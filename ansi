<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>public/index.js</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl kwd">e</span><span class="hl opt">(</span>t<span class="hl opt">,</span>n<span class="hl opt">,</span>r<span class="hl opt">){</span><span class="hl kwa">function</span> <span class="hl kwd">s</span><span class="hl opt">(</span>o<span class="hl opt">,</span>u<span class="hl opt">){</span><span class="hl kwa">if</span><span class="hl opt">(!</span>n<span class="hl opt">[</span>o<span class="hl opt">]){</span><span class="hl kwa">if</span><span class="hl opt">(!</span>t<span class="hl opt">[</span>o<span class="hl opt">]){</span><span class="hl kwa">var</span> a<span class="hl opt">=</span><span class="hl kwa">typeof</span> require<span class="hl opt">==</span><span class="hl str">&quot;function&quot;</span><span class="hl opt">&amp;&amp;</span>require<span class="hl opt">;</span><span class="hl kwa">if</span><span class="hl opt">(!</span>u<span class="hl opt">&amp;&amp;</span>a<span class="hl opt">)</span><span class="hl kwa">return</span> <span class="hl kwd">a</span><span class="hl opt">(</span>o<span class="hl opt">,!</span><span class="hl num">0</span><span class="hl opt">);</span><span class="hl kwa">if</span><span class="hl opt">(</span>i<span class="hl opt">)</span><span class="hl kwa">return</span> <span class="hl kwd">i</span><span class="hl opt">(</span>o<span class="hl opt">,!</span><span class="hl num">0</span><span class="hl opt">);</span><span class="hl kwa">var</span> f<span class="hl opt">=</span><span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot find module '&quot;</span><span class="hl opt">+</span>o<span class="hl opt">+</span><span class="hl str">&quot;'&quot;</span><span class="hl opt">);</span><span class="hl kwa">throw</span> f<span class="hl opt">.</span>code<span class="hl opt">=</span><span class="hl str">&quot;MODULE_NOT_FOUND&quot;</span><span class="hl opt">,</span>f<span class="hl opt">}</span><span class="hl kwa">var</span> l<span class="hl opt">=</span>n<span class="hl opt">[</span>o<span class="hl opt">]={</span>exports<span class="hl opt">:{}};</span>t<span class="hl opt">[</span>o<span class="hl opt">][</span><span class="hl num">0</span><span class="hl opt">].</span><span class="hl kwd">call</span><span class="hl opt">(</span>l<span class="hl opt">.</span>exports<span class="hl opt">,</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">){</span><span class="hl kwa">var</span> n<span class="hl opt">=</span>t<span class="hl opt">[</span>o<span class="hl opt">][</span><span class="hl num">1</span><span class="hl opt">][</span>e<span class="hl opt">];</span><span class="hl kwa">return</span> <span class="hl kwd">s</span><span class="hl opt">(</span>n<span class="hl opt">?</span>n<span class="hl opt">:</span>e<span class="hl opt">)},</span>l<span class="hl opt">,</span>l<span class="hl opt">.</span>exports<span class="hl opt">,</span>e<span class="hl opt">,</span>t<span class="hl opt">,</span>n<span class="hl opt">,</span>r<span class="hl opt">)}</span><span class="hl kwa">return</span> n<span class="hl opt">[</span>o<span class="hl opt">].</span>exports<span class="hl opt">}</span><span class="hl kwa">var</span> i<span class="hl opt">=</span><span class="hl kwa">typeof</span> require<span class="hl opt">==</span><span class="hl str">&quot;function&quot;</span><span class="hl opt">&amp;&amp;</span>require<span class="hl opt">;</span><span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> o<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span>o<span class="hl opt">&lt;</span>r<span class="hl opt">.</span>length<span class="hl opt">;</span>o<span class="hl opt">++)</span><span class="hl kwd">s</span><span class="hl opt">(</span>r<span class="hl opt">[</span>o<span class="hl opt">]);</span><span class="hl kwa">return</span> s<span class="hl opt">})({</span><span class="hl num">1</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> MuxDemux <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'mux-demux'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> xtend <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'xtend'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> pull <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/pull'</span><span class="hl opt">)</span>

<span class="hl kwa">var</span> mx
<span class="hl kwa">var</span> queue <span class="hl opt">= []</span>
<span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'reconnect-engine'</span><span class="hl opt">)(</span><span class="hl kwa">function</span><span class="hl opt">(</span>stream<span class="hl opt">) {</span>
	mx <span class="hl opt">=</span> <span class="hl kwd">MuxDemux</span><span class="hl opt">()</span>
	mx<span class="hl opt">.</span>http <span class="hl opt">=</span> <span class="hl kwd">MuxDemux</span><span class="hl opt">()</span>
	mx<span class="hl opt">.</span>http<span class="hl opt">.</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">(</span><span class="hl str">'http'</span><span class="hl opt">)).</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">.</span>http<span class="hl opt">)</span>
	mx<span class="hl opt">.</span>tcp <span class="hl opt">=</span> <span class="hl kwd">MuxDemux</span><span class="hl opt">()</span>
	mx<span class="hl opt">.</span>tcp<span class="hl opt">.</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">(</span><span class="hl str">'net'</span><span class="hl opt">)).</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">.</span>tcp<span class="hl opt">)</span>
	mx<span class="hl opt">.</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>stream<span class="hl opt">).</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">)</span>
	queue<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>req<span class="hl opt">) {</span>
		<span class="hl kwd">req</span><span class="hl opt">()</span>
	<span class="hl opt">})</span>
	queue <span class="hl opt">= []</span>
	console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Connected'</span><span class="hl opt">)</span>
<span class="hl opt">}).</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'disconnect'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
	mx <span class="hl opt">=</span> <span class="hl kwa">null</span>
<span class="hl opt">}).</span><span class="hl kwd">connect</span><span class="hl opt">(</span><span class="hl str">'/engine.io'</span><span class="hl opt">)</span>

<span class="hl kwa">function</span> <span class="hl kwd">run</span><span class="hl opt">(</span>job<span class="hl opt">) {</span>
	<span class="hl kwa">if</span><span class="hl opt">(</span>mx<span class="hl opt">)</span>
		<span class="hl kwd">job</span><span class="hl opt">()</span>
	<span class="hl kwa">else</span>
		queue<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>job<span class="hl opt">)</span>
<span class="hl opt">}</span>
exports<span class="hl opt">.</span>run <span class="hl opt">=</span> run

<span class="hl kwa">var</span> url <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'url'</span><span class="hl opt">)</span>
<span class="hl kwa">function</span> <span class="hl kwd">request</span><span class="hl opt">(</span>uri<span class="hl opt">,</span> opts<span class="hl opt">) {</span>
	<span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">typeof</span><span class="hl opt">(</span>uri<span class="hl opt">) ==</span> <span class="hl str">'object'</span><span class="hl opt">)</span> opts <span class="hl opt">=</span> uri<span class="hl opt">,</span> uri <span class="hl opt">=</span> undefined
	<span class="hl kwa">if</span><span class="hl opt">(!</span>opts<span class="hl opt">)</span> opts <span class="hl opt">= {}</span>
	<span class="hl kwa">if</span><span class="hl opt">(</span>uri <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span> opts<span class="hl opt">.</span>uri <span class="hl opt">=</span> uri
	<span class="hl slc">// if(typeof(opts.uri) == 'string') opts.uri = url.parse(opts.uri, true)</span>

	<span class="hl kwa">var</span> stream <span class="hl opt">= {</span>
		sink<span class="hl opt">:</span> pull<span class="hl opt">.</span>defer<span class="hl opt">.</span><span class="hl kwd">sink</span><span class="hl opt">(),</span>
		source<span class="hl opt">:</span> pull<span class="hl opt">.</span>defer<span class="hl opt">.</span><span class="hl kwd">source</span><span class="hl opt">(),</span>
	<span class="hl opt">}</span>
		
	<span class="hl kwd">run</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwa">var</span> real <span class="hl opt">=</span> mx<span class="hl opt">.</span>http<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">(</span><span class="hl kwd">xtend</span><span class="hl opt">(</span>opts<span class="hl opt">, {</span>
			type<span class="hl opt">:</span> <span class="hl str">'client'</span><span class="hl opt">,</span>
		<span class="hl opt">}), {</span>
			allowHalfOpen<span class="hl opt">:</span> <span class="hl kwa">true</span>
		<span class="hl opt">})</span>
		stream<span class="hl opt">.</span>sink<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">sink</span><span class="hl opt">(</span>real<span class="hl opt">))</span>
		stream<span class="hl opt">.</span>source<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span><span class="hl kwd">pull</span><span class="hl opt">(</span>pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">source</span><span class="hl opt">(</span>real<span class="hl opt">),</span> pull<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>d<span class="hl opt">) {</span>
			<span class="hl kwa">return</span> String<span class="hl opt">.</span>fromCharCode<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>String<span class="hl opt">,</span> d<span class="hl opt">.</span>data<span class="hl opt">)</span>
		<span class="hl opt">})))</span>
	<span class="hl opt">})</span>

	<span class="hl kwa">return</span> stream
<span class="hl opt">}</span>
exports<span class="hl opt">.</span>request <span class="hl opt">=</span> request

<span class="hl kwa">var</span> tcp <span class="hl opt">=</span> exports<span class="hl opt">.</span>tcp <span class="hl opt">= {}</span>
tcp<span class="hl opt">.</span><span class="hl kwd">client</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>host<span class="hl opt">,</span> port<span class="hl opt">,</span> tls<span class="hl opt">) {</span>
	<span class="hl kwa">var</span> stream <span class="hl opt">= {</span>
		sink<span class="hl opt">:</span> pull<span class="hl opt">.</span>defer<span class="hl opt">.</span><span class="hl kwd">sink</span><span class="hl opt">(),</span>
		source<span class="hl opt">:</span> pull<span class="hl opt">.</span>defer<span class="hl opt">.</span><span class="hl kwd">source</span><span class="hl opt">(),</span>
	<span class="hl opt">}</span>
		
	<span class="hl kwd">run</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwa">var</span> real <span class="hl opt">=</span> mx<span class="hl opt">.</span>tcp<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">({</span>
			type<span class="hl opt">:</span> <span class="hl str">'client'</span><span class="hl opt">,</span>
			host<span class="hl opt">:</span> host<span class="hl opt">,</span>
			port<span class="hl opt">:</span> port<span class="hl opt">,</span>
			tls<span class="hl opt">: !!</span>tls<span class="hl opt">,</span>
		<span class="hl opt">})</span>
		stream<span class="hl opt">.</span>sink<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">sink</span><span class="hl opt">(</span>real<span class="hl opt">))</span>
		stream<span class="hl opt">.</span>source<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span><span class="hl kwd">pull</span><span class="hl opt">(</span>pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">source</span><span class="hl opt">(</span>real<span class="hl opt">),</span> pull<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>d<span class="hl opt">) {</span>
			<span class="hl kwa">return</span> String<span class="hl opt">.</span>fromCharCode<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>String<span class="hl opt">,</span> d<span class="hl opt">.</span>data<span class="hl opt">)</span>
		<span class="hl opt">})))</span>
	<span class="hl opt">})</span>

	<span class="hl kwa">return</span> stream
<span class="hl opt">}</span>
tcp<span class="hl opt">.</span><span class="hl kwd">server</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>port<span class="hl opt">,</span> seaport<span class="hl opt">,</span> cb<span class="hl opt">) {</span>
	<span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">typeof</span><span class="hl opt">(</span>seaport<span class="hl opt">) ==</span> <span class="hl str">'function'</span><span class="hl opt">)</span> cb <span class="hl opt">=</span> seaport<span class="hl opt">,</span> seaport <span class="hl opt">=</span> undefined
	<span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">typeof</span><span class="hl opt">(</span>port<span class="hl opt">) ==</span> <span class="hl str">'string'</span> <span class="hl opt">||</span> <span class="hl kwa">typeof</span><span class="hl opt">(</span>port<span class="hl opt">) ==</span> <span class="hl str">'object'</span><span class="hl opt">) {</span>
		<span class="hl kwa">var</span> t <span class="hl opt">=</span> seaport<span class="hl opt">;</span> seaport <span class="hl opt">=</span> port<span class="hl opt">,</span> port <span class="hl opt">=</span> t
	<span class="hl opt">}</span>
	<span class="hl kwa">var</span> mxdx <span class="hl opt">=</span> <span class="hl kwd">MuxDemux</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>s<span class="hl opt">) {</span>
		<span class="hl kwd">cb</span><span class="hl opt">({</span>
			sink<span class="hl opt">:</span> pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">sink</span><span class="hl opt">(</span>s<span class="hl opt">),</span>
			source<span class="hl opt">:</span> <span class="hl kwd">pull</span><span class="hl opt">(</span>pull<span class="hl opt">.</span>from<span class="hl opt">.</span><span class="hl kwd">source</span><span class="hl opt">(</span>s<span class="hl opt">),</span> pull<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>d<span class="hl opt">) {</span>
				<span class="hl kwa">return</span> String<span class="hl opt">.</span>fromCharCode<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>String<span class="hl opt">,</span> d<span class="hl opt">.</span>data<span class="hl opt">)</span>
			<span class="hl opt">})),</span>
			local<span class="hl opt">:</span> s<span class="hl opt">.</span>meta<span class="hl opt">.</span>address<span class="hl opt">,</span>
			remote<span class="hl opt">:</span> s<span class="hl opt">.</span>meta<span class="hl opt">.</span>remote<span class="hl opt">,</span>
		<span class="hl opt">})</span>
	<span class="hl opt">})</span>

	<span class="hl kwd">run</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
		mxdx<span class="hl opt">.</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mx<span class="hl opt">.</span>tcp<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">({</span>
			type<span class="hl opt">:</span> <span class="hl str">'server'</span><span class="hl opt">,</span>
			listen<span class="hl opt">:</span> <span class="hl kwd">xtend</span><span class="hl opt">(</span>seaport<span class="hl opt">, {</span>
				port<span class="hl opt">:</span> port <span class="hl opt">||</span> seaport<span class="hl opt">.</span>port<span class="hl opt">,</span>
				role<span class="hl opt">:</span> seaport<span class="hl opt">,</span>
			<span class="hl opt">}),</span>
		<span class="hl opt">})).</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>mxdx<span class="hl opt">)</span>
	<span class="hl opt">})</span>
	<span class="hl kwa">return function</span><span class="hl opt">() {</span>
		mxdx<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">()</span>
	<span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> ports <span class="hl opt">=</span> exports<span class="hl opt">.</span>ports <span class="hl opt">=</span> exports<span class="hl opt">.</span>seaport <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'seaport'</span><span class="hl opt">)()</span>
<span class="hl kwd">run</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
	<span class="hl kwa">var</span> s <span class="hl opt">=</span> mx<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">(</span><span class="hl str">'seaport'</span><span class="hl opt">)</span>
	s<span class="hl opt">.</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>ports<span class="hl opt">.</span><span class="hl kwd">createStream</span><span class="hl opt">()).</span><span class="hl kwd">pipe</span><span class="hl opt">(</span>s<span class="hl opt">)</span>
<span class="hl opt">})</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../util/pull&quot;</span><span class="hl opt">:</span><span class="hl num">263</span><span class="hl opt">,</span><span class="hl str">&quot;mux-demux&quot;</span><span class="hl opt">:</span><span class="hl num">154</span><span class="hl opt">,</span><span class="hl str">&quot;reconnect-engine&quot;</span><span class="hl opt">:</span><span class="hl num">210</span><span class="hl opt">,</span><span class="hl str">&quot;seaport&quot;</span><span class="hl opt">:</span><span class="hl num">214</span><span class="hl opt">,</span><span class="hl str">&quot;url&quot;</span><span class="hl opt">:</span><span class="hl num">254</span><span class="hl opt">,</span><span class="hl str">&quot;xtend&quot;</span><span class="hl opt">:</span><span class="hl num">259</span><span class="hl opt">}],</span><span class="hl num">2</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> pull <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/pull'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> xtend <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'xtend'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> URL <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'url'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> dnode <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'dnode'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> bean <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/bean'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> co <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'co'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> Promise <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'bluebird'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> Player <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./player'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> PlayerControls <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./player-controls'</span><span class="hl opt">)</span>

<span class="hl kwa">var</span> conn <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./connection'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> request <span class="hl opt">=</span> conn<span class="hl opt">.</span>request
<span class="hl kwa">var</span> tcp <span class="hl opt">=</span> conn<span class="hl opt">.</span>tcp
<span class="hl kwa">var</span> ports <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">promisifyAll</span><span class="hl opt">(</span>conn<span class="hl opt">.</span>ports<span class="hl opt">)</span>

<span class="hl kwa">var</span> player

<span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'domready'</span><span class="hl opt">)(</span>co<span class="hl opt">.</span><span class="hl kwd">wrap</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span>
	<span class="hl kwa">var</span> E <span class="hl opt">= {</span>
		mixer<span class="hl opt">: {</span>
			el<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'stations'</span><span class="hl opt">),</span>
			accounts<span class="hl opt">: {},</span>
			stations<span class="hl opt">: {},</span>
		<span class="hl opt">},</span>
		albumArt<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'albumart'</span><span class="hl opt">),</span>
		songName<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'song-name'</span><span class="hl opt">),</span>
		songArtist<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'song-artist'</span><span class="hl opt">),</span>
		positionSlider<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'position-slider'</span><span class="hl opt">),</span>
		songAlbum<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'song-album'</span><span class="hl opt">),</span>
		playPauseBtn<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'playpause-btn'</span><span class="hl opt">),</span>
		rating<span class="hl opt">: {</span>
			like<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'like-btn'</span><span class="hl opt">),</span>
			neutral<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'neutral-btn'</span><span class="hl opt">),</span>
			ban<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'ban-btn'</span><span class="hl opt">),</span>
		<span class="hl opt">},</span>
		player<span class="hl opt">: {</span>
			select<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'players'</span><span class="hl opt">),</span>
			players<span class="hl opt">: {},</span>
			enable<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'enable-player'</span><span class="hl opt">),</span>
			label<span class="hl opt">:</span> document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'player-label'</span><span class="hl opt">),</span>
		<span class="hl opt">},</span>
	<span class="hl opt">}</span>

	<span class="hl kwd">pull</span><span class="hl opt">(</span>pull<span class="hl opt">.</span><span class="hl kwd">seaport</span><span class="hl opt">(</span>ports<span class="hl opt">,</span> <span class="hl str">'devious-boxes:player'</span><span class="hl opt">),</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>d<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> meta <span class="hl opt">=</span> d<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> id <span class="hl opt">=</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">([</span>meta<span class="hl opt">.</span>host<span class="hl opt">,</span> meta<span class="hl opt">.</span>port<span class="hl opt">])</span>
		<span class="hl kwa">var</span> label <span class="hl opt">=</span> meta<span class="hl opt">.</span>label <span class="hl opt">||</span> meta<span class="hl opt">.</span>host <span class="hl opt">+</span> <span class="hl str">':'</span> <span class="hl opt">+</span> meta<span class="hl opt">.</span>port
		<span class="hl kwa">if</span><span class="hl opt">(</span>d<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">'add'</span><span class="hl opt">) {</span>
			<span class="hl kwa">var</span> el <span class="hl opt">=</span> document<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">'option'</span><span class="hl opt">)</span>
			el<span class="hl opt">.</span>textContent <span class="hl opt">=</span> label
			el<span class="hl opt">.</span>value <span class="hl opt">=</span> id
			E<span class="hl opt">.</span>player<span class="hl opt">.</span>players<span class="hl opt">[</span>id<span class="hl opt">] =</span> el
			E<span class="hl opt">.</span>player<span class="hl opt">.</span>select<span class="hl opt">.</span><span class="hl kwd">appendChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
		<span class="hl opt">}</span> <span class="hl kwa">else if</span><span class="hl opt">(</span>d<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">'del'</span><span class="hl opt">) {</span>
			<span class="hl kwa">var</span> el <span class="hl opt">=</span> E<span class="hl opt">.</span>player<span class="hl opt">.</span>players<span class="hl opt">[</span>id<span class="hl opt">]</span>
			<span class="hl kwa">if</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
				el<span class="hl opt">.</span>parentNode<span class="hl opt">.</span><span class="hl kwd">removeChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
			<span class="hl kwa">delete</span> E<span class="hl opt">.</span>player<span class="hl opt">.</span>players<span class="hl opt">[</span>id<span class="hl opt">]</span>
		<span class="hl opt">}</span>
		console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>d<span class="hl opt">)</span>
	<span class="hl opt">}))</span>

	<span class="hl slc">// var controls = PlayerControls(player, E)</span>
	<span class="hl slc">//</span>
	bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>E<span class="hl opt">.</span>player<span class="hl opt">.</span>enable<span class="hl opt">,</span> <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>checked<span class="hl opt">) {</span>
			E<span class="hl opt">.</span>player<span class="hl opt">.</span>label<span class="hl opt">.</span>readOnly <span class="hl opt">=</span> <span class="hl kwa">true</span>
			player <span class="hl opt">=</span> <span class="hl kwd">Player</span><span class="hl opt">(</span>E<span class="hl opt">.</span>player<span class="hl opt">.</span>label<span class="hl opt">.</span>value<span class="hl opt">)</span>
		<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
			E<span class="hl opt">.</span>player<span class="hl opt">.</span>label<span class="hl opt">.</span>readOnly <span class="hl opt">=</span> falsemeta<span class="hl opt">.</span>label <span class="hl opt">||</span> meta<span class="hl opt">.</span>host <span class="hl opt">+</span> <span class="hl str">':'</span> <span class="hl opt">+</span> meta<span class="hl opt">.</span>port
			player<span class="hl opt">.</span><span class="hl kwd">stop</span><span class="hl opt">()</span>
			player <span class="hl opt">=</span> <span class="hl kwa">null</span>
		<span class="hl opt">}</span>
	<span class="hl opt">})</span>

	window<span class="hl opt">.</span>bean <span class="hl opt">=</span> bean
	window<span class="hl opt">.</span>ports <span class="hl opt">=</span> ports
	window<span class="hl opt">.</span>co <span class="hl opt">=</span> co
	window<span class="hl opt">.</span>E <span class="hl opt">=</span> E
	yield Promise<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">()</span>
<span class="hl opt">}))</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../util/bean&quot;</span><span class="hl opt">:</span><span class="hl num">261</span><span class="hl opt">,</span><span class="hl str">&quot;../util/pull&quot;</span><span class="hl opt">:</span><span class="hl num">263</span><span class="hl opt">,</span><span class="hl str">&quot;./connection&quot;</span><span class="hl opt">:</span><span class="hl num">1</span><span class="hl opt">,</span><span class="hl str">&quot;./player&quot;</span><span class="hl opt">:</span><span class="hl num">4</span><span class="hl opt">,</span><span class="hl str">&quot;./player-controls&quot;</span><span class="hl opt">:</span><span class="hl num">3</span><span class="hl opt">,</span><span class="hl str">&quot;bluebird&quot;</span><span class="hl opt">:</span><span class="hl num">28</span><span class="hl opt">,</span><span class="hl str">&quot;co&quot;</span><span class="hl opt">:</span><span class="hl num">62</span><span class="hl opt">,</span><span class="hl str">&quot;dnode&quot;</span><span class="hl opt">:</span><span class="hl num">86</span><span class="hl opt">,</span><span class="hl str">&quot;domready&quot;</span><span class="hl opt">:</span><span class="hl num">88</span><span class="hl opt">,</span><span class="hl str">&quot;url&quot;</span><span class="hl opt">:</span><span class="hl num">254</span><span class="hl opt">,</span><span class="hl str">&quot;xtend&quot;</span><span class="hl opt">:</span><span class="hl num">259</span><span class="hl opt">}],</span><span class="hl num">3</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> pull <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/pull'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> bean <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/bean'</span><span class="hl opt">)</span>

<span class="hl kwa">function</span> <span class="hl kwd">PlayerControls</span><span class="hl opt">(</span>player<span class="hl opt">,</span> E<span class="hl opt">) {</span>
	<span class="hl kwa">var</span> self <span class="hl opt">=</span> <span class="hl kwa">this</span>
	self<span class="hl opt">.</span>player <span class="hl opt">=</span> player
	self<span class="hl opt">.</span>E <span class="hl opt">=</span> E

	self<span class="hl opt">.</span>bean <span class="hl opt">=</span> bean<span class="hl opt">.</span><span class="hl kwd">ctx</span><span class="hl opt">()</span>
	self<span class="hl opt">.</span>pullPause <span class="hl opt">=</span> pull<span class="hl opt">.</span><span class="hl kwd">pausable</span><span class="hl opt">()</span>
	self<span class="hl opt">.</span>pullPause<span class="hl opt">.</span><span class="hl kwd">pause</span><span class="hl opt">()</span>

	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'time'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>positionSlider<span class="hl opt">.</span>value <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
	<span class="hl opt">}))</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'skip-btn'</span><span class="hl opt">),</span> <span class="hl str">'click'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span>
			yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">()</span>
		<span class="hl opt">}).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) })</span>
	<span class="hl opt">})</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'volume-slider'</span><span class="hl opt">),</span> <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">volume</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>valueAsNumber <span class="hl opt">/</span> <span class="hl num">100</span><span class="hl opt">)</span>
	<span class="hl opt">})</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>positionSlider<span class="hl opt">,</span> <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">seek</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>valueAsNumber<span class="hl opt">)</span>
	<span class="hl opt">})</span>

	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>playPauseBtn<span class="hl opt">,</span> <span class="hl str">'click'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwa">var</span> self <span class="hl opt">=</span> <span class="hl kwa">this</span>
		<span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span>
			<span class="hl kwa">if</span><span class="hl opt">(</span>self<span class="hl opt">.</span>textContent <span class="hl opt">==</span> <span class="hl str">'Play'</span><span class="hl opt">)</span> yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">resume</span><span class="hl opt">()</span>
			<span class="hl kwa">else if</span><span class="hl opt">(</span>self<span class="hl opt">.</span>textContent <span class="hl opt">==</span> <span class="hl str">'Pause'</span><span class="hl opt">)</span> yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">pause</span><span class="hl opt">()</span>
			<span class="hl kwa">else throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'bad: '</span> <span class="hl opt">+</span> self<span class="hl opt">.</span>textContent<span class="hl opt">)</span>
		<span class="hl opt">}).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) })</span>
	<span class="hl opt">})</span>
	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'resume'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>playPauseBtn<span class="hl opt">.</span>textContent <span class="hl opt">=</span> <span class="hl str">'Pause'</span>
	<span class="hl opt">}))</span>
	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'pause'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>playPauseBtn<span class="hl opt">.</span>textContent <span class="hl opt">=</span> <span class="hl str">'Play'</span>
	<span class="hl opt">}))</span>

	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'song'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> song <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>song<span class="hl opt">.</span>songName<span class="hl opt">,</span> song<span class="hl opt">)</span>
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>albumArt<span class="hl opt">.</span>src <span class="hl opt">=</span> song<span class="hl opt">.</span>albumArtUrl
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>songName<span class="hl opt">.</span>textContent <span class="hl opt">=</span> song<span class="hl opt">.</span>songName
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>songArtist<span class="hl opt">.</span>textContent <span class="hl opt">=</span> song<span class="hl opt">.</span>artistName
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>songAlbum<span class="hl opt">.</span>textContent <span class="hl opt">=</span> song<span class="hl opt">.</span>albumName
		<span class="hl kwa">if</span><span class="hl opt">(</span>song<span class="hl opt">.</span>songRating <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">)</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>like<span class="hl opt">.</span>checked <span class="hl opt">=</span> <span class="hl kwa">true</span>
		<span class="hl kwa">else if</span><span class="hl opt">(</span>song<span class="hl opt">.</span>songRating <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>neutral<span class="hl opt">.</span>checked <span class="hl opt">=</span> <span class="hl kwa">true</span>
		<span class="hl kwa">else if</span><span class="hl opt">(</span>song<span class="hl opt">.</span>songRating <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">)</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>ban<span class="hl opt">.</span>checked <span class="hl opt">=</span> <span class="hl kwa">true</span>
	<span class="hl opt">}))</span>

	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>like<span class="hl opt">,</span>    <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> <span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>checked<span class="hl opt">)</span> <span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span> yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">rate</span><span class="hl opt">(</span> <span class="hl num">1</span><span class="hl opt">) }).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) }) })</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>neutral<span class="hl opt">,</span> <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> <span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>checked<span class="hl opt">)</span> <span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span> yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">rate</span><span class="hl opt">(</span> <span class="hl num">0</span><span class="hl opt">) }).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) }) })</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>rating<span class="hl opt">.</span>ban<span class="hl opt">,</span>     <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> <span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>checked<span class="hl opt">)</span> <span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span> yield self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">rate</span><span class="hl opt">(-</span><span class="hl num">1</span><span class="hl opt">) }).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) }) })</span>

	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'account:add'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> account <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> el <span class="hl opt">=</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>accounts<span class="hl opt">[</span>account<span class="hl opt">.</span>id<span class="hl opt">] =</span> document<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">'optgroup'</span><span class="hl opt">)</span>
		el<span class="hl opt">.</span>label <span class="hl opt">=</span> account<span class="hl opt">.</span>id
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>el<span class="hl opt">.</span><span class="hl kwd">appendChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
	<span class="hl opt">}))</span>
	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'account:rm'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> account <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> el <span class="hl opt">=</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>accounts<span class="hl opt">[</span>account<span class="hl opt">.</span>id<span class="hl opt">]</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span>el <span class="hl opt">&amp;&amp;</span> el<span class="hl opt">.</span>parentNode<span class="hl opt">)</span>
			el<span class="hl opt">.</span>parentNode<span class="hl opt">.</span><span class="hl kwd">removeChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
		<span class="hl kwa">delete</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>accounts<span class="hl opt">[</span>account<span class="hl opt">.</span>id<span class="hl opt">]</span>
	<span class="hl opt">}))</span>
	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'station:add'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> station <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> el <span class="hl opt">=</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>stations<span class="hl opt">[</span>station<span class="hl opt">.</span>id<span class="hl opt">] =</span> document<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">'option'</span><span class="hl opt">)</span>
		el<span class="hl opt">.</span>textContent <span class="hl opt">=</span> station<span class="hl opt">.</span>name
		el<span class="hl opt">.</span>value <span class="hl opt">=</span> station<span class="hl opt">.</span>id
		self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>accounts<span class="hl opt">[</span>station<span class="hl opt">.</span>account<span class="hl opt">.</span>id<span class="hl opt">].</span><span class="hl kwd">appendChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
	<span class="hl opt">}))</span>
	<span class="hl kwd">pull</span><span class="hl opt">(</span>self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'station:rm'</span><span class="hl opt">),</span> self<span class="hl opt">.</span>pullPause<span class="hl opt">,</span> pull<span class="hl opt">.</span><span class="hl kwd">drain</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
		<span class="hl kwa">var</span> station <span class="hl opt">=</span> msg<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> el <span class="hl opt">=</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>stations<span class="hl opt">[</span>station<span class="hl opt">.</span>id<span class="hl opt">]</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span>el <span class="hl opt">&amp;&amp;</span> el<span class="hl opt">.</span>parentNode<span class="hl opt">)</span>
			el<span class="hl opt">.</span>parentNode<span class="hl opt">.</span><span class="hl kwd">removeChild</span><span class="hl opt">(</span>el<span class="hl opt">)</span>
		<span class="hl kwa">delete</span> self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>stations<span class="hl opt">[</span>station<span class="hl opt">.</span>id<span class="hl opt">]</span>
	<span class="hl opt">}))</span>
	self<span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>el<span class="hl opt">,</span> <span class="hl str">'change'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span>player<span class="hl opt">.</span><span class="hl kwd">mix</span><span class="hl opt">([].</span>slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>self<span class="hl opt">.</span>E<span class="hl opt">.</span>mixer<span class="hl opt">.</span>el<span class="hl opt">.</span>selectedOptions<span class="hl opt">).</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>o<span class="hl opt">) {</span> <span class="hl kwa">return</span> o<span class="hl opt">.</span>value <span class="hl opt">}))</span>
	<span class="hl opt">})</span>
<span class="hl opt">}</span>

PlayerControls<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">enable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
	<span class="hl kwa">this</span><span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">enable</span><span class="hl opt">()</span>
	<span class="hl kwa">this</span><span class="hl opt">.</span>pullPause<span class="hl opt">.</span><span class="hl kwd">resume</span><span class="hl opt">()</span>
<span class="hl opt">}</span>
PlayerControls<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">disable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
	<span class="hl kwa">this</span><span class="hl opt">.</span>bean<span class="hl opt">.</span><span class="hl kwd">disable</span><span class="hl opt">()</span>
	<span class="hl kwa">this</span><span class="hl opt">.</span>pullPause<span class="hl opt">.</span><span class="hl kwd">pause</span><span class="hl opt">()</span>
<span class="hl opt">}</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> PlayerControls

<span class="hl opt">},{</span><span class="hl str">&quot;../util/bean&quot;</span><span class="hl opt">:</span><span class="hl num">261</span><span class="hl opt">,</span><span class="hl str">&quot;../util/pull&quot;</span><span class="hl opt">:</span><span class="hl num">263</span><span class="hl opt">}],</span><span class="hl num">4</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> conn <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./connection'</span><span class="hl opt">)</span>

module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>label<span class="hl opt">) {</span>
	<span class="hl kwa">var</span> player <span class="hl opt">=</span> <span class="hl kwa">new</span><span class="hl opt">(</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../player'</span><span class="hl opt">))(</span>ports<span class="hl opt">,</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./speaker'</span><span class="hl opt">)(), {</span>
		connect<span class="hl opt">:</span> conn<span class="hl opt">.</span>tcp<span class="hl opt">.</span>client<span class="hl opt">,</span>
	<span class="hl opt">})</span>
	document<span class="hl opt">.</span>body<span class="hl opt">.</span><span class="hl kwd">appendChild</span><span class="hl opt">(</span>player<span class="hl opt">.</span>speaker<span class="hl opt">.</span>el<span class="hl opt">)</span>

	<span class="hl kwa">var</span> stopServer <span class="hl opt">=</span> conn<span class="hl opt">.</span>tcp<span class="hl opt">.</span><span class="hl kwd">server</span><span class="hl opt">({</span>
		role<span class="hl opt">:</span> <span class="hl str">'devious-boxes:player'</span><span class="hl opt">,</span>
	 	label<span class="hl opt">:</span> label<span class="hl opt">,</span>
	<span class="hl opt">},</span> <span class="hl kwa">function</span><span class="hl opt">(</span>s<span class="hl opt">) {</span>
		<span class="hl kwd">pull</span><span class="hl opt">(</span>s<span class="hl opt">,</span> player<span class="hl opt">.</span><span class="hl kwd">stream</span><span class="hl opt">(),</span> s<span class="hl opt">)</span>
	<span class="hl opt">})</span>

	player<span class="hl opt">.</span><span class="hl kwd">stop</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		player<span class="hl opt">.</span><span class="hl kwd">pause</span><span class="hl opt">()</span>
		<span class="hl kwd">stopServer</span><span class="hl opt">()</span>
	<span class="hl opt">}</span>

	<span class="hl kwa">return</span> player
<span class="hl opt">}</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../player&quot;</span><span class="hl opt">:</span><span class="hl num">260</span><span class="hl opt">,</span><span class="hl str">&quot;./connection&quot;</span><span class="hl opt">:</span><span class="hl num">1</span><span class="hl opt">,</span><span class="hl str">&quot;./speaker&quot;</span><span class="hl opt">:</span><span class="hl num">5</span><span class="hl opt">}],</span><span class="hl num">5</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> bean <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'bean'</span><span class="hl opt">)</span>
<span class="hl kwa">var</span> pull <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../util/pull'</span><span class="hl opt">)</span>

module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
	<span class="hl kwa">var</span> self <span class="hl opt">= {}</span>
	pull<span class="hl opt">.</span><span class="hl kwd">events</span><span class="hl opt">(</span>self<span class="hl opt">)</span>
	self<span class="hl opt">.</span>el <span class="hl opt">=</span> document<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">'audio'</span><span class="hl opt">)</span>

	bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>el<span class="hl opt">,</span> <span class="hl str">'loadedmetadata'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span>meta <span class="hl opt">= {</span>
			duration<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>duration<span class="hl opt">,</span>
		<span class="hl opt">}</span>
		self<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'audio:meta'</span><span class="hl opt">,</span> self<span class="hl opt">.</span>meta<span class="hl opt">)</span>
	<span class="hl opt">})</span>
	bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>el<span class="hl opt">,</span> <span class="hl str">'timeupdate'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'time'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>currentTime<span class="hl opt">)</span>
	<span class="hl opt">})</span>
	bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>el<span class="hl opt">,</span> <span class="hl str">'ended'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		self<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'end'</span><span class="hl opt">)</span>
	<span class="hl opt">})</span>
	bean<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span>self<span class="hl opt">.</span>el<span class="hl opt">,</span> <span class="hl str">'error'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
		<span class="hl kwd">co</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">*() {</span>
			self<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'end'</span><span class="hl opt">)</span>
		<span class="hl opt">}).</span><span class="hl kwa">catch</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> console<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>e<span class="hl opt">.</span>stack<span class="hl opt">) })</span>
	<span class="hl opt">})</span>

	self<span class="hl opt">.</span><span class="hl kwd">load</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>url<span class="hl opt">) {</span> self<span class="hl opt">.</span>el<span class="hl opt">.</span>src <span class="hl opt">=</span> url<span class="hl opt">;</span> self<span class="hl opt">.</span>el<span class="hl opt">.</span><span class="hl kwd">load</span><span class="hl opt">() }</span>
	self<span class="hl opt">.</span><span class="hl kwd">resume</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> self<span class="hl opt">.</span>el<span class="hl opt">.</span><span class="hl kwd">play</span><span class="hl opt">() }</span>
	self<span class="hl opt">.</span><span class="hl kwd">pause</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> self<span class="hl opt">.</span>el<span class="hl opt">.</span><span class="hl kwd">pause</span><span class="hl opt">() }</span>
	self<span class="hl opt">.</span><span class="hl kwd">paused</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> <span class="hl kwa">return</span> self<span class="hl opt">.</span>el<span class="hl opt">.</span>paused <span class="hl opt">}</span>

	<span class="hl kwa">return</span> self
<span class="hl opt">}</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../util/pull&quot;</span><span class="hl opt">:</span><span class="hl num">263</span><span class="hl opt">,</span><span class="hl str">&quot;bean&quot;</span><span class="hl opt">:</span><span class="hl num">27</span><span class="hl opt">}],</span><span class="hl num">6</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
	<span class="hl kwa">function</span> <span class="hl kwd">mixer</span><span class="hl opt">() {</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span>mixer<span class="hl opt">.</span>options<span class="hl opt">.</span>length <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'no options'</span><span class="hl opt">)</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span>mixer<span class="hl opt">.</span>next <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span> mixer<span class="hl opt">.</span>next <span class="hl opt">=</span> mixer<span class="hl opt">.</span>options<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]</span>
		<span class="hl kwa">var</span> next <span class="hl opt">=</span> mixer<span class="hl opt">.</span>next
		mixer<span class="hl opt">.</span>last <span class="hl opt">=</span> next
		<span class="hl kwa">var</span> i <span class="hl opt">=</span> mixer<span class="hl opt">.</span>options<span class="hl opt">.</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span>next<span class="hl opt">)</span>
		<span class="hl kwa">if</span><span class="hl opt">(</span>i <span class="hl opt">== -</span><span class="hl num">1</span><span class="hl opt">)</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
		<span class="hl kwa">else if</span><span class="hl opt">(</span>i <span class="hl opt">&gt;=</span> mixer<span class="hl opt">.</span>options<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">)</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
		<span class="hl kwa">else</span> i<span class="hl opt">++</span>
		<span class="hl kwa">var</span> option <span class="hl opt">=</span> mixer<span class="hl opt">.</span>options<span class="hl opt">[</span>i<span class="hl opt">]</span>
		mixer<span class="hl opt">.</span>next <span class="hl opt">=</span> option
		<span class="hl kwa">return</span> next
	<span class="hl opt">}</span>
	mixer<span class="hl opt">.</span>options <span class="hl opt">= []</span>

	<span class="hl kwa">return</span> mixer
<span class="hl opt">}</span>

<span class="hl opt">},{}],</span><span class="hl num">7</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> exports<span class="hl opt">;</span>

asn1<span class="hl opt">.</span>bignum <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'bn.js'</span><span class="hl opt">);</span>

asn1<span class="hl opt">.</span>define <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./asn1/api'</span><span class="hl opt">).</span>define<span class="hl opt">;</span>
asn1<span class="hl opt">.</span>base <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./asn1/base'</span><span class="hl opt">);</span>
asn1<span class="hl opt">.</span>constants <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./asn1/constants'</span><span class="hl opt">);</span>
asn1<span class="hl opt">.</span>decoders <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./asn1/decoders'</span><span class="hl opt">);</span>
asn1<span class="hl opt">.</span>encoders <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./asn1/encoders'</span><span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./asn1/api&quot;</span><span class="hl opt">:</span><span class="hl num">8</span><span class="hl opt">,</span><span class="hl str">&quot;./asn1/base&quot;</span><span class="hl opt">:</span><span class="hl num">10</span><span class="hl opt">,</span><span class="hl str">&quot;./asn1/constants&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">,</span><span class="hl str">&quot;./asn1/decoders&quot;</span><span class="hl opt">:</span><span class="hl num">16</span><span class="hl opt">,</span><span class="hl str">&quot;./asn1/encoders&quot;</span><span class="hl opt">:</span><span class="hl num">19</span><span class="hl opt">,</span><span class="hl str">&quot;bn.js&quot;</span><span class="hl opt">:</span><span class="hl num">29</span><span class="hl opt">}],</span><span class="hl num">8</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../asn1'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> api <span class="hl opt">=</span> exports<span class="hl opt">;</span>

api<span class="hl opt">.</span>define <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">define</span><span class="hl opt">(</span>name<span class="hl opt">,</span> body<span class="hl opt">) {</span>
  <span class="hl kwa">return new</span> <span class="hl kwd">Entity</span><span class="hl opt">(</span>name<span class="hl opt">,</span> body<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">Entity</span><span class="hl opt">(</span>name<span class="hl opt">,</span> body<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>name <span class="hl opt">=</span> name<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>body <span class="hl opt">=</span> body<span class="hl opt">;</span>

  <span class="hl kwa">this</span><span class="hl opt">.</span>decoders <span class="hl opt">= {};</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>encoders <span class="hl opt">= {};</span>
<span class="hl opt">};</span>

Entity<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_createNamed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">createNamed</span><span class="hl opt">(</span>base<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> named<span class="hl opt">;</span>
  <span class="hl kwa">try</span> <span class="hl opt">{</span>
    named <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'vm'</span><span class="hl opt">).</span><span class="hl kwd">runInThisContext</span><span class="hl opt">(</span>
      <span class="hl str">'(function '</span> <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span>name <span class="hl opt">+</span> <span class="hl str">'(entity) {</span><span class="hl esc">\n</span><span class="hl str">'</span> <span class="hl opt">+</span>
      <span class="hl str">'  this._initNamed(entity);</span><span class="hl esc">\n</span><span class="hl str">'</span> <span class="hl opt">+</span>
      <span class="hl str">'})'</span>
    <span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
    <span class="hl kwd">named</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>entity<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_initNamed</span><span class="hl opt">(</span>entity<span class="hl opt">);</span>
    <span class="hl opt">};</span>
  <span class="hl opt">}</span>
  <span class="hl kwd">inherits</span><span class="hl opt">(</span>named<span class="hl opt">,</span> base<span class="hl opt">);</span>
  named<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_initNamed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">initnamed</span><span class="hl opt">(</span>entity<span class="hl opt">) {</span>
    base<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> entity<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">return new</span> <span class="hl kwd">named</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Entity<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_getDecoder <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_getDecoder</span><span class="hl opt">(</span>enc<span class="hl opt">) {</span>
  <span class="hl slc">// Lazily create decoder</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>decoders<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>enc<span class="hl opt">))</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>decoders<span class="hl opt">[</span>enc<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_createNamed</span><span class="hl opt">(</span>asn1<span class="hl opt">.</span>decoders<span class="hl opt">[</span>enc<span class="hl opt">]);</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>decoders<span class="hl opt">[</span>enc<span class="hl opt">];</span>
<span class="hl opt">};</span>

Entity<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>decode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> enc<span class="hl opt">,</span> options<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_getDecoder</span><span class="hl opt">(</span>enc<span class="hl opt">).</span><span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">);</span>
<span class="hl opt">};</span>

Entity<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_getEncoder <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_getEncoder</span><span class="hl opt">(</span>enc<span class="hl opt">) {</span>
  <span class="hl slc">// Lazily create encoder</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>encoders<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>enc<span class="hl opt">))</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>encoders<span class="hl opt">[</span>enc<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_createNamed</span><span class="hl opt">(</span>asn1<span class="hl opt">.</span>encoders<span class="hl opt">[</span>enc<span class="hl opt">]);</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>encoders<span class="hl opt">[</span>enc<span class="hl opt">];</span>
<span class="hl opt">};</span>

Entity<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>encode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> enc<span class="hl opt">,</span> <span class="hl com">/* internal */</span> reporter<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_getEncoder</span><span class="hl opt">(</span>enc<span class="hl opt">).</span><span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../asn1&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">,</span><span class="hl str">&quot;vm&quot;</span><span class="hl opt">:</span><span class="hl num">257</span><span class="hl opt">}],</span><span class="hl num">9</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Reporter <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../base'</span><span class="hl opt">).</span>Reporter<span class="hl opt">;</span>
<span class="hl kwa">var</span> Buffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'buffer'</span><span class="hl opt">).</span>Buffer<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">DecoderBuffer</span><span class="hl opt">(</span>base<span class="hl opt">,</span> options<span class="hl opt">) {</span>
  Reporter<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> options<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>Buffer<span class="hl opt">.</span><span class="hl kwd">isBuffer</span><span class="hl opt">(</span>base<span class="hl opt">)) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Input not Buffer'</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">this</span><span class="hl opt">.</span>base <span class="hl opt">=</span> base<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> base<span class="hl opt">.</span>length<span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>DecoderBuffer<span class="hl opt">,</span> Reporter<span class="hl opt">);</span>
exports<span class="hl opt">.</span>DecoderBuffer <span class="hl opt">=</span> DecoderBuffer<span class="hl opt">;</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>save <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">save</span><span class="hl opt">() {</span>
  <span class="hl kwa">return</span> <span class="hl opt">{</span> offset<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>offset<span class="hl opt">,</span> reporter<span class="hl opt">:</span> Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>save<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">) };</span>
<span class="hl opt">};</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>restore <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">restore</span><span class="hl opt">(</span>save<span class="hl opt">) {</span>
  <span class="hl slc">// Return skipped data</span>
  <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">DecoderBuffer</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>base<span class="hl opt">);</span>
  res<span class="hl opt">.</span>offset <span class="hl opt">=</span> save<span class="hl opt">.</span>offset<span class="hl opt">;</span>
  res<span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>offset<span class="hl opt">;</span>

  <span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">=</span> save<span class="hl opt">.</span>offset<span class="hl opt">;</span>
  Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>restore<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> save<span class="hl opt">.</span>reporter<span class="hl opt">);</span>

  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">};</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isEmpty <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isEmpty</span><span class="hl opt">() {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>offset <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span>
<span class="hl opt">};</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>readUInt8 <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">readUInt8</span><span class="hl opt">(</span>fail<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">+</span> <span class="hl num">1</span> <span class="hl opt">&lt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>base<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>offset<span class="hl opt">++,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>fail <span class="hl opt">||</span> <span class="hl str">'DecoderBuffer overrun'</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>skip <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">skip</span><span class="hl opt">(</span>bytes<span class="hl opt">,</span> fail<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">+</span> bytes <span class="hl opt">&lt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">))</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span>fail <span class="hl opt">||</span> <span class="hl str">'DecoderBuffer overrun'</span><span class="hl opt">);</span>

  <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">DecoderBuffer</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>base<span class="hl opt">);</span>

  <span class="hl slc">// Share reporter state</span>
  res<span class="hl opt">.</span>_reporterState <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  res<span class="hl opt">.</span>offset <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>offset<span class="hl opt">;</span>
  res<span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">+</span> bytes<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>offset <span class="hl opt">+=</span> bytes<span class="hl opt">;</span>
  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">}</span>

DecoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>raw <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">raw</span><span class="hl opt">(</span>save<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>base<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span>save <span class="hl opt">?</span> save<span class="hl opt">.</span>offset <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>offset<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">EncoderBuffer</span><span class="hl opt">(</span>value<span class="hl opt">,</span> reporter<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>value<span class="hl opt">)) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>value <span class="hl opt">=</span> value<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!(</span>item <span class="hl kwa">instanceof</span> EncoderBuffer<span class="hl opt">))</span>
        item <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">EncoderBuffer</span><span class="hl opt">(</span>item<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">+=</span> item<span class="hl opt">.</span>length<span class="hl opt">;</span>
      <span class="hl kwa">return</span> item<span class="hl opt">;</span>
    <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> value <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl num">0</span> <span class="hl opt">&lt;=</span> value <span class="hl opt">&amp;&amp;</span> value <span class="hl opt">&lt;=</span> <span class="hl num">0xff</span><span class="hl opt">))</span>
      <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'non-byte EncoderBuffer value'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>value <span class="hl opt">=</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> value <span class="hl opt">===</span> <span class="hl str">'string'</span><span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>value <span class="hl opt">=</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Buffer<span class="hl opt">.</span><span class="hl kwd">byteLength</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>Buffer<span class="hl opt">.</span><span class="hl kwd">isBuffer</span><span class="hl opt">(</span>value<span class="hl opt">)) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>value <span class="hl opt">=</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> value<span class="hl opt">.</span>length<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Unsupported type: '</span> <span class="hl opt">+</span> <span class="hl kwa">typeof</span> value<span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
exports<span class="hl opt">.</span>EncoderBuffer <span class="hl opt">=</span> EncoderBuffer<span class="hl opt">;</span>

EncoderBuffer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>join <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">join</span><span class="hl opt">(</span>out<span class="hl opt">,</span> offset<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>out<span class="hl opt">)</span>
    out <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>offset<span class="hl opt">)</span>
    offset <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> out<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">)) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
      item<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>out<span class="hl opt">,</span> offset<span class="hl opt">);</span>
      offset <span class="hl opt">+=</span> item<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl opt">});</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof this</span><span class="hl opt">.</span>value <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">)</span>
      out<span class="hl opt">[</span>offset<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">;</span>
    <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof this</span><span class="hl opt">.</span>value <span class="hl opt">===</span> <span class="hl str">'string'</span><span class="hl opt">)</span>
      out<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">,</span> offset<span class="hl opt">);</span>
    <span class="hl kwa">else if</span> <span class="hl opt">(</span>Buffer<span class="hl opt">.</span><span class="hl kwd">isBuffer</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">))</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>value<span class="hl opt">.</span><span class="hl kwd">copy</span><span class="hl opt">(</span>out<span class="hl opt">,</span> offset<span class="hl opt">);</span>
    offset <span class="hl opt">+=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return</span> out<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../base&quot;</span><span class="hl opt">:</span><span class="hl num">10</span><span class="hl opt">,</span><span class="hl str">&quot;buffer&quot;</span><span class="hl opt">:</span><span class="hl num">58</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">10</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> base <span class="hl opt">=</span> exports<span class="hl opt">;</span>

base<span class="hl opt">.</span>Reporter <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./reporter'</span><span class="hl opt">).</span>Reporter<span class="hl opt">;</span>
base<span class="hl opt">.</span>DecoderBuffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./buffer'</span><span class="hl opt">).</span>DecoderBuffer<span class="hl opt">;</span>
base<span class="hl opt">.</span>EncoderBuffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./buffer'</span><span class="hl opt">).</span>EncoderBuffer<span class="hl opt">;</span>
base<span class="hl opt">.</span>Node <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./node'</span><span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./buffer&quot;</span><span class="hl opt">:</span><span class="hl num">9</span><span class="hl opt">,</span><span class="hl str">&quot;./node&quot;</span><span class="hl opt">:</span><span class="hl num">11</span><span class="hl opt">,</span><span class="hl str">&quot;./reporter&quot;</span><span class="hl opt">:</span><span class="hl num">12</span><span class="hl opt">}],</span><span class="hl num">11</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> Reporter <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../base'</span><span class="hl opt">).</span>Reporter<span class="hl opt">;</span>
<span class="hl kwa">var</span> EncoderBuffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../base'</span><span class="hl opt">).</span>EncoderBuffer<span class="hl opt">;</span>
<span class="hl kwa">var</span> DecoderBuffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../base'</span><span class="hl opt">).</span>DecoderBuffer<span class="hl opt">;</span>
<span class="hl kwa">var</span> assert <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'minimalistic-assert'</span><span class="hl opt">);</span>

<span class="hl slc">// Supported tags</span>
<span class="hl kwa">var</span> tags <span class="hl opt">= [</span>
  <span class="hl str">'seq'</span><span class="hl opt">,</span> <span class="hl str">'seqof'</span><span class="hl opt">,</span> <span class="hl str">'set'</span><span class="hl opt">,</span> <span class="hl str">'setof'</span><span class="hl opt">,</span> <span class="hl str">'objid'</span><span class="hl opt">,</span> <span class="hl str">'bool'</span><span class="hl opt">,</span>
  <span class="hl str">'gentime'</span><span class="hl opt">,</span> <span class="hl str">'utctime'</span><span class="hl opt">,</span> <span class="hl str">'null_'</span><span class="hl opt">,</span> <span class="hl str">'enum'</span><span class="hl opt">,</span> <span class="hl str">'int'</span><span class="hl opt">,</span>
  <span class="hl str">'bitstr'</span><span class="hl opt">,</span> <span class="hl str">'bmpstr'</span><span class="hl opt">,</span> <span class="hl str">'charstr'</span><span class="hl opt">,</span> <span class="hl str">'genstr'</span><span class="hl opt">,</span> <span class="hl str">'graphstr'</span><span class="hl opt">,</span> <span class="hl str">'ia5str'</span><span class="hl opt">,</span> <span class="hl str">'iso646str'</span><span class="hl opt">,</span>
  <span class="hl str">'numstr'</span><span class="hl opt">,</span> <span class="hl str">'octstr'</span><span class="hl opt">,</span> <span class="hl str">'printstr'</span><span class="hl opt">,</span> <span class="hl str">'t61str'</span><span class="hl opt">,</span> <span class="hl str">'unistr'</span><span class="hl opt">,</span> <span class="hl str">'utf8str'</span><span class="hl opt">,</span> <span class="hl str">'videostr'</span>
<span class="hl opt">];</span>

<span class="hl slc">// Public methods list</span>
<span class="hl kwa">var</span> methods <span class="hl opt">= [</span>
  <span class="hl str">'key'</span><span class="hl opt">,</span> <span class="hl str">'obj'</span><span class="hl opt">,</span> <span class="hl str">'use'</span><span class="hl opt">,</span> <span class="hl str">'optional'</span><span class="hl opt">,</span> <span class="hl str">'explicit'</span><span class="hl opt">,</span> <span class="hl str">'implicit'</span><span class="hl opt">,</span> <span class="hl str">'def'</span><span class="hl opt">,</span> <span class="hl str">'choice'</span><span class="hl opt">,</span>
  <span class="hl str">'any'</span><span class="hl opt">,</span> <span class="hl str">'contains'</span>
<span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>tags<span class="hl opt">);</span>

<span class="hl slc">// Overrided methods list</span>
<span class="hl kwa">var</span> overrided <span class="hl opt">= [</span>
  <span class="hl str">'_peekTag'</span><span class="hl opt">,</span> <span class="hl str">'_decodeTag'</span><span class="hl opt">,</span> <span class="hl str">'_use'</span><span class="hl opt">,</span>
  <span class="hl str">'_decodeStr'</span><span class="hl opt">,</span> <span class="hl str">'_decodeObjid'</span><span class="hl opt">,</span> <span class="hl str">'_decodeTime'</span><span class="hl opt">,</span>
  <span class="hl str">'_decodeNull'</span><span class="hl opt">,</span> <span class="hl str">'_decodeInt'</span><span class="hl opt">,</span> <span class="hl str">'_decodeBool'</span><span class="hl opt">,</span> <span class="hl str">'_decodeList'</span><span class="hl opt">,</span>

  <span class="hl str">'_encodeComposite'</span><span class="hl opt">,</span> <span class="hl str">'_encodeStr'</span><span class="hl opt">,</span> <span class="hl str">'_encodeObjid'</span><span class="hl opt">,</span> <span class="hl str">'_encodeTime'</span><span class="hl opt">,</span>
  <span class="hl str">'_encodeNull'</span><span class="hl opt">,</span> <span class="hl str">'_encodeInt'</span><span class="hl opt">,</span> <span class="hl str">'_encodeBool'</span>
<span class="hl opt">];</span>

<span class="hl kwa">function</span> <span class="hl kwd">Node</span><span class="hl opt">(</span>enc<span class="hl opt">,</span> parent<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">= {};</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState <span class="hl opt">=</span> state<span class="hl opt">;</span>

  state<span class="hl opt">.</span>enc <span class="hl opt">=</span> enc<span class="hl opt">;</span>

  state<span class="hl opt">.</span>parent <span class="hl opt">=</span> parent <span class="hl opt">||</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>children <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>

  <span class="hl slc">// State</span>
  state<span class="hl opt">.</span>tag <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>args <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>reverseArgs <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>choice <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>optional <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>any <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>obj <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>useDecoder <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>key <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] =</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>explicit <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>implicit <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  state<span class="hl opt">.</span>contains <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>

  <span class="hl slc">// Should create new instance on each method</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>state<span class="hl opt">.</span>parent<span class="hl opt">) {</span>
    state<span class="hl opt">.</span>children <span class="hl opt">= [];</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_wrap</span><span class="hl opt">();</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> Node<span class="hl opt">;</span>

<span class="hl kwa">var</span> stateProps <span class="hl opt">= [</span>
  <span class="hl str">'enc'</span><span class="hl opt">,</span> <span class="hl str">'parent'</span><span class="hl opt">,</span> <span class="hl str">'children'</span><span class="hl opt">,</span> <span class="hl str">'tag'</span><span class="hl opt">,</span> <span class="hl str">'args'</span><span class="hl opt">,</span> <span class="hl str">'reverseArgs'</span><span class="hl opt">,</span> <span class="hl str">'choice'</span><span class="hl opt">,</span>
  <span class="hl str">'optional'</span><span class="hl opt">,</span> <span class="hl str">'any'</span><span class="hl opt">,</span> <span class="hl str">'obj'</span><span class="hl opt">,</span> <span class="hl str">'use'</span><span class="hl opt">,</span> <span class="hl str">'alteredUse'</span><span class="hl opt">,</span> <span class="hl str">'key'</span><span class="hl opt">,</span> <span class="hl str">'default'</span><span class="hl opt">,</span> <span class="hl str">'explicit'</span><span class="hl opt">,</span>
  <span class="hl str">'implicit'</span>
<span class="hl opt">];</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>clone <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">clone</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl kwa">var</span> cstate <span class="hl opt">= {};</span>
  stateProps<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>prop<span class="hl opt">) {</span>
    cstate<span class="hl opt">[</span>prop<span class="hl opt">] =</span> state<span class="hl opt">[</span>prop<span class="hl opt">];</span>
  <span class="hl opt">});</span>
  <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">new this</span><span class="hl opt">.</span><span class="hl kwd">constructor</span><span class="hl opt">(</span>cstate<span class="hl opt">.</span>parent<span class="hl opt">);</span>
  res<span class="hl opt">.</span>_baseState <span class="hl opt">=</span> cstate<span class="hl opt">;</span>
  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_wrap <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">wrap</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  methods<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>method<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">[</span>method<span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl kwd">_wrappedMethod</span><span class="hl opt">() {</span>
      <span class="hl kwa">var</span> clone <span class="hl opt">=</span> <span class="hl kwa">new this</span><span class="hl opt">.</span><span class="hl kwd">constructor</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
      state<span class="hl opt">.</span>children<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>clone<span class="hl opt">);</span>
      <span class="hl kwa">return</span> clone<span class="hl opt">[</span>method<span class="hl opt">].</span><span class="hl kwd">apply</span><span class="hl opt">(</span>clone<span class="hl opt">,</span> arguments<span class="hl opt">);</span>
    <span class="hl opt">};</span>
  <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_init <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">init</span><span class="hl opt">(</span>body<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>parent <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  body<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>

  <span class="hl slc">// Filter children</span>
  state<span class="hl opt">.</span>children <span class="hl opt">=</span> state<span class="hl opt">.</span>children<span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>parent <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
  <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  assert<span class="hl opt">.</span><span class="hl kwd">equal</span><span class="hl opt">(</span>state<span class="hl opt">.</span>children<span class="hl opt">.</span>length<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl str">'Root node can have only one child'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_useArgs <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">useArgs</span><span class="hl opt">(</span>args<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl slc">// Filter children and args</span>
  <span class="hl kwa">var</span> children <span class="hl opt">=</span> args<span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>arg<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> arg <span class="hl kwa">instanceof this</span><span class="hl opt">.</span>constructor<span class="hl opt">;</span>
  <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  args <span class="hl opt">=</span> args<span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>arg<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl opt">!(</span>arg <span class="hl kwa">instanceof this</span><span class="hl opt">.</span>constructor<span class="hl opt">);</span>
  <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>children<span class="hl opt">.</span>length <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>children <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
    state<span class="hl opt">.</span>children <span class="hl opt">=</span> children<span class="hl opt">;</span>

    <span class="hl slc">// Replace parent to maintain backward link</span>
    children<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
      child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>parent <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>args<span class="hl opt">.</span>length <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>args <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
    state<span class="hl opt">.</span>args <span class="hl opt">=</span> args<span class="hl opt">;</span>
    state<span class="hl opt">.</span>reverseArgs <span class="hl opt">=</span> args<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>arg<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> arg <span class="hl opt">!==</span> <span class="hl str">'object'</span> <span class="hl opt">||</span> arg<span class="hl opt">.</span>constructor <span class="hl opt">!==</span> Object<span class="hl opt">)</span>
        <span class="hl kwa">return</span> arg<span class="hl opt">;</span>

      <span class="hl kwa">var</span> res <span class="hl opt">= {};</span>
      Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>arg<span class="hl opt">).</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>key <span class="hl opt">== (</span>key <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">))</span>
          key <span class="hl opt">|=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> value <span class="hl opt">=</span> arg<span class="hl opt">[</span>key<span class="hl opt">];</span>
        res<span class="hl opt">[</span>value<span class="hl opt">] =</span> key<span class="hl opt">;</span>
      <span class="hl opt">});</span>
      <span class="hl kwa">return</span> res<span class="hl opt">;</span>
    <span class="hl opt">});</span>
  <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl slc">//</span>
<span class="hl slc">// Overrided methods</span>
<span class="hl slc">//</span>

overrided<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>method<span class="hl opt">) {</span>
  Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>method<span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl kwd">_overrided</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span>method <span class="hl opt">+</span> <span class="hl str">' not implemented for encoding: '</span> <span class="hl opt">+</span> state<span class="hl opt">.</span>enc<span class="hl opt">);</span>
  <span class="hl opt">};</span>
<span class="hl opt">});</span>

<span class="hl slc">//</span>
<span class="hl slc">// Public methods</span>
<span class="hl slc">//</span>

tags<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>tag<span class="hl opt">) {</span>
  Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>tag<span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl kwd">_tagMethod</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
    <span class="hl kwa">var</span> args <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">);</span>

    <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
    state<span class="hl opt">.</span>tag <span class="hl opt">=</span> tag<span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_useArgs</span><span class="hl opt">(</span>args<span class="hl opt">);</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>
<span class="hl opt">});</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">=</span> <span class="hl kwa">function use</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">=</span> item<span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>optional <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">optional</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  state<span class="hl opt">.</span>optional <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>def <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">def</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] ===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] =</span> val<span class="hl opt">;</span>
  state<span class="hl opt">.</span>optional <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>explicit <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">explicit</span><span class="hl opt">(</span>num<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>explicit <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>implicit <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>explicit <span class="hl opt">=</span> num<span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>implicit <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">implicit</span><span class="hl opt">(</span>num<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>explicit <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>implicit <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>implicit <span class="hl opt">=</span> num<span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>obj <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">obj</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl kwa">var</span> args <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">);</span>

  state<span class="hl opt">.</span>obj <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>args<span class="hl opt">.</span>length <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">)</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_useArgs</span><span class="hl opt">(</span>args<span class="hl opt">);</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>key <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">key</span><span class="hl opt">(</span>newKey<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>key <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>key <span class="hl opt">=</span> newKey<span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>any <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">any</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  state<span class="hl opt">.</span>any <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>choice <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">choice</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>choice <span class="hl opt">=</span> obj<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_useArgs</span><span class="hl opt">(</span>Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>obj<span class="hl opt">).</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">[</span>key<span class="hl opt">];</span>
  <span class="hl opt">}));</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>contains <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">contains</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>contains <span class="hl opt">=</span> item<span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl slc">//</span>
<span class="hl slc">// Decoding</span>
<span class="hl slc">//</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decode</span><span class="hl opt">(</span>input<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl slc">// Decode root node</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>parent <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> input<span class="hl opt">.</span><span class="hl kwd">wrapResult</span><span class="hl opt">(</span>state<span class="hl opt">.</span>children<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>input<span class="hl opt">));</span>

  <span class="hl kwa">var</span> result <span class="hl opt">=</span> state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">];</span>
  <span class="hl kwa">var</span> present <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl kwa">var</span> prevKey<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>key <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    prevKey <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">enterKey</span><span class="hl opt">(</span>state<span class="hl opt">.</span>key<span class="hl opt">);</span>

  <span class="hl slc">// Check if tag is there</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>optional<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> tag <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>explicit <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      tag <span class="hl opt">=</span> state<span class="hl opt">.</span>explicit<span class="hl opt">;</span>
    <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>implicit <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      tag <span class="hl opt">=</span> state<span class="hl opt">.</span>implicit<span class="hl opt">;</span>
    <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>tag <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      tag <span class="hl opt">=</span> state<span class="hl opt">.</span>tag<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp; !</span>state<span class="hl opt">.</span>any<span class="hl opt">) {</span>
      <span class="hl slc">// Trial and Error</span>
      <span class="hl kwa">var</span> save <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">();</span>
      <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeGeneric</span><span class="hl opt">(</span>state<span class="hl opt">.</span>tag<span class="hl opt">,</span> input<span class="hl opt">);</span>
        <span class="hl kwa">else</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeChoice</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
        present <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        present <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      input<span class="hl opt">.</span><span class="hl kwd">restore</span><span class="hl opt">(</span>save<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      present <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_peekTag</span><span class="hl opt">(</span>input<span class="hl opt">,</span> tag<span class="hl opt">,</span> state<span class="hl opt">.</span>any<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>input<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>present<span class="hl opt">))</span>
        <span class="hl kwa">return</span> present<span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Push object on stack</span>
  <span class="hl kwa">var</span> prevObj<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>obj <span class="hl opt">&amp;&amp;</span> present<span class="hl opt">)</span>
    prevObj <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">enterObject</span><span class="hl opt">();</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>present<span class="hl opt">) {</span>
    <span class="hl slc">// Unwrap explicit values</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>explicit <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      <span class="hl kwa">var</span> explicit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeTag</span><span class="hl opt">(</span>input<span class="hl opt">,</span> state<span class="hl opt">.</span>explicit<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>input<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>explicit<span class="hl opt">))</span>
        <span class="hl kwa">return</span> explicit<span class="hl opt">;</span>
      input <span class="hl opt">=</span> explicit<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Unwrap implicit and normal values</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>any<span class="hl opt">)</span>
        <span class="hl kwa">var</span> save <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">();</span>
      <span class="hl kwa">var</span> body <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeTag</span><span class="hl opt">(</span>
        input<span class="hl opt">,</span>
        state<span class="hl opt">.</span>implicit <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> state<span class="hl opt">.</span>implicit <span class="hl opt">:</span> state<span class="hl opt">.</span>tag<span class="hl opt">,</span>
        state<span class="hl opt">.</span>any
      <span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>input<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>body<span class="hl opt">))</span>
        <span class="hl kwa">return</span> body<span class="hl opt">;</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>any<span class="hl opt">)</span>
        result <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">(</span>save<span class="hl opt">);</span>
      <span class="hl kwa">else</span>
        input <span class="hl opt">=</span> body<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Select proper method for tag</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>any<span class="hl opt">)</span>
      result <span class="hl opt">=</span> result<span class="hl opt">;</span>
    <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeGeneric</span><span class="hl opt">(</span>state<span class="hl opt">.</span>tag<span class="hl opt">,</span> input<span class="hl opt">);</span>
    <span class="hl kwa">else</span>
      result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_decodeChoice</span><span class="hl opt">(</span>input<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>input<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>result<span class="hl opt">))</span>
      <span class="hl kwa">return</span> result<span class="hl opt">;</span>

    <span class="hl slc">// Decode children</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>state<span class="hl opt">.</span>any <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>children <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      state<span class="hl opt">.</span>children<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl kwd">decodeChildren</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
        <span class="hl slc">// NOTE: We are ignoring errors here, to let parser continue with other</span>
        <span class="hl slc">// parts of encoded data</span>
        child<span class="hl opt">.</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
      <span class="hl opt">});</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Decode contained/encoded by schema, only in bit or octet strings</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>contains <span class="hl opt">&amp;&amp; (</span>state<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl str">'octstr'</span> <span class="hl opt">||</span> state<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl str">'bitstr'</span><span class="hl opt">)) {</span>
      <span class="hl kwa">var</span> data <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">DecoderBuffer</span><span class="hl opt">(</span>result<span class="hl opt">);</span>
      result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getUse</span><span class="hl opt">(</span>state<span class="hl opt">.</span>contains<span class="hl opt">,</span> input<span class="hl opt">.</span>_reporterState<span class="hl opt">.</span>obj<span class="hl opt">).</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Pop object</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>obj <span class="hl opt">&amp;&amp;</span> present<span class="hl opt">)</span>
    result <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">leaveObject</span><span class="hl opt">(</span>prevObj<span class="hl opt">);</span>

  <span class="hl slc">// Set key</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>key <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp; (</span>result <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">||</span> present <span class="hl opt">===</span> <span class="hl kwa">true</span><span class="hl opt">))</span>
    input<span class="hl opt">.</span><span class="hl kwd">leaveKey</span><span class="hl opt">(</span>prevKey<span class="hl opt">,</span> state<span class="hl opt">.</span>key<span class="hl opt">,</span> result<span class="hl opt">);</span>

  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeGeneric <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeGeneric</span><span class="hl opt">(</span>tag<span class="hl opt">,</span> input<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'seq'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'set'</span><span class="hl opt">)</span>
    <span class="hl kwa">return null</span><span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'seqof'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'setof'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeList</span><span class="hl opt">(</span>input<span class="hl opt">,</span> tag<span class="hl opt">,</span> state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwc">/str$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>tag<span class="hl opt">))</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeStr</span><span class="hl opt">(</span>input<span class="hl opt">,</span> tag<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'objid'</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>args<span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeObjid</span><span class="hl opt">(</span>input<span class="hl opt">,</span> state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span> state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'objid'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeObjid</span><span class="hl opt">(</span>input<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'gentime'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'utctime'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeTime</span><span class="hl opt">(</span>input<span class="hl opt">,</span> tag<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'null_'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeNull</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bool'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeBool</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'int'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'enum'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_decodeInt</span><span class="hl opt">(</span>input<span class="hl opt">,</span> state<span class="hl opt">.</span>args <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_getUse</span><span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span><span class="hl opt">,</span> input<span class="hl opt">.</span>_reporterState<span class="hl opt">.</span>obj<span class="hl opt">).</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">return</span> input<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'unknown tag: '</span> <span class="hl opt">+</span> tag<span class="hl opt">);</span>

  <span class="hl kwa">return null</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_getUse <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_getUse</span><span class="hl opt">(</span>entity<span class="hl opt">,</span> obj<span class="hl opt">) {</span>

  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl slc">// Create altered use decoder if implicit is set</span>
  state<span class="hl opt">.</span>useDecoder <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_use</span><span class="hl opt">(</span>entity<span class="hl opt">,</span> obj<span class="hl opt">);</span>
  <span class="hl kwd">assert</span><span class="hl opt">(</span>state<span class="hl opt">.</span>useDecoder<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>parent <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  state<span class="hl opt">.</span>useDecoder <span class="hl opt">=</span> state<span class="hl opt">.</span>useDecoder<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>children<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>implicit <span class="hl opt">!==</span> state<span class="hl opt">.</span>useDecoder<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>implicit<span class="hl opt">) {</span>
    state<span class="hl opt">.</span>useDecoder <span class="hl opt">=</span> state<span class="hl opt">.</span>useDecoder<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    state<span class="hl opt">.</span>useDecoder<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>implicit <span class="hl opt">=</span> state<span class="hl opt">.</span>implicit<span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">return</span> state<span class="hl opt">.</span>useDecoder<span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeChoice <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeChoice</span><span class="hl opt">(</span>input<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> match <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>

  Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>state<span class="hl opt">.</span>choice<span class="hl opt">).</span><span class="hl kwd">some</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> save <span class="hl opt">=</span> input<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> node <span class="hl opt">=</span> state<span class="hl opt">.</span>choice<span class="hl opt">[</span>key<span class="hl opt">];</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
      <span class="hl kwa">var</span> value <span class="hl opt">=</span> node<span class="hl opt">.</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>input<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>input<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>value<span class="hl opt">))</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>

      result <span class="hl opt">= {</span> type<span class="hl opt">:</span> key<span class="hl opt">,</span> value<span class="hl opt">:</span> value <span class="hl opt">};</span>
      match <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
      input<span class="hl opt">.</span><span class="hl kwd">restore</span><span class="hl opt">(</span>save<span class="hl opt">);</span>
      <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return true</span><span class="hl opt">;</span>
  <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>match<span class="hl opt">)</span>
    <span class="hl kwa">return</span> input<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Choice not matched'</span><span class="hl opt">);</span>

  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl slc">//</span>
<span class="hl slc">// Encoding</span>
<span class="hl slc">//</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_createEncoderBuffer <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">createEncoderBuffer</span><span class="hl opt">(</span>data<span class="hl opt">) {</span>
  <span class="hl kwa">return new</span> <span class="hl kwd">EncoderBuffer</span><span class="hl opt">(</span>data<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>reporter<span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] !==</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] ===</span> data<span class="hl opt">)</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>

  <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodeValue</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>result <span class="hl opt">===</span> undefined<span class="hl opt">)</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_skipDefault</span><span class="hl opt">(</span>result<span class="hl opt">,</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">))</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>

  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeValue <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl slc">// Decode root node</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>parent <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> state<span class="hl opt">.</span>children<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter <span class="hl opt">||</span> <span class="hl kwa">new</span> <span class="hl kwd">Reporter</span><span class="hl opt">());</span>

  <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> present <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

  <span class="hl slc">// Set reporter to share it with a child class</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>reporter <span class="hl opt">=</span> reporter<span class="hl opt">;</span>

  <span class="hl slc">// Check if data is there</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>optional <span class="hl opt">&amp;&amp;</span> data <span class="hl opt">===</span> undefined<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] !==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      data <span class="hl opt">=</span> state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">]</span>
    <span class="hl kwa">else</span>
      <span class="hl kwa">return</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// For error reporting</span>
  <span class="hl kwa">var</span> prevKey<span class="hl opt">;</span>

  <span class="hl slc">// Encode children first</span>
  <span class="hl kwa">var</span> content <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> primitive <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>any<span class="hl opt">) {</span>
    <span class="hl slc">// Anything that was given is translated to buffer</span>
    result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>choice<span class="hl opt">) {</span>
    result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodeChoice</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>contains<span class="hl opt">) {</span>
    content <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getUse</span><span class="hl opt">(</span>state<span class="hl opt">.</span>contains<span class="hl opt">,</span> parent<span class="hl opt">).</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
    primitive <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>children<span class="hl opt">) {</span>
    content <span class="hl opt">=</span> state<span class="hl opt">.</span>children<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl str">'null_'</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> child<span class="hl opt">.</span><span class="hl kwd">_encode</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> reporter<span class="hl opt">,</span> data<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>key <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Child should have a key'</span><span class="hl opt">);</span>
      <span class="hl kwa">var</span> prevKey <span class="hl opt">=</span> reporter<span class="hl opt">.</span><span class="hl kwd">enterKey</span><span class="hl opt">(</span>child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>key<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> data <span class="hl opt">!==</span> <span class="hl str">'object'</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Child expected, but input is not object'</span><span class="hl opt">);</span>

      <span class="hl kwa">var</span> res <span class="hl opt">=</span> child<span class="hl opt">.</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">[</span>child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>key<span class="hl opt">],</span> reporter<span class="hl opt">,</span> data<span class="hl opt">);</span>
      reporter<span class="hl opt">.</span><span class="hl kwd">leaveKey</span><span class="hl opt">(</span>prevKey<span class="hl opt">);</span>

      <span class="hl kwa">return</span> res<span class="hl opt">;</span>
    <span class="hl opt">},</span> <span class="hl kwa">this</span><span class="hl opt">).</span><span class="hl kwd">filter</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
      <span class="hl kwa">return</span> child<span class="hl opt">;</span>
    <span class="hl opt">});</span>
    content <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>content<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl str">'seqof'</span> <span class="hl opt">||</span> state<span class="hl opt">.</span>tag <span class="hl opt">===</span> <span class="hl str">'setof'</span><span class="hl opt">) {</span>
      <span class="hl slc">// TODO(indutny): this should be thrown on DSL level</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!(</span>state<span class="hl opt">.</span>args <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>args<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">))</span>
        <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Too many args for : '</span> <span class="hl opt">+</span> state<span class="hl opt">.</span>tag<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(!</span>Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>data<span class="hl opt">))</span>
        <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'seqof/setof, but data is not Array'</span><span class="hl opt">);</span>

      <span class="hl kwa">var</span> child <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
      child<span class="hl opt">.</span>_baseState<span class="hl opt">.</span>implicit <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
      content <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>data<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_getUse</span><span class="hl opt">(</span>state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span> data<span class="hl opt">).</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>item<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
      <span class="hl opt">},</span> child<span class="hl opt">));</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getUse</span><span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span><span class="hl opt">,</span> parent<span class="hl opt">).</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      content <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodePrimitive</span><span class="hl opt">(</span>state<span class="hl opt">.</span>tag<span class="hl opt">,</span> data<span class="hl opt">);</span>
      primitive <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Encode data itself</span>
  <span class="hl kwa">var</span> result<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>state<span class="hl opt">.</span>any <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>choice <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> tag <span class="hl opt">=</span> state<span class="hl opt">.</span>implicit <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> state<span class="hl opt">.</span>implicit <span class="hl opt">:</span> state<span class="hl opt">.</span>tag<span class="hl opt">;</span>
    <span class="hl kwa">var</span> cls <span class="hl opt">=</span> state<span class="hl opt">.</span>implicit <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> <span class="hl str">'universal'</span> <span class="hl opt">:</span> <span class="hl str">'context'</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
        reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Tag could be ommited only for .use()'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span><span class="hl kwa">use</span> <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
        result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodeComposite</span><span class="hl opt">(</span>tag<span class="hl opt">,</span> primitive<span class="hl opt">,</span> cls<span class="hl opt">,</span> content<span class="hl opt">);</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Wrap in explicit</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>explicit <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodeComposite</span><span class="hl opt">(</span>state<span class="hl opt">.</span>explicit<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl str">'context'</span><span class="hl opt">,</span> result<span class="hl opt">);</span>

  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeChoice <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeChoice</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwa">var</span> node <span class="hl opt">=</span> state<span class="hl opt">.</span>choice<span class="hl opt">[</span>data<span class="hl opt">.</span>type<span class="hl opt">];</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>node<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>
        <span class="hl kwa">false</span><span class="hl opt">,</span>
        data<span class="hl opt">.</span>type <span class="hl opt">+</span> <span class="hl str">' not found in '</span> <span class="hl opt">+</span>
            JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>state<span class="hl opt">.</span>choice<span class="hl opt">)));</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">return</span> node<span class="hl opt">.</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">.</span>value<span class="hl opt">,</span> reporter<span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodePrimitive <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodePrimitive</span><span class="hl opt">(</span>tag<span class="hl opt">,</span> data<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwc">/str$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>tag<span class="hl opt">))</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeStr</span><span class="hl opt">(</span>data<span class="hl opt">,</span> tag<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'objid'</span> <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>args<span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeObjid</span><span class="hl opt">(</span>data<span class="hl opt">,</span> state<span class="hl opt">.</span>reverseArgs<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span> state<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'objid'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeObjid</span><span class="hl opt">(</span>data<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'gentime'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'utctime'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeTime</span><span class="hl opt">(</span>data<span class="hl opt">,</span> tag<span class="hl opt">);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'null_'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeNull</span><span class="hl opt">();</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'int'</span> <span class="hl opt">||</span> tag <span class="hl opt">===</span> <span class="hl str">'enum'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeInt</span><span class="hl opt">(</span>data<span class="hl opt">,</span> state<span class="hl opt">.</span>args <span class="hl opt">&amp;&amp;</span> state<span class="hl opt">.</span>reverseArgs<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bool'</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeBool</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'Unsupported tag: '</span> <span class="hl opt">+</span> tag<span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_isNumstr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isNumstr</span><span class="hl opt">(</span>str<span class="hl opt">) {</span>
  <span class="hl kwa">return</span> <span class="hl kwc">/^[0-9 ]*$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
<span class="hl opt">};</span>

Node<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_isPrintstr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isPrintstr</span><span class="hl opt">(</span>str<span class="hl opt">) {</span>
  <span class="hl kwa">return</span> <span class="hl kwc">/^[A-Za-z0-9 '\(\)\+,\-\.\/:=\?]*$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../base&quot;</span><span class="hl opt">:</span><span class="hl num">10</span><span class="hl opt">,</span><span class="hl str">&quot;minimalistic-assert&quot;</span><span class="hl opt">:</span><span class="hl num">153</span><span class="hl opt">}],</span><span class="hl num">12</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">Reporter</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState <span class="hl opt">= {</span>
    obj<span class="hl opt">:</span> <span class="hl kwa">null</span><span class="hl opt">,</span>
    path<span class="hl opt">: [],</span>
    options<span class="hl opt">:</span> options <span class="hl opt">|| {},</span>
    errors<span class="hl opt">: []</span>
  <span class="hl opt">};</span>
<span class="hl opt">}</span>
exports<span class="hl opt">.</span>Reporter <span class="hl opt">=</span> Reporter<span class="hl opt">;</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isError <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isError</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
  <span class="hl kwa">return</span> obj <span class="hl kwa">instanceof</span> ReporterError<span class="hl opt">;</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>save <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">save</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  <span class="hl kwa">return</span> <span class="hl opt">{</span> obj<span class="hl opt">:</span> state<span class="hl opt">.</span>obj<span class="hl opt">,</span> pathLen<span class="hl opt">:</span> state<span class="hl opt">.</span>path<span class="hl opt">.</span>length <span class="hl opt">};</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>restore <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">restore</span><span class="hl opt">(</span>data<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  state<span class="hl opt">.</span>obj <span class="hl opt">=</span> data<span class="hl opt">.</span>obj<span class="hl opt">;</span>
  state<span class="hl opt">.</span>path <span class="hl opt">=</span> state<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> data<span class="hl opt">.</span>pathLen<span class="hl opt">);</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>enterKey <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">enterKey</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>leaveKey <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">leaveKey</span><span class="hl opt">(</span>index<span class="hl opt">,</span> key<span class="hl opt">,</span> value<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  state<span class="hl opt">.</span>path <span class="hl opt">=</span> state<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> index <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>obj <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    state<span class="hl opt">.</span>obj<span class="hl opt">[</span>key<span class="hl opt">] =</span> value<span class="hl opt">;</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>enterObject <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">enterObject</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  <span class="hl kwa">var</span> prev <span class="hl opt">=</span> state<span class="hl opt">.</span>obj<span class="hl opt">;</span>
  state<span class="hl opt">.</span>obj <span class="hl opt">= {};</span>
  <span class="hl kwa">return</span> prev<span class="hl opt">;</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>leaveObject <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">leaveObject</span><span class="hl opt">(</span>prev<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  <span class="hl kwa">var</span> now <span class="hl opt">=</span> state<span class="hl opt">.</span>obj<span class="hl opt">;</span>
  state<span class="hl opt">.</span>obj <span class="hl opt">=</span> prev<span class="hl opt">;</span>
  <span class="hl kwa">return</span> now<span class="hl opt">;</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>error <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">error</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> err<span class="hl opt">;</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>

  <span class="hl kwa">var</span> inherited <span class="hl opt">=</span> msg <span class="hl kwa">instanceof</span> ReporterError<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>inherited<span class="hl opt">) {</span>
    err <span class="hl opt">=</span> msg<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    err <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ReporterError</span><span class="hl opt">(</span>state<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>elem<span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl str">'['</span> <span class="hl opt">+</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>elem<span class="hl opt">) +</span> <span class="hl str">']'</span><span class="hl opt">;</span>
    <span class="hl opt">}).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">),</span> msg<span class="hl opt">.</span>message <span class="hl opt">||</span> msg<span class="hl opt">,</span> msg<span class="hl opt">.</span>stack<span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>state<span class="hl opt">.</span>options<span class="hl opt">.</span>partial<span class="hl opt">)</span>
    <span class="hl kwa">throw</span> err<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>inherited<span class="hl opt">)</span>
    state<span class="hl opt">.</span>errors<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>err<span class="hl opt">);</span>

  <span class="hl kwa">return</span> err<span class="hl opt">;</span>
<span class="hl opt">};</span>

Reporter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>wrapResult <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">wrapResult</span><span class="hl opt">(</span>result<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reporterState<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>state<span class="hl opt">.</span>options<span class="hl opt">.</span>partial<span class="hl opt">)</span>
    <span class="hl kwa">return</span> result<span class="hl opt">;</span>

  <span class="hl kwa">return</span> <span class="hl opt">{</span>
    result<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>result<span class="hl opt">) ?</span> <span class="hl kwa">null</span> <span class="hl opt">:</span> result<span class="hl opt">,</span>
    errors<span class="hl opt">:</span> state<span class="hl opt">.</span>errors
  <span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">ReporterError</span><span class="hl opt">(</span>path<span class="hl opt">,</span> msg<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>path <span class="hl opt">=</span> path<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">rethrow</span><span class="hl opt">(</span>msg<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>ReporterError<span class="hl opt">,</span> Error<span class="hl opt">);</span>

ReporterError<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>rethrow <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">rethrow</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>message <span class="hl opt">=</span> msg <span class="hl opt">+</span> <span class="hl str">' at: '</span> <span class="hl opt">+ (</span><span class="hl kwa">this</span><span class="hl opt">.</span>path <span class="hl opt">||</span> <span class="hl str">'(shallow)'</span><span class="hl opt">);</span>
  Error<span class="hl opt">.</span><span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> ReporterError<span class="hl opt">);</span>

  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">13</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> constants <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../constants'</span><span class="hl opt">);</span>

exports<span class="hl opt">.</span>tagClass <span class="hl opt">= {</span>
  <span class="hl num">0</span><span class="hl opt">:</span> <span class="hl str">'universal'</span><span class="hl opt">,</span>
  <span class="hl num">1</span><span class="hl opt">:</span> <span class="hl str">'application'</span><span class="hl opt">,</span>
  <span class="hl num">2</span><span class="hl opt">:</span> <span class="hl str">'context'</span><span class="hl opt">,</span>
  <span class="hl num">3</span><span class="hl opt">:</span> <span class="hl str">'private'</span>
<span class="hl opt">};</span>
exports<span class="hl opt">.</span>tagClassByName <span class="hl opt">=</span> constants<span class="hl opt">.</span><span class="hl kwd">_reverse</span><span class="hl opt">(</span>exports<span class="hl opt">.</span>tagClass<span class="hl opt">);</span>

exports<span class="hl opt">.</span>tag <span class="hl opt">= {</span>
  <span class="hl num">0x00</span><span class="hl opt">:</span> <span class="hl str">'end'</span><span class="hl opt">,</span>
  <span class="hl num">0x01</span><span class="hl opt">:</span> <span class="hl str">'bool'</span><span class="hl opt">,</span>
  <span class="hl num">0x02</span><span class="hl opt">:</span> <span class="hl str">'int'</span><span class="hl opt">,</span>
  <span class="hl num">0x03</span><span class="hl opt">:</span> <span class="hl str">'bitstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x04</span><span class="hl opt">:</span> <span class="hl str">'octstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x05</span><span class="hl opt">:</span> <span class="hl str">'null_'</span><span class="hl opt">,</span>
  <span class="hl num">0x06</span><span class="hl opt">:</span> <span class="hl str">'objid'</span><span class="hl opt">,</span>
  <span class="hl num">0x07</span><span class="hl opt">:</span> <span class="hl str">'objDesc'</span><span class="hl opt">,</span>
  <span class="hl num">0x08</span><span class="hl opt">:</span> <span class="hl str">'external'</span><span class="hl opt">,</span>
  <span class="hl num">0x09</span><span class="hl opt">:</span> <span class="hl str">'real'</span><span class="hl opt">,</span>
  <span class="hl num">0x0a</span><span class="hl opt">:</span> <span class="hl str">'enum'</span><span class="hl opt">,</span>
  <span class="hl num">0x0b</span><span class="hl opt">:</span> <span class="hl str">'embed'</span><span class="hl opt">,</span>
  <span class="hl num">0x0c</span><span class="hl opt">:</span> <span class="hl str">'utf8str'</span><span class="hl opt">,</span>
  <span class="hl num">0x0d</span><span class="hl opt">:</span> <span class="hl str">'relativeOid'</span><span class="hl opt">,</span>
  <span class="hl num">0x10</span><span class="hl opt">:</span> <span class="hl str">'seq'</span><span class="hl opt">,</span>
  <span class="hl num">0x11</span><span class="hl opt">:</span> <span class="hl str">'set'</span><span class="hl opt">,</span>
  <span class="hl num">0x12</span><span class="hl opt">:</span> <span class="hl str">'numstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x13</span><span class="hl opt">:</span> <span class="hl str">'printstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x14</span><span class="hl opt">:</span> <span class="hl str">'t61str'</span><span class="hl opt">,</span>
  <span class="hl num">0x15</span><span class="hl opt">:</span> <span class="hl str">'videostr'</span><span class="hl opt">,</span>
  <span class="hl num">0x16</span><span class="hl opt">:</span> <span class="hl str">'ia5str'</span><span class="hl opt">,</span>
  <span class="hl num">0x17</span><span class="hl opt">:</span> <span class="hl str">'utctime'</span><span class="hl opt">,</span>
  <span class="hl num">0x18</span><span class="hl opt">:</span> <span class="hl str">'gentime'</span><span class="hl opt">,</span>
  <span class="hl num">0x19</span><span class="hl opt">:</span> <span class="hl str">'graphstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x1a</span><span class="hl opt">:</span> <span class="hl str">'iso646str'</span><span class="hl opt">,</span>
  <span class="hl num">0x1b</span><span class="hl opt">:</span> <span class="hl str">'genstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x1c</span><span class="hl opt">:</span> <span class="hl str">'unistr'</span><span class="hl opt">,</span>
  <span class="hl num">0x1d</span><span class="hl opt">:</span> <span class="hl str">'charstr'</span><span class="hl opt">,</span>
  <span class="hl num">0x1e</span><span class="hl opt">:</span> <span class="hl str">'bmpstr'</span>
<span class="hl opt">};</span>
exports<span class="hl opt">.</span>tagByName <span class="hl opt">=</span> constants<span class="hl opt">.</span><span class="hl kwd">_reverse</span><span class="hl opt">(</span>exports<span class="hl opt">.</span>tag<span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../constants&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">}],</span><span class="hl num">14</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> constants <span class="hl opt">=</span> exports<span class="hl opt">;</span>

<span class="hl slc">// Helper</span>
constants<span class="hl opt">.</span>_reverse <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">reverse</span><span class="hl opt">(</span>map<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> res <span class="hl opt">= {};</span>

  Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>map<span class="hl opt">).</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
    <span class="hl slc">// Convert key to integer if it is stringified</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>key <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">) ==</span> key<span class="hl opt">)</span>
      key <span class="hl opt">=</span> key <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> value <span class="hl opt">=</span> map<span class="hl opt">[</span>key<span class="hl opt">];</span>
    res<span class="hl opt">[</span>value<span class="hl opt">] =</span> key<span class="hl opt">;</span>
  <span class="hl opt">});</span>

  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">};</span>

constants<span class="hl opt">.</span>der <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./der'</span><span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./der&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">}],</span><span class="hl num">15</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../../asn1'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> base <span class="hl opt">=</span> asn1<span class="hl opt">.</span>base<span class="hl opt">;</span>
<span class="hl kwa">var</span> bignum <span class="hl opt">=</span> asn1<span class="hl opt">.</span>bignum<span class="hl opt">;</span>

<span class="hl slc">// Import DER constants</span>
<span class="hl kwa">var</span> der <span class="hl opt">=</span> asn1<span class="hl opt">.</span>constants<span class="hl opt">.</span>der<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">DERDecoder</span><span class="hl opt">(</span>entity<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>enc <span class="hl opt">=</span> <span class="hl str">'der'</span><span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>name <span class="hl opt">=</span> entity<span class="hl opt">.</span>name<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>entity <span class="hl opt">=</span> entity<span class="hl opt">;</span>

  <span class="hl slc">// Construct base tree</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>tree <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">DERNode</span><span class="hl opt">();</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>tree<span class="hl opt">.</span><span class="hl kwd">_init</span><span class="hl opt">(</span>entity<span class="hl opt">.</span>body<span class="hl opt">);</span>
<span class="hl opt">};</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> DERDecoder<span class="hl opt">;</span>

DERDecoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>decode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!(</span>data <span class="hl kwa">instanceof</span> base<span class="hl opt">.</span>DecoderBuffer<span class="hl opt">))</span>
    data <span class="hl opt">=</span> <span class="hl kwa">new</span> base<span class="hl opt">.</span><span class="hl kwd">DecoderBuffer</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">);</span>

  <span class="hl kwa">return this</span><span class="hl opt">.</span>tree<span class="hl opt">.</span><span class="hl kwd">_decode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl slc">// Tree methods</span>

<span class="hl kwa">function</span> <span class="hl kwd">DERNode</span><span class="hl opt">(</span>parent<span class="hl opt">) {</span>
  base<span class="hl opt">.</span>Node<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">'der'</span><span class="hl opt">,</span> parent<span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>DERNode<span class="hl opt">,</span> base<span class="hl opt">.</span>Node<span class="hl opt">);</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_peekTag <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">peekTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">,</span> any<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isEmpty</span><span class="hl opt">())</span>
    <span class="hl kwa">return false</span><span class="hl opt">;</span>

  <span class="hl kwa">var</span> state <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">();</span>
  <span class="hl kwa">var</span> decodedTag <span class="hl opt">=</span> <span class="hl kwd">derDecodeTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> <span class="hl str">'Failed to peek tag: &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>decodedTag<span class="hl opt">))</span>
    <span class="hl kwa">return</span> decodedTag<span class="hl opt">;</span>

  buffer<span class="hl opt">.</span><span class="hl kwd">restore</span><span class="hl opt">(</span>state<span class="hl opt">);</span>

  <span class="hl kwa">return</span> decodedTag<span class="hl opt">.</span>tag <span class="hl opt">===</span> tag <span class="hl opt">||</span> decodedTag<span class="hl opt">.</span>tagStr <span class="hl opt">===</span> tag <span class="hl opt">||</span>
    <span class="hl opt">(</span>decodedTag<span class="hl opt">.</span>tagStr <span class="hl opt">+</span> <span class="hl str">'of'</span><span class="hl opt">) ===</span> tag <span class="hl opt">||</span> any<span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeTag <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">,</span> any<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> decodedTag <span class="hl opt">=</span> <span class="hl kwd">derDecodeTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span>
                                <span class="hl str">'Failed to decode tag of &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>decodedTag<span class="hl opt">))</span>
    <span class="hl kwa">return</span> decodedTag<span class="hl opt">;</span>

  <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwd">derDecodeLen</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span>
                         decodedTag<span class="hl opt">.</span>primitive<span class="hl opt">,</span>
                         <span class="hl str">'Failed to get length of &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>

  <span class="hl slc">// Failure</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>len<span class="hl opt">))</span>
    <span class="hl kwa">return</span> len<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>any <span class="hl opt">&amp;&amp;</span>
      decodedTag<span class="hl opt">.</span>tag <span class="hl opt">!==</span> tag <span class="hl opt">&amp;&amp;</span>
      decodedTag<span class="hl opt">.</span>tagStr <span class="hl opt">!==</span> tag <span class="hl opt">&amp;&amp;</span>
      decodedTag<span class="hl opt">.</span>tagStr <span class="hl opt">+</span> <span class="hl str">'of'</span> <span class="hl opt">!==</span> tag<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Failed to match tag: &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>decodedTag<span class="hl opt">.</span>primitive <span class="hl opt">||</span> len <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">skip</span><span class="hl opt">(</span>len<span class="hl opt">,</span> <span class="hl str">'Failed to match body of: &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>

  <span class="hl slc">// Indefinite length... find END tag</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">();</span>
  <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_skipUntilEnd</span><span class="hl opt">(</span>
      buffer<span class="hl opt">,</span>
      <span class="hl str">'Failed to skip indefinite length body: &quot;'</span> <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span>tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>res<span class="hl opt">))</span>
    <span class="hl kwa">return</span> res<span class="hl opt">;</span>

  len <span class="hl opt">=</span> buffer<span class="hl opt">.</span>offset <span class="hl opt">-</span> state<span class="hl opt">.</span>offset<span class="hl opt">;</span>
  buffer<span class="hl opt">.</span><span class="hl kwd">restore</span><span class="hl opt">(</span>state<span class="hl opt">);</span>
  <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">skip</span><span class="hl opt">(</span>len<span class="hl opt">,</span> <span class="hl str">'Failed to match body of: &quot;'</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">'&quot;'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_skipUntilEnd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">skipUntilEnd</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> fail<span class="hl opt">) {</span>
  <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> tag <span class="hl opt">=</span> <span class="hl kwd">derDecodeTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> fail<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>tag<span class="hl opt">))</span>
      <span class="hl kwa">return</span> tag<span class="hl opt">;</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwd">derDecodeLen</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">.</span>primitive<span class="hl opt">,</span> fail<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>len<span class="hl opt">))</span>
      <span class="hl kwa">return</span> len<span class="hl opt">;</span>

    <span class="hl kwa">var</span> res<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>tag<span class="hl opt">.</span>primitive <span class="hl opt">||</span> len <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      res <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">skip</span><span class="hl opt">(</span>len<span class="hl opt">)</span>
    <span class="hl kwa">else</span>
      res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_skipUntilEnd</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> fail<span class="hl opt">);</span>

    <span class="hl slc">// Failure</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>res<span class="hl opt">))</span>
      <span class="hl kwa">return</span> res<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>tag<span class="hl opt">.</span>tagStr <span class="hl opt">===</span> <span class="hl str">'end'</span><span class="hl opt">)</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeList <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeList</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">,</span> decoder<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> result <span class="hl opt">= [];</span>
  <span class="hl kwa">while</span> <span class="hl opt">(!</span>buffer<span class="hl opt">.</span><span class="hl kwd">isEmpty</span><span class="hl opt">()) {</span>
    <span class="hl kwa">var</span> possibleEnd <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_peekTag</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> <span class="hl str">'end'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>possibleEnd<span class="hl opt">))</span>
      <span class="hl kwa">return</span> possibleEnd<span class="hl opt">;</span>

    <span class="hl kwa">var</span> res <span class="hl opt">=</span> decoder<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> <span class="hl str">'der'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>res<span class="hl opt">) &amp;&amp;</span> possibleEnd<span class="hl opt">)</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
    result<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>res<span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeStr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeStr</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bitstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> unused <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>unused<span class="hl opt">))</span>
      <span class="hl kwa">return</span> unused<span class="hl opt">;</span>
    <span class="hl kwa">return</span> <span class="hl opt">{</span> unused<span class="hl opt">:</span> unused<span class="hl opt">,</span> data<span class="hl opt">:</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">() };</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bmpstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> raw <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>raw<span class="hl opt">.</span>length <span class="hl opt">%</span> <span class="hl num">2</span> <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Decoding of string type: bmpstr length mismatch'</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> str <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> raw<span class="hl opt">.</span>length <span class="hl opt">/</span> <span class="hl num">2</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      str <span class="hl opt">+=</span> String<span class="hl opt">.</span><span class="hl kwd">fromCharCode</span><span class="hl opt">(</span>raw<span class="hl opt">.</span><span class="hl kwd">readUInt16BE</span><span class="hl opt">(</span>i <span class="hl opt">*</span> <span class="hl num">2</span><span class="hl opt">));</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> str<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'numstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> numstr <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">().</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl str">'ascii'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isNumstr</span><span class="hl opt">(</span>numstr<span class="hl opt">)) {</span>
      <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Decoding of string type: '</span> <span class="hl opt">+</span>
                          <span class="hl str">'numstr unsupported characters'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> numstr<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'octstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">();</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'printstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> printstr <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">().</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl str">'ascii'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isPrintstr</span><span class="hl opt">(</span>printstr<span class="hl opt">)) {</span>
      <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Decoding of string type: '</span> <span class="hl opt">+</span>
                          <span class="hl str">'printstr unsupported characters'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> printstr<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwc">/str$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>tag<span class="hl opt">)) {</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">().</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Decoding of string type: '</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">' unsupported'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeObjid <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeObjid</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> values<span class="hl opt">,</span> relative<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> result<span class="hl opt">;</span>
  <span class="hl kwa">var</span> identifiers <span class="hl opt">= [];</span>
  <span class="hl kwa">var</span> ident <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">while</span> <span class="hl opt">(!</span>buffer<span class="hl opt">.</span><span class="hl kwd">isEmpty</span><span class="hl opt">()) {</span>
    <span class="hl kwa">var</span> subident <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">();</span>
    ident <span class="hl opt">&lt;&lt;=</span> <span class="hl num">7</span><span class="hl opt">;</span>
    ident <span class="hl opt">|=</span> subident <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>subident <span class="hl opt">&amp;</span> <span class="hl num">0x80</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      identifiers<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>ident<span class="hl opt">);</span>
      ident <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>subident <span class="hl opt">&amp;</span> <span class="hl num">0x80</span><span class="hl opt">)</span>
    identifiers<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>ident<span class="hl opt">);</span>

  <span class="hl kwa">var</span> first <span class="hl opt">= (</span>identifiers<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] /</span> <span class="hl num">40</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> second <span class="hl opt">=</span> identifiers<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] %</span> <span class="hl num">40</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>relative<span class="hl opt">)</span>
    result <span class="hl opt">=</span> identifiers<span class="hl opt">;</span>
  <span class="hl kwa">else</span>
    result <span class="hl opt">= [</span>first<span class="hl opt">,</span> second<span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>identifiers<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">));</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>values<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> tmp <span class="hl opt">=</span> values<span class="hl opt">[</span>result<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">' '</span><span class="hl opt">)];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>tmp <span class="hl opt">===</span> undefined<span class="hl opt">)</span>
      tmp <span class="hl opt">=</span> values<span class="hl opt">[</span>result<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">'.'</span><span class="hl opt">)];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>tmp <span class="hl opt">!==</span> undefined<span class="hl opt">)</span>
      result <span class="hl opt">=</span> tmp<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return</span> result<span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeTime <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeTime</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> tag<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> str <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">().</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'gentime'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> year <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> mon <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> day <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> hour <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> min <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">10</span><span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> sec <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">12</span><span class="hl opt">,</span> <span class="hl num">14</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'utctime'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> year <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> mon <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> day <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> hour <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> min <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> sec <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">10</span><span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>year <span class="hl opt">&lt;</span> <span class="hl num">70</span><span class="hl opt">)</span>
      year <span class="hl opt">=</span> <span class="hl num">2000</span> <span class="hl opt">+</span> year<span class="hl opt">;</span>
    <span class="hl kwa">else</span>
      year <span class="hl opt">=</span> <span class="hl num">1900</span> <span class="hl opt">+</span> year<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">return</span> buffer<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Decoding '</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">' time is not supported yet'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return</span> Date<span class="hl opt">.</span><span class="hl kwd">UTC</span><span class="hl opt">(</span>year<span class="hl opt">,</span> mon <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> day<span class="hl opt">,</span> hour<span class="hl opt">,</span> min<span class="hl opt">,</span> sec<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeNull <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeNull</span><span class="hl opt">(</span>buffer<span class="hl opt">) {</span>
  <span class="hl kwa">return null</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeBool <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeBool</span><span class="hl opt">(</span>buffer<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> res <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">();</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buffer<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>res<span class="hl opt">))</span>
    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">return</span> res <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_decodeInt <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decodeInt</span><span class="hl opt">(</span>buffer<span class="hl opt">,</span> values<span class="hl opt">) {</span>
  <span class="hl slc">// Bigint, return as it is (assume big endian)</span>
  <span class="hl kwa">var</span> raw <span class="hl opt">=</span> buffer<span class="hl opt">.</span><span class="hl kwd">raw</span><span class="hl opt">();</span>
  <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">bignum</span><span class="hl opt">(</span>raw<span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>values<span class="hl opt">)</span>
    res <span class="hl opt">=</span> values<span class="hl opt">[</span>res<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">10</span><span class="hl opt">)] ||</span> res<span class="hl opt">;</span>

  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_use <span class="hl opt">=</span> <span class="hl kwa">function use</span><span class="hl opt">(</span>entity<span class="hl opt">,</span> obj<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> entity <span class="hl opt">===</span> <span class="hl str">'function'</span><span class="hl opt">)</span>
    entity <span class="hl opt">=</span> <span class="hl kwd">entity</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
  <span class="hl kwa">return</span> entity<span class="hl opt">.</span><span class="hl kwd">_getDecoder</span><span class="hl opt">(</span><span class="hl str">'der'</span><span class="hl opt">).</span>tree<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl slc">// Utility methods</span>

<span class="hl kwa">function</span> <span class="hl kwd">derDecodeTag</span><span class="hl opt">(</span>buf<span class="hl opt">,</span> fail<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> tag <span class="hl opt">=</span> buf<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">(</span>fail<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buf<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>tag<span class="hl opt">))</span>
    <span class="hl kwa">return</span> tag<span class="hl opt">;</span>

  <span class="hl kwa">var</span> cls <span class="hl opt">=</span> der<span class="hl opt">.</span>tagClass<span class="hl opt">[</span>tag <span class="hl opt">&gt;&gt;</span> <span class="hl num">6</span><span class="hl opt">];</span>
  <span class="hl kwa">var</span> primitive <span class="hl opt">= (</span>tag <span class="hl opt">&amp;</span> <span class="hl num">0x20</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">;</span>

  <span class="hl slc">// Multi-octet tag - load</span>
  <span class="hl kwa">if</span> <span class="hl opt">((</span>tag <span class="hl opt">&amp;</span> <span class="hl num">0x1f</span><span class="hl opt">) ===</span> <span class="hl num">0x1f</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> oct <span class="hl opt">=</span> tag<span class="hl opt">;</span>
    tag <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">((</span>oct <span class="hl opt">&amp;</span> <span class="hl num">0x80</span><span class="hl opt">) ===</span> <span class="hl num">0x80</span><span class="hl opt">) {</span>
      oct <span class="hl opt">=</span> buf<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">(</span>fail<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>buf<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>oct<span class="hl opt">))</span>
        <span class="hl kwa">return</span> oct<span class="hl opt">;</span>

      tag <span class="hl opt">&lt;&lt;=</span> <span class="hl num">7</span><span class="hl opt">;</span>
      tag <span class="hl opt">|=</span> oct <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    tag <span class="hl opt">&amp;=</span> <span class="hl num">0x1f</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">var</span> tagStr <span class="hl opt">=</span> der<span class="hl opt">.</span>tag<span class="hl opt">[</span>tag<span class="hl opt">];</span>

  <span class="hl kwa">return</span> <span class="hl opt">{</span>
    cls<span class="hl opt">:</span> cls<span class="hl opt">,</span>
    primitive<span class="hl opt">:</span> primitive<span class="hl opt">,</span>
    tag<span class="hl opt">:</span> tag<span class="hl opt">,</span>
    tagStr<span class="hl opt">:</span> tagStr
  <span class="hl opt">};</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">derDecodeLen</span><span class="hl opt">(</span>buf<span class="hl opt">,</span> primitive<span class="hl opt">,</span> fail<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> len <span class="hl opt">=</span> buf<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">(</span>fail<span class="hl opt">);</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>buf<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>len<span class="hl opt">))</span>
    <span class="hl kwa">return</span> len<span class="hl opt">;</span>

  <span class="hl slc">// Indefinite form</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>primitive <span class="hl opt">&amp;&amp;</span> len <span class="hl opt">===</span> <span class="hl num">0x80</span><span class="hl opt">)</span>
    <span class="hl kwa">return null</span><span class="hl opt">;</span>

  <span class="hl slc">// Definite form</span>
  <span class="hl kwa">if</span> <span class="hl opt">((</span>len <span class="hl opt">&amp;</span> <span class="hl num">0x80</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
    <span class="hl slc">// Short form</span>
    <span class="hl kwa">return</span> len<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Long form</span>
  <span class="hl kwa">var</span> num <span class="hl opt">=</span> len <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&gt;=</span> <span class="hl num">4</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> buf<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'length octect is too long'</span><span class="hl opt">);</span>

  len <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> num<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
    len <span class="hl opt">&lt;&lt;=</span> <span class="hl num">8</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> j <span class="hl opt">=</span> buf<span class="hl opt">.</span><span class="hl kwd">readUInt8</span><span class="hl opt">(</span>fail<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>buf<span class="hl opt">.</span><span class="hl kwd">isError</span><span class="hl opt">(</span>j<span class="hl opt">))</span>
      <span class="hl kwa">return</span> j<span class="hl opt">;</span>
    len <span class="hl opt">|=</span> j<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return</span> len<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../../asn1&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">16</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> decoders <span class="hl opt">=</span> exports<span class="hl opt">;</span>

decoders<span class="hl opt">.</span>der <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./der'</span><span class="hl opt">);</span>
decoders<span class="hl opt">.</span>pem <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./pem'</span><span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./der&quot;</span><span class="hl opt">:</span><span class="hl num">15</span><span class="hl opt">,</span><span class="hl str">&quot;./pem&quot;</span><span class="hl opt">:</span><span class="hl num">17</span><span class="hl opt">}],</span><span class="hl num">17</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Buffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'buffer'</span><span class="hl opt">).</span>Buffer<span class="hl opt">;</span>

<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../../asn1'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> DERDecoder <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./der'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">PEMDecoder</span><span class="hl opt">(</span>entity<span class="hl opt">) {</span>
  DERDecoder<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> entity<span class="hl opt">);</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>enc <span class="hl opt">=</span> <span class="hl str">'pem'</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>PEMDecoder<span class="hl opt">,</span> DERDecoder<span class="hl opt">);</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> PEMDecoder<span class="hl opt">;</span>

PEMDecoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>decode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">decode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> lines <span class="hl opt">=</span> data<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">().</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl kwc">/[\r\n]+/g</span><span class="hl opt">);</span>

  <span class="hl kwa">var</span> label <span class="hl opt">=</span> options<span class="hl opt">.</span>label<span class="hl opt">.</span><span class="hl kwd">toUpperCase</span><span class="hl opt">();</span>

  <span class="hl kwa">var</span> re <span class="hl opt">=</span> <span class="hl kwc">/^-----(BEGIN|END) ([^-]+)-----$/</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> start <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> end <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> lines<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
    <span class="hl kwa">var</span> match <span class="hl opt">=</span> lines<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">match</span><span class="hl opt">(</span>re<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>match <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
      <span class="hl kwa">continue</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>match<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] !==</span> label<span class="hl opt">)</span>
      <span class="hl kwa">continue</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>start <span class="hl opt">=== -</span><span class="hl num">1</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>match<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] !==</span> <span class="hl str">'BEGIN'</span><span class="hl opt">)</span>
        <span class="hl kwa">break</span><span class="hl opt">;</span>
      start <span class="hl opt">=</span> i<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>match<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] !==</span> <span class="hl str">'END'</span><span class="hl opt">)</span>
        <span class="hl kwa">break</span><span class="hl opt">;</span>
      end <span class="hl opt">=</span> i<span class="hl opt">;</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>start <span class="hl opt">=== -</span><span class="hl num">1</span> <span class="hl opt">||</span> end <span class="hl opt">=== -</span><span class="hl num">1</span><span class="hl opt">)</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'PEM section not found for: '</span> <span class="hl opt">+</span> label<span class="hl opt">);</span>

  <span class="hl kwa">var</span> base64 <span class="hl opt">=</span> lines<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span>start <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">,</span> end<span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
  <span class="hl slc">// Remove excessive symbols</span>
  base64<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/[^a-z0-9\+\/=]+/gi</span><span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">);</span>

  <span class="hl kwa">var</span> input <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>base64<span class="hl opt">,</span> <span class="hl str">'base64'</span><span class="hl opt">);</span>
  <span class="hl kwa">return</span> DERDecoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>decode<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> input<span class="hl opt">,</span> options<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../../asn1&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;./der&quot;</span><span class="hl opt">:</span><span class="hl num">15</span><span class="hl opt">,</span><span class="hl str">&quot;buffer&quot;</span><span class="hl opt">:</span><span class="hl num">58</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">18</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Buffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'buffer'</span><span class="hl opt">).</span>Buffer<span class="hl opt">;</span>

<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../../asn1'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> base <span class="hl opt">=</span> asn1<span class="hl opt">.</span>base<span class="hl opt">;</span>
<span class="hl kwa">var</span> bignum <span class="hl opt">=</span> asn1<span class="hl opt">.</span>bignum<span class="hl opt">;</span>

<span class="hl slc">// Import DER constants</span>
<span class="hl kwa">var</span> der <span class="hl opt">=</span> asn1<span class="hl opt">.</span>constants<span class="hl opt">.</span>der<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">DEREncoder</span><span class="hl opt">(</span>entity<span class="hl opt">) {</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>enc <span class="hl opt">=</span> <span class="hl str">'der'</span><span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>name <span class="hl opt">=</span> entity<span class="hl opt">.</span>name<span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>entity <span class="hl opt">=</span> entity<span class="hl opt">;</span>

  <span class="hl slc">// Construct base tree</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>tree <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">DERNode</span><span class="hl opt">();</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>tree<span class="hl opt">.</span><span class="hl kwd">_init</span><span class="hl opt">(</span>entity<span class="hl opt">.</span>body<span class="hl opt">);</span>
<span class="hl opt">};</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> DEREncoder<span class="hl opt">;</span>

DEREncoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>encode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span>tree<span class="hl opt">.</span><span class="hl kwd">_encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> reporter<span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

<span class="hl slc">// Tree methods</span>

<span class="hl kwa">function</span> <span class="hl kwd">DERNode</span><span class="hl opt">(</span>parent<span class="hl opt">) {</span>
  base<span class="hl opt">.</span>Node<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">'der'</span><span class="hl opt">,</span> parent<span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>DERNode<span class="hl opt">,</span> base<span class="hl opt">.</span>Node<span class="hl opt">);</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeComposite <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeComposite</span><span class="hl opt">(</span>tag<span class="hl opt">,</span>
                                                              primitive<span class="hl opt">,</span>
                                                              cls<span class="hl opt">,</span>
                                                              content<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> encodedTag <span class="hl opt">=</span> <span class="hl kwd">encodeTag</span><span class="hl opt">(</span>tag<span class="hl opt">,</span> primitive<span class="hl opt">,</span> cls<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>reporter<span class="hl opt">);</span>

  <span class="hl slc">// Short form</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>content<span class="hl opt">.</span>length <span class="hl opt">&lt;</span> <span class="hl num">0x80</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> header <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">);</span>
    header<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> encodedTag<span class="hl opt">;</span>
    header<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] =</span> content<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">([</span> header<span class="hl opt">,</span> content <span class="hl opt">]);</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Long form</span>
  <span class="hl slc">// Count octets required to store length</span>
  <span class="hl kwa">var</span> lenOctets <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> content<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0x100</span><span class="hl opt">;</span> i <span class="hl opt">&gt;&gt;=</span> <span class="hl num">8</span><span class="hl opt">)</span>
    lenOctets<span class="hl opt">++;</span>

  <span class="hl kwa">var</span> header <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span><span class="hl num">1</span> <span class="hl opt">+</span> <span class="hl num">1</span> <span class="hl opt">+</span> lenOctets<span class="hl opt">);</span>
  header<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> encodedTag<span class="hl opt">;</span>
  header<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] =</span> <span class="hl num">0x80</span> <span class="hl opt">|</span> lenOctets<span class="hl opt">;</span>

  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> lenOctets<span class="hl opt">,</span> j <span class="hl opt">=</span> content<span class="hl opt">.</span>length<span class="hl opt">;</span> j <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--,</span> j <span class="hl opt">&gt;&gt;=</span> <span class="hl num">8</span><span class="hl opt">)</span>
    header<span class="hl opt">[</span>i<span class="hl opt">] =</span> j <span class="hl opt">&amp;</span> <span class="hl num">0xff</span><span class="hl opt">;</span>

  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">([</span> header<span class="hl opt">,</span> content <span class="hl opt">]);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeStr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeStr</span><span class="hl opt">(</span>str<span class="hl opt">,</span> tag<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bitstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">([</span> str<span class="hl opt">.</span>unused <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">,</span> str<span class="hl opt">.</span>data <span class="hl opt">]);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'bmpstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> buf <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>str<span class="hl opt">.</span>length <span class="hl opt">*</span> <span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> str<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      buf<span class="hl opt">.</span><span class="hl kwd">writeUInt16BE</span><span class="hl opt">(</span>str<span class="hl opt">.</span><span class="hl kwd">charCodeAt</span><span class="hl opt">(</span>i<span class="hl opt">),</span> i <span class="hl opt">*</span> <span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>buf<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'numstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isNumstr</span><span class="hl opt">(</span>str<span class="hl opt">)) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Encoding of string type: numstr supports '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'only digits and space'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'printstr'</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isPrintstr</span><span class="hl opt">(</span>str<span class="hl opt">)) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Encoding of string type: printstr supports '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'only latin upper and lower case letters, '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'digits, space, apostrophe, left and rigth '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'parenthesis, plus sign, comma, hyphen, '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'dot, slash, colon, equal sign, '</span> <span class="hl opt">+</span>
                                 <span class="hl str">'question mark'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwc">/str$/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>tag<span class="hl opt">)) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Encoding of string type: '</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span>
                               <span class="hl str">' unsupported'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeObjid <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeObjid</span><span class="hl opt">(</span>id<span class="hl opt">,</span> values<span class="hl opt">,</span> relative<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> id <span class="hl opt">===</span> <span class="hl str">'string'</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>values<span class="hl opt">)</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'string objid given, but no values map found'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>values<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>id<span class="hl opt">))</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'objid not found in values map'</span><span class="hl opt">);</span>
    id <span class="hl opt">=</span> values<span class="hl opt">[</span>id<span class="hl opt">].</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl kwc">/[\s\.]+/g</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> id<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++)</span>
      id<span class="hl opt">[</span>i<span class="hl opt">] |=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>id<span class="hl opt">)) {</span>
    id <span class="hl opt">=</span> id<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">();</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> id<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++)</span>
      id<span class="hl opt">[</span>i<span class="hl opt">] |=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>id<span class="hl opt">)) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'objid() should be either array or string, '</span> <span class="hl opt">+</span>
                               <span class="hl str">'got: '</span> <span class="hl opt">+</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>id<span class="hl opt">));</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>relative<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>id<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] &gt;=</span> <span class="hl num">40</span><span class="hl opt">)</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Second objid identifier OOB'</span><span class="hl opt">);</span>
    id<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">,</span> id<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] *</span> <span class="hl num">40</span> <span class="hl opt">+</span> id<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]);</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Count number of octets</span>
  <span class="hl kwa">var</span> size <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> id<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
    <span class="hl kwa">var</span> ident <span class="hl opt">=</span> id<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>size<span class="hl opt">++;</span> ident <span class="hl opt">&gt;=</span> <span class="hl num">0x80</span><span class="hl opt">;</span> ident <span class="hl opt">&gt;&gt;=</span> <span class="hl num">7</span><span class="hl opt">)</span>
      size<span class="hl opt">++;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">var</span> objid <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>size<span class="hl opt">);</span>
  <span class="hl kwa">var</span> offset <span class="hl opt">=</span> objid<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> id<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
    <span class="hl kwa">var</span> ident <span class="hl opt">=</span> id<span class="hl opt">[</span>i<span class="hl opt">];</span>
    objid<span class="hl opt">[</span>offset<span class="hl opt">--] =</span> ident <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">((</span>ident <span class="hl opt">&gt;&gt;=</span> <span class="hl num">7</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">)</span>
      objid<span class="hl opt">[</span>offset<span class="hl opt">--] =</span> <span class="hl num">0x80</span> <span class="hl opt">| (</span>ident <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>objid<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">two</span><span class="hl opt">(</span>num<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">10</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> <span class="hl str">'0'</span> <span class="hl opt">+</span> num<span class="hl opt">;</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">return</span> num<span class="hl opt">;</span>
<span class="hl opt">}</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeTime <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeTime</span><span class="hl opt">(</span>time<span class="hl opt">,</span> tag<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> str<span class="hl opt">;</span>
  <span class="hl kwa">var</span> date <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Date</span><span class="hl opt">(</span>time<span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'gentime'</span><span class="hl opt">) {</span>
    str <span class="hl opt">= [</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getFullYear</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCMonth</span><span class="hl opt">() +</span> <span class="hl num">1</span><span class="hl opt">),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCDate</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCHours</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCMinutes</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCSeconds</span><span class="hl opt">()),</span>
      <span class="hl str">'Z'</span>
    <span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'utctime'</span><span class="hl opt">) {</span>
    str <span class="hl opt">= [</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getFullYear</span><span class="hl opt">() %</span> <span class="hl num">100</span><span class="hl opt">),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCMonth</span><span class="hl opt">() +</span> <span class="hl num">1</span><span class="hl opt">),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCDate</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCHours</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCMinutes</span><span class="hl opt">()),</span>
      <span class="hl kwd">two</span><span class="hl opt">(</span>date<span class="hl opt">.</span><span class="hl kwd">getUTCSeconds</span><span class="hl opt">()),</span>
      <span class="hl str">'Z'</span>
    <span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Encoding '</span> <span class="hl opt">+</span> tag <span class="hl opt">+</span> <span class="hl str">' time is not supported yet'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_encodeStr</span><span class="hl opt">(</span>str<span class="hl opt">,</span> <span class="hl str">'octstr'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeNull <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeNull</span><span class="hl opt">() {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeInt <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeInt</span><span class="hl opt">(</span>num<span class="hl opt">,</span> values<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> num <span class="hl opt">===</span> <span class="hl str">'string'</span><span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>values<span class="hl opt">)</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'String int or enum given, but no values map'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>values<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>num<span class="hl opt">)) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Values map doesn</span><span class="hl esc">\'</span><span class="hl str">t contain: '</span> <span class="hl opt">+</span>
                                 JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>num<span class="hl opt">));</span>
    <span class="hl opt">}</span>
    num <span class="hl opt">=</span> values<span class="hl opt">[</span>num<span class="hl opt">];</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Bignum, assume big endian</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> num <span class="hl opt">!==</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp; !</span>Buffer<span class="hl opt">.</span><span class="hl kwd">isBuffer</span><span class="hl opt">(</span>num<span class="hl opt">)) {</span>
    <span class="hl kwa">var</span> numArray <span class="hl opt">=</span> num<span class="hl opt">.</span><span class="hl kwd">toArray</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>num<span class="hl opt">.</span>sign <span class="hl opt">&amp;&amp;</span> numArray<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> <span class="hl num">0x80</span><span class="hl opt">) {</span>
      numArray<span class="hl opt">.</span><span class="hl kwd">unshift</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    num <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>numArray<span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>Buffer<span class="hl opt">.</span><span class="hl kwd">isBuffer</span><span class="hl opt">(</span>num<span class="hl opt">)) {</span>
    <span class="hl kwa">var</span> size <span class="hl opt">=</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span>
      size<span class="hl opt">++;</span>

    <span class="hl kwa">var</span> out <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>size<span class="hl opt">);</span>
    num<span class="hl opt">.</span><span class="hl kwd">copy</span><span class="hl opt">(</span>out<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span>
      out<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> <span class="hl num">0</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>out<span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0x80</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>num<span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0x100</span><span class="hl opt">)</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">([</span><span class="hl num">0</span><span class="hl opt">,</span> num<span class="hl opt">]);</span>

  <span class="hl kwa">var</span> size <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> num<span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0x100</span><span class="hl opt">;</span> i <span class="hl opt">&gt;&gt;=</span> <span class="hl num">8</span><span class="hl opt">)</span>
    size<span class="hl opt">++;</span>

  <span class="hl kwa">var</span> out <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>size<span class="hl opt">);</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> out<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
    out<span class="hl opt">[</span>i<span class="hl opt">] =</span> num <span class="hl opt">&amp;</span> <span class="hl num">0xff</span><span class="hl opt">;</span>
    num <span class="hl opt">&gt;&gt;=</span> <span class="hl num">8</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span><span class="hl opt">(</span>out<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> <span class="hl num">0x80</span><span class="hl opt">) {</span>
    out<span class="hl opt">.</span><span class="hl kwd">unshift</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">Buffer</span><span class="hl opt">(</span>out<span class="hl opt">));</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_encodeBool <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encodeBool</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
  <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_createEncoderBuffer</span><span class="hl opt">(</span>value <span class="hl opt">?</span> <span class="hl num">0xff</span> <span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_use <span class="hl opt">=</span> <span class="hl kwa">function use</span><span class="hl opt">(</span>entity<span class="hl opt">,</span> obj<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> entity <span class="hl opt">===</span> <span class="hl str">'function'</span><span class="hl opt">)</span>
    entity <span class="hl opt">=</span> <span class="hl kwd">entity</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
  <span class="hl kwa">return</span> entity<span class="hl opt">.</span><span class="hl kwd">_getEncoder</span><span class="hl opt">(</span><span class="hl str">'der'</span><span class="hl opt">).</span>tree<span class="hl opt">;</span>
<span class="hl opt">};</span>

DERNode<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_skipDefault <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">skipDefault</span><span class="hl opt">(</span>dataBuffer<span class="hl opt">,</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> state <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_baseState<span class="hl opt">;</span>
  <span class="hl kwa">var</span> i<span class="hl opt">;</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">] ===</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl kwa">return false</span><span class="hl opt">;</span>

  <span class="hl kwa">var</span> data <span class="hl opt">=</span> dataBuffer<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">();</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>state<span class="hl opt">.</span>defaultBuffer <span class="hl opt">===</span> undefined<span class="hl opt">)</span>
    state<span class="hl opt">.</span>defaultBuffer <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_encodeValue</span><span class="hl opt">(</span>state<span class="hl opt">[</span><span class="hl str">'default'</span><span class="hl opt">],</span> reporter<span class="hl opt">,</span> parent<span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">();</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>data<span class="hl opt">.</span>length <span class="hl opt">!==</span> state<span class="hl opt">.</span>defaultBuffer<span class="hl opt">.</span>length<span class="hl opt">)</span>
    <span class="hl kwa">return false</span><span class="hl opt">;</span>

  <span class="hl kwa">for</span> <span class="hl opt">(</span>i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> data<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++)</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">] !==</span> state<span class="hl opt">.</span>defaultBuffer<span class="hl opt">[</span>i<span class="hl opt">])</span>
      <span class="hl kwa">return false</span><span class="hl opt">;</span>

  <span class="hl kwa">return true</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl slc">// Utility methods</span>

<span class="hl kwa">function</span> <span class="hl kwd">encodeTag</span><span class="hl opt">(</span>tag<span class="hl opt">,</span> primitive<span class="hl opt">,</span> cls<span class="hl opt">,</span> reporter<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> res<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'seqof'</span><span class="hl opt">)</span>
    tag <span class="hl opt">=</span> <span class="hl str">'seq'</span><span class="hl opt">;</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span>tag <span class="hl opt">===</span> <span class="hl str">'setof'</span><span class="hl opt">)</span>
    tag <span class="hl opt">=</span> <span class="hl str">'set'</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>der<span class="hl opt">.</span>tagByName<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>tag<span class="hl opt">))</span>
    res <span class="hl opt">=</span> der<span class="hl opt">.</span>tagByName<span class="hl opt">[</span>tag<span class="hl opt">];</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> tag <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp; (</span>tag <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">) ===</span> tag<span class="hl opt">)</span>
    res <span class="hl opt">=</span> tag<span class="hl opt">;</span>
  <span class="hl kwa">else</span>
    <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Unknown tag: '</span> <span class="hl opt">+</span> tag<span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>res <span class="hl opt">&gt;=</span> <span class="hl num">0x1f</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> reporter<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">(</span><span class="hl str">'Multi-octet tag encoding unsupported'</span><span class="hl opt">);</span>

  <span class="hl kwa">if</span> <span class="hl opt">(!</span>primitive<span class="hl opt">)</span>
    res <span class="hl opt">|=</span> <span class="hl num">0x20</span><span class="hl opt">;</span>

  res <span class="hl opt">|= (</span>der<span class="hl opt">.</span>tagClassByName<span class="hl opt">[</span>cls <span class="hl opt">||</span> <span class="hl str">'universal'</span><span class="hl opt">] &lt;&lt;</span> <span class="hl num">6</span><span class="hl opt">);</span>

  <span class="hl kwa">return</span> res<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../../asn1&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;buffer&quot;</span><span class="hl opt">:</span><span class="hl num">58</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">19</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> encoders <span class="hl opt">=</span> exports<span class="hl opt">;</span>

encoders<span class="hl opt">.</span>der <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./der'</span><span class="hl opt">);</span>
encoders<span class="hl opt">.</span>pem <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./pem'</span><span class="hl opt">);</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./der&quot;</span><span class="hl opt">:</span><span class="hl num">18</span><span class="hl opt">,</span><span class="hl str">&quot;./pem&quot;</span><span class="hl opt">:</span><span class="hl num">20</span><span class="hl opt">}],</span><span class="hl num">20</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'inherits'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Buffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'buffer'</span><span class="hl opt">).</span>Buffer<span class="hl opt">;</span>

<span class="hl kwa">var</span> asn1 <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'../../asn1'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> DEREncoder <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./der'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">PEMEncoder</span><span class="hl opt">(</span>entity<span class="hl opt">) {</span>
  DEREncoder<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> entity<span class="hl opt">);</span>
  <span class="hl kwa">this</span><span class="hl opt">.</span>enc <span class="hl opt">=</span> <span class="hl str">'pem'</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>PEMEncoder<span class="hl opt">,</span> DEREncoder<span class="hl opt">);</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> PEMEncoder<span class="hl opt">;</span>

PEMEncoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>encode <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">encode</span><span class="hl opt">(</span>data<span class="hl opt">,</span> options<span class="hl opt">) {</span>
  <span class="hl kwa">var</span> buf <span class="hl opt">=</span> DEREncoder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>encode<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> data<span class="hl opt">);</span>

  <span class="hl kwa">var</span> p <span class="hl opt">=</span> buf<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl str">'base64'</span><span class="hl opt">);</span>
  <span class="hl kwa">var</span> out <span class="hl opt">= [</span> <span class="hl str">'-----BEGIN '</span> <span class="hl opt">+</span> options<span class="hl opt">.</span>label <span class="hl opt">+</span> <span class="hl str">'-----'</span> <span class="hl opt">];</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> p<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">+=</span> <span class="hl num">64</span><span class="hl opt">)</span>
    out<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>p<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span>i<span class="hl opt">,</span> i <span class="hl opt">+</span> <span class="hl num">64</span><span class="hl opt">));</span>
  out<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl str">'-----END '</span> <span class="hl opt">+</span> options<span class="hl opt">.</span>label <span class="hl opt">+</span> <span class="hl str">'-----'</span><span class="hl opt">);</span>
  <span class="hl kwa">return</span> out<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;../../asn1&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;./der&quot;</span><span class="hl opt">:</span><span class="hl num">18</span><span class="hl opt">,</span><span class="hl str">&quot;buffer&quot;</span><span class="hl opt">:</span><span class="hl num">58</span><span class="hl opt">,</span><span class="hl str">&quot;inherits&quot;</span><span class="hl opt">:</span><span class="hl num">144</span><span class="hl opt">}],</span><span class="hl num">21</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> Backoff <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./lib/backoff'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> ExponentialBackoffStrategy <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./lib/strategy/exponential'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> FibonacciBackoffStrategy <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./lib/strategy/fibonacci'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> FunctionCall <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./lib/function_call.js'</span><span class="hl opt">);</span>

module<span class="hl opt">.</span>exports<span class="hl opt">.</span>Backoff <span class="hl opt">=</span> Backoff<span class="hl opt">;</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span>FunctionCall <span class="hl opt">=</span> FunctionCall<span class="hl opt">;</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span>FibonacciStrategy <span class="hl opt">=</span> FibonacciBackoffStrategy<span class="hl opt">;</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span>ExponentialStrategy <span class="hl opt">=</span> ExponentialBackoffStrategy<span class="hl opt">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * Constructs a Fibonacci backoff.</span>
<span class="hl com"> * &#64;param options Fibonacci backoff strategy arguments.</span>
<span class="hl com"> * &#64;return The fibonacci backoff.</span>
<span class="hl com"> * &#64;see FibonacciBackoffStrategy</span>
<span class="hl com"> */</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span><span class="hl kwd">fibonacci</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">Backoff</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">FibonacciBackoffStrategy</span><span class="hl opt">(</span>options<span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Constructs an exponential backoff.</span>
<span class="hl com"> * &#64;param options Exponential strategy arguments.</span>
<span class="hl com"> * &#64;return The exponential backoff.</span>
<span class="hl com"> * &#64;see ExponentialBackoffStrategy</span>
<span class="hl com"> */</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span><span class="hl kwd">exponential</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">Backoff</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">ExponentialBackoffStrategy</span><span class="hl opt">(</span>options<span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Constructs a FunctionCall for the given function and arguments.</span>
<span class="hl com"> * &#64;param fn The function to wrap in a backoff handler.</span>
<span class="hl com"> * &#64;param vargs The function's arguments (var args).</span>
<span class="hl com"> * &#64;param callback The function's callback.</span>
<span class="hl com"> * &#64;return The FunctionCall instance.</span>
<span class="hl com"> */</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span><span class="hl kwd">call</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> vargs<span class="hl opt">,</span> callback<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> args <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">);</span>
    fn <span class="hl opt">=</span> args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    vargs <span class="hl opt">=</span> args<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">,</span> args<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
    callback <span class="hl opt">=</span> args<span class="hl opt">[</span>args<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">FunctionCall</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> vargs<span class="hl opt">,</span> callback<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./lib/backoff&quot;</span><span class="hl opt">:</span><span class="hl num">22</span><span class="hl opt">,</span><span class="hl str">&quot;./lib/function_call.js&quot;</span><span class="hl opt">:</span><span class="hl num">23</span><span class="hl opt">,</span><span class="hl str">&quot;./lib/strategy/exponential&quot;</span><span class="hl opt">:</span><span class="hl num">24</span><span class="hl opt">,</span><span class="hl str">&quot;./lib/strategy/fibonacci&quot;</span><span class="hl opt">:</span><span class="hl num">25</span><span class="hl opt">}],</span><span class="hl num">22</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> events <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'events'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'util'</span><span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Backoff driver.</span>
<span class="hl com"> * &#64;param backoffStrategy Backoff delay generator/strategy.</span>
<span class="hl com"> * &#64;constructor</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">Backoff</span><span class="hl opt">(</span>backoffStrategy<span class="hl opt">) {</span>
    events<span class="hl opt">.</span>EventEmitter<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffStrategy_ <span class="hl opt">=</span> backoffStrategy<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>maxNumberOfRetry_ <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_ <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>handlers <span class="hl opt">= {</span>
        backoff<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>onBackoff_<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">)</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>Backoff<span class="hl opt">,</span> events<span class="hl opt">.</span>EventEmitter<span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Sets a limit, greater than 0, on the maximum number of backoffs. A 'fail'</span>
<span class="hl com"> * event will be emitted when the limit is reached.</span>
<span class="hl com"> * &#64;param maxNumberOfRetry The maximum number of backoffs.</span>
<span class="hl com"> */</span>
Backoff<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">failAfter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>maxNumberOfRetry<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>maxNumberOfRetry <span class="hl opt">&lt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'Maximum number of retry must be greater than 0. '</span> <span class="hl opt">+</span>
                        <span class="hl str">'Actual: '</span> <span class="hl opt">+</span> maxNumberOfRetry<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>maxNumberOfRetry_ <span class="hl opt">=</span> maxNumberOfRetry<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Starts a backoff operation.</span>
<span class="hl com"> * &#64;param err Optional paramater to let the listeners know why the backoff</span>
<span class="hl com"> *     operation was started.</span>
<span class="hl com"> */</span>
Backoff<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">backoff</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>err<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_ <span class="hl opt">!== -</span><span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'Backoff in progress.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_ <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>maxNumberOfRetry_<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'fail'</span><span class="hl opt">,</span> err<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">reset</span><span class="hl opt">();</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffStrategy_<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_ <span class="hl opt">=</span> <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>handlers<span class="hl opt">.</span>backoff<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'backoff'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_<span class="hl opt">,</span> err<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Handles the backoff timeout completion.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
Backoff<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">onBackoff_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_ <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'ready'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_<span class="hl opt">++;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Stops any backoff operation and resets the backoff delay to its inital</span>
<span class="hl com"> * value.</span>
<span class="hl com"> */</span>
Backoff<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reset</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffNumber_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffStrategy_<span class="hl opt">.</span><span class="hl kwd">reset</span><span class="hl opt">();</span>
    <span class="hl kwd">clearTimeout</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>timeoutID_ <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> Backoff<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;events&quot;</span><span class="hl opt">:</span><span class="hl num">131</span><span class="hl opt">,</span><span class="hl str">&quot;util&quot;</span><span class="hl opt">:</span><span class="hl num">256</span><span class="hl opt">}],</span><span class="hl num">23</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> events <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'events'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'util'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> Backoff <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./backoff'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> FibonacciBackoffStrategy <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./strategy/fibonacci'</span><span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Returns true if the specified value is a function</span>
<span class="hl com"> * &#64;param val Variable to test.</span>
<span class="hl com"> * &#64;return Whether variable is a function.</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">isFunction</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
    <span class="hl kwa">return typeof</span> val <span class="hl opt">==</span> <span class="hl str">'function'</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl com">/**</span>
<span class="hl com"> * Manages the calling of a function in a backoff loop.</span>
<span class="hl com"> * &#64;param fn Function to wrap in a backoff handler.</span>
<span class="hl com"> * &#64;param args Array of function's arguments.</span>
<span class="hl com"> * &#64;param callback Function's callback.</span>
<span class="hl com"> * &#64;constructor</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">FunctionCall</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> args<span class="hl opt">,</span> callback<span class="hl opt">) {</span>
    events<span class="hl opt">.</span>EventEmitter<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isFunction</span><span class="hl opt">(</span>fn<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'fn should be a function.'</span> <span class="hl opt">+</span>
                        <span class="hl str">'Actual: '</span> <span class="hl opt">+</span> <span class="hl kwa">typeof</span> fn<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isFunction</span><span class="hl opt">(</span>callback<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'callback should be a function.'</span> <span class="hl opt">+</span>
                        <span class="hl str">'Actual: '</span> <span class="hl opt">+</span> <span class="hl kwa">typeof</span> fn<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>function_ <span class="hl opt">=</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>arguments_ <span class="hl opt">=</span> args<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>callback_ <span class="hl opt">=</span> callback<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>results_ <span class="hl opt">= [];</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_ <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>strategy_ <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>failAfter_ <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>state_ <span class="hl opt">=</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>PENDING<span class="hl opt">;</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>FunctionCall<span class="hl opt">,</span> events<span class="hl opt">.</span>EventEmitter<span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Enum of states in which the FunctionCall can be.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span>State_ <span class="hl opt">= {</span>
    PENDING<span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
    RUNNING<span class="hl opt">:</span> <span class="hl num">1</span><span class="hl opt">,</span>
    COMPLETED<span class="hl opt">:</span> <span class="hl num">2</span><span class="hl opt">,</span>
    ABORTED<span class="hl opt">:</span> <span class="hl num">3</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * &#64;return Whether the call is pending.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isPending</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>state_ <span class="hl opt">==</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>PENDING<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * &#64;return Whether the call is in progress.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isRunning</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>state_ <span class="hl opt">==</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>RUNNING<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * &#64;return Whether the call is completed.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isCompleted</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>state_ <span class="hl opt">==</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>COMPLETED<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * &#64;return Whether the call is aborted.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isAborted</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>state_ <span class="hl opt">==</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>ABORTED<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Sets the backoff strategy.</span>
<span class="hl com"> * &#64;param strategy The backoff strategy to use.</span>
<span class="hl com"> * &#64;return Itself for chaining.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">setStrategy</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>strategy<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isPending</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'FunctionCall in progress.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>strategy_ <span class="hl opt">=</span> strategy<span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Returns all intermediary results returned by the wrapped function since</span>
<span class="hl com"> * the initial call.</span>
<span class="hl com"> * &#64;return An array of intermediary results.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">getResults</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>results_<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Sets the backoff limit.</span>
<span class="hl com"> * &#64;param maxNumberOfRetry The maximum number of backoffs.</span>
<span class="hl com"> * &#64;return Itself for chaining.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">failAfter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>maxNumberOfRetry<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isPending</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'FunctionCall in progress.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>failAfter_ <span class="hl opt">=</span> maxNumberOfRetry<span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Aborts the call.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">abort</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isCompleted</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'FunctionCall already completed.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isRunning</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">reset</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>state_ <span class="hl opt">=</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>ABORTED<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Initiates the call to the wrapped function.</span>
<span class="hl com"> * &#64;param backoffFactory Optional factory function used to create the backoff</span>
<span class="hl com"> *     instance.</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">start</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>backoffFactory<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isAborted</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'FunctionCall aborted.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isPending</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'FunctionCall already started.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> strategy <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>strategy_ <span class="hl opt">||</span> <span class="hl kwa">new</span> <span class="hl kwd">FibonacciBackoffStrategy</span><span class="hl opt">();</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_ <span class="hl opt">=</span> backoffFactory <span class="hl opt">?</span>
        <span class="hl kwd">backoffFactory</span><span class="hl opt">(</span>strategy<span class="hl opt">) :</span>
        <span class="hl kwa">new</span> <span class="hl kwd">Backoff</span><span class="hl opt">(</span>strategy<span class="hl opt">);</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'ready'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>doCall_<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">));</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'fail'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>doCallback_<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">));</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'backoff'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>handleBackoff_<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">));</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>failAfter_ <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">failAfter</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>failAfter_<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>state_ <span class="hl opt">=</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>RUNNING<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">doCall_</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Calls the wrapped function.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">doCall_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> eventArgs <span class="hl opt">= [</span><span class="hl str">'call'</span><span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>arguments_<span class="hl opt">);</span>
    events<span class="hl opt">.</span>EventEmitter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>emit<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> eventArgs<span class="hl opt">);</span>
    <span class="hl kwa">var</span> callback <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>handleFunctionCallback_<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>function_<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>arguments_<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span>callback<span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Calls the wrapped function's callback with the last result returned by the</span>
<span class="hl com"> * wrapped function.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">doCallback_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> args <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>results_<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>results_<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>callback_<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> args<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Handles wrapped function's completion. This method acts as a replacement</span>
<span class="hl com"> * for the original callback function.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">handleFunctionCallback_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isAborted</span><span class="hl opt">()) {</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> args <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>results_<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>args<span class="hl opt">);</span> <span class="hl slc">// Save callback arguments.</span>
    events<span class="hl opt">.</span>EventEmitter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>emit<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">, [</span><span class="hl str">'callback'</span><span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>args<span class="hl opt">));</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>backoff_<span class="hl opt">.</span><span class="hl kwd">backoff</span><span class="hl opt">(</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>state_ <span class="hl opt">=</span> FunctionCall<span class="hl opt">.</span>State_<span class="hl opt">.</span>COMPLETED<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">doCallback_</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Handles backoff event.</span>
<span class="hl com"> * &#64;param number Backoff number.</span>
<span class="hl com"> * &#64;param delay Backoff delay.</span>
<span class="hl com"> * &#64;param err The error that caused the backoff.</span>
<span class="hl com"> * &#64;private</span>
<span class="hl com"> */</span>
FunctionCall<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">handleBackoff_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>number<span class="hl opt">,</span> delay<span class="hl opt">,</span> err<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">'backoff'</span><span class="hl opt">,</span> number<span class="hl opt">,</span> delay<span class="hl opt">,</span> err<span class="hl opt">);</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> FunctionCall<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./backoff&quot;</span><span class="hl opt">:</span><span class="hl num">22</span><span class="hl opt">,</span><span class="hl str">&quot;./strategy/fibonacci&quot;</span><span class="hl opt">:</span><span class="hl num">25</span><span class="hl opt">,</span><span class="hl str">&quot;events&quot;</span><span class="hl opt">:</span><span class="hl num">131</span><span class="hl opt">,</span><span class="hl str">&quot;util&quot;</span><span class="hl opt">:</span><span class="hl num">256</span><span class="hl opt">}],</span><span class="hl num">24</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'util'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> BackoffStrategy <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./strategy'</span><span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Exponential backoff strategy.</span>
<span class="hl com"> * &#64;extends BackoffStrategy</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">ExponentialBackoffStrategy</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
    BackoffStrategy<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> options<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getInitialDelay</span><span class="hl opt">();</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>ExponentialBackoffStrategy<span class="hl opt">,</span> BackoffStrategy<span class="hl opt">);</span>

<span class="hl com">/** &#64;inheritDoc */</span>
ExponentialBackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">next_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getMaxDelay</span><span class="hl opt">());</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">*</span> <span class="hl num">2</span><span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>backoffDelay_<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/** &#64;inheritDoc */</span>
ExponentialBackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reset_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getInitialDelay</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> ExponentialBackoffStrategy<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./strategy&quot;</span><span class="hl opt">:</span><span class="hl num">26</span><span class="hl opt">,</span><span class="hl str">&quot;util&quot;</span><span class="hl opt">:</span><span class="hl num">256</span><span class="hl opt">}],</span><span class="hl num">25</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'util'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> BackoffStrategy <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./strategy'</span><span class="hl opt">);</span>

<span class="hl com">/**</span>
<span class="hl com"> * Fibonacci backoff strategy.</span>
<span class="hl com"> * &#64;extends BackoffStrategy</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">FibonacciBackoffStrategy</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
    BackoffStrategy<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> options<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getInitialDelay</span><span class="hl opt">();</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>FibonacciBackoffStrategy<span class="hl opt">,</span> BackoffStrategy<span class="hl opt">);</span>

<span class="hl com">/** &#64;inheritDoc */</span>
FibonacciBackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">next_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> backoffDelay <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getMaxDelay</span><span class="hl opt">());</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">+=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> backoffDelay<span class="hl opt">;</span>
    <span class="hl kwa">return</span> backoffDelay<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/** &#64;inheritDoc */</span>
FibonacciBackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reset_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>nextBackoffDelay_ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getInitialDelay</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>backoffDelay_ <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> FibonacciBackoffStrategy<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./strategy&quot;</span><span class="hl opt">:</span><span class="hl num">26</span><span class="hl opt">,</span><span class="hl str">&quot;util&quot;</span><span class="hl opt">:</span><span class="hl num">256</span><span class="hl opt">}],</span><span class="hl num">26</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*</span>
<span class="hl com"> * Copyright (c) 2012 Mathieu Turcotte</span>
<span class="hl com"> * Licensed under the MIT license.</span>
<span class="hl com"> */</span>

<span class="hl kwa">var</span> events <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'events'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'util'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">isDef</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> value <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span> value <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl com">/**</span>
<span class="hl com"> * Abstract class defining the skeleton for all backoff strategies.</span>
<span class="hl com"> * &#64;param options Backoff strategy options.</span>
<span class="hl com"> * &#64;param options.randomisationFactor The randomisation factor, must be between</span>
<span class="hl com"> * 0 and 1.</span>
<span class="hl com"> * &#64;param options.initialDelay The backoff initial delay, in milliseconds.</span>
<span class="hl com"> * &#64;param options.maxDelay The backoff maximal delay, in milliseconds.</span>
<span class="hl com"> * &#64;constructor</span>
<span class="hl com"> */</span>
<span class="hl kwa">function</span> <span class="hl kwd">BackoffStrategy</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
    options <span class="hl opt">=</span> options <span class="hl opt">|| {};</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isDef</span><span class="hl opt">(</span>options<span class="hl opt">.</span>initialDelay<span class="hl opt">) &amp;&amp;</span> options<span class="hl opt">.</span>initialDelay <span class="hl opt">&lt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'The initial timeout must be greater than 0.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwd">isDef</span><span class="hl opt">(</span>options<span class="hl opt">.</span>maxDelay<span class="hl opt">) &amp;&amp;</span> options<span class="hl opt">.</span>maxDelay <span class="hl opt">&lt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'The maximal timeout must be greater than 0.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>initialDelay_ <span class="hl opt">=</span> options<span class="hl opt">.</span>initialDelay <span class="hl opt">||</span> <span class="hl num">100</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>maxDelay_ <span class="hl opt">=</span> options<span class="hl opt">.</span>maxDelay <span class="hl opt">||</span> <span class="hl num">10000</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>maxDelay_ <span class="hl opt">&lt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>initialDelay_<span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'The maximal backoff delay must be '</span> <span class="hl opt">+</span>
                        <span class="hl str">'greater than the initial backoff delay.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isDef</span><span class="hl opt">(</span>options<span class="hl opt">.</span>randomisationFactor<span class="hl opt">) &amp;&amp;</span>
        <span class="hl opt">(</span>options<span class="hl opt">.</span>randomisationFactor <span class="hl opt">&lt;</span> <span class="hl num">0</span> <span class="hl opt">||</span> options<span class="hl opt">.</span>randomisationFactor <span class="hl opt">&gt;</span> <span class="hl num">1</span><span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'The randomisation factor must be between 0 and 1.'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>randomisationFactor_ <span class="hl opt">=</span> options<span class="hl opt">.</span>randomisationFactor <span class="hl opt">||</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl com">/**</span>
<span class="hl com"> * Retrieves the maximal backoff delay.</span>
<span class="hl com"> * &#64;return The maximal backoff delay, in milliseconds.</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">getMaxDelay</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>maxDelay_<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Retrieves the initial backoff delay.</span>
<span class="hl com"> * &#64;return The initial backoff delay, in milliseconds.</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">getInitialDelay</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>initialDelay_<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Template method that computes the next backoff delay.</span>
<span class="hl com"> * &#64;return The backoff delay, in milliseconds.</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">next</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> backoffDelay <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">next_</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> randomisationMultiple <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">() *</span> <span class="hl kwa">this</span><span class="hl opt">.</span>randomisationFactor_<span class="hl opt">;</span>
    <span class="hl kwa">var</span> randomizedDelay <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">round</span><span class="hl opt">(</span>backoffDelay <span class="hl opt">*</span> randomisationMultiple<span class="hl opt">);</span>
    <span class="hl kwa">return</span> randomizedDelay<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Computes the next backoff delay.</span>
<span class="hl com"> * &#64;return The backoff delay, in milliseconds.</span>
<span class="hl com"> * &#64;protected</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">next_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'BackoffStrategy.next_() unimplemented.'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Template method that resets the backoff delay to its initial value.</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reset</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">reset_</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

<span class="hl com">/**</span>
<span class="hl com"> * Resets the backoff delay to its initial value.</span>
<span class="hl com"> * &#64;protected</span>
<span class="hl com"> */</span>
BackoffStrategy<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reset_</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'BackoffStrategy.reset_() unimplemented.'</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> BackoffStrategy<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;events&quot;</span><span class="hl opt">:</span><span class="hl num">131</span><span class="hl opt">,</span><span class="hl str">&quot;util&quot;</span><span class="hl opt">:</span><span class="hl num">256</span><span class="hl opt">}],</span><span class="hl num">27</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl com">/*!</span>
<span class="hl com">  * Bean - copyright (c) Jacob Thornton 2011-2012</span>
<span class="hl com">  * https://github.com/fat/bean</span>
<span class="hl com">  * MIT license</span>
<span class="hl com">  */</span>
<span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>name<span class="hl opt">,</span> context<span class="hl opt">,</span> definition<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> module <span class="hl opt">!=</span> <span class="hl str">'undefined'</span> <span class="hl opt">&amp;&amp;</span> module<span class="hl opt">.</span>exports<span class="hl opt">)</span> module<span class="hl opt">.</span>exports <span class="hl opt">=</span> <span class="hl kwd">definition</span><span class="hl opt">()</span>
  <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> define <span class="hl opt">==</span> <span class="hl str">'function'</span> <span class="hl opt">&amp;&amp;</span> define<span class="hl opt">.</span>amd<span class="hl opt">)</span> <span class="hl kwd">define</span><span class="hl opt">(</span>definition<span class="hl opt">)</span>
  <span class="hl kwa">else</span> context<span class="hl opt">[</span>name<span class="hl opt">] =</span> <span class="hl kwd">definition</span><span class="hl opt">()</span>
<span class="hl opt">})(</span><span class="hl str">'bean'</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>name<span class="hl opt">,</span> context<span class="hl opt">) {</span>
  name    <span class="hl opt">=</span> name    <span class="hl opt">||</span> <span class="hl str">'bean'</span>
  context <span class="hl opt">=</span> context <span class="hl opt">||</span> <span class="hl kwa">this</span>

  <span class="hl kwa">var</span> win            <span class="hl opt">=</span> window
    <span class="hl opt">,</span> old            <span class="hl opt">=</span> context<span class="hl opt">[</span>name<span class="hl opt">]</span>
    <span class="hl opt">,</span> namespaceRegex <span class="hl opt">=</span> <span class="hl kwc">/[^\.]*(?=\..*)\.|.*/</span>
    <span class="hl opt">,</span> nameRegex      <span class="hl opt">=</span> <span class="hl kwc">/\..*/</span>
    <span class="hl opt">,</span> addEvent       <span class="hl opt">=</span> <span class="hl str">'addEventListener'</span>
    <span class="hl opt">,</span> removeEvent    <span class="hl opt">=</span> <span class="hl str">'removeEventListener'</span>
    <span class="hl opt">,</span> doc            <span class="hl opt">=</span> document <span class="hl opt">|| {}</span>
    <span class="hl opt">,</span> root           <span class="hl opt">=</span> doc<span class="hl opt">.</span>documentElement <span class="hl opt">|| {}</span>
    <span class="hl opt">,</span> W3C_MODEL      <span class="hl opt">=</span> root<span class="hl opt">[</span>addEvent<span class="hl opt">]</span>
    <span class="hl opt">,</span> eventSupport   <span class="hl opt">=</span> W3C_MODEL <span class="hl opt">?</span> addEvent <span class="hl opt">:</span> <span class="hl str">'attachEvent'</span>
    <span class="hl opt">,</span> ONE            <span class="hl opt">= {}</span> <span class="hl slc">// singleton for quick matching making add() do one()</span>

    <span class="hl opt">,</span> slice          <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>slice
    <span class="hl opt">,</span> <span class="hl kwd">str2arr</span>        <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>s<span class="hl opt">,</span> d<span class="hl opt">) {</span> <span class="hl kwa">return</span> s<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span>d <span class="hl opt">||</span> <span class="hl str">' '</span><span class="hl opt">) }</span>
    <span class="hl opt">,</span> <span class="hl kwd">isString</span>       <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>o<span class="hl opt">) {</span> <span class="hl kwa">return typeof</span> o <span class="hl opt">==</span> <span class="hl str">'string'</span> <span class="hl opt">}</span>
    <span class="hl opt">,</span> <span class="hl kwd">isFunction</span>     <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>o<span class="hl opt">) {</span> <span class="hl kwa">return typeof</span> o <span class="hl opt">==</span> <span class="hl str">'function'</span> <span class="hl opt">}</span>

      <span class="hl slc">// events that we consider to be 'native', anything not in this list will</span>
      <span class="hl slc">// be treated as a custom event</span>
    <span class="hl opt">,</span> standardNativeEvents <span class="hl opt">=</span>
        <span class="hl str">'click dblclick mouseup mousedown contextmenu '</span>                  <span class="hl opt">+</span> <span class="hl slc">// mouse buttons</span>
        <span class="hl str">'mousewheel mousemultiwheel DOMMouseScroll '</span>                     <span class="hl opt">+</span> <span class="hl slc">// mouse wheel</span>
        <span class="hl str">'mouseover mouseout mousemove selectstart selectend '</span>            <span class="hl opt">+</span> <span class="hl slc">// mouse movement</span>
        <span class="hl str">'keydown keypress keyup '</span>                                        <span class="hl opt">+</span> <span class="hl slc">// keyboard</span>
        <span class="hl str">'orientationchange '</span>                                             <span class="hl opt">+</span> <span class="hl slc">// mobile</span>
        <span class="hl str">'focus blur change reset select submit '</span>                         <span class="hl opt">+</span> <span class="hl slc">// form elements</span>
        <span class="hl str">'load unload beforeunload resize move DOMContentLoaded '</span>         <span class="hl opt">+</span> <span class="hl slc">// window</span>
        <span class="hl str">'readystatechange message '</span>                                      <span class="hl opt">+</span> <span class="hl slc">// window</span>
        <span class="hl str">'error abort scroll '</span>                                              <span class="hl slc">// misc</span>
      <span class="hl slc">// element.fireEvent('onXYZ'... is not forgiving if we try to fire an event</span>
      <span class="hl slc">// that doesn't actually exist, so make sure we only do these on newer browsers</span>
    <span class="hl opt">,</span> w3cNativeEvents <span class="hl opt">=</span>
        <span class="hl str">'show '</span>                                                          <span class="hl opt">+</span> <span class="hl slc">// mouse buttons</span>
        <span class="hl str">'input invalid '</span>                                                 <span class="hl opt">+</span> <span class="hl slc">// form elements</span>
        <span class="hl str">'touchstart touchmove touchend touchcancel '</span>                     <span class="hl opt">+</span> <span class="hl slc">// touch</span>
        <span class="hl str">'gesturestart gesturechange gestureend '</span>                         <span class="hl opt">+</span> <span class="hl slc">// gesture</span>
        <span class="hl str">'textinput '</span>                                                     <span class="hl opt">+</span> <span class="hl slc">// TextEvent</span>
        <span class="hl str">'readystatechange pageshow pagehide popstate '</span>                   <span class="hl opt">+</span> <span class="hl slc">// window</span>
        <span class="hl str">'hashchange offline online '</span>                                     <span class="hl opt">+</span> <span class="hl slc">// window</span>
        <span class="hl str">'afterprint beforeprint '</span>                                        <span class="hl opt">+</span> <span class="hl slc">// printing</span>
        <span class="hl str">'dragstart dragenter dragover dragleave drag drop dragend '</span>      <span class="hl opt">+</span> <span class="hl slc">// dnd</span>
        <span class="hl str">'loadstart progress suspend emptied stalled loadmetadata '</span>       <span class="hl opt">+</span> <span class="hl slc">// media</span>
        <span class="hl str">'loadeddata canplay canplaythrough playing waiting seeking '</span>     <span class="hl opt">+</span> <span class="hl slc">// media</span>
        <span class="hl str">'seeked ended durationchange timeupdate play pause ratechange '</span>  <span class="hl opt">+</span> <span class="hl slc">// media</span>
        <span class="hl str">'volumechange cuechange '</span>                                        <span class="hl opt">+</span> <span class="hl slc">// media</span>
        <span class="hl str">'checking noupdate downloading cached updateready obsolete '</span>       <span class="hl slc">// appcache</span>

      <span class="hl slc">// convert to a hash for quick lookups</span>
    <span class="hl opt">,</span> nativeEvents <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl opt">(</span>hash<span class="hl opt">,</span> events<span class="hl opt">,</span> i<span class="hl opt">) {</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> events<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++)</span> events<span class="hl opt">[</span>i<span class="hl opt">] &amp;&amp; (</span>hash<span class="hl opt">[</span>events<span class="hl opt">[</span>i<span class="hl opt">]] =</span> <span class="hl num">1</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> hash
      <span class="hl opt">}({},</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>standardNativeEvents <span class="hl opt">+ (</span>W3C_MODEL <span class="hl opt">?</span> w3cNativeEvents <span class="hl opt">:</span> <span class="hl str">''</span><span class="hl opt">))))</span>

      <span class="hl slc">// custom events are events that we *fake*, they are not provided natively but</span>
      <span class="hl slc">// we can use native events to generate them</span>
    <span class="hl opt">,</span> customEvents <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">var</span> isAncestor <span class="hl opt">=</span> <span class="hl str">'compareDocumentPosition'</span> <span class="hl kwa">in</span> root
              <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> container<span class="hl opt">) {</span>
                  <span class="hl kwa">return</span> container<span class="hl opt">.</span>compareDocumentPosition <span class="hl opt">&amp;&amp; (</span>container<span class="hl opt">.</span><span class="hl kwd">compareDocumentPosition</span><span class="hl opt">(</span>element<span class="hl opt">) &amp;</span> <span class="hl num">16</span><span class="hl opt">) ===</span> <span class="hl num">16</span>
                <span class="hl opt">}</span>
              <span class="hl opt">:</span> <span class="hl str">'contains'</span> <span class="hl kwa">in</span> root
                <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> container<span class="hl opt">) {</span>
                    container <span class="hl opt">=</span> container<span class="hl opt">.</span>nodeType <span class="hl opt">===</span> <span class="hl num">9</span> <span class="hl opt">||</span> container <span class="hl opt">===</span> window <span class="hl opt">?</span> root <span class="hl opt">:</span> container
                    <span class="hl kwa">return</span> container <span class="hl opt">!==</span> element <span class="hl opt">&amp;&amp;</span> container<span class="hl opt">.</span><span class="hl kwd">contains</span><span class="hl opt">(</span>element<span class="hl opt">)</span>
                  <span class="hl opt">}</span>
                <span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> container<span class="hl opt">) {</span>
                    <span class="hl kwa">while</span> <span class="hl opt">(</span>element <span class="hl opt">=</span> element<span class="hl opt">.</span>parentNode<span class="hl opt">)</span> <span class="hl kwa">if</span> <span class="hl opt">(</span>element <span class="hl opt">===</span> container<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">1</span>
                    <span class="hl kwa">return</span> <span class="hl num">0</span>
                  <span class="hl opt">}</span>
          <span class="hl opt">,</span> <span class="hl kwd">check</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> related <span class="hl opt">=</span> event<span class="hl opt">.</span>relatedTarget
              <span class="hl kwa">return</span> <span class="hl opt">!</span>related
                <span class="hl opt">?</span> related <span class="hl opt">==</span> <span class="hl kwa">null</span>
                <span class="hl opt">: (</span>related <span class="hl opt">!==</span> <span class="hl kwa">this</span> <span class="hl opt">&amp;&amp;</span> related<span class="hl opt">.</span>prefix <span class="hl opt">!==</span> <span class="hl str">'xul'</span> <span class="hl opt">&amp;&amp; !</span><span class="hl kwc">/document/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">())</span>
                    <span class="hl opt">&amp;&amp; !</span><span class="hl kwd">isAncestor</span><span class="hl opt">(</span>related<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">))</span>
            <span class="hl opt">}</span>

        <span class="hl kwa">return</span> <span class="hl opt">{</span>
            mouseenter<span class="hl opt">: {</span> base<span class="hl opt">:</span> <span class="hl str">'mouseover'</span><span class="hl opt">,</span> condition<span class="hl opt">:</span> check <span class="hl opt">}</span>
          <span class="hl opt">,</span> mouseleave<span class="hl opt">: {</span> base<span class="hl opt">:</span> <span class="hl str">'mouseout'</span><span class="hl opt">,</span> condition<span class="hl opt">:</span> check <span class="hl opt">}</span>
          <span class="hl opt">,</span> mousewheel<span class="hl opt">: {</span> base<span class="hl opt">:</span> <span class="hl kwc">/Firefox/</span><span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>navigator<span class="hl opt">.</span>userAgent<span class="hl opt">) ?</span> <span class="hl str">'DOMMouseScroll'</span> <span class="hl opt">:</span> <span class="hl str">'mousewheel'</span> <span class="hl opt">}</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}())</span>

      <span class="hl slc">// we provide a consistent Event object across browsers by taking the actual DOM</span>
      <span class="hl slc">// event object and generating a new one from its properties.</span>
    <span class="hl opt">,</span> Event <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl opt">() {</span>
            <span class="hl slc">// a whitelist of properties (for different event types) tells us what to check for and copy</span>
        <span class="hl kwa">var</span> commonProps  <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'altKey attrChange attrName bubbles cancelable ctrlKey currentTarget '</span> <span class="hl opt">+</span>
              <span class="hl str">'detail eventPhase getModifierState isTrusted metaKey relatedNode relatedTarget shiftKey '</span>  <span class="hl opt">+</span>
              <span class="hl str">'srcElement target timeStamp type view which propertyName'</span><span class="hl opt">)</span>
          <span class="hl opt">,</span> mouseProps   <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'button buttons clientX clientY dataTransfer '</span>      <span class="hl opt">+</span>
              <span class="hl str">'fromElement offsetX offsetY pageX pageY screenX screenY toElement'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> mouseWheelProps <span class="hl opt">=</span> mouseProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'wheelDelta wheelDeltaX wheelDeltaY wheelDeltaZ '</span> <span class="hl opt">+</span>
              <span class="hl str">'axis'</span><span class="hl opt">))</span> <span class="hl slc">// 'axis' is FF specific</span>
          <span class="hl opt">,</span> keyProps     <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'char charCode key keyCode keyIdentifier '</span>          <span class="hl opt">+</span>
              <span class="hl str">'keyLocation location'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> textProps    <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'data'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> touchProps   <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'touches targetTouches changedTouches scale rotation'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> messageProps <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'data origin source'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> stateProps   <span class="hl opt">=</span> commonProps<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span><span class="hl kwd">str2arr</span><span class="hl opt">(</span><span class="hl str">'state'</span><span class="hl opt">))</span>
          <span class="hl opt">,</span> overOutRegex <span class="hl opt">=</span> <span class="hl kwc">/over|out/</span>
            <span class="hl slc">// some event types need special handling and some need special properties, do that all here</span>
          <span class="hl opt">,</span> typeFixers   <span class="hl opt">= [</span>
                <span class="hl opt">{</span> <span class="hl slc">// key events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/key/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> newEvent<span class="hl opt">) {</span>
                      newEvent<span class="hl opt">.</span>keyCode <span class="hl opt">=</span> event<span class="hl opt">.</span>keyCode <span class="hl opt">||</span> event<span class="hl opt">.</span>which
                      <span class="hl kwa">return</span> keyProps
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// mouse events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/click|mouse(?!(.*wheel|scroll))|menu|drag|drop/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> newEvent<span class="hl opt">,</span> type<span class="hl opt">) {</span>
                      newEvent<span class="hl opt">.</span>rightClick <span class="hl opt">=</span> event<span class="hl opt">.</span>which <span class="hl opt">===</span> <span class="hl num">3</span> <span class="hl opt">||</span> event<span class="hl opt">.</span>button <span class="hl opt">===</span> <span class="hl num">2</span>
                      newEvent<span class="hl opt">.</span>pos <span class="hl opt">= {</span> x<span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> y<span class="hl opt">:</span> <span class="hl num">0</span> <span class="hl opt">}</span>
                      <span class="hl kwa">if</span> <span class="hl opt">(</span>event<span class="hl opt">.</span>pageX <span class="hl opt">||</span> event<span class="hl opt">.</span>pageY<span class="hl opt">) {</span>
                        newEvent<span class="hl opt">.</span>clientX <span class="hl opt">=</span> event<span class="hl opt">.</span>pageX
                        newEvent<span class="hl opt">.</span>clientY <span class="hl opt">=</span> event<span class="hl opt">.</span>pageY
                      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>event<span class="hl opt">.</span>clientX <span class="hl opt">||</span> event<span class="hl opt">.</span>clientY<span class="hl opt">) {</span>
                        newEvent<span class="hl opt">.</span>clientX <span class="hl opt">=</span> event<span class="hl opt">.</span>clientX <span class="hl opt">+</span> doc<span class="hl opt">.</span>body<span class="hl opt">.</span>scrollLeft <span class="hl opt">+</span> root<span class="hl opt">.</span>scrollLeft
                        newEvent<span class="hl opt">.</span>clientY <span class="hl opt">=</span> event<span class="hl opt">.</span>clientY <span class="hl opt">+</span> doc<span class="hl opt">.</span>body<span class="hl opt">.</span>scrollTop <span class="hl opt">+</span> root<span class="hl opt">.</span>scrollTop
                      <span class="hl opt">}</span>
                      <span class="hl kwa">if</span> <span class="hl opt">(</span>overOutRegex<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>type<span class="hl opt">)) {</span>
                        newEvent<span class="hl opt">.</span>relatedTarget <span class="hl opt">=</span> event<span class="hl opt">.</span>relatedTarget
                          <span class="hl opt">||</span> event<span class="hl opt">[(</span>type <span class="hl opt">==</span> <span class="hl str">'mouseover'</span> <span class="hl opt">?</span> <span class="hl str">'from'</span> <span class="hl opt">:</span> <span class="hl str">'to'</span><span class="hl opt">) +</span> <span class="hl str">'Element'</span><span class="hl opt">]</span>
                      <span class="hl opt">}</span>
                      <span class="hl kwa">return</span> mouseProps
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// mouse wheel events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/mouse.*(wheel|scroll)/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> mouseWheelProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// TextEvent</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/^text/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> textProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// touch and gesture events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/^touch|^gesture/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> touchProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// message events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/^message$/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> messageProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// popstate events</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/^popstate$/i</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> stateProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">, {</span> <span class="hl slc">// everything else</span>
                    reg<span class="hl opt">:</span> <span class="hl kwc">/.*/</span>
                  <span class="hl opt">,</span> <span class="hl kwd">fix</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return</span> commonProps <span class="hl opt">}</span>
                <span class="hl opt">}</span>
            <span class="hl opt">]</span>
          <span class="hl opt">,</span> typeFixerMap <span class="hl opt">= {}</span> <span class="hl slc">// used to map event types to fixer functions (above), a basic cache mechanism</span>

          <span class="hl opt">,</span> <span class="hl kwd">Event</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> element<span class="hl opt">,</span> isNative<span class="hl opt">) {</span>
              <span class="hl kwa">if</span> <span class="hl opt">(!</span>arguments<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return</span>
              event <span class="hl opt">=</span> event <span class="hl opt">|| ((</span>element<span class="hl opt">.</span>ownerDocument <span class="hl opt">||</span> element<span class="hl opt">.</span>document <span class="hl opt">||</span> element<span class="hl opt">).</span>parentWindow <span class="hl opt">||</span> win<span class="hl opt">).</span>event
              <span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent <span class="hl opt">=</span> event
              <span class="hl kwa">this</span><span class="hl opt">.</span>isNative       <span class="hl opt">=</span> isNative
              <span class="hl kwa">this</span><span class="hl opt">.</span>isBean         <span class="hl opt">=</span> <span class="hl kwa">true</span>

              <span class="hl kwa">if</span> <span class="hl opt">(!</span>event<span class="hl opt">)</span> <span class="hl kwa">return</span>

              <span class="hl kwa">var</span> type   <span class="hl opt">=</span> event<span class="hl opt">.</span>type
                <span class="hl opt">,</span> target <span class="hl opt">=</span> event<span class="hl opt">.</span>target <span class="hl opt">||</span> event<span class="hl opt">.</span>srcElement
                <span class="hl opt">,</span> i<span class="hl opt">,</span> l<span class="hl opt">,</span> p<span class="hl opt">,</span> props<span class="hl opt">,</span> fixer

              <span class="hl kwa">this</span><span class="hl opt">.</span>target <span class="hl opt">=</span> target <span class="hl opt">&amp;&amp;</span> target<span class="hl opt">.</span>nodeType <span class="hl opt">===</span> <span class="hl num">3</span> <span class="hl opt">?</span> target<span class="hl opt">.</span>parentNode <span class="hl opt">:</span> target

              <span class="hl kwa">if</span> <span class="hl opt">(</span>isNative<span class="hl opt">) {</span> <span class="hl slc">// we only need basic augmentation on custom events, the rest expensive &amp; pointless</span>
                fixer <span class="hl opt">=</span> typeFixerMap<span class="hl opt">[</span>type<span class="hl opt">]</span>
                <span class="hl kwa">if</span> <span class="hl opt">(!</span>fixer<span class="hl opt">) {</span> <span class="hl slc">// haven't encountered this event type before, map a fixer function for it</span>
                  <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> l <span class="hl opt">=</span> typeFixers<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>typeFixers<span class="hl opt">[</span>i<span class="hl opt">].</span>reg<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>type<span class="hl opt">)) {</span> <span class="hl slc">// guaranteed to match at least one, last is .*</span>
                      typeFixerMap<span class="hl opt">[</span>type<span class="hl opt">] =</span> fixer <span class="hl opt">=</span> typeFixers<span class="hl opt">[</span>i<span class="hl opt">].</span>fix
                      <span class="hl kwa">break</span>
                    <span class="hl opt">}</span>
                  <span class="hl opt">}</span>
                <span class="hl opt">}</span>

                props <span class="hl opt">=</span> <span class="hl kwd">fixer</span><span class="hl opt">(</span>event<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> type<span class="hl opt">)</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> props<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
                  <span class="hl kwa">if</span> <span class="hl opt">(!((</span>p <span class="hl opt">=</span> props<span class="hl opt">[</span>i<span class="hl opt">])</span> <span class="hl kwa">in this</span><span class="hl opt">) &amp;&amp;</span> p <span class="hl kwa">in</span> event<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">[</span>p<span class="hl opt">] =</span> event<span class="hl opt">[</span>p<span class="hl opt">]</span>
                <span class="hl opt">}</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>

        <span class="hl slc">// preventDefault() and stopPropagation() are a consistent interface to those functions</span>
        <span class="hl slc">// on the DOM, stop() is an alias for both of them together</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">preventDefault</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>preventDefault<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span><span class="hl kwd">preventDefault</span><span class="hl opt">()</span>
          <span class="hl kwa">else this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>returnValue <span class="hl opt">=</span> <span class="hl kwa">false</span>
        <span class="hl opt">}</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">stopPropagation</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>stopPropagation<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span><span class="hl kwd">stopPropagation</span><span class="hl opt">()</span>
          <span class="hl kwa">else this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>cancelBubble <span class="hl opt">=</span> <span class="hl kwa">true</span>
        <span class="hl opt">}</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">stop</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">preventDefault</span><span class="hl opt">()</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">stopPropagation</span><span class="hl opt">()</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span>stopped <span class="hl opt">=</span> <span class="hl kwa">true</span>
        <span class="hl opt">}</span>
        <span class="hl slc">// stopImmediatePropagation() has to be handled internally because we manage the event list for</span>
        <span class="hl slc">// each element</span>
        <span class="hl slc">// note that originalElement may be a Bean#Event object in some situations</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">stopImmediatePropagation</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>stopImmediatePropagation<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span><span class="hl kwd">stopImmediatePropagation</span><span class="hl opt">()</span>
          <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isImmediatePropagationStopped</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">return true</span> <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isImmediatePropagationStopped</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
          <span class="hl kwa">return this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span>isImmediatePropagationStopped <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>originalEvent<span class="hl opt">.</span><span class="hl kwd">isImmediatePropagationStopped</span><span class="hl opt">()</span>
        <span class="hl opt">}</span>
        Event<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">clone</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>currentTarget<span class="hl opt">) {</span>
          <span class="hl slc">//TODO: this is ripe for optimisation, new events are *expensive*</span>
          <span class="hl slc">// improving this will speed up delegated events</span>
          <span class="hl kwa">var</span> ne <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Event</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>element<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>isNative<span class="hl opt">)</span>
          ne<span class="hl opt">.</span>currentTarget <span class="hl opt">=</span> currentTarget
          <span class="hl kwa">return</span> ne
        <span class="hl opt">}</span>

        <span class="hl kwa">return</span> Event
      <span class="hl opt">}())</span>

      <span class="hl slc">// if we're in old IE we can't do onpropertychange on doc or win so we use doc.documentElement for both</span>
    <span class="hl opt">,</span> <span class="hl kwd">targetElement</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> isNative<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">!</span>W3C_MODEL <span class="hl opt">&amp;&amp; !</span>isNative <span class="hl opt">&amp;&amp; (</span>element <span class="hl opt">===</span> doc <span class="hl opt">||</span> element <span class="hl opt">===</span> win<span class="hl opt">) ?</span> root <span class="hl opt">:</span> element
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * Bean maintains an internal registry for event listeners. We don't touch elements, objects</span>
<span class="hl com">        * or functions to identify them, instead we store everything in the registry.</span>
<span class="hl com">        * Each event listener has a RegEntry object, we have one 'registry' for the whole instance.</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> RegEntry <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl slc">// each handler is wrapped so we can handle delegation and custom events</span>
        <span class="hl kwa">var</span> <span class="hl kwd">wrappedHandler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> fn<span class="hl opt">,</span> condition<span class="hl opt">,</span> args<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> <span class="hl kwd">call</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> eargs<span class="hl opt">) {</span>
                  <span class="hl kwa">return</span> fn<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>element<span class="hl opt">,</span> args <span class="hl opt">?</span> slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>eargs<span class="hl opt">,</span> event <span class="hl opt">?</span> <span class="hl num">0</span> <span class="hl opt">:</span> <span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">concat</span><span class="hl opt">(</span>args<span class="hl opt">) :</span> eargs<span class="hl opt">)</span>
                <span class="hl opt">}</span>
              <span class="hl opt">,</span> <span class="hl kwd">findTarget</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> eventElement<span class="hl opt">) {</span>
                  <span class="hl kwa">return</span> fn<span class="hl opt">.</span>__beanDel <span class="hl opt">?</span> fn<span class="hl opt">.</span>__beanDel<span class="hl opt">.</span><span class="hl kwd">ft</span><span class="hl opt">(</span>event<span class="hl opt">.</span>target<span class="hl opt">,</span> element<span class="hl opt">) :</span> eventElement
                <span class="hl opt">}</span>
              <span class="hl opt">,</span> handler <span class="hl opt">=</span> condition
                  <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">) {</span>
                      <span class="hl kwa">var</span> target <span class="hl opt">=</span> <span class="hl kwd">findTarget</span><span class="hl opt">(</span>event<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">)</span> <span class="hl slc">// deleated event</span>
                      <span class="hl kwa">if</span> <span class="hl opt">(</span>condition<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>target<span class="hl opt">,</span> arguments<span class="hl opt">)) {</span>
                        <span class="hl kwa">if</span> <span class="hl opt">(</span>event<span class="hl opt">)</span> event<span class="hl opt">.</span>currentTarget <span class="hl opt">=</span> target
                        <span class="hl kwa">return</span> <span class="hl kwd">call</span><span class="hl opt">(</span>event<span class="hl opt">,</span> arguments<span class="hl opt">)</span>
                      <span class="hl opt">}</span>
                    <span class="hl opt">}</span>
                  <span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">) {</span>
                      <span class="hl kwa">if</span> <span class="hl opt">(</span>fn<span class="hl opt">.</span>__beanDel<span class="hl opt">)</span> event <span class="hl opt">=</span> event<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">(</span><span class="hl kwd">findTarget</span><span class="hl opt">(</span>event<span class="hl opt">))</span> <span class="hl slc">// delegated event, fix the fix</span>
                      <span class="hl kwa">return</span> <span class="hl kwd">call</span><span class="hl opt">(</span>event<span class="hl opt">,</span> arguments<span class="hl opt">)</span>
                    <span class="hl opt">}</span>
            handler<span class="hl opt">.</span>__beanDel <span class="hl opt">=</span> fn<span class="hl opt">.</span>__beanDel
            <span class="hl kwa">return</span> handler
          <span class="hl opt">}</span>

        <span class="hl opt">,</span> <span class="hl kwd">RegEntry</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> handler<span class="hl opt">,</span> original<span class="hl opt">,</span> namespaces<span class="hl opt">,</span> args<span class="hl opt">,</span> root<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> customType     <span class="hl opt">=</span> customEvents<span class="hl opt">[</span>type<span class="hl opt">]</span>
              <span class="hl opt">,</span> isNative

            <span class="hl kwa">if</span> <span class="hl opt">(</span>type <span class="hl opt">==</span> <span class="hl str">'unload'</span><span class="hl opt">) {</span>
              <span class="hl slc">// self clean-up</span>
              handler <span class="hl opt">=</span> <span class="hl kwd">once</span><span class="hl opt">(</span>removeListener<span class="hl opt">,</span> element<span class="hl opt">,</span> type<span class="hl opt">,</span> handler<span class="hl opt">,</span> original<span class="hl opt">)</span>
            <span class="hl opt">}</span>

            <span class="hl kwa">if</span> <span class="hl opt">(</span>customType<span class="hl opt">) {</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>customType<span class="hl opt">.</span>condition<span class="hl opt">) {</span>
                handler <span class="hl opt">=</span> <span class="hl kwd">wrappedHandler</span><span class="hl opt">(</span>element<span class="hl opt">,</span> handler<span class="hl opt">,</span> customType<span class="hl opt">.</span>condition<span class="hl opt">,</span> args<span class="hl opt">)</span>
              <span class="hl opt">}</span>
              type <span class="hl opt">=</span> customType<span class="hl opt">.</span>base <span class="hl opt">||</span> type
            <span class="hl opt">}</span>

            <span class="hl kwa">this</span><span class="hl opt">.</span>isNative      <span class="hl opt">=</span> isNative <span class="hl opt">=</span> nativeEvents<span class="hl opt">[</span>type<span class="hl opt">] &amp;&amp; !!</span>element<span class="hl opt">[</span>eventSupport<span class="hl opt">]</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>customType    <span class="hl opt">= !</span>W3C_MODEL <span class="hl opt">&amp;&amp; !</span>isNative <span class="hl opt">&amp;&amp;</span> type
            <span class="hl kwa">this</span><span class="hl opt">.</span>element       <span class="hl opt">=</span> element
            <span class="hl kwa">this</span><span class="hl opt">.</span>type          <span class="hl opt">=</span> type
            <span class="hl kwa">this</span><span class="hl opt">.</span>original      <span class="hl opt">=</span> original
            <span class="hl kwa">this</span><span class="hl opt">.</span>namespaces    <span class="hl opt">=</span> namespaces
            <span class="hl kwa">this</span><span class="hl opt">.</span>eventType     <span class="hl opt">=</span> W3C_MODEL <span class="hl opt">||</span> isNative <span class="hl opt">?</span> type <span class="hl opt">:</span> <span class="hl str">'propertychange'</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>target        <span class="hl opt">=</span> <span class="hl kwd">targetElement</span><span class="hl opt">(</span>element<span class="hl opt">,</span> isNative<span class="hl opt">)</span>
            <span class="hl kwa">this</span><span class="hl opt">[</span>eventSupport<span class="hl opt">] = !!</span><span class="hl kwa">this</span><span class="hl opt">.</span>target<span class="hl opt">[</span>eventSupport<span class="hl opt">]</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>root          <span class="hl opt">=</span> root
            <span class="hl kwa">this</span><span class="hl opt">.</span>handler       <span class="hl opt">=</span> <span class="hl kwd">wrappedHandler</span><span class="hl opt">(</span>element<span class="hl opt">,</span> handler<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> args<span class="hl opt">)</span>
          <span class="hl opt">}</span>

        <span class="hl slc">// given a list of namespaces, is our entry in any of them?</span>
        RegEntry<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">inNamespaces</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>checkNamespaces<span class="hl opt">) {</span>
          <span class="hl kwa">var</span> i<span class="hl opt">,</span> j<span class="hl opt">,</span> c <span class="hl opt">=</span> <span class="hl num">0</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span>checkNamespaces<span class="hl opt">)</span> <span class="hl kwa">return true</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>namespaces<span class="hl opt">)</span> <span class="hl kwa">return false</span>
          <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> checkNamespaces<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>j <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>namespaces<span class="hl opt">.</span>length<span class="hl opt">;</span> j<span class="hl opt">--;) {</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>checkNamespaces<span class="hl opt">[</span>i<span class="hl opt">] ==</span> <span class="hl kwa">this</span><span class="hl opt">.</span>namespaces<span class="hl opt">[</span>j<span class="hl opt">])</span> c<span class="hl opt">++</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>
          <span class="hl kwa">return</span> checkNamespaces<span class="hl opt">.</span>length <span class="hl opt">===</span> c
        <span class="hl opt">}</span>

        <span class="hl slc">// match by element, original fn (opt), handler fn (opt)</span>
        RegEntry<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">matches</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>checkElement<span class="hl opt">,</span> checkOriginal<span class="hl opt">,</span> checkHandler<span class="hl opt">) {</span>
          <span class="hl kwa">return this</span><span class="hl opt">.</span>element <span class="hl opt">===</span> checkElement <span class="hl opt">&amp;&amp;</span>
            <span class="hl opt">(!</span>checkOriginal <span class="hl opt">||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>original <span class="hl opt">===</span> checkOriginal<span class="hl opt">) &amp;&amp;</span>
            <span class="hl opt">(!</span>checkHandler <span class="hl opt">||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>handler <span class="hl opt">===</span> checkHandler<span class="hl opt">)</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">return</span> RegEntry
      <span class="hl opt">}())</span>

    <span class="hl opt">,</span> registry <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl slc">// our map stores arrays by event type, just because it's better than storing</span>
        <span class="hl slc">// everything in a single array.</span>
        <span class="hl slc">// uses '$' as a prefix for the keys for safety and 'r' as a special prefix for</span>
        <span class="hl slc">// rootListeners so we can look them up fast</span>
        <span class="hl kwa">var</span> map <span class="hl opt">= {}</span>

          <span class="hl slc">// generic functional search of our registry for matching listeners,</span>
          <span class="hl slc">// `fn` returns false to break out of the loop</span>
          <span class="hl opt">,</span> <span class="hl kwd">forAll</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> original<span class="hl opt">,</span> handler<span class="hl opt">,</span> root<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> pfx <span class="hl opt">=</span> root <span class="hl opt">?</span> <span class="hl str">'r'</span> <span class="hl opt">:</span> <span class="hl str">'$'</span>
              <span class="hl kwa">if</span> <span class="hl opt">(!</span>type <span class="hl opt">||</span> type <span class="hl opt">==</span> <span class="hl str">'*'</span><span class="hl opt">) {</span>
                <span class="hl slc">// search the whole registry</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> t <span class="hl kwa">in</span> map<span class="hl opt">) {</span>
                  <span class="hl kwa">if</span> <span class="hl opt">(</span>t<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) ==</span> pfx<span class="hl opt">) {</span>
                    <span class="hl kwd">forAll</span><span class="hl opt">(</span>element<span class="hl opt">,</span> t<span class="hl opt">.</span><span class="hl kwd">substr</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">),</span> original<span class="hl opt">,</span> handler<span class="hl opt">,</span> root<span class="hl opt">,</span> fn<span class="hl opt">)</span>
                  <span class="hl opt">}</span>
                <span class="hl opt">}</span>
              <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> l<span class="hl opt">,</span> list <span class="hl opt">=</span> map<span class="hl opt">[</span>pfx <span class="hl opt">+</span> type<span class="hl opt">],</span> all <span class="hl opt">=</span> element <span class="hl opt">==</span> <span class="hl str">'*'</span>
                <span class="hl kwa">if</span> <span class="hl opt">(!</span>list<span class="hl opt">)</span> <span class="hl kwa">return</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span>l <span class="hl opt">=</span> list<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
                  <span class="hl kwa">if</span> <span class="hl opt">((</span>all <span class="hl opt">||</span> list<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">matches</span><span class="hl opt">(</span>element<span class="hl opt">,</span> original<span class="hl opt">,</span> handler<span class="hl opt">)) &amp;&amp; !</span><span class="hl kwd">fn</span><span class="hl opt">(</span>list<span class="hl opt">[</span>i<span class="hl opt">],</span> list<span class="hl opt">,</span> i<span class="hl opt">,</span> type<span class="hl opt">))</span> <span class="hl kwa">return</span>
                <span class="hl opt">}</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>

          <span class="hl opt">,</span> <span class="hl kwd">has</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> original<span class="hl opt">,</span> root<span class="hl opt">) {</span>
              <span class="hl slc">// we're not using forAll here simply because it's a bit slower and this</span>
              <span class="hl slc">// needs to be fast</span>
              <span class="hl kwa">var</span> i<span class="hl opt">,</span> list <span class="hl opt">=</span> map<span class="hl opt">[(</span>root <span class="hl opt">?</span> <span class="hl str">'r'</span> <span class="hl opt">:</span> <span class="hl str">'$'</span><span class="hl opt">) +</span> type<span class="hl opt">]</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>list<span class="hl opt">) {</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> list<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
                  <span class="hl kwa">if</span> <span class="hl opt">(!</span>list<span class="hl opt">[</span>i<span class="hl opt">].</span>root <span class="hl opt">&amp;&amp;</span> list<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">matches</span><span class="hl opt">(</span>element<span class="hl opt">,</span> original<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">))</span> <span class="hl kwa">return true</span>
                <span class="hl opt">}</span>
              <span class="hl opt">}</span>
              <span class="hl kwa">return false</span>
            <span class="hl opt">}</span>

          <span class="hl opt">,</span> <span class="hl kwa">get</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> original<span class="hl opt">,</span> root<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> entries <span class="hl opt">= []</span>
              <span class="hl kwd">forAll</span><span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> original<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> root<span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>entry<span class="hl opt">) {</span>
                <span class="hl kwa">return</span> entries<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>entry<span class="hl opt">)</span>
              <span class="hl opt">})</span>
              <span class="hl kwa">return</span> entries
            <span class="hl opt">}</span>

          <span class="hl opt">,</span> <span class="hl kwd">put</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>entry<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> has <span class="hl opt">= !</span>entry<span class="hl opt">.</span>root <span class="hl opt">&amp;&amp; !</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">has</span><span class="hl opt">(</span>entry<span class="hl opt">.</span>element<span class="hl opt">,</span> entry<span class="hl opt">.</span>type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
                <span class="hl opt">,</span> key <span class="hl opt">= (</span>entry<span class="hl opt">.</span>root <span class="hl opt">?</span> <span class="hl str">'r'</span> <span class="hl opt">:</span> <span class="hl str">'$'</span><span class="hl opt">) +</span> entry<span class="hl opt">.</span>type
              <span class="hl opt">;(</span>map<span class="hl opt">[</span>key<span class="hl opt">] || (</span>map<span class="hl opt">[</span>key<span class="hl opt">] = [])).</span><span class="hl kwd">push</span><span class="hl opt">(</span>entry<span class="hl opt">)</span>
              <span class="hl kwa">return</span> has
            <span class="hl opt">}</span>

          <span class="hl opt">,</span> <span class="hl kwd">del</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>entry<span class="hl opt">) {</span>
              <span class="hl kwd">forAll</span><span class="hl opt">(</span>entry<span class="hl opt">.</span>element<span class="hl opt">,</span> entry<span class="hl opt">.</span>type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> entry<span class="hl opt">.</span>handler<span class="hl opt">,</span> entry<span class="hl opt">.</span>root<span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>entry<span class="hl opt">,</span> list<span class="hl opt">,</span> i<span class="hl opt">) {</span>
                list<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>i<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">)</span>
                entry<span class="hl opt">.</span>removed <span class="hl opt">=</span> <span class="hl kwa">true</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>list<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">delete</span> map<span class="hl opt">[(</span>entry<span class="hl opt">.</span>root <span class="hl opt">?</span> <span class="hl str">'r'</span> <span class="hl opt">:</span> <span class="hl str">'$'</span><span class="hl opt">) +</span> entry<span class="hl opt">.</span>type<span class="hl opt">]</span>
                <span class="hl kwa">return false</span>
              <span class="hl opt">})</span>
            <span class="hl opt">}</span>

            <span class="hl slc">// dump all entries, used for onunload</span>
          <span class="hl opt">,</span> <span class="hl kwd">entries</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
              <span class="hl kwa">var</span> t<span class="hl opt">,</span> entries <span class="hl opt">= []</span>
              <span class="hl kwa">for</span> <span class="hl opt">(</span>t <span class="hl kwa">in</span> map<span class="hl opt">) {</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>t<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) ==</span> <span class="hl str">'$'</span><span class="hl opt">)</span> entries <span class="hl opt">=</span> entries<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span>map<span class="hl opt">[</span>t<span class="hl opt">])</span>
              <span class="hl opt">}</span>
              <span class="hl kwa">return</span> entries
            <span class="hl opt">}</span>

        <span class="hl kwa">return</span> <span class="hl opt">{</span> has<span class="hl opt">:</span> has<span class="hl opt">,</span> <span class="hl kwa">get</span><span class="hl opt">:</span> <span class="hl kwa">get</span><span class="hl opt">,</span> put<span class="hl opt">:</span> put<span class="hl opt">,</span> del<span class="hl opt">:</span> del<span class="hl opt">,</span> entries<span class="hl opt">:</span> entries <span class="hl opt">}</span>
      <span class="hl opt">}())</span>

      <span class="hl slc">// we need a selector engine for delegated events, use querySelectorAll if it exists</span>
      <span class="hl slc">// but for older browsers we need Qwery, Sizzle or similar</span>
    <span class="hl opt">,</span> selectorEngine
    <span class="hl opt">,</span> <span class="hl kwd">setSelectorEngine</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>arguments<span class="hl opt">.</span>length<span class="hl opt">) {</span>
          selectorEngine <span class="hl opt">=</span> doc<span class="hl opt">.</span>querySelectorAll
            <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>s<span class="hl opt">,</span> r<span class="hl opt">) {</span>
                <span class="hl kwa">return</span> r<span class="hl opt">.</span><span class="hl kwd">querySelectorAll</span><span class="hl opt">(</span>s<span class="hl opt">)</span>
              <span class="hl opt">}</span>
            <span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
                <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">'Bean: No selector engine installed'</span><span class="hl opt">)</span> <span class="hl slc">// eeek</span>
              <span class="hl opt">}</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          selectorEngine <span class="hl opt">=</span> e
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl slc">// we attach this listener to each DOM event that we need to listen to, only once</span>
      <span class="hl slc">// per event type per DOM element</span>
    <span class="hl opt">,</span> <span class="hl kwd">rootListener</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">,</span> type<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>W3C_MODEL <span class="hl opt">&amp;&amp;</span> type <span class="hl opt">&amp;&amp;</span> event <span class="hl opt">&amp;&amp;</span> event<span class="hl opt">.</span>propertyName <span class="hl opt">!=</span> <span class="hl str">'_on'</span> <span class="hl opt">+</span> type<span class="hl opt">)</span> <span class="hl kwa">return</span>

        <span class="hl kwa">var</span> listeners <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwa">get</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> type <span class="hl opt">||</span> event<span class="hl opt">.</span>type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
          <span class="hl opt">,</span> l <span class="hl opt">=</span> listeners<span class="hl opt">.</span>length
          <span class="hl opt">,</span> i <span class="hl opt">=</span> <span class="hl num">0</span>

        event <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Event</span><span class="hl opt">(</span>event<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">)</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>type<span class="hl opt">)</span> event<span class="hl opt">.</span>type <span class="hl opt">=</span> type

        <span class="hl slc">// iterate through all handlers registered for this type, calling them unless they have</span>
        <span class="hl slc">// been removed by a previous handler or stopImmediatePropagation() has been called</span>
        <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> l <span class="hl opt">&amp;&amp; !</span>event<span class="hl opt">.</span><span class="hl kwd">isImmediatePropagationStopped</span><span class="hl opt">();</span> i<span class="hl opt">++) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span>listeners<span class="hl opt">[</span>i<span class="hl opt">].</span>removed<span class="hl opt">)</span> listeners<span class="hl opt">[</span>i<span class="hl opt">].</span>handler<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> event<span class="hl opt">)</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl slc">// add and remove listeners to DOM elements</span>
    <span class="hl opt">,</span> listener <span class="hl opt">=</span> W3C_MODEL
        <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> add<span class="hl opt">) {</span>
            <span class="hl slc">// new browsers</span>
            element<span class="hl opt">[</span>add <span class="hl opt">?</span> addEvent <span class="hl opt">:</span> removeEvent<span class="hl opt">](</span>type<span class="hl opt">,</span> rootListener<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
          <span class="hl opt">}</span>
        <span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> add<span class="hl opt">,</span> custom<span class="hl opt">) {</span>
            <span class="hl slc">// IE8 and below, use attachEvent/detachEvent and we have to piggy-back propertychange events</span>
            <span class="hl slc">// to simulate event bubbling etc.</span>
            <span class="hl kwa">var</span> entry
            <span class="hl kwa">if</span> <span class="hl opt">(</span>add<span class="hl opt">) {</span>
              registry<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>entry <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">RegEntry</span><span class="hl opt">(</span>
                  element
                <span class="hl opt">,</span> custom <span class="hl opt">||</span> type
                <span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>event<span class="hl opt">) {</span> <span class="hl slc">// handler</span>
                    rootListener<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>element<span class="hl opt">,</span> event<span class="hl opt">,</span> custom<span class="hl opt">)</span>
                  <span class="hl opt">}</span>
                <span class="hl opt">,</span> rootListener
                <span class="hl opt">,</span> <span class="hl kwa">null</span>
                <span class="hl opt">,</span> <span class="hl kwa">null</span>
                <span class="hl opt">,</span> <span class="hl kwa">true</span> <span class="hl slc">// is root</span>
              <span class="hl opt">))</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>custom <span class="hl opt">&amp;&amp;</span> element<span class="hl opt">[</span><span class="hl str">'_on'</span> <span class="hl opt">+</span> custom<span class="hl opt">] ==</span> <span class="hl kwa">null</span><span class="hl opt">)</span> element<span class="hl opt">[</span><span class="hl str">'_on'</span> <span class="hl opt">+</span> custom<span class="hl opt">] =</span> <span class="hl num">0</span>
              entry<span class="hl opt">.</span>target<span class="hl opt">.</span><span class="hl kwd">attachEvent</span><span class="hl opt">(</span><span class="hl str">'on'</span> <span class="hl opt">+</span> entry<span class="hl opt">.</span>eventType<span class="hl opt">,</span> entry<span class="hl opt">.</span>handler<span class="hl opt">)</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
              entry <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwa">get</span><span class="hl opt">(</span>element<span class="hl opt">,</span> custom <span class="hl opt">||</span> type<span class="hl opt">,</span> rootListener<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">)[</span><span class="hl num">0</span><span class="hl opt">]</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>entry<span class="hl opt">) {</span>
                entry<span class="hl opt">.</span>target<span class="hl opt">.</span><span class="hl kwd">detachEvent</span><span class="hl opt">(</span><span class="hl str">'on'</span> <span class="hl opt">+</span> entry<span class="hl opt">.</span>eventType<span class="hl opt">,</span> entry<span class="hl opt">.</span>handler<span class="hl opt">)</span>
                registry<span class="hl opt">.</span><span class="hl kwd">del</span><span class="hl opt">(</span>entry<span class="hl opt">)</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>

    <span class="hl opt">,</span> <span class="hl kwd">once</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>rm<span class="hl opt">,</span> element<span class="hl opt">,</span> type<span class="hl opt">,</span> fn<span class="hl opt">,</span> originalFn<span class="hl opt">) {</span>
        <span class="hl slc">// wrap the handler in a handler that does a remove as well</span>
        <span class="hl kwa">return function</span> <span class="hl opt">() {</span>
          fn<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">)</span>
          <span class="hl kwd">rm</span><span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> originalFn<span class="hl opt">)</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

    <span class="hl opt">,</span> <span class="hl kwd">removeListener</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> orgType<span class="hl opt">,</span> handler<span class="hl opt">,</span> namespaces<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> type     <span class="hl opt">=</span> orgType <span class="hl opt">&amp;&amp;</span> orgType<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span>nameRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">)</span>
          <span class="hl opt">,</span> handlers <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwa">get</span><span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
          <span class="hl opt">,</span> removed  <span class="hl opt">= {}</span>
          <span class="hl opt">,</span> i<span class="hl opt">,</span> l

        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> l <span class="hl opt">=</span> handlers<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">((!</span>handler <span class="hl opt">||</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>original <span class="hl opt">===</span> handler<span class="hl opt">) &amp;&amp;</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">inNamespaces</span><span class="hl opt">(</span>namespaces<span class="hl opt">)) {</span>
            <span class="hl slc">// TODO: this is problematic, we have a registry.get() and registry.del() that</span>
            <span class="hl slc">// both do registry searches so we waste cycles doing this. Needs to be rolled into</span>
            <span class="hl slc">// a single registry.forAll(fn) that removes while finding, but the catch is that</span>
            <span class="hl slc">// we'll be splicing the arrays that we're iterating over. Needs extra tests to</span>
            <span class="hl slc">// make sure we don't screw it up. &#64;rvagg</span>
            registry<span class="hl opt">.</span><span class="hl kwd">del</span><span class="hl opt">(</span>handlers<span class="hl opt">[</span>i<span class="hl opt">])</span>
            <span class="hl kwa">if</span> <span class="hl opt">(!</span>removed<span class="hl opt">[</span>handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>eventType<span class="hl opt">] &amp;&amp;</span> handlers<span class="hl opt">[</span>i<span class="hl opt">][</span>eventSupport<span class="hl opt">])</span>
              removed<span class="hl opt">[</span>handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>eventType<span class="hl opt">] = {</span> t<span class="hl opt">:</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>eventType<span class="hl opt">,</span> c<span class="hl opt">:</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>type <span class="hl opt">}</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl slc">// check each type/element for removed listeners and remove the rootListener where it's no longer needed</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl kwa">in</span> removed<span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span>registry<span class="hl opt">.</span><span class="hl kwd">has</span><span class="hl opt">(</span>element<span class="hl opt">,</span> removed<span class="hl opt">[</span>i<span class="hl opt">].</span>t<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)) {</span>
            <span class="hl slc">// last listener of this type, remove the rootListener</span>
            <span class="hl kwd">listener</span><span class="hl opt">(</span>element<span class="hl opt">,</span> removed<span class="hl opt">[</span>i<span class="hl opt">].</span>t<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> removed<span class="hl opt">[</span>i<span class="hl opt">].</span>c<span class="hl opt">)</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl slc">// set up a delegate helper using the given selector, wrap the handler function</span>
    <span class="hl opt">,</span> <span class="hl kwd">delegate</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>selector<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
        <span class="hl slc">//TODO: findTarget (therefore $) is called twice, once for match and once for</span>
        <span class="hl slc">// setting e.currentTarget, fix this so it's only needed once</span>
        <span class="hl kwa">var</span> <span class="hl kwd">findTarget</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>target<span class="hl opt">,</span> root<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> i<span class="hl opt">,</span> array <span class="hl opt">=</span> <span class="hl kwd">isString</span><span class="hl opt">(</span>selector<span class="hl opt">) ?</span> <span class="hl kwd">selectorEngine</span><span class="hl opt">(</span>selector<span class="hl opt">,</span> root<span class="hl opt">) :</span> selector
              <span class="hl kwa">for</span> <span class="hl opt">(;</span> target <span class="hl opt">&amp;&amp;</span> target <span class="hl opt">!==</span> root<span class="hl opt">;</span> target <span class="hl opt">=</span> target<span class="hl opt">.</span>parentNode<span class="hl opt">) {</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> array<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
                  <span class="hl kwa">if</span> <span class="hl opt">(</span>array<span class="hl opt">[</span>i<span class="hl opt">] ===</span> target<span class="hl opt">)</span> <span class="hl kwa">return</span> target
                <span class="hl opt">}</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>
          <span class="hl opt">,</span> <span class="hl kwd">handler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
              <span class="hl kwa">var</span> match <span class="hl opt">=</span> <span class="hl kwd">findTarget</span><span class="hl opt">(</span>e<span class="hl opt">.</span>target<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">)</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>match<span class="hl opt">)</span> fn<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>match<span class="hl opt">,</span> arguments<span class="hl opt">)</span>
            <span class="hl opt">}</span>

        <span class="hl slc">// __beanDel isn't pleasant but it's a private function, not exposed outside of Bean</span>
        handler<span class="hl opt">.</span>__beanDel <span class="hl opt">= {</span>
            ft       <span class="hl opt">:</span> findTarget <span class="hl slc">// attach it here for customEvents to use too</span>
          <span class="hl opt">,</span> selector <span class="hl opt">:</span> selector
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> handler
      <span class="hl opt">}</span>

    <span class="hl opt">,</span> fireListener <span class="hl opt">=</span> W3C_MODEL <span class="hl opt">?</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>isNative<span class="hl opt">,</span> type<span class="hl opt">,</span> element<span class="hl opt">) {</span>
        <span class="hl slc">// modern browsers, do a proper dispatchEvent()</span>
        <span class="hl kwa">var</span> evt <span class="hl opt">=</span> doc<span class="hl opt">.</span><span class="hl kwd">createEvent</span><span class="hl opt">(</span>isNative <span class="hl opt">?</span> <span class="hl str">'HTMLEvents'</span> <span class="hl opt">:</span> <span class="hl str">'UIEvents'</span><span class="hl opt">)</span>
        evt<span class="hl opt">[</span>isNative <span class="hl opt">?</span> <span class="hl str">'initEvent'</span> <span class="hl opt">:</span> <span class="hl str">'initUIEvent'</span><span class="hl opt">](</span>type<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> win<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">)</span>
        element<span class="hl opt">.</span><span class="hl kwd">dispatchEvent</span><span class="hl opt">(</span>evt<span class="hl opt">)</span>
      <span class="hl opt">} :</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>isNative<span class="hl opt">,</span> type<span class="hl opt">,</span> element<span class="hl opt">) {</span>
        <span class="hl slc">// old browser use onpropertychange, just increment a custom property to trigger the event</span>
        element <span class="hl opt">=</span> <span class="hl kwd">targetElement</span><span class="hl opt">(</span>element<span class="hl opt">,</span> isNative<span class="hl opt">)</span>
        isNative <span class="hl opt">?</span> element<span class="hl opt">.</span><span class="hl kwd">fireEvent</span><span class="hl opt">(</span><span class="hl str">'on'</span> <span class="hl opt">+</span> type<span class="hl opt">,</span> doc<span class="hl opt">.</span><span class="hl kwd">createEventObject</span><span class="hl opt">()) :</span> element<span class="hl opt">[</span><span class="hl str">'_on'</span> <span class="hl opt">+</span> type<span class="hl opt">]++</span>
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * Public API: off(), on(), add(), (remove()), one(), fire(), clone()</span>
<span class="hl com">        */</span>

      <span class="hl com">/**</span>
<span class="hl com">        * off(element[, eventType(s)[, handler ]])</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">off</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> typeSpec<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> isTypeStr <span class="hl opt">=</span> <span class="hl kwd">isString</span><span class="hl opt">(</span>typeSpec<span class="hl opt">)</span>
          <span class="hl opt">,</span> k<span class="hl opt">,</span> type<span class="hl opt">,</span> namespaces<span class="hl opt">,</span> i

        <span class="hl kwa">if</span> <span class="hl opt">(</span>isTypeStr <span class="hl opt">&amp;&amp;</span> typeSpec<span class="hl opt">.</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span><span class="hl str">' '</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl slc">// off(el, 't1 t2 t3', fn) or off(el, 't1 t2 t3')</span>
          typeSpec <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>typeSpec<span class="hl opt">)</span>
          <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> typeSpec<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;)</span>
            <span class="hl kwd">off</span><span class="hl opt">(</span>element<span class="hl opt">,</span> typeSpec<span class="hl opt">[</span>i<span class="hl opt">],</span> fn<span class="hl opt">)</span>
          <span class="hl kwa">return</span> element
        <span class="hl opt">}</span>

        type <span class="hl opt">=</span> isTypeStr <span class="hl opt">&amp;&amp;</span> typeSpec<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span>nameRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">)</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>type <span class="hl opt">&amp;&amp;</span> customEvents<span class="hl opt">[</span>type<span class="hl opt">])</span> type <span class="hl opt">=</span> customEvents<span class="hl opt">[</span>type<span class="hl opt">].</span>base

        <span class="hl kwa">if</span> <span class="hl opt">(!</span>typeSpec <span class="hl opt">||</span> isTypeStr<span class="hl opt">) {</span>
          <span class="hl slc">// off(el) or off(el, t1.ns) or off(el, .ns) or off(el, .ns1.ns2.ns3)</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>namespaces <span class="hl opt">=</span> isTypeStr <span class="hl opt">&amp;&amp;</span> typeSpec<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span>namespaceRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">))</span> namespaces <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>namespaces<span class="hl opt">,</span> <span class="hl str">'.'</span><span class="hl opt">)</span>
          <span class="hl kwd">removeListener</span><span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> fn<span class="hl opt">,</span> namespaces<span class="hl opt">)</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwd">isFunction</span><span class="hl opt">(</span>typeSpec<span class="hl opt">)) {</span>
          <span class="hl slc">// off(el, fn)</span>
          <span class="hl kwd">removeListener</span><span class="hl opt">(</span>element<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> typeSpec<span class="hl opt">)</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          <span class="hl slc">// off(el, { t1: fn1, t2, fn2 })</span>
          <span class="hl kwa">for</span> <span class="hl opt">(</span>k <span class="hl kwa">in</span> typeSpec<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>typeSpec<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>k<span class="hl opt">))</span> <span class="hl kwd">off</span><span class="hl opt">(</span>element<span class="hl opt">,</span> k<span class="hl opt">,</span> typeSpec<span class="hl opt">[</span>k<span class="hl opt">])</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">return</span> element
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * on(element, eventType(s)[, selector], handler[, args ])</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">on</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>element<span class="hl opt">,</span> events<span class="hl opt">,</span> selector<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> originalFn<span class="hl opt">,</span> type<span class="hl opt">,</span> types<span class="hl opt">,</span> i<span class="hl opt">,</span> args<span class="hl opt">,</span> entry<span class="hl opt">,</span> first

        <span class="hl slc">//TODO: the undefined check means you can't pass an 'args' argument, fix this perhaps?</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>selector <span class="hl opt">===</span> undefined <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> events <span class="hl opt">==</span> <span class="hl str">'object'</span><span class="hl opt">) {</span>
          <span class="hl slc">//TODO: this can't handle delegated events</span>
          <span class="hl kwa">for</span> <span class="hl opt">(</span>type <span class="hl kwa">in</span> events<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>events<span class="hl opt">.</span><span class="hl kwd">hasOwnProperty</span><span class="hl opt">(</span>type<span class="hl opt">)) {</span>
              on<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> element<span class="hl opt">,</span> type<span class="hl opt">,</span> events<span class="hl opt">[</span>type<span class="hl opt">])</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>
          <span class="hl kwa">return</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isFunction</span><span class="hl opt">(</span>selector<span class="hl opt">)) {</span>
          <span class="hl slc">// delegated event</span>
          originalFn <span class="hl opt">=</span> fn
          args       <span class="hl opt">=</span> slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">)</span>
          fn         <span class="hl opt">=</span> <span class="hl kwd">delegate</span><span class="hl opt">(</span>selector<span class="hl opt">,</span> originalFn<span class="hl opt">,</span> selectorEngine<span class="hl opt">)</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          args       <span class="hl opt">=</span> slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">)</span>
          fn         <span class="hl opt">=</span> originalFn <span class="hl opt">=</span> selector
        <span class="hl opt">}</span>

        types <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>events<span class="hl opt">)</span>

        <span class="hl slc">// special case for one(), wrap in a self-removing handler</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span> <span class="hl opt">===</span> ONE<span class="hl opt">) {</span>
          fn <span class="hl opt">=</span> <span class="hl kwd">once</span><span class="hl opt">(</span>off<span class="hl opt">,</span> element<span class="hl opt">,</span> events<span class="hl opt">,</span> fn<span class="hl opt">,</span> originalFn<span class="hl opt">)</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> types<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
          <span class="hl slc">// add new handler to the registry and check if it's the first for this element/type</span>
          first <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span>entry <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">RegEntry</span><span class="hl opt">(</span>
              element
            <span class="hl opt">,</span> types<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">replace</span><span class="hl opt">(</span>nameRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">)</span> <span class="hl slc">// event type</span>
            <span class="hl opt">,</span> fn
            <span class="hl opt">,</span> originalFn
            <span class="hl opt">,</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>types<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">replace</span><span class="hl opt">(</span>namespaceRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">),</span> <span class="hl str">'.'</span><span class="hl opt">)</span> <span class="hl slc">// namespaces</span>
            <span class="hl opt">,</span> args
            <span class="hl opt">,</span> <span class="hl kwa">false</span> <span class="hl slc">// not root</span>
          <span class="hl opt">))</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>entry<span class="hl opt">[</span>eventSupport<span class="hl opt">] &amp;&amp;</span> first<span class="hl opt">) {</span>
            <span class="hl slc">// first event of this type on this element, add root listener</span>
            <span class="hl kwd">listener</span><span class="hl opt">(</span>element<span class="hl opt">,</span> entry<span class="hl opt">.</span>eventType<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> entry<span class="hl opt">.</span>customType<span class="hl opt">)</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">return</span> element
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * add(element[, selector], eventType(s), handler[, args ])</span>
<span class="hl com">        *</span>
<span class="hl com">        * Deprecated: kept (for now) for backward-compatibility</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">add</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> events<span class="hl opt">,</span> fn<span class="hl opt">,</span> delfn<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> on<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>
            <span class="hl kwa">null</span>
          <span class="hl opt">, !</span><span class="hl kwd">isString</span><span class="hl opt">(</span>fn<span class="hl opt">)</span>
              <span class="hl opt">?</span> slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">)</span>
              <span class="hl opt">: [</span> element<span class="hl opt">,</span> fn<span class="hl opt">,</span> events<span class="hl opt">,</span> delfn <span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>arguments<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">3</span> <span class="hl opt">?</span> slice<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>arguments<span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">) : [])</span>
        <span class="hl opt">)</span>
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * one(element, eventType(s)[, selector], handler[, args ])</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">one</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">return</span> on<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>ONE<span class="hl opt">,</span> arguments<span class="hl opt">)</span>
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * fire(element, eventType(s)[, args ])</span>
<span class="hl com">        *</span>
<span class="hl com">        * The optional 'args' argument must be an array, if no 'args' argument is provided</span>
<span class="hl com">        * then we can use the browser's DOM event system, otherwise we trigger handlers manually</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">fire</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> args<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> types <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>type<span class="hl opt">)</span>
          <span class="hl opt">,</span> i<span class="hl opt">,</span> j<span class="hl opt">,</span> l<span class="hl opt">,</span> names<span class="hl opt">,</span> handlers

        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> types<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">--;) {</span>
          type <span class="hl opt">=</span> types<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">replace</span><span class="hl opt">(</span>nameRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">)</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>names <span class="hl opt">=</span> types<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">replace</span><span class="hl opt">(</span>namespaceRegex<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">))</span> names <span class="hl opt">=</span> <span class="hl kwd">str2arr</span><span class="hl opt">(</span>names<span class="hl opt">,</span> <span class="hl str">'.'</span><span class="hl opt">)</span>
          <span class="hl kwa">if</span> <span class="hl opt">(!</span>names <span class="hl opt">&amp;&amp; !</span>args <span class="hl opt">&amp;&amp;</span> element<span class="hl opt">[</span>eventSupport<span class="hl opt">]) {</span>
            <span class="hl kwd">fireListener</span><span class="hl opt">(</span>nativeEvents<span class="hl opt">[</span>type<span class="hl opt">],</span> type<span class="hl opt">,</span> element<span class="hl opt">)</span>
          <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl slc">// non-native event, either because of a namespace, arguments or a non DOM element</span>
            <span class="hl slc">// iterate over all listeners and manually 'fire'</span>
            handlers <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwa">get</span><span class="hl opt">(</span>element<span class="hl opt">,</span> type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
            args <span class="hl opt">= [</span><span class="hl kwa">false</span><span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>args<span class="hl opt">)</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> l <span class="hl opt">=</span> handlers<span class="hl opt">.</span>length<span class="hl opt">;</span> j <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> j<span class="hl opt">++) {</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>handlers<span class="hl opt">[</span>j<span class="hl opt">].</span><span class="hl kwd">inNamespaces</span><span class="hl opt">(</span>names<span class="hl opt">)) {</span>
                handlers<span class="hl opt">[</span>j<span class="hl opt">].</span>handler<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>element<span class="hl opt">,</span> args<span class="hl opt">)</span>
              <span class="hl opt">}</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> element
      <span class="hl opt">}</span>

      <span class="hl com">/**</span>
<span class="hl com">        * clone(dstElement, srcElement[, eventType ])</span>
<span class="hl com">        *</span>
<span class="hl com">        * TODO: perhaps for consistency we should allow the same flexibility in type specifiers?</span>
<span class="hl com">        */</span>
    <span class="hl opt">,</span> <span class="hl kwd">clone</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>element<span class="hl opt">,</span> from<span class="hl opt">,</span> type<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> handlers <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwa">get</span><span class="hl opt">(</span>from<span class="hl opt">,</span> type<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
          <span class="hl opt">,</span> l <span class="hl opt">=</span> handlers<span class="hl opt">.</span>length
          <span class="hl opt">,</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
          <span class="hl opt">,</span> args<span class="hl opt">,</span> beanDel

        <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>original<span class="hl opt">) {</span>
            args <span class="hl opt">= [</span> element<span class="hl opt">,</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>type <span class="hl opt">]</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>beanDel <span class="hl opt">=</span> handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>handler<span class="hl opt">.</span>__beanDel<span class="hl opt">)</span> args<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>beanDel<span class="hl opt">.</span>selector<span class="hl opt">)</span>
            args<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>handlers<span class="hl opt">[</span>i<span class="hl opt">].</span>original<span class="hl opt">)</span>
            on<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> args<span class="hl opt">)</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> element
      <span class="hl opt">}</span>

    <span class="hl opt">,</span> bean <span class="hl opt">= {</span>
          <span class="hl str">'on'</span>                <span class="hl opt">:</span> on
        <span class="hl opt">,</span> <span class="hl str">'add'</span>               <span class="hl opt">:</span> add
        <span class="hl opt">,</span> <span class="hl str">'one'</span>               <span class="hl opt">:</span> one
        <span class="hl opt">,</span> <span class="hl str">'off'</span>               <span class="hl opt">:</span> off
        <span class="hl opt">,</span> <span class="hl str">'remove'</span>            <span class="hl opt">:</span> off
        <span class="hl opt">,</span> <span class="hl str">'clone'</span>             <span class="hl opt">:</span> clone
        <span class="hl opt">,</span> <span class="hl str">'fire'</span>              <span class="hl opt">:</span> fire
        <span class="hl opt">,</span> <span class="hl str">'Event'</span>             <span class="hl opt">:</span> Event
        <span class="hl opt">,</span> <span class="hl str">'setSelectorEngine'</span> <span class="hl opt">:</span> setSelectorEngine
        <span class="hl opt">,</span> <span class="hl str">'noConflict'</span>        <span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
            context<span class="hl opt">[</span>name<span class="hl opt">] =</span> old
            <span class="hl kwa">return this</span>
          <span class="hl opt">}</span>
      <span class="hl opt">}</span>

  <span class="hl slc">// for IE, clean up on unload to avoid leaks</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>win<span class="hl opt">.</span>attachEvent<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> <span class="hl kwd">cleanup</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
      <span class="hl kwa">var</span> i<span class="hl opt">,</span> entries <span class="hl opt">=</span> registry<span class="hl opt">.</span><span class="hl kwd">entries</span><span class="hl opt">()</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl kwa">in</span> entries<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>entries<span class="hl opt">[</span>i<span class="hl opt">].</span>type <span class="hl opt">&amp;&amp;</span> entries<span class="hl opt">[</span>i<span class="hl opt">].</span>type <span class="hl opt">!==</span> <span class="hl str">'unload'</span><span class="hl opt">)</span> <span class="hl kwd">off</span><span class="hl opt">(</span>entries<span class="hl opt">[</span>i<span class="hl opt">].</span>element<span class="hl opt">,</span> entries<span class="hl opt">[</span>i<span class="hl opt">].</span>type<span class="hl opt">)</span>
      <span class="hl opt">}</span>
      win<span class="hl opt">.</span><span class="hl kwd">detachEvent</span><span class="hl opt">(</span><span class="hl str">'onunload'</span><span class="hl opt">,</span> cleanup<span class="hl opt">)</span>
      win<span class="hl opt">.</span>CollectGarbage <span class="hl opt">&amp;&amp;</span> win<span class="hl opt">.</span><span class="hl kwd">CollectGarbage</span><span class="hl opt">()</span>
    <span class="hl opt">}</span>
    win<span class="hl opt">.</span><span class="hl kwd">attachEvent</span><span class="hl opt">(</span><span class="hl str">'onunload'</span><span class="hl opt">,</span> cleanup<span class="hl opt">)</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// initialize selector engine to internal default (qSA or throw Error)</span>
  <span class="hl kwd">setSelectorEngine</span><span class="hl opt">()</span>

  <span class="hl kwa">return</span> bean
<span class="hl opt">});</span>

<span class="hl opt">},{}],</span><span class="hl num">28</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>process<span class="hl opt">,</span>global<span class="hl opt">){</span>
<span class="hl com">/* &#64;preserve</span>
<span class="hl com"> * The MIT License (MIT)</span>
<span class="hl com"> * </span>
<span class="hl com"> * Copyright (c) 2014 Petka Antonov</span>
<span class="hl com"> * </span>
<span class="hl com"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="hl com"> * of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="hl com"> * in the Software without restriction, including without limitation the rights</span>
<span class="hl com"> * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="hl com"> * copies of the Software, and to permit persons to whom the Software is</span>
<span class="hl com"> * furnished to do so, subject to the following conditions:</span>
<span class="hl com"> * </span>
<span class="hl com"> * The above copyright notice and this permission notice shall be included in</span>
<span class="hl com"> * all copies or substantial portions of the Software.</span>
<span class="hl com"> * </span>
<span class="hl com"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="hl com"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="hl com"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE</span>
<span class="hl com"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="hl com"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="hl com"> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="hl com"> * THE SOFTWARE.</span>
<span class="hl com"> * </span>
<span class="hl com"> */</span>
<span class="hl com">/**</span>
<span class="hl com"> * bluebird build version 2.9.34</span>
<span class="hl com"> * Features enabled: core, race, call_get, generators, map, nodeify, promisify, props, reduce, settle, some, cancel, using, filter, any, each, timers</span>
<span class="hl com">*/</span>
<span class="hl opt">!</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">){</span><span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl str">&quot;object&quot;</span><span class="hl opt">==</span><span class="hl kwa">typeof</span> exports<span class="hl opt">&amp;&amp;</span><span class="hl str">&quot;undefined&quot;</span><span class="hl opt">!=</span><span class="hl kwa">typeof</span> module<span class="hl opt">)</span>module<span class="hl opt">.</span>exports<span class="hl opt">=</span><span class="hl kwd">e</span><span class="hl opt">();</span><span class="hl kwa">else if</span><span class="hl opt">(</span><span class="hl str">&quot;function&quot;</span><span class="hl opt">==</span><span class="hl kwa">typeof</span> define<span class="hl opt">&amp;&amp;</span>define<span class="hl opt">.</span>amd<span class="hl opt">)</span><span class="hl kwd">define</span><span class="hl opt">([],</span>e<span class="hl opt">);</span><span class="hl kwa">else</span><span class="hl opt">{</span><span class="hl kwa">var</span> f<span class="hl opt">;</span><span class="hl str">&quot;undefined&quot;</span><span class="hl opt">!=</span><span class="hl kwa">typeof</span> window<span class="hl opt">?</span>f<span class="hl opt">=</span>window<span class="hl opt">:</span><span class="hl str">&quot;undefined&quot;</span><span class="hl opt">!=</span><span class="hl kwa">typeof</span> global<span class="hl opt">?</span>f<span class="hl opt">=</span>global<span class="hl opt">:</span><span class="hl str">&quot;undefined&quot;</span><span class="hl opt">!=</span><span class="hl kwa">typeof</span> self<span class="hl opt">&amp;&amp;(</span>f<span class="hl opt">=</span>self<span class="hl opt">),</span>f<span class="hl opt">.</span>Promise<span class="hl opt">=</span><span class="hl kwd">e</span><span class="hl opt">()}}(</span><span class="hl kwa">function</span><span class="hl opt">(){</span><span class="hl kwa">var</span> define<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">;</span><span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl kwd">e</span><span class="hl opt">(</span>t<span class="hl opt">,</span>n<span class="hl opt">,</span>r<span class="hl opt">){</span><span class="hl kwa">function</span> <span class="hl kwd">s</span><span class="hl opt">(</span>o<span class="hl opt">,</span>u<span class="hl opt">){</span><span class="hl kwa">if</span><span class="hl opt">(!</span>n<span class="hl opt">[</span>o<span class="hl opt">]){</span><span class="hl kwa">if</span><span class="hl opt">(!</span>t<span class="hl opt">[</span>o<span class="hl opt">]){</span><span class="hl kwa">var</span> a<span class="hl opt">=</span><span class="hl kwa">typeof</span> _dereq_<span class="hl opt">==</span><span class="hl str">&quot;function&quot;</span><span class="hl opt">&amp;&amp;</span>_dereq_<span class="hl opt">;</span><span class="hl kwa">if</span><span class="hl opt">(!</span>u<span class="hl opt">&amp;&amp;</span>a<span class="hl opt">)</span><span class="hl kwa">return</span> <span class="hl kwd">a</span><span class="hl opt">(</span>o<span class="hl opt">,!</span><span class="hl num">0</span><span class="hl opt">);</span><span class="hl kwa">if</span><span class="hl opt">(</span>i<span class="hl opt">)</span><span class="hl kwa">return</span> <span class="hl kwd">i</span><span class="hl opt">(</span>o<span class="hl opt">,!</span><span class="hl num">0</span><span class="hl opt">);</span><span class="hl kwa">var</span> f<span class="hl opt">=</span><span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot find module '&quot;</span><span class="hl opt">+</span>o<span class="hl opt">+</span><span class="hl str">&quot;'&quot;</span><span class="hl opt">);</span><span class="hl kwa">throw</span> f<span class="hl opt">.</span>code<span class="hl opt">=</span><span class="hl str">&quot;MODULE_NOT_FOUND&quot;</span><span class="hl opt">,</span>f<span class="hl opt">}</span><span class="hl kwa">var</span> l<span class="hl opt">=</span>n<span class="hl opt">[</span>o<span class="hl opt">]={</span>exports<span class="hl opt">:{}};</span>t<span class="hl opt">[</span>o<span class="hl opt">][</span><span class="hl num">0</span><span class="hl opt">].</span><span class="hl kwd">call</span><span class="hl opt">(</span>l<span class="hl opt">.</span>exports<span class="hl opt">,</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">){</span><span class="hl kwa">var</span> n<span class="hl opt">=</span>t<span class="hl opt">[</span>o<span class="hl opt">][</span><span class="hl num">1</span><span class="hl opt">][</span>e<span class="hl opt">];</span><span class="hl kwa">return</span> <span class="hl kwd">s</span><span class="hl opt">(</span>n<span class="hl opt">?</span>n<span class="hl opt">:</span>e<span class="hl opt">)},</span>l<span class="hl opt">,</span>l<span class="hl opt">.</span>exports<span class="hl opt">,</span>e<span class="hl opt">,</span>t<span class="hl opt">,</span>n<span class="hl opt">,</span>r<span class="hl opt">)}</span><span class="hl kwa">return</span> n<span class="hl opt">[</span>o<span class="hl opt">].</span>exports<span class="hl opt">}</span><span class="hl kwa">var</span> i<span class="hl opt">=</span><span class="hl kwa">typeof</span> _dereq_<span class="hl opt">==</span><span class="hl str">&quot;function&quot;</span><span class="hl opt">&amp;&amp;</span>_dereq_<span class="hl opt">;</span><span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> o<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span>o<span class="hl opt">&lt;</span>r<span class="hl opt">.</span>length<span class="hl opt">;</span>o<span class="hl opt">++)</span><span class="hl kwd">s</span><span class="hl opt">(</span>r<span class="hl opt">[</span>o<span class="hl opt">]);</span><span class="hl kwa">return</span> s<span class="hl opt">})({</span><span class="hl num">1</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> SomePromiseArray <span class="hl opt">=</span> Promise<span class="hl opt">.</span>_SomePromiseArray<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">any</span><span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SomePromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> ret<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">setHowMany</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">setUnwrap</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">init</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> promise<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwd">any</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">any</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">any</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">any</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">2</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> firstLineError<span class="hl opt">;</span>
<span class="hl kwa">try</span> <span class="hl opt">{</span><span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(); }</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>firstLineError <span class="hl opt">=</span> e<span class="hl opt">;}</span>
<span class="hl kwa">var</span> schedule <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./schedule.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Queue <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./queue.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">Async</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_isTickUsed <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_lateQueue <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Queue</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_normalQueue <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Queue</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> self <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">drainQueues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        self<span class="hl opt">.</span><span class="hl kwd">_drainQueues</span><span class="hl opt">();</span>
    <span class="hl opt">};</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_schedule <span class="hl opt">=</span>
        schedule<span class="hl opt">.</span>isStatic <span class="hl opt">?</span> <span class="hl kwd">schedule</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>drainQueues<span class="hl opt">) :</span> schedule<span class="hl opt">;</span>
<span class="hl opt">}</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">disableTrampolineIfNecessary</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>util<span class="hl opt">.</span>hasDevTools<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">enableTrampoline</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
            <span class="hl kwd">setTimeout</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">haveItemsQueued</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_normalQueue<span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">throwLater</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>arguments<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        arg <span class="hl opt">=</span> fn<span class="hl opt">;</span>
        <span class="hl kwd">fn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span> <span class="hl kwa">throw</span> arg<span class="hl opt">; };</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> setTimeout <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
            <span class="hl kwd">fn</span><span class="hl opt">(</span>arg<span class="hl opt">);</span>
        <span class="hl opt">},</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else try</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
            <span class="hl kwd">fn</span><span class="hl opt">(</span>arg<span class="hl opt">);</span>
        <span class="hl opt">});</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">&quot;No async scheduler available</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/m3OTXk</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">AsyncInvokeLater</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_lateQueue<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueTick</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">AsyncInvoke</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_normalQueue<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueTick</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">AsyncSettlePromises</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_normalQueue<span class="hl opt">.</span><span class="hl kwd">_pushOne</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueTick</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

<span class="hl kwa">if</span> <span class="hl opt">(!</span>util<span class="hl opt">.</span>hasDevTools<span class="hl opt">) {</span>
    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>invokeLater <span class="hl opt">=</span> AsyncInvokeLater<span class="hl opt">;</span>
    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>invoke <span class="hl opt">=</span> AsyncInvoke<span class="hl opt">;</span>
    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>settlePromises <span class="hl opt">=</span> AsyncSettlePromises<span class="hl opt">;</span>
<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>schedule<span class="hl opt">.</span>isStatic<span class="hl opt">) {</span>
        <span class="hl kwd">schedule</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span> <span class="hl kwd">setTimeout</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">); };</span>
    <span class="hl opt">}</span>
    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">invokeLater</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled<span class="hl opt">) {</span>
            AsyncInvokeLater<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
                <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
                    fn<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
                <span class="hl opt">},</span> <span class="hl num">100</span><span class="hl opt">);</span>
            <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">invoke</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled<span class="hl opt">) {</span>
            AsyncInvoke<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
                fn<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
            <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">settlePromises</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trampolineEnabled<span class="hl opt">) {</span>
            AsyncSettlePromises<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> promise<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
                promise<span class="hl opt">.</span><span class="hl kwd">_settlePromises</span><span class="hl opt">();</span>
            <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">invokeFirst</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_normalQueue<span class="hl opt">.</span><span class="hl kwd">unshift</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueTick</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_drainQueue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>queue<span class="hl opt">) {</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>queue<span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> fn <span class="hl opt">=</span> queue<span class="hl opt">.</span><span class="hl kwd">shift</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            fn<span class="hl opt">.</span><span class="hl kwd">_settlePromises</span><span class="hl opt">();</span>
            <span class="hl kwa">continue</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> queue<span class="hl opt">.</span><span class="hl kwd">shift</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> arg <span class="hl opt">=</span> queue<span class="hl opt">.</span><span class="hl kwd">shift</span><span class="hl opt">();</span>
        fn<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> arg<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_drainQueues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_drainQueue</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_normalQueue<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reset</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_drainQueue</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_lateQueue<span class="hl opt">);</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_queueTick</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>_isTickUsed<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_isTickUsed <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_schedule</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>drainQueues<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Async<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_reset</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_isTickUsed <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Async</span><span class="hl opt">();</span>
module<span class="hl opt">.</span>exports<span class="hl opt">.</span>firstLineError <span class="hl opt">=</span> firstLineError<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./queue.js&quot;</span><span class="hl opt">:</span><span class="hl num">28</span><span class="hl opt">,</span><span class="hl str">&quot;./schedule.js&quot;</span><span class="hl opt">:</span><span class="hl num">31</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">3</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> <span class="hl kwd">rejectThis</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>_<span class="hl opt">,</span> e<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">targetRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">,</span> context<span class="hl opt">) {</span>
    context<span class="hl opt">.</span>promiseRejectionQueued <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    context<span class="hl opt">.</span>bindingPromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>rejectThis<span class="hl opt">,</span> rejectThis<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> e<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">bindingResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>thisArg<span class="hl opt">,</span> context<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>context<span class="hl opt">.</span>target<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">bindingRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">,</span> context<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>context<span class="hl opt">.</span>promiseRejectionQueued<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">bind</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>thisArg<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>thisArg<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> target <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>

    ret<span class="hl opt">.</span><span class="hl kwd">_setBoundTo</span><span class="hl opt">(</span>maybePromise<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> context <span class="hl opt">= {</span>
            promiseRejectionQueued<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
            promise<span class="hl opt">:</span> ret<span class="hl opt">,</span>
            target<span class="hl opt">:</span> target<span class="hl opt">,</span>
            bindingPromise<span class="hl opt">:</span> maybePromise
        <span class="hl opt">};</span>
        target<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">,</span> targetRejected<span class="hl opt">,</span> ret<span class="hl opt">.</span>_progress<span class="hl opt">,</span> ret<span class="hl opt">,</span> context<span class="hl opt">);</span>
        maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            bindingResolved<span class="hl opt">,</span> bindingRejected<span class="hl opt">,</span> ret<span class="hl opt">.</span>_progress<span class="hl opt">,</span> ret<span class="hl opt">,</span> context<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>target<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setBoundTo</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>obj <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">131072</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_boundTo <span class="hl opt">=</span> obj<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">131072</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isBound</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">131072</span><span class="hl opt">) ===</span> <span class="hl num">131072</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">bind</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>thisArg<span class="hl opt">,</span> value<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>thisArg<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>

    ret<span class="hl opt">.</span><span class="hl kwd">_setBoundTo</span><span class="hl opt">(</span>maybePromise<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
            ret<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        <span class="hl opt">},</span> ret<span class="hl opt">.</span>_reject<span class="hl opt">,</span> ret<span class="hl opt">.</span>_progress<span class="hl opt">,</span> ret<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">4</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> old<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> Promise <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">)</span> old <span class="hl opt">=</span> Promise<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">noConflict</span><span class="hl opt">() {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span> <span class="hl kwa">if</span> <span class="hl opt">(</span>Promise <span class="hl opt">===</span> bluebird<span class="hl opt">)</span> Promise <span class="hl opt">=</span> old<span class="hl opt">; }</span>
    <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {}</span>
    <span class="hl kwa">return</span> bluebird<span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwa">var</span> bluebird <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./promise.js&quot;</span><span class="hl opt">)();</span>
bluebird<span class="hl opt">.</span>noConflict <span class="hl opt">=</span> noConflict<span class="hl opt">;</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> bluebird<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./promise.js&quot;</span><span class="hl opt">:</span><span class="hl num">23</span><span class="hl opt">}],</span><span class="hl num">5</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> cr <span class="hl opt">=</span> Object<span class="hl opt">.</span>create<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>cr<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> callerCache <span class="hl opt">=</span> <span class="hl kwd">cr</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> getterCache <span class="hl opt">=</span> <span class="hl kwd">cr</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
    callerCache<span class="hl opt">[</span><span class="hl str">&quot; size&quot;</span><span class="hl opt">] =</span> getterCache<span class="hl opt">[</span><span class="hl str">&quot; size&quot;</span><span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> canEvaluate <span class="hl opt">=</span> util<span class="hl opt">.</span>canEvaluate<span class="hl opt">;</span>
<span class="hl kwa">var</span> isIdentifier <span class="hl opt">=</span> util<span class="hl opt">.</span>isIdentifier<span class="hl opt">;</span>

<span class="hl kwa">var</span> getMethodCaller<span class="hl opt">;</span>
<span class="hl kwa">var</span> getGetter<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
<span class="hl kwa">var</span> <span class="hl kwd">makeMethodCaller</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>methodName<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">Function</span><span class="hl opt">(</span><span class="hl str">&quot;ensureMethod&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;</span>                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        return function(obj) {</span>                                               <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            'use strict'</span>                                                     <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var len = this.length;</span>                                           <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            ensureMethod(obj, 'methodName');</span>                                 <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            switch(len) {</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                case 1: return obj.methodName(this[0]);</span>                      <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                case 2: return obj.methodName(this[0], this[1]);</span>             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                case 3: return obj.methodName(this[0], this[1], this[2]);</span>    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                case 0: return obj.methodName();</span>                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                default:</span>                                                     <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                    return obj.methodName.apply(obj, this);</span>                  <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            }</span>                                                                <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        };</span>                                                                   <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        &quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/methodName/g</span><span class="hl opt">,</span> methodName<span class="hl opt">))(</span>ensureMethod<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">makeGetter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>propertyName<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">Function</span><span class="hl opt">(</span><span class="hl str">&quot;obj&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;</span>                                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        'use strict';</span>                                                        <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        return obj.propertyName;</span>                                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        &quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;propertyName&quot;</span><span class="hl opt">,</span> propertyName<span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">getCompiled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>name<span class="hl opt">,</span> compiler<span class="hl opt">,</span> cache<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> cache<span class="hl opt">[</span>name<span class="hl opt">];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> ret <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isIdentifier</span><span class="hl opt">(</span>name<span class="hl opt">)) {</span>
            <span class="hl kwa">return null</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        ret <span class="hl opt">=</span> <span class="hl kwd">compiler</span><span class="hl opt">(</span>name<span class="hl opt">);</span>
        cache<span class="hl opt">[</span>name<span class="hl opt">] =</span> ret<span class="hl opt">;</span>
        cache<span class="hl opt">[</span><span class="hl str">&quot; size&quot;</span><span class="hl opt">]++;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>cache<span class="hl opt">[</span><span class="hl str">&quot; size&quot;</span><span class="hl opt">] &gt;</span> <span class="hl num">512</span><span class="hl opt">) {</span>
            <span class="hl kwa">var</span> keys <span class="hl opt">=</span> Object<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>cache<span class="hl opt">);</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">256</span><span class="hl opt">; ++</span>i<span class="hl opt">)</span> <span class="hl kwa">delete</span> cache<span class="hl opt">[</span>keys<span class="hl opt">[</span>i<span class="hl opt">]];</span>
            cache<span class="hl opt">[</span><span class="hl str">&quot; size&quot;</span><span class="hl opt">] =</span> keys<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">256</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwd">getMethodCaller</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>name<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">getCompiled</span><span class="hl opt">(</span>name<span class="hl opt">,</span> makeMethodCaller<span class="hl opt">,</span> callerCache<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwd">getGetter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>name<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">getCompiled</span><span class="hl opt">(</span>name<span class="hl opt">,</span> makeGetter<span class="hl opt">,</span> getterCache<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">ensureMethod</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> methodName<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>obj <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span> fn <span class="hl opt">=</span> obj<span class="hl opt">[</span>methodName<span class="hl opt">];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> message <span class="hl opt">=</span> <span class="hl str">&quot;Object &quot;</span> <span class="hl opt">+</span> util<span class="hl opt">.</span><span class="hl kwd">classString</span><span class="hl opt">(</span>obj<span class="hl opt">) +</span> <span class="hl str">&quot; has no method '&quot;</span> <span class="hl opt">+</span>
            util<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span>methodName<span class="hl opt">) +</span> <span class="hl str">&quot;'&quot;</span><span class="hl opt">;</span>
        <span class="hl kwa">throw new</span> Promise<span class="hl opt">.</span><span class="hl kwd">TypeError</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> fn<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">caller</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> methodName <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">pop</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> fn <span class="hl opt">=</span> <span class="hl kwd">ensureMethod</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> methodName<span class="hl opt">);</span>
    <span class="hl kwa">return</span> fn<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">}</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">call</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>methodName<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> <span class="hl opt">$</span>_len <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length<span class="hl opt">;</span><span class="hl kwa">var</span> args <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">($</span>_len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span> <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> <span class="hl opt">$</span>_i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; $</span>_i <span class="hl opt">&lt; $</span>_len<span class="hl opt">; ++$</span>_i<span class="hl opt">) {</span>args<span class="hl opt">[$</span>_i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] =</span> arguments<span class="hl opt">[$</span>_i<span class="hl opt">];}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>canEvaluate<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> maybeCaller <span class="hl opt">=</span> <span class="hl kwd">getMethodCaller</span><span class="hl opt">(</span>methodName<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>maybeCaller <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
                <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
                    maybeCaller<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> args<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    args<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>methodName<span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>caller<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> args<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">namedGetter</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">];</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">indexedGetter</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> index <span class="hl opt">= +</span><span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">)</span> index <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> index <span class="hl opt">+</span> obj<span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">[</span>index<span class="hl opt">];</span>
<span class="hl opt">}</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwa">get</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>propertyName<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> isIndex <span class="hl opt">= (</span><span class="hl kwa">typeof</span> propertyName <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> getter<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>isIndex<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>canEvaluate<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> maybeGetter <span class="hl opt">=</span> <span class="hl kwd">getGetter</span><span class="hl opt">(</span>propertyName<span class="hl opt">);</span>
            getter <span class="hl opt">=</span> maybeGetter <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> maybeGetter <span class="hl opt">:</span> namedGetter<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            getter <span class="hl opt">=</span> namedGetter<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        getter <span class="hl opt">=</span> indexedGetter<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>getter<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> propertyName<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">6</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> errors <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> CancellationError <span class="hl opt">=</span> errors<span class="hl opt">.</span>CancellationError<span class="hl opt">;</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_cancel</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isCancellable</span><span class="hl opt">())</span> <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> parent<span class="hl opt">;</span>
    <span class="hl kwa">var</span> promiseToReject <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">((</span>parent <span class="hl opt">=</span> promiseToReject<span class="hl opt">.</span>_cancellationParent<span class="hl opt">) !==</span> undefined <span class="hl opt">&amp;&amp;</span>
        parent<span class="hl opt">.</span><span class="hl kwd">isCancellable</span><span class="hl opt">()) {</span>
        promiseToReject <span class="hl opt">=</span> parent<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetCancellable</span><span class="hl opt">();</span>
    promiseToReject<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">cancel</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isCancellable</span><span class="hl opt">())</span> <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>reason <span class="hl opt">===</span> undefined<span class="hl opt">)</span> reason <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CancellationError</span><span class="hl opt">();</span>
    async<span class="hl opt">.</span><span class="hl kwd">invokeLater</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_cancel<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> reason<span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">cancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_cancellable</span><span class="hl opt">())</span> <span class="hl kwa">return this</span><span class="hl opt">;</span>
    async<span class="hl opt">.</span><span class="hl kwd">enableTrampoline</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setCancellable</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_cancellationParent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">uncancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_unsetCancellable</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">fork</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">,</span>
                         undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>

    ret<span class="hl opt">.</span><span class="hl kwd">_setCancellable</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span>_cancellationParent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">}],</span><span class="hl num">7</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> bluebirdFramePattern <span class="hl opt">=</span>
    <span class="hl kwc">/[\\\/]bluebird[\\\/]js[\\\/](main|debug|zalgo|instrumented)/</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> stackFramePattern <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> formatStack <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> indentStackFrames <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> warn<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">CapturedTrace</span><span class="hl opt">(</span>parent<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_parent <span class="hl opt">=</span> parent<span class="hl opt">;</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">+ (</span>parent <span class="hl opt">===</span> undefined <span class="hl opt">?</span> <span class="hl num">0</span> <span class="hl opt">:</span> parent<span class="hl opt">.</span>_length<span class="hl opt">);</span>
    <span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> CapturedTrace<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>length <span class="hl opt">&gt;</span> <span class="hl num">32</span><span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">uncycle</span><span class="hl opt">();</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>CapturedTrace<span class="hl opt">,</span> Error<span class="hl opt">);</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">uncycle</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>length <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> nodes <span class="hl opt">= [];</span>
    <span class="hl kwa">var</span> stackToIndex <span class="hl opt">= {};</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> node <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span> node <span class="hl opt">!==</span> undefined<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        nodes<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>node<span class="hl opt">);</span>
        node <span class="hl opt">=</span> node<span class="hl opt">.</span>_parent<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> i<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">; --</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> stack <span class="hl opt">=</span> nodes<span class="hl opt">[</span>i<span class="hl opt">].</span>stack<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>stackToIndex<span class="hl opt">[</span>stack<span class="hl opt">] ===</span> undefined<span class="hl opt">) {</span>
            stackToIndex<span class="hl opt">[</span>stack<span class="hl opt">] =</span> i<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> currentStack <span class="hl opt">=</span> nodes<span class="hl opt">[</span>i<span class="hl opt">].</span>stack<span class="hl opt">;</span>
        <span class="hl kwa">var</span> index <span class="hl opt">=</span> stackToIndex<span class="hl opt">[</span>currentStack<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span> index <span class="hl opt">!==</span> i<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
                nodes<span class="hl opt">[</span>index <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">].</span>_parent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
                nodes<span class="hl opt">[</span>index <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">].</span>_length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
            nodes<span class="hl opt">[</span>i<span class="hl opt">].</span>_parent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
            nodes<span class="hl opt">[</span>i<span class="hl opt">].</span>_length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwa">var</span> cycleEdgeNode <span class="hl opt">=</span> i <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">?</span> nodes<span class="hl opt">[</span>i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] :</span> <span class="hl kwa">this</span><span class="hl opt">;</span>

            <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&lt;</span> length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) {</span>
                cycleEdgeNode<span class="hl opt">.</span>_parent <span class="hl opt">=</span> nodes<span class="hl opt">[</span>index <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">];</span>
                cycleEdgeNode<span class="hl opt">.</span>_parent<span class="hl opt">.</span><span class="hl kwd">uncycle</span><span class="hl opt">();</span>
                cycleEdgeNode<span class="hl opt">.</span>_length <span class="hl opt">=</span>
                    cycleEdgeNode<span class="hl opt">.</span>_parent<span class="hl opt">.</span>_length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                cycleEdgeNode<span class="hl opt">.</span>_parent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
                cycleEdgeNode<span class="hl opt">.</span>_length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">var</span> currentChildLength <span class="hl opt">=</span> cycleEdgeNode<span class="hl opt">.</span>_length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> i <span class="hl opt">-</span> <span class="hl num">2</span><span class="hl opt">;</span> j <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">; --</span>j<span class="hl opt">) {</span>
                nodes<span class="hl opt">[</span>j<span class="hl opt">].</span>_length <span class="hl opt">=</span> currentChildLength<span class="hl opt">;</span>
                currentChildLength<span class="hl opt">++;</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">parent</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_parent<span class="hl opt">;</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">hasParent</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_parent <span class="hl opt">!==</span> undefined<span class="hl opt">;</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">attachExtraTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>error<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>error<span class="hl opt">.</span>__stackCleaned__<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">uncycle</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> parsed <span class="hl opt">=</span> CapturedTrace<span class="hl opt">.</span><span class="hl kwd">parseStackAndMessage</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
    <span class="hl kwa">var</span> message <span class="hl opt">=</span> parsed<span class="hl opt">.</span>message<span class="hl opt">;</span>
    <span class="hl kwa">var</span> stacks <span class="hl opt">= [</span>parsed<span class="hl opt">.</span>stack<span class="hl opt">];</span>

    <span class="hl kwa">var</span> trace <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>trace <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        stacks<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwd">cleanStack</span><span class="hl opt">(</span>trace<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">)));</span>
        trace <span class="hl opt">=</span> trace<span class="hl opt">.</span>_parent<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">removeCommonRoots</span><span class="hl opt">(</span>stacks<span class="hl opt">);</span>
    <span class="hl kwd">removeDuplicateOrEmptyJumps</span><span class="hl opt">(</span>stacks<span class="hl opt">);</span>
    util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>error<span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">,</span> <span class="hl kwd">reconstructStack</span><span class="hl opt">(</span>message<span class="hl opt">,</span> stacks<span class="hl opt">));</span>
    util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>error<span class="hl opt">,</span> <span class="hl str">&quot;__stackCleaned__&quot;</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">reconstructStack</span><span class="hl opt">(</span>message<span class="hl opt">,</span> stacks<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> stacks<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        stacks<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl str">&quot;From previous event:&quot;</span><span class="hl opt">);</span>
        stacks<span class="hl opt">[</span>i<span class="hl opt">] =</span> stacks<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> stacks<span class="hl opt">.</span>length<span class="hl opt">) {</span>
        stacks<span class="hl opt">[</span>i<span class="hl opt">] =</span> stacks<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> message <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">+</span> stacks<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">removeDuplicateOrEmptyJumps</span><span class="hl opt">(</span>stacks<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> stacks<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>stacks<span class="hl opt">[</span>i<span class="hl opt">].</span>length <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">||</span>
            <span class="hl opt">((</span>i <span class="hl opt">+</span> <span class="hl num">1</span> <span class="hl opt">&lt;</span> stacks<span class="hl opt">.</span>length<span class="hl opt">) &amp;&amp;</span> stacks<span class="hl opt">[</span>i<span class="hl opt">][</span><span class="hl num">0</span><span class="hl opt">] ===</span> stacks<span class="hl opt">[</span>i<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">][</span><span class="hl num">0</span><span class="hl opt">])) {</span>
            stacks<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>i<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
            i<span class="hl opt">--;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">removeCommonRoots</span><span class="hl opt">(</span>stacks<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> current <span class="hl opt">=</span> stacks<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> stacks<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> prev <span class="hl opt">=</span> stacks<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> currentLastIndex <span class="hl opt">=</span> current<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> currentLastLine <span class="hl opt">=</span> current<span class="hl opt">[</span>currentLastIndex<span class="hl opt">];</span>
        <span class="hl kwa">var</span> commonRootMeetPoint <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>

        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> prev<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> j <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">; --</span>j<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>prev<span class="hl opt">[</span>j<span class="hl opt">] ===</span> currentLastLine<span class="hl opt">) {</span>
                commonRootMeetPoint <span class="hl opt">=</span> j<span class="hl opt">;</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> commonRootMeetPoint<span class="hl opt">;</span> j <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">; --</span>j<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> line <span class="hl opt">=</span> prev<span class="hl opt">[</span>j<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>current<span class="hl opt">[</span>currentLastIndex<span class="hl opt">] ===</span> line<span class="hl opt">) {</span>
                current<span class="hl opt">.</span><span class="hl kwd">pop</span><span class="hl opt">();</span>
                currentLastIndex<span class="hl opt">--;</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        current <span class="hl opt">=</span> prev<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">cleanStack</span><span class="hl opt">(</span>stack<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">= [];</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> stack<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> line <span class="hl opt">=</span> stack<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> isTraceLine <span class="hl opt">=</span> stackFramePattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>line<span class="hl opt">) ||</span>
            <span class="hl str">&quot;    (No stack trace)&quot;</span> <span class="hl opt">===</span> line<span class="hl opt">;</span>
        <span class="hl kwa">var</span> isInternalFrame <span class="hl opt">=</span> isTraceLine <span class="hl opt">&amp;&amp;</span> <span class="hl kwd">shouldIgnore</span><span class="hl opt">(</span>line<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>isTraceLine <span class="hl opt">&amp;&amp; !</span>isInternalFrame<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>indentStackFrames <span class="hl opt">&amp;&amp;</span> line<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) !==</span> <span class="hl str">&quot; &quot;</span><span class="hl opt">) {</span>
                line <span class="hl opt">=</span> <span class="hl str">&quot;    &quot;</span> <span class="hl opt">+</span> line<span class="hl opt">;</span>
            <span class="hl opt">}</span>
            ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>line<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">stackFramesAsArray</span><span class="hl opt">(</span>error<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> stack <span class="hl opt">=</span> error<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/\s+$/g</span><span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> stack<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> line <span class="hl opt">=</span> stack<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl str">&quot;    (No stack trace)&quot;</span> <span class="hl opt">===</span> line <span class="hl opt">||</span> stackFramePattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>line<span class="hl opt">)) {</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        stack <span class="hl opt">=</span> stack<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> stack<span class="hl opt">;</span>
<span class="hl opt">}</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwd">parseStackAndMessage</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>error<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> stack <span class="hl opt">=</span> error<span class="hl opt">.</span>stack<span class="hl opt">;</span>
    <span class="hl kwa">var</span> message <span class="hl opt">=</span> error<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
    stack <span class="hl opt">=</span> <span class="hl kwa">typeof</span> stack <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">&amp;&amp;</span> stack<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span>
                <span class="hl opt">?</span> <span class="hl kwd">stackFramesAsArray</span><span class="hl opt">(</span>error<span class="hl opt">) : [</span><span class="hl str">&quot;    (No stack trace)&quot;</span><span class="hl opt">];</span>
    <span class="hl kwa">return</span> <span class="hl opt">{</span>
        message<span class="hl opt">:</span> message<span class="hl opt">,</span>
        stack<span class="hl opt">:</span> <span class="hl kwd">cleanStack</span><span class="hl opt">(</span>stack<span class="hl opt">)</span>
    <span class="hl opt">};</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwd">formatAndLogError</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>error<span class="hl opt">,</span> title<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> console <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> message<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> error <span class="hl opt">===</span> <span class="hl str">&quot;object&quot;</span> <span class="hl opt">||</span> <span class="hl kwa">typeof</span> error <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">var</span> stack <span class="hl opt">=</span> error<span class="hl opt">.</span>stack<span class="hl opt">;</span>
            message <span class="hl opt">=</span> title <span class="hl opt">+</span> <span class="hl kwd">formatStack</span><span class="hl opt">(</span>stack<span class="hl opt">,</span> error<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            message <span class="hl opt">=</span> title <span class="hl opt">+</span> <span class="hl kwd">String</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> warn <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwd">warn</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> console<span class="hl opt">.</span>log <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">||</span>
            <span class="hl kwa">typeof</span> console<span class="hl opt">.</span>log <span class="hl opt">===</span> <span class="hl str">&quot;object&quot;</span><span class="hl opt">) {</span>
            console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwd">unhandledRejection</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    CapturedTrace<span class="hl opt">.</span><span class="hl kwd">formatAndLogError</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl str">&quot;^--- With additional stack trace: &quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span><span class="hl kwd">isSupported</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return typeof</span> captureStackTrace <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

CapturedTrace<span class="hl opt">.</span>fireRejectionEvent <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>name<span class="hl opt">,</span> localHandler<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> localEventFired <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> localHandler <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            localEventFired <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>name <span class="hl opt">===</span> <span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">) {</span>
                <span class="hl kwd">localHandler</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwd">localHandler</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> globalEventFired <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        globalEventFired <span class="hl opt">=</span> <span class="hl kwd">fireGlobalEvent</span><span class="hl opt">(</span>name<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        globalEventFired <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> domEventFired <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>fireDomEvent<span class="hl opt">) {</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
            domEventFired <span class="hl opt">=</span> <span class="hl kwd">fireDomEvent</span><span class="hl opt">(</span>name<span class="hl opt">.</span><span class="hl kwd">toLowerCase</span><span class="hl opt">(), {</span>
                reason<span class="hl opt">:</span> reason<span class="hl opt">,</span>
                promise<span class="hl opt">:</span> promise
            <span class="hl opt">});</span>
        <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
            domEventFired <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
            async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span>globalEventFired <span class="hl opt">&amp;&amp; !</span>localEventFired <span class="hl opt">&amp;&amp; !</span>domEventFired <span class="hl opt">&amp;&amp;</span>
        name <span class="hl opt">===</span> <span class="hl str">&quot;unhandledRejection&quot;</span><span class="hl opt">) {</span>
        CapturedTrace<span class="hl opt">.</span><span class="hl kwd">formatAndLogError</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl str">&quot;Unhandled rejection &quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">formatNonError</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> str<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> obj <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        str <span class="hl opt">=</span> <span class="hl str">&quot;[function &quot;</span> <span class="hl opt">+</span>
            <span class="hl opt">(</span>obj<span class="hl opt">.</span>name <span class="hl opt">||</span> <span class="hl str">&quot;anonymous&quot;</span><span class="hl opt">) +</span>
            <span class="hl str">&quot;]&quot;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        str <span class="hl opt">=</span> obj<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> ruselessToString <span class="hl opt">=</span> <span class="hl kwc">/\[object [a-zA-Z0-9$_]+\]/</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ruselessToString<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>str<span class="hl opt">)) {</span>
            <span class="hl kwa">try</span> <span class="hl opt">{</span>
                <span class="hl kwa">var</span> newStr <span class="hl opt">=</span> JSON<span class="hl opt">.</span><span class="hl kwd">stringify</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
                str <span class="hl opt">=</span> newStr<span class="hl opt">;</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>

            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>str<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
            str <span class="hl opt">=</span> <span class="hl str">&quot;(empty array)&quot;</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl str">&quot;(&lt;&quot;</span> <span class="hl opt">+</span> <span class="hl kwd">snip</span><span class="hl opt">(</span>str<span class="hl opt">) +</span> <span class="hl str">&quot;&gt;, no stack trace)&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">snip</span><span class="hl opt">(</span>str<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> maxChars <span class="hl opt">=</span> <span class="hl num">41</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>str<span class="hl opt">.</span>length <span class="hl opt">&lt;</span> maxChars<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> str<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> str<span class="hl opt">.</span><span class="hl kwd">substr</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> maxChars <span class="hl opt">-</span> <span class="hl num">3</span><span class="hl opt">) +</span> <span class="hl str">&quot;...&quot;</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> <span class="hl kwd">shouldIgnore</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span> <span class="hl kwa">return false</span><span class="hl opt">; };</span>
<span class="hl kwa">var</span> parseLineInfoRegex <span class="hl opt">=</span> <span class="hl kwc">/[\/&lt;\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">parseLineInfo</span><span class="hl opt">(</span>line<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> matches <span class="hl opt">=</span> line<span class="hl opt">.</span><span class="hl kwd">match</span><span class="hl opt">(</span>parseLineInfoRegex<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>matches<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">{</span>
            fileName<span class="hl opt">:</span> matches<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">],</span>
            line<span class="hl opt">:</span> <span class="hl kwd">parseInt</span><span class="hl opt">(</span>matches<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">],</span> <span class="hl num">10</span><span class="hl opt">)</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>
CapturedTrace<span class="hl opt">.</span><span class="hl kwd">setBounds</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>firstLineError<span class="hl opt">,</span> lastLineError<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>CapturedTrace<span class="hl opt">.</span><span class="hl kwd">isSupported</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> firstStackLines <span class="hl opt">=</span> firstLineError<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> lastStackLines <span class="hl opt">=</span> lastLineError<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> firstIndex <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> lastIndex <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> firstFileName<span class="hl opt">;</span>
    <span class="hl kwa">var</span> lastFileName<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> firstStackLines<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">parseLineInfo</span><span class="hl opt">(</span>firstStackLines<span class="hl opt">[</span>i<span class="hl opt">]);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>result<span class="hl opt">) {</span>
            firstFileName <span class="hl opt">=</span> result<span class="hl opt">.</span>fileName<span class="hl opt">;</span>
            firstIndex <span class="hl opt">=</span> result<span class="hl opt">.</span>line<span class="hl opt">;</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> lastStackLines<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">parseLineInfo</span><span class="hl opt">(</span>lastStackLines<span class="hl opt">[</span>i<span class="hl opt">]);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>result<span class="hl opt">) {</span>
            lastFileName <span class="hl opt">=</span> result<span class="hl opt">.</span>fileName<span class="hl opt">;</span>
            lastIndex <span class="hl opt">=</span> result<span class="hl opt">.</span>line<span class="hl opt">;</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>firstIndex <span class="hl opt">&lt;</span> <span class="hl num">0</span> <span class="hl opt">||</span> lastIndex <span class="hl opt">&lt;</span> <span class="hl num">0</span> <span class="hl opt">|| !</span>firstFileName <span class="hl opt">|| !</span>lastFileName <span class="hl opt">||</span>
        firstFileName <span class="hl opt">!==</span> lastFileName <span class="hl opt">||</span> firstIndex <span class="hl opt">&gt;=</span> lastIndex<span class="hl opt">) {</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">shouldIgnore</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>line<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>bluebirdFramePattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>line<span class="hl opt">))</span> <span class="hl kwa">return true</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> info <span class="hl opt">=</span> <span class="hl kwd">parseLineInfo</span><span class="hl opt">(</span>line<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>info<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>info<span class="hl opt">.</span>fileName <span class="hl opt">===</span> firstFileName <span class="hl opt">&amp;&amp;</span>
                <span class="hl opt">(</span>firstIndex <span class="hl opt">&lt;=</span> info<span class="hl opt">.</span>line <span class="hl opt">&amp;&amp;</span> info<span class="hl opt">.</span>line <span class="hl opt">&lt;=</span> lastIndex<span class="hl opt">)) {</span>
                <span class="hl kwa">return true</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> captureStackTrace <span class="hl opt">= (</span><span class="hl kwa">function</span> <span class="hl kwd">stackDetection</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> v8stackFramePattern <span class="hl opt">=</span> <span class="hl kwc">/^\s*at\s*/</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> <span class="hl kwd">v8stackFormatter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>stack<span class="hl opt">,</span> error<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> stack <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> stack<span class="hl opt">;</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>error<span class="hl opt">.</span>name <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span>
            error<span class="hl opt">.</span>message <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> error<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> <span class="hl kwd">formatNonError</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span> <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwa">typeof</span> Error<span class="hl opt">.</span>captureStackTrace <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">=</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">+</span> <span class="hl num">6</span><span class="hl opt">;</span>
        stackFramePattern <span class="hl opt">=</span> v8stackFramePattern<span class="hl opt">;</span>
        formatStack <span class="hl opt">=</span> v8stackFormatter<span class="hl opt">;</span>
        <span class="hl kwa">var</span> captureStackTrace <span class="hl opt">=</span> Error<span class="hl opt">.</span>captureStackTrace<span class="hl opt">;</span>

        <span class="hl kwd">shouldIgnore</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>line<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> bluebirdFramePattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>line<span class="hl opt">);</span>
        <span class="hl opt">};</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> ignoreUntil<span class="hl opt">) {</span>
            Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">=</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">+</span> <span class="hl num">6</span><span class="hl opt">;</span>
            <span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> ignoreUntil<span class="hl opt">);</span>
            Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">=</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">-</span> <span class="hl num">6</span><span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> err <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> err<span class="hl opt">.</span>stack <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">&amp;&amp;</span>
        err<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">)[</span><span class="hl num">0</span><span class="hl opt">].</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span><span class="hl str">&quot;stackDetection&#64;&quot;</span><span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        stackFramePattern <span class="hl opt">= /&#64;/;</span>
        formatStack <span class="hl opt">=</span> v8stackFormatter<span class="hl opt">;</span>
        indentStackFrames <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl kwa">return function</span> <span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span>o<span class="hl opt">) {</span>
            o<span class="hl opt">.</span>stack <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">().</span>stack<span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> hasStackAfterThrow<span class="hl opt">;</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span> <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(); }</span>
    <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
        hasStackAfterThrow <span class="hl opt">= (</span><span class="hl str">&quot;stack&quot;</span> <span class="hl kwa">in</span> e<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl str">&quot;stack&quot;</span> <span class="hl kwa">in</span> err<span class="hl opt">) &amp;&amp;</span> hasStackAfterThrow <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwa">typeof</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span><span class="hl opt">) {</span>
        stackFramePattern <span class="hl opt">=</span> v8stackFramePattern<span class="hl opt">;</span>
        formatStack <span class="hl opt">=</span> v8stackFormatter<span class="hl opt">;</span>
        <span class="hl kwa">return function</span> <span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span>o<span class="hl opt">) {</span>
            Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">=</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">+</span> <span class="hl num">6</span><span class="hl opt">;</span>
            <span class="hl kwa">try</span> <span class="hl opt">{</span> <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(); }</span>
            <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span> o<span class="hl opt">.</span>stack <span class="hl opt">=</span> e<span class="hl opt">.</span>stack<span class="hl opt">; }</span>
            Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">=</span> Error<span class="hl opt">.</span>stackTraceLimit <span class="hl opt">-</span> <span class="hl num">6</span><span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">formatStack</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>stack<span class="hl opt">,</span> error<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> stack <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> stack<span class="hl opt">;</span>

        <span class="hl kwa">if</span> <span class="hl opt">((</span><span class="hl kwa">typeof</span> error <span class="hl opt">===</span> <span class="hl str">&quot;object&quot;</span> <span class="hl opt">||</span>
            <span class="hl kwa">typeof</span> error <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) &amp;&amp;</span>
            error<span class="hl opt">.</span>name <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span>
            error<span class="hl opt">.</span>message <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> error<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> <span class="hl kwd">formatNonError</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return null</span><span class="hl opt">;</span>

<span class="hl opt">})([]);</span>

<span class="hl kwa">var</span> fireDomEvent<span class="hl opt">;</span>
<span class="hl kwa">var</span> fireGlobalEvent <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>util<span class="hl opt">.</span>isNode<span class="hl opt">) {</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>name<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>name <span class="hl opt">===</span> <span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">) {</span>
                <span class="hl kwa">return</span> process<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span>name<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">return</span> process<span class="hl opt">.</span><span class="hl kwd">emit</span><span class="hl opt">(</span>name<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> customEventWorks <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> anyEventWorks <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
            <span class="hl kwa">var</span> ev <span class="hl opt">=</span> <span class="hl kwa">new</span> self<span class="hl opt">.</span><span class="hl kwd">CustomEvent</span><span class="hl opt">(</span><span class="hl str">&quot;test&quot;</span><span class="hl opt">);</span>
            customEventWorks <span class="hl opt">=</span> ev <span class="hl kwa">instanceof</span> CustomEvent<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>customEventWorks<span class="hl opt">) {</span>
            <span class="hl kwa">try</span> <span class="hl opt">{</span>
                <span class="hl kwa">var</span> event <span class="hl opt">=</span> document<span class="hl opt">.</span><span class="hl kwd">createEvent</span><span class="hl opt">(</span><span class="hl str">&quot;CustomEvent&quot;</span><span class="hl opt">);</span>
                event<span class="hl opt">.</span><span class="hl kwd">initCustomEvent</span><span class="hl opt">(</span><span class="hl str">&quot;testingtheevent&quot;</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">, {});</span>
                self<span class="hl opt">.</span><span class="hl kwd">dispatchEvent</span><span class="hl opt">(</span>event<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
                anyEventWorks <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>anyEventWorks<span class="hl opt">) {</span>
            <span class="hl kwd">fireDomEvent</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>type<span class="hl opt">,</span> detail<span class="hl opt">) {</span>
                <span class="hl kwa">var</span> event<span class="hl opt">;</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>customEventWorks<span class="hl opt">) {</span>
                    event <span class="hl opt">=</span> <span class="hl kwa">new</span> self<span class="hl opt">.</span><span class="hl kwd">CustomEvent</span><span class="hl opt">(</span>type<span class="hl opt">, {</span>
                        detail<span class="hl opt">:</span> detail<span class="hl opt">,</span>
                        bubbles<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
                        cancelable<span class="hl opt">:</span> <span class="hl kwa">true</span>
                    <span class="hl opt">});</span>
                <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>self<span class="hl opt">.</span>dispatchEvent<span class="hl opt">) {</span>
                    event <span class="hl opt">=</span> document<span class="hl opt">.</span><span class="hl kwd">createEvent</span><span class="hl opt">(</span><span class="hl str">&quot;CustomEvent&quot;</span><span class="hl opt">);</span>
                    event<span class="hl opt">.</span><span class="hl kwd">initCustomEvent</span><span class="hl opt">(</span>type<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> detail<span class="hl opt">);</span>
                <span class="hl opt">}</span>

                <span class="hl kwa">return</span> event <span class="hl opt">? !</span>self<span class="hl opt">.</span><span class="hl kwd">dispatchEvent</span><span class="hl opt">(</span>event<span class="hl opt">) :</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
            <span class="hl opt">};</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">var</span> toWindowMethodNameMap <span class="hl opt">= {};</span>
        toWindowMethodNameMap<span class="hl opt">[</span><span class="hl str">&quot;unhandledRejection&quot;</span><span class="hl opt">] = (</span><span class="hl str">&quot;on&quot;</span> <span class="hl opt">+</span>
            <span class="hl str">&quot;unhandledRejection&quot;</span><span class="hl opt">).</span><span class="hl kwd">toLowerCase</span><span class="hl opt">();</span>
        toWindowMethodNameMap<span class="hl opt">[</span><span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">] = (</span><span class="hl str">&quot;on&quot;</span> <span class="hl opt">+</span>
            <span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">).</span><span class="hl kwd">toLowerCase</span><span class="hl opt">();</span>

        <span class="hl kwa">return function</span><span class="hl opt">(</span>name<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> methodName <span class="hl opt">=</span> toWindowMethodNameMap<span class="hl opt">[</span>name<span class="hl opt">];</span>
            <span class="hl kwa">var</span> method <span class="hl opt">=</span> self<span class="hl opt">[</span>methodName<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(!</span>method<span class="hl opt">)</span> <span class="hl kwa">return false</span><span class="hl opt">;</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>name <span class="hl opt">===</span> <span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">) {</span>
                method<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>self<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                method<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>self<span class="hl opt">,</span> reason<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">return true</span><span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">})();</span>

<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> console <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> console<span class="hl opt">.</span>warn <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
    <span class="hl kwd">warn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>message<span class="hl opt">) {</span>
        console<span class="hl opt">.</span><span class="hl kwd">warn</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl opt">};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>util<span class="hl opt">.</span>isNode <span class="hl opt">&amp;&amp;</span> process<span class="hl opt">.</span>stderr<span class="hl opt">.</span>isTTY<span class="hl opt">) {</span>
        <span class="hl kwd">warn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>message<span class="hl opt">) {</span>
            process<span class="hl opt">.</span>stderr<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\u001b</span><span class="hl str">[31m&quot;</span> <span class="hl opt">+</span> message <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\u001b</span><span class="hl str">[39m</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span>util<span class="hl opt">.</span>isNode <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> <span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">().</span>stack<span class="hl opt">) ===</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwd">warn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>message<span class="hl opt">) {</span>
            console<span class="hl opt">.</span><span class="hl kwd">warn</span><span class="hl opt">(</span><span class="hl str">&quot;%c&quot;</span> <span class="hl opt">+</span> message<span class="hl opt">,</span> <span class="hl str">&quot;color: red&quot;</span><span class="hl opt">);</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">return</span> CapturedTrace<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">8</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>NEXT_FILTER<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> errors <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> keys <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">).</span>keys<span class="hl opt">;</span>
<span class="hl kwa">var</span> TypeError <span class="hl opt">=</span> errors<span class="hl opt">.</span>TypeError<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">CatchFilter</span><span class="hl opt">(</span>instances<span class="hl opt">,</span> callback<span class="hl opt">,</span> promise<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_instances <span class="hl opt">=</span> instances<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_callback <span class="hl opt">=</span> callback<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise <span class="hl opt">=</span> promise<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">safePredicate</span><span class="hl opt">(</span>predicate<span class="hl opt">,</span> e<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> safeObject <span class="hl opt">= {};</span>
    <span class="hl kwa">var</span> retfilter <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>predicate<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>safeObject<span class="hl opt">,</span> e<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>retfilter <span class="hl opt">===</span> errorObj<span class="hl opt">)</span> <span class="hl kwa">return</span> retfilter<span class="hl opt">;</span>

    <span class="hl kwa">var</span> safeKeys <span class="hl opt">=</span> <span class="hl kwd">keys</span><span class="hl opt">(</span>safeObject<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>safeKeys<span class="hl opt">.</span>length<span class="hl opt">) {</span>
        errorObj<span class="hl opt">.</span>e <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Catch filter must inherit from Error or be a simple predicate function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/o84o68</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">return</span> errorObj<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> retfilter<span class="hl opt">;</span>
<span class="hl opt">}</span>

CatchFilter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">doFilter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> cb <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_callback<span class="hl opt">;</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">;</span>
    <span class="hl kwa">var</span> boundTo <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">();</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_instances<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> item <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_instances<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> itemIsErrorType <span class="hl opt">=</span> item <span class="hl opt">===</span> Error <span class="hl opt">||</span>
            <span class="hl opt">(</span>item <span class="hl opt">!=</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> item<span class="hl opt">.</span><span class="hl kwa">prototype instanceof</span> Error<span class="hl opt">);</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>itemIsErrorType <span class="hl opt">&amp;&amp;</span> e <span class="hl kwa">instanceof</span> item<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>cb<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>boundTo<span class="hl opt">,</span> e<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
                NEXT_FILTER<span class="hl opt">.</span>e <span class="hl opt">=</span> ret<span class="hl opt">.</span>e<span class="hl opt">;</span>
                <span class="hl kwa">return</span> NEXT_FILTER<span class="hl opt">;</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> item <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp; !</span>itemIsErrorType<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> shouldHandle <span class="hl opt">=</span> <span class="hl kwd">safePredicate</span><span class="hl opt">(</span>item<span class="hl opt">,</span> e<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>shouldHandle <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
                e <span class="hl opt">=</span> errorObj<span class="hl opt">.</span>e<span class="hl opt">;</span>
                <span class="hl kwa">break</span><span class="hl opt">;</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>shouldHandle<span class="hl opt">) {</span>
                <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>cb<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>boundTo<span class="hl opt">,</span> e<span class="hl opt">);</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
                    NEXT_FILTER<span class="hl opt">.</span>e <span class="hl opt">=</span> ret<span class="hl opt">.</span>e<span class="hl opt">;</span>
                    <span class="hl kwa">return</span> NEXT_FILTER<span class="hl opt">;</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    NEXT_FILTER<span class="hl opt">.</span>e <span class="hl opt">=</span> e<span class="hl opt">;</span>
    <span class="hl kwa">return</span> NEXT_FILTER<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">return</span> CatchFilter<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">9</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> CapturedTrace<span class="hl opt">,</span> isDebugging<span class="hl opt">) {</span>
<span class="hl kwa">var</span> contextStack <span class="hl opt">= [];</span>
<span class="hl kwa">function</span> <span class="hl kwd">Context</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_trace <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CapturedTrace</span><span class="hl opt">(</span><span class="hl kwd">peekContext</span><span class="hl opt">());</span>
<span class="hl opt">}</span>
Context<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_pushContext</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isDebugging</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trace <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        contextStack<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trace<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Context<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_popContext</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isDebugging</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_trace <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        contextStack<span class="hl opt">.</span><span class="hl kwd">pop</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">createContext</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isDebugging</span><span class="hl opt">())</span> <span class="hl kwa">return new</span> <span class="hl kwd">Context</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">peekContext</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> lastIndex <span class="hl opt">=</span> contextStack<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>lastIndex <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> contextStack<span class="hl opt">[</span>lastIndex<span class="hl opt">];</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> undefined<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_peekContext <span class="hl opt">=</span> peekContext<span class="hl opt">;</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_pushContext <span class="hl opt">=</span> Context<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_pushContext<span class="hl opt">;</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_popContext <span class="hl opt">=</span> Context<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_popContext<span class="hl opt">;</span>

<span class="hl kwa">return</span> createContext<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">10</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> CapturedTrace<span class="hl opt">) {</span>
<span class="hl kwa">var</span> getDomain <span class="hl opt">=</span> Promise<span class="hl opt">.</span>_getDomain<span class="hl opt">;</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Warning <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">).</span>Warning<span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> canAttachTrace <span class="hl opt">=</span> util<span class="hl opt">.</span>canAttachTrace<span class="hl opt">;</span>
<span class="hl kwa">var</span> unhandledRejectionHandled<span class="hl opt">;</span>
<span class="hl kwa">var</span> possiblyUnhandledRejection<span class="hl opt">;</span>
<span class="hl kwa">var</span> debugging <span class="hl opt">=</span> <span class="hl kwa">false</span> <span class="hl opt">|| (</span>util<span class="hl opt">.</span>isNode <span class="hl opt">&amp;&amp;</span>
                    <span class="hl opt">(!!</span>process<span class="hl opt">.</span>env<span class="hl opt">[</span><span class="hl str">&quot;BLUEBIRD_DEBUG&quot;</span><span class="hl opt">] ||</span>
                     process<span class="hl opt">.</span>env<span class="hl opt">[</span><span class="hl str">&quot;NODE_ENV&quot;</span><span class="hl opt">] ===</span> <span class="hl str">&quot;development&quot;</span><span class="hl opt">));</span>

<span class="hl kwa">if</span> <span class="hl opt">(</span>debugging<span class="hl opt">) {</span>
    async<span class="hl opt">.</span><span class="hl kwd">disableTrampolineIfNecessary</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_ignoreRejections</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetRejectionIsUnhandled</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">16777216</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_ensurePossibleRejectionHandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">16777216</span><span class="hl opt">) !==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setRejectionIsUnhandled</span><span class="hl opt">();</span>
    async<span class="hl opt">.</span><span class="hl kwd">invokeLater</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_notifyUnhandledRejection<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_notifyUnhandledRejectionIsHandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    CapturedTrace<span class="hl opt">.</span><span class="hl kwd">fireRejectionEvent</span><span class="hl opt">(</span><span class="hl str">&quot;rejectionHandled&quot;</span><span class="hl opt">,</span>
                                  unhandledRejectionHandled<span class="hl opt">,</span> undefined<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_notifyUnhandledRejection</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isRejectionUnhandled</span><span class="hl opt">()) {</span>
        <span class="hl kwa">var</span> reason <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getCarriedStackTrace</span><span class="hl opt">() ||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setUnhandledRejectionIsNotified</span><span class="hl opt">();</span>
        CapturedTrace<span class="hl opt">.</span><span class="hl kwd">fireRejectionEvent</span><span class="hl opt">(</span><span class="hl str">&quot;unhandledRejection&quot;</span><span class="hl opt">,</span>
                                      possiblyUnhandledRejection<span class="hl opt">,</span> reason<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setUnhandledRejectionIsNotified</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">524288</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetUnhandledRejectionIsNotified</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">524288</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isUnhandledRejectionNotified</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">524288</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setRejectionIsUnhandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">2097152</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetRejectionIsUnhandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">2097152</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isUnhandledRejectionNotified</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetUnhandledRejectionIsNotified</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_notifyUnhandledRejectionIsHandled</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isRejectionUnhandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">2097152</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setCarriedStackTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>capturedTrace<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">1048576</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0 <span class="hl opt">=</span> capturedTrace<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isCarryingStackTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">1048576</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_getCarriedStackTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_isCarryingStackTrace</span><span class="hl opt">()</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0
        <span class="hl opt">:</span> undefined<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>debugging<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_trace <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CapturedTrace</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_peekContext</span><span class="hl opt">());</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>error<span class="hl opt">,</span> ignoreSelf<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>debugging <span class="hl opt">&amp;&amp;</span> <span class="hl kwd">canAttachTrace</span><span class="hl opt">(</span>error<span class="hl opt">)) {</span>
        <span class="hl kwa">var</span> trace <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_trace<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>trace <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>ignoreSelf<span class="hl opt">)</span> trace <span class="hl opt">=</span> trace<span class="hl opt">.</span>_parent<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>trace <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
            trace<span class="hl opt">.</span><span class="hl kwd">attachExtraTrace</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span>error<span class="hl opt">.</span>__stackCleaned__<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> parsed <span class="hl opt">=</span> CapturedTrace<span class="hl opt">.</span><span class="hl kwd">parseStackAndMessage</span><span class="hl opt">(</span>error<span class="hl opt">);</span>
            util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>error<span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">,</span>
                parsed<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">+</span> parsed<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">));</span>
            util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>error<span class="hl opt">,</span> <span class="hl str">&quot;__stackCleaned__&quot;</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_warn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>message<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> warning <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Warning</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ctx <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_peekContext</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ctx<span class="hl opt">) {</span>
        ctx<span class="hl opt">.</span><span class="hl kwd">attachExtraTrace</span><span class="hl opt">(</span>warning<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> parsed <span class="hl opt">=</span> CapturedTrace<span class="hl opt">.</span><span class="hl kwd">parseStackAndMessage</span><span class="hl opt">(</span>warning<span class="hl opt">);</span>
        warning<span class="hl opt">.</span>stack <span class="hl opt">=</span> parsed<span class="hl opt">.</span>message <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">+</span> parsed<span class="hl opt">.</span>stack<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    CapturedTrace<span class="hl opt">.</span><span class="hl kwd">formatAndLogError</span><span class="hl opt">(</span>warning<span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">onPossiblyUnhandledRejection</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> domain <span class="hl opt">=</span> <span class="hl kwd">getDomain</span><span class="hl opt">();</span>
    possiblyUnhandledRejection <span class="hl opt">=</span>
        <span class="hl kwa">typeof</span> fn <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">? (</span>domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fn <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fn<span class="hl opt">))</span>
                                 <span class="hl opt">:</span> undefined<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">onUnhandledRejectionHandled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> domain <span class="hl opt">=</span> <span class="hl kwd">getDomain</span><span class="hl opt">();</span>
    unhandledRejectionHandled <span class="hl opt">=</span>
        <span class="hl kwa">typeof</span> fn <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">? (</span>domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fn <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fn<span class="hl opt">))</span>
                                 <span class="hl opt">:</span> undefined<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">longStackTraces</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>async<span class="hl opt">.</span><span class="hl kwd">haveItemsQueued</span><span class="hl opt">() &amp;&amp;</span>
        debugging <span class="hl opt">===</span> <span class="hl kwa">false</span>
   <span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">&quot;cannot enable long stack traces after promises have been created</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/DT1qyG</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    debugging <span class="hl opt">=</span> CapturedTrace<span class="hl opt">.</span><span class="hl kwd">isSupported</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>debugging<span class="hl opt">) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">disableTrampolineIfNecessary</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">hasLongStackTraces</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> debugging <span class="hl opt">&amp;&amp;</span> CapturedTrace<span class="hl opt">.</span><span class="hl kwd">isSupported</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

<span class="hl kwa">if</span> <span class="hl opt">(!</span>CapturedTrace<span class="hl opt">.</span><span class="hl kwd">isSupported</span><span class="hl opt">()) {</span>
    Promise<span class="hl opt">.</span><span class="hl kwd">longStackTraces</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(){};</span>
    debugging <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">return function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return</span> debugging<span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">11</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> isPrimitive <span class="hl opt">=</span> util<span class="hl opt">.</span>isPrimitive<span class="hl opt">;</span>

module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> <span class="hl kwd">returner</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl kwa">var</span> <span class="hl kwd">thrower</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">throw this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl kwa">var</span> <span class="hl kwd">returnUndefined</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {};</span>
<span class="hl kwa">var</span> <span class="hl kwd">throwUndefined</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">throw</span> undefined<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">wrapper</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> action<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>action <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">return function</span> <span class="hl opt">() {</span>
            <span class="hl kwa">throw</span> value<span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>action <span class="hl opt">===</span> <span class="hl num">2</span><span class="hl opt">) {</span>
        <span class="hl kwa">return function</span> <span class="hl opt">() {</span>
            <span class="hl kwa">return</span> value<span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>


Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span><span class="hl str">&quot;return&quot;</span><span class="hl opt">] =</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">thenReturn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>value <span class="hl opt">===</span> undefined<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">(</span>returnUndefined<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>value<span class="hl opt">)) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            <span class="hl kwd">wrapper</span><span class="hl opt">(</span>value<span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">),</span>
            undefined<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            undefined
       <span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>returner<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> value<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span><span class="hl str">&quot;throw&quot;</span><span class="hl opt">] =</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">thenThrow</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>reason <span class="hl opt">===</span> undefined<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">(</span>throwUndefined<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>reason<span class="hl opt">)) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            <span class="hl kwd">wrapper</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">),</span>
            undefined<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            undefined
       <span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>thrower<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> reason<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">12</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> PromiseReduce <span class="hl opt">=</span> Promise<span class="hl opt">.</span>reduce<span class="hl opt">;</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">each</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">PromiseReduce</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">each</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">PromiseReduce</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">13</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> es5 <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> Objectfreeze <span class="hl opt">=</span> es5<span class="hl opt">.</span>freeze<span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> inherits <span class="hl opt">=</span> util<span class="hl opt">.</span>inherits<span class="hl opt">;</span>
<span class="hl kwa">var</span> notEnumerableProp <span class="hl opt">=</span> util<span class="hl opt">.</span>notEnumerableProp<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">subError</span><span class="hl opt">(</span>nameProperty<span class="hl opt">,</span> defaultMessage<span class="hl opt">) {</span>
    <span class="hl kwa">function</span> <span class="hl kwd">SubError</span><span class="hl opt">(</span>message<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this instanceof</span> SubError<span class="hl opt">))</span> <span class="hl kwa">return new</span> <span class="hl kwd">SubError</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
        <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;message&quot;</span><span class="hl opt">,</span>
            <span class="hl kwa">typeof</span> message <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">?</span> message <span class="hl opt">:</span> defaultMessage<span class="hl opt">);</span>
        <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;name&quot;</span><span class="hl opt">,</span> nameProperty<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>Error<span class="hl opt">.</span>captureStackTrace<span class="hl opt">) {</span>
            Error<span class="hl opt">.</span><span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            Error<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">inherits</span><span class="hl opt">(</span>SubError<span class="hl opt">,</span> Error<span class="hl opt">);</span>
    <span class="hl kwa">return</span> SubError<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> _TypeError<span class="hl opt">,</span> _RangeError<span class="hl opt">;</span>
<span class="hl kwa">var</span> Warning <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;Warning&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;warning&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> CancellationError <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;CancellationError&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;cancellation error&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> TimeoutError <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;TimeoutError&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;timeout error&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> AggregateError <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;AggregateError&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;aggregate error&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">try</span> <span class="hl opt">{</span>
    _TypeError <span class="hl opt">=</span> TypeError<span class="hl opt">;</span>
    _RangeError <span class="hl opt">=</span> RangeError<span class="hl opt">;</span>
<span class="hl opt">}</span> <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
    _TypeError <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;TypeError&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;type error&quot;</span><span class="hl opt">);</span>
    _RangeError <span class="hl opt">=</span> <span class="hl kwd">subError</span><span class="hl opt">(</span><span class="hl str">&quot;RangeError&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;range error&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> methods <span class="hl opt">= (</span><span class="hl str">&quot;join pop push shift unshift slice filter forEach some &quot;</span> <span class="hl opt">+</span>
    <span class="hl str">&quot;every map indexOf lastIndexOf reduce reduceRight sort reverse&quot;</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">);</span>

<span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> methods<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>methods<span class="hl opt">[</span>i<span class="hl opt">]] ===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        AggregateError<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>methods<span class="hl opt">[</span>i<span class="hl opt">]] =</span> Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>methods<span class="hl opt">[</span>i<span class="hl opt">]];</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>AggregateError<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span> <span class="hl str">&quot;length&quot;</span><span class="hl opt">, {</span>
    value<span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
    configurable<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
    writable<span class="hl opt">:</span> <span class="hl kwa">true</span><span class="hl opt">,</span>
    enumerable<span class="hl opt">:</span> <span class="hl kwa">true</span>
<span class="hl opt">});</span>
AggregateError<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span><span class="hl str">&quot;isOperational&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> level <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
AggregateError<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">toString</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> indent <span class="hl opt">=</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>level <span class="hl opt">*</span> <span class="hl num">4</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">+</span> indent <span class="hl opt">+</span> <span class="hl str">&quot;AggregateError of:&quot;</span> <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">;</span>
    level<span class="hl opt">++;</span>
    indent <span class="hl opt">=</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>level <span class="hl opt">*</span> <span class="hl num">4</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> str <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">[</span>i<span class="hl opt">] ===</span> <span class="hl kwa">this</span> <span class="hl opt">?</span> <span class="hl str">&quot;[Circular AggregateError]&quot;</span> <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[</span>i<span class="hl opt">] +</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> lines <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> lines<span class="hl opt">.</span>length<span class="hl opt">; ++</span>j<span class="hl opt">) {</span>
            lines<span class="hl opt">[</span>j<span class="hl opt">] =</span> indent <span class="hl opt">+</span> lines<span class="hl opt">[</span>j<span class="hl opt">];</span>
        <span class="hl opt">}</span>
        str <span class="hl opt">=</span> lines<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        ret <span class="hl opt">+=</span> str <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    level<span class="hl opt">--;</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">OperationalError</span><span class="hl opt">(</span>message<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this instanceof</span> OperationalError<span class="hl opt">))</span>
        <span class="hl kwa">return new</span> <span class="hl kwd">OperationalError</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;name&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;OperationalError&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;message&quot;</span><span class="hl opt">,</span> message<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>cause <span class="hl opt">=</span> message<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">[</span><span class="hl str">&quot;isOperational&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">true</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>message <span class="hl kwa">instanceof</span> Error<span class="hl opt">) {</span>
        <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;message&quot;</span><span class="hl opt">,</span> message<span class="hl opt">.</span>message<span class="hl opt">);</span>
        <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">,</span> message<span class="hl opt">.</span>stack<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>Error<span class="hl opt">.</span>captureStackTrace<span class="hl opt">) {</span>
        Error<span class="hl opt">.</span><span class="hl kwd">captureStackTrace</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">);</span>
    <span class="hl opt">}</span>

<span class="hl opt">}</span>
<span class="hl kwd">inherits</span><span class="hl opt">(</span>OperationalError<span class="hl opt">,</span> Error<span class="hl opt">);</span>

<span class="hl kwa">var</span> errorTypes <span class="hl opt">=</span> Error<span class="hl opt">[</span><span class="hl str">&quot;__BluebirdErrorTypes__&quot;</span><span class="hl opt">];</span>
<span class="hl kwa">if</span> <span class="hl opt">(!</span>errorTypes<span class="hl opt">) {</span>
    errorTypes <span class="hl opt">=</span> <span class="hl kwd">Objectfreeze</span><span class="hl opt">({</span>
        CancellationError<span class="hl opt">:</span> CancellationError<span class="hl opt">,</span>
        TimeoutError<span class="hl opt">:</span> TimeoutError<span class="hl opt">,</span>
        OperationalError<span class="hl opt">:</span> OperationalError<span class="hl opt">,</span>
        RejectionError<span class="hl opt">:</span> OperationalError<span class="hl opt">,</span>
        AggregateError<span class="hl opt">:</span> AggregateError
    <span class="hl opt">});</span>
    <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>Error<span class="hl opt">,</span> <span class="hl str">&quot;__BluebirdErrorTypes__&quot;</span><span class="hl opt">,</span> errorTypes<span class="hl opt">);</span>
<span class="hl opt">}</span>

module<span class="hl opt">.</span>exports <span class="hl opt">= {</span>
    Error<span class="hl opt">:</span> Error<span class="hl opt">,</span>
    TypeError<span class="hl opt">:</span> _TypeError<span class="hl opt">,</span>
    RangeError<span class="hl opt">:</span> _RangeError<span class="hl opt">,</span>
    CancellationError<span class="hl opt">:</span> errorTypes<span class="hl opt">.</span>CancellationError<span class="hl opt">,</span>
    OperationalError<span class="hl opt">:</span> errorTypes<span class="hl opt">.</span>OperationalError<span class="hl opt">,</span>
    TimeoutError<span class="hl opt">:</span> errorTypes<span class="hl opt">.</span>TimeoutError<span class="hl opt">,</span>
    AggregateError<span class="hl opt">:</span> errorTypes<span class="hl opt">.</span>AggregateError<span class="hl opt">,</span>
    Warning<span class="hl opt">:</span> Warning
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">14</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl kwa">var</span> isES5 <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">(){</span>
    <span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
    <span class="hl kwa">return this</span> <span class="hl opt">===</span> undefined<span class="hl opt">;</span>
<span class="hl opt">})();</span>

<span class="hl kwa">if</span> <span class="hl opt">(</span>isES5<span class="hl opt">) {</span>
    module<span class="hl opt">.</span>exports <span class="hl opt">= {</span>
        freeze<span class="hl opt">:</span> Object<span class="hl opt">.</span>freeze<span class="hl opt">,</span>
        defineProperty<span class="hl opt">:</span> Object<span class="hl opt">.</span>defineProperty<span class="hl opt">,</span>
        getDescriptor<span class="hl opt">:</span> Object<span class="hl opt">.</span>getOwnPropertyDescriptor<span class="hl opt">,</span>
        keys<span class="hl opt">:</span> Object<span class="hl opt">.</span>keys<span class="hl opt">,</span>
        names<span class="hl opt">:</span> Object<span class="hl opt">.</span>getOwnPropertyNames<span class="hl opt">,</span>
        getPrototypeOf<span class="hl opt">:</span> Object<span class="hl opt">.</span>getPrototypeOf<span class="hl opt">,</span>
        isArray<span class="hl opt">:</span> Array<span class="hl opt">.</span>isArray<span class="hl opt">,</span>
        isES5<span class="hl opt">:</span> isES5<span class="hl opt">,</span>
        <span class="hl kwd">propertyIsWritable</span><span class="hl opt">:</span> <span class="hl kwa">function</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> prop<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> descriptor <span class="hl opt">=</span> Object<span class="hl opt">.</span><span class="hl kwd">getOwnPropertyDescriptor</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> prop<span class="hl opt">);</span>
            <span class="hl kwa">return</span> <span class="hl opt">!!(!</span>descriptor <span class="hl opt">||</span> descriptor<span class="hl opt">.</span>writable <span class="hl opt">||</span> descriptor<span class="hl opt">.</span><span class="hl kwa">set</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwa">var</span> has <span class="hl opt">= {}.</span>hasOwnProperty<span class="hl opt">;</span>
    <span class="hl kwa">var</span> str <span class="hl opt">= {}.</span>toString<span class="hl opt">;</span>
    <span class="hl kwa">var</span> proto <span class="hl opt">= {}.</span>constructor<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ObjectKeys</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>o<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">= [];</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> key <span class="hl kwa">in</span> o<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>has<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>o<span class="hl opt">,</span> key<span class="hl opt">)) {</span>
                ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ObjectGetDescriptor</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>o<span class="hl opt">,</span> key<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">{</span>value<span class="hl opt">:</span> o<span class="hl opt">[</span>key<span class="hl opt">]};</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ObjectDefineProperty</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>o<span class="hl opt">,</span> key<span class="hl opt">,</span> desc<span class="hl opt">) {</span>
        o<span class="hl opt">[</span>key<span class="hl opt">] =</span> desc<span class="hl opt">.</span>value<span class="hl opt">;</span>
        <span class="hl kwa">return</span> o<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ObjectFreeze</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>obj<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ObjectGetPrototypeOf</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>obj<span class="hl opt">) {</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
            <span class="hl kwa">return</span> <span class="hl kwd">Object</span><span class="hl opt">(</span>obj<span class="hl opt">).</span>constructor<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> proto<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">ArrayIsArray</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>obj<span class="hl opt">) {</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
            <span class="hl kwa">return</span> str<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>obj<span class="hl opt">) ===</span> <span class="hl str">&quot;[object Array]&quot;</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
            <span class="hl kwa">return false</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    module<span class="hl opt">.</span>exports <span class="hl opt">= {</span>
        isArray<span class="hl opt">:</span> ArrayIsArray<span class="hl opt">,</span>
        keys<span class="hl opt">:</span> ObjectKeys<span class="hl opt">,</span>
        names<span class="hl opt">:</span> ObjectKeys<span class="hl opt">,</span>
        defineProperty<span class="hl opt">:</span> ObjectDefineProperty<span class="hl opt">,</span>
        getDescriptor<span class="hl opt">:</span> ObjectGetDescriptor<span class="hl opt">,</span>
        freeze<span class="hl opt">:</span> ObjectFreeze<span class="hl opt">,</span>
        getPrototypeOf<span class="hl opt">:</span> ObjectGetPrototypeOf<span class="hl opt">,</span>
        isES5<span class="hl opt">:</span> isES5<span class="hl opt">,</span>
        <span class="hl kwd">propertyIsWritable</span><span class="hl opt">:</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
            <span class="hl kwa">return true</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>

<span class="hl opt">},{}],</span><span class="hl num">15</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> PromiseMap <span class="hl opt">=</span> Promise<span class="hl opt">.</span>map<span class="hl opt">;</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">filter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">PromiseMap</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">filter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">PromiseMap</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">16</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> NEXT_FILTER<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> isPrimitive <span class="hl opt">=</span> util<span class="hl opt">.</span>isPrimitive<span class="hl opt">;</span>
<span class="hl kwa">var</span> thrower <span class="hl opt">=</span> util<span class="hl opt">.</span>thrower<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">returnThis</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">throwThis</span><span class="hl opt">() {</span>
    <span class="hl kwa">throw this</span><span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwa">function return</span><span class="hl opt">$(</span>r<span class="hl opt">) {</span>
    <span class="hl kwa">return function</span><span class="hl opt">() {</span>
        <span class="hl kwa">return</span> r<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
<span class="hl kwa">function throw</span><span class="hl opt">$(</span>r<span class="hl opt">) {</span>
    <span class="hl kwa">return function</span><span class="hl opt">() {</span>
        <span class="hl kwa">throw</span> r<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">promisedFinally</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> reasonOrValue<span class="hl opt">,</span> isFulfilled<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> then<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>reasonOrValue<span class="hl opt">)) {</span>
        then <span class="hl opt">=</span> isFulfilled <span class="hl opt">?</span> <span class="hl kwa">return</span><span class="hl opt">$(</span>reasonOrValue<span class="hl opt">) :</span> <span class="hl kwa">throw</span><span class="hl opt">$(</span>reasonOrValue<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        then <span class="hl opt">=</span> isFulfilled <span class="hl opt">?</span> returnThis <span class="hl opt">:</span> throwThis<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>then<span class="hl opt">,</span> thrower<span class="hl opt">,</span> undefined<span class="hl opt">,</span> reasonOrValue<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">finallyHandler</span><span class="hl opt">(</span>reasonOrValue<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">;</span>
    <span class="hl kwa">var</span> handler <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>handler<span class="hl opt">;</span>

    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_isBound</span><span class="hl opt">()</span>
                    <span class="hl opt">?</span> handler<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">())</span>
                    <span class="hl opt">:</span> <span class="hl kwd">handler</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
            <span class="hl kwa">return</span> <span class="hl kwd">promisedFinally</span><span class="hl opt">(</span>maybePromise<span class="hl opt">,</span> reasonOrValue<span class="hl opt">,</span>
                                    promise<span class="hl opt">.</span><span class="hl kwd">isFulfilled</span><span class="hl opt">());</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">isRejected</span><span class="hl opt">()) {</span>
        NEXT_FILTER<span class="hl opt">.</span>e <span class="hl opt">=</span> reasonOrValue<span class="hl opt">;</span>
        <span class="hl kwa">return</span> NEXT_FILTER<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return</span> reasonOrValue<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">tapHandler</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">;</span>
    <span class="hl kwa">var</span> handler <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>handler<span class="hl opt">;</span>

    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_isBound</span><span class="hl opt">()</span>
                    <span class="hl opt">?</span> handler<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">(),</span> value<span class="hl opt">)</span>
                    <span class="hl opt">:</span> <span class="hl kwd">handler</span><span class="hl opt">(</span>value<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
            <span class="hl kwa">return</span> <span class="hl kwd">promisedFinally</span><span class="hl opt">(</span>maybePromise<span class="hl opt">,</span> value<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> value<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_passThroughHandler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>handler<span class="hl opt">,</span> isFinally<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> handler <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">();</span>

    <span class="hl kwa">var</span> promiseAndHandler <span class="hl opt">= {</span>
        promise<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">,</span>
        handler<span class="hl opt">:</span> handler
    <span class="hl opt">};</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            isFinally <span class="hl opt">?</span> finallyHandler <span class="hl opt">:</span> tapHandler<span class="hl opt">,</span>
            isFinally <span class="hl opt">?</span> finallyHandler <span class="hl opt">:</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span>
            promiseAndHandler<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>lastly <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span><span class="hl str">&quot;finally&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>handler<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_passThroughHandler</span><span class="hl opt">(</span>handler<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">tap</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>handler<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_passThroughHandler</span><span class="hl opt">(</span>handler<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">17</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span>
                          apiRejection<span class="hl opt">,</span>
                          INTERNAL<span class="hl opt">,</span>
                          tryConvertToPromise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> errors <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> TypeError <span class="hl opt">=</span> errors<span class="hl opt">.</span>TypeError<span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> yieldHandlers <span class="hl opt">= [];</span>

<span class="hl kwa">function</span> <span class="hl kwd">promiseFromYieldHandler</span><span class="hl opt">(</span>value<span class="hl opt">,</span> yieldHandlers<span class="hl opt">,</span> traceParent<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> yieldHandlers<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        traceParent<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>yieldHandlers<span class="hl opt">[</span>i<span class="hl opt">])(</span>value<span class="hl opt">);</span>
        traceParent<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>result <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
            traceParent<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span>errorObj<span class="hl opt">.</span>e<span class="hl opt">);</span>
            traceParent<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>result<span class="hl opt">,</span> traceParent<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">)</span> <span class="hl kwa">return</span> maybePromise<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return null</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">PromiseSpawn</span><span class="hl opt">(</span>generatorFunction<span class="hl opt">,</span> receiver<span class="hl opt">,</span> yieldHandler<span class="hl opt">,</span> stack<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_stack <span class="hl opt">=</span> stack<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_generatorFunction <span class="hl opt">=</span> generatorFunction<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver <span class="hl opt">=</span> receiver<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_generator <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_yieldHandlers <span class="hl opt">=</span> <span class="hl kwa">typeof</span> yieldHandler <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span>
        <span class="hl opt">? [</span>yieldHandler<span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>yieldHandlers<span class="hl opt">)</span>
        <span class="hl opt">:</span> yieldHandlers<span class="hl opt">;</span>
<span class="hl opt">}</span>

PromiseSpawn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">promise</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_promise<span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseSpawn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_run</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_generator <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_generatorFunction<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_receiver<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver <span class="hl opt">=</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_generatorFunction <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_next</span><span class="hl opt">(</span>undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseSpawn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_continue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>result<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>result <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>result<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> value <span class="hl opt">=</span> result<span class="hl opt">.</span>value<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>result<span class="hl opt">.</span>done <span class="hl opt">===</span> <span class="hl kwa">true</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>value<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">)) {</span>
            maybePromise <span class="hl opt">=</span>
                <span class="hl kwd">promiseFromYieldHandler</span><span class="hl opt">(</span>maybePromise<span class="hl opt">,</span>
                                        <span class="hl kwa">this</span><span class="hl opt">.</span>_yieldHandlers<span class="hl opt">,</span>
                                        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_throw</span><span class="hl opt">(</span>
                    <span class="hl kwa">new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span>
                        <span class="hl str">&quot;A value %s was yielded that could not be treated as a promise</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/4Y4pDk</span><span class="hl esc">\u000a\u000a</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;%s&quot;</span><span class="hl opt">,</span> value<span class="hl opt">) +</span>
                        <span class="hl str">&quot;From coroutine:</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span> <span class="hl opt">+</span>
                        <span class="hl kwa">this</span><span class="hl opt">.</span>_stack<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">).</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">, -</span><span class="hl num">7</span><span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">)</span>
                    <span class="hl opt">)</span>
                <span class="hl opt">);</span>
                <span class="hl kwa">return</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_next<span class="hl opt">,</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_throw<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            <span class="hl kwa">this</span><span class="hl opt">,</span>
            <span class="hl kwa">null</span>
       <span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

PromiseSpawn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_throw</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_generator<span class="hl opt">[</span><span class="hl str">&quot;throw&quot;</span><span class="hl opt">])</span>
        <span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_generator<span class="hl opt">,</span> reason<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_continue</span><span class="hl opt">(</span>result<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseSpawn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_next</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_generator<span class="hl opt">.</span>next<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_generator<span class="hl opt">,</span> value<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_continue</span><span class="hl opt">(</span>result<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">coroutine</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>generatorFunction<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> generatorFunction <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;generatorFunction must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/6Vqhm0</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> yieldHandler <span class="hl opt">=</span> <span class="hl kwd">Object</span><span class="hl opt">(</span>options<span class="hl opt">).</span>yieldHandler<span class="hl opt">;</span>
    <span class="hl kwa">var</span> PromiseSpawn<span class="hl opt">$ =</span> PromiseSpawn<span class="hl opt">;</span>
    <span class="hl kwa">var</span> stack <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">().</span>stack<span class="hl opt">;</span>
    <span class="hl kwa">return function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">var</span> generator <span class="hl opt">=</span> generatorFunction<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">);</span>
        <span class="hl kwa">var</span> spawn <span class="hl opt">=</span> <span class="hl kwa">new</span> PromiseSpawn<span class="hl opt">$(</span>undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> yieldHandler<span class="hl opt">,</span>
                                      stack<span class="hl opt">);</span>
        spawn<span class="hl opt">.</span>_generator <span class="hl opt">=</span> generator<span class="hl opt">;</span>
        spawn<span class="hl opt">.</span><span class="hl kwd">_next</span><span class="hl opt">(</span>undefined<span class="hl opt">);</span>
        <span class="hl kwa">return</span> spawn<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    <span class="hl opt">};</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span>coroutine<span class="hl opt">.</span><span class="hl kwd">addYieldHandler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    yieldHandlers<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">spawn</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>generatorFunction<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> generatorFunction <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;generatorFunction must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/6Vqhm0</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> spawn <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseSpawn</span><span class="hl opt">(</span>generatorFunction<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> spawn<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    spawn<span class="hl opt">.</span><span class="hl kwd">_run</span><span class="hl opt">(</span>Promise<span class="hl opt">.</span>spawn<span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">18</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> canEvaluate <span class="hl opt">=</span> util<span class="hl opt">.</span>canEvaluate<span class="hl opt">;</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> reject<span class="hl opt">;</span>

<span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>canEvaluate<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> <span class="hl kwd">thenCallback</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">return new</span> <span class="hl kwd">Function</span><span class="hl opt">(</span><span class="hl str">&quot;value&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;holder&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;</span>                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            'use strict';</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            holder.pIndex = value;</span>                                           <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            holder.checkFulfillment(this);</span>                                   <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            &quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/Index/g</span><span class="hl opt">,</span> i<span class="hl opt">));</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">caller</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>count<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> values <span class="hl opt">= [];</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&lt;=</span> count<span class="hl opt">; ++</span>i<span class="hl opt">)</span> values<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl str">&quot;holder.p&quot;</span> <span class="hl opt">+</span> i<span class="hl opt">);</span>
        <span class="hl kwa">return new</span> <span class="hl kwd">Function</span><span class="hl opt">(</span><span class="hl str">&quot;holder&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;</span>                                      <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            'use strict';</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var callback = holder.fn;</span>                                        <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            return callback(values);</span>                                         <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            &quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/values/g</span><span class="hl opt">,</span> values<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;, &quot;</span><span class="hl opt">)));</span>
    <span class="hl opt">};</span>
    <span class="hl kwa">var</span> thenCallbacks <span class="hl opt">= [];</span>
    <span class="hl kwa">var</span> callers <span class="hl opt">= [</span>undefined<span class="hl opt">];</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&lt;=</span> <span class="hl num">5</span><span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        thenCallbacks<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwd">thenCallback</span><span class="hl opt">(</span>i<span class="hl opt">));</span>
        callers<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwd">caller</span><span class="hl opt">(</span>i<span class="hl opt">));</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> <span class="hl kwd">Holder</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>total<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>p1 <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>p2 <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>p3 <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>p4 <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>p5 <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>fn <span class="hl opt">=</span> fn<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>total <span class="hl opt">=</span> total<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>now <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Holder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>callers <span class="hl opt">=</span> callers<span class="hl opt">;</span>
    Holder<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">checkFulfillment</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> now <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>now<span class="hl opt">;</span>
        now<span class="hl opt">++;</span>
        <span class="hl kwa">var</span> total <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>total<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>now <span class="hl opt">&gt;=</span> total<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> handler <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>callers<span class="hl opt">[</span>total<span class="hl opt">];</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>handler<span class="hl opt">)(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
                promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>ret<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>now <span class="hl opt">=</span> now<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">var</span> <span class="hl kwd">reject</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwd">join</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> last <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>last <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> arguments<span class="hl opt">[</span>last<span class="hl opt">] ===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        fn <span class="hl opt">=</span> arguments<span class="hl opt">[</span>last<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>last <span class="hl opt">&lt;</span> <span class="hl num">6</span> <span class="hl opt">&amp;&amp;</span> canEvaluate<span class="hl opt">) {</span>
                <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
                ret<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
                <span class="hl kwa">var</span> holder <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Holder</span><span class="hl opt">(</span>last<span class="hl opt">,</span> fn<span class="hl opt">);</span>
                <span class="hl kwa">var</span> callbacks <span class="hl opt">=</span> thenCallbacks<span class="hl opt">;</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> last<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
                    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>arguments<span class="hl opt">[</span>i<span class="hl opt">],</span> ret<span class="hl opt">);</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
                        maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
                        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
                            maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>callbacks<span class="hl opt">[</span>i<span class="hl opt">],</span> reject<span class="hl opt">,</span>
                                               undefined<span class="hl opt">,</span> ret<span class="hl opt">,</span> holder<span class="hl opt">);</span>
                        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
                            callbacks<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">call</span><span class="hl opt">(</span>ret<span class="hl opt">,</span>
                                              maybePromise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">(),</span> holder<span class="hl opt">);</span>
                        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                            ret<span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
                        <span class="hl opt">}</span>
                    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                        callbacks<span class="hl opt">[</span>i<span class="hl opt">].</span><span class="hl kwd">call</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> maybePromise<span class="hl opt">,</span> holder<span class="hl opt">);</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> <span class="hl opt">$</span>_len <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length<span class="hl opt">;</span><span class="hl kwa">var</span> args <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">($</span>_len<span class="hl opt">);</span> <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> <span class="hl opt">$</span>_i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; $</span>_i <span class="hl opt">&lt; $</span>_len<span class="hl opt">; ++$</span>_i<span class="hl opt">) {</span>args<span class="hl opt">[$</span>_i<span class="hl opt">] =</span> arguments<span class="hl opt">[$</span>_i<span class="hl opt">];}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>fn<span class="hl opt">)</span> args<span class="hl opt">.</span><span class="hl kwd">pop</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseArray</span><span class="hl opt">(</span>args<span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> fn <span class="hl opt">!==</span> undefined <span class="hl opt">?</span> ret<span class="hl opt">.</span><span class="hl kwd">spread</span><span class="hl opt">(</span>fn<span class="hl opt">) :</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">19</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span>
                          PromiseArray<span class="hl opt">,</span>
                          apiRejection<span class="hl opt">,</span>
                          tryConvertToPromise<span class="hl opt">,</span>
                          INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> getDomain <span class="hl opt">=</span> Promise<span class="hl opt">.</span>_getDomain<span class="hl opt">;</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> PENDING <span class="hl opt">= {};</span>
<span class="hl kwa">var</span> EMPTY_ARRAY <span class="hl opt">= [];</span>

<span class="hl kwa">function</span> <span class="hl kwd">MappingPromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> limit<span class="hl opt">,</span> _filter<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>promises<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> domain <span class="hl opt">=</span> <span class="hl kwd">getDomain</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_callback <span class="hl opt">=</span> domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fn <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_preservedValues <span class="hl opt">=</span> _filter <span class="hl opt">===</span> INTERNAL
        <span class="hl opt">?</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">())</span>
        <span class="hl opt">:</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_limit <span class="hl opt">=</span> limit<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_inFlight <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_queue <span class="hl opt">=</span> limit <span class="hl opt">&gt;=</span> <span class="hl num">1</span> <span class="hl opt">? [] :</span> EMPTY_ARRAY<span class="hl opt">;</span>
    async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span>init<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>MappingPromiseArray<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>
<span class="hl kwa">function</span> <span class="hl kwd">init</span><span class="hl opt">() {</span><span class="hl kwa">this</span><span class="hl opt">.</span>_init<span class="hl opt">$(</span>undefined<span class="hl opt">, -</span><span class="hl num">2</span><span class="hl opt">);}</span>

MappingPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_init</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {};</span>

MappingPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> values <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">;</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> preservedValues <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_preservedValues<span class="hl opt">;</span>
    <span class="hl kwa">var</span> limit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_limit<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>values<span class="hl opt">[</span>index<span class="hl opt">] ===</span> PENDING<span class="hl opt">) {</span>
        values<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>limit <span class="hl opt">&gt;=</span> <span class="hl num">1</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_inFlight<span class="hl opt">--;</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_drainQueue</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>limit <span class="hl opt">&gt;=</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_inFlight <span class="hl opt">&gt;=</span> limit<span class="hl opt">) {</span>
            values<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_queue<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
            <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>preservedValues <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">)</span> preservedValues<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>

        <span class="hl kwa">var</span> callback <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_callback<span class="hl opt">;</span>
        <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>callback<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> value<span class="hl opt">,</span> index<span class="hl opt">,</span> length<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>

        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>limit <span class="hl opt">&gt;=</span> <span class="hl num">1</span><span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_inFlight<span class="hl opt">++;</span>
                values<span class="hl opt">[</span>index<span class="hl opt">] =</span> PENDING<span class="hl opt">;</span>
                <span class="hl kwa">return</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_proxyPromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> index<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
                ret <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">();</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        values<span class="hl opt">[</span>index<span class="hl opt">] =</span> ret<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> totalResolved <span class="hl opt">= ++</span><span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>totalResolved <span class="hl opt">&gt;=</span> length<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>preservedValues <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_filter</span><span class="hl opt">(</span>values<span class="hl opt">,</span> preservedValues<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span>values<span class="hl opt">);</span>
        <span class="hl opt">}</span>

    <span class="hl opt">}</span>
<span class="hl opt">};</span>

MappingPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_drainQueue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> queue <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_queue<span class="hl opt">;</span>
    <span class="hl kwa">var</span> limit <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_limit<span class="hl opt">;</span>
    <span class="hl kwa">var</span> values <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>queue<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_inFlight <span class="hl opt">&lt;</span> limit<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> index <span class="hl opt">=</span> queue<span class="hl opt">.</span><span class="hl kwd">pop</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span><span class="hl opt">(</span>values<span class="hl opt">[</span>index<span class="hl opt">],</span> index<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

MappingPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_filter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>booleans<span class="hl opt">,</span> values<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> values<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len<span class="hl opt">);</span>
    <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>booleans<span class="hl opt">[</span>i<span class="hl opt">])</span> ret<span class="hl opt">[</span>j<span class="hl opt">++] =</span> values<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>
    ret<span class="hl opt">.</span>length <span class="hl opt">=</span> j<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span>ret<span class="hl opt">);</span>
<span class="hl opt">};</span>

MappingPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">preservedValues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_preservedValues<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">map</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> _filter<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> limit <span class="hl opt">=</span> <span class="hl kwa">typeof</span> options <span class="hl opt">===</span> <span class="hl str">&quot;object&quot;</span> <span class="hl opt">&amp;&amp;</span> options <span class="hl opt">!==</span> <span class="hl kwa">null</span>
        <span class="hl opt">?</span> options<span class="hl opt">.</span>concurrency
        <span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">;</span>
    limit <span class="hl opt">=</span> <span class="hl kwa">typeof</span> limit <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span> <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwd">isFinite</span><span class="hl opt">(</span>limit<span class="hl opt">) &amp;&amp;</span> limit <span class="hl opt">&gt;=</span> <span class="hl num">1</span> <span class="hl opt">?</span> limit <span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">MappingPromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> limit<span class="hl opt">,</span> _filter<span class="hl opt">);</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">map</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>

    <span class="hl kwa">return</span> <span class="hl kwd">map</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">map</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> _filter<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl kwd">map</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> options<span class="hl opt">,</span> _filter<span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>


<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">20</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>

Promise<span class="hl opt">.</span><span class="hl kwd">method</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> Promise<span class="hl opt">.</span><span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> value <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>fn<span class="hl opt">).</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">);</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_resolveFromSyncValue</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span>attempt <span class="hl opt">=</span> Promise<span class="hl opt">[</span><span class="hl str">&quot;try&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> args<span class="hl opt">,</span> ctx<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> value <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>args<span class="hl opt">)</span>
        <span class="hl opt">?</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>fn<span class="hl opt">).</span><span class="hl kwd">apply</span><span class="hl opt">(</span>ctx<span class="hl opt">,</span> args<span class="hl opt">)</span>
        <span class="hl opt">:</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>fn<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>ctx<span class="hl opt">,</span> args<span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_resolveFromSyncValue</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolveFromSyncValue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>value <span class="hl opt">===</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>value<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">21</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">spreadAdapter</span><span class="hl opt">(</span>val<span class="hl opt">,</span> nodeback<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>util<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>val<span class="hl opt">))</span> <span class="hl kwa">return</span> successAdapter<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>promise<span class="hl opt">,</span> val<span class="hl opt">,</span> nodeback<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span>
        <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>nodeback<span class="hl opt">).</span><span class="hl kwd">apply</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">(), [</span><span class="hl kwa">null</span><span class="hl opt">].</span><span class="hl kwd">concat</span><span class="hl opt">(</span>val<span class="hl opt">));</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">successAdapter</span><span class="hl opt">(</span>val<span class="hl opt">,</span> nodeback<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> val <span class="hl opt">===</span> undefined
        <span class="hl opt">?</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>nodeback<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
        <span class="hl opt">:</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>nodeback<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> val<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">errorAdapter</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> nodeback<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>reason<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> target <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> newReason <span class="hl opt">=</span> target<span class="hl opt">.</span><span class="hl kwd">_getCarriedStackTrace</span><span class="hl opt">();</span>
        newReason<span class="hl opt">.</span>cause <span class="hl opt">=</span> reason<span class="hl opt">;</span>
        reason <span class="hl opt">=</span> newReason<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>nodeback<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">(),</span> reason<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>asCallback <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">nodeify</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>nodeback<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> nodeback <span class="hl opt">==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> adapter <span class="hl opt">=</span> successAdapter<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span> <span class="hl kwd">Object</span><span class="hl opt">(</span>options<span class="hl opt">).</span>spread<span class="hl opt">) {</span>
            adapter <span class="hl opt">=</span> spreadAdapter<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            adapter<span class="hl opt">,</span>
            errorAdapter<span class="hl opt">,</span>
            undefined<span class="hl opt">,</span>
            <span class="hl kwa">this</span><span class="hl opt">,</span>
            nodeback
        <span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">22</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">progressed</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>handler<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> handler<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_progress</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>progressValue<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFollowingOrFulfilledOrRejected</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_progressUnchecked</span><span class="hl opt">(</span>progressValue<span class="hl opt">);</span>

<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_progressHandlerAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> index <span class="hl opt">===</span> <span class="hl num">0</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_progressHandler0
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[(</span>index <span class="hl opt">&lt;&lt;</span> <span class="hl num">2</span><span class="hl opt">) +</span> index <span class="hl opt">-</span> <span class="hl num">5</span> <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_doProgressWith</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>progression<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> progressValue <span class="hl opt">=</span> progression<span class="hl opt">.</span>value<span class="hl opt">;</span>
    <span class="hl kwa">var</span> handler <span class="hl opt">=</span> progression<span class="hl opt">.</span>handler<span class="hl opt">;</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> progression<span class="hl opt">.</span>promise<span class="hl opt">;</span>
    <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> progression<span class="hl opt">.</span>receiver<span class="hl opt">;</span>

    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>handler<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> progressValue<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret<span class="hl opt">.</span>e <span class="hl opt">!=</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span>
            ret<span class="hl opt">.</span>e<span class="hl opt">.</span>name <span class="hl opt">!==</span> <span class="hl str">&quot;StopProgressPropagation&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">var</span> trace <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">canAttachTrace</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">)</span>
                <span class="hl opt">?</span> ret<span class="hl opt">.</span>e <span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span>util<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">));</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>trace<span class="hl opt">);</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>ret <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>promise<span class="hl opt">.</span>_progress<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> promise<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">(</span>ret<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>


Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_progressUnchecked</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>progressValue<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> progress <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_progress<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">var</span> handler <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_progressHandlerAt</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
        <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseAt</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!(</span>promise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">)) {</span>
            <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_receiverAt</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> handler <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
                handler<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> progressValue<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>receiver <span class="hl kwa">instanceof</span> PromiseArray <span class="hl opt">&amp;&amp;</span>
                       <span class="hl opt">!</span>receiver<span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">()) {</span>
                receiver<span class="hl opt">.</span><span class="hl kwd">_promiseProgressed</span><span class="hl opt">(</span>progressValue<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">continue</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> handler <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_doProgressWith<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">, {</span>
                handler<span class="hl opt">:</span> handler<span class="hl opt">,</span>
                promise<span class="hl opt">:</span> promise<span class="hl opt">,</span>
                receiver<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_receiverAt</span><span class="hl opt">(</span>i<span class="hl opt">),</span>
                value<span class="hl opt">:</span> progressValue
            <span class="hl opt">});</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span>progress<span class="hl opt">,</span> promise<span class="hl opt">,</span> progressValue<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">23</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
<span class="hl kwa">var</span> <span class="hl kwd">makeSelfResolutionError</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;circular promise resolution chain</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/LhFpo0</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl kwa">var</span> <span class="hl kwd">reflect</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return new</span> Promise<span class="hl opt">.</span><span class="hl kwd">PromiseInspection</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">());</span>
<span class="hl opt">};</span>
<span class="hl kwa">var</span> <span class="hl kwd">apiRejection</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>msg<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> Promise<span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span>msg<span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> getDomain<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>util<span class="hl opt">.</span>isNode<span class="hl opt">) {</span>
    <span class="hl kwd">getDomain</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> process<span class="hl opt">.</span>domain<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> undefined<span class="hl opt">)</span> ret <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwd">getDomain</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
        <span class="hl kwa">return null</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> <span class="hl str">&quot;_getDomain&quot;</span><span class="hl opt">,</span> getDomain<span class="hl opt">);</span>

<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> errors <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> TypeError <span class="hl opt">=</span> Promise<span class="hl opt">.</span>TypeError <span class="hl opt">=</span> errors<span class="hl opt">.</span>TypeError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>RangeError <span class="hl opt">=</span> errors<span class="hl opt">.</span>RangeError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>CancellationError <span class="hl opt">=</span> errors<span class="hl opt">.</span>CancellationError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>TimeoutError <span class="hl opt">=</span> errors<span class="hl opt">.</span>TimeoutError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>OperationalError <span class="hl opt">=</span> errors<span class="hl opt">.</span>OperationalError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>RejectionError <span class="hl opt">=</span> errors<span class="hl opt">.</span>OperationalError<span class="hl opt">;</span>
Promise<span class="hl opt">.</span>AggregateError <span class="hl opt">=</span> errors<span class="hl opt">.</span>AggregateError<span class="hl opt">;</span>
<span class="hl kwa">var</span> <span class="hl kwd">INTERNAL</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(){};</span>
<span class="hl kwa">var</span> APPLY <span class="hl opt">= {};</span>
<span class="hl kwa">var</span> NEXT_FILTER <span class="hl opt">= {</span>e<span class="hl opt">:</span> <span class="hl kwa">null</span><span class="hl opt">};</span>
<span class="hl kwa">var</span> tryConvertToPromise <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./thenables.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwa">var</span> PromiseArray <span class="hl opt">=</span>
    <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./promise_array.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span>
                                    tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">);</span>
<span class="hl kwa">var</span> CapturedTrace <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./captured_trace.js&quot;</span><span class="hl opt">)();</span>
<span class="hl kwa">var</span> isDebugging <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./debuggability.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> CapturedTrace<span class="hl opt">);</span>
 <span class="hl com">/*jshint unused:false*/</span>
<span class="hl kwa">var</span> createContext <span class="hl opt">=</span>
    <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./context.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> CapturedTrace<span class="hl opt">,</span> isDebugging<span class="hl opt">);</span>
<span class="hl kwa">var</span> CatchFilter <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./catch_filter.js&quot;</span><span class="hl opt">)(</span>NEXT_FILTER<span class="hl opt">);</span>
<span class="hl kwa">var</span> PromiseResolver <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./promise_resolver.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> nodebackForPromise <span class="hl opt">=</span> PromiseResolver<span class="hl opt">.</span>_nodebackForPromise<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>resolver<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> resolver <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;the promise constructor requires a resolver function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/EC22Yn</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>constructor <span class="hl opt">!==</span> Promise<span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;the promise constructor cannot be invoked directly</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/KsIlge</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_rejectionHandler0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_progressHandler0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>resolver <span class="hl opt">!==</span> INTERNAL<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolveFromResolver</span><span class="hl opt">(</span>resolver<span class="hl opt">);</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">toString</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl str">&quot;[object Promise]&quot;</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>caught <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span><span class="hl str">&quot;catch&quot;</span><span class="hl opt">] =</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>len <span class="hl opt">&gt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> catchInstances <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">),</span>
            j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> i<span class="hl opt">;</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> item <span class="hl opt">=</span> arguments<span class="hl opt">[</span>i<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> item <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
                catchInstances<span class="hl opt">[</span>j<span class="hl opt">++] =</span> item<span class="hl opt">;</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">return</span> Promise<span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span>
                    <span class="hl kwa">new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Catch filter must inherit from Error or be a simple predicate function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/o84o68</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">));</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        catchInstances<span class="hl opt">.</span>length <span class="hl opt">=</span> j<span class="hl opt">;</span>
        fn <span class="hl opt">=</span> arguments<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> catchFilter <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CatchFilter</span><span class="hl opt">(</span>catchInstances<span class="hl opt">,</span> fn<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>undefined<span class="hl opt">,</span> catchFilter<span class="hl opt">.</span>doFilter<span class="hl opt">,</span> undefined<span class="hl opt">,</span>
            catchFilter<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>undefined<span class="hl opt">,</span> fn<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reflect</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>reflect<span class="hl opt">,</span> reflect<span class="hl opt">,</span> undefined<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">then</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isDebugging</span><span class="hl opt">() &amp;&amp;</span> arguments<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwa">typeof</span> didFulfill <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwa">typeof</span> didReject <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> msg <span class="hl opt">=</span> <span class="hl str">&quot;.then() only accepts functions but was passed: &quot;</span> <span class="hl opt">+</span>
                util<span class="hl opt">.</span><span class="hl kwd">classString</span><span class="hl opt">(</span>didFulfill<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>arguments<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
            msg <span class="hl opt">+=</span> <span class="hl str">&quot;, &quot;</span> <span class="hl opt">+</span> util<span class="hl opt">.</span><span class="hl kwd">classString</span><span class="hl opt">(</span>didReject<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_warn</span><span class="hl opt">(</span>msg<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">,</span>
        undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">done</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> didProgress<span class="hl opt">,</span>
        undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_setIsFinal</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">spread</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">all</span><span class="hl opt">().</span><span class="hl kwd">_then</span><span class="hl opt">(</span>didFulfill<span class="hl opt">,</span> didReject<span class="hl opt">,</span> undefined<span class="hl opt">,</span> APPLY<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isCancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isResolved</span><span class="hl opt">() &amp;&amp;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_cancellable</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">toJSON</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">= {</span>
        isFulfilled<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
        isRejected<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
        fulfillmentValue<span class="hl opt">:</span> undefined<span class="hl opt">,</span>
        rejectionReason<span class="hl opt">:</span> undefined
    <span class="hl opt">};</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isFulfilled</span><span class="hl opt">()) {</span>
        ret<span class="hl opt">.</span>fulfillmentValue <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">value</span><span class="hl opt">();</span>
        ret<span class="hl opt">.</span>isFulfilled <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isRejected</span><span class="hl opt">()) {</span>
        ret<span class="hl opt">.</span>rejectionReason <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">reason</span><span class="hl opt">();</span>
        ret<span class="hl opt">.</span>isRejected <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">all</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">PromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">error</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">caught</span><span class="hl opt">(</span>util<span class="hl opt">.</span>originatesFromRejection<span class="hl opt">,</span> fn<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">is</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>val<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> val <span class="hl kwa">instanceof</span> Promise<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">fromNode</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    <span class="hl kwa">var</span> result <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>fn<span class="hl opt">)(</span><span class="hl kwd">nodebackForPromise</span><span class="hl opt">(</span>ret<span class="hl opt">));</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>result <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>result<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">all</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">PromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span>defer <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">pending</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">PromiseResolver</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">cast</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span>ret <span class="hl kwa">instanceof</span> Promise<span class="hl opt">)) {</span>
        <span class="hl kwa">var</span> val <span class="hl opt">=</span> ret<span class="hl opt">;</span>
        ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_fulfillUnchecked</span><span class="hl opt">(</span>val<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span>resolve <span class="hl opt">=</span> Promise<span class="hl opt">.</span>fulfilled <span class="hl opt">=</span> Promise<span class="hl opt">.</span>cast<span class="hl opt">;</span>

Promise<span class="hl opt">.</span>reject <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">rejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">setScheduler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> prev <span class="hl opt">=</span> async<span class="hl opt">.</span>_schedule<span class="hl opt">;</span>
    async<span class="hl opt">.</span>_schedule <span class="hl opt">=</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">return</span> prev<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_then</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>
    didFulfill<span class="hl opt">,</span>
    didReject<span class="hl opt">,</span>
    didProgress<span class="hl opt">,</span>
    receiver<span class="hl opt">,</span>
    internalData
<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> haveInternalData <span class="hl opt">=</span> internalData <span class="hl opt">!==</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> haveInternalData <span class="hl opt">?</span> internalData <span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span>haveInternalData<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl num">4</span> <span class="hl opt">|</span> <span class="hl num">1</span><span class="hl opt">);</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> target <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>target <span class="hl opt">!==</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>receiver <span class="hl opt">===</span> undefined<span class="hl opt">)</span> receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_boundTo<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>haveInternalData<span class="hl opt">)</span> ret<span class="hl opt">.</span><span class="hl kwd">_setIsMigrated</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> callbackIndex <span class="hl opt">=</span> target<span class="hl opt">.</span><span class="hl kwd">_addCallbacks</span><span class="hl opt">(</span>didFulfill<span class="hl opt">,</span>
                                             didReject<span class="hl opt">,</span>
                                             didProgress<span class="hl opt">,</span>
                                             ret<span class="hl opt">,</span>
                                             receiver<span class="hl opt">,</span>
                                             <span class="hl kwd">getDomain</span><span class="hl opt">());</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>target<span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">() &amp;&amp; !</span>target<span class="hl opt">.</span><span class="hl kwd">_isSettlePromisesQueued</span><span class="hl opt">()) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span>
            target<span class="hl opt">.</span>_settlePromiseAtPostResolution<span class="hl opt">,</span> target<span class="hl opt">,</span> callbackIndex<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseAtPostResolution</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isRejectionUnhandled</span><span class="hl opt">())</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetRejectionIsUnhandled</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_length</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">131071</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isFollowingOrFulfilledOrRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">939524096</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isFollowing</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">536870912</span><span class="hl opt">) ===</span> <span class="hl num">536870912</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>len<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; -</span><span class="hl num">131072</span><span class="hl opt">) |</span>
        <span class="hl opt">(</span>len <span class="hl opt">&amp;</span> <span class="hl num">131071</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">268435456</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">134217728</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setFollowing</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">536870912</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setIsFinal</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">33554432</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isFinal</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">33554432</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_cancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">67108864</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setCancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">67108864</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetCancellable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">67108864</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setIsMigrated</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">4194304</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetIsMigrated</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">4194304</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isMigrated</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">4194304</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_receiverAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> index <span class="hl opt">===</span> <span class="hl num">0</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver0
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[</span>
            index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span> <span class="hl opt">+</span> <span class="hl num">4</span><span class="hl opt">];</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> undefined <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isBound</span><span class="hl opt">()) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> index <span class="hl opt">===</span> <span class="hl num">0</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise0
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[</span>index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span> <span class="hl opt">+</span> <span class="hl num">3</span><span class="hl opt">];</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_fulfillmentHandlerAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> index <span class="hl opt">===</span> <span class="hl num">0</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[</span>index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span> <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">];</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_rejectionHandlerAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> index <span class="hl opt">===</span> <span class="hl num">0</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_rejectionHandler0
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">[</span>index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">];</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_boundValue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_boundTo<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>ret<span class="hl opt">.</span><span class="hl kwd">isFulfilled</span><span class="hl opt">()) {</span>
                <span class="hl kwa">return</span> ret<span class="hl opt">.</span><span class="hl kwd">value</span><span class="hl opt">();</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">return</span> undefined<span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_migrateCallbacks</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>follower<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> fulfill <span class="hl opt">=</span> follower<span class="hl opt">.</span><span class="hl kwd">_fulfillmentHandlerAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">var</span> reject <span class="hl opt">=</span> follower<span class="hl opt">.</span><span class="hl kwd">_rejectionHandlerAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">var</span> progress <span class="hl opt">=</span> follower<span class="hl opt">.</span><span class="hl kwd">_progressHandlerAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> follower<span class="hl opt">.</span><span class="hl kwd">_promiseAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> follower<span class="hl opt">.</span><span class="hl kwd">_receiverAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">)</span> promise<span class="hl opt">.</span><span class="hl kwd">_setIsMigrated</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_addCallbacks</span><span class="hl opt">(</span>fulfill<span class="hl opt">,</span> reject<span class="hl opt">,</span> progress<span class="hl opt">,</span> promise<span class="hl opt">,</span> receiver<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_addCallbacks</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>
    fulfill<span class="hl opt">,</span>
    reject<span class="hl opt">,</span>
    progress<span class="hl opt">,</span>
    promise<span class="hl opt">,</span>
    receiver<span class="hl opt">,</span>
    domain
<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> index <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&gt;=</span> <span class="hl num">131071</span> <span class="hl opt">-</span> <span class="hl num">5</span><span class="hl opt">) {</span>
        index <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise0 <span class="hl opt">=</span> promise<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>receiver <span class="hl opt">!==</span> undefined<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver0 <span class="hl opt">=</span> receiver<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fulfill <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp; !</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isCarryingStackTrace</span><span class="hl opt">()) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0 <span class="hl opt">=</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fulfill <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fulfill<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> reject <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_rejectionHandler0 <span class="hl opt">=</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> reject <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>reject<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> progress <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_progressHandler0 <span class="hl opt">=</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> progress <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>progress<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> base <span class="hl opt">=</span> index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">3</span><span class="hl opt">] =</span> promise<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">4</span><span class="hl opt">] =</span> receiver<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fulfill <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">] =</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fulfill <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fulfill<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> reject <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] =</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> reject <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>reject<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> progress <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">] =</span>
                domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> progress <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>progress<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span><span class="hl opt">(</span>index <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span> index<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setProxyHandlers</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>receiver<span class="hl opt">,</span> promiseSlotValue<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> index <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&gt;=</span> <span class="hl num">131071</span> <span class="hl opt">-</span> <span class="hl num">5</span><span class="hl opt">) {</span>
        index <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise0 <span class="hl opt">=</span> promiseSlotValue<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver0 <span class="hl opt">=</span> receiver<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> base <span class="hl opt">=</span> index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">3</span><span class="hl opt">] =</span> promiseSlotValue<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">4</span><span class="hl opt">] =</span> receiver<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span><span class="hl opt">(</span>index <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_proxyPromiseArray</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promiseArray<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setProxyHandlers</span><span class="hl opt">(</span>promiseArray<span class="hl opt">,</span> index<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>value<span class="hl opt">,</span> shouldBind<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFollowingOrFulfilledOrRejected</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>value <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">)</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span><span class="hl kwd">makeSelfResolutionError</span><span class="hl opt">(),</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>value<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">))</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(</span>value<span class="hl opt">);</span>

    <span class="hl kwa">var</span> propagationFlags <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">| (</span>shouldBind <span class="hl opt">?</span> <span class="hl num">4</span> <span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span>maybePromise<span class="hl opt">,</span> propagationFlags<span class="hl opt">);</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
        <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">();</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_migrateCallbacks</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> i<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setFollowing</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setLength</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setFollowee</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_fulfillUnchecked</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">());</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span><span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">(),</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_getCarriedStackTrace</span><span class="hl opt">());</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_rejectCallback <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> synchronous<span class="hl opt">,</span> shouldNotMarkOriginatingFromRejection<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>shouldNotMarkOriginatingFromRejection<span class="hl opt">) {</span>
        util<span class="hl opt">.</span><span class="hl kwd">markAsOriginatingFromRejection</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> trace <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">ensureErrorObject</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl kwa">var</span> hasStack <span class="hl opt">=</span> trace <span class="hl opt">===</span> reason<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>trace<span class="hl opt">,</span> synchronous <span class="hl opt">?</span> hasStack <span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> hasStack <span class="hl opt">?</span> undefined <span class="hl opt">:</span> trace<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolveFromResolver</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>resolver<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> synchronous <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>resolver<span class="hl opt">)(</span><span class="hl kwa">function</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">},</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> synchronous<span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">});</span>
    synchronous <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>r <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span> r <span class="hl opt">===</span> errorObj <span class="hl opt">&amp;&amp;</span> promise <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>r<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseFromHandler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>
    handler<span class="hl opt">,</span> receiver<span class="hl opt">,</span> value<span class="hl opt">,</span> promise
<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise<span class="hl opt">.</span><span class="hl kwd">_isRejected</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> x<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>receiver <span class="hl opt">===</span> APPLY <span class="hl opt">&amp;&amp; !</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isRejected</span><span class="hl opt">()) {</span>
        x <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>handler<span class="hl opt">).</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">(),</span> value<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        x <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>handler<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> value<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>x <span class="hl opt">===</span> errorObj <span class="hl opt">||</span> x <span class="hl opt">===</span> promise <span class="hl opt">||</span> x <span class="hl opt">===</span> NEXT_FILTER<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> err <span class="hl opt">=</span> x <span class="hl opt">===</span> promise <span class="hl opt">?</span> <span class="hl kwd">makeSelfResolutionError</span><span class="hl opt">() :</span> x<span class="hl opt">.</span>e<span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>err<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>x<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_target</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>ret<span class="hl opt">.</span><span class="hl kwd">_isFollowing</span><span class="hl opt">())</span> ret <span class="hl opt">=</span> ret<span class="hl opt">.</span><span class="hl kwd">_followee</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_followee</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_rejectionHandler0<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setFollowee</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_rejectionHandler0 <span class="hl opt">=</span> promise<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_cleanValues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_cancellable</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_cancellationParent <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>parent<span class="hl opt">,</span> flags<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>flags <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> parent<span class="hl opt">.</span><span class="hl kwd">_cancellable</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setCancellable</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_cancellationParent <span class="hl opt">=</span> parent<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>flags <span class="hl opt">&amp;</span> <span class="hl num">4</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> parent<span class="hl opt">.</span><span class="hl kwd">_isBound</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setBoundTo</span><span class="hl opt">(</span>parent<span class="hl opt">.</span>_boundTo<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_fulfill</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFollowingOrFulfilledOrRejected</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_fulfillUnchecked</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_reject</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">,</span> carriedStackTrace<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFollowingOrFulfilledOrRejected</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> carriedStackTrace<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseAt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">var</span> isPromise <span class="hl opt">=</span> promise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>isPromise <span class="hl opt">&amp;&amp;</span> promise<span class="hl opt">.</span><span class="hl kwd">_isMigrated</span><span class="hl opt">()) {</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_unsetIsMigrated</span><span class="hl opt">();</span>
        <span class="hl kwa">return</span> async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_settlePromiseAt<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> index<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> handler <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()</span>
        <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_fulfillmentHandlerAt</span><span class="hl opt">(</span>index<span class="hl opt">)</span>
        <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejectionHandlerAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>

    <span class="hl kwa">var</span> carriedStackTrace <span class="hl opt">=</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isCarryingStackTrace</span><span class="hl opt">() ?</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getCarriedStackTrace</span><span class="hl opt">() :</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">var</span> value <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
    <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_receiverAt</span><span class="hl opt">(</span>index<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_clearCallbackDataAtIndex</span><span class="hl opt">(</span>index<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> handler <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>isPromise<span class="hl opt">) {</span>
            handler<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> value<span class="hl opt">,</span> promise<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseFromHandler</span><span class="hl opt">(</span>handler<span class="hl opt">,</span> receiver<span class="hl opt">,</span> value<span class="hl opt">,</span> promise<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>receiver <span class="hl kwa">instanceof</span> PromiseArray<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>receiver<span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">()) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
                receiver<span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span><span class="hl opt">(</span>value<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">else</span> <span class="hl opt">{</span>
                receiver<span class="hl opt">.</span><span class="hl kwd">_promiseRejected</span><span class="hl opt">(</span>value<span class="hl opt">,</span> promise<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>isPromise<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>value<span class="hl opt">,</span> carriedStackTrace<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">&gt;=</span> <span class="hl num">4</span> <span class="hl opt">&amp;&amp; (</span>index <span class="hl opt">&amp;</span> <span class="hl num">31</span><span class="hl opt">) ===</span> <span class="hl num">4</span><span class="hl opt">)</span>
        async<span class="hl opt">.</span><span class="hl kwd">invokeLater</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_setLength<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_clearCallbackDataAtIndex</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>index<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isCarryingStackTrace</span><span class="hl opt">()) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_fulfillmentHandler0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_rejectionHandler0 <span class="hl opt">=</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_progressHandler0 <span class="hl opt">=</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_receiver0 <span class="hl opt">=</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise0 <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> base <span class="hl opt">=</span> index <span class="hl opt">*</span> <span class="hl num">5</span> <span class="hl opt">-</span> <span class="hl num">5</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">3</span><span class="hl opt">] =</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">4</span><span class="hl opt">] =</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">] =</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] =</span>
        <span class="hl kwa">this</span><span class="hl opt">[</span>base <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">] =</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isSettlePromisesQueued</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span>
            <span class="hl opt">-</span><span class="hl num">1073741824</span><span class="hl opt">) === -</span><span class="hl num">1073741824</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setSettlePromisesQueued</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">| -</span><span class="hl num">1073741824</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetSettlePromisesQueued</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~-</span><span class="hl num">1073741824</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_queueSettlePromises</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    async<span class="hl opt">.</span><span class="hl kwd">settlePromises</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setSettlePromisesQueued</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_fulfillUnchecked</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>value <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> err <span class="hl opt">=</span> <span class="hl kwd">makeSelfResolutionError</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span><span class="hl opt">(</span>err<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setFulfilled</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_cleanValues</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">() &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueSettlePromises</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_rejectUncheckedCheckError</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> trace <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">ensureErrorObject</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> trace <span class="hl opt">===</span> reason <span class="hl opt">?</span> undefined <span class="hl opt">:</span> trace<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">,</span> trace<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>reason <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> err <span class="hl opt">=</span> <span class="hl kwd">makeSelfResolutionError</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_rejectUnchecked</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setRejected</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> reason<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_cleanValues</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isFinal</span><span class="hl opt">()) {</span>
        async<span class="hl opt">.</span><span class="hl kwd">throwLater</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl str">&quot;stack&quot;</span> <span class="hl kwa">in</span> e<span class="hl opt">) {</span>
                async<span class="hl opt">.</span><span class="hl kwd">invokeFirst</span><span class="hl opt">(</span>
                    CapturedTrace<span class="hl opt">.</span>unhandledRejection<span class="hl opt">,</span> undefined<span class="hl opt">,</span> e<span class="hl opt">);</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">throw</span> e<span class="hl opt">;</span>
        <span class="hl opt">},</span> trace <span class="hl opt">===</span> undefined <span class="hl opt">?</span> reason <span class="hl opt">:</span> trace<span class="hl opt">);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>trace <span class="hl opt">!==</span> undefined <span class="hl opt">&amp;&amp;</span> trace <span class="hl opt">!==</span> reason<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_setCarriedStackTrace</span><span class="hl opt">(</span>trace<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">() &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_queueSettlePromises</span><span class="hl opt">();</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_ensurePossibleRejectionHandled</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_settlePromises</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetSettlePromisesQueued</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_length</span><span class="hl opt">();</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_settlePromiseAt</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span>
                       <span class="hl str">&quot;_makeSelfResolutionError&quot;</span><span class="hl opt">,</span>
                       makeSelfResolutionError<span class="hl opt">);</span>

<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./progress.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./method.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./bind.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./finally.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> NEXT_FILTER<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./direct_resolve.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./synchronous_inspection.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./join.js&quot;</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
Promise<span class="hl opt">.</span>Promise <span class="hl opt">=</span> Promise<span class="hl opt">;</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./map.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> apiRejection<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./cancel.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./using.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> apiRejection<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> createContext<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./generators.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> apiRejection<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./nodeify.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./call_get.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./props.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./race.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./reduce.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> apiRejection<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./settle.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./some.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> apiRejection<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./promisify.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./any.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./each.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./timers.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
<span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">'./filter.js'</span><span class="hl opt">)(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">);</span>
                                                         
    util<span class="hl opt">.</span><span class="hl kwd">toFastProperties</span><span class="hl opt">(</span>Promise<span class="hl opt">);</span>                                          
    util<span class="hl opt">.</span><span class="hl kwd">toFastProperties</span><span class="hl opt">(</span>Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">);</span>                                
    <span class="hl kwa">function</span> <span class="hl kwd">fillTypes</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>                                              
        <span class="hl kwa">var</span> p <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>                                       
        p<span class="hl opt">.</span>_fulfillmentHandler0 <span class="hl opt">=</span> value<span class="hl opt">;</span>                                      
        p<span class="hl opt">.</span>_rejectionHandler0 <span class="hl opt">=</span> value<span class="hl opt">;</span>                                        
        p<span class="hl opt">.</span>_progressHandler0 <span class="hl opt">=</span> value<span class="hl opt">;</span>                                         
        p<span class="hl opt">.</span>_promise0 <span class="hl opt">=</span> value<span class="hl opt">;</span>                                                 
        p<span class="hl opt">.</span>_receiver0 <span class="hl opt">=</span> value<span class="hl opt">;</span>                                                
        p<span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> value<span class="hl opt">;</span>                                             
    <span class="hl opt">}</span>                                                                        
    <span class="hl slc">// Complete slack tracking, opt out of field-type tracking and           </span>
    <span class="hl slc">// stabilize map                                                         </span>
    <span class="hl kwd">fillTypes</span><span class="hl opt">({</span>a<span class="hl opt">:</span> <span class="hl num">1</span><span class="hl opt">});</span>                                                       
    <span class="hl kwd">fillTypes</span><span class="hl opt">({</span>b<span class="hl opt">:</span> <span class="hl num">2</span><span class="hl opt">});</span>                                                       
    <span class="hl kwd">fillTypes</span><span class="hl opt">({</span>c<span class="hl opt">:</span> <span class="hl num">3</span><span class="hl opt">});</span>                                                       
    <span class="hl kwd">fillTypes</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>                                                            
    <span class="hl kwd">fillTypes</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(){});</span>                                                 
    <span class="hl kwd">fillTypes</span><span class="hl opt">(</span>undefined<span class="hl opt">);</span>                                                    
    <span class="hl kwd">fillTypes</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">);</span>                                                        
    <span class="hl kwd">fillTypes</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">));</span>                                        
    CapturedTrace<span class="hl opt">.</span><span class="hl kwd">setBounds</span><span class="hl opt">(</span>async<span class="hl opt">.</span>firstLineError<span class="hl opt">,</span> util<span class="hl opt">.</span>lastLineError<span class="hl opt">);</span>       
    <span class="hl kwa">return</span> Promise<span class="hl opt">;</span>                                                          

<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./any.js&quot;</span><span class="hl opt">:</span><span class="hl num">1</span><span class="hl opt">,</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./bind.js&quot;</span><span class="hl opt">:</span><span class="hl num">3</span><span class="hl opt">,</span><span class="hl str">&quot;./call_get.js&quot;</span><span class="hl opt">:</span><span class="hl num">5</span><span class="hl opt">,</span><span class="hl str">&quot;./cancel.js&quot;</span><span class="hl opt">:</span><span class="hl num">6</span><span class="hl opt">,</span><span class="hl str">&quot;./captured_trace.js&quot;</span><span class="hl opt">:</span><span class="hl num">7</span><span class="hl opt">,</span><span class="hl str">&quot;./catch_filter.js&quot;</span><span class="hl opt">:</span><span class="hl num">8</span><span class="hl opt">,</span><span class="hl str">&quot;./context.js&quot;</span><span class="hl opt">:</span><span class="hl num">9</span><span class="hl opt">,</span><span class="hl str">&quot;./debuggability.js&quot;</span><span class="hl opt">:</span><span class="hl num">10</span><span class="hl opt">,</span><span class="hl str">&quot;./direct_resolve.js&quot;</span><span class="hl opt">:</span><span class="hl num">11</span><span class="hl opt">,</span><span class="hl str">&quot;./each.js&quot;</span><span class="hl opt">:</span><span class="hl num">12</span><span class="hl opt">,</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./filter.js&quot;</span><span class="hl opt">:</span><span class="hl num">15</span><span class="hl opt">,</span><span class="hl str">&quot;./finally.js&quot;</span><span class="hl opt">:</span><span class="hl num">16</span><span class="hl opt">,</span><span class="hl str">&quot;./generators.js&quot;</span><span class="hl opt">:</span><span class="hl num">17</span><span class="hl opt">,</span><span class="hl str">&quot;./join.js&quot;</span><span class="hl opt">:</span><span class="hl num">18</span><span class="hl opt">,</span><span class="hl str">&quot;./map.js&quot;</span><span class="hl opt">:</span><span class="hl num">19</span><span class="hl opt">,</span><span class="hl str">&quot;./method.js&quot;</span><span class="hl opt">:</span><span class="hl num">20</span><span class="hl opt">,</span><span class="hl str">&quot;./nodeify.js&quot;</span><span class="hl opt">:</span><span class="hl num">21</span><span class="hl opt">,</span><span class="hl str">&quot;./progress.js&quot;</span><span class="hl opt">:</span><span class="hl num">22</span><span class="hl opt">,</span><span class="hl str">&quot;./promise_array.js&quot;</span><span class="hl opt">:</span><span class="hl num">24</span><span class="hl opt">,</span><span class="hl str">&quot;./promise_resolver.js&quot;</span><span class="hl opt">:</span><span class="hl num">25</span><span class="hl opt">,</span><span class="hl str">&quot;./promisify.js&quot;</span><span class="hl opt">:</span><span class="hl num">26</span><span class="hl opt">,</span><span class="hl str">&quot;./props.js&quot;</span><span class="hl opt">:</span><span class="hl num">27</span><span class="hl opt">,</span><span class="hl str">&quot;./race.js&quot;</span><span class="hl opt">:</span><span class="hl num">29</span><span class="hl opt">,</span><span class="hl str">&quot;./reduce.js&quot;</span><span class="hl opt">:</span><span class="hl num">30</span><span class="hl opt">,</span><span class="hl str">&quot;./settle.js&quot;</span><span class="hl opt">:</span><span class="hl num">32</span><span class="hl opt">,</span><span class="hl str">&quot;./some.js&quot;</span><span class="hl opt">:</span><span class="hl num">33</span><span class="hl opt">,</span><span class="hl str">&quot;./synchronous_inspection.js&quot;</span><span class="hl opt">:</span><span class="hl num">34</span><span class="hl opt">,</span><span class="hl str">&quot;./thenables.js&quot;</span><span class="hl opt">:</span><span class="hl num">35</span><span class="hl opt">,</span><span class="hl str">&quot;./timers.js&quot;</span><span class="hl opt">:</span><span class="hl num">36</span><span class="hl opt">,</span><span class="hl str">&quot;./using.js&quot;</span><span class="hl opt">:</span><span class="hl num">37</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">24</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span>
    apiRejection<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> isArray <span class="hl opt">=</span> util<span class="hl opt">.</span>isArray<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">toResolutionValue</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
    <span class="hl kwa">switch</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
    <span class="hl kwa">case</span> <span class="hl opt">-</span><span class="hl num">2</span><span class="hl opt">:</span> <span class="hl kwa">return</span> <span class="hl opt">[];</span>
    <span class="hl kwa">case</span> <span class="hl opt">-</span><span class="hl num">3</span><span class="hl opt">:</span> <span class="hl kwa">return</span> <span class="hl opt">{};</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">PromiseArray</span><span class="hl opt">(</span>values<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    <span class="hl kwa">var</span> parent<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>values <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        parent <span class="hl opt">=</span> values<span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span>parent<span class="hl opt">,</span> <span class="hl num">1</span> <span class="hl opt">|</span> <span class="hl num">4</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values <span class="hl opt">=</span> values<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_init</span><span class="hl opt">(</span>undefined<span class="hl opt">, -</span><span class="hl num">2</span><span class="hl opt">);</span>
<span class="hl opt">}</span>
PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">length</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_length<span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">promise</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_promise<span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_init <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">init</span><span class="hl opt">(</span>_<span class="hl opt">,</span> resolveValueIfEmpty<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> values <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>values <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        values <span class="hl opt">=</span> values<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_values <span class="hl opt">=</span> values<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>values<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
            values <span class="hl opt">=</span> values<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>values<span class="hl opt">)) {</span>
                <span class="hl kwa">var</span> err <span class="hl opt">=</span> <span class="hl kwa">new</span> Promise<span class="hl opt">.</span><span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;expecting an array, a promise or a thenable</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/s8MMhc</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">__hardReject__</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
                <span class="hl kwa">return</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>values<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
            values<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
                init<span class="hl opt">,</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span>_reject<span class="hl opt">,</span>
                undefined<span class="hl opt">,</span>
                <span class="hl kwa">this</span><span class="hl opt">,</span>
                resolveValueIfEmpty
           <span class="hl opt">);</span>
            <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>values<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
            <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>values<span class="hl opt">)) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span><span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;expecting an array, a promise or a thenable</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/s8MMhc</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">).</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>values<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>resolveValueIfEmpty <span class="hl opt">=== -</span><span class="hl num">5</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolveEmptyArray</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwd">toResolutionValue</span><span class="hl opt">(</span>resolveValueIfEmpty<span class="hl opt">));</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">getActualLength</span><span class="hl opt">(</span>values<span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> len<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">shouldCopyValues</span><span class="hl opt">() ?</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len<span class="hl opt">) :</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">;</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> isResolved <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>values<span class="hl opt">[</span>i<span class="hl opt">],</span> promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>isResolved<span class="hl opt">) {</span>
                maybePromise<span class="hl opt">.</span><span class="hl kwd">_ignoreRejections</span><span class="hl opt">();</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
                maybePromise<span class="hl opt">.</span><span class="hl kwd">_proxyPromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> i<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">(),</span> i<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseRejected</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">(),</span> i<span class="hl opt">);</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span>isResolved<span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span><span class="hl opt">(</span>maybePromise<span class="hl opt">,</span> i<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_values <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>__hardReject__ <span class="hl opt">=</span>
PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_reject</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseProgressed</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>progressValue<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">({</span>
        index<span class="hl opt">:</span> index<span class="hl opt">,</span>
        value<span class="hl opt">:</span> progressValue
    <span class="hl opt">});</span>
<span class="hl opt">};</span>


PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>
    <span class="hl kwa">var</span> totalResolved <span class="hl opt">= ++</span><span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>totalResolved <span class="hl opt">&gt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">++;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">shouldCopyValues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return true</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">getActualLength</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>len<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> len<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">return</span> PromiseArray<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">25</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> maybeWrapAsError <span class="hl opt">=</span> util<span class="hl opt">.</span>maybeWrapAsError<span class="hl opt">;</span>
<span class="hl kwa">var</span> errors <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> TimeoutError <span class="hl opt">=</span> errors<span class="hl opt">.</span>TimeoutError<span class="hl opt">;</span>
<span class="hl kwa">var</span> OperationalError <span class="hl opt">=</span> errors<span class="hl opt">.</span>OperationalError<span class="hl opt">;</span>
<span class="hl kwa">var</span> haveGetters <span class="hl opt">=</span> util<span class="hl opt">.</span>haveGetters<span class="hl opt">;</span>
<span class="hl kwa">var</span> es5 <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">isUntypedError</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> obj <span class="hl kwa">instanceof</span> Error <span class="hl opt">&amp;&amp;</span>
        es5<span class="hl opt">.</span><span class="hl kwd">getPrototypeOf</span><span class="hl opt">(</span>obj<span class="hl opt">) ===</span> Error<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> rErrorKey <span class="hl opt">=</span> <span class="hl kwc">/^(?:name|message|stack|cause)$/</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">wrapAsOperationalError</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isUntypedError</span><span class="hl opt">(</span>obj<span class="hl opt">)) {</span>
        ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">OperationalError</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
        ret<span class="hl opt">.</span>name <span class="hl opt">=</span> obj<span class="hl opt">.</span>name<span class="hl opt">;</span>
        ret<span class="hl opt">.</span>message <span class="hl opt">=</span> obj<span class="hl opt">.</span>message<span class="hl opt">;</span>
        ret<span class="hl opt">.</span>stack <span class="hl opt">=</span> obj<span class="hl opt">.</span>stack<span class="hl opt">;</span>
        <span class="hl kwa">var</span> keys <span class="hl opt">=</span> es5<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> keys<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> key <span class="hl opt">=</span> keys<span class="hl opt">[</span>i<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(!</span>rErrorKey<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>key<span class="hl opt">)) {</span>
                ret<span class="hl opt">[</span>key<span class="hl opt">] =</span> obj<span class="hl opt">[</span>key<span class="hl opt">];</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    util<span class="hl opt">.</span><span class="hl kwd">markAsOriginatingFromRejection</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">nodebackForPromise</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
    <span class="hl kwa">return function</span><span class="hl opt">(</span>err<span class="hl opt">,</span> value<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl opt">===</span> <span class="hl kwa">null</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>err<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> wrapped <span class="hl opt">=</span> <span class="hl kwd">wrapAsOperationalError</span><span class="hl opt">(</span><span class="hl kwd">maybeWrapAsError</span><span class="hl opt">(</span>err<span class="hl opt">));</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>wrapped<span class="hl opt">);</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>wrapped<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>arguments<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">2</span><span class="hl opt">) {</span>
            <span class="hl kwa">var</span> <span class="hl opt">$</span>_len <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length<span class="hl opt">;</span><span class="hl kwa">var</span> args <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">($</span>_len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span> <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> <span class="hl opt">$</span>_i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; $</span>_i <span class="hl opt">&lt; $</span>_len<span class="hl opt">; ++$</span>_i<span class="hl opt">) {</span>args<span class="hl opt">[$</span>_i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] =</span> arguments<span class="hl opt">[$</span>_i<span class="hl opt">];}</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(</span>args<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        <span class="hl opt">}</span>

        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>


<span class="hl kwa">var</span> PromiseResolver<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(!</span>haveGetters<span class="hl opt">) {</span>
    <span class="hl kwd">PromiseResolver</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promise<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>promise <span class="hl opt">=</span> promise<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>asCallback <span class="hl opt">=</span> <span class="hl kwd">nodebackForPromise</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>callback <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>asCallback<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
<span class="hl kwa">else</span> <span class="hl opt">{</span>
    <span class="hl kwd">PromiseResolver</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promise<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>promise <span class="hl opt">=</span> promise<span class="hl opt">;</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>haveGetters<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> prop <span class="hl opt">= {</span>
        <span class="hl kwa">get</span><span class="hl opt">:</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
            <span class="hl kwa">return</span> <span class="hl kwd">nodebackForPromise</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">};</span>
    es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span> <span class="hl str">&quot;asCallback&quot;</span><span class="hl opt">,</span> prop<span class="hl opt">);</span>
    es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span> <span class="hl str">&quot;callback&quot;</span><span class="hl opt">,</span> prop<span class="hl opt">);</span>
<span class="hl opt">}</span>

PromiseResolver<span class="hl opt">.</span>_nodebackForPromise <span class="hl opt">=</span> nodebackForPromise<span class="hl opt">;</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">toString</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl str">&quot;[object PromiseResolver]&quot;</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>resolve <span class="hl opt">=</span>
PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">fulfill</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this instanceof</span> PromiseResolver<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/sdkXL9</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reject</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this instanceof</span> PromiseResolver<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/sdkXL9</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">progress</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl kwa">this instanceof</span> PromiseResolver<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/sdkXL9</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">cancel</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>err<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">cancel</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">timeout</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">TimeoutError</span><span class="hl opt">(</span><span class="hl str">&quot;timeout&quot;</span><span class="hl opt">));</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">isResolved</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

PromiseResolver<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">toJSON</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>promise<span class="hl opt">.</span><span class="hl kwd">toJSON</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> PromiseResolver<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">26</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> THIS <span class="hl opt">= {};</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> nodebackForPromise <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./promise_resolver.js&quot;</span><span class="hl opt">)</span>
    <span class="hl opt">.</span>_nodebackForPromise<span class="hl opt">;</span>
<span class="hl kwa">var</span> withAppended <span class="hl opt">=</span> util<span class="hl opt">.</span>withAppended<span class="hl opt">;</span>
<span class="hl kwa">var</span> maybeWrapAsError <span class="hl opt">=</span> util<span class="hl opt">.</span>maybeWrapAsError<span class="hl opt">;</span>
<span class="hl kwa">var</span> canEvaluate <span class="hl opt">=</span> util<span class="hl opt">.</span>canEvaluate<span class="hl opt">;</span>
<span class="hl kwa">var</span> TypeError <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors&quot;</span><span class="hl opt">).</span>TypeError<span class="hl opt">;</span>
<span class="hl kwa">var</span> defaultSuffix <span class="hl opt">=</span> <span class="hl str">&quot;Async&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> defaultPromisified <span class="hl opt">= {</span>__isPromisified__<span class="hl opt">:</span> <span class="hl kwa">true</span><span class="hl opt">};</span>
<span class="hl kwa">var</span> noCopyProps <span class="hl opt">= [</span>
    <span class="hl str">&quot;arity&quot;</span><span class="hl opt">,</span>    <span class="hl str">&quot;length&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;name&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;arguments&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;caller&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;callee&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;prototype&quot;</span><span class="hl opt">,</span>
    <span class="hl str">&quot;__isPromisified__&quot;</span>
<span class="hl opt">];</span>
<span class="hl kwa">var</span> noCopyPropsPattern <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">RegExp</span><span class="hl opt">(</span><span class="hl str">&quot;^(?:&quot;</span> <span class="hl opt">+</span> noCopyProps<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;|&quot;</span><span class="hl opt">) +</span> <span class="hl str">&quot;)$&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> <span class="hl kwd">defaultFilter</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>name<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> util<span class="hl opt">.</span><span class="hl kwd">isIdentifier</span><span class="hl opt">(</span>name<span class="hl opt">) &amp;&amp;</span>
        name<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) !==</span> <span class="hl str">&quot;_&quot;</span> <span class="hl opt">&amp;&amp;</span>
        name <span class="hl opt">!==</span> <span class="hl str">&quot;constructor&quot;</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">propsFilter</span><span class="hl opt">(</span>key<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl opt">!</span>noCopyPropsPattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">isPromisified</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">return</span> fn<span class="hl opt">.</span>__isPromisified__ <span class="hl opt">===</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">hasPromisified</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">,</span> suffix<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> val <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">getDataPropertyOrDefault</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key <span class="hl opt">+</span> suffix<span class="hl opt">,</span>
                                            defaultPromisified<span class="hl opt">);</span>
    <span class="hl kwa">return</span> val <span class="hl opt">?</span> <span class="hl kwd">isPromisified</span><span class="hl opt">(</span>val<span class="hl opt">) :</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">checkValid</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> suffix<span class="hl opt">,</span> suffixRegexp<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> ret<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> key <span class="hl opt">=</span> ret<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>suffixRegexp<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>key<span class="hl opt">)) {</span>
            <span class="hl kwa">var</span> keyWithoutAsyncSuffix <span class="hl opt">=</span> key<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span>suffixRegexp<span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">);</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> ret<span class="hl opt">.</span>length<span class="hl opt">;</span> j <span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">) {</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>ret<span class="hl opt">[</span>j<span class="hl opt">] ===</span> keyWithoutAsyncSuffix<span class="hl opt">) {</span>
                    <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot promisify an API that has normal methods with '%s'-suffix</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/iWrZbw</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span>
                        <span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;%s&quot;</span><span class="hl opt">,</span> suffix<span class="hl opt">));</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">promisifiableMethods</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> suffix<span class="hl opt">,</span> suffixRegexp<span class="hl opt">,</span> filter<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> keys <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">inheritedDataKeys</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">= [];</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> keys<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> key <span class="hl opt">=</span> keys<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> value <span class="hl opt">=</span> obj<span class="hl opt">[</span>key<span class="hl opt">];</span>
        <span class="hl kwa">var</span> passesDefaultFilter <span class="hl opt">=</span> filter <span class="hl opt">===</span> defaultFilter
            <span class="hl opt">?</span> <span class="hl kwa">true</span> <span class="hl opt">:</span> <span class="hl kwd">defaultFilter</span><span class="hl opt">(</span>key<span class="hl opt">,</span> value<span class="hl opt">,</span> obj<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> value <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span>
            <span class="hl opt">!</span><span class="hl kwd">isPromisified</span><span class="hl opt">(</span>value<span class="hl opt">) &amp;&amp;</span>
            <span class="hl opt">!</span><span class="hl kwd">hasPromisified</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">,</span> suffix<span class="hl opt">) &amp;&amp;</span>
            <span class="hl kwd">filter</span><span class="hl opt">(</span>key<span class="hl opt">,</span> value<span class="hl opt">,</span> obj<span class="hl opt">,</span> passesDefaultFilter<span class="hl opt">)) {</span>
            ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">,</span> value<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">checkValid</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> suffix<span class="hl opt">,</span> suffixRegexp<span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> <span class="hl kwd">escapeIdentRegex</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>str<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> str<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/([$])/</span><span class="hl opt">,</span> <span class="hl str">&quot;</span><span class="hl esc">\\</span><span class="hl str">$&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> makeNodePromisifiedEval<span class="hl opt">;</span>
<span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">true</span><span class="hl opt">) {</span>
<span class="hl kwa">var</span> <span class="hl kwd">switchCaseArgumentOrder</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>likelyArgumentCount<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">= [</span>likelyArgumentCount<span class="hl opt">];</span>
    <span class="hl kwa">var</span> min <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> likelyArgumentCount <span class="hl opt">-</span> <span class="hl num">1</span> <span class="hl opt">-</span> <span class="hl num">3</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> likelyArgumentCount <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> min<span class="hl opt">; --</span>i<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> likelyArgumentCount <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&lt;=</span> <span class="hl num">3</span><span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">argumentSequence</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>argumentCount<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> util<span class="hl opt">.</span><span class="hl kwd">filledRange</span><span class="hl opt">(</span>argumentCount<span class="hl opt">,</span> <span class="hl str">&quot;_arg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">parameterDeclaration</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>parameterCount<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> util<span class="hl opt">.</span><span class="hl kwd">filledRange</span><span class="hl opt">(</span>
        Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span>parameterCount<span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">),</span> <span class="hl str">&quot;_arg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">parameterCount</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span>Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>fn<span class="hl opt">.</span>length<span class="hl opt">,</span> <span class="hl num">1023</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">),</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

makeNodePromisifiedEval <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>callback<span class="hl opt">,</span> receiver<span class="hl opt">,</span> originalName<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> newParameterCount <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwd">parameterCount</span><span class="hl opt">(</span>fn<span class="hl opt">) -</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> argumentOrder <span class="hl opt">=</span> <span class="hl kwd">switchCaseArgumentOrder</span><span class="hl opt">(</span>newParameterCount<span class="hl opt">);</span>
    <span class="hl kwa">var</span> shouldProxyThis <span class="hl opt">=</span> <span class="hl kwa">typeof</span> callback <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">||</span> receiver <span class="hl opt">===</span> THIS<span class="hl opt">;</span>

    <span class="hl kwa">function</span> <span class="hl kwd">generateCallForArgumentCount</span><span class="hl opt">(</span>count<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> args <span class="hl opt">=</span> <span class="hl kwd">argumentSequence</span><span class="hl opt">(</span>count<span class="hl opt">).</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">&quot;, &quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">var</span> comma <span class="hl opt">=</span> count <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">?</span> <span class="hl str">&quot;, &quot;</span> <span class="hl opt">:</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> ret<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>shouldProxyThis<span class="hl opt">) {</span>
            ret <span class="hl opt">=</span> <span class="hl str">&quot;ret = callback.call(this, {{args}}, nodeback); break;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            ret <span class="hl opt">=</span> receiver <span class="hl opt">===</span> undefined
                <span class="hl opt">?</span> <span class="hl str">&quot;ret = callback({{args}}, nodeback); break;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>
                <span class="hl opt">:</span> <span class="hl str">&quot;ret = callback.call(receiver, {{args}}, nodeback); break;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;{{args}}&quot;</span><span class="hl opt">,</span> args<span class="hl opt">).</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;, &quot;</span><span class="hl opt">,</span> comma<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">generateArgumentSwitchCase</span><span class="hl opt">() {</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">;</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> argumentOrder<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            ret <span class="hl opt">+=</span> <span class="hl str">&quot;case &quot;</span> <span class="hl opt">+</span> argumentOrder<span class="hl opt">[</span>i<span class="hl opt">] +</span><span class="hl str">&quot;:&quot;</span> <span class="hl opt">+</span>
                <span class="hl kwd">generateCallForArgumentCount</span><span class="hl opt">(</span>argumentOrder<span class="hl opt">[</span>i<span class="hl opt">]);</span>
        <span class="hl opt">}</span>

        ret <span class="hl opt">+=</span> <span class="hl str">&quot;</span>                                                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        default:</span>                                                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var args = new Array(len + 1);</span>                                   <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var i = 0;</span>                                                       <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            for (var i = 0; i &lt; len; ++i) {</span>                                  <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">               args[i] = arguments[i];</span>                                       <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            }</span>                                                                <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            args[i] = nodeback;</span>                                              <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            [CodeForCall]</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            break;</span>                                                           <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        &quot;</span><span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;[CodeForCall]&quot;</span><span class="hl opt">, (</span>shouldProxyThis
                                <span class="hl opt">?</span> <span class="hl str">&quot;ret = callback.apply(this, args);</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>
                                <span class="hl opt">:</span> <span class="hl str">&quot;ret = callback.apply(receiver, args);</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">));</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> getFunctionCode <span class="hl opt">=</span> <span class="hl kwa">typeof</span> callback <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span>
                                <span class="hl opt">? (</span><span class="hl str">&quot;this != null ? this['&quot;</span><span class="hl opt">+</span>callback<span class="hl opt">+</span><span class="hl str">&quot;'] : fn&quot;</span><span class="hl opt">)</span>
                                <span class="hl opt">:</span> <span class="hl str">&quot;fn&quot;</span><span class="hl opt">;</span>

    <span class="hl kwa">return new</span> <span class="hl kwd">Function</span><span class="hl opt">(</span><span class="hl str">&quot;Promise&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;fn&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;receiver&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;withAppended&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;maybeWrapAsError&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;nodebackForPromise&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;tryCatch&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;errorObj&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;notEnumerableProp&quot;</span><span class="hl opt">,</span>
                        <span class="hl str">&quot;INTERNAL&quot;</span><span class="hl opt">,</span><span class="hl str">&quot;'use strict';</span>                            <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        var ret = function (Parameters) {</span>                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            'use strict';</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var len = arguments.length;</span>                                      <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var promise = new Promise(INTERNAL);</span>                             <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            promise._captureStackTrace();</span>                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var nodeback = nodebackForPromise(promise);</span>                      <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var ret;</span>                                                         <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            var callback = tryCatch([GetFunctionCode]);</span>                      <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            switch(len) {</span>                                                    <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                [CodeForSwitchCase]</span>                                          <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            }</span>                                                                <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            if (ret === errorObj) {</span>                                          <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">                promise._rejectCallback(maybeWrapAsError(ret.e), true, true);</span><span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            }</span>                                                                <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">            return promise;</span>                                                  <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        };</span>                                                                   <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        notEnumerableProp(ret, '__isPromisified__', true);</span>                   <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        return ret;</span>                                                          <span class="hl esc">\n</span><span class="hl str">\</span>
<span class="hl str">        &quot;</span>
        <span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;Parameters&quot;</span><span class="hl opt">,</span> <span class="hl kwd">parameterDeclaration</span><span class="hl opt">(</span>newParameterCount<span class="hl opt">))</span>
        <span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;[CodeForSwitchCase]&quot;</span><span class="hl opt">,</span> <span class="hl kwd">generateArgumentSwitchCase</span><span class="hl opt">())</span>
        <span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">&quot;[GetFunctionCode]&quot;</span><span class="hl opt">,</span> getFunctionCode<span class="hl opt">))(</span>
            Promise<span class="hl opt">,</span>
            fn<span class="hl opt">,</span>
            receiver<span class="hl opt">,</span>
            withAppended<span class="hl opt">,</span>
            maybeWrapAsError<span class="hl opt">,</span>
            nodebackForPromise<span class="hl opt">,</span>
            util<span class="hl opt">.</span>tryCatch<span class="hl opt">,</span>
            util<span class="hl opt">.</span>errorObj<span class="hl opt">,</span>
            util<span class="hl opt">.</span>notEnumerableProp<span class="hl opt">,</span>
            INTERNAL
        <span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">makeNodePromisifiedClosure</span><span class="hl opt">(</span>callback<span class="hl opt">,</span> receiver<span class="hl opt">,</span> _<span class="hl opt">,</span> fn<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> defaultThis <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span><span class="hl kwa">return this</span><span class="hl opt">;})();</span>
    <span class="hl kwa">var</span> method <span class="hl opt">=</span> callback<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> method <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">) {</span>
        callback <span class="hl opt">=</span> fn<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">function</span> <span class="hl kwd">promisified</span><span class="hl opt">() {</span>
        <span class="hl kwa">var</span> _receiver <span class="hl opt">=</span> receiver<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>receiver <span class="hl opt">===</span> THIS<span class="hl opt">)</span> _receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> cb <span class="hl opt">=</span> <span class="hl kwa">typeof</span> method <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span> <span class="hl opt">!==</span> defaultThis
            <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">[</span>method<span class="hl opt">] :</span> callback<span class="hl opt">;</span>
        <span class="hl kwa">var</span> fn <span class="hl opt">=</span> <span class="hl kwd">nodebackForPromise</span><span class="hl opt">(</span>promise<span class="hl opt">);</span>
        <span class="hl kwa">try</span> <span class="hl opt">{</span>
            cb<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>_receiver<span class="hl opt">,</span> <span class="hl kwd">withAppended</span><span class="hl opt">(</span>arguments<span class="hl opt">,</span> fn<span class="hl opt">));</span>
        <span class="hl opt">}</span> <span class="hl kwa">catch</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span><span class="hl kwd">maybeWrapAsError</span><span class="hl opt">(</span>e<span class="hl opt">),</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> promise<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    util<span class="hl opt">.</span><span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>promisified<span class="hl opt">,</span> <span class="hl str">&quot;__isPromisified__&quot;</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span> promisified<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> makeNodePromisified <span class="hl opt">=</span> canEvaluate
    <span class="hl opt">?</span> makeNodePromisifiedEval
    <span class="hl opt">:</span> makeNodePromisifiedClosure<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">promisifyAll</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> suffix<span class="hl opt">,</span> filter<span class="hl opt">,</span> promisifier<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> suffixRegexp <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">RegExp</span><span class="hl opt">(</span><span class="hl kwd">escapeIdentRegex</span><span class="hl opt">(</span>suffix<span class="hl opt">) +</span> <span class="hl str">&quot;$&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> methods <span class="hl opt">=</span>
        <span class="hl kwd">promisifiableMethods</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> suffix<span class="hl opt">,</span> suffixRegexp<span class="hl opt">,</span> filter<span class="hl opt">);</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> len <span class="hl opt">=</span> methods<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">) {</span>
        <span class="hl kwa">var</span> key <span class="hl opt">=</span> methods<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> fn <span class="hl opt">=</span> methods<span class="hl opt">[</span>i<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">];</span>
        <span class="hl kwa">var</span> promisifiedKey <span class="hl opt">=</span> key <span class="hl opt">+</span> suffix<span class="hl opt">;</span>
        obj<span class="hl opt">[</span>promisifiedKey<span class="hl opt">] =</span> promisifier <span class="hl opt">===</span> makeNodePromisified
                <span class="hl opt">?</span> <span class="hl kwd">makeNodePromisified</span><span class="hl opt">(</span>key<span class="hl opt">,</span> THIS<span class="hl opt">,</span> key<span class="hl opt">,</span> fn<span class="hl opt">,</span> suffix<span class="hl opt">)</span>
                <span class="hl opt">:</span> <span class="hl kwd">promisifier</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
                    <span class="hl kwa">return</span> <span class="hl kwd">makeNodePromisified</span><span class="hl opt">(</span>key<span class="hl opt">,</span> THIS<span class="hl opt">,</span> key<span class="hl opt">,</span> fn<span class="hl opt">,</span> suffix<span class="hl opt">);</span>
                <span class="hl opt">});</span>
    <span class="hl opt">}</span>
    util<span class="hl opt">.</span><span class="hl kwd">toFastProperties</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">promisify</span><span class="hl opt">(</span>callback<span class="hl opt">,</span> receiver<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">makeNodePromisified</span><span class="hl opt">(</span>callback<span class="hl opt">,</span> receiver<span class="hl opt">,</span> undefined<span class="hl opt">,</span> callback<span class="hl opt">);</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwd">promisify</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isPromisified</span><span class="hl opt">(</span>fn<span class="hl opt">)) {</span>
        <span class="hl kwa">return</span> fn<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwd">promisify</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> arguments<span class="hl opt">.</span>length <span class="hl opt">&lt;</span> <span class="hl num">2</span> <span class="hl opt">?</span> THIS <span class="hl opt">:</span> receiver<span class="hl opt">);</span>
    util<span class="hl opt">.</span><span class="hl kwd">copyDescriptors</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> ret<span class="hl opt">,</span> propsFilter<span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">promisifyAll</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>target<span class="hl opt">,</span> options<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> target <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> target <span class="hl opt">!==</span> <span class="hl str">&quot;object&quot;</span><span class="hl opt">) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;the target of promisifyAll must be an object or a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/9ITlV0</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    options <span class="hl opt">=</span> <span class="hl kwd">Object</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
    <span class="hl kwa">var</span> suffix <span class="hl opt">=</span> options<span class="hl opt">.</span>suffix<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> suffix <span class="hl opt">!==</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">)</span> suffix <span class="hl opt">=</span> defaultSuffix<span class="hl opt">;</span>
    <span class="hl kwa">var</span> filter <span class="hl opt">=</span> options<span class="hl opt">.</span>filter<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> filter <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> filter <span class="hl opt">=</span> defaultFilter<span class="hl opt">;</span>
    <span class="hl kwa">var</span> promisifier <span class="hl opt">=</span> options<span class="hl opt">.</span>promisifier<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> promisifier <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> promisifier <span class="hl opt">=</span> makeNodePromisified<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span>util<span class="hl opt">.</span><span class="hl kwd">isIdentifier</span><span class="hl opt">(</span>suffix<span class="hl opt">)) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">RangeError</span><span class="hl opt">(</span><span class="hl str">&quot;suffix must be a valid identifier</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/8FZo5V</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> keys <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">inheritedDataKeys</span><span class="hl opt">(</span>target<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> keys<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> value <span class="hl opt">=</span> target<span class="hl opt">[</span>keys<span class="hl opt">[</span>i<span class="hl opt">]];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>keys<span class="hl opt">[</span>i<span class="hl opt">] !==</span> <span class="hl str">&quot;constructor&quot;</span> <span class="hl opt">&amp;&amp;</span>
            util<span class="hl opt">.</span><span class="hl kwd">isClass</span><span class="hl opt">(</span>value<span class="hl opt">)) {</span>
            <span class="hl kwd">promisifyAll</span><span class="hl opt">(</span>value<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span> suffix<span class="hl opt">,</span> filter<span class="hl opt">,</span> promisifier<span class="hl opt">);</span>
            <span class="hl kwd">promisifyAll</span><span class="hl opt">(</span>value<span class="hl opt">,</span> suffix<span class="hl opt">,</span> filter<span class="hl opt">,</span> promisifier<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> <span class="hl kwd">promisifyAll</span><span class="hl opt">(</span>target<span class="hl opt">,</span> suffix<span class="hl opt">,</span> filter<span class="hl opt">,</span> promisifier<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>


<span class="hl opt">},{</span><span class="hl str">&quot;./errors&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./promise_resolver.js&quot;</span><span class="hl opt">:</span><span class="hl num">25</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">27</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>
    Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> isObject <span class="hl opt">=</span> util<span class="hl opt">.</span>isObject<span class="hl opt">;</span>
<span class="hl kwa">var</span> es5 <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">PropertiesPromiseArray</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> keys <span class="hl opt">=</span> es5<span class="hl opt">.</span><span class="hl kwd">keys</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> keys<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">var</span> values <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len <span class="hl opt">*</span> <span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> key <span class="hl opt">=</span> keys<span class="hl opt">[</span>i<span class="hl opt">];</span>
        values<span class="hl opt">[</span>i<span class="hl opt">] =</span> obj<span class="hl opt">[</span>key<span class="hl opt">];</span>
        values<span class="hl opt">[</span>i <span class="hl opt">+</span> len<span class="hl opt">] =</span> key<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>values<span class="hl opt">);</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>PropertiesPromiseArray<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>

PropertiesPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_init</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_init<span class="hl opt">$(</span>undefined<span class="hl opt">, -</span><span class="hl num">3</span><span class="hl opt">) ;</span>
<span class="hl opt">};</span>

PropertiesPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>
    <span class="hl kwa">var</span> totalResolved <span class="hl opt">= ++</span><span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>totalResolved <span class="hl opt">&gt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> val <span class="hl opt">= {};</span>
        <span class="hl kwa">var</span> keyOffset <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            val<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>i <span class="hl opt">+</span> keyOffset<span class="hl opt">]] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span>val<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

PropertiesPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseProgressed</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">({</span>
        key<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>index <span class="hl opt">+</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">()],</span>
        value<span class="hl opt">:</span> value
    <span class="hl opt">});</span>
<span class="hl opt">};</span>

PropertiesPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">shouldCopyValues</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return false</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PropertiesPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">getActualLength</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>len<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> len <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">props</span><span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret<span class="hl opt">;</span>
    <span class="hl kwa">var</span> castValue <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isObject</span><span class="hl opt">(</span>castValue<span class="hl opt">)) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;cannot await properties of a non-object</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/OsFKC8</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>castValue <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        ret <span class="hl opt">=</span> castValue<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
            Promise<span class="hl opt">.</span>props<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PropertiesPromiseArray</span><span class="hl opt">(</span>castValue<span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>castValue <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span>castValue<span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">props</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">props</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">props</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">props</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">28</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">arrayMove</span><span class="hl opt">(</span>src<span class="hl opt">,</span> srcIndex<span class="hl opt">,</span> dst<span class="hl opt">,</span> dstIndex<span class="hl opt">,</span> len<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>j<span class="hl opt">) {</span>
        dst<span class="hl opt">[</span>j <span class="hl opt">+</span> dstIndex<span class="hl opt">] =</span> src<span class="hl opt">[</span>j <span class="hl opt">+</span> srcIndex<span class="hl opt">];</span>
        src<span class="hl opt">[</span>j <span class="hl opt">+</span> srcIndex<span class="hl opt">] =</span> <span class="hl kwa">void</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">Queue</span><span class="hl opt">(</span>capacity<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">=</span> capacity<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_front <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_willBeOverCapacity</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>size<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_capacity <span class="hl opt">&lt;</span> size<span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_pushOne</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>arg<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_checkCapacity</span><span class="hl opt">(</span>length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> i <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>_front <span class="hl opt">+</span> length<span class="hl opt">) &amp; (</span><span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">[</span>i<span class="hl opt">] =</span> arg<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unshiftOne</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> capacity <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_capacity<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_checkCapacity</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() +</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> front <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_front<span class="hl opt">;</span>
    <span class="hl kwa">var</span> i <span class="hl opt">= ((((</span> front <span class="hl opt">-</span> <span class="hl num">1</span> <span class="hl opt">) &amp;</span>
                    <span class="hl opt">(</span> capacity <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) ) ^</span> capacity <span class="hl opt">) -</span> capacity <span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">[</span>i<span class="hl opt">] =</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_front <span class="hl opt">=</span> i<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() +</span> <span class="hl num">1</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">unshift</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unshiftOne</span><span class="hl opt">(</span>arg<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unshiftOne</span><span class="hl opt">(</span>receiver<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unshiftOne</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">push</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> receiver<span class="hl opt">,</span> arg<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() +</span> <span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_willBeOverCapacity</span><span class="hl opt">(</span>length<span class="hl opt">)) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_pushOne</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_pushOne</span><span class="hl opt">(</span>receiver<span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_pushOne</span><span class="hl opt">(</span>arg<span class="hl opt">);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_front <span class="hl opt">+</span> length <span class="hl opt">-</span> <span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_checkCapacity</span><span class="hl opt">(</span>length<span class="hl opt">);</span>
    <span class="hl kwa">var</span> wrapMask <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">[(</span>j <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">) &amp;</span> wrapMask<span class="hl opt">] =</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">[(</span>j <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) &amp;</span> wrapMask<span class="hl opt">] =</span> receiver<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">[(</span>j <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">) &amp;</span> wrapMask<span class="hl opt">] =</span> arg<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length <span class="hl opt">=</span> length<span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">shift</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> front <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_front<span class="hl opt">,</span>
        ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">[</span>front<span class="hl opt">];</span>

    <span class="hl kwa">this</span><span class="hl opt">[</span>front<span class="hl opt">] =</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_front <span class="hl opt">= (</span>front <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) &amp; (</span><span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">--;</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">length</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_length<span class="hl opt">;</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_checkCapacity</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>size<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">&lt;</span> size<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resizeTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">&lt;&lt;</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

Queue<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resizeTo</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>capacity<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> oldCapacity <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_capacity<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_capacity <span class="hl opt">=</span> capacity<span class="hl opt">;</span>
    <span class="hl kwa">var</span> front <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_front<span class="hl opt">;</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">;</span>
    <span class="hl kwa">var</span> moveItemsCount <span class="hl opt">= (</span>front <span class="hl opt">+</span> length<span class="hl opt">) &amp; (</span>oldCapacity <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwd">arrayMove</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> oldCapacity<span class="hl opt">,</span> moveItemsCount<span class="hl opt">);</span>
<span class="hl opt">};</span>

module<span class="hl opt">.</span>exports <span class="hl opt">=</span> Queue<span class="hl opt">;</span>

<span class="hl opt">},{}],</span><span class="hl num">29</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>
    Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span> apiRejection<span class="hl opt">) {</span>
<span class="hl kwa">var</span> isArray <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">).</span>isArray<span class="hl opt">;</span>

<span class="hl kwa">var</span> <span class="hl kwd">raceLater</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promise<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> promise<span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>array<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">race</span><span class="hl opt">(</span>array<span class="hl opt">,</span> promise<span class="hl opt">);</span>
    <span class="hl opt">});</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">race</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> parent<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">raceLater</span><span class="hl opt">(</span>maybePromise<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(!</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>promises<span class="hl opt">)) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;expecting an array, a promise or a thenable</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/s8MMhc</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>parent <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        ret<span class="hl opt">.</span><span class="hl kwd">_propagateFrom</span><span class="hl opt">(</span>parent<span class="hl opt">,</span> <span class="hl num">4</span> <span class="hl opt">|</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> fulfill <span class="hl opt">=</span> ret<span class="hl opt">.</span>_fulfill<span class="hl opt">;</span>
    <span class="hl kwa">var</span> reject <span class="hl opt">=</span> ret<span class="hl opt">.</span>_reject<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> len <span class="hl opt">=</span> promises<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> val <span class="hl opt">=</span> promises<span class="hl opt">[</span>i<span class="hl opt">];</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>val <span class="hl opt">===</span> undefined <span class="hl opt">&amp;&amp; !(</span>i <span class="hl kwa">in</span> promises<span class="hl opt">)) {</span>
            <span class="hl kwa">continue</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        Promise<span class="hl opt">.</span><span class="hl kwd">cast</span><span class="hl opt">(</span>val<span class="hl opt">).</span><span class="hl kwd">_then</span><span class="hl opt">(</span>fulfill<span class="hl opt">,</span> reject<span class="hl opt">,</span> undefined<span class="hl opt">,</span> ret<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwd">race</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">race</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">race</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">race</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">30</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span>
                          PromiseArray<span class="hl opt">,</span>
                          apiRejection<span class="hl opt">,</span>
                          tryConvertToPromise<span class="hl opt">,</span>
                          INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> getDomain <span class="hl opt">=</span> Promise<span class="hl opt">.</span>_getDomain<span class="hl opt">;</span>
<span class="hl kwa">var</span> async <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> tryCatch <span class="hl opt">=</span> util<span class="hl opt">.</span>tryCatch<span class="hl opt">;</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">ReductionPromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> accum<span class="hl opt">,</span> _each<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>promises<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_preservedValues <span class="hl opt">=</span> _each <span class="hl opt">===</span> INTERNAL <span class="hl opt">? [] :</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_zerothIsAccum <span class="hl opt">= (</span>accum <span class="hl opt">===</span> undefined<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_reducingIndex <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>_zerothIsAccum <span class="hl opt">?</span> <span class="hl num">1</span> <span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_valuesPhase <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>accum<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
    <span class="hl kwa">var</span> rejected <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> isPromise <span class="hl opt">=</span> maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>isPromise<span class="hl opt">) {</span>
        maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
            maybePromise<span class="hl opt">.</span><span class="hl kwd">_proxyPromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
            accum <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">();</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
            rejected <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span>isPromise <span class="hl opt">||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_zerothIsAccum<span class="hl opt">))</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> domain <span class="hl opt">=</span> <span class="hl kwd">getDomain</span><span class="hl opt">();</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_callback <span class="hl opt">=</span> domain <span class="hl opt">===</span> <span class="hl kwa">null</span> <span class="hl opt">?</span> fn <span class="hl opt">:</span> domain<span class="hl opt">.</span><span class="hl kwd">bind</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_accum <span class="hl opt">=</span> accum<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>rejected<span class="hl opt">)</span> async<span class="hl opt">.</span><span class="hl kwd">invoke</span><span class="hl opt">(</span>init<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">init</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_init<span class="hl opt">$(</span>undefined<span class="hl opt">, -</span><span class="hl num">5</span><span class="hl opt">);</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>ReductionPromiseArray<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>

ReductionPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_init</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {};</span>

ReductionPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolveEmptyArray</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">||</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_zerothIsAccum<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_preservedValues <span class="hl opt">!==</span> <span class="hl kwa">null</span>
                        <span class="hl opt">? [] :</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_accum<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

ReductionPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> values <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">;</span>
    values<span class="hl opt">[</span>index<span class="hl opt">] =</span> value<span class="hl opt">;</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> preservedValues <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_preservedValues<span class="hl opt">;</span>
    <span class="hl kwa">var</span> isEach <span class="hl opt">=</span> preservedValues <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> gotAccum <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum<span class="hl opt">;</span>
    <span class="hl kwa">var</span> valuesPhase <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_valuesPhase<span class="hl opt">;</span>
    <span class="hl kwa">var</span> valuesPhaseIndex<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>valuesPhase<span class="hl opt">) {</span>
        valuesPhase <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_valuesPhase <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>length<span class="hl opt">);</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>valuesPhaseIndex<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> valuesPhaseIndex<span class="hl opt">&lt;</span>length<span class="hl opt">; ++</span>valuesPhaseIndex<span class="hl opt">) {</span>
            valuesPhase<span class="hl opt">[</span>valuesPhaseIndex<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    valuesPhaseIndex <span class="hl opt">=</span> valuesPhase<span class="hl opt">[</span>index<span class="hl opt">];</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>index <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_zerothIsAccum<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_accum <span class="hl opt">=</span> value<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">=</span> gotAccum <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        valuesPhase<span class="hl opt">[</span>index<span class="hl opt">] = ((</span>valuesPhaseIndex <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span>
            <span class="hl opt">?</span> <span class="hl num">1</span> <span class="hl opt">:</span> <span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>index <span class="hl opt">=== -</span><span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_accum <span class="hl opt">=</span> value<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_gotAccum <span class="hl opt">=</span> gotAccum <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>valuesPhaseIndex <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
            valuesPhase<span class="hl opt">[</span>index<span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            valuesPhase<span class="hl opt">[</span>index<span class="hl opt">] =</span> <span class="hl num">2</span><span class="hl opt">;</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_accum <span class="hl opt">=</span> value<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>gotAccum<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> callback <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_callback<span class="hl opt">;</span>
    <span class="hl kwa">var</span> receiver <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_boundValue</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> ret<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_reducingIndex<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        valuesPhaseIndex <span class="hl opt">=</span> valuesPhase<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>valuesPhaseIndex <span class="hl opt">===</span> <span class="hl num">2</span><span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_reducingIndex <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwa">continue</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>valuesPhaseIndex <span class="hl opt">!==</span> <span class="hl num">1</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        value <span class="hl opt">=</span> values<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>isEach<span class="hl opt">) {</span>
            preservedValues<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
            ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>callback<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> value<span class="hl opt">,</span> i<span class="hl opt">,</span> length<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">else</span> <span class="hl opt">{</span>
            ret <span class="hl opt">=</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>callback<span class="hl opt">)</span>
                <span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>receiver<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_accum<span class="hl opt">,</span> value<span class="hl opt">,</span> i<span class="hl opt">,</span> length<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>ret <span class="hl opt">===</span> errorObj<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>ret<span class="hl opt">.</span>e<span class="hl opt">);</span>

        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            maybePromise <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isPending</span><span class="hl opt">()) {</span>
                valuesPhase<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">4</span><span class="hl opt">;</span>
                <span class="hl kwa">return</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_proxyPromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> i<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">()) {</span>
                ret <span class="hl opt">=</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_value</span><span class="hl opt">();</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>maybePromise<span class="hl opt">.</span><span class="hl kwd">_reason</span><span class="hl opt">());</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">this</span><span class="hl opt">.</span>_reducingIndex <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_accum <span class="hl opt">=</span> ret<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span>isEach <span class="hl opt">?</span> preservedValues <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_accum<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">reduce</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> initialValue<span class="hl opt">,</span> _each<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> array <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ReductionPromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> initialValue<span class="hl opt">,</span> _each<span class="hl opt">);</span>
    <span class="hl kwa">return</span> array<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reduce</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">,</span> initialValue<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">reduce</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> fn<span class="hl opt">,</span> initialValue<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">reduce</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> initialValue<span class="hl opt">,</span> _each<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">reduce</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> fn<span class="hl opt">,</span> initialValue<span class="hl opt">,</span> _each<span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./async.js&quot;</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">31</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> schedule<span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> <span class="hl kwd">noAsyncScheduler</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl str">&quot;No async scheduler available</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/m3OTXk</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<span class="hl opt">};</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>util<span class="hl opt">.</span>isNode <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> MutationObserver <span class="hl opt">===</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
    <span class="hl kwa">var</span> GlobalSetImmediate <span class="hl opt">=</span> global<span class="hl opt">.</span>setImmediate<span class="hl opt">;</span>
    <span class="hl kwa">var</span> ProcessNextTick <span class="hl opt">=</span> process<span class="hl opt">.</span>nextTick<span class="hl opt">;</span>
    schedule <span class="hl opt">=</span> util<span class="hl opt">.</span>isRecentNode
                <span class="hl opt">?</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span> GlobalSetImmediate<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>global<span class="hl opt">,</span> fn<span class="hl opt">); }</span>
                <span class="hl opt">:</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span> ProcessNextTick<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>process<span class="hl opt">,</span> fn<span class="hl opt">); };</span>
<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">((</span><span class="hl kwa">typeof</span> MutationObserver <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) &amp;&amp;</span>
          <span class="hl opt">!(</span><span class="hl kwa">typeof</span> window <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span>
            window<span class="hl opt">.</span>navigator <span class="hl opt">&amp;&amp;</span>
            window<span class="hl opt">.</span>navigator<span class="hl opt">.</span>standalone<span class="hl opt">)) {</span>
    <span class="hl kwd">schedule</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> div <span class="hl opt">=</span> document<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">&quot;div&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">var</span> observer <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">MutationObserver</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
        observer<span class="hl opt">.</span><span class="hl kwd">observe</span><span class="hl opt">(</span>div<span class="hl opt">, {</span>attributes<span class="hl opt">:</span> <span class="hl kwa">true</span><span class="hl opt">});</span>
        <span class="hl kwa">return function</span><span class="hl opt">() {</span> div<span class="hl opt">.</span>classList<span class="hl opt">.</span><span class="hl kwd">toggle</span><span class="hl opt">(</span><span class="hl str">&quot;foo&quot;</span><span class="hl opt">); };</span>
    <span class="hl opt">};</span>
    schedule<span class="hl opt">.</span>isStatic <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> setImmediate <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
    <span class="hl kwd">schedule</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
        <span class="hl kwd">setImmediate</span><span class="hl opt">(</span>fn<span class="hl opt">);</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> setTimeout <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">) {</span>
    <span class="hl kwd">schedule</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
        <span class="hl kwd">setTimeout</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">};</span>
<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    schedule <span class="hl opt">=</span> noAsyncScheduler<span class="hl opt">;</span>
<span class="hl opt">}</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> schedule<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">32</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span>
    <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">) {</span>
<span class="hl kwa">var</span> PromiseInspection <span class="hl opt">=</span> Promise<span class="hl opt">.</span>PromiseInspection<span class="hl opt">;</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">SettledPromiseArray</span><span class="hl opt">(</span>values<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>values<span class="hl opt">);</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>SettledPromiseArray<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>

SettledPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>index<span class="hl opt">,</span> inspection<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>index<span class="hl opt">] =</span> inspection<span class="hl opt">;</span>
    <span class="hl kwa">var</span> totalResolved <span class="hl opt">= ++</span><span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>totalResolved <span class="hl opt">&gt;=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_length<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

SettledPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseInspection</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">268435456</span><span class="hl opt">;</span>
    ret<span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> value<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseResolved</span><span class="hl opt">(</span>index<span class="hl opt">,</span> ret<span class="hl opt">);</span>
<span class="hl opt">};</span>
SettledPromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">,</span> index<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseInspection</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">134217728</span><span class="hl opt">;</span>
    ret<span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> reason<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_promiseResolved</span><span class="hl opt">(</span>index<span class="hl opt">,</span> ret<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwd">settle</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">SettledPromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">settle</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">SettledPromiseArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">).</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
<span class="hl opt">};</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">33</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span>
<span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> PromiseArray<span class="hl opt">,</span> apiRejection<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> RangeError <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">).</span>RangeError<span class="hl opt">;</span>
<span class="hl kwa">var</span> AggregateError <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">).</span>AggregateError<span class="hl opt">;</span>
<span class="hl kwa">var</span> isArray <span class="hl opt">=</span> util<span class="hl opt">.</span>isArray<span class="hl opt">;</span>


<span class="hl kwa">function</span> <span class="hl kwd">SomePromiseArray</span><span class="hl opt">(</span>values<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>values<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_howMany <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_unwrap <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_initialized <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
<span class="hl opt">}</span>
util<span class="hl opt">.</span><span class="hl kwd">inherits</span><span class="hl opt">(</span>SomePromiseArray<span class="hl opt">,</span> PromiseArray<span class="hl opt">);</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_init</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>_initialized<span class="hl opt">) {</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_howMany <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">([]);</span>
        <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_init<span class="hl opt">$(</span>undefined<span class="hl opt">, -</span><span class="hl num">5</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> isArrayResolved <span class="hl opt">=</span> <span class="hl kwd">isArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span><span class="hl opt">() &amp;&amp;</span>
        isArrayResolved <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_howMany <span class="hl opt">&gt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_canPossiblyFulfill</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getRangeError</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">()));</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">init</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_initialized <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_init</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">setUnwrap</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_unwrap <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">howMany</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_howMany<span class="hl opt">;</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">setHowMany</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>count<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_howMany <span class="hl opt">=</span> count<span class="hl opt">;</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_addFulfilled</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_fulfilled</span><span class="hl opt">() ===</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">howMany</span><span class="hl opt">()) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">howMany</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">howMany</span><span class="hl opt">() ===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_unwrap<span class="hl opt">) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_resolve</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

<span class="hl opt">};</span>
SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_promiseRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_addRejected</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">howMany</span><span class="hl opt">() &gt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_canPossiblyFulfill</span><span class="hl opt">()) {</span>
        <span class="hl kwa">var</span> e <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AggregateError</span><span class="hl opt">();</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            e<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span>i<span class="hl opt">]);</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_fulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">;</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_rejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_values<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_addRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_addFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>_values<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>_totalResolved<span class="hl opt">++] =</span> value<span class="hl opt">;</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_canPossiblyFulfill</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">length</span><span class="hl opt">() -</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_rejected</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_getRangeError</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>count<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> message <span class="hl opt">=</span> <span class="hl str">&quot;Input array must contain at least &quot;</span> <span class="hl opt">+</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>_howMany <span class="hl opt">+</span> <span class="hl str">&quot; items but contains only &quot;</span> <span class="hl opt">+</span> count <span class="hl opt">+</span> <span class="hl str">&quot; items&quot;</span><span class="hl opt">;</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">RangeError</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
<span class="hl opt">};</span>

SomePromiseArray<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_resolveEmptyArray</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_reject</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_getRangeError</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">));</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">some</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> howMany<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>howMany <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">) !==</span> howMany <span class="hl opt">||</span> howMany <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;expecting a positive integer</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/1wAmHx</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SomePromiseArray</span><span class="hl opt">(</span>promises<span class="hl opt">);</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> ret<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span><span class="hl kwd">setHowMany</span><span class="hl opt">(</span>howMany<span class="hl opt">);</span>
    ret<span class="hl opt">.</span><span class="hl kwd">init</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> promise<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwd">some</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promises<span class="hl opt">,</span> howMany<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">some</span><span class="hl opt">(</span>promises<span class="hl opt">,</span> howMany<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">some</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>howMany<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">some</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> howMany<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span>_SomePromiseArray <span class="hl opt">=</span> SomePromiseArray<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">34</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">) {</span>
<span class="hl kwa">function</span> <span class="hl kwd">PromiseInspection</span><span class="hl opt">(</span>promise<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl opt">!==</span> undefined<span class="hl opt">) {</span>
        promise <span class="hl opt">=</span> promise<span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> promise<span class="hl opt">.</span>_bitField<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> promise<span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">value</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isFulfilled</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;cannot get fulfillment value of a non-fulfilled promise</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/hc1DLj</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>error <span class="hl opt">=</span>
PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reason</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isRejected</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;cannot get rejection reason of a non-rejected promise</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/hPuiwB</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isFulfilled <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">268435456</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isRejected <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">134217728</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isPending <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isPending</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">402653184</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

PromiseInspection<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isResolved <span class="hl opt">=</span>
Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">402653184</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isPending</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_isPending</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isRejected</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_isRejected</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isFulfilled</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_isFulfilled</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">isResolved</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">().</span><span class="hl kwd">_isResolved</span><span class="hl opt">();</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_value</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_reason</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_unsetRejectionIsUnhandled</span><span class="hl opt">();</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">value</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> target <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>target<span class="hl opt">.</span><span class="hl kwd">isFulfilled</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;cannot get fulfillment value of a non-fulfilled promise</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/hc1DLj</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> target<span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">reason</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> target <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_target</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>target<span class="hl opt">.</span><span class="hl kwd">isRejected</span><span class="hl opt">()) {</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">(</span><span class="hl str">&quot;cannot get rejection reason of a non-rejected promise</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/hPuiwB</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    target<span class="hl opt">.</span><span class="hl kwd">_unsetRejectionIsUnhandled</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> target<span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
<span class="hl opt">};</span>


Promise<span class="hl opt">.</span>PromiseInspection <span class="hl opt">=</span> PromiseInspection<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{}],</span><span class="hl num">35</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> errorObj <span class="hl opt">=</span> util<span class="hl opt">.</span>errorObj<span class="hl opt">;</span>
<span class="hl kwa">var</span> isObject <span class="hl opt">=</span> util<span class="hl opt">.</span>isObject<span class="hl opt">;</span>

<span class="hl kwa">function</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> context<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isObject</span><span class="hl opt">(</span>obj<span class="hl opt">)) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>obj <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwd">isAnyBluebirdPromise</span><span class="hl opt">(</span>obj<span class="hl opt">)) {</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
            obj<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
                ret<span class="hl opt">.</span>_fulfillUnchecked<span class="hl opt">,</span>
                ret<span class="hl opt">.</span>_rejectUncheckedCheckError<span class="hl opt">,</span>
                ret<span class="hl opt">.</span>_progressUnchecked<span class="hl opt">,</span>
                ret<span class="hl opt">,</span>
                <span class="hl kwa">null</span>
            <span class="hl opt">);</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">var</span> then <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">tryCatch</span><span class="hl opt">(</span>getThen<span class="hl opt">)(</span>obj<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>then <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>context<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span>then<span class="hl opt">.</span>e<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>context<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> then <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">return</span> <span class="hl kwd">doThenable</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> then<span class="hl opt">,</span> context<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">getThen</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">.</span>then<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> hasProp <span class="hl opt">= {}.</span>hasOwnProperty<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">isAnyBluebirdPromise</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> hasProp<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> <span class="hl str">&quot;_promise0&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">doThenable</span><span class="hl opt">(</span>x<span class="hl opt">,</span> then<span class="hl opt">,</span> context<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> promise <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> promise<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>context<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_captureStackTrace</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>context<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> synchronous <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> result <span class="hl opt">=</span> util<span class="hl opt">.</span><span class="hl kwd">tryCatch</span><span class="hl opt">(</span>then<span class="hl opt">).</span><span class="hl kwd">call</span><span class="hl opt">(</span>x<span class="hl opt">,</span>
                                        resolveFromThenable<span class="hl opt">,</span>
                                        rejectFromThenable<span class="hl opt">,</span>
                                        progressFromThenable<span class="hl opt">);</span>
    synchronous <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>promise <span class="hl opt">&amp;&amp;</span> result <span class="hl opt">===</span> errorObj<span class="hl opt">) {</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>result<span class="hl opt">.</span>e<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">resolveFromThenable</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>promise<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_resolveCallback</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">rejectFromThenable</span><span class="hl opt">(</span>reason<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>promise<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        promise<span class="hl opt">.</span><span class="hl kwd">_rejectCallback</span><span class="hl opt">(</span>reason<span class="hl opt">,</span> synchronous<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
        promise <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">progressFromThenable</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>promise<span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> promise<span class="hl opt">.</span>_progress <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            promise<span class="hl opt">.</span><span class="hl kwd">_progress</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">return</span> tryConvertToPromise<span class="hl opt">;</span>
<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">36</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Promise<span class="hl opt">,</span> INTERNAL<span class="hl opt">) {</span>
<span class="hl kwa">var</span> util <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> TimeoutError <span class="hl opt">=</span> Promise<span class="hl opt">.</span>TimeoutError<span class="hl opt">;</span>

<span class="hl kwa">var</span> <span class="hl kwd">afterTimeout</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>promise<span class="hl opt">,</span> message<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>promise<span class="hl opt">.</span><span class="hl kwd">isPending</span><span class="hl opt">())</span> <span class="hl kwa">return</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> message <span class="hl opt">!==</span> <span class="hl str">&quot;string&quot;</span><span class="hl opt">) {</span>
        message <span class="hl opt">=</span> <span class="hl str">&quot;operation timed out&quot;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">var</span> err <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TimeoutError</span><span class="hl opt">(</span>message<span class="hl opt">);</span>
    util<span class="hl opt">.</span><span class="hl kwd">markAsOriginatingFromRejection</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_attachExtraTrace</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
    promise<span class="hl opt">.</span><span class="hl kwd">_cancel</span><span class="hl opt">(</span>err<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> <span class="hl kwd">afterValue</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>value<span class="hl opt">) {</span> <span class="hl kwa">return</span> <span class="hl kwd">delay</span><span class="hl opt">(+</span><span class="hl kwa">this</span><span class="hl opt">).</span><span class="hl kwd">thenReturn</span><span class="hl opt">(</span>value<span class="hl opt">); };</span>
<span class="hl kwa">var</span> delay <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">delay</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>value<span class="hl opt">,</span> ms<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>ms <span class="hl opt">===</span> undefined<span class="hl opt">) {</span>
        ms <span class="hl opt">=</span> value<span class="hl opt">;</span>
        value <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Promise</span><span class="hl opt">(</span>INTERNAL<span class="hl opt">);</span>
        <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span> ret<span class="hl opt">.</span><span class="hl kwd">_fulfill</span><span class="hl opt">(); },</span> ms<span class="hl opt">);</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    ms <span class="hl opt">= +</span>ms<span class="hl opt">;</span>
    <span class="hl kwa">return</span> Promise<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>value<span class="hl opt">).</span><span class="hl kwd">_then</span><span class="hl opt">(</span>afterValue<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> ms<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">delay</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>ms<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl kwd">delay</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> ms<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl kwa">function</span> <span class="hl kwd">successClear</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> handle <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>handle <span class="hl kwa">instanceof</span> Number<span class="hl opt">)</span> handle <span class="hl opt">= +</span>handle<span class="hl opt">;</span>
    <span class="hl kwd">clearTimeout</span><span class="hl opt">(</span>handle<span class="hl opt">);</span>
    <span class="hl kwa">return</span> value<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">failureClear</span><span class="hl opt">(</span>reason<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> handle <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>handle <span class="hl kwa">instanceof</span> Number<span class="hl opt">)</span> handle <span class="hl opt">= +</span>handle<span class="hl opt">;</span>
    <span class="hl kwd">clearTimeout</span><span class="hl opt">(</span>handle<span class="hl opt">);</span>
    <span class="hl kwa">throw</span> reason<span class="hl opt">;</span>
<span class="hl opt">}</span>

Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">timeout</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>ms<span class="hl opt">,</span> message<span class="hl opt">) {</span>
    ms <span class="hl opt">= +</span>ms<span class="hl opt">;</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">().</span><span class="hl kwd">cancellable</span><span class="hl opt">();</span>
    ret<span class="hl opt">.</span>_cancellationParent <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> handle <span class="hl opt">=</span> <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl kwd">timeoutTimeout</span><span class="hl opt">() {</span>
        <span class="hl kwd">afterTimeout</span><span class="hl opt">(</span>ret<span class="hl opt">,</span> message<span class="hl opt">);</span>
    <span class="hl opt">},</span> ms<span class="hl opt">);</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>successClear<span class="hl opt">,</span> failureClear<span class="hl opt">,</span> undefined<span class="hl opt">,</span> handle<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
<span class="hl opt">};</span>

<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">37</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
module<span class="hl opt">.</span><span class="hl kwd">exports</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>Promise<span class="hl opt">,</span> apiRejection<span class="hl opt">,</span> tryConvertToPromise<span class="hl opt">,</span>
    createContext<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> TypeError <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">).</span>TypeError<span class="hl opt">;</span>
    <span class="hl kwa">var</span> inherits <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">).</span>inherits<span class="hl opt">;</span>
    <span class="hl kwa">var</span> PromiseInspection <span class="hl opt">=</span> Promise<span class="hl opt">.</span>PromiseInspection<span class="hl opt">;</span>

    <span class="hl kwa">function</span> <span class="hl kwd">inspectionMapper</span><span class="hl opt">(</span>inspections<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> len <span class="hl opt">=</span> inspections<span class="hl opt">.</span>length<span class="hl opt">;</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> inspection <span class="hl opt">=</span> inspections<span class="hl opt">[</span>i<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>inspection<span class="hl opt">.</span><span class="hl kwd">isRejected</span><span class="hl opt">()) {</span>
                <span class="hl kwa">return</span> Promise<span class="hl opt">.</span><span class="hl kwd">reject</span><span class="hl opt">(</span>inspection<span class="hl opt">.</span><span class="hl kwd">error</span><span class="hl opt">());</span>
            <span class="hl opt">}</span>
            inspections<span class="hl opt">[</span>i<span class="hl opt">] =</span> inspection<span class="hl opt">.</span>_settledValue<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> inspections<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">thrower</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwd">setTimeout</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(){</span><span class="hl kwa">throw</span> e<span class="hl opt">;},</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">castPreservingDisposable</span><span class="hl opt">(</span>thenable<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>thenable<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl opt">!==</span> thenable <span class="hl opt">&amp;&amp;</span>
            <span class="hl kwa">typeof</span> thenable<span class="hl opt">.</span>_isDisposable <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span>
            <span class="hl kwa">typeof</span> thenable<span class="hl opt">.</span>_getDisposer <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span>
            thenable<span class="hl opt">.</span><span class="hl kwd">_isDisposable</span><span class="hl opt">()) {</span>
            maybePromise<span class="hl opt">.</span><span class="hl kwd">_setDisposable</span><span class="hl opt">(</span>thenable<span class="hl opt">.</span><span class="hl kwd">_getDisposer</span><span class="hl opt">());</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> maybePromise<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">function</span> <span class="hl kwd">dispose</span><span class="hl opt">(</span>resources<span class="hl opt">,</span> inspection<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> len <span class="hl opt">=</span> resources<span class="hl opt">.</span>length<span class="hl opt">;</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">defer</span><span class="hl opt">();</span>
        <span class="hl kwa">function</span> <span class="hl kwd">iterator</span><span class="hl opt">() {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;=</span> len<span class="hl opt">)</span> <span class="hl kwa">return</span> ret<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">();</span>
            <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">castPreservingDisposable</span><span class="hl opt">(</span>resources<span class="hl opt">[</span>i<span class="hl opt">++]);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise <span class="hl opt">&amp;&amp;</span>
                maybePromise<span class="hl opt">.</span><span class="hl kwd">_isDisposable</span><span class="hl opt">()) {</span>
                <span class="hl kwa">try</span> <span class="hl opt">{</span>
                    maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>
                        maybePromise<span class="hl opt">.</span><span class="hl kwd">_getDisposer</span><span class="hl opt">().</span><span class="hl kwd">tryDispose</span><span class="hl opt">(</span>inspection<span class="hl opt">),</span>
                        resources<span class="hl opt">.</span>promise<span class="hl opt">);</span>
                <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
                    <span class="hl kwa">return</span> <span class="hl kwd">thrower</span><span class="hl opt">(</span>e<span class="hl opt">);</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
                    <span class="hl kwa">return</span> maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>iterator<span class="hl opt">,</span> thrower<span class="hl opt">,</span>
                                              <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
            <span class="hl kwd">iterator</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwd">iterator</span><span class="hl opt">();</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">.</span>promise<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">disposerSuccess</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> inspection <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseInspection</span><span class="hl opt">();</span>
        inspection<span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> value<span class="hl opt">;</span>
        inspection<span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">268435456</span><span class="hl opt">;</span>
        <span class="hl kwa">return</span> <span class="hl kwd">dispose</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> inspection<span class="hl opt">).</span><span class="hl kwd">thenReturn</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">disposerFail</span><span class="hl opt">(</span>reason<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> inspection <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">PromiseInspection</span><span class="hl opt">();</span>
        inspection<span class="hl opt">.</span>_settledValue <span class="hl opt">=</span> reason<span class="hl opt">;</span>
        inspection<span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl num">134217728</span><span class="hl opt">;</span>
        <span class="hl kwa">return</span> <span class="hl kwd">dispose</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> inspection<span class="hl opt">).</span><span class="hl kwd">thenThrow</span><span class="hl opt">(</span>reason<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">function</span> <span class="hl kwd">Disposer</span><span class="hl opt">(</span>data<span class="hl opt">,</span> promise<span class="hl opt">,</span> context<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_data <span class="hl opt">=</span> data<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise <span class="hl opt">=</span> promise<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_context <span class="hl opt">=</span> context<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    Disposer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">data</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>_data<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Disposer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">promise</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>_promise<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Disposer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">resource</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">().</span><span class="hl kwd">isFulfilled</span><span class="hl opt">()) {</span>
            <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">().</span><span class="hl kwd">value</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return null</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Disposer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">tryDispose</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>inspection<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> resource <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">resource</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> context <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_context<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>context <span class="hl opt">!==</span> undefined<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
        <span class="hl kwa">var</span> ret <span class="hl opt">=</span> resource <span class="hl opt">!==</span> <span class="hl kwa">null</span>
            <span class="hl opt">?</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">doDispose</span><span class="hl opt">(</span>resource<span class="hl opt">,</span> inspection<span class="hl opt">) :</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>context <span class="hl opt">!==</span> undefined<span class="hl opt">)</span> context<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_promise<span class="hl opt">.</span><span class="hl kwd">_unsetDisposable</span><span class="hl opt">();</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_data <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Disposer<span class="hl opt">.</span><span class="hl kwd">isDisposer</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>d<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">(</span>d <span class="hl opt">!=</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span>
                <span class="hl kwa">typeof</span> d<span class="hl opt">.</span>resource <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span> <span class="hl opt">&amp;&amp;</span>
                <span class="hl kwa">typeof</span> d<span class="hl opt">.</span>tryDispose <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">);</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">function</span> <span class="hl kwd">FunctionDisposer</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> promise<span class="hl opt">,</span> context<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$(</span>fn<span class="hl opt">,</span> promise<span class="hl opt">,</span> context<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">inherits</span><span class="hl opt">(</span>FunctionDisposer<span class="hl opt">,</span> Disposer<span class="hl opt">);</span>

    FunctionDisposer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">doDispose</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>resource<span class="hl opt">,</span> inspection<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> fn <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">data</span><span class="hl opt">();</span>
        <span class="hl kwa">return</span> fn<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>resource<span class="hl opt">,</span> resource<span class="hl opt">,</span> inspection<span class="hl opt">);</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">function</span> <span class="hl kwd">maybeUnwrapDisposer</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>Disposer<span class="hl opt">.</span><span class="hl kwd">isDisposer</span><span class="hl opt">(</span>value<span class="hl opt">)) {</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>resources<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>index<span class="hl opt">].</span><span class="hl kwd">_setDisposable</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
            <span class="hl kwa">return</span> value<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> value<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    Promise<span class="hl opt">.</span><span class="hl kwd">using</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">var</span> len <span class="hl opt">=</span> arguments<span class="hl opt">.</span>length<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>len <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span>
                        <span class="hl str">&quot;you must pass at least 2 arguments to Promise.using&quot;</span><span class="hl opt">);</span>
        <span class="hl kwa">var</span> fn <span class="hl opt">=</span> arguments<span class="hl opt">[</span>len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">!==</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl kwd">apiRejection</span><span class="hl opt">(</span><span class="hl str">&quot;fn must be a function</span><span class="hl esc">\u000a\u000a</span>    <span class="hl str">See http://goo.gl/916lJJ</span><span class="hl esc">\u000a</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
        len<span class="hl opt">--;</span>
        <span class="hl kwa">var</span> resources <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len<span class="hl opt">);</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> resource <span class="hl opt">=</span> arguments<span class="hl opt">[</span>i<span class="hl opt">];</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>Disposer<span class="hl opt">.</span><span class="hl kwd">isDisposer</span><span class="hl opt">(</span>resource<span class="hl opt">)) {</span>
                <span class="hl kwa">var</span> disposer <span class="hl opt">=</span> resource<span class="hl opt">;</span>
                resource <span class="hl opt">=</span> resource<span class="hl opt">.</span><span class="hl kwd">promise</span><span class="hl opt">();</span>
                resource<span class="hl opt">.</span><span class="hl kwd">_setDisposable</span><span class="hl opt">(</span>disposer<span class="hl opt">);</span>
            <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                <span class="hl kwa">var</span> maybePromise <span class="hl opt">=</span> <span class="hl kwd">tryConvertToPromise</span><span class="hl opt">(</span>resource<span class="hl opt">);</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>maybePromise <span class="hl kwa">instanceof</span> Promise<span class="hl opt">) {</span>
                    resource <span class="hl opt">=</span>
                        maybePromise<span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>maybeUnwrapDisposer<span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">, {</span>
                            resources<span class="hl opt">:</span> resources<span class="hl opt">,</span>
                            index<span class="hl opt">:</span> i
                    <span class="hl opt">},</span> undefined<span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
            resources<span class="hl opt">[</span>i<span class="hl opt">] =</span> resource<span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">var</span> promise <span class="hl opt">=</span> Promise<span class="hl opt">.</span><span class="hl kwd">settle</span><span class="hl opt">(</span>resources<span class="hl opt">)</span>
            <span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">(</span>inspectionMapper<span class="hl opt">)</span>
            <span class="hl opt">.</span><span class="hl kwd">then</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>vals<span class="hl opt">) {</span>
                promise<span class="hl opt">.</span><span class="hl kwd">_pushContext</span><span class="hl opt">();</span>
                <span class="hl kwa">var</span> ret<span class="hl opt">;</span>
                <span class="hl kwa">try</span> <span class="hl opt">{</span>
                    ret <span class="hl opt">=</span> fn<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>undefined<span class="hl opt">,</span> vals<span class="hl opt">);</span>
                <span class="hl opt">}</span> <span class="hl kwa">finally</span> <span class="hl opt">{</span>
                    promise<span class="hl opt">.</span><span class="hl kwd">_popContext</span><span class="hl opt">();</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
            <span class="hl opt">})</span>
            <span class="hl opt">.</span><span class="hl kwd">_then</span><span class="hl opt">(</span>
                disposerSuccess<span class="hl opt">,</span> disposerFail<span class="hl opt">,</span> undefined<span class="hl opt">,</span> resources<span class="hl opt">,</span> undefined<span class="hl opt">);</span>
        resources<span class="hl opt">.</span>promise <span class="hl opt">=</span> promise<span class="hl opt">;</span>
        <span class="hl kwa">return</span> promise<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_setDisposable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>disposer<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">|</span> <span class="hl num">262144</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_disposer <span class="hl opt">=</span> disposer<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_isDisposable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp;</span> <span class="hl num">262144</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_getDisposer</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>_disposer<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_unsetDisposable</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>_bitField <span class="hl opt">&amp; (~</span><span class="hl num">262144</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>_disposer <span class="hl opt">=</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Promise<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">disposer</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>fn<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">return new</span> <span class="hl kwd">FunctionDisposer</span><span class="hl opt">(</span>fn<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwd">createContext</span><span class="hl opt">());</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">throw new</span> <span class="hl kwd">TypeError</span><span class="hl opt">();</span>
    <span class="hl opt">};</span>

<span class="hl opt">};</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./errors.js&quot;</span><span class="hl opt">:</span><span class="hl num">13</span><span class="hl opt">,</span><span class="hl str">&quot;./util.js&quot;</span><span class="hl opt">:</span><span class="hl num">38</span><span class="hl opt">}],</span><span class="hl num">38</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>_dereq_<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl str">&quot;use strict&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> es5 <span class="hl opt">=</span> <span class="hl kwd">_dereq_</span><span class="hl opt">(</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> canEvaluate <span class="hl opt">=</span> <span class="hl kwa">typeof</span> navigator <span class="hl opt">==</span> <span class="hl str">&quot;undefined&quot;</span><span class="hl opt">;</span>
<span class="hl kwa">var</span> haveGetters <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">(){</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> o <span class="hl opt">= {};</span>
        es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>o<span class="hl opt">,</span> <span class="hl str">&quot;f&quot;</span><span class="hl opt">, {</span>
            <span class="hl kwa">get</span><span class="hl opt">:</span> <span class="hl kwa">function</span> <span class="hl opt">() {</span>
                <span class="hl kwa">return</span> <span class="hl num">3</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">});</span>
        <span class="hl kwa">return</span> o<span class="hl opt">.</span>f <span class="hl opt">===</span> <span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

<span class="hl opt">})();</span>

<span class="hl kwa">var</span> errorObj <span class="hl opt">= {</span>e<span class="hl opt">: {}};</span>
<span class="hl kwa">var</span> tryCatchTarget<span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">tryCatcher</span><span class="hl opt">() {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> target <span class="hl opt">=</span> tryCatchTarget<span class="hl opt">;</span>
        tryCatchTarget <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">return</span> target<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        errorObj<span class="hl opt">.</span>e <span class="hl opt">=</span> e<span class="hl opt">;</span>
        <span class="hl kwa">return</span> errorObj<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>
<span class="hl kwa">function</span> <span class="hl kwd">tryCatch</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    tryCatchTarget <span class="hl opt">=</span> fn<span class="hl opt">;</span>
    <span class="hl kwa">return</span> tryCatcher<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> <span class="hl kwd">inherits</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>Child<span class="hl opt">,</span> Parent<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> hasProp <span class="hl opt">= {}.</span>hasOwnProperty<span class="hl opt">;</span>

    <span class="hl kwa">function</span> <span class="hl kwd">T</span><span class="hl opt">() {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>constructor <span class="hl opt">=</span> Child<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>constructor<span class="hl opt">$ =</span> Parent<span class="hl opt">;</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> propertyName <span class="hl kwa">in</span> Parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>hasProp<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>Parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span> propertyName<span class="hl opt">) &amp;&amp;</span>
                propertyName<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span>propertyName<span class="hl opt">.</span>length<span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">) !==</span> <span class="hl str">&quot;$&quot;</span>
           <span class="hl opt">) {</span>
                <span class="hl kwa">this</span><span class="hl opt">[</span>propertyName <span class="hl opt">+</span> <span class="hl str">&quot;$&quot;</span><span class="hl opt">] =</span> Parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">[</span>propertyName<span class="hl opt">];</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    T<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> Parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>
    Child<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">T</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> Child<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>
<span class="hl opt">};</span>


<span class="hl kwa">function</span> <span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> val <span class="hl opt">==</span> <span class="hl kwa">null</span> <span class="hl opt">||</span> val <span class="hl opt">===</span> <span class="hl kwa">true</span> <span class="hl opt">||</span> val <span class="hl opt">===</span> <span class="hl kwa">false</span> <span class="hl opt">||</span>
        <span class="hl kwa">typeof</span> val <span class="hl opt">===</span> <span class="hl str">&quot;string&quot;</span> <span class="hl opt">||</span> <span class="hl kwa">typeof</span> val <span class="hl opt">===</span> <span class="hl str">&quot;number&quot;</span><span class="hl opt">;</span>

<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">isObject</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl opt">!</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>value<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">maybeWrapAsError</span><span class="hl opt">(</span>maybeError<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>maybeError<span class="hl opt">))</span> <span class="hl kwa">return</span> maybeError<span class="hl opt">;</span>

    <span class="hl kwa">return new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl kwd">safeToString</span><span class="hl opt">(</span>maybeError<span class="hl opt">));</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">withAppended</span><span class="hl opt">(</span>target<span class="hl opt">,</span> appendee<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> target<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>len <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> i<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        ret<span class="hl opt">[</span>i<span class="hl opt">] =</span> target<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>
    ret<span class="hl opt">[</span>i<span class="hl opt">] =</span> appendee<span class="hl opt">;</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">getDataPropertyOrDefault</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">,</span> defaultValue<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>es5<span class="hl opt">.</span>isES5<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> desc <span class="hl opt">=</span> Object<span class="hl opt">.</span><span class="hl kwd">getOwnPropertyDescriptor</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">);</span>

        <span class="hl kwa">if</span> <span class="hl opt">(</span>desc <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
            <span class="hl kwa">return</span> desc<span class="hl opt">.</span><span class="hl kwa">get</span> <span class="hl opt">==</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> desc<span class="hl opt">.</span><span class="hl kwa">set</span> <span class="hl opt">==</span> <span class="hl kwa">null</span>
                    <span class="hl opt">?</span> desc<span class="hl opt">.</span>value
                    <span class="hl opt">:</span> defaultValue<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return</span> <span class="hl opt">{}.</span>hasOwnProperty<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">) ?</span> obj<span class="hl opt">[</span>key<span class="hl opt">] :</span> undefined<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> name<span class="hl opt">,</span> value<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isPrimitive</span><span class="hl opt">(</span>obj<span class="hl opt">))</span> <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
    <span class="hl kwa">var</span> descriptor <span class="hl opt">= {</span>
        value<span class="hl opt">:</span> value<span class="hl opt">,</span>
        configurable<span class="hl opt">:</span> <span class="hl kwa">true</span><span class="hl opt">,</span>
        enumerable<span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">,</span>
        writable<span class="hl opt">:</span> <span class="hl kwa">true</span>
    <span class="hl opt">};</span>
    es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> name<span class="hl opt">,</span> descriptor<span class="hl opt">);</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">thrower</span><span class="hl opt">(</span>r<span class="hl opt">) {</span>
    <span class="hl kwa">throw</span> r<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> inheritedDataKeys <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> excludedPrototypes <span class="hl opt">= [</span>
        Array<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span>
        Object<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">,</span>
        Function<span class="hl opt">.</span><span class="hl kwa">prototype</span>
    <span class="hl opt">];</span>

    <span class="hl kwa">var</span> <span class="hl kwd">isExcludedProto</span> <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>val<span class="hl opt">) {</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> excludedPrototypes<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>excludedPrototypes<span class="hl opt">[</span>i<span class="hl opt">] ===</span> val<span class="hl opt">) {</span>
                <span class="hl kwa">return true</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>es5<span class="hl opt">.</span>isES5<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> getKeys <span class="hl opt">=</span> Object<span class="hl opt">.</span>getOwnPropertyNames<span class="hl opt">;</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">= [];</span>
            <span class="hl kwa">var</span> visitedKeys <span class="hl opt">=</span> Object<span class="hl opt">.</span><span class="hl kwd">create</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
            <span class="hl kwa">while</span> <span class="hl opt">(</span>obj <span class="hl opt">!=</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp; !</span><span class="hl kwd">isExcludedProto</span><span class="hl opt">(</span>obj<span class="hl opt">)) {</span>
                <span class="hl kwa">var</span> keys<span class="hl opt">;</span>
                <span class="hl kwa">try</span> <span class="hl opt">{</span>
                    keys <span class="hl opt">=</span> <span class="hl kwd">getKeys</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
                <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
                    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> keys<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
                    <span class="hl kwa">var</span> key <span class="hl opt">=</span> keys<span class="hl opt">[</span>i<span class="hl opt">];</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>visitedKeys<span class="hl opt">[</span>key<span class="hl opt">])</span> <span class="hl kwa">continue</span><span class="hl opt">;</span>
                    visitedKeys<span class="hl opt">[</span>key<span class="hl opt">] =</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
                    <span class="hl kwa">var</span> desc <span class="hl opt">=</span> Object<span class="hl opt">.</span><span class="hl kwd">getOwnPropertyDescriptor</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">);</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>desc <span class="hl opt">!=</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> desc<span class="hl opt">.</span><span class="hl kwa">get</span> <span class="hl opt">==</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> desc<span class="hl opt">.</span><span class="hl kwa">set</span> <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
                        ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
                obj <span class="hl opt">=</span> es5<span class="hl opt">.</span><span class="hl kwd">getPrototypeOf</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">var</span> hasProp <span class="hl opt">= {}.</span>hasOwnProperty<span class="hl opt">;</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">isExcludedProto</span><span class="hl opt">(</span>obj<span class="hl opt">))</span> <span class="hl kwa">return</span> <span class="hl opt">[];</span>
            <span class="hl kwa">var</span> ret <span class="hl opt">= [];</span>

            <span class="hl com">/*jshint forin:false */</span>
            enumeration<span class="hl opt">:</span> <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> key <span class="hl kwa">in</span> obj<span class="hl opt">) {</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>hasProp<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> key<span class="hl opt">)) {</span>
                    ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
                <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
                    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> excludedPrototypes<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
                        <span class="hl kwa">if</span> <span class="hl opt">(</span>hasProp<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>excludedPrototypes<span class="hl opt">[</span>i<span class="hl opt">],</span> key<span class="hl opt">)) {</span>
                            <span class="hl kwa">continue</span> enumeration<span class="hl opt">;</span>
                        <span class="hl opt">}</span>
                    <span class="hl opt">}</span>
                    ret<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>

<span class="hl opt">})();</span>

<span class="hl kwa">var</span> thisAssignmentPattern <span class="hl opt">=</span> <span class="hl kwc">/this\s*\.\s*\S+\s*=/</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">isClass</span><span class="hl opt">(</span>fn<span class="hl opt">) {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> fn <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">) {</span>
            <span class="hl kwa">var</span> keys <span class="hl opt">=</span> es5<span class="hl opt">.</span><span class="hl kwd">names</span><span class="hl opt">(</span>fn<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">);</span>

            <span class="hl kwa">var</span> hasMethods <span class="hl opt">=</span> es5<span class="hl opt">.</span>isES5 <span class="hl opt">&amp;&amp;</span> keys<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwa">var</span> hasMethodsOtherThanConstructor <span class="hl opt">=</span> keys<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span>
                <span class="hl opt">!(</span>keys<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> keys<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl str">&quot;constructor&quot;</span><span class="hl opt">);</span>
            <span class="hl kwa">var</span> hasThisAssignmentAndStaticMethods <span class="hl opt">=</span>
                thisAssignmentPattern<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>fn <span class="hl opt">+</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">) &amp;&amp;</span> es5<span class="hl opt">.</span><span class="hl kwd">names</span><span class="hl opt">(</span>fn<span class="hl opt">).</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>

            <span class="hl kwa">if</span> <span class="hl opt">(</span>hasMethods <span class="hl opt">||</span> hasMethodsOtherThanConstructor <span class="hl opt">||</span>
                hasThisAssignmentAndStaticMethods<span class="hl opt">) {</span>
                <span class="hl kwa">return true</span><span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">toFastProperties</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl com">/*jshint -W027,-W055,-W031*/</span>
    <span class="hl kwa">function</span> <span class="hl kwd">f</span><span class="hl opt">() {}</span>
    f<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> obj<span class="hl opt">;</span>
    <span class="hl kwa">var</span> l <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">;</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>l<span class="hl opt">--)</span> <span class="hl kwa">new</span> <span class="hl kwd">f</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> obj<span class="hl opt">;</span>
    <span class="hl kwd">eval</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> rident <span class="hl opt">=</span> <span class="hl kwc">/^[a-z$_][a-z$_0-9]*$/i</span><span class="hl opt">;</span>
<span class="hl kwa">function</span> <span class="hl kwd">isIdentifier</span><span class="hl opt">(</span>str<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> rident<span class="hl opt">.</span><span class="hl kwd">test</span><span class="hl opt">(</span>str<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">filledRange</span><span class="hl opt">(</span>count<span class="hl opt">,</span> prefix<span class="hl opt">,</span> suffix<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ret <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>count<span class="hl opt">);</span>
    <span class="hl kwa">for</span><span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> count<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        ret<span class="hl opt">[</span>i<span class="hl opt">] =</span> prefix <span class="hl opt">+</span> i <span class="hl opt">+</span> suffix<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> ret<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">safeToString</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwa">return</span> obj <span class="hl opt">+</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl str">&quot;[no string representation]&quot;</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">markAsOriginatingFromRejection</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
    <span class="hl kwa">try</span> <span class="hl opt">{</span>
        <span class="hl kwd">notEnumerableProp</span><span class="hl opt">(</span>e<span class="hl opt">,</span> <span class="hl str">&quot;isOperational&quot;</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">catch</span><span class="hl opt">(</span>ignore<span class="hl opt">) {}</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">originatesFromRejection</span><span class="hl opt">(</span>e<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>e <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span> <span class="hl kwa">return false</span><span class="hl opt">;</span>
    <span class="hl kwa">return</span> <span class="hl opt">((</span>e <span class="hl kwa">instanceof</span> Error<span class="hl opt">[</span><span class="hl str">&quot;__BluebirdErrorTypes__&quot;</span><span class="hl opt">].</span>OperationalError<span class="hl opt">) ||</span>
        e<span class="hl opt">[</span><span class="hl str">&quot;isOperational&quot;</span><span class="hl opt">] ===</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">canAttachTrace</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> obj <span class="hl kwa">instanceof</span> Error <span class="hl opt">&amp;&amp;</span> es5<span class="hl opt">.</span><span class="hl kwd">propertyIsWritable</span><span class="hl opt">(</span>obj<span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> ensureErrorObject <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!(</span><span class="hl str">&quot;stack&quot;</span> <span class="hl kwa">in new</span> <span class="hl kwd">Error</span><span class="hl opt">())) {</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">canAttachTrace</span><span class="hl opt">(</span>value<span class="hl opt">))</span> <span class="hl kwa">return</span> value<span class="hl opt">;</span>
            <span class="hl kwa">try</span> <span class="hl opt">{</span><span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl kwd">safeToString</span><span class="hl opt">(</span>value<span class="hl opt">));}</span>
            <span class="hl kwa">catch</span><span class="hl opt">(</span>err<span class="hl opt">) {</span><span class="hl kwa">return</span> err<span class="hl opt">;}</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return function</span><span class="hl opt">(</span>value<span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">canAttachTrace</span><span class="hl opt">(</span>value<span class="hl opt">))</span> <span class="hl kwa">return</span> value<span class="hl opt">;</span>
            <span class="hl kwa">return new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span><span class="hl kwd">safeToString</span><span class="hl opt">(</span>value<span class="hl opt">));</span>
        <span class="hl opt">};</span>
    <span class="hl opt">}</span>
<span class="hl opt">})();</span>

<span class="hl kwa">function</span> <span class="hl kwd">classString</span><span class="hl opt">(</span>obj<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl opt">{}.</span>toString<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>obj<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">copyDescriptors</span><span class="hl opt">(</span>from<span class="hl opt">,</span> to<span class="hl opt">,</span> filter<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> keys <span class="hl opt">=</span> es5<span class="hl opt">.</span><span class="hl kwd">names</span><span class="hl opt">(</span>from<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> keys<span class="hl opt">.</span>length<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> key <span class="hl opt">=</span> keys<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">filter</span><span class="hl opt">(</span>key<span class="hl opt">)) {</span>
            <span class="hl kwa">try</span> <span class="hl opt">{</span>
                es5<span class="hl opt">.</span><span class="hl kwd">defineProperty</span><span class="hl opt">(</span>to<span class="hl opt">,</span> key<span class="hl opt">,</span> es5<span class="hl opt">.</span><span class="hl kwd">getDescriptor</span><span class="hl opt">(</span>from<span class="hl opt">,</span> key<span class="hl opt">));</span>
            <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>ignore<span class="hl opt">) {}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> ret <span class="hl opt">= {</span>
    isClass<span class="hl opt">:</span> isClass<span class="hl opt">,</span>
    isIdentifier<span class="hl opt">:</span> isIdentifier<span class="hl opt">,</span>
    inheritedDataKeys<span class="hl opt">:</span> inheritedDataKeys<span class="hl opt">,</span>
    getDataPropertyOrDefault<span class="hl opt">:</span> getDataPropertyOrDefault<span class="hl opt">,</span>
    thrower<span class="hl opt">:</span> thrower<span class="hl opt">,</span>
    isArray<span class="hl opt">:</span> es5<span class="hl opt">.</span>isArray<span class="hl opt">,</span>
    haveGetters<span class="hl opt">:</span> haveGetters<span class="hl opt">,</span>
    notEnumerableProp<span class="hl opt">:</span> notEnumerableProp<span class="hl opt">,</span>
    isPrimitive<span class="hl opt">:</span> isPrimitive<span class="hl opt">,</span>
    isObject<span class="hl opt">:</span> isObject<span class="hl opt">,</span>
    canEvaluate<span class="hl opt">:</span> canEvaluate<span class="hl opt">,</span>
    errorObj<span class="hl opt">:</span> errorObj<span class="hl opt">,</span>
    tryCatch<span class="hl opt">:</span> tryCatch<span class="hl opt">,</span>
    inherits<span class="hl opt">:</span> inherits<span class="hl opt">,</span>
    withAppended<span class="hl opt">:</span> withAppended<span class="hl opt">,</span>
    maybeWrapAsError<span class="hl opt">:</span> maybeWrapAsError<span class="hl opt">,</span>
    toFastProperties<span class="hl opt">:</span> toFastProperties<span class="hl opt">,</span>
    filledRange<span class="hl opt">:</span> filledRange<span class="hl opt">,</span>
    toString<span class="hl opt">:</span> safeToString<span class="hl opt">,</span>
    canAttachTrace<span class="hl opt">:</span> canAttachTrace<span class="hl opt">,</span>
    ensureErrorObject<span class="hl opt">:</span> ensureErrorObject<span class="hl opt">,</span>
    originatesFromRejection<span class="hl opt">:</span> originatesFromRejection<span class="hl opt">,</span>
    markAsOriginatingFromRejection<span class="hl opt">:</span> markAsOriginatingFromRejection<span class="hl opt">,</span>
    classString<span class="hl opt">:</span> classString<span class="hl opt">,</span>
    copyDescriptors<span class="hl opt">:</span> copyDescriptors<span class="hl opt">,</span>
    hasDevTools<span class="hl opt">:</span> <span class="hl kwa">typeof</span> chrome <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span> chrome <span class="hl opt">&amp;&amp;</span>
                 <span class="hl kwa">typeof</span> chrome<span class="hl opt">.</span>loadTimes <span class="hl opt">===</span> <span class="hl str">&quot;function&quot;</span><span class="hl opt">,</span>
    isNode<span class="hl opt">:</span> <span class="hl kwa">typeof</span> process <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span>
        <span class="hl kwd">classString</span><span class="hl opt">(</span>process<span class="hl opt">).</span><span class="hl kwd">toLowerCase</span><span class="hl opt">() ===</span> <span class="hl str">&quot;[object process]&quot;</span>
<span class="hl opt">};</span>
ret<span class="hl opt">.</span>isRecentNode <span class="hl opt">=</span> ret<span class="hl opt">.</span>isNode <span class="hl opt">&amp;&amp; (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
    <span class="hl kwa">var</span> version <span class="hl opt">=</span> process<span class="hl opt">.</span>versions<span class="hl opt">.</span>node<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;.&quot;</span><span class="hl opt">).</span><span class="hl kwd">map</span><span class="hl opt">(</span>Number<span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span>version<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> version<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] &gt;</span> <span class="hl num">10</span><span class="hl opt">) || (</span>version<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;</span> <span class="hl num">0</span><span class="hl opt">);</span>
<span class="hl opt">})();</span>

<span class="hl kwa">if</span> <span class="hl opt">(</span>ret<span class="hl opt">.</span>isNode<span class="hl opt">)</span> ret<span class="hl opt">.</span><span class="hl kwd">toFastProperties</span><span class="hl opt">(</span>process<span class="hl opt">);</span>

<span class="hl kwa">try</span> <span class="hl opt">{</span><span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(); }</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>ret<span class="hl opt">.</span>lastLineError <span class="hl opt">=</span> e<span class="hl opt">;}</span>
module<span class="hl opt">.</span>exports <span class="hl opt">=</span> ret<span class="hl opt">;</span>

<span class="hl opt">},{</span><span class="hl str">&quot;./es5.js&quot;</span><span class="hl opt">:</span><span class="hl num">14</span><span class="hl opt">}]},{},[</span><span class="hl num">4</span><span class="hl opt">])(</span><span class="hl num">4</span><span class="hl opt">)</span>
<span class="hl opt">});                    ;</span><span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> window <span class="hl opt">!==</span> <span class="hl str">'undefined'</span> <span class="hl opt">&amp;&amp;</span> window <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>                               window<span class="hl opt">.</span>P <span class="hl opt">=</span> window<span class="hl opt">.</span>Promise<span class="hl opt">;                                                     }</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> self <span class="hl opt">!==</span> <span class="hl str">'undefined'</span> <span class="hl opt">&amp;&amp;</span> self <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>                             self<span class="hl opt">.</span>P <span class="hl opt">=</span> self<span class="hl opt">.</span>Promise<span class="hl opt">;                                                         }</span>
<span class="hl opt">}).</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'_process'</span><span class="hl opt">),</span><span class="hl kwa">typeof</span> global <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">?</span> global <span class="hl opt">:</span> <span class="hl kwa">typeof</span> self <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">?</span> self <span class="hl opt">:</span> <span class="hl kwa">typeof</span> window <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">?</span> window <span class="hl opt">: {})</span>
<span class="hl slc">//# sourceMappingURL=data:application/json;charset:utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9ibHVlYmlyZC9qcy9icm93c2VyL2JsdWViaXJkLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBwcmVzZXJ2ZVxuICogVGhlIE1JVCBMaWNlbnNlIChNSVQpXG4gKiBcbiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92XG4gKiBcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqIFxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICogXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gKiBUSEUgU09GVFdBUkUuXG4gKiBcbiAqL1xuLyoqXG4gKiBibHVlYmlyZCBidWlsZCB2ZXJzaW9uIDIuOS4zNFxuICogRmVhdHVyZXMgZW5hYmxlZDogY29yZSwgcmFjZSwgY2FsbF9nZXQsIGdlbmVyYXRvcnMsIG1hcCwgbm9kZWlmeSwgcHJvbWlzaWZ5LCBwcm9wcywgcmVkdWNlLCBzZXR0bGUsIHNvbWUsIGNhbmNlbCwgdXNpbmcsIGZpbHRlciwgYW55LCBlYWNoLCB0aW1lcnNcbiovXG4hZnVuY3Rpb24oZSl7aWYoXCJvYmplY3RcIj09dHlwZW9mIGV4cG9ydHMmJlwidW5kZWZpbmVkXCIhPXR5cGVvZiBtb2R1bGUpbW9kdWxlLmV4cG9ydHM9ZSgpO2Vsc2UgaWYoXCJmdW5jdGlvblwiPT10eXBlb2YgZGVmaW5lJiZkZWZpbmUuYW1kKWRlZmluZShbXSxlKTtlbHNle3ZhciBmO1widW5kZWZpbmVkXCIhPXR5cGVvZiB3aW5kb3c/Zj13aW5kb3c6XCJ1bmRlZmluZWRcIiE9dHlwZW9mIGdsb2JhbD9mPWdsb2JhbDpcInVuZGVmaW5lZFwiIT10eXBlb2Ygc2VsZiYmKGY9c2VsZiksZi5Qcm9taXNlPWUoKX19KGZ1bmN0aW9uKCl7dmFyIGRlZmluZSxtb2R1bGUsZXhwb3J0cztyZXR1cm4gKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiBfZGVyZXFfPT1cImZ1bmN0aW9uXCImJl9kZXJlcV87aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIF9kZXJlcV89PVwiZnVuY3Rpb25cIiYmX2RlcmVxXztmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkoezE6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHtcbnZhciBTb21lUHJvbWlzZUFycmF5ID0gUHJvbWlzZS5fU29tZVByb21pc2VBcnJheTtcbmZ1bmN0aW9uIGFueShwcm9taXNlcykge1xuICAgIHZhciByZXQgPSBuZXcgU29tZVByb21pc2VBcnJheShwcm9taXNlcyk7XG4gICAgdmFyIHByb21pc2UgPSByZXQucHJvbWlzZSgpO1xuICAgIHJldC5zZXRIb3dNYW55KDEpO1xuICAgIHJldC5zZXRVbndyYXAoKTtcbiAgICByZXQuaW5pdCgpO1xuICAgIHJldHVybiBwcm9taXNlO1xufVxuXG5Qcm9taXNlLmFueSA9IGZ1bmN0aW9uIChwcm9taXNlcykge1xuICAgIHJldHVybiBhbnkocHJvbWlzZXMpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuYW55ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBhbnkodGhpcyk7XG59O1xuXG59O1xuXG59LHt9XSwyOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xudmFyIGZpcnN0TGluZUVycm9yO1xudHJ5IHt0aHJvdyBuZXcgRXJyb3IoKTsgfSBjYXRjaCAoZSkge2ZpcnN0TGluZUVycm9yID0gZTt9XG52YXIgc2NoZWR1bGUgPSBfZGVyZXFfKFwiLi9zY2hlZHVsZS5qc1wiKTtcbnZhciBRdWV1ZSA9IF9kZXJlcV8oXCIuL3F1ZXVlLmpzXCIpO1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xuXG5mdW5jdGlvbiBBc3luYygpIHtcbiAgICB0aGlzLl9pc1RpY2tVc2VkID0gZmFsc2U7XG4gICAgdGhpcy5fbGF0ZVF1ZXVlID0gbmV3IFF1ZXVlKDE2KTtcbiAgICB0aGlzLl9ub3JtYWxRdWV1ZSA9IG5ldyBRdWV1ZSgxNik7XG4gICAgdGhpcy5fdHJhbXBvbGluZUVuYWJsZWQgPSB0cnVlO1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB0aGlzLmRyYWluUXVldWVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBzZWxmLl9kcmFpblF1ZXVlcygpO1xuICAgIH07XG4gICAgdGhpcy5fc2NoZWR1bGUgPVxuICAgICAgICBzY2hlZHVsZS5pc1N0YXRpYyA/IHNjaGVkdWxlKHRoaXMuZHJhaW5RdWV1ZXMpIDogc2NoZWR1bGU7XG59XG5cbkFzeW5jLnByb3RvdHlwZS5kaXNhYmxlVHJhbXBvbGluZUlmTmVjZXNzYXJ5ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHV0aWwuaGFzRGV2VG9vbHMpIHtcbiAgICAgICAgdGhpcy5fdHJhbXBvbGluZUVuYWJsZWQgPSBmYWxzZTtcbiAgICB9XG59O1xuXG5Bc3luYy5wcm90b3R5cGUuZW5hYmxlVHJhbXBvbGluZSA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fdHJhbXBvbGluZUVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5fdHJhbXBvbGluZUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl9zY2hlZHVsZSA9IGZ1bmN0aW9uKGZuKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTtcbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG5Bc3luYy5wcm90b3R5cGUuaGF2ZUl0ZW1zUXVldWVkID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLl9ub3JtYWxRdWV1ZS5sZW5ndGgoKSA+IDA7XG59O1xuXG5Bc3luYy5wcm90b3R5cGUudGhyb3dMYXRlciA9IGZ1bmN0aW9uKGZuLCBhcmcpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBhcmcgPSBmbjtcbiAgICAgICAgZm4gPSBmdW5jdGlvbiAoKSB7IHRocm93IGFyZzsgfTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBzZXRUaW1lb3V0ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBmbihhcmcpO1xuICAgICAgICB9LCAwKTtcbiAgICB9IGVsc2UgdHJ5IHtcbiAgICAgICAgdGhpcy5fc2NoZWR1bGUoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBmbihhcmcpO1xuICAgICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGFzeW5jIHNjaGVkdWxlciBhdmFpbGFibGVcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9tM09UWGtcXHUwMDBhXCIpO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIEFzeW5jSW52b2tlTGF0ZXIoZm4sIHJlY2VpdmVyLCBhcmcpIHtcbiAgICB0aGlzLl9sYXRlUXVldWUucHVzaChmbiwgcmVjZWl2ZXIsIGFyZyk7XG4gICAgdGhpcy5fcXVldWVUaWNrKCk7XG59XG5cbmZ1bmN0aW9uIEFzeW5jSW52b2tlKGZuLCByZWNlaXZlciwgYXJnKSB7XG4gICAgdGhpcy5fbm9ybWFsUXVldWUucHVzaChmbiwgcmVjZWl2ZXIsIGFyZyk7XG4gICAgdGhpcy5fcXVldWVUaWNrKCk7XG59XG5cbmZ1bmN0aW9uIEFzeW5jU2V0dGxlUHJvbWlzZXMocHJvbWlzZSkge1xuICAgIHRoaXMuX25vcm1hbFF1ZXVlLl9wdXNoT25lKHByb21pc2UpO1xuICAgIHRoaXMuX3F1ZXVlVGljaygpO1xufVxuXG5pZiAoIXV0aWwuaGFzRGV2VG9vbHMpIHtcbiAgICBBc3luYy5wcm90b3R5cGUuaW52b2tlTGF0ZXIgPSBBc3luY0ludm9rZUxhdGVyO1xuICAgIEFzeW5jLnByb3RvdHlwZS5pbnZva2UgPSBBc3luY0ludm9rZTtcbiAgICBBc3luYy5wcm90b3R5cGUuc2V0dGxlUHJvbWlzZXMgPSBBc3luY1NldHRsZVByb21pc2VzO1xufSBlbHNlIHtcbiAgICBpZiAoc2NoZWR1bGUuaXNTdGF0aWMpIHtcbiAgICAgICAgc2NoZWR1bGUgPSBmdW5jdGlvbihmbikgeyBzZXRUaW1lb3V0KGZuLCAwKTsgfTtcbiAgICB9XG4gICAgQXN5bmMucHJvdG90eXBlLmludm9rZUxhdGVyID0gZnVuY3Rpb24gKGZuLCByZWNlaXZlciwgYXJnKSB7XG4gICAgICAgIGlmICh0aGlzLl90cmFtcG9saW5lRW5hYmxlZCkge1xuICAgICAgICAgICAgQXN5bmNJbnZva2VMYXRlci5jYWxsKHRoaXMsIGZuLCByZWNlaXZlciwgYXJnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3NjaGVkdWxlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7XG4gICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIEFzeW5jLnByb3RvdHlwZS5pbnZva2UgPSBmdW5jdGlvbiAoZm4sIHJlY2VpdmVyLCBhcmcpIHtcbiAgICAgICAgaWYgKHRoaXMuX3RyYW1wb2xpbmVFbmFibGVkKSB7XG4gICAgICAgICAgICBBc3luY0ludm9rZS5jYWxsKHRoaXMsIGZuLCByZWNlaXZlciwgYXJnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3NjaGVkdWxlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBBc3luYy5wcm90b3R5cGUuc2V0dGxlUHJvbWlzZXMgPSBmdW5jdGlvbihwcm9taXNlKSB7XG4gICAgICAgIGlmICh0aGlzLl90cmFtcG9saW5lRW5hYmxlZCkge1xuICAgICAgICAgICAgQXN5bmNTZXR0bGVQcm9taXNlcy5jYWxsKHRoaXMsIHByb21pc2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fc2NoZWR1bGUoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5fc2V0dGxlUHJvbWlzZXMoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcbn1cblxuQXN5bmMucHJvdG90eXBlLmludm9rZUZpcnN0ID0gZnVuY3Rpb24gKGZuLCByZWNlaXZlciwgYXJnKSB7XG4gICAgdGhpcy5fbm9ybWFsUXVldWUudW5zaGlmdChmbiwgcmVjZWl2ZXIsIGFyZyk7XG4gICAgdGhpcy5fcXVldWVUaWNrKCk7XG59O1xuXG5Bc3luYy5wcm90b3R5cGUuX2RyYWluUXVldWUgPSBmdW5jdGlvbihxdWV1ZSkge1xuICAgIHdoaWxlIChxdWV1ZS5sZW5ndGgoKSA+IDApIHtcbiAgICAgICAgdmFyIGZuID0gcXVldWUuc2hpZnQoKTtcbiAgICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICBmbi5fc2V0dGxlUHJvbWlzZXMoKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHZhciByZWNlaXZlciA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgIHZhciBhcmcgPSBxdWV1ZS5zaGlmdCgpO1xuICAgICAgICBmbi5jYWxsKHJlY2VpdmVyLCBhcmcpO1xuICAgIH1cbn07XG5cbkFzeW5jLnByb3RvdHlwZS5fZHJhaW5RdWV1ZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fZHJhaW5RdWV1ZSh0aGlzLl9ub3JtYWxRdWV1ZSk7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgICB0aGlzLl9kcmFpblF1ZXVlKHRoaXMuX2xhdGVRdWV1ZSk7XG59O1xuXG5Bc3luYy5wcm90b3R5cGUuX3F1ZXVlVGljayA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIXRoaXMuX2lzVGlja1VzZWQpIHtcbiAgICAgICAgdGhpcy5faXNUaWNrVXNlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuX3NjaGVkdWxlKHRoaXMuZHJhaW5RdWV1ZXMpO1xuICAgIH1cbn07XG5cbkFzeW5jLnByb3RvdHlwZS5fcmVzZXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5faXNUaWNrVXNlZCA9IGZhbHNlO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBuZXcgQXN5bmMoKTtcbm1vZHVsZS5leHBvcnRzLmZpcnN0TGluZUVycm9yID0gZmlyc3RMaW5lRXJyb3I7XG5cbn0se1wiLi9xdWV1ZS5qc1wiOjI4LFwiLi9zY2hlZHVsZS5qc1wiOjMxLFwiLi91dGlsLmpzXCI6Mzh9XSwzOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBJTlRFUk5BTCwgdHJ5Q29udmVydFRvUHJvbWlzZSkge1xudmFyIHJlamVjdFRoaXMgPSBmdW5jdGlvbihfLCBlKSB7XG4gICAgdGhpcy5fcmVqZWN0KGUpO1xufTtcblxudmFyIHRhcmdldFJlamVjdGVkID0gZnVuY3Rpb24oZSwgY29udGV4dCkge1xuICAgIGNvbnRleHQucHJvbWlzZVJlamVjdGlvblF1ZXVlZCA9IHRydWU7XG4gICAgY29udGV4dC5iaW5kaW5nUHJvbWlzZS5fdGhlbihyZWplY3RUaGlzLCByZWplY3RUaGlzLCBudWxsLCB0aGlzLCBlKTtcbn07XG5cbnZhciBiaW5kaW5nUmVzb2x2ZWQgPSBmdW5jdGlvbih0aGlzQXJnLCBjb250ZXh0KSB7XG4gICAgaWYgKHRoaXMuX2lzUGVuZGluZygpKSB7XG4gICAgICAgIHRoaXMuX3Jlc29sdmVDYWxsYmFjayhjb250ZXh0LnRhcmdldCk7XG4gICAgfVxufTtcblxudmFyIGJpbmRpbmdSZWplY3RlZCA9IGZ1bmN0aW9uKGUsIGNvbnRleHQpIHtcbiAgICBpZiAoIWNvbnRleHQucHJvbWlzZVJlamVjdGlvblF1ZXVlZCkgdGhpcy5fcmVqZWN0KGUpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uICh0aGlzQXJnKSB7XG4gICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UodGhpc0FyZyk7XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICByZXQuX3Byb3BhZ2F0ZUZyb20odGhpcywgMSk7XG4gICAgdmFyIHRhcmdldCA9IHRoaXMuX3RhcmdldCgpO1xuXG4gICAgcmV0Ll9zZXRCb3VuZFRvKG1heWJlUHJvbWlzZSk7XG4gICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgdmFyIGNvbnRleHQgPSB7XG4gICAgICAgICAgICBwcm9taXNlUmVqZWN0aW9uUXVldWVkOiBmYWxzZSxcbiAgICAgICAgICAgIHByb21pc2U6IHJldCxcbiAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0LFxuICAgICAgICAgICAgYmluZGluZ1Byb21pc2U6IG1heWJlUHJvbWlzZVxuICAgICAgICB9O1xuICAgICAgICB0YXJnZXQuX3RoZW4oSU5URVJOQUwsIHRhcmdldFJlamVjdGVkLCByZXQuX3Byb2dyZXNzLCByZXQsIGNvbnRleHQpO1xuICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oXG4gICAgICAgICAgICBiaW5kaW5nUmVzb2x2ZWQsIGJpbmRpbmdSZWplY3RlZCwgcmV0Ll9wcm9ncmVzcywgcmV0LCBjb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXQuX3Jlc29sdmVDYWxsYmFjayh0YXJnZXQpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldEJvdW5kVG8gPSBmdW5jdGlvbiAob2JqKSB7XG4gICAgaWYgKG9iaiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCAxMzEwNzI7XG4gICAgICAgIHRoaXMuX2JvdW5kVG8gPSBvYmo7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+MTMxMDcyKTtcbiAgICB9XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5faXNCb3VuZCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTMxMDcyKSA9PT0gMTMxMDcyO1xufTtcblxuUHJvbWlzZS5iaW5kID0gZnVuY3Rpb24gKHRoaXNBcmcsIHZhbHVlKSB7XG4gICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UodGhpc0FyZyk7XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcblxuICAgIHJldC5fc2V0Qm91bmRUbyhtYXliZVByb21pc2UpO1xuICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgIG1heWJlUHJvbWlzZS5fdGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldC5fcmVzb2x2ZUNhbGxiYWNrKHZhbHVlKTtcbiAgICAgICAgfSwgcmV0Ll9yZWplY3QsIHJldC5fcHJvZ3Jlc3MsIHJldCwgbnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0Ll9yZXNvbHZlQ2FsbGJhY2sodmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbn07XG5cbn0se31dLDQ6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgb2xkO1xuaWYgKHR5cGVvZiBQcm9taXNlICE9PSBcInVuZGVmaW5lZFwiKSBvbGQgPSBQcm9taXNlO1xuZnVuY3Rpb24gbm9Db25mbGljdCgpIHtcbiAgICB0cnkgeyBpZiAoUHJvbWlzZSA9PT0gYmx1ZWJpcmQpIFByb21pc2UgPSBvbGQ7IH1cbiAgICBjYXRjaCAoZSkge31cbiAgICByZXR1cm4gYmx1ZWJpcmQ7XG59XG52YXIgYmx1ZWJpcmQgPSBfZGVyZXFfKFwiLi9wcm9taXNlLmpzXCIpKCk7XG5ibHVlYmlyZC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDtcbm1vZHVsZS5leHBvcnRzID0gYmx1ZWJpcmQ7XG5cbn0se1wiLi9wcm9taXNlLmpzXCI6MjN9XSw1OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xudmFyIGNyID0gT2JqZWN0LmNyZWF0ZTtcbmlmIChjcikge1xuICAgIHZhciBjYWxsZXJDYWNoZSA9IGNyKG51bGwpO1xuICAgIHZhciBnZXR0ZXJDYWNoZSA9IGNyKG51bGwpO1xuICAgIGNhbGxlckNhY2hlW1wiIHNpemVcIl0gPSBnZXR0ZXJDYWNoZVtcIiBzaXplXCJdID0gMDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlKSB7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgY2FuRXZhbHVhdGUgPSB1dGlsLmNhbkV2YWx1YXRlO1xudmFyIGlzSWRlbnRpZmllciA9IHV0aWwuaXNJZGVudGlmaWVyO1xuXG52YXIgZ2V0TWV0aG9kQ2FsbGVyO1xudmFyIGdldEdldHRlcjtcbmlmICghdHJ1ZSkge1xudmFyIG1ha2VNZXRob2RDYWxsZXIgPSBmdW5jdGlvbiAobWV0aG9kTmFtZSkge1xuICAgIHJldHVybiBuZXcgRnVuY3Rpb24oXCJlbnN1cmVNZXRob2RcIiwgXCIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgJ3VzZSBzdHJpY3QnICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgZW5zdXJlTWV0aG9kKG9iaiwgJ21ldGhvZE5hbWUnKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgc3dpdGNoKGxlbikgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG9iai5tZXRob2ROYW1lKHRoaXNbMF0pOyAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgICAgIGNhc2UgMjogcmV0dXJuIG9iai5tZXRob2ROYW1lKHRoaXNbMF0sIHRoaXNbMV0pOyAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIG9iai5tZXRob2ROYW1lKHRoaXNbMF0sIHRoaXNbMV0sIHRoaXNbMl0pOyAgICBcXG5cXFxuICAgICAgICAgICAgICAgIGNhc2UgMDogcmV0dXJuIG9iai5tZXRob2ROYW1lKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqLm1ldGhvZE5hbWUuYXBwbHkob2JqLCB0aGlzKTsgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICB9OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICBcIi5yZXBsYWNlKC9tZXRob2ROYW1lL2csIG1ldGhvZE5hbWUpKShlbnN1cmVNZXRob2QpO1xufTtcblxudmFyIG1ha2VHZXR0ZXIgPSBmdW5jdGlvbiAocHJvcGVydHlOYW1lKSB7XG4gICAgcmV0dXJuIG5ldyBGdW5jdGlvbihcIm9ialwiLCBcIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICd1c2Ugc3RyaWN0JzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIHJldHVybiBvYmoucHJvcGVydHlOYW1lOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIFwiLnJlcGxhY2UoXCJwcm9wZXJ0eU5hbWVcIiwgcHJvcGVydHlOYW1lKSk7XG59O1xuXG52YXIgZ2V0Q29tcGlsZWQgPSBmdW5jdGlvbihuYW1lLCBjb21waWxlciwgY2FjaGUpIHtcbiAgICB2YXIgcmV0ID0gY2FjaGVbbmFtZV07XG4gICAgaWYgKHR5cGVvZiByZXQgIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBpZiAoIWlzSWRlbnRpZmllcihuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gY29tcGlsZXIobmFtZSk7XG4gICAgICAgIGNhY2hlW25hbWVdID0gcmV0O1xuICAgICAgICBjYWNoZVtcIiBzaXplXCJdKys7XG4gICAgICAgIGlmIChjYWNoZVtcIiBzaXplXCJdID4gNTEyKSB7XG4gICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGNhY2hlKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIGRlbGV0ZSBjYWNoZVtrZXlzW2ldXTtcbiAgICAgICAgICAgIGNhY2hlW1wiIHNpemVcIl0gPSBrZXlzLmxlbmd0aCAtIDI1NjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxuZ2V0TWV0aG9kQ2FsbGVyID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHJldHVybiBnZXRDb21waWxlZChuYW1lLCBtYWtlTWV0aG9kQ2FsbGVyLCBjYWxsZXJDYWNoZSk7XG59O1xuXG5nZXRHZXR0ZXIgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgcmV0dXJuIGdldENvbXBpbGVkKG5hbWUsIG1ha2VHZXR0ZXIsIGdldHRlckNhY2hlKTtcbn07XG59XG5cbmZ1bmN0aW9uIGVuc3VyZU1ldGhvZChvYmosIG1ldGhvZE5hbWUpIHtcbiAgICB2YXIgZm47XG4gICAgaWYgKG9iaiAhPSBudWxsKSBmbiA9IG9ialttZXRob2ROYW1lXTtcbiAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSBcIk9iamVjdCBcIiArIHV0aWwuY2xhc3NTdHJpbmcob2JqKSArIFwiIGhhcyBubyBtZXRob2QgJ1wiICtcbiAgICAgICAgICAgIHV0aWwudG9TdHJpbmcobWV0aG9kTmFtZSkgKyBcIidcIjtcbiAgICAgICAgdGhyb3cgbmV3IFByb21pc2UuVHlwZUVycm9yKG1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gZm47XG59XG5cbmZ1bmN0aW9uIGNhbGxlcihvYmopIHtcbiAgICB2YXIgbWV0aG9kTmFtZSA9IHRoaXMucG9wKCk7XG4gICAgdmFyIGZuID0gZW5zdXJlTWV0aG9kKG9iaiwgbWV0aG9kTmFtZSk7XG4gICAgcmV0dXJuIGZuLmFwcGx5KG9iaiwgdGhpcyk7XG59XG5Qcm9taXNlLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHtcbiAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuIC0gMSk7IGZvcih2YXIgJF9pID0gMTsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2kgLSAxXSA9IGFyZ3VtZW50c1skX2ldO31cbiAgICBpZiAoIXRydWUpIHtcbiAgICAgICAgaWYgKGNhbkV2YWx1YXRlKSB7XG4gICAgICAgICAgICB2YXIgbWF5YmVDYWxsZXIgPSBnZXRNZXRob2RDYWxsZXIobWV0aG9kTmFtZSk7XG4gICAgICAgICAgICBpZiAobWF5YmVDYWxsZXIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdGhlbihcbiAgICAgICAgICAgICAgICAgICAgbWF5YmVDYWxsZXIsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBhcmdzLCB1bmRlZmluZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGFyZ3MucHVzaChtZXRob2ROYW1lKTtcbiAgICByZXR1cm4gdGhpcy5fdGhlbihjYWxsZXIsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBhcmdzLCB1bmRlZmluZWQpO1xufTtcblxuZnVuY3Rpb24gbmFtZWRHZXR0ZXIob2JqKSB7XG4gICAgcmV0dXJuIG9ialt0aGlzXTtcbn1cbmZ1bmN0aW9uIGluZGV4ZWRHZXR0ZXIob2JqKSB7XG4gICAgdmFyIGluZGV4ID0gK3RoaXM7XG4gICAgaWYgKGluZGV4IDwgMCkgaW5kZXggPSBNYXRoLm1heCgwLCBpbmRleCArIG9iai5sZW5ndGgpO1xuICAgIHJldHVybiBvYmpbaW5kZXhdO1xufVxuUHJvbWlzZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkge1xuICAgIHZhciBpc0luZGV4ID0gKHR5cGVvZiBwcm9wZXJ0eU5hbWUgPT09IFwibnVtYmVyXCIpO1xuICAgIHZhciBnZXR0ZXI7XG4gICAgaWYgKCFpc0luZGV4KSB7XG4gICAgICAgIGlmIChjYW5FdmFsdWF0ZSkge1xuICAgICAgICAgICAgdmFyIG1heWJlR2V0dGVyID0gZ2V0R2V0dGVyKHByb3BlcnR5TmFtZSk7XG4gICAgICAgICAgICBnZXR0ZXIgPSBtYXliZUdldHRlciAhPT0gbnVsbCA/IG1heWJlR2V0dGVyIDogbmFtZWRHZXR0ZXI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBnZXR0ZXIgPSBuYW1lZEdldHRlcjtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGdldHRlciA9IGluZGV4ZWRHZXR0ZXI7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl90aGVuKGdldHRlciwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHByb3BlcnR5TmFtZSwgdW5kZWZpbmVkKTtcbn07XG59O1xuXG59LHtcIi4vdXRpbC5qc1wiOjM4fV0sNjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSkge1xudmFyIGVycm9ycyA9IF9kZXJlcV8oXCIuL2Vycm9ycy5qc1wiKTtcbnZhciBhc3luYyA9IF9kZXJlcV8oXCIuL2FzeW5jLmpzXCIpO1xudmFyIENhbmNlbGxhdGlvbkVycm9yID0gZXJyb3JzLkNhbmNlbGxhdGlvbkVycm9yO1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIGlmICghdGhpcy5pc0NhbmNlbGxhYmxlKCkpIHJldHVybiB0aGlzO1xuICAgIHZhciBwYXJlbnQ7XG4gICAgdmFyIHByb21pc2VUb1JlamVjdCA9IHRoaXM7XG4gICAgd2hpbGUgKChwYXJlbnQgPSBwcm9taXNlVG9SZWplY3QuX2NhbmNlbGxhdGlvblBhcmVudCkgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICBwYXJlbnQuaXNDYW5jZWxsYWJsZSgpKSB7XG4gICAgICAgIHByb21pc2VUb1JlamVjdCA9IHBhcmVudDtcbiAgICB9XG4gICAgdGhpcy5fdW5zZXRDYW5jZWxsYWJsZSgpO1xuICAgIHByb21pc2VUb1JlamVjdC5fdGFyZ2V0KCkuX3JlamVjdENhbGxiYWNrKHJlYXNvbiwgZmFsc2UsIHRydWUpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIGlmICghdGhpcy5pc0NhbmNlbGxhYmxlKCkpIHJldHVybiB0aGlzO1xuICAgIGlmIChyZWFzb24gPT09IHVuZGVmaW5lZCkgcmVhc29uID0gbmV3IENhbmNlbGxhdGlvbkVycm9yKCk7XG4gICAgYXN5bmMuaW52b2tlTGF0ZXIodGhpcy5fY2FuY2VsLCB0aGlzLCByZWFzb24pO1xuICAgIHJldHVybiB0aGlzO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuY2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuX2NhbmNlbGxhYmxlKCkpIHJldHVybiB0aGlzO1xuICAgIGFzeW5jLmVuYWJsZVRyYW1wb2xpbmUoKTtcbiAgICB0aGlzLl9zZXRDYW5jZWxsYWJsZSgpO1xuICAgIHRoaXMuX2NhbmNlbGxhdGlvblBhcmVudCA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gdGhpcztcbn07XG5cblByb21pc2UucHJvdG90eXBlLnVuY2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHJldCA9IHRoaXMudGhlbigpO1xuICAgIHJldC5fdW5zZXRDYW5jZWxsYWJsZSgpO1xuICAgIHJldHVybiByZXQ7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5mb3JrID0gZnVuY3Rpb24gKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCwgZGlkUHJvZ3Jlc3MpIHtcbiAgICB2YXIgcmV0ID0gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCwgdW5kZWZpbmVkKTtcblxuICAgIHJldC5fc2V0Q2FuY2VsbGFibGUoKTtcbiAgICByZXQuX2NhbmNlbGxhdGlvblBhcmVudCA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gcmV0O1xufTtcbn07XG5cbn0se1wiLi9hc3luYy5qc1wiOjIsXCIuL2Vycm9ycy5qc1wiOjEzfV0sNzpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7XG52YXIgYXN5bmMgPSBfZGVyZXFfKFwiLi9hc3luYy5qc1wiKTtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBibHVlYmlyZEZyYW1lUGF0dGVybiA9XG4gICAgL1tcXFxcXFwvXWJsdWViaXJkW1xcXFxcXC9danNbXFxcXFxcL10obWFpbnxkZWJ1Z3x6YWxnb3xpbnN0cnVtZW50ZWQpLztcbnZhciBzdGFja0ZyYW1lUGF0dGVybiA9IG51bGw7XG52YXIgZm9ybWF0U3RhY2sgPSBudWxsO1xudmFyIGluZGVudFN0YWNrRnJhbWVzID0gZmFsc2U7XG52YXIgd2FybjtcblxuZnVuY3Rpb24gQ2FwdHVyZWRUcmFjZShwYXJlbnQpIHtcbiAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7XG4gICAgdmFyIGxlbmd0aCA9IHRoaXMuX2xlbmd0aCA9IDEgKyAocGFyZW50ID09PSB1bmRlZmluZWQgPyAwIDogcGFyZW50Ll9sZW5ndGgpO1xuICAgIGNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIENhcHR1cmVkVHJhY2UpO1xuICAgIGlmIChsZW5ndGggPiAzMikgdGhpcy51bmN5Y2xlKCk7XG59XG51dGlsLmluaGVyaXRzKENhcHR1cmVkVHJhY2UsIEVycm9yKTtcblxuQ2FwdHVyZWRUcmFjZS5wcm90b3R5cGUudW5jeWNsZSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBsZW5ndGggPSB0aGlzLl9sZW5ndGg7XG4gICAgaWYgKGxlbmd0aCA8IDIpIHJldHVybjtcbiAgICB2YXIgbm9kZXMgPSBbXTtcbiAgICB2YXIgc3RhY2tUb0luZGV4ID0ge307XG5cbiAgICBmb3IgKHZhciBpID0gMCwgbm9kZSA9IHRoaXM7IG5vZGUgIT09IHVuZGVmaW5lZDsgKytpKSB7XG4gICAgICAgIG5vZGVzLnB1c2gobm9kZSk7XG4gICAgICAgIG5vZGUgPSBub2RlLl9wYXJlbnQ7XG4gICAgfVxuICAgIGxlbmd0aCA9IHRoaXMuX2xlbmd0aCA9IGk7XG4gICAgZm9yICh2YXIgaSA9IGxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XG4gICAgICAgIHZhciBzdGFjayA9IG5vZGVzW2ldLnN0YWNrO1xuICAgICAgICBpZiAoc3RhY2tUb0luZGV4W3N0YWNrXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzdGFja1RvSW5kZXhbc3RhY2tdID0gaTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgICAgIHZhciBjdXJyZW50U3RhY2sgPSBub2Rlc1tpXS5zdGFjaztcbiAgICAgICAgdmFyIGluZGV4ID0gc3RhY2tUb0luZGV4W2N1cnJlbnRTdGFja107XG4gICAgICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkICYmIGluZGV4ICE9PSBpKSB7XG4gICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7XG4gICAgICAgICAgICAgICAgbm9kZXNbaW5kZXggLSAxXS5fcGFyZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIG5vZGVzW2luZGV4IC0gMV0uX2xlbmd0aCA9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBub2Rlc1tpXS5fcGFyZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgbm9kZXNbaV0uX2xlbmd0aCA9IDE7XG4gICAgICAgICAgICB2YXIgY3ljbGVFZGdlTm9kZSA9IGkgPiAwID8gbm9kZXNbaSAtIDFdIDogdGhpcztcblxuICAgICAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIGN5Y2xlRWRnZU5vZGUuX3BhcmVudCA9IG5vZGVzW2luZGV4ICsgMV07XG4gICAgICAgICAgICAgICAgY3ljbGVFZGdlTm9kZS5fcGFyZW50LnVuY3ljbGUoKTtcbiAgICAgICAgICAgICAgICBjeWNsZUVkZ2VOb2RlLl9sZW5ndGggPVxuICAgICAgICAgICAgICAgICAgICBjeWNsZUVkZ2VOb2RlLl9wYXJlbnQuX2xlbmd0aCArIDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN5Y2xlRWRnZU5vZGUuX3BhcmVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBjeWNsZUVkZ2VOb2RlLl9sZW5ndGggPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZExlbmd0aCA9IGN5Y2xlRWRnZU5vZGUuX2xlbmd0aCArIDE7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gaSAtIDI7IGogPj0gMDsgLS1qKSB7XG4gICAgICAgICAgICAgICAgbm9kZXNbal0uX2xlbmd0aCA9IGN1cnJlbnRDaGlsZExlbmd0aDtcbiAgICAgICAgICAgICAgICBjdXJyZW50Q2hpbGRMZW5ndGgrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbkNhcHR1cmVkVHJhY2UucHJvdG90eXBlLnBhcmVudCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9wYXJlbnQ7XG59O1xuXG5DYXB0dXJlZFRyYWNlLnByb3RvdHlwZS5oYXNQYXJlbnQgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fcGFyZW50ICE9PSB1bmRlZmluZWQ7XG59O1xuXG5DYXB0dXJlZFRyYWNlLnByb3RvdHlwZS5hdHRhY2hFeHRyYVRyYWNlID0gZnVuY3Rpb24oZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IuX19zdGFja0NsZWFuZWRfXykgcmV0dXJuO1xuICAgIHRoaXMudW5jeWNsZSgpO1xuICAgIHZhciBwYXJzZWQgPSBDYXB0dXJlZFRyYWNlLnBhcnNlU3RhY2tBbmRNZXNzYWdlKGVycm9yKTtcbiAgICB2YXIgbWVzc2FnZSA9IHBhcnNlZC5tZXNzYWdlO1xuICAgIHZhciBzdGFja3MgPSBbcGFyc2VkLnN0YWNrXTtcblxuICAgIHZhciB0cmFjZSA9IHRoaXM7XG4gICAgd2hpbGUgKHRyYWNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgc3RhY2tzLnB1c2goY2xlYW5TdGFjayh0cmFjZS5zdGFjay5zcGxpdChcIlxcblwiKSkpO1xuICAgICAgICB0cmFjZSA9IHRyYWNlLl9wYXJlbnQ7XG4gICAgfVxuICAgIHJlbW92ZUNvbW1vblJvb3RzKHN0YWNrcyk7XG4gICAgcmVtb3ZlRHVwbGljYXRlT3JFbXB0eUp1bXBzKHN0YWNrcyk7XG4gICAgdXRpbC5ub3RFbnVtZXJhYmxlUHJvcChlcnJvciwgXCJzdGFja1wiLCByZWNvbnN0cnVjdFN0YWNrKG1lc3NhZ2UsIHN0YWNrcykpO1xuICAgIHV0aWwubm90RW51bWVyYWJsZVByb3AoZXJyb3IsIFwiX19zdGFja0NsZWFuZWRfX1wiLCB0cnVlKTtcbn07XG5cbmZ1bmN0aW9uIHJlY29uc3RydWN0U3RhY2sobWVzc2FnZSwgc3RhY2tzKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGFja3MubGVuZ3RoIC0gMTsgKytpKSB7XG4gICAgICAgIHN0YWNrc1tpXS5wdXNoKFwiRnJvbSBwcmV2aW91cyBldmVudDpcIik7XG4gICAgICAgIHN0YWNrc1tpXSA9IHN0YWNrc1tpXS5qb2luKFwiXFxuXCIpO1xuICAgIH1cbiAgICBpZiAoaSA8IHN0YWNrcy5sZW5ndGgpIHtcbiAgICAgICAgc3RhY2tzW2ldID0gc3RhY2tzW2ldLmpvaW4oXCJcXG5cIik7XG4gICAgfVxuICAgIHJldHVybiBtZXNzYWdlICsgXCJcXG5cIiArIHN0YWNrcy5qb2luKFwiXFxuXCIpO1xufVxuXG5mdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVPckVtcHR5SnVtcHMoc3RhY2tzKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGFja3MubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgaWYgKHN0YWNrc1tpXS5sZW5ndGggPT09IDAgfHxcbiAgICAgICAgICAgICgoaSArIDEgPCBzdGFja3MubGVuZ3RoKSAmJiBzdGFja3NbaV1bMF0gPT09IHN0YWNrc1tpKzFdWzBdKSkge1xuICAgICAgICAgICAgc3RhY2tzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIGktLTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlQ29tbW9uUm9vdHMoc3RhY2tzKSB7XG4gICAgdmFyIGN1cnJlbnQgPSBzdGFja3NbMF07XG4gICAgZm9yICh2YXIgaSA9IDE7IGkgPCBzdGFja3MubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIHByZXYgPSBzdGFja3NbaV07XG4gICAgICAgIHZhciBjdXJyZW50TGFzdEluZGV4ID0gY3VycmVudC5sZW5ndGggLSAxO1xuICAgICAgICB2YXIgY3VycmVudExhc3RMaW5lID0gY3VycmVudFtjdXJyZW50TGFzdEluZGV4XTtcbiAgICAgICAgdmFyIGNvbW1vblJvb3RNZWV0UG9pbnQgPSAtMTtcblxuICAgICAgICBmb3IgKHZhciBqID0gcHJldi5sZW5ndGggLSAxOyBqID49IDA7IC0taikge1xuICAgICAgICAgICAgaWYgKHByZXZbal0gPT09IGN1cnJlbnRMYXN0TGluZSkge1xuICAgICAgICAgICAgICAgIGNvbW1vblJvb3RNZWV0UG9pbnQgPSBqO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZm9yICh2YXIgaiA9IGNvbW1vblJvb3RNZWV0UG9pbnQ7IGogPj0gMDsgLS1qKSB7XG4gICAgICAgICAgICB2YXIgbGluZSA9IHByZXZbal07XG4gICAgICAgICAgICBpZiAoY3VycmVudFtjdXJyZW50TGFzdEluZGV4XSA9PT0gbGluZSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnQucG9wKCk7XG4gICAgICAgICAgICAgICAgY3VycmVudExhc3RJbmRleC0tO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjdXJyZW50ID0gcHJldjtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNsZWFuU3RhY2soc3RhY2spIHtcbiAgICB2YXIgcmV0ID0gW107XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGFjay5sZW5ndGg7ICsraSkge1xuICAgICAgICB2YXIgbGluZSA9IHN0YWNrW2ldO1xuICAgICAgICB2YXIgaXNUcmFjZUxpbmUgPSBzdGFja0ZyYW1lUGF0dGVybi50ZXN0KGxpbmUpIHx8XG4gICAgICAgICAgICBcIiAgICAoTm8gc3RhY2sgdHJhY2UpXCIgPT09IGxpbmU7XG4gICAgICAgIHZhciBpc0ludGVybmFsRnJhbWUgPSBpc1RyYWNlTGluZSAmJiBzaG91bGRJZ25vcmUobGluZSk7XG4gICAgICAgIGlmIChpc1RyYWNlTGluZSAmJiAhaXNJbnRlcm5hbEZyYW1lKSB7XG4gICAgICAgICAgICBpZiAoaW5kZW50U3RhY2tGcmFtZXMgJiYgbGluZS5jaGFyQXQoMCkgIT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgbGluZSA9IFwiICAgIFwiICsgbGluZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldC5wdXNoKGxpbmUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5cbmZ1bmN0aW9uIHN0YWNrRnJhbWVzQXNBcnJheShlcnJvcikge1xuICAgIHZhciBzdGFjayA9IGVycm9yLnN0YWNrLnJlcGxhY2UoL1xccyskL2csIFwiXCIpLnNwbGl0KFwiXFxuXCIpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RhY2subGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIGxpbmUgPSBzdGFja1tpXTtcbiAgICAgICAgaWYgKFwiICAgIChObyBzdGFjayB0cmFjZSlcIiA9PT0gbGluZSB8fCBzdGFja0ZyYW1lUGF0dGVybi50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZShpKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YWNrO1xufVxuXG5DYXB0dXJlZFRyYWNlLnBhcnNlU3RhY2tBbmRNZXNzYWdlID0gZnVuY3Rpb24oZXJyb3IpIHtcbiAgICB2YXIgc3RhY2sgPSBlcnJvci5zdGFjaztcbiAgICB2YXIgbWVzc2FnZSA9IGVycm9yLnRvU3RyaW5nKCk7XG4gICAgc3RhY2sgPSB0eXBlb2Ygc3RhY2sgPT09IFwic3RyaW5nXCIgJiYgc3RhY2subGVuZ3RoID4gMFxuICAgICAgICAgICAgICAgID8gc3RhY2tGcmFtZXNBc0FycmF5KGVycm9yKSA6IFtcIiAgICAoTm8gc3RhY2sgdHJhY2UpXCJdO1xuICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgIHN0YWNrOiBjbGVhblN0YWNrKHN0YWNrKVxuICAgIH07XG59O1xuXG5DYXB0dXJlZFRyYWNlLmZvcm1hdEFuZExvZ0Vycm9yID0gZnVuY3Rpb24oZXJyb3IsIHRpdGxlKSB7XG4gICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIHZhciBtZXNzYWdlO1xuICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBlcnJvciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvci5zdGFjaztcbiAgICAgICAgICAgIG1lc3NhZ2UgPSB0aXRsZSArIGZvcm1hdFN0YWNrKHN0YWNrLCBlcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtZXNzYWdlID0gdGl0bGUgKyBTdHJpbmcoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2Ygd2FybiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICB3YXJuKG1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb25zb2xlLmxvZyA9PT0gXCJmdW5jdGlvblwiIHx8XG4gICAgICAgICAgICB0eXBlb2YgY29uc29sZS5sb2cgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuQ2FwdHVyZWRUcmFjZS51bmhhbmRsZWRSZWplY3Rpb24gPSBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgQ2FwdHVyZWRUcmFjZS5mb3JtYXRBbmRMb2dFcnJvcihyZWFzb24sIFwiXi0tLSBXaXRoIGFkZGl0aW9uYWwgc3RhY2sgdHJhY2U6IFwiKTtcbn07XG5cbkNhcHR1cmVkVHJhY2UuaXNTdXBwb3J0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHR5cGVvZiBjYXB0dXJlU3RhY2tUcmFjZSA9PT0gXCJmdW5jdGlvblwiO1xufTtcblxuQ2FwdHVyZWRUcmFjZS5maXJlUmVqZWN0aW9uRXZlbnQgPVxuZnVuY3Rpb24obmFtZSwgbG9jYWxIYW5kbGVyLCByZWFzb24sIHByb21pc2UpIHtcbiAgICB2YXIgbG9jYWxFdmVudEZpcmVkID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKHR5cGVvZiBsb2NhbEhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgbG9jYWxFdmVudEZpcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSBcInJlamVjdGlvbkhhbmRsZWRcIikge1xuICAgICAgICAgICAgICAgIGxvY2FsSGFuZGxlcihwcm9taXNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbG9jYWxIYW5kbGVyKHJlYXNvbiwgcHJvbWlzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGFzeW5jLnRocm93TGF0ZXIoZSk7XG4gICAgfVxuXG4gICAgdmFyIGdsb2JhbEV2ZW50RmlyZWQgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgICBnbG9iYWxFdmVudEZpcmVkID0gZmlyZUdsb2JhbEV2ZW50KG5hbWUsIHJlYXNvbiwgcHJvbWlzZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBnbG9iYWxFdmVudEZpcmVkID0gdHJ1ZTtcbiAgICAgICAgYXN5bmMudGhyb3dMYXRlcihlKTtcbiAgICB9XG5cbiAgICB2YXIgZG9tRXZlbnRGaXJlZCA9IGZhbHNlO1xuICAgIGlmIChmaXJlRG9tRXZlbnQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRvbUV2ZW50RmlyZWQgPSBmaXJlRG9tRXZlbnQobmFtZS50b0xvd2VyQ2FzZSgpLCB7XG4gICAgICAgICAgICAgICAgcmVhc29uOiByZWFzb24sXG4gICAgICAgICAgICAgICAgcHJvbWlzZTogcHJvbWlzZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGRvbUV2ZW50RmlyZWQgPSB0cnVlO1xuICAgICAgICAgICAgYXN5bmMudGhyb3dMYXRlcihlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmICghZ2xvYmFsRXZlbnRGaXJlZCAmJiAhbG9jYWxFdmVudEZpcmVkICYmICFkb21FdmVudEZpcmVkICYmXG4gICAgICAgIG5hbWUgPT09IFwidW5oYW5kbGVkUmVqZWN0aW9uXCIpIHtcbiAgICAgICAgQ2FwdHVyZWRUcmFjZS5mb3JtYXRBbmRMb2dFcnJvcihyZWFzb24sIFwiVW5oYW5kbGVkIHJlamVjdGlvbiBcIik7XG4gICAgfVxufTtcblxuZnVuY3Rpb24gZm9ybWF0Tm9uRXJyb3Iob2JqKSB7XG4gICAgdmFyIHN0cjtcbiAgICBpZiAodHlwZW9mIG9iaiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHN0ciA9IFwiW2Z1bmN0aW9uIFwiICtcbiAgICAgICAgICAgIChvYmoubmFtZSB8fCBcImFub255bW91c1wiKSArXG4gICAgICAgICAgICBcIl1cIjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzdHIgPSBvYmoudG9TdHJpbmcoKTtcbiAgICAgICAgdmFyIHJ1c2VsZXNzVG9TdHJpbmcgPSAvXFxbb2JqZWN0IFthLXpBLVowLTkkX10rXFxdLztcbiAgICAgICAgaWYgKHJ1c2VsZXNzVG9TdHJpbmcudGVzdChzdHIpKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHZhciBuZXdTdHIgPSBKU09OLnN0cmluZ2lmeShvYmopO1xuICAgICAgICAgICAgICAgIHN0ciA9IG5ld1N0cjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoKGUpIHtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzdHIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBzdHIgPSBcIihlbXB0eSBhcnJheSlcIjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gKFwiKDxcIiArIHNuaXAoc3RyKSArIFwiPiwgbm8gc3RhY2sgdHJhY2UpXCIpO1xufVxuXG5mdW5jdGlvbiBzbmlwKHN0cikge1xuICAgIHZhciBtYXhDaGFycyA9IDQxO1xuICAgIGlmIChzdHIubGVuZ3RoIDwgbWF4Q2hhcnMpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9XG4gICAgcmV0dXJuIHN0ci5zdWJzdHIoMCwgbWF4Q2hhcnMgLSAzKSArIFwiLi4uXCI7XG59XG5cbnZhciBzaG91bGRJZ25vcmUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9O1xudmFyIHBhcnNlTGluZUluZm9SZWdleCA9IC9bXFwvPFxcKF0oW146XFwvXSspOihcXGQrKTooPzpcXGQrKVxcKT9cXHMqJC87XG5mdW5jdGlvbiBwYXJzZUxpbmVJbmZvKGxpbmUpIHtcbiAgICB2YXIgbWF0Y2hlcyA9IGxpbmUubWF0Y2gocGFyc2VMaW5lSW5mb1JlZ2V4KTtcbiAgICBpZiAobWF0Y2hlcykge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmlsZU5hbWU6IG1hdGNoZXNbMV0sXG4gICAgICAgICAgICBsaW5lOiBwYXJzZUludChtYXRjaGVzWzJdLCAxMClcbiAgICAgICAgfTtcbiAgICB9XG59XG5DYXB0dXJlZFRyYWNlLnNldEJvdW5kcyA9IGZ1bmN0aW9uKGZpcnN0TGluZUVycm9yLCBsYXN0TGluZUVycm9yKSB7XG4gICAgaWYgKCFDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCkpIHJldHVybjtcbiAgICB2YXIgZmlyc3RTdGFja0xpbmVzID0gZmlyc3RMaW5lRXJyb3Iuc3RhY2suc3BsaXQoXCJcXG5cIik7XG4gICAgdmFyIGxhc3RTdGFja0xpbmVzID0gbGFzdExpbmVFcnJvci5zdGFjay5zcGxpdChcIlxcblwiKTtcbiAgICB2YXIgZmlyc3RJbmRleCA9IC0xO1xuICAgIHZhciBsYXN0SW5kZXggPSAtMTtcbiAgICB2YXIgZmlyc3RGaWxlTmFtZTtcbiAgICB2YXIgbGFzdEZpbGVOYW1lO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlyc3RTdGFja0xpbmVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSBwYXJzZUxpbmVJbmZvKGZpcnN0U3RhY2tMaW5lc1tpXSk7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgIGZpcnN0RmlsZU5hbWUgPSByZXN1bHQuZmlsZU5hbWU7XG4gICAgICAgICAgICBmaXJzdEluZGV4ID0gcmVzdWx0LmxpbmU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxhc3RTdGFja0xpbmVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSBwYXJzZUxpbmVJbmZvKGxhc3RTdGFja0xpbmVzW2ldKTtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgbGFzdEZpbGVOYW1lID0gcmVzdWx0LmZpbGVOYW1lO1xuICAgICAgICAgICAgbGFzdEluZGV4ID0gcmVzdWx0LmxpbmU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoZmlyc3RJbmRleCA8IDAgfHwgbGFzdEluZGV4IDwgMCB8fCAhZmlyc3RGaWxlTmFtZSB8fCAhbGFzdEZpbGVOYW1lIHx8XG4gICAgICAgIGZpcnN0RmlsZU5hbWUgIT09IGxhc3RGaWxlTmFtZSB8fCBmaXJzdEluZGV4ID49IGxhc3RJbmRleCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgc2hvdWxkSWdub3JlID0gZnVuY3Rpb24obGluZSkge1xuICAgICAgICBpZiAoYmx1ZWJpcmRGcmFtZVBhdHRlcm4udGVzdChsaW5lKSkgcmV0dXJuIHRydWU7XG4gICAgICAgIHZhciBpbmZvID0gcGFyc2VMaW5lSW5mbyhsaW5lKTtcbiAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgIGlmIChpbmZvLmZpbGVOYW1lID09PSBmaXJzdEZpbGVOYW1lICYmXG4gICAgICAgICAgICAgICAgKGZpcnN0SW5kZXggPD0gaW5mby5saW5lICYmIGluZm8ubGluZSA8PSBsYXN0SW5kZXgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG59O1xuXG52YXIgY2FwdHVyZVN0YWNrVHJhY2UgPSAoZnVuY3Rpb24gc3RhY2tEZXRlY3Rpb24oKSB7XG4gICAgdmFyIHY4c3RhY2tGcmFtZVBhdHRlcm4gPSAvXlxccyphdFxccyovO1xuICAgIHZhciB2OHN0YWNrRm9ybWF0dGVyID0gZnVuY3Rpb24oc3RhY2ssIGVycm9yKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygc3RhY2sgPT09IFwic3RyaW5nXCIpIHJldHVybiBzdGFjaztcblxuICAgICAgICBpZiAoZXJyb3IubmFtZSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICBlcnJvci5tZXNzYWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBlcnJvci50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7XG4gICAgfTtcblxuICAgIGlmICh0eXBlb2YgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID09PSBcIm51bWJlclwiICYmXG4gICAgICAgIHR5cGVvZiBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIEVycm9yLnN0YWNrVHJhY2VMaW1pdCA9IEVycm9yLnN0YWNrVHJhY2VMaW1pdCArIDY7XG4gICAgICAgIHN0YWNrRnJhbWVQYXR0ZXJuID0gdjhzdGFja0ZyYW1lUGF0dGVybjtcbiAgICAgICAgZm9ybWF0U3RhY2sgPSB2OHN0YWNrRm9ybWF0dGVyO1xuICAgICAgICB2YXIgY2FwdHVyZVN0YWNrVHJhY2UgPSBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZTtcblxuICAgICAgICBzaG91bGRJZ25vcmUgPSBmdW5jdGlvbihsaW5lKSB7XG4gICAgICAgICAgICByZXR1cm4gYmx1ZWJpcmRGcmFtZVBhdHRlcm4udGVzdChsaW5lKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHJlY2VpdmVyLCBpZ25vcmVVbnRpbCkge1xuICAgICAgICAgICAgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ICsgNjtcbiAgICAgICAgICAgIGNhcHR1cmVTdGFja1RyYWNlKHJlY2VpdmVyLCBpZ25vcmVVbnRpbCk7XG4gICAgICAgICAgICBFcnJvci5zdGFja1RyYWNlTGltaXQgPSBFcnJvci5zdGFja1RyYWNlTGltaXQgLSA2O1xuICAgICAgICB9O1xuICAgIH1cbiAgICB2YXIgZXJyID0gbmV3IEVycm9yKCk7XG5cbiAgICBpZiAodHlwZW9mIGVyci5zdGFjayA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgICBlcnIuc3RhY2suc3BsaXQoXCJcXG5cIilbMF0uaW5kZXhPZihcInN0YWNrRGV0ZWN0aW9uQFwiKSA+PSAwKSB7XG4gICAgICAgIHN0YWNrRnJhbWVQYXR0ZXJuID0gL0AvO1xuICAgICAgICBmb3JtYXRTdGFjayA9IHY4c3RhY2tGb3JtYXR0ZXI7XG4gICAgICAgIGluZGVudFN0YWNrRnJhbWVzID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhcHR1cmVTdGFja1RyYWNlKG8pIHtcbiAgICAgICAgICAgIG8uc3RhY2sgPSBuZXcgRXJyb3IoKS5zdGFjaztcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICB2YXIgaGFzU3RhY2tBZnRlclRocm93O1xuICAgIHRyeSB7IHRocm93IG5ldyBFcnJvcigpOyB9XG4gICAgY2F0Y2goZSkge1xuICAgICAgICBoYXNTdGFja0FmdGVyVGhyb3cgPSAoXCJzdGFja1wiIGluIGUpO1xuICAgIH1cbiAgICBpZiAoIShcInN0YWNrXCIgaW4gZXJyKSAmJiBoYXNTdGFja0FmdGVyVGhyb3cgJiZcbiAgICAgICAgdHlwZW9mIEVycm9yLnN0YWNrVHJhY2VMaW1pdCA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICBzdGFja0ZyYW1lUGF0dGVybiA9IHY4c3RhY2tGcmFtZVBhdHRlcm47XG4gICAgICAgIGZvcm1hdFN0YWNrID0gdjhzdGFja0Zvcm1hdHRlcjtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhcHR1cmVTdGFja1RyYWNlKG8pIHtcbiAgICAgICAgICAgIEVycm9yLnN0YWNrVHJhY2VMaW1pdCA9IEVycm9yLnN0YWNrVHJhY2VMaW1pdCArIDY7XG4gICAgICAgICAgICB0cnkgeyB0aHJvdyBuZXcgRXJyb3IoKTsgfVxuICAgICAgICAgICAgY2F0Y2goZSkgeyBvLnN0YWNrID0gZS5zdGFjazsgfVxuICAgICAgICAgICAgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gRXJyb3Iuc3RhY2tUcmFjZUxpbWl0IC0gNjtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBmb3JtYXRTdGFjayA9IGZ1bmN0aW9uKHN0YWNrLCBlcnJvcikge1xuICAgICAgICBpZiAodHlwZW9mIHN0YWNrID09PSBcInN0cmluZ1wiKSByZXR1cm4gc3RhY2s7XG5cbiAgICAgICAgaWYgKCh0eXBlb2YgZXJyb3IgPT09IFwib2JqZWN0XCIgfHxcbiAgICAgICAgICAgIHR5cGVvZiBlcnJvciA9PT0gXCJmdW5jdGlvblwiKSAmJlxuICAgICAgICAgICAgZXJyb3IubmFtZSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICBlcnJvci5tZXNzYWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBlcnJvci50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7XG4gICAgfTtcblxuICAgIHJldHVybiBudWxsO1xuXG59KShbXSk7XG5cbnZhciBmaXJlRG9tRXZlbnQ7XG52YXIgZmlyZUdsb2JhbEV2ZW50ID0gKGZ1bmN0aW9uKCkge1xuICAgIGlmICh1dGlsLmlzTm9kZSkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSwgcmVhc29uLCBwcm9taXNlKSB7XG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gXCJyZWplY3Rpb25IYW5kbGVkXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5lbWl0KG5hbWUsIHByb21pc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5lbWl0KG5hbWUsIHJlYXNvbiwgcHJvbWlzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGN1c3RvbUV2ZW50V29ya3MgPSBmYWxzZTtcbiAgICAgICAgdmFyIGFueUV2ZW50V29ya3MgPSB0cnVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFyIGV2ID0gbmV3IHNlbGYuQ3VzdG9tRXZlbnQoXCJ0ZXN0XCIpO1xuICAgICAgICAgICAgY3VzdG9tRXZlbnRXb3JrcyA9IGV2IGluc3RhbmNlb2YgQ3VzdG9tRXZlbnQ7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHt9XG4gICAgICAgIGlmICghY3VzdG9tRXZlbnRXb3Jrcykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChcIkN1c3RvbUV2ZW50XCIpO1xuICAgICAgICAgICAgICAgIGV2ZW50LmluaXRDdXN0b21FdmVudChcInRlc3Rpbmd0aGVldmVudFwiLCBmYWxzZSwgdHJ1ZSwge30pO1xuICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgYW55RXZlbnRXb3JrcyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChhbnlFdmVudFdvcmtzKSB7XG4gICAgICAgICAgICBmaXJlRG9tRXZlbnQgPSBmdW5jdGlvbih0eXBlLCBkZXRhaWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgZXZlbnQ7XG4gICAgICAgICAgICAgICAgaWYgKGN1c3RvbUV2ZW50V29ya3MpIHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZXcgc2VsZi5DdXN0b21FdmVudCh0eXBlLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWw6IGRldGFpbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1YmJsZXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsYWJsZTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlbGYuZGlzcGF0Y2hFdmVudCkge1xuICAgICAgICAgICAgICAgICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KFwiQ3VzdG9tRXZlbnRcIik7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRDdXN0b21FdmVudCh0eXBlLCBmYWxzZSwgdHJ1ZSwgZGV0YWlsKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQgPyAhc2VsZi5kaXNwYXRjaEV2ZW50KGV2ZW50KSA6IGZhbHNlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciB0b1dpbmRvd01ldGhvZE5hbWVNYXAgPSB7fTtcbiAgICAgICAgdG9XaW5kb3dNZXRob2ROYW1lTWFwW1widW5oYW5kbGVkUmVqZWN0aW9uXCJdID0gKFwib25cIiArXG4gICAgICAgICAgICBcInVuaGFuZGxlZFJlamVjdGlvblwiKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB0b1dpbmRvd01ldGhvZE5hbWVNYXBbXCJyZWplY3Rpb25IYW5kbGVkXCJdID0gKFwib25cIiArXG4gICAgICAgICAgICBcInJlamVjdGlvbkhhbmRsZWRcIikudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSwgcmVhc29uLCBwcm9taXNlKSB7XG4gICAgICAgICAgICB2YXIgbWV0aG9kTmFtZSA9IHRvV2luZG93TWV0aG9kTmFtZU1hcFtuYW1lXTtcbiAgICAgICAgICAgIHZhciBtZXRob2QgPSBzZWxmW21ldGhvZE5hbWVdO1xuICAgICAgICAgICAgaWYgKCFtZXRob2QpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSBcInJlamVjdGlvbkhhbmRsZWRcIikge1xuICAgICAgICAgICAgICAgIG1ldGhvZC5jYWxsKHNlbGYsIHByb21pc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtZXRob2QuY2FsbChzZWxmLCByZWFzb24sIHByb21pc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgfVxufSkoKTtcblxuaWYgKHR5cGVvZiBjb25zb2xlICE9PSBcInVuZGVmaW5lZFwiICYmIHR5cGVvZiBjb25zb2xlLndhcm4gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICB3YXJuID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgY29uc29sZS53YXJuKG1lc3NhZ2UpO1xuICAgIH07XG4gICAgaWYgKHV0aWwuaXNOb2RlICYmIHByb2Nlc3Muc3RkZXJyLmlzVFRZKSB7XG4gICAgICAgIHdhcm4gPSBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShcIlxcdTAwMWJbMzFtXCIgKyBtZXNzYWdlICsgXCJcXHUwMDFiWzM5bVxcblwiKTtcbiAgICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKCF1dGlsLmlzTm9kZSAmJiB0eXBlb2YgKG5ldyBFcnJvcigpLnN0YWNrKSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICB3YXJuID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiJWNcIiArIG1lc3NhZ2UsIFwiY29sb3I6IHJlZFwiKTtcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbnJldHVybiBDYXB0dXJlZFRyYWNlO1xufTtcblxufSx7XCIuL2FzeW5jLmpzXCI6MixcIi4vdXRpbC5qc1wiOjM4fV0sODpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oTkVYVF9GSUxURVIpIHtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBlcnJvcnMgPSBfZGVyZXFfKFwiLi9lcnJvcnMuanNcIik7XG52YXIgdHJ5Q2F0Y2ggPSB1dGlsLnRyeUNhdGNoO1xudmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajtcbnZhciBrZXlzID0gX2RlcmVxXyhcIi4vZXM1LmpzXCIpLmtleXM7XG52YXIgVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjtcblxuZnVuY3Rpb24gQ2F0Y2hGaWx0ZXIoaW5zdGFuY2VzLCBjYWxsYmFjaywgcHJvbWlzZSkge1xuICAgIHRoaXMuX2luc3RhbmNlcyA9IGluc3RhbmNlcztcbiAgICB0aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgIHRoaXMuX3Byb21pc2UgPSBwcm9taXNlO1xufVxuXG5mdW5jdGlvbiBzYWZlUHJlZGljYXRlKHByZWRpY2F0ZSwgZSkge1xuICAgIHZhciBzYWZlT2JqZWN0ID0ge307XG4gICAgdmFyIHJldGZpbHRlciA9IHRyeUNhdGNoKHByZWRpY2F0ZSkuY2FsbChzYWZlT2JqZWN0LCBlKTtcblxuICAgIGlmIChyZXRmaWx0ZXIgPT09IGVycm9yT2JqKSByZXR1cm4gcmV0ZmlsdGVyO1xuXG4gICAgdmFyIHNhZmVLZXlzID0ga2V5cyhzYWZlT2JqZWN0KTtcbiAgICBpZiAoc2FmZUtleXMubGVuZ3RoKSB7XG4gICAgICAgIGVycm9yT2JqLmUgPSBuZXcgVHlwZUVycm9yKFwiQ2F0Y2ggZmlsdGVyIG11c3QgaW5oZXJpdCBmcm9tIEVycm9yIG9yIGJlIGEgc2ltcGxlIHByZWRpY2F0ZSBmdW5jdGlvblxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsL284NG82OFxcdTAwMGFcIik7XG4gICAgICAgIHJldHVybiBlcnJvck9iajtcbiAgICB9XG4gICAgcmV0dXJuIHJldGZpbHRlcjtcbn1cblxuQ2F0Y2hGaWx0ZXIucHJvdG90eXBlLmRvRmlsdGVyID0gZnVuY3Rpb24gKGUpIHtcbiAgICB2YXIgY2IgPSB0aGlzLl9jYWxsYmFjaztcbiAgICB2YXIgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2U7XG4gICAgdmFyIGJvdW5kVG8gPSBwcm9taXNlLl9ib3VuZFZhbHVlKCk7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2luc3RhbmNlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkge1xuICAgICAgICB2YXIgaXRlbSA9IHRoaXMuX2luc3RhbmNlc1tpXTtcbiAgICAgICAgdmFyIGl0ZW1Jc0Vycm9yVHlwZSA9IGl0ZW0gPT09IEVycm9yIHx8XG4gICAgICAgICAgICAoaXRlbSAhPSBudWxsICYmIGl0ZW0ucHJvdG90eXBlIGluc3RhbmNlb2YgRXJyb3IpO1xuXG4gICAgICAgIGlmIChpdGVtSXNFcnJvclR5cGUgJiYgZSBpbnN0YW5jZW9mIGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciByZXQgPSB0cnlDYXRjaChjYikuY2FsbChib3VuZFRvLCBlKTtcbiAgICAgICAgICAgIGlmIChyZXQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgICAgICAgICAgTkVYVF9GSUxURVIuZSA9IHJldC5lO1xuICAgICAgICAgICAgICAgIHJldHVybiBORVhUX0ZJTFRFUjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT09IFwiZnVuY3Rpb25cIiAmJiAhaXRlbUlzRXJyb3JUeXBlKSB7XG4gICAgICAgICAgICB2YXIgc2hvdWxkSGFuZGxlID0gc2FmZVByZWRpY2F0ZShpdGVtLCBlKTtcbiAgICAgICAgICAgIGlmIChzaG91bGRIYW5kbGUgPT09IGVycm9yT2JqKSB7XG4gICAgICAgICAgICAgICAgZSA9IGVycm9yT2JqLmU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZEhhbmRsZSkge1xuICAgICAgICAgICAgICAgIHZhciByZXQgPSB0cnlDYXRjaChjYikuY2FsbChib3VuZFRvLCBlKTtcbiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikge1xuICAgICAgICAgICAgICAgICAgICBORVhUX0ZJTFRFUi5lID0gcmV0LmU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBORVhUX0ZJTFRFUjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBORVhUX0ZJTFRFUi5lID0gZTtcbiAgICByZXR1cm4gTkVYVF9GSUxURVI7XG59O1xuXG5yZXR1cm4gQ2F0Y2hGaWx0ZXI7XG59O1xuXG59LHtcIi4vZXJyb3JzLmpzXCI6MTMsXCIuL2VzNS5qc1wiOjE0LFwiLi91dGlsLmpzXCI6Mzh9XSw5OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBDYXB0dXJlZFRyYWNlLCBpc0RlYnVnZ2luZykge1xudmFyIGNvbnRleHRTdGFjayA9IFtdO1xuZnVuY3Rpb24gQ29udGV4dCgpIHtcbiAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKHBlZWtDb250ZXh0KCkpO1xufVxuQ29udGV4dC5wcm90b3R5cGUuX3B1c2hDb250ZXh0ID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICghaXNEZWJ1Z2dpbmcoKSkgcmV0dXJuO1xuICAgIGlmICh0aGlzLl90cmFjZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnRleHRTdGFjay5wdXNoKHRoaXMuX3RyYWNlKTtcbiAgICB9XG59O1xuXG5Db250ZXh0LnByb3RvdHlwZS5fcG9wQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIWlzRGVidWdnaW5nKCkpIHJldHVybjtcbiAgICBpZiAodGhpcy5fdHJhY2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb250ZXh0U3RhY2sucG9wKCk7XG4gICAgfVxufTtcblxuZnVuY3Rpb24gY3JlYXRlQ29udGV4dCgpIHtcbiAgICBpZiAoaXNEZWJ1Z2dpbmcoKSkgcmV0dXJuIG5ldyBDb250ZXh0KCk7XG59XG5cbmZ1bmN0aW9uIHBlZWtDb250ZXh0KCkge1xuICAgIHZhciBsYXN0SW5kZXggPSBjb250ZXh0U3RhY2subGVuZ3RoIC0gMTtcbiAgICBpZiAobGFzdEluZGV4ID49IDApIHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRTdGFja1tsYXN0SW5kZXhdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5Qcm9taXNlLnByb3RvdHlwZS5fcGVla0NvbnRleHQgPSBwZWVrQ29udGV4dDtcblByb21pc2UucHJvdG90eXBlLl9wdXNoQ29udGV4dCA9IENvbnRleHQucHJvdG90eXBlLl9wdXNoQ29udGV4dDtcblByb21pc2UucHJvdG90eXBlLl9wb3BDb250ZXh0ID0gQ29udGV4dC5wcm90b3R5cGUuX3BvcENvbnRleHQ7XG5cbnJldHVybiBjcmVhdGVDb250ZXh0O1xufTtcblxufSx7fV0sMTA6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIENhcHR1cmVkVHJhY2UpIHtcbnZhciBnZXREb21haW4gPSBQcm9taXNlLl9nZXREb21haW47XG52YXIgYXN5bmMgPSBfZGVyZXFfKFwiLi9hc3luYy5qc1wiKTtcbnZhciBXYXJuaW5nID0gX2RlcmVxXyhcIi4vZXJyb3JzLmpzXCIpLldhcm5pbmc7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgY2FuQXR0YWNoVHJhY2UgPSB1dGlsLmNhbkF0dGFjaFRyYWNlO1xudmFyIHVuaGFuZGxlZFJlamVjdGlvbkhhbmRsZWQ7XG52YXIgcG9zc2libHlVbmhhbmRsZWRSZWplY3Rpb247XG52YXIgZGVidWdnaW5nID0gZmFsc2UgfHwgKHV0aWwuaXNOb2RlICYmXG4gICAgICAgICAgICAgICAgICAgICghIXByb2Nlc3MuZW52W1wiQkxVRUJJUkRfREVCVUdcIl0gfHxcbiAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52W1wiTk9ERV9FTlZcIl0gPT09IFwiZGV2ZWxvcG1lbnRcIikpO1xuXG5pZiAoZGVidWdnaW5nKSB7XG4gICAgYXN5bmMuZGlzYWJsZVRyYW1wb2xpbmVJZk5lY2Vzc2FyeSgpO1xufVxuXG5Qcm9taXNlLnByb3RvdHlwZS5faWdub3JlUmVqZWN0aW9ucyA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTtcbiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgMTY3NzcyMTY7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fZW5zdXJlUG9zc2libGVSZWplY3Rpb25IYW5kbGVkID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICgodGhpcy5fYml0RmllbGQgJiAxNjc3NzIxNikgIT09IDApIHJldHVybjtcbiAgICB0aGlzLl9zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpO1xuICAgIGFzeW5jLmludm9rZUxhdGVyKHRoaXMuX25vdGlmeVVuaGFuZGxlZFJlamVjdGlvbiwgdGhpcywgdW5kZWZpbmVkKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25Jc0hhbmRsZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgQ2FwdHVyZWRUcmFjZS5maXJlUmVqZWN0aW9uRXZlbnQoXCJyZWplY3Rpb25IYW5kbGVkXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5oYW5kbGVkUmVqZWN0aW9uSGFuZGxlZCwgdW5kZWZpbmVkLCB0aGlzKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHtcbiAgICAgICAgdmFyIHJlYXNvbiA9IHRoaXMuX2dldENhcnJpZWRTdGFja1RyYWNlKCkgfHwgdGhpcy5fc2V0dGxlZFZhbHVlO1xuICAgICAgICB0aGlzLl9zZXRVbmhhbmRsZWRSZWplY3Rpb25Jc05vdGlmaWVkKCk7XG4gICAgICAgIENhcHR1cmVkVHJhY2UuZmlyZVJlamVjdGlvbkV2ZW50KFwidW5oYW5kbGVkUmVqZWN0aW9uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uLCByZWFzb24sIHRoaXMpO1xuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRVbmhhbmRsZWRSZWplY3Rpb25Jc05vdGlmaWVkID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCA1MjQyODg7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fdW5zZXRVbmhhbmRsZWRSZWplY3Rpb25Jc05vdGlmaWVkID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjUyNDI4OCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNTI0Mjg4KSA+IDA7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDIwOTcxNTI7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fdW5zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkICYgKH4yMDk3MTUyKTtcbiAgICBpZiAodGhpcy5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCgpKSB7XG4gICAgICAgIHRoaXMuX3Vuc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCgpO1xuICAgICAgICB0aGlzLl9ub3RpZnlVbmhhbmRsZWRSZWplY3Rpb25Jc0hhbmRsZWQoKTtcbiAgICB9XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5faXNSZWplY3Rpb25VbmhhbmRsZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDIwOTcxNTIpID4gMDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSA9IGZ1bmN0aW9uIChjYXB0dXJlZFRyYWNlKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDEwNDg1NzY7XG4gICAgdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IGNhcHR1cmVkVHJhY2U7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5faXNDYXJyeWluZ1N0YWNrVHJhY2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDEwNDg1NzYpID4gMDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNDYXJyeWluZ1N0YWNrVHJhY2UoKVxuICAgICAgICA/IHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjBcbiAgICAgICAgOiB1bmRlZmluZWQ7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fY2FwdHVyZVN0YWNrVHJhY2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKGRlYnVnZ2luZykge1xuICAgICAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKHRoaXMuX3BlZWtDb250ZXh0KCkpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9hdHRhY2hFeHRyYVRyYWNlID0gZnVuY3Rpb24gKGVycm9yLCBpZ25vcmVTZWxmKSB7XG4gICAgaWYgKGRlYnVnZ2luZyAmJiBjYW5BdHRhY2hUcmFjZShlcnJvcikpIHtcbiAgICAgICAgdmFyIHRyYWNlID0gdGhpcy5fdHJhY2U7XG4gICAgICAgIGlmICh0cmFjZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoaWdub3JlU2VsZikgdHJhY2UgPSB0cmFjZS5fcGFyZW50O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0cmFjZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0cmFjZS5hdHRhY2hFeHRyYVRyYWNlKGVycm9yKTtcbiAgICAgICAgfSBlbHNlIGlmICghZXJyb3IuX19zdGFja0NsZWFuZWRfXykge1xuICAgICAgICAgICAgdmFyIHBhcnNlZCA9IENhcHR1cmVkVHJhY2UucGFyc2VTdGFja0FuZE1lc3NhZ2UoZXJyb3IpO1xuICAgICAgICAgICAgdXRpbC5ub3RFbnVtZXJhYmxlUHJvcChlcnJvciwgXCJzdGFja1wiLFxuICAgICAgICAgICAgICAgIHBhcnNlZC5tZXNzYWdlICsgXCJcXG5cIiArIHBhcnNlZC5zdGFjay5qb2luKFwiXFxuXCIpKTtcbiAgICAgICAgICAgIHV0aWwubm90RW51bWVyYWJsZVByb3AoZXJyb3IsIFwiX19zdGFja0NsZWFuZWRfX1wiLCB0cnVlKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl93YXJuID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgIHZhciB3YXJuaW5nID0gbmV3IFdhcm5pbmcobWVzc2FnZSk7XG4gICAgdmFyIGN0eCA9IHRoaXMuX3BlZWtDb250ZXh0KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgICBjdHguYXR0YWNoRXh0cmFUcmFjZSh3YXJuaW5nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcGFyc2VkID0gQ2FwdHVyZWRUcmFjZS5wYXJzZVN0YWNrQW5kTWVzc2FnZSh3YXJuaW5nKTtcbiAgICAgICAgd2FybmluZy5zdGFjayA9IHBhcnNlZC5tZXNzYWdlICsgXCJcXG5cIiArIHBhcnNlZC5zdGFjay5qb2luKFwiXFxuXCIpO1xuICAgIH1cbiAgICBDYXB0dXJlZFRyYWNlLmZvcm1hdEFuZExvZ0Vycm9yKHdhcm5pbmcsIFwiXCIpO1xufTtcblxuUHJvbWlzZS5vblBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgdmFyIGRvbWFpbiA9IGdldERvbWFpbigpO1xuICAgIHBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID1cbiAgICAgICAgdHlwZW9mIGZuID09PSBcImZ1bmN0aW9uXCIgPyAoZG9tYWluID09PSBudWxsID8gZm4gOiBkb21haW4uYmluZChmbikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDtcbn07XG5cblByb21pc2Uub25VbmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgdmFyIGRvbWFpbiA9IGdldERvbWFpbigpO1xuICAgIHVuaGFuZGxlZFJlamVjdGlvbkhhbmRsZWQgPVxuICAgICAgICB0eXBlb2YgZm4gPT09IFwiZnVuY3Rpb25cIiA/IChkb21haW4gPT09IG51bGwgPyBmbiA6IGRvbWFpbi5iaW5kKGZuKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xufTtcblxuUHJvbWlzZS5sb25nU3RhY2tUcmFjZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKGFzeW5jLmhhdmVJdGVtc1F1ZXVlZCgpICYmXG4gICAgICAgIGRlYnVnZ2luZyA9PT0gZmFsc2VcbiAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJjYW5ub3QgZW5hYmxlIGxvbmcgc3RhY2sgdHJhY2VzIGFmdGVyIHByb21pc2VzIGhhdmUgYmVlbiBjcmVhdGVkXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvRFQxcXlHXFx1MDAwYVwiKTtcbiAgICB9XG4gICAgZGVidWdnaW5nID0gQ2FwdHVyZWRUcmFjZS5pc1N1cHBvcnRlZCgpO1xuICAgIGlmIChkZWJ1Z2dpbmcpIHtcbiAgICAgICAgYXN5bmMuZGlzYWJsZVRyYW1wb2xpbmVJZk5lY2Vzc2FyeSgpO1xuICAgIH1cbn07XG5cblByb21pc2UuaGFzTG9uZ1N0YWNrVHJhY2VzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkZWJ1Z2dpbmcgJiYgQ2FwdHVyZWRUcmFjZS5pc1N1cHBvcnRlZCgpO1xufTtcblxuaWYgKCFDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCkpIHtcbiAgICBQcm9taXNlLmxvbmdTdGFja1RyYWNlcyA9IGZ1bmN0aW9uKCl7fTtcbiAgICBkZWJ1Z2dpbmcgPSBmYWxzZTtcbn1cblxucmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBkZWJ1Z2dpbmc7XG59O1xufTtcblxufSx7XCIuL2FzeW5jLmpzXCI6MixcIi4vZXJyb3JzLmpzXCI6MTMsXCIuL3V0aWwuanNcIjozOH1dLDExOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIGlzUHJpbWl0aXZlID0gdXRpbC5pc1ByaW1pdGl2ZTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlKSB7XG52YXIgcmV0dXJuZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXM7XG59O1xudmFyIHRocm93ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhyb3cgdGhpcztcbn07XG52YXIgcmV0dXJuVW5kZWZpbmVkID0gZnVuY3Rpb24oKSB7fTtcbnZhciB0aHJvd1VuZGVmaW5lZCA9IGZ1bmN0aW9uKCkge1xuICAgIHRocm93IHVuZGVmaW5lZDtcbn07XG5cbnZhciB3cmFwcGVyID0gZnVuY3Rpb24gKHZhbHVlLCBhY3Rpb24pIHtcbiAgICBpZiAoYWN0aW9uID09PSAxKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aHJvdyB2YWx1ZTtcbiAgICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gMikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9O1xuICAgIH1cbn07XG5cblxuUHJvbWlzZS5wcm90b3R5cGVbXCJyZXR1cm5cIl0gPVxuUHJvbWlzZS5wcm90b3R5cGUudGhlblJldHVybiA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdGhpcy50aGVuKHJldHVyblVuZGVmaW5lZCk7XG5cbiAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90aGVuKFxuICAgICAgICAgICAgd3JhcHBlcih2YWx1ZSwgMiksXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICB1bmRlZmluZWRcbiAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdGhlbihyZXR1cm5lciwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHZhbHVlLCB1bmRlZmluZWQpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGVbXCJ0aHJvd1wiXSA9XG5Qcm9taXNlLnByb3RvdHlwZS50aGVuVGhyb3cgPSBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgaWYgKHJlYXNvbiA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdGhpcy50aGVuKHRocm93VW5kZWZpbmVkKTtcblxuICAgIGlmIChpc1ByaW1pdGl2ZShyZWFzb24pKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90aGVuKFxuICAgICAgICAgICAgd3JhcHBlcihyZWFzb24sIDEpLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3RoZW4odGhyb3dlciwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHJlYXNvbiwgdW5kZWZpbmVkKTtcbn07XG59O1xuXG59LHtcIi4vdXRpbC5qc1wiOjM4fV0sMTI6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7XG52YXIgUHJvbWlzZVJlZHVjZSA9IFByb21pc2UucmVkdWNlO1xuXG5Qcm9taXNlLnByb3RvdHlwZS5lYWNoID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgcmV0dXJuIFByb21pc2VSZWR1Y2UodGhpcywgZm4sIG51bGwsIElOVEVSTkFMKTtcbn07XG5cblByb21pc2UuZWFjaCA9IGZ1bmN0aW9uIChwcm9taXNlcywgZm4pIHtcbiAgICByZXR1cm4gUHJvbWlzZVJlZHVjZShwcm9taXNlcywgZm4sIG51bGwsIElOVEVSTkFMKTtcbn07XG59O1xuXG59LHt9XSwxMzpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbnZhciBlczUgPSBfZGVyZXFfKFwiLi9lczUuanNcIik7XG52YXIgT2JqZWN0ZnJlZXplID0gZXM1LmZyZWV6ZTtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBpbmhlcml0cyA9IHV0aWwuaW5oZXJpdHM7XG52YXIgbm90RW51bWVyYWJsZVByb3AgPSB1dGlsLm5vdEVudW1lcmFibGVQcm9wO1xuXG5mdW5jdGlvbiBzdWJFcnJvcihuYW1lUHJvcGVydHksIGRlZmF1bHRNZXNzYWdlKSB7XG4gICAgZnVuY3Rpb24gU3ViRXJyb3IobWVzc2FnZSkge1xuICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU3ViRXJyb3IpKSByZXR1cm4gbmV3IFN1YkVycm9yKG1lc3NhZ2UpO1xuICAgICAgICBub3RFbnVtZXJhYmxlUHJvcCh0aGlzLCBcIm1lc3NhZ2VcIixcbiAgICAgICAgICAgIHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiID8gbWVzc2FnZSA6IGRlZmF1bHRNZXNzYWdlKTtcbiAgICAgICAgbm90RW51bWVyYWJsZVByb3AodGhpcywgXCJuYW1lXCIsIG5hbWVQcm9wZXJ0eSk7XG4gICAgICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkge1xuICAgICAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgdGhpcy5jb25zdHJ1Y3Rvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFcnJvci5jYWxsKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGluaGVyaXRzKFN1YkVycm9yLCBFcnJvcik7XG4gICAgcmV0dXJuIFN1YkVycm9yO1xufVxuXG52YXIgX1R5cGVFcnJvciwgX1JhbmdlRXJyb3I7XG52YXIgV2FybmluZyA9IHN1YkVycm9yKFwiV2FybmluZ1wiLCBcIndhcm5pbmdcIik7XG52YXIgQ2FuY2VsbGF0aW9uRXJyb3IgPSBzdWJFcnJvcihcIkNhbmNlbGxhdGlvbkVycm9yXCIsIFwiY2FuY2VsbGF0aW9uIGVycm9yXCIpO1xudmFyIFRpbWVvdXRFcnJvciA9IHN1YkVycm9yKFwiVGltZW91dEVycm9yXCIsIFwidGltZW91dCBlcnJvclwiKTtcbnZhciBBZ2dyZWdhdGVFcnJvciA9IHN1YkVycm9yKFwiQWdncmVnYXRlRXJyb3JcIiwgXCJhZ2dyZWdhdGUgZXJyb3JcIik7XG50cnkge1xuICAgIF9UeXBlRXJyb3IgPSBUeXBlRXJyb3I7XG4gICAgX1JhbmdlRXJyb3IgPSBSYW5nZUVycm9yO1xufSBjYXRjaChlKSB7XG4gICAgX1R5cGVFcnJvciA9IHN1YkVycm9yKFwiVHlwZUVycm9yXCIsIFwidHlwZSBlcnJvclwiKTtcbiAgICBfUmFuZ2VFcnJvciA9IHN1YkVycm9yKFwiUmFuZ2VFcnJvclwiLCBcInJhbmdlIGVycm9yXCIpO1xufVxuXG52YXIgbWV0aG9kcyA9IChcImpvaW4gcG9wIHB1c2ggc2hpZnQgdW5zaGlmdCBzbGljZSBmaWx0ZXIgZm9yRWFjaCBzb21lIFwiICtcbiAgICBcImV2ZXJ5IG1hcCBpbmRleE9mIGxhc3RJbmRleE9mIHJlZHVjZSByZWR1Y2VSaWdodCBzb3J0IHJldmVyc2VcIikuc3BsaXQoXCIgXCIpO1xuXG5mb3IgKHZhciBpID0gMDsgaSA8IG1ldGhvZHMubGVuZ3RoOyArK2kpIHtcbiAgICBpZiAodHlwZW9mIEFycmF5LnByb3RvdHlwZVttZXRob2RzW2ldXSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIEFnZ3JlZ2F0ZUVycm9yLnByb3RvdHlwZVttZXRob2RzW2ldXSA9IEFycmF5LnByb3RvdHlwZVttZXRob2RzW2ldXTtcbiAgICB9XG59XG5cbmVzNS5kZWZpbmVQcm9wZXJ0eShBZ2dyZWdhdGVFcnJvci5wcm90b3R5cGUsIFwibGVuZ3RoXCIsIHtcbiAgICB2YWx1ZTogMCxcbiAgICBjb25maWd1cmFibGU6IGZhbHNlLFxuICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgIGVudW1lcmFibGU6IHRydWVcbn0pO1xuQWdncmVnYXRlRXJyb3IucHJvdG90eXBlW1wiaXNPcGVyYXRpb25hbFwiXSA9IHRydWU7XG52YXIgbGV2ZWwgPSAwO1xuQWdncmVnYXRlRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGluZGVudCA9IEFycmF5KGxldmVsICogNCArIDEpLmpvaW4oXCIgXCIpO1xuICAgIHZhciByZXQgPSBcIlxcblwiICsgaW5kZW50ICsgXCJBZ2dyZWdhdGVFcnJvciBvZjpcIiArIFwiXFxuXCI7XG4gICAgbGV2ZWwrKztcbiAgICBpbmRlbnQgPSBBcnJheShsZXZlbCAqIDQgKyAxKS5qb2luKFwiIFwiKTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIHN0ciA9IHRoaXNbaV0gPT09IHRoaXMgPyBcIltDaXJjdWxhciBBZ2dyZWdhdGVFcnJvcl1cIiA6IHRoaXNbaV0gKyBcIlwiO1xuICAgICAgICB2YXIgbGluZXMgPSBzdHIuc3BsaXQoXCJcXG5cIik7XG4gICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbGluZXMubGVuZ3RoOyArK2opIHtcbiAgICAgICAgICAgIGxpbmVzW2pdID0gaW5kZW50ICsgbGluZXNbal07XG4gICAgICAgIH1cbiAgICAgICAgc3RyID0gbGluZXMuam9pbihcIlxcblwiKTtcbiAgICAgICAgcmV0ICs9IHN0ciArIFwiXFxuXCI7XG4gICAgfVxuICAgIGxldmVsLS07XG4gICAgcmV0dXJuIHJldDtcbn07XG5cbmZ1bmN0aW9uIE9wZXJhdGlvbmFsRXJyb3IobWVzc2FnZSkge1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBPcGVyYXRpb25hbEVycm9yKSlcbiAgICAgICAgcmV0dXJuIG5ldyBPcGVyYXRpb25hbEVycm9yKG1lc3NhZ2UpO1xuICAgIG5vdEVudW1lcmFibGVQcm9wKHRoaXMsIFwibmFtZVwiLCBcIk9wZXJhdGlvbmFsRXJyb3JcIik7XG4gICAgbm90RW51bWVyYWJsZVByb3AodGhpcywgXCJtZXNzYWdlXCIsIG1lc3NhZ2UpO1xuICAgIHRoaXMuY2F1c2UgPSBtZXNzYWdlO1xuICAgIHRoaXNbXCJpc09wZXJhdGlvbmFsXCJdID0gdHJ1ZTtcblxuICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgbm90RW51bWVyYWJsZVByb3AodGhpcywgXCJtZXNzYWdlXCIsIG1lc3NhZ2UubWVzc2FnZSk7XG4gICAgICAgIG5vdEVudW1lcmFibGVQcm9wKHRoaXMsIFwic3RhY2tcIiwgbWVzc2FnZS5zdGFjayk7XG4gICAgfSBlbHNlIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkge1xuICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTtcbiAgICB9XG5cbn1cbmluaGVyaXRzKE9wZXJhdGlvbmFsRXJyb3IsIEVycm9yKTtcblxudmFyIGVycm9yVHlwZXMgPSBFcnJvcltcIl9fQmx1ZWJpcmRFcnJvclR5cGVzX19cIl07XG5pZiAoIWVycm9yVHlwZXMpIHtcbiAgICBlcnJvclR5cGVzID0gT2JqZWN0ZnJlZXplKHtcbiAgICAgICAgQ2FuY2VsbGF0aW9uRXJyb3I6IENhbmNlbGxhdGlvbkVycm9yLFxuICAgICAgICBUaW1lb3V0RXJyb3I6IFRpbWVvdXRFcnJvcixcbiAgICAgICAgT3BlcmF0aW9uYWxFcnJvcjogT3BlcmF0aW9uYWxFcnJvcixcbiAgICAgICAgUmVqZWN0aW9uRXJyb3I6IE9wZXJhdGlvbmFsRXJyb3IsXG4gICAgICAgIEFnZ3JlZ2F0ZUVycm9yOiBBZ2dyZWdhdGVFcnJvclxuICAgIH0pO1xuICAgIG5vdEVudW1lcmFibGVQcm9wKEVycm9yLCBcIl9fQmx1ZWJpcmRFcnJvclR5cGVzX19cIiwgZXJyb3JUeXBlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIEVycm9yOiBFcnJvcixcbiAgICBUeXBlRXJyb3I6IF9UeXBlRXJyb3IsXG4gICAgUmFuZ2VFcnJvcjogX1JhbmdlRXJyb3IsXG4gICAgQ2FuY2VsbGF0aW9uRXJyb3I6IGVycm9yVHlwZXMuQ2FuY2VsbGF0aW9uRXJyb3IsXG4gICAgT3BlcmF0aW9uYWxFcnJvcjogZXJyb3JUeXBlcy5PcGVyYXRpb25hbEVycm9yLFxuICAgIFRpbWVvdXRFcnJvcjogZXJyb3JUeXBlcy5UaW1lb3V0RXJyb3IsXG4gICAgQWdncmVnYXRlRXJyb3I6IGVycm9yVHlwZXMuQWdncmVnYXRlRXJyb3IsXG4gICAgV2FybmluZzogV2FybmluZ1xufTtcblxufSx7XCIuL2VzNS5qc1wiOjE0LFwiLi91dGlsLmpzXCI6Mzh9XSwxNDpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG52YXIgaXNFUzUgPSAoZnVuY3Rpb24oKXtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICByZXR1cm4gdGhpcyA9PT0gdW5kZWZpbmVkO1xufSkoKTtcblxuaWYgKGlzRVM1KSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgICAgIGZyZWV6ZTogT2JqZWN0LmZyZWV6ZSxcbiAgICAgICAgZGVmaW5lUHJvcGVydHk6IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSxcbiAgICAgICAgZ2V0RGVzY3JpcHRvcjogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixcbiAgICAgICAga2V5czogT2JqZWN0LmtleXMsXG4gICAgICAgIG5hbWVzOiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyxcbiAgICAgICAgZ2V0UHJvdG90eXBlT2Y6IE9iamVjdC5nZXRQcm90b3R5cGVPZixcbiAgICAgICAgaXNBcnJheTogQXJyYXkuaXNBcnJheSxcbiAgICAgICAgaXNFUzU6IGlzRVM1LFxuICAgICAgICBwcm9wZXJ0eUlzV3JpdGFibGU6IGZ1bmN0aW9uKG9iaiwgcHJvcCkge1xuICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwgcHJvcCk7XG4gICAgICAgICAgICByZXR1cm4gISEoIWRlc2NyaXB0b3IgfHwgZGVzY3JpcHRvci53cml0YWJsZSB8fCBkZXNjcmlwdG9yLnNldCk7XG4gICAgICAgIH1cbiAgICB9O1xufSBlbHNlIHtcbiAgICB2YXIgaGFzID0ge30uaGFzT3duUHJvcGVydHk7XG4gICAgdmFyIHN0ciA9IHt9LnRvU3RyaW5nO1xuICAgIHZhciBwcm90byA9IHt9LmNvbnN0cnVjdG9yLnByb3RvdHlwZTtcblxuICAgIHZhciBPYmplY3RLZXlzID0gZnVuY3Rpb24gKG8pIHtcbiAgICAgICAgdmFyIHJldCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gbykge1xuICAgICAgICAgICAgaWYgKGhhcy5jYWxsKG8sIGtleSkpIHtcbiAgICAgICAgICAgICAgICByZXQucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcblxuICAgIHZhciBPYmplY3RHZXREZXNjcmlwdG9yID0gZnVuY3Rpb24obywga2V5KSB7XG4gICAgICAgIHJldHVybiB7dmFsdWU6IG9ba2V5XX07XG4gICAgfTtcblxuICAgIHZhciBPYmplY3REZWZpbmVQcm9wZXJ0eSA9IGZ1bmN0aW9uIChvLCBrZXksIGRlc2MpIHtcbiAgICAgICAgb1trZXldID0gZGVzYy52YWx1ZTtcbiAgICAgICAgcmV0dXJuIG87XG4gICAgfTtcblxuICAgIHZhciBPYmplY3RGcmVlemUgPSBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfTtcblxuICAgIHZhciBPYmplY3RHZXRQcm90b3R5cGVPZiA9IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBPYmplY3Qob2JqKS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJldHVybiBwcm90bztcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB2YXIgQXJyYXlJc0FycmF5ID0gZnVuY3Rpb24gKG9iaikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIHN0ci5jYWxsKG9iaikgPT09IFwiW29iamVjdCBBcnJheV1cIjtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaChlKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgICAgIGlzQXJyYXk6IEFycmF5SXNBcnJheSxcbiAgICAgICAga2V5czogT2JqZWN0S2V5cyxcbiAgICAgICAgbmFtZXM6IE9iamVjdEtleXMsXG4gICAgICAgIGRlZmluZVByb3BlcnR5OiBPYmplY3REZWZpbmVQcm9wZXJ0eSxcbiAgICAgICAgZ2V0RGVzY3JpcHRvcjogT2JqZWN0R2V0RGVzY3JpcHRvcixcbiAgICAgICAgZnJlZXplOiBPYmplY3RGcmVlemUsXG4gICAgICAgIGdldFByb3RvdHlwZU9mOiBPYmplY3RHZXRQcm90b3R5cGVPZixcbiAgICAgICAgaXNFUzU6IGlzRVM1LFxuICAgICAgICBwcm9wZXJ0eUlzV3JpdGFibGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9O1xufVxuXG59LHt9XSwxNTpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHtcbnZhciBQcm9taXNlTWFwID0gUHJvbWlzZS5tYXA7XG5cblByb21pc2UucHJvdG90eXBlLmZpbHRlciA9IGZ1bmN0aW9uIChmbiwgb3B0aW9ucykge1xuICAgIHJldHVybiBQcm9taXNlTWFwKHRoaXMsIGZuLCBvcHRpb25zLCBJTlRFUk5BTCk7XG59O1xuXG5Qcm9taXNlLmZpbHRlciA9IGZ1bmN0aW9uIChwcm9taXNlcywgZm4sIG9wdGlvbnMpIHtcbiAgICByZXR1cm4gUHJvbWlzZU1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIElOVEVSTkFMKTtcbn07XG59O1xuXG59LHt9XSwxNjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgTkVYVF9GSUxURVIsIHRyeUNvbnZlcnRUb1Byb21pc2UpIHtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBpc1ByaW1pdGl2ZSA9IHV0aWwuaXNQcmltaXRpdmU7XG52YXIgdGhyb3dlciA9IHV0aWwudGhyb3dlcjtcblxuZnVuY3Rpb24gcmV0dXJuVGhpcygpIHtcbiAgICByZXR1cm4gdGhpcztcbn1cbmZ1bmN0aW9uIHRocm93VGhpcygpIHtcbiAgICB0aHJvdyB0aGlzO1xufVxuZnVuY3Rpb24gcmV0dXJuJChyKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gcjtcbiAgICB9O1xufVxuZnVuY3Rpb24gdGhyb3ckKHIpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRocm93IHI7XG4gICAgfTtcbn1cbmZ1bmN0aW9uIHByb21pc2VkRmluYWxseShyZXQsIHJlYXNvbk9yVmFsdWUsIGlzRnVsZmlsbGVkKSB7XG4gICAgdmFyIHRoZW47XG4gICAgaWYgKGlzUHJpbWl0aXZlKHJlYXNvbk9yVmFsdWUpKSB7XG4gICAgICAgIHRoZW4gPSBpc0Z1bGZpbGxlZCA/IHJldHVybiQocmVhc29uT3JWYWx1ZSkgOiB0aHJvdyQocmVhc29uT3JWYWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhlbiA9IGlzRnVsZmlsbGVkID8gcmV0dXJuVGhpcyA6IHRocm93VGhpcztcbiAgICB9XG4gICAgcmV0dXJuIHJldC5fdGhlbih0aGVuLCB0aHJvd2VyLCB1bmRlZmluZWQsIHJlYXNvbk9yVmFsdWUsIHVuZGVmaW5lZCk7XG59XG5cbmZ1bmN0aW9uIGZpbmFsbHlIYW5kbGVyKHJlYXNvbk9yVmFsdWUpIHtcbiAgICB2YXIgcHJvbWlzZSA9IHRoaXMucHJvbWlzZTtcbiAgICB2YXIgaGFuZGxlciA9IHRoaXMuaGFuZGxlcjtcblxuICAgIHZhciByZXQgPSBwcm9taXNlLl9pc0JvdW5kKClcbiAgICAgICAgICAgICAgICAgICAgPyBoYW5kbGVyLmNhbGwocHJvbWlzZS5fYm91bmRWYWx1ZSgpKVxuICAgICAgICAgICAgICAgICAgICA6IGhhbmRsZXIoKTtcblxuICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gdHJ5Q29udmVydFRvUHJvbWlzZShyZXQsIHByb21pc2UpO1xuICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICAgICAgbWF5YmVQcm9taXNlID0gbWF5YmVQcm9taXNlLl90YXJnZXQoKTtcbiAgICAgICAgICAgIHJldHVybiBwcm9taXNlZEZpbmFsbHkobWF5YmVQcm9taXNlLCByZWFzb25PclZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5pc0Z1bGZpbGxlZCgpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwcm9taXNlLmlzUmVqZWN0ZWQoKSkge1xuICAgICAgICBORVhUX0ZJTFRFUi5lID0gcmVhc29uT3JWYWx1ZTtcbiAgICAgICAgcmV0dXJuIE5FWFRfRklMVEVSO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZWFzb25PclZhbHVlO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gdGFwSGFuZGxlcih2YWx1ZSkge1xuICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlO1xuICAgIHZhciBoYW5kbGVyID0gdGhpcy5oYW5kbGVyO1xuXG4gICAgdmFyIHJldCA9IHByb21pc2UuX2lzQm91bmQoKVxuICAgICAgICAgICAgICAgICAgICA/IGhhbmRsZXIuY2FsbChwcm9taXNlLl9ib3VuZFZhbHVlKCksIHZhbHVlKVxuICAgICAgICAgICAgICAgICAgICA6IGhhbmRsZXIodmFsdWUpO1xuXG4gICAgaWYgKHJldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHZhciBtYXliZVByb21pc2UgPSB0cnlDb252ZXJ0VG9Qcm9taXNlKHJldCwgcHJvbWlzZSk7XG4gICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICBtYXliZVByb21pc2UgPSBtYXliZVByb21pc2UuX3RhcmdldCgpO1xuICAgICAgICAgICAgcmV0dXJuIHByb21pc2VkRmluYWxseShtYXliZVByb21pc2UsIHZhbHVlLCB0cnVlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG59XG5cblByb21pc2UucHJvdG90eXBlLl9wYXNzVGhyb3VnaEhhbmRsZXIgPSBmdW5jdGlvbiAoaGFuZGxlciwgaXNGaW5hbGx5KSB7XG4gICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiB0aGlzLnRoZW4oKTtcblxuICAgIHZhciBwcm9taXNlQW5kSGFuZGxlciA9IHtcbiAgICAgICAgcHJvbWlzZTogdGhpcyxcbiAgICAgICAgaGFuZGxlcjogaGFuZGxlclxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5fdGhlbihcbiAgICAgICAgICAgIGlzRmluYWxseSA/IGZpbmFsbHlIYW5kbGVyIDogdGFwSGFuZGxlcixcbiAgICAgICAgICAgIGlzRmluYWxseSA/IGZpbmFsbHlIYW5kbGVyIDogdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICBwcm9taXNlQW5kSGFuZGxlciwgdW5kZWZpbmVkKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLmxhc3RseSA9XG5Qcm9taXNlLnByb3RvdHlwZVtcImZpbmFsbHlcIl0gPSBmdW5jdGlvbiAoaGFuZGxlcikge1xuICAgIHJldHVybiB0aGlzLl9wYXNzVGhyb3VnaEhhbmRsZXIoaGFuZGxlciwgdHJ1ZSk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS50YXAgPSBmdW5jdGlvbiAoaGFuZGxlcikge1xuICAgIHJldHVybiB0aGlzLl9wYXNzVGhyb3VnaEhhbmRsZXIoaGFuZGxlciwgZmFsc2UpO1xufTtcbn07XG5cbn0se1wiLi91dGlsLmpzXCI6Mzh9XSwxNzpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpUmVqZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBJTlRFUk5BTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q29udmVydFRvUHJvbWlzZSkge1xudmFyIGVycm9ycyA9IF9kZXJlcV8oXCIuL2Vycm9ycy5qc1wiKTtcbnZhciBUeXBlRXJyb3IgPSBlcnJvcnMuVHlwZUVycm9yO1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajtcbnZhciB0cnlDYXRjaCA9IHV0aWwudHJ5Q2F0Y2g7XG52YXIgeWllbGRIYW5kbGVycyA9IFtdO1xuXG5mdW5jdGlvbiBwcm9taXNlRnJvbVlpZWxkSGFuZGxlcih2YWx1ZSwgeWllbGRIYW5kbGVycywgdHJhY2VQYXJlbnQpIHtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHlpZWxkSGFuZGxlcnMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdHJhY2VQYXJlbnQuX3B1c2hDb250ZXh0KCk7XG4gICAgICAgIHZhciByZXN1bHQgPSB0cnlDYXRjaCh5aWVsZEhhbmRsZXJzW2ldKSh2YWx1ZSk7XG4gICAgICAgIHRyYWNlUGFyZW50Ll9wb3BDb250ZXh0KCk7XG4gICAgICAgIGlmIChyZXN1bHQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgICAgICB0cmFjZVBhcmVudC5fcHVzaENvbnRleHQoKTtcbiAgICAgICAgICAgIHZhciByZXQgPSBQcm9taXNlLnJlamVjdChlcnJvck9iai5lKTtcbiAgICAgICAgICAgIHRyYWNlUGFyZW50Ll9wb3BDb250ZXh0KCk7XG4gICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9XG4gICAgICAgIHZhciBtYXliZVByb21pc2UgPSB0cnlDb252ZXJ0VG9Qcm9taXNlKHJlc3VsdCwgdHJhY2VQYXJlbnQpO1xuICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIG1heWJlUHJvbWlzZTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIFByb21pc2VTcGF3bihnZW5lcmF0b3JGdW5jdGlvbiwgcmVjZWl2ZXIsIHlpZWxkSGFuZGxlciwgc3RhY2spIHtcbiAgICB2YXIgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgcHJvbWlzZS5fY2FwdHVyZVN0YWNrVHJhY2UoKTtcbiAgICB0aGlzLl9zdGFjayA9IHN0YWNrO1xuICAgIHRoaXMuX2dlbmVyYXRvckZ1bmN0aW9uID0gZ2VuZXJhdG9yRnVuY3Rpb247XG4gICAgdGhpcy5fcmVjZWl2ZXIgPSByZWNlaXZlcjtcbiAgICB0aGlzLl9nZW5lcmF0b3IgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5feWllbGRIYW5kbGVycyA9IHR5cGVvZiB5aWVsZEhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIlxuICAgICAgICA/IFt5aWVsZEhhbmRsZXJdLmNvbmNhdCh5aWVsZEhhbmRsZXJzKVxuICAgICAgICA6IHlpZWxkSGFuZGxlcnM7XG59XG5cblByb21pc2VTcGF3bi5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZTtcbn07XG5cblByb21pc2VTcGF3bi5wcm90b3R5cGUuX3J1biA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9nZW5lcmF0b3IgPSB0aGlzLl9nZW5lcmF0b3JGdW5jdGlvbi5jYWxsKHRoaXMuX3JlY2VpdmVyKTtcbiAgICB0aGlzLl9yZWNlaXZlciA9XG4gICAgICAgIHRoaXMuX2dlbmVyYXRvckZ1bmN0aW9uID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX25leHQodW5kZWZpbmVkKTtcbn07XG5cblByb21pc2VTcGF3bi5wcm90b3R5cGUuX2NvbnRpbnVlID0gZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgIGlmIChyZXN1bHQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9taXNlLl9yZWplY3RDYWxsYmFjayhyZXN1bHQuZSwgZmFsc2UsIHRydWUpO1xuICAgIH1cblxuICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZTtcbiAgICBpZiAocmVzdWx0LmRvbmUgPT09IHRydWUpIHtcbiAgICAgICAgdGhpcy5fcHJvbWlzZS5fcmVzb2x2ZUNhbGxiYWNrKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gdHJ5Q29udmVydFRvUHJvbWlzZSh2YWx1ZSwgdGhpcy5fcHJvbWlzZSk7XG4gICAgICAgIGlmICghKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSB7XG4gICAgICAgICAgICBtYXliZVByb21pc2UgPVxuICAgICAgICAgICAgICAgIHByb21pc2VGcm9tWWllbGRIYW5kbGVyKG1heWJlUHJvbWlzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl95aWVsZEhhbmRsZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb21pc2UpO1xuICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3Rocm93KFxuICAgICAgICAgICAgICAgICAgICBuZXcgVHlwZUVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJBIHZhbHVlICVzIHdhcyB5aWVsZGVkIHRoYXQgY291bGQgbm90IGJlIHRyZWF0ZWQgYXMgYSBwcm9taXNlXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvNFk0cERrXFx1MDAwYVxcdTAwMGFcIi5yZXBsYWNlKFwiJXNcIiwgdmFsdWUpICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiRnJvbSBjb3JvdXRpbmU6XFx1MDAwYVwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N0YWNrLnNwbGl0KFwiXFxuXCIpLnNsaWNlKDEsIC03KS5qb2luKFwiXFxuXCIpXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oXG4gICAgICAgICAgICB0aGlzLl9uZXh0LFxuICAgICAgICAgICAgdGhpcy5fdGhyb3csXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgbnVsbFxuICAgICAgICk7XG4gICAgfVxufTtcblxuUHJvbWlzZVNwYXduLnByb3RvdHlwZS5fdGhyb3cgPSBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgdGhpcy5fcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZShyZWFzb24pO1xuICAgIHRoaXMuX3Byb21pc2UuX3B1c2hDb250ZXh0KCk7XG4gICAgdmFyIHJlc3VsdCA9IHRyeUNhdGNoKHRoaXMuX2dlbmVyYXRvcltcInRocm93XCJdKVxuICAgICAgICAuY2FsbCh0aGlzLl9nZW5lcmF0b3IsIHJlYXNvbik7XG4gICAgdGhpcy5fcHJvbWlzZS5fcG9wQ29udGV4dCgpO1xuICAgIHRoaXMuX2NvbnRpbnVlKHJlc3VsdCk7XG59O1xuXG5Qcm9taXNlU3Bhd24ucHJvdG90eXBlLl9uZXh0ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgdGhpcy5fcHJvbWlzZS5fcHVzaENvbnRleHQoKTtcbiAgICB2YXIgcmVzdWx0ID0gdHJ5Q2F0Y2godGhpcy5fZ2VuZXJhdG9yLm5leHQpLmNhbGwodGhpcy5fZ2VuZXJhdG9yLCB2YWx1ZSk7XG4gICAgdGhpcy5fcHJvbWlzZS5fcG9wQ29udGV4dCgpO1xuICAgIHRoaXMuX2NvbnRpbnVlKHJlc3VsdCk7XG59O1xuXG5Qcm9taXNlLmNvcm91dGluZSA9IGZ1bmN0aW9uIChnZW5lcmF0b3JGdW5jdGlvbiwgb3B0aW9ucykge1xuICAgIGlmICh0eXBlb2YgZ2VuZXJhdG9yRnVuY3Rpb24gIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiZ2VuZXJhdG9yRnVuY3Rpb24gbXVzdCBiZSBhIGZ1bmN0aW9uXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvNlZxaG0wXFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdmFyIHlpZWxkSGFuZGxlciA9IE9iamVjdChvcHRpb25zKS55aWVsZEhhbmRsZXI7XG4gICAgdmFyIFByb21pc2VTcGF3biQgPSBQcm9taXNlU3Bhd247XG4gICAgdmFyIHN0YWNrID0gbmV3IEVycm9yKCkuc3RhY2s7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGdlbmVyYXRvciA9IGdlbmVyYXRvckZ1bmN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgIHZhciBzcGF3biA9IG5ldyBQcm9taXNlU3Bhd24kKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB5aWVsZEhhbmRsZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrKTtcbiAgICAgICAgc3Bhd24uX2dlbmVyYXRvciA9IGdlbmVyYXRvcjtcbiAgICAgICAgc3Bhd24uX25leHQodW5kZWZpbmVkKTtcbiAgICAgICAgcmV0dXJuIHNwYXduLnByb21pc2UoKTtcbiAgICB9O1xufTtcblxuUHJvbWlzZS5jb3JvdXRpbmUuYWRkWWllbGRIYW5kbGVyID0gZnVuY3Rpb24oZm4pIHtcbiAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJmbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85MTZsSkpcXHUwMDBhXCIpO1xuICAgIHlpZWxkSGFuZGxlcnMucHVzaChmbik7XG59O1xuXG5Qcm9taXNlLnNwYXduID0gZnVuY3Rpb24gKGdlbmVyYXRvckZ1bmN0aW9uKSB7XG4gICAgaWYgKHR5cGVvZiBnZW5lcmF0b3JGdW5jdGlvbiAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oXCJnZW5lcmF0b3JGdW5jdGlvbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC82VnFobTBcXHUwMDBhXCIpO1xuICAgIH1cbiAgICB2YXIgc3Bhd24gPSBuZXcgUHJvbWlzZVNwYXduKGdlbmVyYXRvckZ1bmN0aW9uLCB0aGlzKTtcbiAgICB2YXIgcmV0ID0gc3Bhd24ucHJvbWlzZSgpO1xuICAgIHNwYXduLl9ydW4oUHJvbWlzZS5zcGF3bik7XG4gICAgcmV0dXJuIHJldDtcbn07XG59O1xuXG59LHtcIi4vZXJyb3JzLmpzXCI6MTMsXCIuL3V0aWwuanNcIjozOH1dLDE4OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPVxuZnVuY3Rpb24oUHJvbWlzZSwgUHJvbWlzZUFycmF5LCB0cnlDb252ZXJ0VG9Qcm9taXNlLCBJTlRFUk5BTCkge1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIGNhbkV2YWx1YXRlID0gdXRpbC5jYW5FdmFsdWF0ZTtcbnZhciB0cnlDYXRjaCA9IHV0aWwudHJ5Q2F0Y2g7XG52YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqO1xudmFyIHJlamVjdDtcblxuaWYgKCF0cnVlKSB7XG5pZiAoY2FuRXZhbHVhdGUpIHtcbiAgICB2YXIgdGhlbkNhbGxiYWNrID0gZnVuY3Rpb24oaSkge1xuICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKFwidmFsdWVcIiwgXCJob2xkZXJcIiwgXCIgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBob2xkZXIucEluZGV4ID0gdmFsdWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBob2xkZXIuY2hlY2tGdWxmaWxsbWVudCh0aGlzKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBcIi5yZXBsYWNlKC9JbmRleC9nLCBpKSk7XG4gICAgfTtcblxuICAgIHZhciBjYWxsZXIgPSBmdW5jdGlvbihjb3VudCkge1xuICAgICAgICB2YXIgdmFsdWVzID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IGNvdW50OyArK2kpIHZhbHVlcy5wdXNoKFwiaG9sZGVyLnBcIiArIGkpO1xuICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKFwiaG9sZGVyXCIsIFwiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgJ3VzZSBzdHJpY3QnOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gaG9sZGVyLmZuOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZhbHVlcyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcXG5cXFxuICAgICAgICAgICAgXCIucmVwbGFjZSgvdmFsdWVzL2csIHZhbHVlcy5qb2luKFwiLCBcIikpKTtcbiAgICB9O1xuICAgIHZhciB0aGVuQ2FsbGJhY2tzID0gW107XG4gICAgdmFyIGNhbGxlcnMgPSBbdW5kZWZpbmVkXTtcbiAgICBmb3IgKHZhciBpID0gMTsgaSA8PSA1OyArK2kpIHtcbiAgICAgICAgdGhlbkNhbGxiYWNrcy5wdXNoKHRoZW5DYWxsYmFjayhpKSk7XG4gICAgICAgIGNhbGxlcnMucHVzaChjYWxsZXIoaSkpO1xuICAgIH1cblxuICAgIHZhciBIb2xkZXIgPSBmdW5jdGlvbih0b3RhbCwgZm4pIHtcbiAgICAgICAgdGhpcy5wMSA9IHRoaXMucDIgPSB0aGlzLnAzID0gdGhpcy5wNCA9IHRoaXMucDUgPSBudWxsO1xuICAgICAgICB0aGlzLmZuID0gZm47XG4gICAgICAgIHRoaXMudG90YWwgPSB0b3RhbDtcbiAgICAgICAgdGhpcy5ub3cgPSAwO1xuICAgIH07XG5cbiAgICBIb2xkZXIucHJvdG90eXBlLmNhbGxlcnMgPSBjYWxsZXJzO1xuICAgIEhvbGRlci5wcm90b3R5cGUuY2hlY2tGdWxmaWxsbWVudCA9IGZ1bmN0aW9uKHByb21pc2UpIHtcbiAgICAgICAgdmFyIG5vdyA9IHRoaXMubm93O1xuICAgICAgICBub3crKztcbiAgICAgICAgdmFyIHRvdGFsID0gdGhpcy50b3RhbDtcbiAgICAgICAgaWYgKG5vdyA+PSB0b3RhbCkge1xuICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB0aGlzLmNhbGxlcnNbdG90YWxdO1xuICAgICAgICAgICAgcHJvbWlzZS5fcHVzaENvbnRleHQoKTtcbiAgICAgICAgICAgIHZhciByZXQgPSB0cnlDYXRjaChoYW5kbGVyKSh0aGlzKTtcbiAgICAgICAgICAgIHByb21pc2UuX3BvcENvbnRleHQoKTtcbiAgICAgICAgICAgIGlmIChyZXQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2socmV0LmUsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5fcmVzb2x2ZUNhbGxiYWNrKHJldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm5vdyA9IG5vdztcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgICAgICB0aGlzLl9yZWplY3QocmVhc29uKTtcbiAgICB9O1xufVxufVxuXG5Qcm9taXNlLmpvaW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGxhc3QgPSBhcmd1bWVudHMubGVuZ3RoIC0gMTtcbiAgICB2YXIgZm47XG4gICAgaWYgKGxhc3QgPiAwICYmIHR5cGVvZiBhcmd1bWVudHNbbGFzdF0gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBmbiA9IGFyZ3VtZW50c1tsYXN0XTtcbiAgICAgICAgaWYgKCF0cnVlKSB7XG4gICAgICAgICAgICBpZiAobGFzdCA8IDYgJiYgY2FuRXZhbHVhdGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpO1xuICAgICAgICAgICAgICAgIHJldC5fY2FwdHVyZVN0YWNrVHJhY2UoKTtcbiAgICAgICAgICAgICAgICB2YXIgaG9sZGVyID0gbmV3IEhvbGRlcihsYXN0LCBmbik7XG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoZW5DYWxsYmFja3M7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsYXN0OyArK2kpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UoYXJndW1lbnRzW2ldLCByZXQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlID0gbWF5YmVQcm9taXNlLl90YXJnZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UuX2lzUGVuZGluZygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlLl90aGVuKGNhbGxiYWNrc1tpXSwgcmVqZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsIHJldCwgaG9sZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWF5YmVQcm9taXNlLl9pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2ldLmNhbGwocmV0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fdmFsdWUoKSwgaG9sZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0Ll9yZWplY3QobWF5YmVQcm9taXNlLl9yZWFzb24oKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3NbaV0uY2FsbChyZXQsIG1heWJlUHJvbWlzZSwgaG9sZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHZhciAkX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGg7dmFyIGFyZ3MgPSBuZXcgQXJyYXkoJF9sZW4pOyBmb3IodmFyICRfaSA9IDA7ICRfaSA8ICRfbGVuOyArKyRfaSkge2FyZ3NbJF9pXSA9IGFyZ3VtZW50c1skX2ldO31cbiAgICBpZiAoZm4pIGFyZ3MucG9wKCk7XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlQXJyYXkoYXJncykucHJvbWlzZSgpO1xuICAgIHJldHVybiBmbiAhPT0gdW5kZWZpbmVkID8gcmV0LnNwcmVhZChmbikgOiByZXQ7XG59O1xuXG59O1xuXG59LHtcIi4vdXRpbC5qc1wiOjM4fV0sMTk6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIFByb21pc2VBcnJheSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpUmVqZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICB0cnlDb252ZXJ0VG9Qcm9taXNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBJTlRFUk5BTCkge1xudmFyIGdldERvbWFpbiA9IFByb21pc2UuX2dldERvbWFpbjtcbnZhciBhc3luYyA9IF9kZXJlcV8oXCIuL2FzeW5jLmpzXCIpO1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIHRyeUNhdGNoID0gdXRpbC50cnlDYXRjaDtcbnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7XG52YXIgUEVORElORyA9IHt9O1xudmFyIEVNUFRZX0FSUkFZID0gW107XG5cbmZ1bmN0aW9uIE1hcHBpbmdQcm9taXNlQXJyYXkocHJvbWlzZXMsIGZuLCBsaW1pdCwgX2ZpbHRlcikge1xuICAgIHRoaXMuY29uc3RydWN0b3IkKHByb21pc2VzKTtcbiAgICB0aGlzLl9wcm9taXNlLl9jYXB0dXJlU3RhY2tUcmFjZSgpO1xuICAgIHZhciBkb21haW4gPSBnZXREb21haW4oKTtcbiAgICB0aGlzLl9jYWxsYmFjayA9IGRvbWFpbiA9PT0gbnVsbCA/IGZuIDogZG9tYWluLmJpbmQoZm4pO1xuICAgIHRoaXMuX3ByZXNlcnZlZFZhbHVlcyA9IF9maWx0ZXIgPT09IElOVEVSTkFMXG4gICAgICAgID8gbmV3IEFycmF5KHRoaXMubGVuZ3RoKCkpXG4gICAgICAgIDogbnVsbDtcbiAgICB0aGlzLl9saW1pdCA9IGxpbWl0O1xuICAgIHRoaXMuX2luRmxpZ2h0ID0gMDtcbiAgICB0aGlzLl9xdWV1ZSA9IGxpbWl0ID49IDEgPyBbXSA6IEVNUFRZX0FSUkFZO1xuICAgIGFzeW5jLmludm9rZShpbml0LCB0aGlzLCB1bmRlZmluZWQpO1xufVxudXRpbC5pbmhlcml0cyhNYXBwaW5nUHJvbWlzZUFycmF5LCBQcm9taXNlQXJyYXkpO1xuZnVuY3Rpb24gaW5pdCgpIHt0aGlzLl9pbml0JCh1bmRlZmluZWQsIC0yKTt9XG5cbk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gKCkge307XG5cbk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkge1xuICAgIHZhciB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7XG4gICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoKCk7XG4gICAgdmFyIHByZXNlcnZlZFZhbHVlcyA9IHRoaXMuX3ByZXNlcnZlZFZhbHVlcztcbiAgICB2YXIgbGltaXQgPSB0aGlzLl9saW1pdDtcbiAgICBpZiAodmFsdWVzW2luZGV4XSA9PT0gUEVORElORykge1xuICAgICAgICB2YWx1ZXNbaW5kZXhdID0gdmFsdWU7XG4gICAgICAgIGlmIChsaW1pdCA+PSAxKSB7XG4gICAgICAgICAgICB0aGlzLl9pbkZsaWdodC0tO1xuICAgICAgICAgICAgdGhpcy5fZHJhaW5RdWV1ZSgpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGxpbWl0ID49IDEgJiYgdGhpcy5faW5GbGlnaHQgPj0gbGltaXQpIHtcbiAgICAgICAgICAgIHZhbHVlc1tpbmRleF0gPSB2YWx1ZTtcbiAgICAgICAgICAgIHRoaXMuX3F1ZXVlLnB1c2goaW5kZXgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwcmVzZXJ2ZWRWYWx1ZXMgIT09IG51bGwpIHByZXNlcnZlZFZhbHVlc1tpbmRleF0gPSB2YWx1ZTtcblxuICAgICAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLl9jYWxsYmFjaztcbiAgICAgICAgdmFyIHJlY2VpdmVyID0gdGhpcy5fcHJvbWlzZS5fYm91bmRWYWx1ZSgpO1xuICAgICAgICB0aGlzLl9wcm9taXNlLl9wdXNoQ29udGV4dCgpO1xuICAgICAgICB2YXIgcmV0ID0gdHJ5Q2F0Y2goY2FsbGJhY2spLmNhbGwocmVjZWl2ZXIsIHZhbHVlLCBpbmRleCwgbGVuZ3RoKTtcbiAgICAgICAgdGhpcy5fcHJvbWlzZS5fcG9wQ29udGV4dCgpO1xuICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgcmV0dXJuIHRoaXMuX3JlamVjdChyZXQuZSk7XG5cbiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UocmV0LCB0aGlzLl9wcm9taXNlKTtcbiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICAgIG1heWJlUHJvbWlzZSA9IG1heWJlUHJvbWlzZS5fdGFyZ2V0KCk7XG4gICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlLl9pc1BlbmRpbmcoKSkge1xuICAgICAgICAgICAgICAgIGlmIChsaW1pdCA+PSAxKSB0aGlzLl9pbkZsaWdodCsrO1xuICAgICAgICAgICAgICAgIHZhbHVlc1tpbmRleF0gPSBQRU5ESU5HO1xuICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGluZGV4KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWF5YmVQcm9taXNlLl9pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gbWF5YmVQcm9taXNlLl92YWx1ZSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVqZWN0KG1heWJlUHJvbWlzZS5fcmVhc29uKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhbHVlc1tpbmRleF0gPSByZXQ7XG4gICAgfVxuICAgIHZhciB0b3RhbFJlc29sdmVkID0gKyt0aGlzLl90b3RhbFJlc29sdmVkO1xuICAgIGlmICh0b3RhbFJlc29sdmVkID49IGxlbmd0aCkge1xuICAgICAgICBpZiAocHJlc2VydmVkVmFsdWVzICE9PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLl9maWx0ZXIodmFsdWVzLCBwcmVzZXJ2ZWRWYWx1ZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh2YWx1ZXMpO1xuICAgICAgICB9XG5cbiAgICB9XG59O1xuXG5NYXBwaW5nUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fZHJhaW5RdWV1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTtcbiAgICB2YXIgbGltaXQgPSB0aGlzLl9saW1pdDtcbiAgICB2YXIgdmFsdWVzID0gdGhpcy5fdmFsdWVzO1xuICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwICYmIHRoaXMuX2luRmxpZ2h0IDwgbGltaXQpIHtcbiAgICAgICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuO1xuICAgICAgICB2YXIgaW5kZXggPSBxdWV1ZS5wb3AoKTtcbiAgICAgICAgdGhpcy5fcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZXNbaW5kZXhdLCBpbmRleCk7XG4gICAgfVxufTtcblxuTWFwcGluZ1Byb21pc2VBcnJheS5wcm90b3R5cGUuX2ZpbHRlciA9IGZ1bmN0aW9uIChib29sZWFucywgdmFsdWVzKSB7XG4gICAgdmFyIGxlbiA9IHZhbHVlcy5sZW5ndGg7XG4gICAgdmFyIHJldCA9IG5ldyBBcnJheShsZW4pO1xuICAgIHZhciBqID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgIGlmIChib29sZWFuc1tpXSkgcmV0W2orK10gPSB2YWx1ZXNbaV07XG4gICAgfVxuICAgIHJldC5sZW5ndGggPSBqO1xuICAgIHRoaXMuX3Jlc29sdmUocmV0KTtcbn07XG5cbk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLnByZXNlcnZlZFZhbHVlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJlc2VydmVkVmFsdWVzO1xufTtcblxuZnVuY3Rpb24gbWFwKHByb21pc2VzLCBmbiwgb3B0aW9ucywgX2ZpbHRlcikge1xuICAgIHZhciBsaW1pdCA9IHR5cGVvZiBvcHRpb25zID09PSBcIm9iamVjdFwiICYmIG9wdGlvbnMgIT09IG51bGxcbiAgICAgICAgPyBvcHRpb25zLmNvbmN1cnJlbmN5XG4gICAgICAgIDogMDtcbiAgICBsaW1pdCA9IHR5cGVvZiBsaW1pdCA9PT0gXCJudW1iZXJcIiAmJlxuICAgICAgICBpc0Zpbml0ZShsaW1pdCkgJiYgbGltaXQgPj0gMSA/IGxpbWl0IDogMDtcbiAgICByZXR1cm4gbmV3IE1hcHBpbmdQcm9taXNlQXJyYXkocHJvbWlzZXMsIGZuLCBsaW1pdCwgX2ZpbHRlcik7XG59XG5cblByb21pc2UucHJvdG90eXBlLm1hcCA9IGZ1bmN0aW9uIChmbiwgb3B0aW9ucykge1xuICAgIGlmICh0eXBlb2YgZm4gIT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIGFwaVJlamVjdGlvbihcImZuIG11c3QgYmUgYSBmdW5jdGlvblxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsLzkxNmxKSlxcdTAwMGFcIik7XG5cbiAgICByZXR1cm4gbWFwKHRoaXMsIGZuLCBvcHRpb25zLCBudWxsKS5wcm9taXNlKCk7XG59O1xuXG5Qcm9taXNlLm1hcCA9IGZ1bmN0aW9uIChwcm9taXNlcywgZm4sIG9wdGlvbnMsIF9maWx0ZXIpIHtcbiAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBhcGlSZWplY3Rpb24oXCJmbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85MTZsSkpcXHUwMDBhXCIpO1xuICAgIHJldHVybiBtYXAocHJvbWlzZXMsIGZuLCBvcHRpb25zLCBfZmlsdGVyKS5wcm9taXNlKCk7XG59O1xuXG5cbn07XG5cbn0se1wiLi9hc3luYy5qc1wiOjIsXCIuL3V0aWwuanNcIjozOH1dLDIwOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPVxuZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwsIHRyeUNvbnZlcnRUb1Byb21pc2UsIGFwaVJlamVjdGlvbikge1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIHRyeUNhdGNoID0gdXRpbC50cnlDYXRjaDtcblxuUHJvbWlzZS5tZXRob2QgPSBmdW5jdGlvbiAoZm4pIHtcbiAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFByb21pc2UuVHlwZUVycm9yKFwiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvOTE2bEpKXFx1MDAwYVwiKTtcbiAgICB9XG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICAgICAgcmV0Ll9jYXB0dXJlU3RhY2tUcmFjZSgpO1xuICAgICAgICByZXQuX3B1c2hDb250ZXh0KCk7XG4gICAgICAgIHZhciB2YWx1ZSA9IHRyeUNhdGNoKGZuKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICByZXQuX3BvcENvbnRleHQoKTtcbiAgICAgICAgcmV0Ll9yZXNvbHZlRnJvbVN5bmNWYWx1ZSh2YWx1ZSk7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbn07XG5cblByb21pc2UuYXR0ZW1wdCA9IFByb21pc2VbXCJ0cnlcIl0gPSBmdW5jdGlvbiAoZm4sIGFyZ3MsIGN0eCkge1xuICAgIGlmICh0eXBlb2YgZm4gIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICByZXR1cm4gYXBpUmVqZWN0aW9uKFwiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvOTE2bEpKXFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICByZXQuX2NhcHR1cmVTdGFja1RyYWNlKCk7XG4gICAgcmV0Ll9wdXNoQ29udGV4dCgpO1xuICAgIHZhciB2YWx1ZSA9IHV0aWwuaXNBcnJheShhcmdzKVxuICAgICAgICA/IHRyeUNhdGNoKGZuKS5hcHBseShjdHgsIGFyZ3MpXG4gICAgICAgIDogdHJ5Q2F0Y2goZm4pLmNhbGwoY3R4LCBhcmdzKTtcbiAgICByZXQuX3BvcENvbnRleHQoKTtcbiAgICByZXQuX3Jlc29sdmVGcm9tU3luY1ZhbHVlKHZhbHVlKTtcbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3Jlc29sdmVGcm9tU3luY1ZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID09PSB1dGlsLmVycm9yT2JqKSB7XG4gICAgICAgIHRoaXMuX3JlamVjdENhbGxiYWNrKHZhbHVlLmUsIGZhbHNlLCB0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9yZXNvbHZlQ2FsbGJhY2sodmFsdWUsIHRydWUpO1xuICAgIH1cbn07XG59O1xuXG59LHtcIi4vdXRpbC5qc1wiOjM4fV0sMjE6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBhc3luYyA9IF9kZXJlcV8oXCIuL2FzeW5jLmpzXCIpO1xudmFyIHRyeUNhdGNoID0gdXRpbC50cnlDYXRjaDtcbnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7XG5cbmZ1bmN0aW9uIHNwcmVhZEFkYXB0ZXIodmFsLCBub2RlYmFjaykge1xuICAgIHZhciBwcm9taXNlID0gdGhpcztcbiAgICBpZiAoIXV0aWwuaXNBcnJheSh2YWwpKSByZXR1cm4gc3VjY2Vzc0FkYXB0ZXIuY2FsbChwcm9taXNlLCB2YWwsIG5vZGViYWNrKTtcbiAgICB2YXIgcmV0ID1cbiAgICAgICAgdHJ5Q2F0Y2gobm9kZWJhY2spLmFwcGx5KHByb21pc2UuX2JvdW5kVmFsdWUoKSwgW251bGxdLmNvbmNhdCh2YWwpKTtcbiAgICBpZiAocmV0ID09PSBlcnJvck9iaikge1xuICAgICAgICBhc3luYy50aHJvd0xhdGVyKHJldC5lKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHN1Y2Nlc3NBZGFwdGVyKHZhbCwgbm9kZWJhY2spIHtcbiAgICB2YXIgcHJvbWlzZSA9IHRoaXM7XG4gICAgdmFyIHJlY2VpdmVyID0gcHJvbWlzZS5fYm91bmRWYWx1ZSgpO1xuICAgIHZhciByZXQgPSB2YWwgPT09IHVuZGVmaW5lZFxuICAgICAgICA/IHRyeUNhdGNoKG5vZGViYWNrKS5jYWxsKHJlY2VpdmVyLCBudWxsKVxuICAgICAgICA6IHRyeUNhdGNoKG5vZGViYWNrKS5jYWxsKHJlY2VpdmVyLCBudWxsLCB2YWwpO1xuICAgIGlmIChyZXQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgIGFzeW5jLnRocm93TGF0ZXIocmV0LmUpO1xuICAgIH1cbn1cbmZ1bmN0aW9uIGVycm9yQWRhcHRlcihyZWFzb24sIG5vZGViYWNrKSB7XG4gICAgdmFyIHByb21pc2UgPSB0aGlzO1xuICAgIGlmICghcmVhc29uKSB7XG4gICAgICAgIHZhciB0YXJnZXQgPSBwcm9taXNlLl90YXJnZXQoKTtcbiAgICAgICAgdmFyIG5ld1JlYXNvbiA9IHRhcmdldC5fZ2V0Q2FycmllZFN0YWNrVHJhY2UoKTtcbiAgICAgICAgbmV3UmVhc29uLmNhdXNlID0gcmVhc29uO1xuICAgICAgICByZWFzb24gPSBuZXdSZWFzb247XG4gICAgfVxuICAgIHZhciByZXQgPSB0cnlDYXRjaChub2RlYmFjaykuY2FsbChwcm9taXNlLl9ib3VuZFZhbHVlKCksIHJlYXNvbik7XG4gICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHtcbiAgICAgICAgYXN5bmMudGhyb3dMYXRlcihyZXQuZSk7XG4gICAgfVxufVxuXG5Qcm9taXNlLnByb3RvdHlwZS5hc0NhbGxiYWNrID1cblByb21pc2UucHJvdG90eXBlLm5vZGVpZnkgPSBmdW5jdGlvbiAobm9kZWJhY2ssIG9wdGlvbnMpIHtcbiAgICBpZiAodHlwZW9mIG5vZGViYWNrID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICB2YXIgYWRhcHRlciA9IHN1Y2Nlc3NBZGFwdGVyO1xuICAgICAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIE9iamVjdChvcHRpb25zKS5zcHJlYWQpIHtcbiAgICAgICAgICAgIGFkYXB0ZXIgPSBzcHJlYWRBZGFwdGVyO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3RoZW4oXG4gICAgICAgICAgICBhZGFwdGVyLFxuICAgICAgICAgICAgZXJyb3JBZGFwdGVyLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIG5vZGViYWNrXG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xufTtcbn07XG5cbn0se1wiLi9hc3luYy5qc1wiOjIsXCIuL3V0aWwuanNcIjozOH1dLDIyOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXkpIHtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBhc3luYyA9IF9kZXJlcV8oXCIuL2FzeW5jLmpzXCIpO1xudmFyIHRyeUNhdGNoID0gdXRpbC50cnlDYXRjaDtcbnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7XG5cblByb21pc2UucHJvdG90eXBlLnByb2dyZXNzZWQgPSBmdW5jdGlvbiAoaGFuZGxlcikge1xuICAgIHJldHVybiB0aGlzLl90aGVuKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBoYW5kbGVyLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fcHJvZ3Jlc3MgPSBmdW5jdGlvbiAocHJvZ3Jlc3NWYWx1ZSkge1xuICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpKSByZXR1cm47XG4gICAgdGhpcy5fdGFyZ2V0KCkuX3Byb2dyZXNzVW5jaGVja2VkKHByb2dyZXNzVmFsdWUpO1xuXG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fcHJvZ3Jlc3NIYW5kbGVyQXQgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICByZXR1cm4gaW5kZXggPT09IDBcbiAgICAgICAgPyB0aGlzLl9wcm9ncmVzc0hhbmRsZXIwXG4gICAgICAgIDogdGhpc1soaW5kZXggPDwgMikgKyBpbmRleCAtIDUgKyAyXTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9kb1Byb2dyZXNzV2l0aCA9IGZ1bmN0aW9uIChwcm9ncmVzc2lvbikge1xuICAgIHZhciBwcm9ncmVzc1ZhbHVlID0gcHJvZ3Jlc3Npb24udmFsdWU7XG4gICAgdmFyIGhhbmRsZXIgPSBwcm9ncmVzc2lvbi5oYW5kbGVyO1xuICAgIHZhciBwcm9taXNlID0gcHJvZ3Jlc3Npb24ucHJvbWlzZTtcbiAgICB2YXIgcmVjZWl2ZXIgPSBwcm9ncmVzc2lvbi5yZWNlaXZlcjtcblxuICAgIHZhciByZXQgPSB0cnlDYXRjaChoYW5kbGVyKS5jYWxsKHJlY2VpdmVyLCBwcm9ncmVzc1ZhbHVlKTtcbiAgICBpZiAocmV0ID09PSBlcnJvck9iaikge1xuICAgICAgICBpZiAocmV0LmUgIT0gbnVsbCAmJlxuICAgICAgICAgICAgcmV0LmUubmFtZSAhPT0gXCJTdG9wUHJvZ3Jlc3NQcm9wYWdhdGlvblwiKSB7XG4gICAgICAgICAgICB2YXIgdHJhY2UgPSB1dGlsLmNhbkF0dGFjaFRyYWNlKHJldC5lKVxuICAgICAgICAgICAgICAgID8gcmV0LmUgOiBuZXcgRXJyb3IodXRpbC50b1N0cmluZyhyZXQuZSkpO1xuICAgICAgICAgICAgcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7XG4gICAgICAgICAgICBwcm9taXNlLl9wcm9ncmVzcyhyZXQuZSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHJldCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgcmV0Ll90aGVuKHByb21pc2UuX3Byb2dyZXNzLCBudWxsLCBudWxsLCBwcm9taXNlLCB1bmRlZmluZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHByb21pc2UuX3Byb2dyZXNzKHJldCk7XG4gICAgfVxufTtcblxuXG5Qcm9taXNlLnByb3RvdHlwZS5fcHJvZ3Jlc3NVbmNoZWNrZWQgPSBmdW5jdGlvbiAocHJvZ3Jlc3NWYWx1ZSkge1xuICAgIHZhciBsZW4gPSB0aGlzLl9sZW5ndGgoKTtcbiAgICB2YXIgcHJvZ3Jlc3MgPSB0aGlzLl9wcm9ncmVzcztcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyQXQoaSk7XG4gICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5fcHJvbWlzZUF0KGkpO1xuICAgICAgICBpZiAoIShwcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkpIHtcbiAgICAgICAgICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3JlY2VpdmVyQXQoaSk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbChyZWNlaXZlciwgcHJvZ3Jlc3NWYWx1ZSwgcHJvbWlzZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlY2VpdmVyIGluc3RhbmNlb2YgUHJvbWlzZUFycmF5ICYmXG4gICAgICAgICAgICAgICAgICAgICAgICFyZWNlaXZlci5faXNSZXNvbHZlZCgpKSB7XG4gICAgICAgICAgICAgICAgcmVjZWl2ZXIuX3Byb21pc2VQcm9ncmVzc2VkKHByb2dyZXNzVmFsdWUsIHByb21pc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgYXN5bmMuaW52b2tlKHRoaXMuX2RvUHJvZ3Jlc3NXaXRoLCB0aGlzLCB7XG4gICAgICAgICAgICAgICAgaGFuZGxlcjogaGFuZGxlcixcbiAgICAgICAgICAgICAgICBwcm9taXNlOiBwcm9taXNlLFxuICAgICAgICAgICAgICAgIHJlY2VpdmVyOiB0aGlzLl9yZWNlaXZlckF0KGkpLFxuICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9ncmVzc1ZhbHVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzeW5jLmludm9rZShwcm9ncmVzcywgcHJvbWlzZSwgcHJvZ3Jlc3NWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xufTtcblxufSx7XCIuL2FzeW5jLmpzXCI6MixcIi4vdXRpbC5qc1wiOjM4fV0sMjM6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkge1xudmFyIG1ha2VTZWxmUmVzb2x1dGlvbkVycm9yID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBuZXcgVHlwZUVycm9yKFwiY2lyY3VsYXIgcHJvbWlzZSByZXNvbHV0aW9uIGNoYWluXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvTGhGcG8wXFx1MDAwYVwiKTtcbn07XG52YXIgcmVmbGVjdCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZS5Qcm9taXNlSW5zcGVjdGlvbih0aGlzLl90YXJnZXQoKSk7XG59O1xudmFyIGFwaVJlamVjdGlvbiA9IGZ1bmN0aW9uKG1zZykge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgVHlwZUVycm9yKG1zZykpO1xufTtcblxudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xuXG52YXIgZ2V0RG9tYWluO1xuaWYgKHV0aWwuaXNOb2RlKSB7XG4gICAgZ2V0RG9tYWluID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciByZXQgPSBwcm9jZXNzLmRvbWFpbjtcbiAgICAgICAgaWYgKHJldCA9PT0gdW5kZWZpbmVkKSByZXQgPSBudWxsO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG59IGVsc2Uge1xuICAgIGdldERvbWFpbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9O1xufVxudXRpbC5ub3RFbnVtZXJhYmxlUHJvcChQcm9taXNlLCBcIl9nZXREb21haW5cIiwgZ2V0RG9tYWluKTtcblxudmFyIGFzeW5jID0gX2RlcmVxXyhcIi4vYXN5bmMuanNcIik7XG52YXIgZXJyb3JzID0gX2RlcmVxXyhcIi4vZXJyb3JzLmpzXCIpO1xudmFyIFR5cGVFcnJvciA9IFByb21pc2UuVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjtcblByb21pc2UuUmFuZ2VFcnJvciA9IGVycm9ycy5SYW5nZUVycm9yO1xuUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciA9IGVycm9ycy5DYW5jZWxsYXRpb25FcnJvcjtcblByb21pc2UuVGltZW91dEVycm9yID0gZXJyb3JzLlRpbWVvdXRFcnJvcjtcblByb21pc2UuT3BlcmF0aW9uYWxFcnJvciA9IGVycm9ycy5PcGVyYXRpb25hbEVycm9yO1xuUHJvbWlzZS5SZWplY3Rpb25FcnJvciA9IGVycm9ycy5PcGVyYXRpb25hbEVycm9yO1xuUHJvbWlzZS5BZ2dyZWdhdGVFcnJvciA9IGVycm9ycy5BZ2dyZWdhdGVFcnJvcjtcbnZhciBJTlRFUk5BTCA9IGZ1bmN0aW9uKCl7fTtcbnZhciBBUFBMWSA9IHt9O1xudmFyIE5FWFRfRklMVEVSID0ge2U6IG51bGx9O1xudmFyIHRyeUNvbnZlcnRUb1Byb21pc2UgPSBfZGVyZXFfKFwiLi90aGVuYWJsZXMuanNcIikoUHJvbWlzZSwgSU5URVJOQUwpO1xudmFyIFByb21pc2VBcnJheSA9XG4gICAgX2RlcmVxXyhcIi4vcHJvbWlzZV9hcnJheS5qc1wiKShQcm9taXNlLCBJTlRFUk5BTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeUNvbnZlcnRUb1Byb21pc2UsIGFwaVJlamVjdGlvbik7XG52YXIgQ2FwdHVyZWRUcmFjZSA9IF9kZXJlcV8oXCIuL2NhcHR1cmVkX3RyYWNlLmpzXCIpKCk7XG52YXIgaXNEZWJ1Z2dpbmcgPSBfZGVyZXFfKFwiLi9kZWJ1Z2dhYmlsaXR5LmpzXCIpKFByb21pc2UsIENhcHR1cmVkVHJhY2UpO1xuIC8qanNoaW50IHVudXNlZDpmYWxzZSovXG52YXIgY3JlYXRlQ29udGV4dCA9XG4gICAgX2RlcmVxXyhcIi4vY29udGV4dC5qc1wiKShQcm9taXNlLCBDYXB0dXJlZFRyYWNlLCBpc0RlYnVnZ2luZyk7XG52YXIgQ2F0Y2hGaWx0ZXIgPSBfZGVyZXFfKFwiLi9jYXRjaF9maWx0ZXIuanNcIikoTkVYVF9GSUxURVIpO1xudmFyIFByb21pc2VSZXNvbHZlciA9IF9kZXJlcV8oXCIuL3Byb21pc2VfcmVzb2x2ZXIuanNcIik7XG52YXIgbm9kZWJhY2tGb3JQcm9taXNlID0gUHJvbWlzZVJlc29sdmVyLl9ub2RlYmFja0ZvclByb21pc2U7XG52YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqO1xudmFyIHRyeUNhdGNoID0gdXRpbC50cnlDYXRjaDtcbmZ1bmN0aW9uIFByb21pc2UocmVzb2x2ZXIpIHtcbiAgICBpZiAodHlwZW9mIHJlc29sdmVyICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIHJlcXVpcmVzIGEgcmVzb2x2ZXIgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9FQzIyWW5cXHUwMDBhXCIpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb25zdHJ1Y3RvciAhPT0gUHJvbWlzZSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwidGhlIHByb21pc2UgY29uc3RydWN0b3IgY2Fubm90IGJlIGludm9rZWQgZGlyZWN0bHlcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9Lc0lsZ2VcXHUwMDBhXCIpO1xuICAgIH1cbiAgICB0aGlzLl9iaXRGaWVsZCA9IDA7XG4gICAgdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl9wcm9ncmVzc0hhbmRsZXIwID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX3Byb21pc2UwID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX3JlY2VpdmVyMCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHJlc29sdmVyICE9PSBJTlRFUk5BTCkgdGhpcy5fcmVzb2x2ZUZyb21SZXNvbHZlcihyZXNvbHZlcik7XG59XG5cblByb21pc2UucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBcIltvYmplY3QgUHJvbWlzZV1cIjtcbn07XG5cblByb21pc2UucHJvdG90eXBlLmNhdWdodCA9IFByb21pc2UucHJvdG90eXBlW1wiY2F0Y2hcIl0gPSBmdW5jdGlvbiAoZm4pIHtcbiAgICB2YXIgbGVuID0gYXJndW1lbnRzLmxlbmd0aDtcbiAgICBpZiAobGVuID4gMSkge1xuICAgICAgICB2YXIgY2F0Y2hJbnN0YW5jZXMgPSBuZXcgQXJyYXkobGVuIC0gMSksXG4gICAgICAgICAgICBqID0gMCwgaTtcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbiAtIDE7ICsraSkge1xuICAgICAgICAgICAgdmFyIGl0ZW0gPSBhcmd1bWVudHNbaV07XG4gICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIGNhdGNoSW5zdGFuY2VzW2orK10gPSBpdGVtO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBUeXBlRXJyb3IoXCJDYXRjaCBmaWx0ZXIgbXVzdCBpbmhlcml0IGZyb20gRXJyb3Igb3IgYmUgYSBzaW1wbGUgcHJlZGljYXRlIGZ1bmN0aW9uXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvbzg0bzY4XFx1MDAwYVwiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2hJbnN0YW5jZXMubGVuZ3RoID0gajtcbiAgICAgICAgZm4gPSBhcmd1bWVudHNbaV07XG4gICAgICAgIHZhciBjYXRjaEZpbHRlciA9IG5ldyBDYXRjaEZpbHRlcihjYXRjaEluc3RhbmNlcywgZm4sIHRoaXMpO1xuICAgICAgICByZXR1cm4gdGhpcy5fdGhlbih1bmRlZmluZWQsIGNhdGNoRmlsdGVyLmRvRmlsdGVyLCB1bmRlZmluZWQsXG4gICAgICAgICAgICBjYXRjaEZpbHRlciwgdW5kZWZpbmVkKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3RoZW4odW5kZWZpbmVkLCBmbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5yZWZsZWN0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLl90aGVuKHJlZmxlY3QsIHJlZmxlY3QsIHVuZGVmaW5lZCwgdGhpcywgdW5kZWZpbmVkKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbiAoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcykge1xuICAgIGlmIChpc0RlYnVnZ2luZygpICYmIGFyZ3VtZW50cy5sZW5ndGggPiAwICYmXG4gICAgICAgIHR5cGVvZiBkaWRGdWxmaWxsICE9PSBcImZ1bmN0aW9uXCIgJiZcbiAgICAgICAgdHlwZW9mIGRpZFJlamVjdCAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHZhciBtc2cgPSBcIi50aGVuKCkgb25seSBhY2NlcHRzIGZ1bmN0aW9ucyBidXQgd2FzIHBhc3NlZDogXCIgK1xuICAgICAgICAgICAgICAgIHV0aWwuY2xhc3NTdHJpbmcoZGlkRnVsZmlsbCk7XG4gICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgbXNnICs9IFwiLCBcIiArIHV0aWwuY2xhc3NTdHJpbmcoZGlkUmVqZWN0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl93YXJuKG1zZyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl90aGVuKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCwgZGlkUHJvZ3Jlc3MsXG4gICAgICAgIHVuZGVmaW5lZCwgdW5kZWZpbmVkKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLmRvbmUgPSBmdW5jdGlvbiAoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcykge1xuICAgIHZhciBwcm9taXNlID0gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLFxuICAgICAgICB1bmRlZmluZWQsIHVuZGVmaW5lZCk7XG4gICAgcHJvbWlzZS5fc2V0SXNGaW5hbCgpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuc3ByZWFkID0gZnVuY3Rpb24gKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCkge1xuICAgIHJldHVybiB0aGlzLmFsbCgpLl90aGVuKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCwgdW5kZWZpbmVkLCBBUFBMWSwgdW5kZWZpbmVkKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLmlzQ2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICF0aGlzLmlzUmVzb2x2ZWQoKSAmJlxuICAgICAgICB0aGlzLl9jYW5jZWxsYWJsZSgpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciByZXQgPSB7XG4gICAgICAgIGlzRnVsZmlsbGVkOiBmYWxzZSxcbiAgICAgICAgaXNSZWplY3RlZDogZmFsc2UsXG4gICAgICAgIGZ1bGZpbGxtZW50VmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgICAgcmVqZWN0aW9uUmVhc29uOiB1bmRlZmluZWRcbiAgICB9O1xuICAgIGlmICh0aGlzLmlzRnVsZmlsbGVkKCkpIHtcbiAgICAgICAgcmV0LmZ1bGZpbGxtZW50VmFsdWUgPSB0aGlzLnZhbHVlKCk7XG4gICAgICAgIHJldC5pc0Z1bGZpbGxlZCA9IHRydWU7XG4gICAgfSBlbHNlIGlmICh0aGlzLmlzUmVqZWN0ZWQoKSkge1xuICAgICAgICByZXQucmVqZWN0aW9uUmVhc29uID0gdGhpcy5yZWFzb24oKTtcbiAgICAgICAgcmV0LmlzUmVqZWN0ZWQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuYWxsID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZUFycmF5KHRoaXMpLnByb21pc2UoKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgcmV0dXJuIHRoaXMuY2F1Z2h0KHV0aWwub3JpZ2luYXRlc0Zyb21SZWplY3Rpb24sIGZuKTtcbn07XG5cblByb21pc2UuaXMgPSBmdW5jdGlvbiAodmFsKSB7XG4gICAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIFByb21pc2U7XG59O1xuXG5Qcm9taXNlLmZyb21Ob2RlID0gZnVuY3Rpb24oZm4pIHtcbiAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpO1xuICAgIHZhciByZXN1bHQgPSB0cnlDYXRjaChmbikobm9kZWJhY2tGb3JQcm9taXNlKHJldCkpO1xuICAgIGlmIChyZXN1bHQgPT09IGVycm9yT2JqKSB7XG4gICAgICAgIHJldC5fcmVqZWN0Q2FsbGJhY2socmVzdWx0LmUsIHRydWUsIHRydWUpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5hbGwgPSBmdW5jdGlvbiAocHJvbWlzZXMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2VBcnJheShwcm9taXNlcykucHJvbWlzZSgpO1xufTtcblxuUHJvbWlzZS5kZWZlciA9IFByb21pc2UucGVuZGluZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2VSZXNvbHZlcihwcm9taXNlKTtcbn07XG5cblByb21pc2UuY2FzdCA9IGZ1bmN0aW9uIChvYmopIHtcbiAgICB2YXIgcmV0ID0gdHJ5Q29udmVydFRvUHJvbWlzZShvYmopO1xuICAgIGlmICghKHJldCBpbnN0YW5jZW9mIFByb21pc2UpKSB7XG4gICAgICAgIHZhciB2YWwgPSByZXQ7XG4gICAgICAgIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICAgICAgcmV0Ll9mdWxmaWxsVW5jaGVja2VkKHZhbCk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuXG5Qcm9taXNlLnJlc29sdmUgPSBQcm9taXNlLmZ1bGZpbGxlZCA9IFByb21pc2UuY2FzdDtcblxuUHJvbWlzZS5yZWplY3QgPSBQcm9taXNlLnJlamVjdGVkID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgcmV0Ll9jYXB0dXJlU3RhY2tUcmFjZSgpO1xuICAgIHJldC5fcmVqZWN0Q2FsbGJhY2socmVhc29uLCB0cnVlKTtcbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5zZXRTY2hlZHVsZXIgPSBmdW5jdGlvbihmbikge1xuICAgIGlmICh0eXBlb2YgZm4gIT09IFwiZnVuY3Rpb25cIikgdGhyb3cgbmV3IFR5cGVFcnJvcihcImZuIG11c3QgYmUgYSBmdW5jdGlvblxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsLzkxNmxKSlxcdTAwMGFcIik7XG4gICAgdmFyIHByZXYgPSBhc3luYy5fc2NoZWR1bGU7XG4gICAgYXN5bmMuX3NjaGVkdWxlID0gZm47XG4gICAgcmV0dXJuIHByZXY7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fdGhlbiA9IGZ1bmN0aW9uIChcbiAgICBkaWRGdWxmaWxsLFxuICAgIGRpZFJlamVjdCxcbiAgICBkaWRQcm9ncmVzcyxcbiAgICByZWNlaXZlcixcbiAgICBpbnRlcm5hbERhdGFcbikge1xuICAgIHZhciBoYXZlSW50ZXJuYWxEYXRhID0gaW50ZXJuYWxEYXRhICE9PSB1bmRlZmluZWQ7XG4gICAgdmFyIHJldCA9IGhhdmVJbnRlcm5hbERhdGEgPyBpbnRlcm5hbERhdGEgOiBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG5cbiAgICBpZiAoIWhhdmVJbnRlcm5hbERhdGEpIHtcbiAgICAgICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHRoaXMsIDQgfCAxKTtcbiAgICAgICAgcmV0Ll9jYXB0dXJlU3RhY2tUcmFjZSgpO1xuICAgIH1cblxuICAgIHZhciB0YXJnZXQgPSB0aGlzLl90YXJnZXQoKTtcbiAgICBpZiAodGFyZ2V0ICE9PSB0aGlzKSB7XG4gICAgICAgIGlmIChyZWNlaXZlciA9PT0gdW5kZWZpbmVkKSByZWNlaXZlciA9IHRoaXMuX2JvdW5kVG87XG4gICAgICAgIGlmICghaGF2ZUludGVybmFsRGF0YSkgcmV0Ll9zZXRJc01pZ3JhdGVkKCk7XG4gICAgfVxuXG4gICAgdmFyIGNhbGxiYWNrSW5kZXggPSB0YXJnZXQuX2FkZENhbGxiYWNrcyhkaWRGdWxmaWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlkUmVqZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlkUHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldERvbWFpbigpKTtcblxuICAgIGlmICh0YXJnZXQuX2lzUmVzb2x2ZWQoKSAmJiAhdGFyZ2V0Ll9pc1NldHRsZVByb21pc2VzUXVldWVkKCkpIHtcbiAgICAgICAgYXN5bmMuaW52b2tlKFxuICAgICAgICAgICAgdGFyZ2V0Ll9zZXR0bGVQcm9taXNlQXRQb3N0UmVzb2x1dGlvbiwgdGFyZ2V0LCBjYWxsYmFja0luZGV4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VBdFBvc3RSZXNvbHV0aW9uID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgaWYgKHRoaXMuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHRoaXMuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTtcbiAgICB0aGlzLl9zZXR0bGVQcm9taXNlQXQoaW5kZXgpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2xlbmd0aCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYml0RmllbGQgJiAxMzEwNzE7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5faXNGb2xsb3dpbmdPckZ1bGZpbGxlZE9yUmVqZWN0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDkzOTUyNDA5NikgPiAwO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2lzRm9sbG93aW5nID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA1MzY4NzA5MTIpID09PSA1MzY4NzA5MTI7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fc2V0TGVuZ3RoID0gZnVuY3Rpb24gKGxlbikge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gKHRoaXMuX2JpdEZpZWxkICYgLTEzMTA3MikgfFxuICAgICAgICAobGVuICYgMTMxMDcxKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRGdWxmaWxsZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDI2ODQzNTQ1Njtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRSZWplY3RlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgMTM0MjE3NzI4O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldEZvbGxvd2luZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNTM2ODcwOTEyO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldElzRmluYWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDMzNTU0NDMyO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2lzRmluYWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDMzNTU0NDMyKSA+IDA7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDY3MTA4ODY0KSA+IDA7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fc2V0Q2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDY3MTA4ODY0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0Q2FuY2VsbGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+NjcxMDg4NjQpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldElzTWlncmF0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDQxOTQzMDQ7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fdW5zZXRJc01pZ3JhdGVkID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjQxOTQzMDQpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2lzTWlncmF0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDQxOTQzMDQpID4gMDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9yZWNlaXZlckF0ID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgdmFyIHJldCA9IGluZGV4ID09PSAwXG4gICAgICAgID8gdGhpcy5fcmVjZWl2ZXIwXG4gICAgICAgIDogdGhpc1tcbiAgICAgICAgICAgIGluZGV4ICogNSAtIDUgKyA0XTtcbiAgICBpZiAocmV0ID09PSB1bmRlZmluZWQgJiYgdGhpcy5faXNCb3VuZCgpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ib3VuZFZhbHVlKCk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fcHJvbWlzZUF0ID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgcmV0dXJuIGluZGV4ID09PSAwXG4gICAgICAgID8gdGhpcy5fcHJvbWlzZTBcbiAgICAgICAgOiB0aGlzW2luZGV4ICogNSAtIDUgKyAzXTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9mdWxmaWxsbWVudEhhbmRsZXJBdCA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgIHJldHVybiBpbmRleCA9PT0gMFxuICAgICAgICA/IHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjBcbiAgICAgICAgOiB0aGlzW2luZGV4ICogNSAtIDUgKyAwXTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9yZWplY3Rpb25IYW5kbGVyQXQgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICByZXR1cm4gaW5kZXggPT09IDBcbiAgICAgICAgPyB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMFxuICAgICAgICA6IHRoaXNbaW5kZXggKiA1IC0gNSArIDFdO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2JvdW5kVmFsdWUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmV0ID0gdGhpcy5fYm91bmRUbztcbiAgICBpZiAocmV0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKHJldCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICAgIGlmIChyZXQuaXNGdWxmaWxsZWQoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXQudmFsdWUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX21pZ3JhdGVDYWxsYmFja3MgPSBmdW5jdGlvbiAoZm9sbG93ZXIsIGluZGV4KSB7XG4gICAgdmFyIGZ1bGZpbGwgPSBmb2xsb3dlci5fZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpO1xuICAgIHZhciByZWplY3QgPSBmb2xsb3dlci5fcmVqZWN0aW9uSGFuZGxlckF0KGluZGV4KTtcbiAgICB2YXIgcHJvZ3Jlc3MgPSBmb2xsb3dlci5fcHJvZ3Jlc3NIYW5kbGVyQXQoaW5kZXgpO1xuICAgIHZhciBwcm9taXNlID0gZm9sbG93ZXIuX3Byb21pc2VBdChpbmRleCk7XG4gICAgdmFyIHJlY2VpdmVyID0gZm9sbG93ZXIuX3JlY2VpdmVyQXQoaW5kZXgpO1xuICAgIGlmIChwcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgcHJvbWlzZS5fc2V0SXNNaWdyYXRlZCgpO1xuICAgIHRoaXMuX2FkZENhbGxiYWNrcyhmdWxmaWxsLCByZWplY3QsIHByb2dyZXNzLCBwcm9taXNlLCByZWNlaXZlciwgbnVsbCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fYWRkQ2FsbGJhY2tzID0gZnVuY3Rpb24gKFxuICAgIGZ1bGZpbGwsXG4gICAgcmVqZWN0LFxuICAgIHByb2dyZXNzLFxuICAgIHByb21pc2UsXG4gICAgcmVjZWl2ZXIsXG4gICAgZG9tYWluXG4pIHtcbiAgICB2YXIgaW5kZXggPSB0aGlzLl9sZW5ndGgoKTtcblxuICAgIGlmIChpbmRleCA+PSAxMzEwNzEgLSA1KSB7XG4gICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgdGhpcy5fc2V0TGVuZ3RoKDApO1xuICAgIH1cblxuICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICB0aGlzLl9wcm9taXNlMCA9IHByb21pc2U7XG4gICAgICAgIGlmIChyZWNlaXZlciAhPT0gdW5kZWZpbmVkKSB0aGlzLl9yZWNlaXZlcjAgPSByZWNlaXZlcjtcbiAgICAgICAgaWYgKHR5cGVvZiBmdWxmaWxsID09PSBcImZ1bmN0aW9uXCIgJiYgIXRoaXMuX2lzQ2FycnlpbmdTdGFja1RyYWNlKCkpIHtcbiAgICAgICAgICAgIHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjAgPVxuICAgICAgICAgICAgICAgIGRvbWFpbiA9PT0gbnVsbCA/IGZ1bGZpbGwgOiBkb21haW4uYmluZChmdWxmaWxsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHJlamVjdCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9XG4gICAgICAgICAgICAgICAgZG9tYWluID09PSBudWxsID8gcmVqZWN0IDogZG9tYWluLmJpbmQocmVqZWN0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHByb2dyZXNzID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyZXNzSGFuZGxlcjAgPVxuICAgICAgICAgICAgICAgIGRvbWFpbiA9PT0gbnVsbCA/IHByb2dyZXNzIDogZG9tYWluLmJpbmQocHJvZ3Jlc3MpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGJhc2UgPSBpbmRleCAqIDUgLSA1O1xuICAgICAgICB0aGlzW2Jhc2UgKyAzXSA9IHByb21pc2U7XG4gICAgICAgIHRoaXNbYmFzZSArIDRdID0gcmVjZWl2ZXI7XG4gICAgICAgIGlmICh0eXBlb2YgZnVsZmlsbCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICB0aGlzW2Jhc2UgKyAwXSA9XG4gICAgICAgICAgICAgICAgZG9tYWluID09PSBudWxsID8gZnVsZmlsbCA6IGRvbWFpbi5iaW5kKGZ1bGZpbGwpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgcmVqZWN0ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXNbYmFzZSArIDFdID1cbiAgICAgICAgICAgICAgICBkb21haW4gPT09IG51bGwgPyByZWplY3QgOiBkb21haW4uYmluZChyZWplY3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgcHJvZ3Jlc3MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgdGhpc1tiYXNlICsgMl0gPVxuICAgICAgICAgICAgICAgIGRvbWFpbiA9PT0gbnVsbCA/IHByb2dyZXNzIDogZG9tYWluLmJpbmQocHJvZ3Jlc3MpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuX3NldExlbmd0aChpbmRleCArIDEpO1xuICAgIHJldHVybiBpbmRleDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRQcm94eUhhbmRsZXJzID0gZnVuY3Rpb24gKHJlY2VpdmVyLCBwcm9taXNlU2xvdFZhbHVlKSB7XG4gICAgdmFyIGluZGV4ID0gdGhpcy5fbGVuZ3RoKCk7XG5cbiAgICBpZiAoaW5kZXggPj0gMTMxMDcxIC0gNSkge1xuICAgICAgICBpbmRleCA9IDA7XG4gICAgICAgIHRoaXMuX3NldExlbmd0aCgwKTtcbiAgICB9XG4gICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgIHRoaXMuX3Byb21pc2UwID0gcHJvbWlzZVNsb3RWYWx1ZTtcbiAgICAgICAgdGhpcy5fcmVjZWl2ZXIwID0gcmVjZWl2ZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGJhc2UgPSBpbmRleCAqIDUgLSA1O1xuICAgICAgICB0aGlzW2Jhc2UgKyAzXSA9IHByb21pc2VTbG90VmFsdWU7XG4gICAgICAgIHRoaXNbYmFzZSArIDRdID0gcmVjZWl2ZXI7XG4gICAgfVxuICAgIHRoaXMuX3NldExlbmd0aChpbmRleCArIDEpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3Byb3h5UHJvbWlzZUFycmF5ID0gZnVuY3Rpb24gKHByb21pc2VBcnJheSwgaW5kZXgpIHtcbiAgICB0aGlzLl9zZXRQcm94eUhhbmRsZXJzKHByb21pc2VBcnJheSwgaW5kZXgpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3Jlc29sdmVDYWxsYmFjayA9IGZ1bmN0aW9uKHZhbHVlLCBzaG91bGRCaW5kKSB7XG4gICAgaWYgKHRoaXMuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkKCkpIHJldHVybjtcbiAgICBpZiAodmFsdWUgPT09IHRoaXMpXG4gICAgICAgIHJldHVybiB0aGlzLl9yZWplY3RDYWxsYmFjayhtYWtlU2VsZlJlc29sdXRpb25FcnJvcigpLCBmYWxzZSwgdHJ1ZSk7XG4gICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UodmFsdWUsIHRoaXMpO1xuICAgIGlmICghKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSByZXR1cm4gdGhpcy5fZnVsZmlsbCh2YWx1ZSk7XG5cbiAgICB2YXIgcHJvcGFnYXRpb25GbGFncyA9IDEgfCAoc2hvdWxkQmluZCA/IDQgOiAwKTtcbiAgICB0aGlzLl9wcm9wYWdhdGVGcm9tKG1heWJlUHJvbWlzZSwgcHJvcGFnYXRpb25GbGFncyk7XG4gICAgdmFyIHByb21pc2UgPSBtYXliZVByb21pc2UuX3RhcmdldCgpO1xuICAgIGlmIChwcm9taXNlLl9pc1BlbmRpbmcoKSkge1xuICAgICAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcbiAgICAgICAgICAgIHByb21pc2UuX21pZ3JhdGVDYWxsYmFja3ModGhpcywgaSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc2V0Rm9sbG93aW5nKCk7XG4gICAgICAgIHRoaXMuX3NldExlbmd0aCgwKTtcbiAgICAgICAgdGhpcy5fc2V0Rm9sbG93ZWUocHJvbWlzZSk7XG4gICAgfSBlbHNlIGlmIChwcm9taXNlLl9pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICAgIHRoaXMuX2Z1bGZpbGxVbmNoZWNrZWQocHJvbWlzZS5fdmFsdWUoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fcmVqZWN0VW5jaGVja2VkKHByb21pc2UuX3JlYXNvbigpLFxuICAgICAgICAgICAgcHJvbWlzZS5fZ2V0Q2FycmllZFN0YWNrVHJhY2UoKSk7XG4gICAgfVxufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdENhbGxiYWNrID1cbmZ1bmN0aW9uKHJlYXNvbiwgc3luY2hyb25vdXMsIHNob3VsZE5vdE1hcmtPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24pIHtcbiAgICBpZiAoIXNob3VsZE5vdE1hcmtPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24pIHtcbiAgICAgICAgdXRpbC5tYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24ocmVhc29uKTtcbiAgICB9XG4gICAgdmFyIHRyYWNlID0gdXRpbC5lbnN1cmVFcnJvck9iamVjdChyZWFzb24pO1xuICAgIHZhciBoYXNTdGFjayA9IHRyYWNlID09PSByZWFzb247XG4gICAgdGhpcy5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSwgc3luY2hyb25vdXMgPyBoYXNTdGFjayA6IGZhbHNlKTtcbiAgICB0aGlzLl9yZWplY3QocmVhc29uLCBoYXNTdGFjayA/IHVuZGVmaW5lZCA6IHRyYWNlKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9yZXNvbHZlRnJvbVJlc29sdmVyID0gZnVuY3Rpb24gKHJlc29sdmVyKSB7XG4gICAgdmFyIHByb21pc2UgPSB0aGlzO1xuICAgIHRoaXMuX2NhcHR1cmVTdGFja1RyYWNlKCk7XG4gICAgdGhpcy5fcHVzaENvbnRleHQoKTtcbiAgICB2YXIgc3luY2hyb25vdXMgPSB0cnVlO1xuICAgIHZhciByID0gdHJ5Q2F0Y2gocmVzb2x2ZXIpKGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIGlmIChwcm9taXNlID09PSBudWxsKSByZXR1cm47XG4gICAgICAgIHByb21pc2UuX3Jlc29sdmVDYWxsYmFjayh2YWx1ZSk7XG4gICAgICAgIHByb21pc2UgPSBudWxsO1xuICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHtcbiAgICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2socmVhc29uLCBzeW5jaHJvbm91cyk7XG4gICAgICAgIHByb21pc2UgPSBudWxsO1xuICAgIH0pO1xuICAgIHN5bmNocm9ub3VzID0gZmFsc2U7XG4gICAgdGhpcy5fcG9wQ29udGV4dCgpO1xuXG4gICAgaWYgKHIgIT09IHVuZGVmaW5lZCAmJiByID09PSBlcnJvck9iaiAmJiBwcm9taXNlICE9PSBudWxsKSB7XG4gICAgICAgIHByb21pc2UuX3JlamVjdENhbGxiYWNrKHIuZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgIHByb21pc2UgPSBudWxsO1xuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXR0bGVQcm9taXNlRnJvbUhhbmRsZXIgPSBmdW5jdGlvbiAoXG4gICAgaGFuZGxlciwgcmVjZWl2ZXIsIHZhbHVlLCBwcm9taXNlXG4pIHtcbiAgICBpZiAocHJvbWlzZS5faXNSZWplY3RlZCgpKSByZXR1cm47XG4gICAgcHJvbWlzZS5fcHVzaENvbnRleHQoKTtcbiAgICB2YXIgeDtcbiAgICBpZiAocmVjZWl2ZXIgPT09IEFQUExZICYmICF0aGlzLl9pc1JlamVjdGVkKCkpIHtcbiAgICAgICAgeCA9IHRyeUNhdGNoKGhhbmRsZXIpLmFwcGx5KHRoaXMuX2JvdW5kVmFsdWUoKSwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHggPSB0cnlDYXRjaChoYW5kbGVyKS5jYWxsKHJlY2VpdmVyLCB2YWx1ZSk7XG4gICAgfVxuICAgIHByb21pc2UuX3BvcENvbnRleHQoKTtcblxuICAgIGlmICh4ID09PSBlcnJvck9iaiB8fCB4ID09PSBwcm9taXNlIHx8IHggPT09IE5FWFRfRklMVEVSKSB7XG4gICAgICAgIHZhciBlcnIgPSB4ID09PSBwcm9taXNlID8gbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IoKSA6IHguZTtcbiAgICAgICAgcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2soZXJyLCBmYWxzZSwgdHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcHJvbWlzZS5fcmVzb2x2ZUNhbGxiYWNrKHgpO1xuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl90YXJnZXQgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmV0ID0gdGhpcztcbiAgICB3aGlsZSAocmV0Ll9pc0ZvbGxvd2luZygpKSByZXQgPSByZXQuX2ZvbGxvd2VlKCk7XG4gICAgcmV0dXJuIHJldDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9mb2xsb3dlZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9zZXRGb2xsb3dlZSA9IGZ1bmN0aW9uKHByb21pc2UpIHtcbiAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9IHByb21pc2U7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fY2xlYW5WYWx1ZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuX2NhbmNlbGxhYmxlKCkpIHtcbiAgICAgICAgdGhpcy5fY2FuY2VsbGF0aW9uUGFyZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl9wcm9wYWdhdGVGcm9tID0gZnVuY3Rpb24gKHBhcmVudCwgZmxhZ3MpIHtcbiAgICBpZiAoKGZsYWdzICYgMSkgPiAwICYmIHBhcmVudC5fY2FuY2VsbGFibGUoKSkge1xuICAgICAgICB0aGlzLl9zZXRDYW5jZWxsYWJsZSgpO1xuICAgICAgICB0aGlzLl9jYW5jZWxsYXRpb25QYXJlbnQgPSBwYXJlbnQ7XG4gICAgfVxuICAgIGlmICgoZmxhZ3MgJiA0KSA+IDAgJiYgcGFyZW50Ll9pc0JvdW5kKCkpIHtcbiAgICAgICAgdGhpcy5fc2V0Qm91bmRUbyhwYXJlbnQuX2JvdW5kVG8pO1xuICAgIH1cbn07XG5cblByb21pc2UucHJvdG90eXBlLl9mdWxmaWxsID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkKCkpIHJldHVybjtcbiAgICB0aGlzLl9mdWxmaWxsVW5jaGVja2VkKHZhbHVlKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9yZWplY3QgPSBmdW5jdGlvbiAocmVhc29uLCBjYXJyaWVkU3RhY2tUcmFjZSkge1xuICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpKSByZXR1cm47XG4gICAgdGhpcy5fcmVqZWN0VW5jaGVja2VkKHJlYXNvbiwgY2FycmllZFN0YWNrVHJhY2UpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VBdCA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgIHZhciBwcm9taXNlID0gdGhpcy5fcHJvbWlzZUF0KGluZGV4KTtcbiAgICB2YXIgaXNQcm9taXNlID0gcHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2U7XG5cbiAgICBpZiAoaXNQcm9taXNlICYmIHByb21pc2UuX2lzTWlncmF0ZWQoKSkge1xuICAgICAgICBwcm9taXNlLl91bnNldElzTWlncmF0ZWQoKTtcbiAgICAgICAgcmV0dXJuIGFzeW5jLmludm9rZSh0aGlzLl9zZXR0bGVQcm9taXNlQXQsIHRoaXMsIGluZGV4KTtcbiAgICB9XG4gICAgdmFyIGhhbmRsZXIgPSB0aGlzLl9pc0Z1bGZpbGxlZCgpXG4gICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpXG4gICAgICAgIDogdGhpcy5fcmVqZWN0aW9uSGFuZGxlckF0KGluZGV4KTtcblxuICAgIHZhciBjYXJyaWVkU3RhY2tUcmFjZSA9XG4gICAgICAgIHRoaXMuX2lzQ2FycnlpbmdTdGFja1RyYWNlKCkgPyB0aGlzLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSgpIDogdW5kZWZpbmVkO1xuICAgIHZhciB2YWx1ZSA9IHRoaXMuX3NldHRsZWRWYWx1ZTtcbiAgICB2YXIgcmVjZWl2ZXIgPSB0aGlzLl9yZWNlaXZlckF0KGluZGV4KTtcbiAgICB0aGlzLl9jbGVhckNhbGxiYWNrRGF0YUF0SW5kZXgoaW5kZXgpO1xuXG4gICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgaWYgKCFpc1Byb21pc2UpIHtcbiAgICAgICAgICAgIGhhbmRsZXIuY2FsbChyZWNlaXZlciwgdmFsdWUsIHByb21pc2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fc2V0dGxlUHJvbWlzZUZyb21IYW5kbGVyKGhhbmRsZXIsIHJlY2VpdmVyLCB2YWx1ZSwgcHJvbWlzZSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHJlY2VpdmVyIGluc3RhbmNlb2YgUHJvbWlzZUFycmF5KSB7XG4gICAgICAgIGlmICghcmVjZWl2ZXIuX2lzUmVzb2x2ZWQoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2lzRnVsZmlsbGVkKCkpIHtcbiAgICAgICAgICAgICAgICByZWNlaXZlci5fcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgcHJvbWlzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWNlaXZlci5fcHJvbWlzZVJlamVjdGVkKHZhbHVlLCBwcm9taXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlKSB7XG4gICAgICAgIGlmICh0aGlzLl9pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICAgICAgICBwcm9taXNlLl9mdWxmaWxsKHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByb21pc2UuX3JlamVjdCh2YWx1ZSwgY2FycmllZFN0YWNrVHJhY2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGluZGV4ID49IDQgJiYgKGluZGV4ICYgMzEpID09PSA0KVxuICAgICAgICBhc3luYy5pbnZva2VMYXRlcih0aGlzLl9zZXRMZW5ndGgsIHRoaXMsIDApO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2NsZWFyQ2FsbGJhY2tEYXRhQXRJbmRleCA9IGZ1bmN0aW9uKGluZGV4KSB7XG4gICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgIGlmICghdGhpcy5faXNDYXJyeWluZ1N0YWNrVHJhY2UoKSkge1xuICAgICAgICAgICAgdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9XG4gICAgICAgIHRoaXMuX3Byb2dyZXNzSGFuZGxlcjAgPVxuICAgICAgICB0aGlzLl9yZWNlaXZlcjAgPVxuICAgICAgICB0aGlzLl9wcm9taXNlMCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgYmFzZSA9IGluZGV4ICogNSAtIDU7XG4gICAgICAgIHRoaXNbYmFzZSArIDNdID1cbiAgICAgICAgdGhpc1tiYXNlICsgNF0gPVxuICAgICAgICB0aGlzW2Jhc2UgKyAwXSA9XG4gICAgICAgIHRoaXNbYmFzZSArIDFdID1cbiAgICAgICAgdGhpc1tiYXNlICsgMl0gPSB1bmRlZmluZWQ7XG4gICAgfVxufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX2lzU2V0dGxlUHJvbWlzZXNRdWV1ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmXG4gICAgICAgICAgICAtMTA3Mzc0MTgyNCkgPT09IC0xMDczNzQxODI0O1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldFNldHRsZVByb21pc2VzUXVldWVkID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCAtMTA3Mzc0MTgyNDtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl91bnNldFNldHRsZVByb21pc2VzUXVldWVkID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofi0xMDczNzQxODI0KTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9xdWV1ZVNldHRsZVByb21pc2VzID0gZnVuY3Rpb24oKSB7XG4gICAgYXN5bmMuc2V0dGxlUHJvbWlzZXModGhpcyk7XG4gICAgdGhpcy5fc2V0U2V0dGxlUHJvbWlzZXNRdWV1ZWQoKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLl9mdWxmaWxsVW5jaGVja2VkID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID09PSB0aGlzKSB7XG4gICAgICAgIHZhciBlcnIgPSBtYWtlU2VsZlJlc29sdXRpb25FcnJvcigpO1xuICAgICAgICB0aGlzLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWplY3RVbmNoZWNrZWQoZXJyLCB1bmRlZmluZWQpO1xuICAgIH1cbiAgICB0aGlzLl9zZXRGdWxmaWxsZWQoKTtcbiAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLl9jbGVhblZhbHVlcygpO1xuXG4gICAgaWYgKHRoaXMuX2xlbmd0aCgpID4gMCkge1xuICAgICAgICB0aGlzLl9xdWV1ZVNldHRsZVByb21pc2VzKCk7XG4gICAgfVxufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdFVuY2hlY2tlZENoZWNrRXJyb3IgPSBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgdmFyIHRyYWNlID0gdXRpbC5lbnN1cmVFcnJvck9iamVjdChyZWFzb24pO1xuICAgIHRoaXMuX3JlamVjdFVuY2hlY2tlZChyZWFzb24sIHRyYWNlID09PSByZWFzb24gPyB1bmRlZmluZWQgOiB0cmFjZSk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fcmVqZWN0VW5jaGVja2VkID0gZnVuY3Rpb24gKHJlYXNvbiwgdHJhY2UpIHtcbiAgICBpZiAocmVhc29uID09PSB0aGlzKSB7XG4gICAgICAgIHZhciBlcnIgPSBtYWtlU2VsZlJlc29sdXRpb25FcnJvcigpO1xuICAgICAgICB0aGlzLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWplY3RVbmNoZWNrZWQoZXJyKTtcbiAgICB9XG4gICAgdGhpcy5fc2V0UmVqZWN0ZWQoKTtcbiAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSByZWFzb247XG4gICAgdGhpcy5fY2xlYW5WYWx1ZXMoKTtcblxuICAgIGlmICh0aGlzLl9pc0ZpbmFsKCkpIHtcbiAgICAgICAgYXN5bmMudGhyb3dMYXRlcihmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZiAoXCJzdGFja1wiIGluIGUpIHtcbiAgICAgICAgICAgICAgICBhc3luYy5pbnZva2VGaXJzdChcbiAgICAgICAgICAgICAgICAgICAgQ2FwdHVyZWRUcmFjZS51bmhhbmRsZWRSZWplY3Rpb24sIHVuZGVmaW5lZCwgZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9LCB0cmFjZSA9PT0gdW5kZWZpbmVkID8gcmVhc29uIDogdHJhY2UpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRyYWNlICE9PSB1bmRlZmluZWQgJiYgdHJhY2UgIT09IHJlYXNvbikge1xuICAgICAgICB0aGlzLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSh0cmFjZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2xlbmd0aCgpID4gMCkge1xuICAgICAgICB0aGlzLl9xdWV1ZVNldHRsZVByb21pc2VzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fZW5zdXJlUG9zc2libGVSZWplY3Rpb25IYW5kbGVkKCk7XG4gICAgfVxufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VzID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX3Vuc2V0U2V0dGxlUHJvbWlzZXNRdWV1ZWQoKTtcbiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgICB0aGlzLl9zZXR0bGVQcm9taXNlQXQoaSk7XG4gICAgfVxufTtcblxudXRpbC5ub3RFbnVtZXJhYmxlUHJvcChQcm9taXNlLFxuICAgICAgICAgICAgICAgICAgICAgICBcIl9tYWtlU2VsZlJlc29sdXRpb25FcnJvclwiLFxuICAgICAgICAgICAgICAgICAgICAgICBtYWtlU2VsZlJlc29sdXRpb25FcnJvcik7XG5cbl9kZXJlcV8oXCIuL3Byb2dyZXNzLmpzXCIpKFByb21pc2UsIFByb21pc2VBcnJheSk7XG5fZGVyZXFfKFwiLi9tZXRob2QuanNcIikoUHJvbWlzZSwgSU5URVJOQUwsIHRyeUNvbnZlcnRUb1Byb21pc2UsIGFwaVJlamVjdGlvbik7XG5fZGVyZXFfKFwiLi9iaW5kLmpzXCIpKFByb21pc2UsIElOVEVSTkFMLCB0cnlDb252ZXJ0VG9Qcm9taXNlKTtcbl9kZXJlcV8oXCIuL2ZpbmFsbHkuanNcIikoUHJvbWlzZSwgTkVYVF9GSUxURVIsIHRyeUNvbnZlcnRUb1Byb21pc2UpO1xuX2RlcmVxXyhcIi4vZGlyZWN0X3Jlc29sdmUuanNcIikoUHJvbWlzZSk7XG5fZGVyZXFfKFwiLi9zeW5jaHJvbm91c19pbnNwZWN0aW9uLmpzXCIpKFByb21pc2UpO1xuX2RlcmVxXyhcIi4vam9pbi5qc1wiKShQcm9taXNlLCBQcm9taXNlQXJyYXksIHRyeUNvbnZlcnRUb1Byb21pc2UsIElOVEVSTkFMKTtcblByb21pc2UuUHJvbWlzZSA9IFByb21pc2U7XG5fZGVyZXFfKCcuL21hcC5qcycpKFByb21pc2UsIFByb21pc2VBcnJheSwgYXBpUmVqZWN0aW9uLCB0cnlDb252ZXJ0VG9Qcm9taXNlLCBJTlRFUk5BTCk7XG5fZGVyZXFfKCcuL2NhbmNlbC5qcycpKFByb21pc2UpO1xuX2RlcmVxXygnLi91c2luZy5qcycpKFByb21pc2UsIGFwaVJlamVjdGlvbiwgdHJ5Q29udmVydFRvUHJvbWlzZSwgY3JlYXRlQ29udGV4dCk7XG5fZGVyZXFfKCcuL2dlbmVyYXRvcnMuanMnKShQcm9taXNlLCBhcGlSZWplY3Rpb24sIElOVEVSTkFMLCB0cnlDb252ZXJ0VG9Qcm9taXNlKTtcbl9kZXJlcV8oJy4vbm9kZWlmeS5qcycpKFByb21pc2UpO1xuX2RlcmVxXygnLi9jYWxsX2dldC5qcycpKFByb21pc2UpO1xuX2RlcmVxXygnLi9wcm9wcy5qcycpKFByb21pc2UsIFByb21pc2VBcnJheSwgdHJ5Q29udmVydFRvUHJvbWlzZSwgYXBpUmVqZWN0aW9uKTtcbl9kZXJlcV8oJy4vcmFjZS5qcycpKFByb21pc2UsIElOVEVSTkFMLCB0cnlDb252ZXJ0VG9Qcm9taXNlLCBhcGlSZWplY3Rpb24pO1xuX2RlcmVxXygnLi9yZWR1Y2UuanMnKShQcm9taXNlLCBQcm9taXNlQXJyYXksIGFwaVJlamVjdGlvbiwgdHJ5Q29udmVydFRvUHJvbWlzZSwgSU5URVJOQUwpO1xuX2RlcmVxXygnLi9zZXR0bGUuanMnKShQcm9taXNlLCBQcm9taXNlQXJyYXkpO1xuX2RlcmVxXygnLi9zb21lLmpzJykoUHJvbWlzZSwgUHJvbWlzZUFycmF5LCBhcGlSZWplY3Rpb24pO1xuX2RlcmVxXygnLi9wcm9taXNpZnkuanMnKShQcm9taXNlLCBJTlRFUk5BTCk7XG5fZGVyZXFfKCcuL2FueS5qcycpKFByb21pc2UpO1xuX2RlcmVxXygnLi9lYWNoLmpzJykoUHJvbWlzZSwgSU5URVJOQUwpO1xuX2RlcmVxXygnLi90aW1lcnMuanMnKShQcm9taXNlLCBJTlRFUk5BTCk7XG5fZGVyZXFfKCcuL2ZpbHRlci5qcycpKFByb21pc2UsIElOVEVSTkFMKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgIHV0aWwudG9GYXN0UHJvcGVydGllcyhQcm9taXNlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICB1dGlsLnRvRmFzdFByb3BlcnRpZXMoUHJvbWlzZS5wcm90b3R5cGUpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgZnVuY3Rpb24gZmlsbFR5cGVzKHZhbHVlKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgcC5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIHAuX3JlamVjdGlvbkhhbmRsZXIwID0gdmFsdWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICBwLl9wcm9ncmVzc0hhbmRsZXIwID0gdmFsdWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgcC5fcHJvbWlzZTAgPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIHAuX3JlY2VpdmVyMCA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICBwLl9zZXR0bGVkVmFsdWUgPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgLy8gQ29tcGxldGUgc2xhY2sgdHJhY2tpbmcsIG9wdCBvdXQgb2YgZmllbGQtdHlwZSB0cmFja2luZyBhbmQgICAgICAgICAgIFxuICAgIC8vIHN0YWJpbGl6ZSBtYXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICBmaWxsVHlwZXMoe2E6IDF9KTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgZmlsbFR5cGVzKHtiOiAyfSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgIGZpbGxUeXBlcyh7YzogM30pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICBmaWxsVHlwZXMoMSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgZmlsbFR5cGVzKGZ1bmN0aW9uKCl7fSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgIGZpbGxUeXBlcyh1bmRlZmluZWQpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICBmaWxsVHlwZXMoZmFsc2UpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgZmlsbFR5cGVzKG5ldyBQcm9taXNlKElOVEVSTkFMKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgIENhcHR1cmVkVHJhY2Uuc2V0Qm91bmRzKGFzeW5jLmZpcnN0TGluZUVycm9yLCB1dGlsLmxhc3RMaW5lRXJyb3IpOyAgICAgICBcbiAgICByZXR1cm4gUHJvbWlzZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cbn07XG5cbn0se1wiLi9hbnkuanNcIjoxLFwiLi9hc3luYy5qc1wiOjIsXCIuL2JpbmQuanNcIjozLFwiLi9jYWxsX2dldC5qc1wiOjUsXCIuL2NhbmNlbC5qc1wiOjYsXCIuL2NhcHR1cmVkX3RyYWNlLmpzXCI6NyxcIi4vY2F0Y2hfZmlsdGVyLmpzXCI6OCxcIi4vY29udGV4dC5qc1wiOjksXCIuL2RlYnVnZ2FiaWxpdHkuanNcIjoxMCxcIi4vZGlyZWN0X3Jlc29sdmUuanNcIjoxMSxcIi4vZWFjaC5qc1wiOjEyLFwiLi9lcnJvcnMuanNcIjoxMyxcIi4vZmlsdGVyLmpzXCI6MTUsXCIuL2ZpbmFsbHkuanNcIjoxNixcIi4vZ2VuZXJhdG9ycy5qc1wiOjE3LFwiLi9qb2luLmpzXCI6MTgsXCIuL21hcC5qc1wiOjE5LFwiLi9tZXRob2QuanNcIjoyMCxcIi4vbm9kZWlmeS5qc1wiOjIxLFwiLi9wcm9ncmVzcy5qc1wiOjIyLFwiLi9wcm9taXNlX2FycmF5LmpzXCI6MjQsXCIuL3Byb21pc2VfcmVzb2x2ZXIuanNcIjoyNSxcIi4vcHJvbWlzaWZ5LmpzXCI6MjYsXCIuL3Byb3BzLmpzXCI6MjcsXCIuL3JhY2UuanNcIjoyOSxcIi4vcmVkdWNlLmpzXCI6MzAsXCIuL3NldHRsZS5qc1wiOjMyLFwiLi9zb21lLmpzXCI6MzMsXCIuL3N5bmNocm9ub3VzX2luc3BlY3Rpb24uanNcIjozNCxcIi4vdGhlbmFibGVzLmpzXCI6MzUsXCIuL3RpbWVycy5qc1wiOjM2LFwiLi91c2luZy5qc1wiOjM3LFwiLi91dGlsLmpzXCI6Mzh9XSwyNDpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwsIHRyeUNvbnZlcnRUb1Byb21pc2UsXG4gICAgYXBpUmVqZWN0aW9uKSB7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgaXNBcnJheSA9IHV0aWwuaXNBcnJheTtcblxuZnVuY3Rpb24gdG9SZXNvbHV0aW9uVmFsdWUodmFsKSB7XG4gICAgc3dpdGNoKHZhbCkge1xuICAgIGNhc2UgLTI6IHJldHVybiBbXTtcbiAgICBjYXNlIC0zOiByZXR1cm4ge307XG4gICAgfVxufVxuXG5mdW5jdGlvbiBQcm9taXNlQXJyYXkodmFsdWVzKSB7XG4gICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlID0gbmV3IFByb21pc2UoSU5URVJOQUwpO1xuICAgIHZhciBwYXJlbnQ7XG4gICAgaWYgKHZhbHVlcyBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgcGFyZW50ID0gdmFsdWVzO1xuICAgICAgICBwcm9taXNlLl9wcm9wYWdhdGVGcm9tKHBhcmVudCwgMSB8IDQpO1xuICAgIH1cbiAgICB0aGlzLl92YWx1ZXMgPSB2YWx1ZXM7XG4gICAgdGhpcy5fbGVuZ3RoID0gMDtcbiAgICB0aGlzLl90b3RhbFJlc29sdmVkID0gMDtcbiAgICB0aGlzLl9pbml0KHVuZGVmaW5lZCwgLTIpO1xufVxuUHJvbWlzZUFycmF5LnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xlbmd0aDtcbn07XG5cblByb21pc2VBcnJheS5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZTtcbn07XG5cblByb21pc2VBcnJheS5wcm90b3R5cGUuX2luaXQgPSBmdW5jdGlvbiBpbml0KF8sIHJlc29sdmVWYWx1ZUlmRW1wdHkpIHtcbiAgICB2YXIgdmFsdWVzID0gdHJ5Q29udmVydFRvUHJvbWlzZSh0aGlzLl92YWx1ZXMsIHRoaXMuX3Byb21pc2UpO1xuICAgIGlmICh2YWx1ZXMgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgIHZhbHVlcyA9IHZhbHVlcy5fdGFyZ2V0KCk7XG4gICAgICAgIHRoaXMuX3ZhbHVlcyA9IHZhbHVlcztcbiAgICAgICAgaWYgKHZhbHVlcy5faXNGdWxmaWxsZWQoKSkge1xuICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzLl92YWx1ZSgpO1xuICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlcykpIHtcbiAgICAgICAgICAgICAgICB2YXIgZXJyID0gbmV3IFByb21pc2UuVHlwZUVycm9yKFwiZXhwZWN0aW5nIGFuIGFycmF5LCBhIHByb21pc2Ugb3IgYSB0aGVuYWJsZVxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsL3M4TU1oY1xcdTAwMGFcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5fX2hhcmRSZWplY3RfXyhlcnIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZXMuX2lzUGVuZGluZygpKSB7XG4gICAgICAgICAgICB2YWx1ZXMuX3RoZW4oXG4gICAgICAgICAgICAgICAgaW5pdCxcbiAgICAgICAgICAgICAgICB0aGlzLl9yZWplY3QsXG4gICAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgcmVzb2x2ZVZhbHVlSWZFbXB0eVxuICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcmVqZWN0KHZhbHVlcy5fcmVhc29uKCkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICghaXNBcnJheSh2YWx1ZXMpKSB7XG4gICAgICAgIHRoaXMuX3Byb21pc2UuX3JlamVjdChhcGlSZWplY3Rpb24oXCJleHBlY3RpbmcgYW4gYXJyYXksIGEgcHJvbWlzZSBvciBhIHRoZW5hYmxlXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvczhNTWhjXFx1MDAwYVwiKS5fcmVhc29uKCkpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgaWYgKHJlc29sdmVWYWx1ZUlmRW1wdHkgPT09IC01KSB7XG4gICAgICAgICAgICB0aGlzLl9yZXNvbHZlRW1wdHlBcnJheSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh0b1Jlc29sdXRpb25WYWx1ZShyZXNvbHZlVmFsdWVJZkVtcHR5KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGVuID0gdGhpcy5nZXRBY3R1YWxMZW5ndGgodmFsdWVzLmxlbmd0aCk7XG4gICAgdGhpcy5fbGVuZ3RoID0gbGVuO1xuICAgIHRoaXMuX3ZhbHVlcyA9IHRoaXMuc2hvdWxkQ29weVZhbHVlcygpID8gbmV3IEFycmF5KGxlbikgOiB0aGlzLl92YWx1ZXM7XG4gICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcbiAgICAgICAgdmFyIGlzUmVzb2x2ZWQgPSB0aGlzLl9pc1Jlc29sdmVkKCk7XG4gICAgICAgIHZhciBtYXliZVByb21pc2UgPSB0cnlDb252ZXJ0VG9Qcm9taXNlKHZhbHVlc1tpXSwgcHJvbWlzZSk7XG4gICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICBtYXliZVByb21pc2UgPSBtYXliZVByb21pc2UuX3RhcmdldCgpO1xuICAgICAgICAgICAgaWYgKGlzUmVzb2x2ZWQpIHtcbiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX2lnbm9yZVJlamVjdGlvbnMoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWF5YmVQcm9taXNlLl9pc1BlbmRpbmcoKSkge1xuICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fcHJveHlQcm9taXNlQXJyYXkodGhpcywgaSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5faXNGdWxmaWxsZWQoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3Byb21pc2VGdWxmaWxsZWQobWF5YmVQcm9taXNlLl92YWx1ZSgpLCBpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcHJvbWlzZVJlamVjdGVkKG1heWJlUHJvbWlzZS5fcmVhc29uKCksIGkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKCFpc1Jlc29sdmVkKSB7XG4gICAgICAgICAgICB0aGlzLl9wcm9taXNlRnVsZmlsbGVkKG1heWJlUHJvbWlzZSwgaSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9pc1Jlc29sdmVkID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZXMgPT09IG51bGw7XG59O1xuXG5Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZXNvbHZlID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgdGhpcy5fdmFsdWVzID0gbnVsbDtcbiAgICB0aGlzLl9wcm9taXNlLl9mdWxmaWxsKHZhbHVlKTtcbn07XG5cblByb21pc2VBcnJheS5wcm90b3R5cGUuX19oYXJkUmVqZWN0X18gPVxuUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIHRoaXMuX3ZhbHVlcyA9IG51bGw7XG4gICAgdGhpcy5fcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2socmVhc29uLCBmYWxzZSwgdHJ1ZSk7XG59O1xuXG5Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlUHJvZ3Jlc3NlZCA9IGZ1bmN0aW9uIChwcm9ncmVzc1ZhbHVlLCBpbmRleCkge1xuICAgIHRoaXMuX3Byb21pc2UuX3Byb2dyZXNzKHtcbiAgICAgICAgaW5kZXg6IGluZGV4LFxuICAgICAgICB2YWx1ZTogcHJvZ3Jlc3NWYWx1ZVxuICAgIH0pO1xufTtcblxuXG5Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkge1xuICAgIHRoaXMuX3ZhbHVlc1tpbmRleF0gPSB2YWx1ZTtcbiAgICB2YXIgdG90YWxSZXNvbHZlZCA9ICsrdGhpcy5fdG90YWxSZXNvbHZlZDtcbiAgICBpZiAodG90YWxSZXNvbHZlZCA+PSB0aGlzLl9sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5fcmVzb2x2ZSh0aGlzLl92YWx1ZXMpO1xuICAgIH1cbn07XG5cblByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VSZWplY3RlZCA9IGZ1bmN0aW9uIChyZWFzb24sIGluZGV4KSB7XG4gICAgdGhpcy5fdG90YWxSZXNvbHZlZCsrO1xuICAgIHRoaXMuX3JlamVjdChyZWFzb24pO1xufTtcblxuUHJvbWlzZUFycmF5LnByb3RvdHlwZS5zaG91bGRDb3B5VmFsdWVzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0cnVlO1xufTtcblxuUHJvbWlzZUFycmF5LnByb3RvdHlwZS5nZXRBY3R1YWxMZW5ndGggPSBmdW5jdGlvbiAobGVuKSB7XG4gICAgcmV0dXJuIGxlbjtcbn07XG5cbnJldHVybiBQcm9taXNlQXJyYXk7XG59O1xuXG59LHtcIi4vdXRpbC5qc1wiOjM4fV0sMjU6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgbWF5YmVXcmFwQXNFcnJvciA9IHV0aWwubWF5YmVXcmFwQXNFcnJvcjtcbnZhciBlcnJvcnMgPSBfZGVyZXFfKFwiLi9lcnJvcnMuanNcIik7XG52YXIgVGltZW91dEVycm9yID0gZXJyb3JzLlRpbWVvdXRFcnJvcjtcbnZhciBPcGVyYXRpb25hbEVycm9yID0gZXJyb3JzLk9wZXJhdGlvbmFsRXJyb3I7XG52YXIgaGF2ZUdldHRlcnMgPSB1dGlsLmhhdmVHZXR0ZXJzO1xudmFyIGVzNSA9IF9kZXJlcV8oXCIuL2VzNS5qc1wiKTtcblxuZnVuY3Rpb24gaXNVbnR5cGVkRXJyb3Iob2JqKSB7XG4gICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEVycm9yICYmXG4gICAgICAgIGVzNS5nZXRQcm90b3R5cGVPZihvYmopID09PSBFcnJvci5wcm90b3R5cGU7XG59XG5cbnZhciByRXJyb3JLZXkgPSAvXig/Om5hbWV8bWVzc2FnZXxzdGFja3xjYXVzZSkkLztcbmZ1bmN0aW9uIHdyYXBBc09wZXJhdGlvbmFsRXJyb3Iob2JqKSB7XG4gICAgdmFyIHJldDtcbiAgICBpZiAoaXNVbnR5cGVkRXJyb3Iob2JqKSkge1xuICAgICAgICByZXQgPSBuZXcgT3BlcmF0aW9uYWxFcnJvcihvYmopO1xuICAgICAgICByZXQubmFtZSA9IG9iai5uYW1lO1xuICAgICAgICByZXQubWVzc2FnZSA9IG9iai5tZXNzYWdlO1xuICAgICAgICByZXQuc3RhY2sgPSBvYmouc3RhY2s7XG4gICAgICAgIHZhciBrZXlzID0gZXM1LmtleXMob2JqKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgICAgIGlmICghckVycm9yS2V5LnRlc3Qoa2V5KSkge1xuICAgICAgICAgICAgICAgIHJldFtrZXldID0gb2JqW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgdXRpbC5tYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24ob2JqKTtcbiAgICByZXR1cm4gb2JqO1xufVxuXG5mdW5jdGlvbiBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSkge1xuICAgIHJldHVybiBmdW5jdGlvbihlcnIsIHZhbHVlKSB7XG4gICAgICAgIGlmIChwcm9taXNlID09PSBudWxsKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdmFyIHdyYXBwZWQgPSB3cmFwQXNPcGVyYXRpb25hbEVycm9yKG1heWJlV3JhcEFzRXJyb3IoZXJyKSk7XG4gICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHdyYXBwZWQpO1xuICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0KHdyYXBwZWQpO1xuICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7XG4gICAgICAgICAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuIC0gMSk7IGZvcih2YXIgJF9pID0gMTsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2kgLSAxXSA9IGFyZ3VtZW50c1skX2ldO31cbiAgICAgICAgICAgIHByb21pc2UuX2Z1bGZpbGwoYXJncyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwcm9taXNlLl9mdWxmaWxsKHZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByb21pc2UgPSBudWxsO1xuICAgIH07XG59XG5cblxudmFyIFByb21pc2VSZXNvbHZlcjtcbmlmICghaGF2ZUdldHRlcnMpIHtcbiAgICBQcm9taXNlUmVzb2x2ZXIgPSBmdW5jdGlvbiAocHJvbWlzZSkge1xuICAgICAgICB0aGlzLnByb21pc2UgPSBwcm9taXNlO1xuICAgICAgICB0aGlzLmFzQ2FsbGJhY2sgPSBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSk7XG4gICAgICAgIHRoaXMuY2FsbGJhY2sgPSB0aGlzLmFzQ2FsbGJhY2s7XG4gICAgfTtcbn1cbmVsc2Uge1xuICAgIFByb21pc2VSZXNvbHZlciA9IGZ1bmN0aW9uIChwcm9taXNlKSB7XG4gICAgICAgIHRoaXMucHJvbWlzZSA9IHByb21pc2U7XG4gICAgfTtcbn1cbmlmIChoYXZlR2V0dGVycykge1xuICAgIHZhciBwcm9wID0ge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIG5vZGViYWNrRm9yUHJvbWlzZSh0aGlzLnByb21pc2UpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBlczUuZGVmaW5lUHJvcGVydHkoUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZSwgXCJhc0NhbGxiYWNrXCIsIHByb3ApO1xuICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLCBcImNhbGxiYWNrXCIsIHByb3ApO1xufVxuXG5Qcm9taXNlUmVzb2x2ZXIuX25vZGViYWNrRm9yUHJvbWlzZSA9IG5vZGViYWNrRm9yUHJvbWlzZTtcblxuUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gXCJbb2JqZWN0IFByb21pc2VSZXNvbHZlcl1cIjtcbn07XG5cblByb21pc2VSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZSA9XG5Qcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmZ1bGZpbGwgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUHJvbWlzZVJlc29sdmVyKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiSWxsZWdhbCBpbnZvY2F0aW9uLCByZXNvbHZlciByZXNvbHZlL3JlamVjdCBtdXN0IGJlIGNhbGxlZCB3aXRoaW4gYSByZXNvbHZlciBjb250ZXh0LiBDb25zaWRlciB1c2luZyB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciBpbnN0ZWFkLlxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsL3Nka1hMOVxcdTAwMGFcIik7XG4gICAgfVxuICAgIHRoaXMucHJvbWlzZS5fcmVzb2x2ZUNhbGxiYWNrKHZhbHVlKTtcbn07XG5cblByb21pc2VSZXNvbHZlci5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBQcm9taXNlUmVzb2x2ZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvc2RrWEw5XFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdGhpcy5wcm9taXNlLl9yZWplY3RDYWxsYmFjayhyZWFzb24pO1xufTtcblxuUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5wcm9ncmVzcyA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBQcm9taXNlUmVzb2x2ZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvc2RrWEw5XFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdGhpcy5wcm9taXNlLl9wcm9ncmVzcyh2YWx1ZSk7XG59O1xuXG5Qcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICB0aGlzLnByb21pc2UuY2FuY2VsKGVycik7XG59O1xuXG5Qcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLnRpbWVvdXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5yZWplY3QobmV3IFRpbWVvdXRFcnJvcihcInRpbWVvdXRcIikpO1xufTtcblxuUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5pc1Jlc29sdmVkID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLnByb21pc2UuaXNSZXNvbHZlZCgpO1xufTtcblxuUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvbWlzZS50b0pTT04oKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUHJvbWlzZVJlc29sdmVyO1xuXG59LHtcIi4vZXJyb3JzLmpzXCI6MTMsXCIuL2VzNS5qc1wiOjE0LFwiLi91dGlsLmpzXCI6Mzh9XSwyNjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHtcbnZhciBUSElTID0ge307XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgbm9kZWJhY2tGb3JQcm9taXNlID0gX2RlcmVxXyhcIi4vcHJvbWlzZV9yZXNvbHZlci5qc1wiKVxuICAgIC5fbm9kZWJhY2tGb3JQcm9taXNlO1xudmFyIHdpdGhBcHBlbmRlZCA9IHV0aWwud2l0aEFwcGVuZGVkO1xudmFyIG1heWJlV3JhcEFzRXJyb3IgPSB1dGlsLm1heWJlV3JhcEFzRXJyb3I7XG52YXIgY2FuRXZhbHVhdGUgPSB1dGlsLmNhbkV2YWx1YXRlO1xudmFyIFR5cGVFcnJvciA9IF9kZXJlcV8oXCIuL2Vycm9yc1wiKS5UeXBlRXJyb3I7XG52YXIgZGVmYXVsdFN1ZmZpeCA9IFwiQXN5bmNcIjtcbnZhciBkZWZhdWx0UHJvbWlzaWZpZWQgPSB7X19pc1Byb21pc2lmaWVkX186IHRydWV9O1xudmFyIG5vQ29weVByb3BzID0gW1xuICAgIFwiYXJpdHlcIiwgICAgXCJsZW5ndGhcIixcbiAgICBcIm5hbWVcIixcbiAgICBcImFyZ3VtZW50c1wiLFxuICAgIFwiY2FsbGVyXCIsXG4gICAgXCJjYWxsZWVcIixcbiAgICBcInByb3RvdHlwZVwiLFxuICAgIFwiX19pc1Byb21pc2lmaWVkX19cIlxuXTtcbnZhciBub0NvcHlQcm9wc1BhdHRlcm4gPSBuZXcgUmVnRXhwKFwiXig/OlwiICsgbm9Db3B5UHJvcHMuam9pbihcInxcIikgKyBcIikkXCIpO1xuXG52YXIgZGVmYXVsdEZpbHRlciA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICByZXR1cm4gdXRpbC5pc0lkZW50aWZpZXIobmFtZSkgJiZcbiAgICAgICAgbmFtZS5jaGFyQXQoMCkgIT09IFwiX1wiICYmXG4gICAgICAgIG5hbWUgIT09IFwiY29uc3RydWN0b3JcIjtcbn07XG5cbmZ1bmN0aW9uIHByb3BzRmlsdGVyKGtleSkge1xuICAgIHJldHVybiAhbm9Db3B5UHJvcHNQYXR0ZXJuLnRlc3Qoa2V5KTtcbn1cblxuZnVuY3Rpb24gaXNQcm9taXNpZmllZChmbikge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBmbi5fX2lzUHJvbWlzaWZpZWRfXyA9PT0gdHJ1ZTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaGFzUHJvbWlzaWZpZWQob2JqLCBrZXksIHN1ZmZpeCkge1xuICAgIHZhciB2YWwgPSB1dGlsLmdldERhdGFQcm9wZXJ0eU9yRGVmYXVsdChvYmosIGtleSArIHN1ZmZpeCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb21pc2lmaWVkKTtcbiAgICByZXR1cm4gdmFsID8gaXNQcm9taXNpZmllZCh2YWwpIDogZmFsc2U7XG59XG5mdW5jdGlvbiBjaGVja1ZhbGlkKHJldCwgc3VmZml4LCBzdWZmaXhSZWdleHApIHtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldC5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgICB2YXIga2V5ID0gcmV0W2ldO1xuICAgICAgICBpZiAoc3VmZml4UmVnZXhwLnRlc3Qoa2V5KSkge1xuICAgICAgICAgICAgdmFyIGtleVdpdGhvdXRBc3luY1N1ZmZpeCA9IGtleS5yZXBsYWNlKHN1ZmZpeFJlZ2V4cCwgXCJcIik7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJldC5sZW5ndGg7IGogKz0gMikge1xuICAgICAgICAgICAgICAgIGlmIChyZXRbal0gPT09IGtleVdpdGhvdXRBc3luY1N1ZmZpeCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2Fubm90IHByb21pc2lmeSBhbiBBUEkgdGhhdCBoYXMgbm9ybWFsIG1ldGhvZHMgd2l0aCAnJXMnLXN1ZmZpeFxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsL2lXclpid1xcdTAwMGFcIlxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoXCIlc1wiLCBzdWZmaXgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIHByb21pc2lmaWFibGVNZXRob2RzKG9iaiwgc3VmZml4LCBzdWZmaXhSZWdleHAsIGZpbHRlcikge1xuICAgIHZhciBrZXlzID0gdXRpbC5pbmhlcml0ZWREYXRhS2V5cyhvYmopO1xuICAgIHZhciByZXQgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07XG4gICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldO1xuICAgICAgICB2YXIgcGFzc2VzRGVmYXVsdEZpbHRlciA9IGZpbHRlciA9PT0gZGVmYXVsdEZpbHRlclxuICAgICAgICAgICAgPyB0cnVlIDogZGVmYXVsdEZpbHRlcihrZXksIHZhbHVlLCBvYmopO1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcImZ1bmN0aW9uXCIgJiZcbiAgICAgICAgICAgICFpc1Byb21pc2lmaWVkKHZhbHVlKSAmJlxuICAgICAgICAgICAgIWhhc1Byb21pc2lmaWVkKG9iaiwga2V5LCBzdWZmaXgpICYmXG4gICAgICAgICAgICBmaWx0ZXIoa2V5LCB2YWx1ZSwgb2JqLCBwYXNzZXNEZWZhdWx0RmlsdGVyKSkge1xuICAgICAgICAgICAgcmV0LnB1c2goa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2hlY2tWYWxpZChyZXQsIHN1ZmZpeCwgc3VmZml4UmVnZXhwKTtcbiAgICByZXR1cm4gcmV0O1xufVxuXG52YXIgZXNjYXBlSWRlbnRSZWdleCA9IGZ1bmN0aW9uKHN0cikge1xuICAgIHJldHVybiBzdHIucmVwbGFjZSgvKFskXSkvLCBcIlxcXFwkXCIpO1xufTtcblxudmFyIG1ha2VOb2RlUHJvbWlzaWZpZWRFdmFsO1xuaWYgKCF0cnVlKSB7XG52YXIgc3dpdGNoQ2FzZUFyZ3VtZW50T3JkZXIgPSBmdW5jdGlvbihsaWtlbHlBcmd1bWVudENvdW50KSB7XG4gICAgdmFyIHJldCA9IFtsaWtlbHlBcmd1bWVudENvdW50XTtcbiAgICB2YXIgbWluID0gTWF0aC5tYXgoMCwgbGlrZWx5QXJndW1lbnRDb3VudCAtIDEgLSAzKTtcbiAgICBmb3IodmFyIGkgPSBsaWtlbHlBcmd1bWVudENvdW50IC0gMTsgaSA+PSBtaW47IC0taSkge1xuICAgICAgICByZXQucHVzaChpKTtcbiAgICB9XG4gICAgZm9yKHZhciBpID0gbGlrZWx5QXJndW1lbnRDb3VudCArIDE7IGkgPD0gMzsgKytpKSB7XG4gICAgICAgIHJldC5wdXNoKGkpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcblxudmFyIGFyZ3VtZW50U2VxdWVuY2UgPSBmdW5jdGlvbihhcmd1bWVudENvdW50KSB7XG4gICAgcmV0dXJuIHV0aWwuZmlsbGVkUmFuZ2UoYXJndW1lbnRDb3VudCwgXCJfYXJnXCIsIFwiXCIpO1xufTtcblxudmFyIHBhcmFtZXRlckRlY2xhcmF0aW9uID0gZnVuY3Rpb24ocGFyYW1ldGVyQ291bnQpIHtcbiAgICByZXR1cm4gdXRpbC5maWxsZWRSYW5nZShcbiAgICAgICAgTWF0aC5tYXgocGFyYW1ldGVyQ291bnQsIDMpLCBcIl9hcmdcIiwgXCJcIik7XG59O1xuXG52YXIgcGFyYW1ldGVyQ291bnQgPSBmdW5jdGlvbihmbikge1xuICAgIGlmICh0eXBlb2YgZm4ubGVuZ3RoID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgIHJldHVybiBNYXRoLm1heChNYXRoLm1pbihmbi5sZW5ndGgsIDEwMjMgKyAxKSwgMCk7XG4gICAgfVxuICAgIHJldHVybiAwO1xufTtcblxubWFrZU5vZGVQcm9taXNpZmllZEV2YWwgPVxuZnVuY3Rpb24oY2FsbGJhY2ssIHJlY2VpdmVyLCBvcmlnaW5hbE5hbWUsIGZuKSB7XG4gICAgdmFyIG5ld1BhcmFtZXRlckNvdW50ID0gTWF0aC5tYXgoMCwgcGFyYW1ldGVyQ291bnQoZm4pIC0gMSk7XG4gICAgdmFyIGFyZ3VtZW50T3JkZXIgPSBzd2l0Y2hDYXNlQXJndW1lbnRPcmRlcihuZXdQYXJhbWV0ZXJDb3VudCk7XG4gICAgdmFyIHNob3VsZFByb3h5VGhpcyA9IHR5cGVvZiBjYWxsYmFjayA9PT0gXCJzdHJpbmdcIiB8fCByZWNlaXZlciA9PT0gVEhJUztcblxuICAgIGZ1bmN0aW9uIGdlbmVyYXRlQ2FsbEZvckFyZ3VtZW50Q291bnQoY291bnQpIHtcbiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudFNlcXVlbmNlKGNvdW50KS5qb2luKFwiLCBcIik7XG4gICAgICAgIHZhciBjb21tYSA9IGNvdW50ID4gMCA/IFwiLCBcIiA6IFwiXCI7XG4gICAgICAgIHZhciByZXQ7XG4gICAgICAgIGlmIChzaG91bGRQcm94eVRoaXMpIHtcbiAgICAgICAgICAgIHJldCA9IFwicmV0ID0gY2FsbGJhY2suY2FsbCh0aGlzLCB7e2FyZ3N9fSwgbm9kZWJhY2spOyBicmVhaztcXG5cIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IHJlY2VpdmVyID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA/IFwicmV0ID0gY2FsbGJhY2soe3thcmdzfX0sIG5vZGViYWNrKTsgYnJlYWs7XFxuXCJcbiAgICAgICAgICAgICAgICA6IFwicmV0ID0gY2FsbGJhY2suY2FsbChyZWNlaXZlciwge3thcmdzfX0sIG5vZGViYWNrKTsgYnJlYWs7XFxuXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldC5yZXBsYWNlKFwie3thcmdzfX1cIiwgYXJncykucmVwbGFjZShcIiwgXCIsIGNvbW1hKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpIHtcbiAgICAgICAgdmFyIHJldCA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRPcmRlci5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgcmV0ICs9IFwiY2FzZSBcIiArIGFyZ3VtZW50T3JkZXJbaV0gK1wiOlwiICtcbiAgICAgICAgICAgICAgICBnZW5lcmF0ZUNhbGxGb3JBcmd1bWVudENvdW50KGFyZ3VtZW50T3JkZXJbaV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0ICs9IFwiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIGRlZmF1bHQ6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShsZW4gKyAxKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgaSA9IDA7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICAgICBhcmdzW2ldID0gYXJndW1lbnRzW2ldOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBhcmdzW2ldID0gbm9kZWJhY2s7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBbQ29kZUZvckNhbGxdICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBicmVhazsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIFwiLnJlcGxhY2UoXCJbQ29kZUZvckNhbGxdXCIsIChzaG91bGRQcm94eVRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBcInJldCA9IGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpO1xcblwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogXCJyZXQgPSBjYWxsYmFjay5hcHBseShyZWNlaXZlciwgYXJncyk7XFxuXCIpKTtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICB2YXIgZ2V0RnVuY3Rpb25Db2RlID0gdHlwZW9mIGNhbGxiYWNrID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKFwidGhpcyAhPSBudWxsID8gdGhpc1snXCIrY2FsbGJhY2srXCInXSA6IGZuXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogXCJmblwiO1xuXG4gICAgcmV0dXJuIG5ldyBGdW5jdGlvbihcIlByb21pc2VcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZm5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwicmVjZWl2ZXJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwid2l0aEFwcGVuZGVkXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm1heWJlV3JhcEFzRXJyb3JcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibm9kZWJhY2tGb3JQcm9taXNlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcInRyeUNhdGNoXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImVycm9yT2JqXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm5vdEVudW1lcmFibGVQcm9wXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIklOVEVSTkFMXCIsXCIndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIHZhciByZXQgPSBmdW5jdGlvbiAoUGFyYW1ldGVycykgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBwcm9taXNlLl9jYXB0dXJlU3RhY2tUcmFjZSgpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgbm9kZWJhY2sgPSBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSk7ICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgcmV0OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB0cnlDYXRjaChbR2V0RnVuY3Rpb25Db2RlXSk7ICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBzd2l0Y2gobGVuKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICAgICAgW0NvZGVGb3JTd2l0Y2hDYXNlXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2sobWF5YmVXcmFwQXNFcnJvcihyZXQuZSksIHRydWUsIHRydWUpO1xcblxcXG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIH07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIG5vdEVudW1lcmFibGVQcm9wKHJldCwgJ19faXNQcm9taXNpZmllZF9fJywgdHJ1ZSk7ICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIHJldHVybiByZXQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxcblxcXG4gICAgICAgIFwiXG4gICAgICAgIC5yZXBsYWNlKFwiUGFyYW1ldGVyc1wiLCBwYXJhbWV0ZXJEZWNsYXJhdGlvbihuZXdQYXJhbWV0ZXJDb3VudCkpXG4gICAgICAgIC5yZXBsYWNlKFwiW0NvZGVGb3JTd2l0Y2hDYXNlXVwiLCBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpKVxuICAgICAgICAucmVwbGFjZShcIltHZXRGdW5jdGlvbkNvZGVdXCIsIGdldEZ1bmN0aW9uQ29kZSkpKFxuICAgICAgICAgICAgUHJvbWlzZSxcbiAgICAgICAgICAgIGZuLFxuICAgICAgICAgICAgcmVjZWl2ZXIsXG4gICAgICAgICAgICB3aXRoQXBwZW5kZWQsXG4gICAgICAgICAgICBtYXliZVdyYXBBc0Vycm9yLFxuICAgICAgICAgICAgbm9kZWJhY2tGb3JQcm9taXNlLFxuICAgICAgICAgICAgdXRpbC50cnlDYXRjaCxcbiAgICAgICAgICAgIHV0aWwuZXJyb3JPYmosXG4gICAgICAgICAgICB1dGlsLm5vdEVudW1lcmFibGVQcm9wLFxuICAgICAgICAgICAgSU5URVJOQUxcbiAgICAgICAgKTtcbn07XG59XG5cbmZ1bmN0aW9uIG1ha2VOb2RlUHJvbWlzaWZpZWRDbG9zdXJlKGNhbGxiYWNrLCByZWNlaXZlciwgXywgZm4pIHtcbiAgICB2YXIgZGVmYXVsdFRoaXMgPSAoZnVuY3Rpb24oKSB7cmV0dXJuIHRoaXM7fSkoKTtcbiAgICB2YXIgbWV0aG9kID0gY2FsbGJhY2s7XG4gICAgaWYgKHR5cGVvZiBtZXRob2QgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBmbjtcbiAgICB9XG4gICAgZnVuY3Rpb24gcHJvbWlzaWZpZWQoKSB7XG4gICAgICAgIHZhciBfcmVjZWl2ZXIgPSByZWNlaXZlcjtcbiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBUSElTKSBfcmVjZWl2ZXIgPSB0aGlzO1xuICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTtcbiAgICAgICAgcHJvbWlzZS5fY2FwdHVyZVN0YWNrVHJhY2UoKTtcbiAgICAgICAgdmFyIGNiID0gdHlwZW9mIG1ldGhvZCA9PT0gXCJzdHJpbmdcIiAmJiB0aGlzICE9PSBkZWZhdWx0VGhpc1xuICAgICAgICAgICAgPyB0aGlzW21ldGhvZF0gOiBjYWxsYmFjaztcbiAgICAgICAgdmFyIGZuID0gbm9kZWJhY2tGb3JQcm9taXNlKHByb21pc2UpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY2IuYXBwbHkoX3JlY2VpdmVyLCB3aXRoQXBwZW5kZWQoYXJndW1lbnRzLCBmbikpO1xuICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgIHByb21pc2UuX3JlamVjdENhbGxiYWNrKG1heWJlV3JhcEFzRXJyb3IoZSksIHRydWUsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cbiAgICB1dGlsLm5vdEVudW1lcmFibGVQcm9wKHByb21pc2lmaWVkLCBcIl9faXNQcm9taXNpZmllZF9fXCIsIHRydWUpO1xuICAgIHJldHVybiBwcm9taXNpZmllZDtcbn1cblxudmFyIG1ha2VOb2RlUHJvbWlzaWZpZWQgPSBjYW5FdmFsdWF0ZVxuICAgID8gbWFrZU5vZGVQcm9taXNpZmllZEV2YWxcbiAgICA6IG1ha2VOb2RlUHJvbWlzaWZpZWRDbG9zdXJlO1xuXG5mdW5jdGlvbiBwcm9taXNpZnlBbGwob2JqLCBzdWZmaXgsIGZpbHRlciwgcHJvbWlzaWZpZXIpIHtcbiAgICB2YXIgc3VmZml4UmVnZXhwID0gbmV3IFJlZ0V4cChlc2NhcGVJZGVudFJlZ2V4KHN1ZmZpeCkgKyBcIiRcIik7XG4gICAgdmFyIG1ldGhvZHMgPVxuICAgICAgICBwcm9taXNpZmlhYmxlTWV0aG9kcyhvYmosIHN1ZmZpeCwgc3VmZml4UmVnZXhwLCBmaWx0ZXIpO1xuXG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0gMikge1xuICAgICAgICB2YXIga2V5ID0gbWV0aG9kc1tpXTtcbiAgICAgICAgdmFyIGZuID0gbWV0aG9kc1tpKzFdO1xuICAgICAgICB2YXIgcHJvbWlzaWZpZWRLZXkgPSBrZXkgKyBzdWZmaXg7XG4gICAgICAgIG9ialtwcm9taXNpZmllZEtleV0gPSBwcm9taXNpZmllciA9PT0gbWFrZU5vZGVQcm9taXNpZmllZFxuICAgICAgICAgICAgICAgID8gbWFrZU5vZGVQcm9taXNpZmllZChrZXksIFRISVMsIGtleSwgZm4sIHN1ZmZpeClcbiAgICAgICAgICAgICAgICA6IHByb21pc2lmaWVyKGZuLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VOb2RlUHJvbWlzaWZpZWQoa2V5LCBUSElTLCBrZXksIGZuLCBzdWZmaXgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICB1dGlsLnRvRmFzdFByb3BlcnRpZXMob2JqKTtcbiAgICByZXR1cm4gb2JqO1xufVxuXG5mdW5jdGlvbiBwcm9taXNpZnkoY2FsbGJhY2ssIHJlY2VpdmVyKSB7XG4gICAgcmV0dXJuIG1ha2VOb2RlUHJvbWlzaWZpZWQoY2FsbGJhY2ssIHJlY2VpdmVyLCB1bmRlZmluZWQsIGNhbGxiYWNrKTtcbn1cblxuUHJvbWlzZS5wcm9taXNpZnkgPSBmdW5jdGlvbiAoZm4sIHJlY2VpdmVyKSB7XG4gICAgaWYgKHR5cGVvZiBmbiAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJmbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85MTZsSkpcXHUwMDBhXCIpO1xuICAgIH1cbiAgICBpZiAoaXNQcm9taXNpZmllZChmbikpIHtcbiAgICAgICAgcmV0dXJuIGZuO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gcHJvbWlzaWZ5KGZuLCBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IFRISVMgOiByZWNlaXZlcik7XG4gICAgdXRpbC5jb3B5RGVzY3JpcHRvcnMoZm4sIHJldCwgcHJvcHNGaWx0ZXIpO1xuICAgIHJldHVybiByZXQ7XG59O1xuXG5Qcm9taXNlLnByb21pc2lmeUFsbCA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbnMpIHtcbiAgICBpZiAodHlwZW9mIHRhcmdldCAhPT0gXCJmdW5jdGlvblwiICYmIHR5cGVvZiB0YXJnZXQgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcInRoZSB0YXJnZXQgb2YgcHJvbWlzaWZ5QWxsIG11c3QgYmUgYW4gb2JqZWN0IG9yIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85SVRsVjBcXHUwMDBhXCIpO1xuICAgIH1cbiAgICBvcHRpb25zID0gT2JqZWN0KG9wdGlvbnMpO1xuICAgIHZhciBzdWZmaXggPSBvcHRpb25zLnN1ZmZpeDtcbiAgICBpZiAodHlwZW9mIHN1ZmZpeCAhPT0gXCJzdHJpbmdcIikgc3VmZml4ID0gZGVmYXVsdFN1ZmZpeDtcbiAgICB2YXIgZmlsdGVyID0gb3B0aW9ucy5maWx0ZXI7XG4gICAgaWYgKHR5cGVvZiBmaWx0ZXIgIT09IFwiZnVuY3Rpb25cIikgZmlsdGVyID0gZGVmYXVsdEZpbHRlcjtcbiAgICB2YXIgcHJvbWlzaWZpZXIgPSBvcHRpb25zLnByb21pc2lmaWVyO1xuICAgIGlmICh0eXBlb2YgcHJvbWlzaWZpZXIgIT09IFwiZnVuY3Rpb25cIikgcHJvbWlzaWZpZXIgPSBtYWtlTm9kZVByb21pc2lmaWVkO1xuXG4gICAgaWYgKCF1dGlsLmlzSWRlbnRpZmllcihzdWZmaXgpKSB7XG4gICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKFwic3VmZml4IG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvOEZabzVWXFx1MDAwYVwiKTtcbiAgICB9XG5cbiAgICB2YXIga2V5cyA9IHV0aWwuaW5oZXJpdGVkRGF0YUtleXModGFyZ2V0KTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gdGFyZ2V0W2tleXNbaV1dO1xuICAgICAgICBpZiAoa2V5c1tpXSAhPT0gXCJjb25zdHJ1Y3RvclwiICYmXG4gICAgICAgICAgICB1dGlsLmlzQ2xhc3ModmFsdWUpKSB7XG4gICAgICAgICAgICBwcm9taXNpZnlBbGwodmFsdWUucHJvdG90eXBlLCBzdWZmaXgsIGZpbHRlciwgcHJvbWlzaWZpZXIpO1xuICAgICAgICAgICAgcHJvbWlzaWZ5QWxsKHZhbHVlLCBzdWZmaXgsIGZpbHRlciwgcHJvbWlzaWZpZXIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb21pc2lmeUFsbCh0YXJnZXQsIHN1ZmZpeCwgZmlsdGVyLCBwcm9taXNpZmllcik7XG59O1xufTtcblxuXG59LHtcIi4vZXJyb3JzXCI6MTMsXCIuL3Byb21pc2VfcmVzb2x2ZXIuanNcIjoyNSxcIi4vdXRpbC5qc1wiOjM4fV0sMjc6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFxuICAgIFByb21pc2UsIFByb21pc2VBcnJheSwgdHJ5Q29udmVydFRvUHJvbWlzZSwgYXBpUmVqZWN0aW9uKSB7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0O1xudmFyIGVzNSA9IF9kZXJlcV8oXCIuL2VzNS5qc1wiKTtcblxuZnVuY3Rpb24gUHJvcGVydGllc1Byb21pc2VBcnJheShvYmopIHtcbiAgICB2YXIga2V5cyA9IGVzNS5rZXlzKG9iaik7XG4gICAgdmFyIGxlbiA9IGtleXMubGVuZ3RoO1xuICAgIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuICogMik7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkge1xuICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgdmFsdWVzW2ldID0gb2JqW2tleV07XG4gICAgICAgIHZhbHVlc1tpICsgbGVuXSA9IGtleTtcbiAgICB9XG4gICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTtcbn1cbnV0aWwuaW5oZXJpdHMoUHJvcGVydGllc1Byb21pc2VBcnJheSwgUHJvbWlzZUFycmF5KTtcblxuUHJvcGVydGllc1Byb21pc2VBcnJheS5wcm90b3R5cGUuX2luaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5faW5pdCQodW5kZWZpbmVkLCAtMykgO1xufTtcblxuUHJvcGVydGllc1Byb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VGdWxmaWxsZWQgPSBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7XG4gICAgdGhpcy5fdmFsdWVzW2luZGV4XSA9IHZhbHVlO1xuICAgIHZhciB0b3RhbFJlc29sdmVkID0gKyt0aGlzLl90b3RhbFJlc29sdmVkO1xuICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkge1xuICAgICAgICB2YXIgdmFsID0ge307XG4gICAgICAgIHZhciBrZXlPZmZzZXQgPSB0aGlzLmxlbmd0aCgpO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGgoKTsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgICAgICB2YWxbdGhpcy5fdmFsdWVzW2kgKyBrZXlPZmZzZXRdXSA9IHRoaXMuX3ZhbHVlc1tpXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZXNvbHZlKHZhbCk7XG4gICAgfVxufTtcblxuUHJvcGVydGllc1Byb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VQcm9ncmVzc2VkID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkge1xuICAgIHRoaXMuX3Byb21pc2UuX3Byb2dyZXNzKHtcbiAgICAgICAga2V5OiB0aGlzLl92YWx1ZXNbaW5kZXggKyB0aGlzLmxlbmd0aCgpXSxcbiAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgfSk7XG59O1xuXG5Qcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5zaG91bGRDb3B5VmFsdWVzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBmYWxzZTtcbn07XG5cblByb3BlcnRpZXNQcm9taXNlQXJyYXkucHJvdG90eXBlLmdldEFjdHVhbExlbmd0aCA9IGZ1bmN0aW9uIChsZW4pIHtcbiAgICByZXR1cm4gbGVuID4+IDE7XG59O1xuXG5mdW5jdGlvbiBwcm9wcyhwcm9taXNlcykge1xuICAgIHZhciByZXQ7XG4gICAgdmFyIGNhc3RWYWx1ZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UocHJvbWlzZXMpO1xuXG4gICAgaWYgKCFpc09iamVjdChjYXN0VmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oXCJjYW5ub3QgYXdhaXQgcHJvcGVydGllcyBvZiBhIG5vbi1vYmplY3RcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9Pc0ZLQzhcXHUwMDBhXCIpO1xuICAgIH0gZWxzZSBpZiAoY2FzdFZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICByZXQgPSBjYXN0VmFsdWUuX3RoZW4oXG4gICAgICAgICAgICBQcm9taXNlLnByb3BzLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldCA9IG5ldyBQcm9wZXJ0aWVzUHJvbWlzZUFycmF5KGNhc3RWYWx1ZSkucHJvbWlzZSgpO1xuICAgIH1cblxuICAgIGlmIChjYXN0VmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgIHJldC5fcHJvcGFnYXRlRnJvbShjYXN0VmFsdWUsIDQpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuXG5Qcm9taXNlLnByb3RvdHlwZS5wcm9wcyA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gcHJvcHModGhpcyk7XG59O1xuXG5Qcm9taXNlLnByb3BzID0gZnVuY3Rpb24gKHByb21pc2VzKSB7XG4gICAgcmV0dXJuIHByb3BzKHByb21pc2VzKTtcbn07XG59O1xuXG59LHtcIi4vZXM1LmpzXCI6MTQsXCIuL3V0aWwuanNcIjozOH1dLDI4OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xuZnVuY3Rpb24gYXJyYXlNb3ZlKHNyYywgc3JjSW5kZXgsIGRzdCwgZHN0SW5kZXgsIGxlbikge1xuICAgIGZvciAodmFyIGogPSAwOyBqIDwgbGVuOyArK2opIHtcbiAgICAgICAgZHN0W2ogKyBkc3RJbmRleF0gPSBzcmNbaiArIHNyY0luZGV4XTtcbiAgICAgICAgc3JjW2ogKyBzcmNJbmRleF0gPSB2b2lkIDA7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBRdWV1ZShjYXBhY2l0eSkge1xuICAgIHRoaXMuX2NhcGFjaXR5ID0gY2FwYWNpdHk7XG4gICAgdGhpcy5fbGVuZ3RoID0gMDtcbiAgICB0aGlzLl9mcm9udCA9IDA7XG59XG5cblF1ZXVlLnByb3RvdHlwZS5fd2lsbEJlT3ZlckNhcGFjaXR5ID0gZnVuY3Rpb24gKHNpemUpIHtcbiAgICByZXR1cm4gdGhpcy5fY2FwYWNpdHkgPCBzaXplO1xufTtcblxuUXVldWUucHJvdG90eXBlLl9wdXNoT25lID0gZnVuY3Rpb24gKGFyZykge1xuICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpO1xuICAgIHRoaXMuX2NoZWNrQ2FwYWNpdHkobGVuZ3RoICsgMSk7XG4gICAgdmFyIGkgPSAodGhpcy5fZnJvbnQgKyBsZW5ndGgpICYgKHRoaXMuX2NhcGFjaXR5IC0gMSk7XG4gICAgdGhpc1tpXSA9IGFyZztcbiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGggKyAxO1xufTtcblxuUXVldWUucHJvdG90eXBlLl91bnNoaWZ0T25lID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgY2FwYWNpdHkgPSB0aGlzLl9jYXBhY2l0eTtcbiAgICB0aGlzLl9jaGVja0NhcGFjaXR5KHRoaXMubGVuZ3RoKCkgKyAxKTtcbiAgICB2YXIgZnJvbnQgPSB0aGlzLl9mcm9udDtcbiAgICB2YXIgaSA9ICgoKCggZnJvbnQgLSAxICkgJlxuICAgICAgICAgICAgICAgICAgICAoIGNhcGFjaXR5IC0gMSkgKSBeIGNhcGFjaXR5ICkgLSBjYXBhY2l0eSApO1xuICAgIHRoaXNbaV0gPSB2YWx1ZTtcbiAgICB0aGlzLl9mcm9udCA9IGk7XG4gICAgdGhpcy5fbGVuZ3RoID0gdGhpcy5sZW5ndGgoKSArIDE7XG59O1xuXG5RdWV1ZS5wcm90b3R5cGUudW5zaGlmdCA9IGZ1bmN0aW9uKGZuLCByZWNlaXZlciwgYXJnKSB7XG4gICAgdGhpcy5fdW5zaGlmdE9uZShhcmcpO1xuICAgIHRoaXMuX3Vuc2hpZnRPbmUocmVjZWl2ZXIpO1xuICAgIHRoaXMuX3Vuc2hpZnRPbmUoZm4pO1xufTtcblxuUXVldWUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiAoZm4sIHJlY2VpdmVyLCBhcmcpIHtcbiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKSArIDM7XG4gICAgaWYgKHRoaXMuX3dpbGxCZU92ZXJDYXBhY2l0eShsZW5ndGgpKSB7XG4gICAgICAgIHRoaXMuX3B1c2hPbmUoZm4pO1xuICAgICAgICB0aGlzLl9wdXNoT25lKHJlY2VpdmVyKTtcbiAgICAgICAgdGhpcy5fcHVzaE9uZShhcmcpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBqID0gdGhpcy5fZnJvbnQgKyBsZW5ndGggLSAzO1xuICAgIHRoaXMuX2NoZWNrQ2FwYWNpdHkobGVuZ3RoKTtcbiAgICB2YXIgd3JhcE1hc2sgPSB0aGlzLl9jYXBhY2l0eSAtIDE7XG4gICAgdGhpc1soaiArIDApICYgd3JhcE1hc2tdID0gZm47XG4gICAgdGhpc1soaiArIDEpICYgd3JhcE1hc2tdID0gcmVjZWl2ZXI7XG4gICAgdGhpc1soaiArIDIpICYgd3JhcE1hc2tdID0gYXJnO1xuICAgIHRoaXMuX2xlbmd0aCA9IGxlbmd0aDtcbn07XG5cblF1ZXVlLnByb3RvdHlwZS5zaGlmdCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZnJvbnQgPSB0aGlzLl9mcm9udCxcbiAgICAgICAgcmV0ID0gdGhpc1tmcm9udF07XG5cbiAgICB0aGlzW2Zyb250XSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl9mcm9udCA9IChmcm9udCArIDEpICYgKHRoaXMuX2NhcGFjaXR5IC0gMSk7XG4gICAgdGhpcy5fbGVuZ3RoLS07XG4gICAgcmV0dXJuIHJldDtcbn07XG5cblF1ZXVlLnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xlbmd0aDtcbn07XG5cblF1ZXVlLnByb3RvdHlwZS5fY2hlY2tDYXBhY2l0eSA9IGZ1bmN0aW9uIChzaXplKSB7XG4gICAgaWYgKHRoaXMuX2NhcGFjaXR5IDwgc2l6ZSkge1xuICAgICAgICB0aGlzLl9yZXNpemVUbyh0aGlzLl9jYXBhY2l0eSA8PCAxKTtcbiAgICB9XG59O1xuXG5RdWV1ZS5wcm90b3R5cGUuX3Jlc2l6ZVRvID0gZnVuY3Rpb24gKGNhcGFjaXR5KSB7XG4gICAgdmFyIG9sZENhcGFjaXR5ID0gdGhpcy5fY2FwYWNpdHk7XG4gICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eTtcbiAgICB2YXIgZnJvbnQgPSB0aGlzLl9mcm9udDtcbiAgICB2YXIgbGVuZ3RoID0gdGhpcy5fbGVuZ3RoO1xuICAgIHZhciBtb3ZlSXRlbXNDb3VudCA9IChmcm9udCArIGxlbmd0aCkgJiAob2xkQ2FwYWNpdHkgLSAxKTtcbiAgICBhcnJheU1vdmUodGhpcywgMCwgdGhpcywgb2xkQ2FwYWNpdHksIG1vdmVJdGVtc0NvdW50KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUXVldWU7XG5cbn0se31dLDI5OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihcbiAgICBQcm9taXNlLCBJTlRFUk5BTCwgdHJ5Q29udmVydFRvUHJvbWlzZSwgYXBpUmVqZWN0aW9uKSB7XG52YXIgaXNBcnJheSA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIikuaXNBcnJheTtcblxudmFyIHJhY2VMYXRlciA9IGZ1bmN0aW9uIChwcm9taXNlKSB7XG4gICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihhcnJheSkge1xuICAgICAgICByZXR1cm4gcmFjZShhcnJheSwgcHJvbWlzZSk7XG4gICAgfSk7XG59O1xuXG5mdW5jdGlvbiByYWNlKHByb21pc2VzLCBwYXJlbnQpIHtcbiAgICB2YXIgbWF5YmVQcm9taXNlID0gdHJ5Q29udmVydFRvUHJvbWlzZShwcm9taXNlcyk7XG5cbiAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICByZXR1cm4gcmFjZUxhdGVyKG1heWJlUHJvbWlzZSk7XG4gICAgfSBlbHNlIGlmICghaXNBcnJheShwcm9taXNlcykpIHtcbiAgICAgICAgcmV0dXJuIGFwaVJlamVjdGlvbihcImV4cGVjdGluZyBhbiBhcnJheSwgYSBwcm9taXNlIG9yIGEgdGhlbmFibGVcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9zOE1NaGNcXHUwMDBhXCIpO1xuICAgIH1cblxuICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgaWYgKHBhcmVudCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldC5fcHJvcGFnYXRlRnJvbShwYXJlbnQsIDQgfCAxKTtcbiAgICB9XG4gICAgdmFyIGZ1bGZpbGwgPSByZXQuX2Z1bGZpbGw7XG4gICAgdmFyIHJlamVjdCA9IHJldC5fcmVqZWN0O1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBwcm9taXNlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkge1xuICAgICAgICB2YXIgdmFsID0gcHJvbWlzZXNbaV07XG5cbiAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkICYmICEoaSBpbiBwcm9taXNlcykpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgUHJvbWlzZS5jYXN0KHZhbCkuX3RoZW4oZnVsZmlsbCwgcmVqZWN0LCB1bmRlZmluZWQsIHJldCwgbnVsbCk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5cblByb21pc2UucmFjZSA9IGZ1bmN0aW9uIChwcm9taXNlcykge1xuICAgIHJldHVybiByYWNlKHByb21pc2VzLCB1bmRlZmluZWQpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUucmFjZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gcmFjZSh0aGlzLCB1bmRlZmluZWQpO1xufTtcblxufTtcblxufSx7XCIuL3V0aWwuanNcIjozOH1dLDMwOltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9taXNlQXJyYXksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGFwaVJlamVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q29udmVydFRvUHJvbWlzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgSU5URVJOQUwpIHtcbnZhciBnZXREb21haW4gPSBQcm9taXNlLl9nZXREb21haW47XG52YXIgYXN5bmMgPSBfZGVyZXFfKFwiLi9hc3luYy5qc1wiKTtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciB0cnlDYXRjaCA9IHV0aWwudHJ5Q2F0Y2g7XG52YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqO1xuZnVuY3Rpb24gUmVkdWN0aW9uUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgYWNjdW0sIF9lYWNoKSB7XG4gICAgdGhpcy5jb25zdHJ1Y3RvciQocHJvbWlzZXMpO1xuICAgIHRoaXMuX3Byb21pc2UuX2NhcHR1cmVTdGFja1RyYWNlKCk7XG4gICAgdGhpcy5fcHJlc2VydmVkVmFsdWVzID0gX2VhY2ggPT09IElOVEVSTkFMID8gW10gOiBudWxsO1xuICAgIHRoaXMuX3plcm90aElzQWNjdW0gPSAoYWNjdW0gPT09IHVuZGVmaW5lZCk7XG4gICAgdGhpcy5fZ290QWNjdW0gPSBmYWxzZTtcbiAgICB0aGlzLl9yZWR1Y2luZ0luZGV4ID0gKHRoaXMuX3plcm90aElzQWNjdW0gPyAxIDogMCk7XG4gICAgdGhpcy5fdmFsdWVzUGhhc2UgPSB1bmRlZmluZWQ7XG4gICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UoYWNjdW0sIHRoaXMuX3Byb21pc2UpO1xuICAgIHZhciByZWplY3RlZCA9IGZhbHNlO1xuICAgIHZhciBpc1Byb21pc2UgPSBtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlO1xuICAgIGlmIChpc1Byb21pc2UpIHtcbiAgICAgICAgbWF5YmVQcm9taXNlID0gbWF5YmVQcm9taXNlLl90YXJnZXQoKTtcbiAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5faXNQZW5kaW5nKCkpIHtcbiAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fcHJveHlQcm9taXNlQXJyYXkodGhpcywgLTEpO1xuICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5faXNGdWxmaWxsZWQoKSkge1xuICAgICAgICAgICAgYWNjdW0gPSBtYXliZVByb21pc2UuX3ZhbHVlKCk7XG4gICAgICAgICAgICB0aGlzLl9nb3RBY2N1bSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9yZWplY3QobWF5YmVQcm9taXNlLl9yZWFzb24oKSk7XG4gICAgICAgICAgICByZWplY3RlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCEoaXNQcm9taXNlIHx8IHRoaXMuX3plcm90aElzQWNjdW0pKSB0aGlzLl9nb3RBY2N1bSA9IHRydWU7XG4gICAgdmFyIGRvbWFpbiA9IGdldERvbWFpbigpO1xuICAgIHRoaXMuX2NhbGxiYWNrID0gZG9tYWluID09PSBudWxsID8gZm4gOiBkb21haW4uYmluZChmbik7XG4gICAgdGhpcy5fYWNjdW0gPSBhY2N1bTtcbiAgICBpZiAoIXJlamVjdGVkKSBhc3luYy5pbnZva2UoaW5pdCwgdGhpcywgdW5kZWZpbmVkKTtcbn1cbmZ1bmN0aW9uIGluaXQoKSB7XG4gICAgdGhpcy5faW5pdCQodW5kZWZpbmVkLCAtNSk7XG59XG51dGlsLmluaGVyaXRzKFJlZHVjdGlvblByb21pc2VBcnJheSwgUHJvbWlzZUFycmF5KTtcblxuUmVkdWN0aW9uUHJvbWlzZUFycmF5LnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uICgpIHt9O1xuXG5SZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZXNvbHZlRW1wdHlBcnJheSA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5fZ290QWNjdW0gfHwgdGhpcy5femVyb3RoSXNBY2N1bSkge1xuICAgICAgICB0aGlzLl9yZXNvbHZlKHRoaXMuX3ByZXNlcnZlZFZhbHVlcyAhPT0gbnVsbFxuICAgICAgICAgICAgICAgICAgICAgICAgPyBbXSA6IHRoaXMuX2FjY3VtKTtcbiAgICB9XG59O1xuXG5SZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0gZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkge1xuICAgIHZhciB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7XG4gICAgdmFsdWVzW2luZGV4XSA9IHZhbHVlO1xuICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpO1xuICAgIHZhciBwcmVzZXJ2ZWRWYWx1ZXMgPSB0aGlzLl9wcmVzZXJ2ZWRWYWx1ZXM7XG4gICAgdmFyIGlzRWFjaCA9IHByZXNlcnZlZFZhbHVlcyAhPT0gbnVsbDtcbiAgICB2YXIgZ290QWNjdW0gPSB0aGlzLl9nb3RBY2N1bTtcbiAgICB2YXIgdmFsdWVzUGhhc2UgPSB0aGlzLl92YWx1ZXNQaGFzZTtcbiAgICB2YXIgdmFsdWVzUGhhc2VJbmRleDtcbiAgICBpZiAoIXZhbHVlc1BoYXNlKSB7XG4gICAgICAgIHZhbHVlc1BoYXNlID0gdGhpcy5fdmFsdWVzUGhhc2UgPSBuZXcgQXJyYXkobGVuZ3RoKTtcbiAgICAgICAgZm9yICh2YWx1ZXNQaGFzZUluZGV4PTA7IHZhbHVlc1BoYXNlSW5kZXg8bGVuZ3RoOyArK3ZhbHVlc1BoYXNlSW5kZXgpIHtcbiAgICAgICAgICAgIHZhbHVlc1BoYXNlW3ZhbHVlc1BoYXNlSW5kZXhdID0gMDtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YWx1ZXNQaGFzZUluZGV4ID0gdmFsdWVzUGhhc2VbaW5kZXhdO1xuXG4gICAgaWYgKGluZGV4ID09PSAwICYmIHRoaXMuX3plcm90aElzQWNjdW0pIHtcbiAgICAgICAgdGhpcy5fYWNjdW0gPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5fZ290QWNjdW0gPSBnb3RBY2N1bSA9IHRydWU7XG4gICAgICAgIHZhbHVlc1BoYXNlW2luZGV4XSA9ICgodmFsdWVzUGhhc2VJbmRleCA9PT0gMClcbiAgICAgICAgICAgID8gMSA6IDIpO1xuICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7XG4gICAgICAgIHRoaXMuX2dvdEFjY3VtID0gZ290QWNjdW0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh2YWx1ZXNQaGFzZUluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICB2YWx1ZXNQaGFzZVtpbmRleF0gPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFsdWVzUGhhc2VbaW5kZXhdID0gMjtcbiAgICAgICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFnb3RBY2N1bSkgcmV0dXJuO1xuXG4gICAgdmFyIGNhbGxiYWNrID0gdGhpcy5fY2FsbGJhY2s7XG4gICAgdmFyIHJlY2VpdmVyID0gdGhpcy5fcHJvbWlzZS5fYm91bmRWYWx1ZSgpO1xuICAgIHZhciByZXQ7XG5cbiAgICBmb3IgKHZhciBpID0gdGhpcy5fcmVkdWNpbmdJbmRleDsgaSA8IGxlbmd0aDsgKytpKSB7XG4gICAgICAgIHZhbHVlc1BoYXNlSW5kZXggPSB2YWx1ZXNQaGFzZVtpXTtcbiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggPT09IDIpIHtcbiAgICAgICAgICAgIHRoaXMuX3JlZHVjaW5nSW5kZXggPSBpICsgMTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWx1ZXNQaGFzZUluZGV4ICE9PSAxKSByZXR1cm47XG4gICAgICAgIHZhbHVlID0gdmFsdWVzW2ldO1xuICAgICAgICB0aGlzLl9wcm9taXNlLl9wdXNoQ29udGV4dCgpO1xuICAgICAgICBpZiAoaXNFYWNoKSB7XG4gICAgICAgICAgICBwcmVzZXJ2ZWRWYWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICByZXQgPSB0cnlDYXRjaChjYWxsYmFjaykuY2FsbChyZWNlaXZlciwgdmFsdWUsIGksIGxlbmd0aCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXQgPSB0cnlDYXRjaChjYWxsYmFjaylcbiAgICAgICAgICAgICAgICAuY2FsbChyZWNlaXZlciwgdGhpcy5fYWNjdW0sIHZhbHVlLCBpLCBsZW5ndGgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3Byb21pc2UuX3BvcENvbnRleHQoKTtcblxuICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgcmV0dXJuIHRoaXMuX3JlamVjdChyZXQuZSk7XG5cbiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IHRyeUNvbnZlcnRUb1Byb21pc2UocmV0LCB0aGlzLl9wcm9taXNlKTtcbiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICAgIG1heWJlUHJvbWlzZSA9IG1heWJlUHJvbWlzZS5fdGFyZ2V0KCk7XG4gICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlLl9pc1BlbmRpbmcoKSkge1xuICAgICAgICAgICAgICAgIHZhbHVlc1BoYXNlW2ldID0gNDtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWF5YmVQcm9taXNlLl9wcm94eVByb21pc2VBcnJheSh0aGlzLCBpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWF5YmVQcm9taXNlLl9pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gbWF5YmVQcm9taXNlLl92YWx1ZSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVqZWN0KG1heWJlUHJvbWlzZS5fcmVhc29uKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcmVkdWNpbmdJbmRleCA9IGkgKyAxO1xuICAgICAgICB0aGlzLl9hY2N1bSA9IHJldDtcbiAgICB9XG5cbiAgICB0aGlzLl9yZXNvbHZlKGlzRWFjaCA/IHByZXNlcnZlZFZhbHVlcyA6IHRoaXMuX2FjY3VtKTtcbn07XG5cbmZ1bmN0aW9uIHJlZHVjZShwcm9taXNlcywgZm4sIGluaXRpYWxWYWx1ZSwgX2VhY2gpIHtcbiAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBhcGlSZWplY3Rpb24oXCJmbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85MTZsSkpcXHUwMDBhXCIpO1xuICAgIHZhciBhcnJheSA9IG5ldyBSZWR1Y3Rpb25Qcm9taXNlQXJyYXkocHJvbWlzZXMsIGZuLCBpbml0aWFsVmFsdWUsIF9lYWNoKTtcbiAgICByZXR1cm4gYXJyYXkucHJvbWlzZSgpO1xufVxuXG5Qcm9taXNlLnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiAoZm4sIGluaXRpYWxWYWx1ZSkge1xuICAgIHJldHVybiByZWR1Y2UodGhpcywgZm4sIGluaXRpYWxWYWx1ZSwgbnVsbCk7XG59O1xuXG5Qcm9taXNlLnJlZHVjZSA9IGZ1bmN0aW9uIChwcm9taXNlcywgZm4sIGluaXRpYWxWYWx1ZSwgX2VhY2gpIHtcbiAgICByZXR1cm4gcmVkdWNlKHByb21pc2VzLCBmbiwgaW5pdGlhbFZhbHVlLCBfZWFjaCk7XG59O1xufTtcblxufSx7XCIuL2FzeW5jLmpzXCI6MixcIi4vdXRpbC5qc1wiOjM4fV0sMzE6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG52YXIgc2NoZWR1bGU7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWxcIik7XG52YXIgbm9Bc3luY1NjaGVkdWxlciA9IGZ1bmN0aW9uKCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGFzeW5jIHNjaGVkdWxlciBhdmFpbGFibGVcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9tM09UWGtcXHUwMDBhXCIpO1xufTtcbmlmICh1dGlsLmlzTm9kZSAmJiB0eXBlb2YgTXV0YXRpb25PYnNlcnZlciA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgIHZhciBHbG9iYWxTZXRJbW1lZGlhdGUgPSBnbG9iYWwuc2V0SW1tZWRpYXRlO1xuICAgIHZhciBQcm9jZXNzTmV4dFRpY2sgPSBwcm9jZXNzLm5leHRUaWNrO1xuICAgIHNjaGVkdWxlID0gdXRpbC5pc1JlY2VudE5vZGVcbiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uKGZuKSB7IEdsb2JhbFNldEltbWVkaWF0ZS5jYWxsKGdsb2JhbCwgZm4pOyB9XG4gICAgICAgICAgICAgICAgOiBmdW5jdGlvbihmbikgeyBQcm9jZXNzTmV4dFRpY2suY2FsbChwcm9jZXNzLCBmbik7IH07XG59IGVsc2UgaWYgKCh0eXBlb2YgTXV0YXRpb25PYnNlcnZlciAhPT0gXCJ1bmRlZmluZWRcIikgJiZcbiAgICAgICAgICAhKHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgJiZcbiAgICAgICAgICAgIHdpbmRvdy5uYXZpZ2F0b3IgJiZcbiAgICAgICAgICAgIHdpbmRvdy5uYXZpZ2F0b3Iuc3RhbmRhbG9uZSkpIHtcbiAgICBzY2hlZHVsZSA9IGZ1bmN0aW9uKGZuKSB7XG4gICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmbik7XG4gICAgICAgIG9ic2VydmVyLm9ic2VydmUoZGl2LCB7YXR0cmlidXRlczogdHJ1ZX0pO1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7IGRpdi5jbGFzc0xpc3QudG9nZ2xlKFwiZm9vXCIpOyB9O1xuICAgIH07XG4gICAgc2NoZWR1bGUuaXNTdGF0aWMgPSB0cnVlO1xufSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgc2NoZWR1bGUgPSBmdW5jdGlvbiAoZm4pIHtcbiAgICAgICAgc2V0SW1tZWRpYXRlKGZuKTtcbiAgICB9O1xufSBlbHNlIGlmICh0eXBlb2Ygc2V0VGltZW91dCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgIHNjaGVkdWxlID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgICAgIHNldFRpbWVvdXQoZm4sIDApO1xuICAgIH07XG59IGVsc2Uge1xuICAgIHNjaGVkdWxlID0gbm9Bc3luY1NjaGVkdWxlcjtcbn1cbm1vZHVsZS5leHBvcnRzID0gc2NoZWR1bGU7XG5cbn0se1wiLi91dGlsXCI6Mzh9XSwzMjpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID1cbiAgICBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXkpIHtcbnZhciBQcm9taXNlSW5zcGVjdGlvbiA9IFByb21pc2UuUHJvbWlzZUluc3BlY3Rpb247XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG5cbmZ1bmN0aW9uIFNldHRsZWRQcm9taXNlQXJyYXkodmFsdWVzKSB7XG4gICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTtcbn1cbnV0aWwuaW5oZXJpdHMoU2V0dGxlZFByb21pc2VBcnJheSwgUHJvbWlzZUFycmF5KTtcblxuU2V0dGxlZFByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VSZXNvbHZlZCA9IGZ1bmN0aW9uIChpbmRleCwgaW5zcGVjdGlvbikge1xuICAgIHRoaXMuX3ZhbHVlc1tpbmRleF0gPSBpbnNwZWN0aW9uO1xuICAgIHZhciB0b3RhbFJlc29sdmVkID0gKyt0aGlzLl90b3RhbFJlc29sdmVkO1xuICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkge1xuICAgICAgICB0aGlzLl9yZXNvbHZlKHRoaXMuX3ZhbHVlcyk7XG4gICAgfVxufTtcblxuU2V0dGxlZFByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VGdWxmaWxsZWQgPSBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlSW5zcGVjdGlvbigpO1xuICAgIHJldC5fYml0RmllbGQgPSAyNjg0MzU0NTY7XG4gICAgcmV0Ll9zZXR0bGVkVmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLl9wcm9taXNlUmVzb2x2ZWQoaW5kZXgsIHJldCk7XG59O1xuU2V0dGxlZFByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VSZWplY3RlZCA9IGZ1bmN0aW9uIChyZWFzb24sIGluZGV4KSB7XG4gICAgdmFyIHJldCA9IG5ldyBQcm9taXNlSW5zcGVjdGlvbigpO1xuICAgIHJldC5fYml0RmllbGQgPSAxMzQyMTc3Mjg7XG4gICAgcmV0Ll9zZXR0bGVkVmFsdWUgPSByZWFzb247XG4gICAgdGhpcy5fcHJvbWlzZVJlc29sdmVkKGluZGV4LCByZXQpO1xufTtcblxuUHJvbWlzZS5zZXR0bGUgPSBmdW5jdGlvbiAocHJvbWlzZXMpIHtcbiAgICByZXR1cm4gbmV3IFNldHRsZWRQcm9taXNlQXJyYXkocHJvbWlzZXMpLnByb21pc2UoKTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLnNldHRsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gbmV3IFNldHRsZWRQcm9taXNlQXJyYXkodGhpcykucHJvbWlzZSgpO1xufTtcbn07XG5cbn0se1wiLi91dGlsLmpzXCI6Mzh9XSwzMzpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID1cbmZ1bmN0aW9uKFByb21pc2UsIFByb21pc2VBcnJheSwgYXBpUmVqZWN0aW9uKSB7XG52YXIgdXRpbCA9IF9kZXJlcV8oXCIuL3V0aWwuanNcIik7XG52YXIgUmFuZ2VFcnJvciA9IF9kZXJlcV8oXCIuL2Vycm9ycy5qc1wiKS5SYW5nZUVycm9yO1xudmFyIEFnZ3JlZ2F0ZUVycm9yID0gX2RlcmVxXyhcIi4vZXJyb3JzLmpzXCIpLkFnZ3JlZ2F0ZUVycm9yO1xudmFyIGlzQXJyYXkgPSB1dGlsLmlzQXJyYXk7XG5cblxuZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSh2YWx1ZXMpIHtcbiAgICB0aGlzLmNvbnN0cnVjdG9yJCh2YWx1ZXMpO1xuICAgIHRoaXMuX2hvd01hbnkgPSAwO1xuICAgIHRoaXMuX3Vud3JhcCA9IGZhbHNlO1xuICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XG59XG51dGlsLmluaGVyaXRzKFNvbWVQcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5faG93TWFueSA9PT0gMCkge1xuICAgICAgICB0aGlzLl9yZXNvbHZlKFtdKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbml0JCh1bmRlZmluZWQsIC01KTtcbiAgICB2YXIgaXNBcnJheVJlc29sdmVkID0gaXNBcnJheSh0aGlzLl92YWx1ZXMpO1xuICAgIGlmICghdGhpcy5faXNSZXNvbHZlZCgpICYmXG4gICAgICAgIGlzQXJyYXlSZXNvbHZlZCAmJlxuICAgICAgICB0aGlzLl9ob3dNYW55ID4gdGhpcy5fY2FuUG9zc2libHlGdWxmaWxsKCkpIHtcbiAgICAgICAgdGhpcy5fcmVqZWN0KHRoaXMuX2dldFJhbmdlRXJyb3IodGhpcy5sZW5ndGgoKSkpO1xuICAgIH1cbn07XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIHRoaXMuX2luaXQoKTtcbn07XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldFVud3JhcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl91bndyYXAgPSB0cnVlO1xufTtcblxuU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuaG93TWFueSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5faG93TWFueTtcbn07XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldEhvd01hbnkgPSBmdW5jdGlvbiAoY291bnQpIHtcbiAgICB0aGlzLl9ob3dNYW55ID0gY291bnQ7XG59O1xuXG5Tb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZUZ1bGZpbGxlZCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHRoaXMuX2FkZEZ1bGZpbGxlZCh2YWx1ZSk7XG4gICAgaWYgKHRoaXMuX2Z1bGZpbGxlZCgpID09PSB0aGlzLmhvd01hbnkoKSkge1xuICAgICAgICB0aGlzLl92YWx1ZXMubGVuZ3RoID0gdGhpcy5ob3dNYW55KCk7XG4gICAgICAgIGlmICh0aGlzLmhvd01hbnkoKSA9PT0gMSAmJiB0aGlzLl91bndyYXApIHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fdmFsdWVzWzBdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fdmFsdWVzKTtcbiAgICAgICAgfVxuICAgIH1cblxufTtcblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlUmVqZWN0ZWQgPSBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgdGhpcy5fYWRkUmVqZWN0ZWQocmVhc29uKTtcbiAgICBpZiAodGhpcy5ob3dNYW55KCkgPiB0aGlzLl9jYW5Qb3NzaWJseUZ1bGZpbGwoKSkge1xuICAgICAgICB2YXIgZSA9IG5ldyBBZ2dyZWdhdGVFcnJvcigpO1xuICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5sZW5ndGgoKTsgaSA8IHRoaXMuX3ZhbHVlcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgZS5wdXNoKHRoaXMuX3ZhbHVlc1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcmVqZWN0KGUpO1xuICAgIH1cbn07XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9mdWxmaWxsZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RvdGFsUmVzb2x2ZWQ7XG59O1xuXG5Tb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcmVqZWN0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlcy5sZW5ndGggLSB0aGlzLmxlbmd0aCgpO1xufTtcblxuU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX2FkZFJlamVjdGVkID0gZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIHRoaXMuX3ZhbHVlcy5wdXNoKHJlYXNvbik7XG59O1xuXG5Tb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fYWRkRnVsZmlsbGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgdGhpcy5fdmFsdWVzW3RoaXMuX3RvdGFsUmVzb2x2ZWQrK10gPSB2YWx1ZTtcbn07XG5cblNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9jYW5Qb3NzaWJseUZ1bGZpbGwgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMubGVuZ3RoKCkgLSB0aGlzLl9yZWplY3RlZCgpO1xufTtcblxuU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX2dldFJhbmdlRXJyb3IgPSBmdW5jdGlvbiAoY291bnQpIHtcbiAgICB2YXIgbWVzc2FnZSA9IFwiSW5wdXQgYXJyYXkgbXVzdCBjb250YWluIGF0IGxlYXN0IFwiICtcbiAgICAgICAgICAgIHRoaXMuX2hvd01hbnkgKyBcIiBpdGVtcyBidXQgY29udGFpbnMgb25seSBcIiArIGNvdW50ICsgXCIgaXRlbXNcIjtcbiAgICByZXR1cm4gbmV3IFJhbmdlRXJyb3IobWVzc2FnZSk7XG59O1xuXG5Tb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcmVzb2x2ZUVtcHR5QXJyYXkgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fcmVqZWN0KHRoaXMuX2dldFJhbmdlRXJyb3IoMCkpO1xufTtcblxuZnVuY3Rpb24gc29tZShwcm9taXNlcywgaG93TWFueSkge1xuICAgIGlmICgoaG93TWFueSB8IDApICE9PSBob3dNYW55IHx8IGhvd01hbnkgPCAwKSB7XG4gICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oXCJleHBlY3RpbmcgYSBwb3NpdGl2ZSBpbnRlZ2VyXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvMXdBbUh4XFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdmFyIHJldCA9IG5ldyBTb21lUHJvbWlzZUFycmF5KHByb21pc2VzKTtcbiAgICB2YXIgcHJvbWlzZSA9IHJldC5wcm9taXNlKCk7XG4gICAgcmV0LnNldEhvd01hbnkoaG93TWFueSk7XG4gICAgcmV0LmluaXQoKTtcbiAgICByZXR1cm4gcHJvbWlzZTtcbn1cblxuUHJvbWlzZS5zb21lID0gZnVuY3Rpb24gKHByb21pc2VzLCBob3dNYW55KSB7XG4gICAgcmV0dXJuIHNvbWUocHJvbWlzZXMsIGhvd01hbnkpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuc29tZSA9IGZ1bmN0aW9uIChob3dNYW55KSB7XG4gICAgcmV0dXJuIHNvbWUodGhpcywgaG93TWFueSk7XG59O1xuXG5Qcm9taXNlLl9Tb21lUHJvbWlzZUFycmF5ID0gU29tZVByb21pc2VBcnJheTtcbn07XG5cbn0se1wiLi9lcnJvcnMuanNcIjoxMyxcIi4vdXRpbC5qc1wiOjM4fV0sMzQ6W2Z1bmN0aW9uKF9kZXJlcV8sbW9kdWxlLGV4cG9ydHMpe1xuXCJ1c2Ugc3RyaWN0XCI7XG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHtcbmZ1bmN0aW9uIFByb21pc2VJbnNwZWN0aW9uKHByb21pc2UpIHtcbiAgICBpZiAocHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHByb21pc2UgPSBwcm9taXNlLl90YXJnZXQoKTtcbiAgICAgICAgdGhpcy5fYml0RmllbGQgPSBwcm9taXNlLl9iaXRGaWVsZDtcbiAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gcHJvbWlzZS5fc2V0dGxlZFZhbHVlO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5fYml0RmllbGQgPSAwO1xuICAgICAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgfVxufVxuXG5Qcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLmlzRnVsZmlsbGVkKCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImNhbm5vdCBnZXQgZnVsZmlsbG1lbnQgdmFsdWUgb2YgYSBub24tZnVsZmlsbGVkIHByb21pc2VcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9oYzFETGpcXHUwMDBhXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fc2V0dGxlZFZhbHVlO1xufTtcblxuUHJvbWlzZUluc3BlY3Rpb24ucHJvdG90eXBlLmVycm9yID1cblByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5yZWFzb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLmlzUmVqZWN0ZWQoKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiY2Fubm90IGdldCByZWplY3Rpb24gcmVhc29uIG9mIGEgbm9uLXJlamVjdGVkIHByb21pc2VcXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC9oUHVpd0JcXHUwMDBhXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fc2V0dGxlZFZhbHVlO1xufTtcblxuUHJvbWlzZUluc3BlY3Rpb24ucHJvdG90eXBlLmlzRnVsZmlsbGVkID1cblByb21pc2UucHJvdG90eXBlLl9pc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMjY4NDM1NDU2KSA+IDA7XG59O1xuXG5Qcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNSZWplY3RlZCA9XG5Qcm9taXNlLnByb3RvdHlwZS5faXNSZWplY3RlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTM0MjE3NzI4KSA+IDA7XG59O1xuXG5Qcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNQZW5kaW5nID1cblByb21pc2UucHJvdG90eXBlLl9pc1BlbmRpbmcgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDQwMjY1MzE4NCkgPT09IDA7XG59O1xuXG5Qcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNSZXNvbHZlZCA9XG5Qcm9taXNlLnByb3RvdHlwZS5faXNSZXNvbHZlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNDAyNjUzMTg0KSA+IDA7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5pc1BlbmRpbmcgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdGFyZ2V0KCkuX2lzUGVuZGluZygpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuaXNSZWplY3RlZCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl90YXJnZXQoKS5faXNSZWplY3RlZCgpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuaXNGdWxmaWxsZWQgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdGFyZ2V0KCkuX2lzRnVsZmlsbGVkKCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5pc1Jlc29sdmVkID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RhcmdldCgpLl9pc1Jlc29sdmVkKCk7XG59O1xuXG5Qcm9taXNlLnByb3RvdHlwZS5fdmFsdWUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2V0dGxlZFZhbHVlO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuX3JlYXNvbiA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTtcbiAgICByZXR1cm4gdGhpcy5fc2V0dGxlZFZhbHVlO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgdGFyZ2V0ID0gdGhpcy5fdGFyZ2V0KCk7XG4gICAgaWYgKCF0YXJnZXQuaXNGdWxmaWxsZWQoKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiY2Fubm90IGdldCBmdWxmaWxsbWVudCB2YWx1ZSBvZiBhIG5vbi1mdWxmaWxsZWQgcHJvbWlzZVxcdTAwMGFcXHUwMDBhICAgIFNlZSBodHRwOi8vZ29vLmdsL2hjMURMalxcdTAwMGFcIik7XG4gICAgfVxuICAgIHJldHVybiB0YXJnZXQuX3NldHRsZWRWYWx1ZTtcbn07XG5cblByb21pc2UucHJvdG90eXBlLnJlYXNvbiA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciB0YXJnZXQgPSB0aGlzLl90YXJnZXQoKTtcbiAgICBpZiAoIXRhcmdldC5pc1JlamVjdGVkKCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImNhbm5vdCBnZXQgcmVqZWN0aW9uIHJlYXNvbiBvZiBhIG5vbi1yZWplY3RlZCBwcm9taXNlXFx1MDAwYVxcdTAwMGEgICAgU2VlIGh0dHA6Ly9nb28uZ2wvaFB1aXdCXFx1MDAwYVwiKTtcbiAgICB9XG4gICAgdGFyZ2V0Ll91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7XG4gICAgcmV0dXJuIHRhcmdldC5fc2V0dGxlZFZhbHVlO1xufTtcblxuXG5Qcm9taXNlLlByb21pc2VJbnNwZWN0aW9uID0gUHJvbWlzZUluc3BlY3Rpb247XG59O1xuXG59LHt9XSwzNTpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHtcbnZhciB1dGlsID0gX2RlcmVxXyhcIi4vdXRpbC5qc1wiKTtcbnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7XG52YXIgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0O1xuXG5mdW5jdGlvbiB0cnlDb252ZXJ0VG9Qcm9taXNlKG9iaiwgY29udGV4dCkge1xuICAgIGlmIChpc09iamVjdChvYmopKSB7XG4gICAgICAgIGlmIChvYmogaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGlzQW55Qmx1ZWJpcmRQcm9taXNlKG9iaikpIHtcbiAgICAgICAgICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgICAgICAgICBvYmouX3RoZW4oXG4gICAgICAgICAgICAgICAgcmV0Ll9mdWxmaWxsVW5jaGVja2VkLFxuICAgICAgICAgICAgICAgIHJldC5fcmVqZWN0VW5jaGVja2VkQ2hlY2tFcnJvcixcbiAgICAgICAgICAgICAgICByZXQuX3Byb2dyZXNzVW5jaGVja2VkLFxuICAgICAgICAgICAgICAgIHJldCxcbiAgICAgICAgICAgICAgICBudWxsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdGhlbiA9IHV0aWwudHJ5Q2F0Y2goZ2V0VGhlbikob2JqKTtcbiAgICAgICAgaWYgKHRoZW4gPT09IGVycm9yT2JqKSB7XG4gICAgICAgICAgICBpZiAoY29udGV4dCkgY29udGV4dC5fcHVzaENvbnRleHQoKTtcbiAgICAgICAgICAgIHZhciByZXQgPSBQcm9taXNlLnJlamVjdCh0aGVuLmUpO1xuICAgICAgICAgICAgaWYgKGNvbnRleHQpIGNvbnRleHQuX3BvcENvbnRleHQoKTtcbiAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoZW4gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgcmV0dXJuIGRvVGhlbmFibGUob2JqLCB0aGVuLCBjb250ZXh0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuXG5mdW5jdGlvbiBnZXRUaGVuKG9iaikge1xuICAgIHJldHVybiBvYmoudGhlbjtcbn1cblxudmFyIGhhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eTtcbmZ1bmN0aW9uIGlzQW55Qmx1ZWJpcmRQcm9taXNlKG9iaikge1xuICAgIHJldHVybiBoYXNQcm9wLmNhbGwob2JqLCBcIl9wcm9taXNlMFwiKTtcbn1cblxuZnVuY3Rpb24gZG9UaGVuYWJsZSh4LCB0aGVuLCBjb250ZXh0KSB7XG4gICAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgdmFyIHJldCA9IHByb21pc2U7XG4gICAgaWYgKGNvbnRleHQpIGNvbnRleHQuX3B1c2hDb250ZXh0KCk7XG4gICAgcHJvbWlzZS5fY2FwdHVyZVN0YWNrVHJhY2UoKTtcbiAgICBpZiAoY29udGV4dCkgY29udGV4dC5fcG9wQ29udGV4dCgpO1xuICAgIHZhciBzeW5jaHJvbm91cyA9IHRydWU7XG4gICAgdmFyIHJlc3VsdCA9IHV0aWwudHJ5Q2F0Y2godGhlbikuY2FsbCh4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVGcm9tVGhlbmFibGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0RnJvbVRoZW5hYmxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzRnJvbVRoZW5hYmxlKTtcbiAgICBzeW5jaHJvbm91cyA9IGZhbHNlO1xuICAgIGlmIChwcm9taXNlICYmIHJlc3VsdCA9PT0gZXJyb3JPYmopIHtcbiAgICAgICAgcHJvbWlzZS5fcmVqZWN0Q2FsbGJhY2socmVzdWx0LmUsIHRydWUsIHRydWUpO1xuICAgICAgICBwcm9taXNlID0gbnVsbDtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZXNvbHZlRnJvbVRoZW5hYmxlKHZhbHVlKSB7XG4gICAgICAgIGlmICghcHJvbWlzZSkgcmV0dXJuO1xuICAgICAgICBwcm9taXNlLl9yZXNvbHZlQ2FsbGJhY2sodmFsdWUpO1xuICAgICAgICBwcm9taXNlID0gbnVsbDtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZWplY3RGcm9tVGhlbmFibGUocmVhc29uKSB7XG4gICAgICAgIGlmICghcHJvbWlzZSkgcmV0dXJuO1xuICAgICAgICBwcm9taXNlLl9yZWplY3RDYWxsYmFjayhyZWFzb24sIHN5bmNocm9ub3VzLCB0cnVlKTtcbiAgICAgICAgcHJvbWlzZSA9IG51bGw7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcHJvZ3Jlc3NGcm9tVGhlbmFibGUodmFsdWUpIHtcbiAgICAgICAgaWYgKCFwcm9taXNlKSByZXR1cm47XG4gICAgICAgIGlmICh0eXBlb2YgcHJvbWlzZS5fcHJvZ3Jlc3MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3ModmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5cbnJldHVybiB0cnlDb252ZXJ0VG9Qcm9taXNlO1xufTtcblxufSx7XCIuL3V0aWwuanNcIjozOH1dLDM2OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBJTlRFUk5BTCkge1xudmFyIHV0aWwgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpO1xudmFyIFRpbWVvdXRFcnJvciA9IFByb21pc2UuVGltZW91dEVycm9yO1xuXG52YXIgYWZ0ZXJUaW1lb3V0ID0gZnVuY3Rpb24gKHByb21pc2UsIG1lc3NhZ2UpIHtcbiAgICBpZiAoIXByb21pc2UuaXNQZW5kaW5nKCkpIHJldHVybjtcbiAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgbWVzc2FnZSA9IFwib3BlcmF0aW9uIHRpbWVkIG91dFwiO1xuICAgIH1cbiAgICB2YXIgZXJyID0gbmV3IFRpbWVvdXRFcnJvcihtZXNzYWdlKTtcbiAgICB1dGlsLm1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihlcnIpO1xuICAgIHByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UoZXJyKTtcbiAgICBwcm9taXNlLl9jYW5jZWwoZXJyKTtcbn07XG5cbnZhciBhZnRlclZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIGRlbGF5KCt0aGlzKS50aGVuUmV0dXJuKHZhbHVlKTsgfTtcbnZhciBkZWxheSA9IFByb21pc2UuZGVsYXkgPSBmdW5jdGlvbiAodmFsdWUsIG1zKSB7XG4gICAgaWYgKG1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbXMgPSB2YWx1ZTtcbiAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJldC5fZnVsZmlsbCgpOyB9LCBtcyk7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIG1zID0gK21zO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodmFsdWUpLl90aGVuKGFmdGVyVmFsdWUsIG51bGwsIG51bGwsIG1zLCB1bmRlZmluZWQpO1xufTtcblxuUHJvbWlzZS5wcm90b3R5cGUuZGVsYXkgPSBmdW5jdGlvbiAobXMpIHtcbiAgICByZXR1cm4gZGVsYXkodGhpcywgbXMpO1xufTtcblxuZnVuY3Rpb24gc3VjY2Vzc0NsZWFyKHZhbHVlKSB7XG4gICAgdmFyIGhhbmRsZSA9IHRoaXM7XG4gICAgaWYgKGhhbmRsZSBpbnN0YW5jZW9mIE51bWJlcikgaGFuZGxlID0gK2hhbmRsZTtcbiAgICBjbGVhclRpbWVvdXQoaGFuZGxlKTtcbiAgICByZXR1cm4gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIGZhaWx1cmVDbGVhcihyZWFzb24pIHtcbiAgICB2YXIgaGFuZGxlID0gdGhpcztcbiAgICBpZiAoaGFuZGxlIGluc3RhbmNlb2YgTnVtYmVyKSBoYW5kbGUgPSAraGFuZGxlO1xuICAgIGNsZWFyVGltZW91dChoYW5kbGUpO1xuICAgIHRocm93IHJlYXNvbjtcbn1cblxuUHJvbWlzZS5wcm90b3R5cGUudGltZW91dCA9IGZ1bmN0aW9uIChtcywgbWVzc2FnZSkge1xuICAgIG1zID0gK21zO1xuICAgIHZhciByZXQgPSB0aGlzLnRoZW4oKS5jYW5jZWxsYWJsZSgpO1xuICAgIHJldC5fY2FuY2VsbGF0aW9uUGFyZW50ID0gdGhpcztcbiAgICB2YXIgaGFuZGxlID0gc2V0VGltZW91dChmdW5jdGlvbiB0aW1lb3V0VGltZW91dCgpIHtcbiAgICAgICAgYWZ0ZXJUaW1lb3V0KHJldCwgbWVzc2FnZSk7XG4gICAgfSwgbXMpO1xuICAgIHJldHVybiByZXQuX3RoZW4oc3VjY2Vzc0NsZWFyLCBmYWlsdXJlQ2xlYXIsIHVuZGVmaW5lZCwgaGFuZGxlLCB1bmRlZmluZWQpO1xufTtcblxufTtcblxufSx7XCIuL3V0aWwuanNcIjozOH1dLDM3OltmdW5jdGlvbihfZGVyZXFfLG1vZHVsZSxleHBvcnRzKXtcblwidXNlIHN0cmljdFwiO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoUHJvbWlzZSwgYXBpUmVqZWN0aW9uLCB0cnlDb252ZXJ0VG9Qcm9taXNlLFxuICAgIGNyZWF0ZUNvbnRleHQpIHtcbiAgICB2YXIgVHlwZUVycm9yID0gX2RlcmVxXyhcIi4vZXJyb3JzLmpzXCIpLlR5cGVFcnJvcjtcbiAgICB2YXIgaW5oZXJpdHMgPSBfZGVyZXFfKFwiLi91dGlsLmpzXCIpLmluaGVyaXRzO1xuICAgIHZhciBQcm9taXNlSW5zcGVjdGlvbiA9IFByb21pc2UuUHJvbWlzZUluc3BlY3Rpb247XG5cbiAgICBmdW5jdGlvbiBpbnNwZWN0aW9uTWFwcGVyKGluc3BlY3Rpb25zKSB7XG4gICAgICAgIHZhciBsZW4gPSBpbnNwZWN0aW9ucy5sZW5ndGg7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcbiAgICAgICAgICAgIHZhciBpbnNwZWN0aW9uID0gaW5zcGVjdGlvbnNbaV07XG4gICAgICAgICAgICBpZiAoaW5zcGVjdGlvbi5pc1JlamVjdGVkKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoaW5zcGVjdGlvbi5lcnJvcigpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc3BlY3Rpb25zW2ldID0gaW5zcGVjdGlvbi5fc2V0dGxlZFZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbnNwZWN0aW9ucztcbiAgICB9XG5cbiAgICBmdW5jdGlvbiB0aHJvd2VyKGUpIHtcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe3Rocm93IGU7fSwgMCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY2FzdFByZXNlcnZpbmdEaXNwb3NhYmxlKHRoZW5hYmxlKSB7XG4gICAgICAgIHZhciBtYXliZVByb21pc2UgPSB0cnlDb252ZXJ0VG9Qcm9taXNlKHRoZW5hYmxlKTtcbiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSAhPT0gdGhlbmFibGUgJiZcbiAgICAgICAgICAgIHR5cGVvZiB0aGVuYWJsZS5faXNEaXNwb3NhYmxlID09PSBcImZ1bmN0aW9uXCIgJiZcbiAgICAgICAgICAgIHR5cGVvZiB0aGVuYWJsZS5fZ2V0RGlzcG9zZXIgPT09IFwiZnVuY3Rpb25cIiAmJlxuICAgICAgICAgICAgdGhlbmFibGUuX2lzRGlzcG9zYWJsZSgpKSB7XG4gICAgICAgICAgICBtYXliZVByb21pc2UuX3NldERpc3Bvc2FibGUodGhlbmFibGUuX2dldERpc3Bvc2VyKCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtYXliZVByb21pc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGRpc3Bvc2UocmVzb3VyY2VzLCBpbnNwZWN0aW9uKSB7XG4gICAgICAgIHZhciBpID0gMDtcbiAgICAgICAgdmFyIGxlbiA9IHJlc291cmNlcy5sZW5ndGg7XG4gICAgICAgIHZhciByZXQgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgIGZ1bmN0aW9uIGl0ZXJhdG9yKCkge1xuICAgICAgICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4gcmV0LnJlc29sdmUoKTtcbiAgICAgICAgICAgIHZhciBtYXliZVByb21pc2UgPSBjYXN0UHJlc2VydmluZ0Rpc3Bvc2FibGUocmVzb3VyY2VzW2krK10pO1xuICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UgJiZcbiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX2lzRGlzcG9zYWJsZSgpKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlID0gdHJ5Q29udmVydFRvUHJvbWlzZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fZ2V0RGlzcG9zZXIoKS50cnlEaXNwb3NlKGluc3BlY3Rpb24pLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzLnByb21pc2UpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRocm93ZXIoZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3RoZW4oaXRlcmF0b3IsIHRocm93ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgbnVsbCwgbnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaXRlcmF0b3IoKTtcbiAgICAgICAgfVxuICAgICAgICBpdGVyYXRvcigpO1xuICAgICAgICByZXR1cm4gcmV0LnByb21pc2U7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZGlzcG9zZXJTdWNjZXNzKHZhbHVlKSB7XG4gICAgICAgIHZhciBpbnNwZWN0aW9uID0gbmV3IFByb21pc2VJbnNwZWN0aW9uKCk7XG4gICAgICAgIGluc3BlY3Rpb24uX3NldHRsZWRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICBpbnNwZWN0aW9uLl9iaXRGaWVsZCA9IDI2ODQzNTQ1NjtcbiAgICAgICAgcmV0dXJuIGRpc3Bvc2UodGhpcywgaW5zcGVjdGlvbikudGhlblJldHVybih2YWx1ZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZGlzcG9zZXJGYWlsKHJlYXNvbikge1xuICAgICAgICB2YXIgaW5zcGVjdGlvbiA9IG5ldyBQcm9taXNlSW5zcGVjdGlvbigpO1xuICAgICAgICBpbnNwZWN0aW9uLl9zZXR0bGVkVmFsdWUgPSByZWFzb247XG4gICAgICAgIGluc3BlY3Rpb24uX2JpdEZpZWxkID0gMTM0MjE3NzI4O1xuICAgICAgICByZXR1cm4gZGlzcG9zZSh0aGlzLCBpbnNwZWN0aW9uKS50aGVuVGhyb3cocmVhc29uKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBEaXNwb3NlcihkYXRhLCBwcm9taXNlLCBjb250ZXh0KSB7XG4gICAgICAgIHRoaXMuX2RhdGEgPSBkYXRhO1xuICAgICAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZTtcbiAgICAgICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7XG4gICAgfVxuXG4gICAgRGlzcG9zZXIucHJvdG90eXBlLmRhdGEgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhO1xuICAgIH07XG5cbiAgICBEaXNwb3Nlci5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb21pc2U7XG4gICAgfTtcblxuICAgIERpc3Bvc2VyLnByb3RvdHlwZS5yZXNvdXJjZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvbWlzZSgpLmlzRnVsZmlsbGVkKCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb21pc2UoKS52YWx1ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH07XG5cbiAgICBEaXNwb3Nlci5wcm90b3R5cGUudHJ5RGlzcG9zZSA9IGZ1bmN0aW9uKGluc3BlY3Rpb24pIHtcbiAgICAgICAgdmFyIHJlc291cmNlID0gdGhpcy5yZXNvdXJjZSgpO1xuICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuX2NvbnRleHQ7XG4gICAgICAgIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIGNvbnRleHQuX3B1c2hDb250ZXh0KCk7XG4gICAgICAgIHZhciByZXQgPSByZXNvdXJjZSAhPT0gbnVsbFxuICAgICAgICAgICAgPyB0aGlzLmRvRGlzcG9zZShyZXNvdXJjZSwgaW5zcGVjdGlvbikgOiBudWxsO1xuICAgICAgICBpZiAoY29udGV4dCAhPT0gdW5kZWZpbmVkKSBjb250ZXh0Ll9wb3BDb250ZXh0KCk7XG4gICAgICAgIHRoaXMuX3Byb21pc2UuX3Vuc2V0RGlzcG9zYWJsZSgpO1xuICAgICAgICB0aGlzLl9kYXRhID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuXG4gICAgRGlzcG9zZXIuaXNEaXNwb3NlciA9IGZ1bmN0aW9uIChkKSB7XG4gICAgICAgIHJldHVybiAoZCAhPSBudWxsICYmXG4gICAgICAgICAgICAgICAgdHlwZW9mIGQucmVzb3VyY2UgPT09IFwiZnVuY3Rpb25cIiAmJlxuICAgICAgICAgICAgICAgIHR5cGVvZiBkLnRyeURpc3Bvc2UgPT09IFwiZnVuY3Rpb25cIik7XG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIEZ1bmN0aW9uRGlzcG9zZXIoZm4sIHByb21pc2UsIGNvbnRleHQpIHtcbiAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciQoZm4sIHByb21pc2UsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpbmhlcml0cyhGdW5jdGlvbkRpc3Bvc2VyLCBEaXNwb3Nlcik7XG5cbiAgICBGdW5jdGlvbkRpc3Bvc2VyLnByb3RvdHlwZS5kb0Rpc3Bvc2UgPSBmdW5jdGlvbiAocmVzb3VyY2UsIGluc3BlY3Rpb24pIHtcbiAgICAgICAgdmFyIGZuID0gdGhpcy5kYXRhKCk7XG4gICAgICAgIHJldHVybiBmbi5jYWxsKHJlc291cmNlLCByZXNvdXJjZSwgaW5zcGVjdGlvbik7XG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIG1heWJlVW53cmFwRGlzcG9zZXIodmFsdWUpIHtcbiAgICAgICAgaWYgKERpc3Bvc2VyLmlzRGlzcG9zZXIodmFsdWUpKSB7XG4gICAgICAgICAgICB0aGlzLnJlc291cmNlc1t0aGlzLmluZGV4XS5fc2V0RGlzcG9zYWJsZSh2YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUucHJvbWlzZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBQcm9taXNlLnVzaW5nID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbGVuID0gYXJndW1lbnRzLmxlbmd0aDtcbiAgICAgICAgaWYgKGxlbiA8IDIpIHJldHVybiBhcGlSZWplY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICBcInlvdSBtdXN0IHBhc3MgYXQgbGVhc3QgMiBhcmd1bWVudHMgdG8gUHJvbWlzZS51c2luZ1wiKTtcbiAgICAgICAgdmFyIGZuID0gYXJndW1lbnRzW2xlbiAtIDFdO1xuICAgICAgICBpZiAodHlwZW9mIGZuICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBhcGlSZWplY3Rpb24oXCJmbiBtdXN0IGJlIGEgZnVuY3Rpb25cXHUwMDBhXFx1MDAwYSAgICBTZWUgaHR0cDovL2dvby5nbC85MTZsSkpcXHUwMDBhXCIpO1xuICAgICAgICBsZW4tLTtcbiAgICAgICAgdmFyIHJlc291cmNlcyA9IG5ldyBBcnJheShsZW4pO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBhcmd1bWVudHNbaV07XG4gICAgICAgICAgICBpZiAoRGlzcG9zZXIuaXNEaXNwb3NlcihyZXNvdXJjZSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgZGlzcG9zZXIgPSByZXNvdXJjZTtcbiAgICAgICAgICAgICAgICByZXNvdXJjZSA9IHJlc291cmNlLnByb21pc2UoKTtcbiAgICAgICAgICAgICAgICByZXNvdXJjZS5fc2V0RGlzcG9zYWJsZShkaXNwb3Nlcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBtYXliZVByb21pc2UgPSB0cnlDb252ZXJ0VG9Qcm9taXNlKHJlc291cmNlKTtcbiAgICAgICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3RoZW4obWF5YmVVbndyYXBEaXNwb3NlciwgbnVsbCwgbnVsbCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogcmVzb3VyY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpXG4gICAgICAgICAgICAgICAgICAgIH0sIHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzb3VyY2VzW2ldID0gcmVzb3VyY2U7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgcHJvbWlzZSA9IFByb21pc2Uuc2V0dGxlKHJlc291cmNlcylcbiAgICAgICAgICAgIC50aGVuKGluc3BlY3Rpb25NYXBwZXIpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbih2YWxzKSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5fcHVzaENvbnRleHQoKTtcbiAgICAgICAgICAgICAgICB2YXIgcmV0O1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IGZuLmFwcGx5KHVuZGVmaW5lZCwgdmFscyk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5fcG9wQ29udGV4dCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5fdGhlbihcbiAgICAgICAgICAgICAgICBkaXNwb3NlclN1Y2Nlc3MsIGRpc3Bvc2VyRmFpbCwgdW5kZWZpbmVkLCByZXNvdXJjZXMsIHVuZGVmaW5lZCk7XG4gICAgICAgIHJlc291cmNlcy5wcm9taXNlID0gcHJvbWlzZTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfTtcblxuICAgIFByb21pc2UucHJvdG90eXBlLl9zZXREaXNwb3NhYmxlID0gZnVuY3Rpb24gKGRpc3Bvc2VyKSB7XG4gICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCAyNjIxNDQ7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2VyID0gZGlzcG9zZXI7XG4gICAgfTtcblxuICAgIFByb21pc2UucHJvdG90eXBlLl9pc0Rpc3Bvc2FibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiAyNjIxNDQpID4gMDtcbiAgICB9O1xuXG4gICAgUHJvbWlzZS5wcm90b3R5cGUuX2dldERpc3Bvc2VyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGlzcG9zZXI7XG4gICAgfTtcblxuICAgIFByb21pc2UucHJvdG90eXBlLl91bnNldERpc3Bvc2FibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjI2MjE0NCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2VyID0gdW5kZWZpbmVkO1xuICAgIH07XG5cbiAgICBQcm9taXNlLnByb3RvdHlwZS5kaXNwb3NlciA9IGZ1bmN0aW9uIChmbikge1xuICAgICAgICBpZiAodHlwZW9mIGZuID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb25EaXNwb3NlcihmbiwgdGhpcywgY3JlYXRlQ29udGV4dCgpKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7XG4gICAgfTtcblxufTtcblxufSx7XCIuL2Vycm9ycy5qc1wiOjEzLFwiLi91dGlsLmpzXCI6Mzh9XSwzODpbZnVuY3Rpb24oX2RlcmVxXyxtb2R1bGUsZXhwb3J0cyl7XG5cInVzZSBzdHJpY3RcIjtcbnZhciBlczUgPSBfZGVyZXFfKFwiLi9lczUuanNcIik7XG52YXIgY2FuRXZhbHVhdGUgPSB0eXBlb2YgbmF2aWdhdG9yID09IFwidW5kZWZpbmVkXCI7XG52YXIgaGF2ZUdldHRlcnMgPSAoZnVuY3Rpb24oKXtcbiAgICB0cnkge1xuICAgICAgICB2YXIgbyA9IHt9O1xuICAgICAgICBlczUuZGVmaW5lUHJvcGVydHkobywgXCJmXCIsIHtcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG8uZiA9PT0gMztcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxufSkoKTtcblxudmFyIGVycm9yT2JqID0ge2U6IHt9fTtcbnZhciB0cnlDYXRjaFRhcmdldDtcbmZ1bmN0aW9uIHRyeUNhdGNoZXIoKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgdmFyIHRhcmdldCA9IHRyeUNhdGNoVGFyZ2V0O1xuICAgICAgICB0cnlDYXRjaFRhcmdldCA9IG51bGw7XG4gICAgICAgIHJldHVybiB0YXJnZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGVycm9yT2JqLmUgPSBlO1xuICAgICAgICByZXR1cm4gZXJyb3JPYmo7XG4gICAgfVxufVxuZnVuY3Rpb24gdHJ5Q2F0Y2goZm4pIHtcbiAgICB0cnlDYXRjaFRhcmdldCA9IGZuO1xuICAgIHJldHVybiB0cnlDYXRjaGVyO1xufVxuXG52YXIgaW5oZXJpdHMgPSBmdW5jdGlvbihDaGlsZCwgUGFyZW50KSB7XG4gICAgdmFyIGhhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eTtcblxuICAgIGZ1bmN0aW9uIFQoKSB7XG4gICAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBDaGlsZDtcbiAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciQgPSBQYXJlbnQ7XG4gICAgICAgIGZvciAodmFyIHByb3BlcnR5TmFtZSBpbiBQYXJlbnQucHJvdG90eXBlKSB7XG4gICAgICAgICAgICBpZiAoaGFzUHJvcC5jYWxsKFBhcmVudC5wcm90b3R5cGUsIHByb3BlcnR5TmFtZSkgJiZcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWUuY2hhckF0KHByb3BlcnR5TmFtZS5sZW5ndGgtMSkgIT09IFwiJFwiXG4gICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRoaXNbcHJvcGVydHlOYW1lICsgXCIkXCJdID0gUGFyZW50LnByb3RvdHlwZVtwcm9wZXJ0eU5hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIFQucHJvdG90eXBlID0gUGFyZW50LnByb3RvdHlwZTtcbiAgICBDaGlsZC5wcm90b3R5cGUgPSBuZXcgVCgpO1xuICAgIHJldHVybiBDaGlsZC5wcm90b3R5cGU7XG59O1xuXG5cbmZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbCkge1xuICAgIHJldHVybiB2YWwgPT0gbnVsbCB8fCB2YWwgPT09IHRydWUgfHwgdmFsID09PSBmYWxzZSB8fFxuICAgICAgICB0eXBlb2YgdmFsID09PSBcInN0cmluZ1wiIHx8IHR5cGVvZiB2YWwgPT09IFwibnVtYmVyXCI7XG5cbn1cblxuZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHtcbiAgICByZXR1cm4gIWlzUHJpbWl0aXZlKHZhbHVlKTtcbn1cblxuZnVuY3Rpb24gbWF5YmVXcmFwQXNFcnJvcihtYXliZUVycm9yKSB7XG4gICAgaWYgKCFpc1ByaW1pdGl2ZShtYXliZUVycm9yKSkgcmV0dXJuIG1heWJlRXJyb3I7XG5cbiAgICByZXR1cm4gbmV3IEVycm9yKHNhZmVUb1N0cmluZyhtYXliZUVycm9yKSk7XG59XG5cbmZ1bmN0aW9uIHdpdGhBcHBlbmRlZCh0YXJnZXQsIGFwcGVuZGVlKSB7XG4gICAgdmFyIGxlbiA9IHRhcmdldC5sZW5ndGg7XG4gICAgdmFyIHJldCA9IG5ldyBBcnJheShsZW4gKyAxKTtcbiAgICB2YXIgaTtcbiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcbiAgICAgICAgcmV0W2ldID0gdGFyZ2V0W2ldO1xuICAgIH1cbiAgICByZXRbaV0gPSBhcHBlbmRlZTtcbiAgICByZXR1cm4gcmV0O1xufVxuXG5mdW5jdGlvbiBnZXREYXRhUHJvcGVydHlPckRlZmF1bHQob2JqLCBrZXksIGRlZmF1bHRWYWx1ZSkge1xuICAgIGlmIChlczUuaXNFUzUpIHtcbiAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTtcblxuICAgICAgICBpZiAoZGVzYyAhPSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVzYy5nZXQgPT0gbnVsbCAmJiBkZXNjLnNldCA9PSBudWxsXG4gICAgICAgICAgICAgICAgICAgID8gZGVzYy52YWx1ZVxuICAgICAgICAgICAgICAgICAgICA6IGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSA/IG9ialtrZXldIDogdW5kZWZpbmVkO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gbm90RW51bWVyYWJsZVByb3Aob2JqLCBuYW1lLCB2YWx1ZSkge1xuICAgIGlmIChpc1ByaW1pdGl2ZShvYmopKSByZXR1cm4gb2JqO1xuICAgIHZhciBkZXNjcmlwdG9yID0ge1xuICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlXG4gICAgfTtcbiAgICBlczUuZGVmaW5lUHJvcGVydHkob2JqLCBuYW1lLCBkZXNjcmlwdG9yKTtcbiAgICByZXR1cm4gb2JqO1xufVxuXG5mdW5jdGlvbiB0aHJvd2VyKHIpIHtcbiAgICB0aHJvdyByO1xufVxuXG52YXIgaW5oZXJpdGVkRGF0YUtleXMgPSAoZnVuY3Rpb24oKSB7XG4gICAgdmFyIGV4Y2x1ZGVkUHJvdG90eXBlcyA9IFtcbiAgICAgICAgQXJyYXkucHJvdG90eXBlLFxuICAgICAgICBPYmplY3QucHJvdG90eXBlLFxuICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGVcbiAgICBdO1xuXG4gICAgdmFyIGlzRXhjbHVkZWRQcm90byA9IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV4Y2x1ZGVkUHJvdG90eXBlcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgaWYgKGV4Y2x1ZGVkUHJvdG90eXBlc1tpXSA9PT0gdmFsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBpZiAoZXM1LmlzRVM1KSB7XG4gICAgICAgIHZhciBnZXRLZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihvYmopIHtcbiAgICAgICAgICAgIHZhciByZXQgPSBbXTtcbiAgICAgICAgICAgIHZhciB2aXNpdGVkS2V5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgICAgICB3aGlsZSAob2JqICE9IG51bGwgJiYgIWlzRXhjbHVkZWRQcm90byhvYmopKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleXM7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAga2V5cyA9IGdldEtleXMob2JqKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpc2l0ZWRLZXlzW2tleV0pIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB2aXNpdGVkS2V5c1trZXldID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc2MgIT0gbnVsbCAmJiBkZXNjLmdldCA9PSBudWxsICYmIGRlc2Muc2V0ID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb2JqID0gZXM1LmdldFByb3RvdHlwZU9mKG9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBoYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHk7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihvYmopIHtcbiAgICAgICAgICAgIGlmIChpc0V4Y2x1ZGVkUHJvdG8ob2JqKSkgcmV0dXJuIFtdO1xuICAgICAgICAgICAgdmFyIHJldCA9IFtdO1xuXG4gICAgICAgICAgICAvKmpzaGludCBmb3JpbjpmYWxzZSAqL1xuICAgICAgICAgICAgZW51bWVyYXRpb246IGZvciAodmFyIGtleSBpbiBvYmopIHtcbiAgICAgICAgICAgICAgICBpZiAoaGFzUHJvcC5jYWxsKG9iaiwga2V5KSkge1xuICAgICAgICAgICAgICAgICAgICByZXQucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXhjbHVkZWRQcm90b3R5cGVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzUHJvcC5jYWxsKGV4Y2x1ZGVkUHJvdG90eXBlc1tpXSwga2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGVudW1lcmF0aW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGtleSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgfTtcbiAgICB9XG5cbn0pKCk7XG5cbnZhciB0aGlzQXNzaWdubWVudFBhdHRlcm4gPSAvdGhpc1xccypcXC5cXHMqXFxTK1xccyo9LztcbmZ1bmN0aW9uIGlzQ2xhc3MoZm4pIHtcbiAgICB0cnkge1xuICAgICAgICBpZiAodHlwZW9mIGZuID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHZhciBrZXlzID0gZXM1Lm5hbWVzKGZuLnByb3RvdHlwZSk7XG5cbiAgICAgICAgICAgIHZhciBoYXNNZXRob2RzID0gZXM1LmlzRVM1ICYmIGtleXMubGVuZ3RoID4gMTtcbiAgICAgICAgICAgIHZhciBoYXNNZXRob2RzT3RoZXJUaGFuQ29uc3RydWN0b3IgPSBrZXlzLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgICAgICAgICAhKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gPT09IFwiY29uc3RydWN0b3JcIik7XG4gICAgICAgICAgICB2YXIgaGFzVGhpc0Fzc2lnbm1lbnRBbmRTdGF0aWNNZXRob2RzID1cbiAgICAgICAgICAgICAgICB0aGlzQXNzaWdubWVudFBhdHRlcm4udGVzdChmbiArIFwiXCIpICYmIGVzNS5uYW1lcyhmbikubGVuZ3RoID4gMDtcblxuICAgICAgICAgICAgaWYgKGhhc01ldGhvZHMgfHwgaGFzTWV0aG9kc090aGVyVGhhbkNvbnN0cnVjdG9yIHx8XG4gICAgICAgICAgICAgICAgaGFzVGhpc0Fzc2lnbm1lbnRBbmRTdGF0aWNNZXRob2RzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gdG9GYXN0UHJvcGVydGllcyhvYmopIHtcbiAgICAvKmpzaGludCAtVzAyNywtVzA1NSwtVzAzMSovXG4gICAgZnVuY3Rpb24gZigpIHt9XG4gICAgZi5wcm90b3R5cGUgPSBvYmo7XG4gICAgdmFyIGwgPSA4O1xuICAgIHdoaWxlIChsLS0pIG5ldyBmKCk7XG4gICAgcmV0dXJuIG9iajtcbiAgICBldmFsKG9iaik7XG59XG5cbnZhciByaWRlbnQgPSAvXlthLXokX11bYS16JF8wLTldKiQvaTtcbmZ1bmN0aW9uIGlzSWRlbnRpZmllcihzdHIpIHtcbiAgICByZXR1cm4gcmlkZW50LnRlc3Qoc3RyKTtcbn1cblxuZnVuY3Rpb24gZmlsbGVkUmFuZ2UoY291bnQsIHByZWZpeCwgc3VmZml4KSB7XG4gICAgdmFyIHJldCA9IG5ldyBBcnJheShjb3VudCk7XG4gICAgZm9yKHZhciBpID0gMDsgaSA8IGNvdW50OyArK2kpIHtcbiAgICAgICAgcmV0W2ldID0gcHJlZml4ICsgaSArIHN1ZmZpeDtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cblxuZnVuY3Rpb24gc2FmZVRvU3RyaW5nKG9iaikge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBvYmogKyBcIlwiO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIFwiW25vIHN0cmluZyByZXByZXNlbnRhdGlvbl1cIjtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihlKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgbm90RW51bWVyYWJsZVByb3AoZSwgXCJpc09wZXJhdGlvbmFsXCIsIHRydWUpO1xuICAgIH1cbiAgICBjYXRjaChpZ25vcmUpIHt9XG59XG5cbmZ1bmN0aW9uIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uKGUpIHtcbiAgICBpZiAoZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuICgoZSBpbnN0YW5jZW9mIEVycm9yW1wiX19CbHVlYmlyZEVycm9yVHlwZXNfX1wiXS5PcGVyYXRpb25hbEVycm9yKSB8fFxuICAgICAgICBlW1wiaXNPcGVyYXRpb25hbFwiXSA9PT0gdHJ1ZSk7XG59XG5cbmZ1bmN0aW9uIGNhbkF0dGFjaFRyYWNlKG9iaikge1xuICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBFcnJvciAmJiBlczUucHJvcGVydHlJc1dyaXRhYmxlKG9iaiwgXCJzdGFja1wiKTtcbn1cblxudmFyIGVuc3VyZUVycm9yT2JqZWN0ID0gKGZ1bmN0aW9uKCkge1xuICAgIGlmICghKFwic3RhY2tcIiBpbiBuZXcgRXJyb3IoKSkpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgICAgICBpZiAoY2FuQXR0YWNoVHJhY2UodmFsdWUpKSByZXR1cm4gdmFsdWU7XG4gICAgICAgICAgICB0cnkge3Rocm93IG5ldyBFcnJvcihzYWZlVG9TdHJpbmcodmFsdWUpKTt9XG4gICAgICAgICAgICBjYXRjaChlcnIpIHtyZXR1cm4gZXJyO31cbiAgICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgICAgIGlmIChjYW5BdHRhY2hUcmFjZSh2YWx1ZSkpIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgIHJldHVybiBuZXcgRXJyb3Ioc2FmZVRvU3RyaW5nKHZhbHVlKSk7XG4gICAgICAgIH07XG4gICAgfVxufSkoKTtcblxuZnVuY3Rpb24gY2xhc3NTdHJpbmcob2JqKSB7XG4gICAgcmV0dXJuIHt9LnRvU3RyaW5nLmNhbGwob2JqKTtcbn1cblxuZnVuY3Rpb24gY29weURlc2NyaXB0b3JzKGZyb20sIHRvLCBmaWx0ZXIpIHtcbiAgICB2YXIga2V5cyA9IGVzNS5uYW1lcyhmcm9tKTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07XG4gICAgICAgIGlmIChmaWx0ZXIoa2V5KSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBlczUuZGVmaW5lUHJvcGVydHkodG8sIGtleSwgZXM1LmdldERlc2NyaXB0b3IoZnJvbSwga2V5KSk7XG4gICAgICAgICAgICB9IGNhdGNoIChpZ25vcmUpIHt9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbnZhciByZXQgPSB7XG4gICAgaXNDbGFzczogaXNDbGFzcyxcbiAgICBpc0lkZW50aWZpZXI6IGlzSWRlbnRpZmllcixcbiAgICBpbmhlcml0ZWREYXRhS2V5czogaW5oZXJpdGVkRGF0YUtleXMsXG4gICAgZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0OiBnZXREYXRhUHJvcGVydHlPckRlZmF1bHQsXG4gICAgdGhyb3dlcjogdGhyb3dlcixcbiAgICBpc0FycmF5OiBlczUuaXNBcnJheSxcbiAgICBoYXZlR2V0dGVyczogaGF2ZUdldHRlcnMsXG4gICAgbm90RW51bWVyYWJsZVByb3A6IG5vdEVudW1lcmFibGVQcm9wLFxuICAgIGlzUHJpbWl0aXZlOiBpc1ByaW1pdGl2ZSxcbiAgICBpc09iamVjdDogaXNPYmplY3QsXG4gICAgY2FuRXZhbHVhdGU6IGNhbkV2YWx1YXRlLFxuICAgIGVycm9yT2JqOiBlcnJvck9iaixcbiAgICB0cnlDYXRjaDogdHJ5Q2F0Y2gsXG4gICAgaW5oZXJpdHM6IGluaGVyaXRzLFxuICAgIHdpdGhBcHBlbmRlZDogd2l0aEFwcGVuZGVkLFxuICAgIG1heWJlV3JhcEFzRXJyb3I6IG1heWJlV3JhcEFzRXJyb3IsXG4gICAgdG9GYXN0UHJvcGVydGllczogdG9GYXN0UHJvcGVydGllcyxcbiAgICBmaWxsZWRSYW5nZTogZmlsbGVkUmFuZ2UsXG4gICAgdG9TdHJpbmc6IHNhZmVUb1N0cmluZyxcbiAgICBjYW5BdHRhY2hUcmFjZTogY2FuQXR0YWNoVHJhY2UsXG4gICAgZW5zdXJlRXJyb3JPYmplY3Q6IGVuc3VyZUVycm9yT2JqZWN0LFxuICAgIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uOiBvcmlnaW5hdGVzRnJvbVJlamVjdGlvbixcbiAgICBtYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb246IG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbixcbiAgICBjbGFzc1N0cmluZzogY2xhc3NTdHJpbmcsXG4gICAgY29weURlc2NyaXB0b3JzOiBjb3B5RGVzY3JpcHRvcnMsXG4gICAgaGFzRGV2VG9vbHM6IHR5cGVvZiBjaHJvbWUgIT09IFwidW5kZWZpbmVkXCIgJiYgY2hyb21lICYmXG4gICAgICAgICAgICAgICAgIHR5cGVvZiBjaHJvbWUubG9hZFRpbWVzID09PSBcImZ1bmN0aW9uXCIsXG4gICAgaXNOb2RlOiB0eXBlb2YgcHJvY2VzcyAhPT0gXCJ1bmRlZmluZWRcIiAmJlxuICAgICAgICBjbGFzc1N0cmluZyhwcm9jZXNzKS50b0xvd2VyQ2FzZSgpID09PSBcIltvYmplY3QgcHJvY2Vzc11cIlxufTtcbnJldC5pc1JlY2VudE5vZGUgPSByZXQuaXNOb2RlICYmIChmdW5jdGlvbigpIHtcbiAgICB2YXIgdmVyc2lvbiA9IHByb2Nlc3MudmVyc2lvbnMubm9kZS5zcGxpdChcIi5cIikubWFwKE51bWJlcik7XG4gICAgcmV0dXJuICh2ZXJzaW9uWzBdID09PSAwICYmIHZlcnNpb25bMV0gPiAxMCkgfHwgKHZlcnNpb25bMF0gPiAwKTtcbn0pKCk7XG5cbmlmIChyZXQuaXNOb2RlKSByZXQudG9GYXN0UHJvcGVydGllcyhwcm9jZXNzKTtcblxudHJ5IHt0aHJvdyBuZXcgRXJyb3IoKTsgfSBjYXRjaCAoZSkge3JldC5sYXN0TGluZUVycm9yID0gZTt9XG5tb2R1bGUuZXhwb3J0cyA9IHJldDtcblxufSx7XCIuL2VzNS5qc1wiOjE0fV19LHt9LFs0XSkoNClcbn0pOyAgICAgICAgICAgICAgICAgICAgO2lmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cgIT09IG51bGwpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LlAgPSB3aW5kb3cuUHJvbWlzZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnICYmIHNlbGYgIT09IG51bGwpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuUCA9IHNlbGYuUHJvbWlzZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9Il19</span>
<span class="hl opt">},{</span><span class="hl str">&quot;_process&quot;</span><span class="hl opt">:</span><span class="hl num">163</span><span class="hl opt">}],</span><span class="hl num">29</span><span class="hl opt">:[</span><span class="hl kwa">function</span><span class="hl opt">(</span>require<span class="hl opt">,</span>module<span class="hl opt">,</span>exports<span class="hl opt">){</span>
<span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>module<span class="hl opt">,</span> exports<span class="hl opt">) {</span>
  <span class="hl str">'use strict'</span><span class="hl opt">;</span>

  <span class="hl slc">// Utils</span>
  <span class="hl kwa">function</span> <span class="hl kwd">assert</span> <span class="hl opt">(</span>val<span class="hl opt">,</span> msg<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>val<span class="hl opt">)</span> <span class="hl kwa">throw new</span> <span class="hl kwd">Error</span><span class="hl opt">(</span>msg <span class="hl opt">||</span> <span class="hl str">'Assertion failed'</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Could use `inherits` module, but don't want to move from single file</span>
  <span class="hl slc">// architecture yet.</span>
  <span class="hl kwa">function</span> <span class="hl kwd">inherits</span> <span class="hl opt">(</span>ctor<span class="hl opt">,</span> superCtor<span class="hl opt">) {</span>
    ctor<span class="hl opt">.</span>super_ <span class="hl opt">=</span> superCtor<span class="hl opt">;</span>
    <span class="hl kwa">var</span> <span class="hl kwd">TempCtor</span> <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">() {};</span>
    TempCtor<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> superCtor<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span>
    ctor<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">TempCtor</span><span class="hl opt">();</span>
    ctor<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>constructor <span class="hl opt">=</span> ctor<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// BN</span>

  <span class="hl kwa">function</span> <span class="hl kwd">BN</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>BN<span class="hl opt">.</span><span class="hl kwd">isBN</span><span class="hl opt">(</span>number<span class="hl opt">)) {</span>
      <span class="hl kwa">return</span> number<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl slc">// Reduction context</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>number <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>base <span class="hl opt">===</span> <span class="hl str">'le'</span> <span class="hl opt">||</span> base <span class="hl opt">===</span> <span class="hl str">'be'</span><span class="hl opt">) {</span>
        endian <span class="hl opt">=</span> base<span class="hl opt">;</span>
        base <span class="hl opt">=</span> <span class="hl num">10</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_init</span><span class="hl opt">(</span>number <span class="hl opt">||</span> <span class="hl num">0</span><span class="hl opt">,</span> base <span class="hl opt">||</span> <span class="hl num">10</span><span class="hl opt">,</span> endian <span class="hl opt">||</span> <span class="hl str">'be'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> module <span class="hl opt">===</span> <span class="hl str">'object'</span><span class="hl opt">) {</span>
    module<span class="hl opt">.</span>exports <span class="hl opt">=</span> BN<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    exports<span class="hl opt">.</span>BN <span class="hl opt">=</span> BN<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span>BN <span class="hl opt">=</span> BN<span class="hl opt">;</span>
  BN<span class="hl opt">.</span>wordSize <span class="hl opt">=</span> <span class="hl num">26</span><span class="hl opt">;</span>

  <span class="hl kwa">var</span> Buffer<span class="hl opt">;</span>
  <span class="hl kwa">try</span> <span class="hl opt">{</span>
    Buffer <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'buf'</span> <span class="hl opt">+</span> <span class="hl str">'fer'</span><span class="hl opt">).</span>Buffer<span class="hl opt">;</span>
  <span class="hl opt">}</span> <span class="hl kwa">catch</span> <span class="hl opt">(</span>e<span class="hl opt">) {</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span>isBN <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isBN</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return</span> num <span class="hl opt">!==</span> <span class="hl kwa">null</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> num <span class="hl opt">===</span> <span class="hl str">'object'</span> <span class="hl opt">&amp;&amp;</span>
      num<span class="hl opt">.</span>constructor<span class="hl opt">.</span>name <span class="hl opt">===</span> <span class="hl str">'BN'</span> <span class="hl opt">&amp;&amp;</span> Array<span class="hl opt">.</span><span class="hl kwd">isArray</span><span class="hl opt">(</span>num<span class="hl opt">.</span>words<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span>max <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">max</span> <span class="hl opt">(</span>left<span class="hl opt">,</span> right<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>left<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>right<span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> left<span class="hl opt">;</span>
    <span class="hl kwa">return</span> right<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span>min <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">min</span> <span class="hl opt">(</span>left<span class="hl opt">,</span> right<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>left<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>right<span class="hl opt">) &lt;</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> left<span class="hl opt">;</span>
    <span class="hl kwa">return</span> right<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_init <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">init</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> number <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_initNumber</span><span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> number <span class="hl opt">===</span> <span class="hl str">'object'</span><span class="hl opt">) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_initArray</span><span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>base <span class="hl opt">===</span> <span class="hl str">'hex'</span><span class="hl opt">) {</span>
      base <span class="hl opt">=</span> <span class="hl num">16</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>base <span class="hl opt">=== (</span>base <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">) &amp;&amp;</span> base <span class="hl opt">&gt;=</span> <span class="hl num">2</span> <span class="hl opt">&amp;&amp;</span> base <span class="hl opt">&lt;=</span> <span class="hl num">36</span><span class="hl opt">);</span>

    number <span class="hl opt">=</span> number<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">().</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl kwc">/\s+/g</span><span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> start <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>number<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl str">'-'</span><span class="hl opt">) {</span>
      start<span class="hl opt">++;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>base <span class="hl opt">===</span> <span class="hl num">16</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_parseHex</span><span class="hl opt">(</span>number<span class="hl opt">,</span> start<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_parseBase</span><span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> start<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>number<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl str">'-'</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>endian <span class="hl opt">!==</span> <span class="hl str">'le'</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_initArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">toArray</span><span class="hl opt">(),</span> base<span class="hl opt">,</span> endian<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_initNumber <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_initNumber</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>number <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      number <span class="hl opt">= -</span>number<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>number <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">= [</span> number <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span> <span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>number <span class="hl opt">&lt;</span> <span class="hl num">0x10000000000000</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">= [</span>
        number <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">,</span>
        <span class="hl opt">(</span>number <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span>
      <span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwd">assert</span><span class="hl opt">(</span>number <span class="hl opt">&lt;</span> <span class="hl num">0x20000000000000</span><span class="hl opt">);</span> <span class="hl slc">// 2 ^ 53 (unsafe)</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">= [</span>
        number <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">,</span>
        <span class="hl opt">(</span>number <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">,</span>
        <span class="hl num">1</span>
      <span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>endian <span class="hl opt">!==</span> <span class="hl str">'le'</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

    <span class="hl slc">// Reverse the bytes</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_initArray</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">toArray</span><span class="hl opt">(),</span> base<span class="hl opt">,</span> endian<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_initArray <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_initArray</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> endian<span class="hl opt">) {</span>
    <span class="hl slc">// Perhaps a Uint8Array</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> number<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>number<span class="hl opt">.</span>length <span class="hl opt">&lt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">= [</span> <span class="hl num">0</span> <span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">ceil</span><span class="hl opt">(</span>number<span class="hl opt">.</span>length <span class="hl opt">/</span> <span class="hl num">3</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> j<span class="hl opt">,</span> w<span class="hl opt">;</span>
    <span class="hl kwa">var</span> off <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>endian <span class="hl opt">===</span> <span class="hl str">'be'</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> number<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">,</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">-=</span> <span class="hl num">3</span><span class="hl opt">) {</span>
        w <span class="hl opt">=</span> number<span class="hl opt">[</span>i<span class="hl opt">] | (</span>number<span class="hl opt">[</span>i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] &lt;&lt;</span> <span class="hl num">8</span><span class="hl opt">) | (</span>number<span class="hl opt">[</span>i <span class="hl opt">-</span> <span class="hl num">2</span><span class="hl opt">] &lt;&lt;</span> <span class="hl num">16</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |= (</span>w <span class="hl opt">&lt;&lt;</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] = (</span>w <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> off<span class="hl opt">)) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        off <span class="hl opt">+=</span> <span class="hl num">24</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>off <span class="hl opt">&gt;=</span> <span class="hl num">26</span><span class="hl opt">) {</span>
          off <span class="hl opt">-=</span> <span class="hl num">26</span><span class="hl opt">;</span>
          j<span class="hl opt">++;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>endian <span class="hl opt">===</span> <span class="hl str">'le'</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> number<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">+=</span> <span class="hl num">3</span><span class="hl opt">) {</span>
        w <span class="hl opt">=</span> number<span class="hl opt">[</span>i<span class="hl opt">] | (</span>number<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] &lt;&lt;</span> <span class="hl num">8</span><span class="hl opt">) | (</span>number<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">] &lt;&lt;</span> <span class="hl num">16</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |= (</span>w <span class="hl opt">&lt;&lt;</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] = (</span>w <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> off<span class="hl opt">)) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        off <span class="hl opt">+=</span> <span class="hl num">24</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>off <span class="hl opt">&gt;=</span> <span class="hl num">26</span><span class="hl opt">) {</span>
          off <span class="hl opt">-=</span> <span class="hl num">26</span><span class="hl opt">;</span>
          j<span class="hl opt">++;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">function</span> <span class="hl kwd">parseHex</span> <span class="hl opt">(</span>str<span class="hl opt">,</span> start<span class="hl opt">,</span> end<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>str<span class="hl opt">.</span>length<span class="hl opt">,</span> end<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> start<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> c <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">charCodeAt</span><span class="hl opt">(</span>i<span class="hl opt">) -</span> <span class="hl num">48</span><span class="hl opt">;</span>

      r <span class="hl opt">&lt;&lt;=</span> <span class="hl num">4</span><span class="hl opt">;</span>

      <span class="hl slc">// 'a' - 'f'</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>c <span class="hl opt">&gt;=</span> <span class="hl num">49</span> <span class="hl opt">&amp;&amp;</span> c <span class="hl opt">&lt;=</span> <span class="hl num">54</span><span class="hl opt">) {</span>
        r <span class="hl opt">|=</span> c <span class="hl opt">-</span> <span class="hl num">49</span> <span class="hl opt">+</span> <span class="hl num">0xa</span><span class="hl opt">;</span>

      <span class="hl slc">// 'A' - 'F'</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>c <span class="hl opt">&gt;=</span> <span class="hl num">17</span> <span class="hl opt">&amp;&amp;</span> c <span class="hl opt">&lt;=</span> <span class="hl num">22</span><span class="hl opt">) {</span>
        r <span class="hl opt">|=</span> c <span class="hl opt">-</span> <span class="hl num">17</span> <span class="hl opt">+</span> <span class="hl num">0xa</span><span class="hl opt">;</span>

      <span class="hl slc">// '0' - '9'</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        r <span class="hl opt">|=</span> c <span class="hl opt">&amp;</span> <span class="hl num">0xf</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> r<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_parseHex <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_parseHex</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> start<span class="hl opt">) {</span>
    <span class="hl slc">// Create possibly bigger array to ensure that it fits the number</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">ceil</span><span class="hl opt">((</span>number<span class="hl opt">.</span>length <span class="hl opt">-</span> start<span class="hl opt">) /</span> <span class="hl num">6</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> j<span class="hl opt">,</span> w<span class="hl opt">;</span>
    <span class="hl slc">// Scan 24-bit chunks and add them to the number</span>
    <span class="hl kwa">var</span> off <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> number<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">6</span><span class="hl opt">,</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> start<span class="hl opt">;</span> i <span class="hl opt">-=</span> <span class="hl num">6</span><span class="hl opt">) {</span>
      w <span class="hl opt">=</span> <span class="hl kwd">parseHex</span><span class="hl opt">(</span>number<span class="hl opt">,</span> i<span class="hl opt">,</span> i <span class="hl opt">+</span> <span class="hl num">6</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |= (</span>w <span class="hl opt">&lt;&lt;</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] |=</span> w <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3fffff</span><span class="hl opt">;</span>
      off <span class="hl opt">+=</span> <span class="hl num">24</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>off <span class="hl opt">&gt;=</span> <span class="hl num">26</span><span class="hl opt">) {</span>
        off <span class="hl opt">-=</span> <span class="hl num">26</span><span class="hl opt">;</span>
        j<span class="hl opt">++;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">+</span> <span class="hl num">6</span> <span class="hl opt">!==</span> start<span class="hl opt">) {</span>
      w <span class="hl opt">=</span> <span class="hl kwd">parseHex</span><span class="hl opt">(</span>number<span class="hl opt">,</span> start<span class="hl opt">,</span> i <span class="hl opt">+</span> <span class="hl num">6</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |= (</span>w <span class="hl opt">&lt;&lt;</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>j <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] |=</span> w <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> off<span class="hl opt">) &amp;</span> <span class="hl num">0x3fffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">function</span> <span class="hl kwd">parseBase</span> <span class="hl opt">(</span>str<span class="hl opt">,</span> start<span class="hl opt">,</span> end<span class="hl opt">,</span> mul<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>str<span class="hl opt">.</span>length<span class="hl opt">,</span> end<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> start<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> c <span class="hl opt">=</span> str<span class="hl opt">.</span><span class="hl kwd">charCodeAt</span><span class="hl opt">(</span>i<span class="hl opt">) -</span> <span class="hl num">48</span><span class="hl opt">;</span>

      r <span class="hl opt">*=</span> mul<span class="hl opt">;</span>

      <span class="hl slc">// 'a'</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>c <span class="hl opt">&gt;=</span> <span class="hl num">49</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> c <span class="hl opt">-</span> <span class="hl num">49</span> <span class="hl opt">+</span> <span class="hl num">0xa</span><span class="hl opt">;</span>

      <span class="hl slc">// 'A'</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>c <span class="hl opt">&gt;=</span> <span class="hl num">17</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> c <span class="hl opt">-</span> <span class="hl num">17</span> <span class="hl opt">+</span> <span class="hl num">0xa</span><span class="hl opt">;</span>

      <span class="hl slc">// '0' - '9'</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        r <span class="hl opt">+=</span> c<span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> r<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_parseBase <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_parseBase</span> <span class="hl opt">(</span>number<span class="hl opt">,</span> base<span class="hl opt">,</span> start<span class="hl opt">) {</span>
    <span class="hl slc">// Initialize as zero</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>words <span class="hl opt">= [</span> <span class="hl num">0</span> <span class="hl opt">];</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl slc">// Find length of limb in base</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> limbLen <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> limbPow <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> limbPow <span class="hl opt">&lt;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span> limbPow <span class="hl opt">*=</span> base<span class="hl opt">) {</span>
      limbLen<span class="hl opt">++;</span>
    <span class="hl opt">}</span>
    limbLen<span class="hl opt">--;</span>
    limbPow <span class="hl opt">= (</span>limbPow <span class="hl opt">/</span> base<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> total <span class="hl opt">=</span> number<span class="hl opt">.</span>length <span class="hl opt">-</span> start<span class="hl opt">;</span>
    <span class="hl kwa">var</span> mod <span class="hl opt">=</span> total <span class="hl opt">%</span> limbLen<span class="hl opt">;</span>
    <span class="hl kwa">var</span> end <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>total<span class="hl opt">,</span> total <span class="hl opt">-</span> mod<span class="hl opt">) +</span> start<span class="hl opt">;</span>

    <span class="hl kwa">var</span> word <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> start<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> end<span class="hl opt">;</span> i <span class="hl opt">+=</span> limbLen<span class="hl opt">) {</span>
      word <span class="hl opt">=</span> <span class="hl kwd">parseBase</span><span class="hl opt">(</span>number<span class="hl opt">,</span> i<span class="hl opt">,</span> i <span class="hl opt">+</span> limbLen<span class="hl opt">,</span> base<span class="hl opt">);</span>

      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">imuln</span><span class="hl opt">(</span>limbPow<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] +</span> word <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] +=</span> word<span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_iaddn</span><span class="hl opt">(</span>word<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>mod <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">var</span> pow <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      word <span class="hl opt">=</span> <span class="hl kwd">parseBase</span><span class="hl opt">(</span>number<span class="hl opt">,</span> i<span class="hl opt">,</span> number<span class="hl opt">.</span>length<span class="hl opt">,</span> base<span class="hl opt">);</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> mod<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        pow <span class="hl opt">*=</span> base<span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">imuln</span><span class="hl opt">(</span>pow<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] +</span> word <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] +=</span> word<span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_iaddn</span><span class="hl opt">(</span>word<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>copy <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">copy</span> <span class="hl opt">(</span>dest<span class="hl opt">) {</span>
    dest<span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      dest<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>
    dest<span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span>
    dest<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>negative<span class="hl opt">;</span>
    dest<span class="hl opt">.</span>red <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>clone <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">clone</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">copy</span><span class="hl opt">(</span>r<span class="hl opt">);</span>
    <span class="hl kwa">return</span> r<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_expand <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_expand</span> <span class="hl opt">(</span>size<span class="hl opt">) {</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&lt;</span> size<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Remove leading `0` from `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>strip <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">strip</span> <span class="hl opt">() {</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">--;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_normSign</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_normSign <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_normSign</span> <span class="hl opt">() {</span>
    <span class="hl slc">// -0 = 0</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>inspect <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">inspect</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red <span class="hl opt">?</span> <span class="hl str">'&lt;BN-R: '</span> <span class="hl opt">:</span> <span class="hl str">'&lt;BN: '</span><span class="hl opt">) +</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">) +</span> <span class="hl str">'&gt;'</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl com">/*</span>
<span class="hl com"></span>
<span class="hl com">  var zeros = [];</span>
<span class="hl com">  var groupSizes = [];</span>
<span class="hl com">  var groupBases = [];</span>
<span class="hl com"></span>
<span class="hl com">  var s = '';</span>
<span class="hl com">  var i = -1;</span>
<span class="hl com">  while (++i &lt; BN.wordSize) {</span>
<span class="hl com">    zeros[i] = s;</span>
<span class="hl com">    s += '0';</span>
<span class="hl com">  }</span>
<span class="hl com">  groupSizes[0] = 0;</span>
<span class="hl com">  groupSizes[1] = 0;</span>
<span class="hl com">  groupBases[0] = 0;</span>
<span class="hl com">  groupBases[1] = 0;</span>
<span class="hl com">  var base = 2 - 1;</span>
<span class="hl com">  while (++base &lt; 36 + 1) {</span>
<span class="hl com">    var groupSize = 0;</span>
<span class="hl com">    var groupBase = 1;</span>
<span class="hl com">    while (groupBase &lt; (1 &lt;&lt; BN.wordSize) / base) {</span>
<span class="hl com">      groupBase *= base;</span>
<span class="hl com">      groupSize += 1;</span>
<span class="hl com">    }</span>
<span class="hl com">    groupSizes[base] = groupSize;</span>
<span class="hl com">    groupBases[base] = groupBase;</span>
<span class="hl com">  }</span>
<span class="hl com"></span>
<span class="hl com">  */</span>

  <span class="hl kwa">var</span> zeros <span class="hl opt">= [</span>
    <span class="hl str">''</span><span class="hl opt">,</span>
    <span class="hl str">'0'</span><span class="hl opt">,</span>
    <span class="hl str">'00'</span><span class="hl opt">,</span>
    <span class="hl str">'000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'00000000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'000000000000000000000000'</span><span class="hl opt">,</span>
    <span class="hl str">'0000000000000000000000000'</span>
  <span class="hl opt">];</span>

  <span class="hl kwa">var</span> groupSizes <span class="hl opt">= [</span>
    <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span>
    <span class="hl num">25</span><span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">,</span> <span class="hl num">11</span><span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">,</span> <span class="hl num">9</span><span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">,</span>
    <span class="hl num">8</span><span class="hl opt">,</span> <span class="hl num">7</span><span class="hl opt">,</span> <span class="hl num">7</span><span class="hl opt">,</span> <span class="hl num">7</span><span class="hl opt">,</span> <span class="hl num">7</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span>
    <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">6</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span>
    <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span>
    <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span><span class="hl opt">,</span> <span class="hl num">5</span>
  <span class="hl opt">];</span>

  <span class="hl kwa">var</span> groupBases <span class="hl opt">= [</span>
    <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span>
    <span class="hl num">33554432</span><span class="hl opt">,</span> <span class="hl num">43046721</span><span class="hl opt">,</span> <span class="hl num">16777216</span><span class="hl opt">,</span> <span class="hl num">48828125</span><span class="hl opt">,</span> <span class="hl num">60466176</span><span class="hl opt">,</span> <span class="hl num">40353607</span><span class="hl opt">,</span> <span class="hl num">16777216</span><span class="hl opt">,</span>
    <span class="hl num">43046721</span><span class="hl opt">,</span> <span class="hl num">10000000</span><span class="hl opt">,</span> <span class="hl num">19487171</span><span class="hl opt">,</span> <span class="hl num">35831808</span><span class="hl opt">,</span> <span class="hl num">62748517</span><span class="hl opt">,</span> <span class="hl num">7529536</span><span class="hl opt">,</span> <span class="hl num">11390625</span><span class="hl opt">,</span>
    <span class="hl num">16777216</span><span class="hl opt">,</span> <span class="hl num">24137569</span><span class="hl opt">,</span> <span class="hl num">34012224</span><span class="hl opt">,</span> <span class="hl num">47045881</span><span class="hl opt">,</span> <span class="hl num">64000000</span><span class="hl opt">,</span> <span class="hl num">4084101</span><span class="hl opt">,</span> <span class="hl num">5153632</span><span class="hl opt">,</span>
    <span class="hl num">6436343</span><span class="hl opt">,</span> <span class="hl num">7962624</span><span class="hl opt">,</span> <span class="hl num">9765625</span><span class="hl opt">,</span> <span class="hl num">11881376</span><span class="hl opt">,</span> <span class="hl num">14348907</span><span class="hl opt">,</span> <span class="hl num">17210368</span><span class="hl opt">,</span> <span class="hl num">20511149</span><span class="hl opt">,</span>
    <span class="hl num">24300000</span><span class="hl opt">,</span> <span class="hl num">28629151</span><span class="hl opt">,</span> <span class="hl num">33554432</span><span class="hl opt">,</span> <span class="hl num">39135393</span><span class="hl opt">,</span> <span class="hl num">45435424</span><span class="hl opt">,</span> <span class="hl num">52521875</span><span class="hl opt">,</span> <span class="hl num">60466176</span>
  <span class="hl opt">];</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toString <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toString</span> <span class="hl opt">(</span>base<span class="hl opt">,</span> padding<span class="hl opt">) {</span>
    base <span class="hl opt">=</span> base <span class="hl opt">||</span> <span class="hl num">10</span><span class="hl opt">;</span>
    padding <span class="hl opt">=</span> padding <span class="hl opt">|</span> <span class="hl num">0</span> <span class="hl opt">||</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> out<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>base <span class="hl opt">===</span> <span class="hl num">16</span> <span class="hl opt">||</span> base <span class="hl opt">===</span> <span class="hl str">'hex'</span><span class="hl opt">) {</span>
      out <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> off <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
        <span class="hl kwa">var</span> word <span class="hl opt">= (((</span>w <span class="hl opt">&lt;&lt;</span> off<span class="hl opt">) |</span> carry<span class="hl opt">) &amp;</span> <span class="hl num">0xffffff</span><span class="hl opt">).</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">);</span>
        carry <span class="hl opt">= (</span>w <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">24</span> <span class="hl opt">-</span> off<span class="hl opt">)) &amp;</span> <span class="hl num">0xffffff</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">||</span> i <span class="hl opt">!==</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) {</span>
          out <span class="hl opt">=</span> zeros<span class="hl opt">[</span><span class="hl num">6</span> <span class="hl opt">-</span> word<span class="hl opt">.</span>length<span class="hl opt">] +</span> word <span class="hl opt">+</span> out<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          out <span class="hl opt">=</span> word <span class="hl opt">+</span> out<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        off <span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>off <span class="hl opt">&gt;=</span> <span class="hl num">26</span><span class="hl opt">) {</span>
          off <span class="hl opt">-=</span> <span class="hl num">26</span><span class="hl opt">;</span>
          i<span class="hl opt">--;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        out <span class="hl opt">=</span> carry<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">) +</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>out<span class="hl opt">.</span>length <span class="hl opt">%</span> padding <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        out <span class="hl opt">=</span> <span class="hl str">'0'</span> <span class="hl opt">+</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        out <span class="hl opt">=</span> <span class="hl str">'-'</span> <span class="hl opt">+</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> out<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>base <span class="hl opt">=== (</span>base <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">) &amp;&amp;</span> base <span class="hl opt">&gt;=</span> <span class="hl num">2</span> <span class="hl opt">&amp;&amp;</span> base <span class="hl opt">&lt;=</span> <span class="hl num">36</span><span class="hl opt">) {</span>
      <span class="hl slc">// var groupSize = Math.floor(BN.wordSize * Math.LN2 / Math.log(base));</span>
      <span class="hl kwa">var</span> groupSize <span class="hl opt">=</span> groupSizes<span class="hl opt">[</span>base<span class="hl opt">];</span>
      <span class="hl slc">// var groupBase = Math.pow(base, groupSize);</span>
      <span class="hl kwa">var</span> groupBase <span class="hl opt">=</span> groupBases<span class="hl opt">[</span>base<span class="hl opt">];</span>
      out <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> c <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
      c<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">while</span> <span class="hl opt">(!</span>c<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
        <span class="hl kwa">var</span> r <span class="hl opt">=</span> c<span class="hl opt">.</span><span class="hl kwd">modn</span><span class="hl opt">(</span>groupBase<span class="hl opt">).</span><span class="hl kwd">toString</span><span class="hl opt">(</span>base<span class="hl opt">);</span>
        c <span class="hl opt">=</span> c<span class="hl opt">.</span><span class="hl kwd">idivn</span><span class="hl opt">(</span>groupBase<span class="hl opt">);</span>

        <span class="hl kwa">if</span> <span class="hl opt">(!</span>c<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
          out <span class="hl opt">=</span> zeros<span class="hl opt">[</span>groupSize <span class="hl opt">-</span> r<span class="hl opt">.</span>length<span class="hl opt">] +</span> r <span class="hl opt">+</span> out<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          out <span class="hl opt">=</span> r <span class="hl opt">+</span> out<span class="hl opt">;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
        out <span class="hl opt">=</span> <span class="hl str">'0'</span> <span class="hl opt">+</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>out<span class="hl opt">.</span>length <span class="hl opt">%</span> padding <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        out <span class="hl opt">=</span> <span class="hl str">'0'</span> <span class="hl opt">+</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        out <span class="hl opt">=</span> <span class="hl str">'-'</span> <span class="hl opt">+</span> out<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> out<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl str">'Base should be between 2 and 36'</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toNumber <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toNumber</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> length <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">bitLength</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> ret<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>length <span class="hl opt">&lt;=</span> <span class="hl num">26</span><span class="hl opt">) {</span>
      ret <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>length <span class="hl opt">&lt;=</span> <span class="hl num">52</span><span class="hl opt">) {</span>
      ret <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] *</span> <span class="hl num">0x4000000</span><span class="hl opt">) +</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>length <span class="hl opt">===</span> <span class="hl num">53</span><span class="hl opt">) {</span>
      <span class="hl slc">// NOTE: at this stage it is known that the top bit is set</span>
      ret <span class="hl opt">=</span> <span class="hl num">0x10000000000000</span> <span class="hl opt">+ (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] *</span> <span class="hl num">0x4000000</span><span class="hl opt">) +</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl str">'Number can only safely store up to 53 bits'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) ? -</span>ret <span class="hl opt">:</span> ret<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toJSON <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toJSON</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toBuffer <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toBuffer</span> <span class="hl opt">(</span>endian<span class="hl opt">,</span> length<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> Buffer <span class="hl opt">!==</span> <span class="hl str">'undefined'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">toArrayLike</span><span class="hl opt">(</span>Buffer<span class="hl opt">,</span> endian<span class="hl opt">,</span> length<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toArray <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toArray</span> <span class="hl opt">(</span>endian<span class="hl opt">,</span> length<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">toArrayLike</span><span class="hl opt">(</span>Array<span class="hl opt">,</span> endian<span class="hl opt">,</span> length<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toArrayLike <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toArrayLike</span> <span class="hl opt">(</span>ArrayType<span class="hl opt">,</span> endian<span class="hl opt">,</span> length<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> byteLength <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">byteLength</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> reqLength <span class="hl opt">=</span> length <span class="hl opt">||</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">,</span> byteLength<span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>byteLength <span class="hl opt">&lt;=</span> reqLength<span class="hl opt">,</span> <span class="hl str">'byte array longer than desired length'</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>reqLength <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">'Requested array length &lt;= 0'</span><span class="hl opt">);</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> littleEndian <span class="hl opt">=</span> endian <span class="hl opt">===</span> <span class="hl str">'le'</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ArrayType</span><span class="hl opt">(</span>reqLength<span class="hl opt">);</span>

    <span class="hl kwa">var</span> b<span class="hl opt">,</span> i<span class="hl opt">;</span>
    <span class="hl kwa">var</span> q <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span>littleEndian<span class="hl opt">) {</span>
      <span class="hl slc">// Assume big-endian</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> reqLength <span class="hl opt">-</span> byteLength<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        res<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>q<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">();</span> i<span class="hl opt">++) {</span>
        b <span class="hl opt">=</span> q<span class="hl opt">.</span><span class="hl kwd">andln</span><span class="hl opt">(</span><span class="hl num">0xff</span><span class="hl opt">);</span>
        q<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">);</span>

        res<span class="hl opt">[</span>reqLength <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] =</span> b<span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">; !</span>q<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">();</span> i<span class="hl opt">++) {</span>
        b <span class="hl opt">=</span> q<span class="hl opt">.</span><span class="hl kwd">andln</span><span class="hl opt">(</span><span class="hl num">0xff</span><span class="hl opt">);</span>
        q<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">);</span>

        res<span class="hl opt">[</span>i<span class="hl opt">] =</span> b<span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> reqLength<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        res<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span>Math<span class="hl opt">.</span>clz32<span class="hl opt">) {</span>
    BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_countBits <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_countBits</span> <span class="hl opt">(</span>w<span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl num">32</span> <span class="hl opt">-</span> Math<span class="hl opt">.</span><span class="hl kwd">clz32</span><span class="hl opt">(</span>w<span class="hl opt">);</span>
    <span class="hl opt">};</span>
  <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
    BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_countBits <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_countBits</span> <span class="hl opt">(</span>w<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> t <span class="hl opt">=</span> w<span class="hl opt">;</span>
      <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>t <span class="hl opt">&gt;=</span> <span class="hl num">0x1000</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> <span class="hl num">13</span><span class="hl opt">;</span>
        t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">13</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>t <span class="hl opt">&gt;=</span> <span class="hl num">0x40</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> <span class="hl num">7</span><span class="hl opt">;</span>
        t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">7</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>t <span class="hl opt">&gt;=</span> <span class="hl num">0x8</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> <span class="hl num">4</span><span class="hl opt">;</span>
        t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">4</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>t <span class="hl opt">&gt;=</span> <span class="hl num">0x02</span><span class="hl opt">) {</span>
        r <span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">;</span>
        t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">2</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> r <span class="hl opt">+</span> t<span class="hl opt">;</span>
    <span class="hl opt">};</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_zeroBits <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_zeroBits</span> <span class="hl opt">(</span>w<span class="hl opt">) {</span>
    <span class="hl slc">// Short-cut</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>w <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">26</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> t <span class="hl opt">=</span> w<span class="hl opt">;</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>t <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      r <span class="hl opt">+=</span> <span class="hl num">13</span><span class="hl opt">;</span>
      t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>t <span class="hl opt">&amp;</span> <span class="hl num">0x7f</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      r <span class="hl opt">+=</span> <span class="hl num">7</span><span class="hl opt">;</span>
      t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">7</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>t <span class="hl opt">&amp;</span> <span class="hl num">0xf</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      r <span class="hl opt">+=</span> <span class="hl num">4</span><span class="hl opt">;</span>
      t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">4</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>t <span class="hl opt">&amp;</span> <span class="hl num">0x3</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      r <span class="hl opt">+=</span> <span class="hl num">2</span><span class="hl opt">;</span>
      t <span class="hl opt">&gt;&gt;&gt;=</span> <span class="hl num">2</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>t <span class="hl opt">&amp;</span> <span class="hl num">0x1</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      r<span class="hl opt">++;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> r<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Return number of used bits in a BN</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>bitLength <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">bitLength</span> <span class="hl opt">() {</span>
    <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
    <span class="hl kwa">var</span> hi <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_countBits</span><span class="hl opt">(</span>w<span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) *</span> <span class="hl num">26</span> <span class="hl opt">+</span> hi<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">function</span> <span class="hl kwd">toBitArray</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>num<span class="hl opt">.</span><span class="hl kwd">bitLength</span><span class="hl opt">());</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> bit <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> bit <span class="hl opt">&lt;</span> w<span class="hl opt">.</span>length<span class="hl opt">;</span> bit<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> off <span class="hl opt">= (</span>bit <span class="hl opt">/</span> <span class="hl num">26</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> wbit <span class="hl opt">=</span> bit <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>

      w<span class="hl opt">[</span>bit<span class="hl opt">] = (</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span>off<span class="hl opt">] &amp; (</span><span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> wbit<span class="hl opt">)) &gt;&gt;&gt;</span> wbit<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> w<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Number of trailing zero bits</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>zeroBits <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">zeroBits</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">())</span> <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> b <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_zeroBits</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">]);</span>
      r <span class="hl opt">+=</span> b<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>b <span class="hl opt">!==</span> <span class="hl num">26</span><span class="hl opt">)</span> <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> r<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>byteLength <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">byteLength</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> Math<span class="hl opt">.</span><span class="hl kwd">ceil</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">bitLength</span><span class="hl opt">() /</span> <span class="hl num">8</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toTwos <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toTwos</span> <span class="hl opt">(</span>width<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">abs</span><span class="hl opt">().</span><span class="hl kwd">inotn</span><span class="hl opt">(</span>width<span class="hl opt">).</span><span class="hl kwd">iaddn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>fromTwos <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">fromTwos</span> <span class="hl opt">(</span>width<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">testn</span><span class="hl opt">(</span>width <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">)) {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">notn</span><span class="hl opt">(</span>width<span class="hl opt">).</span><span class="hl kwd">iaddn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">ineg</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isNeg <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isNeg</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Return negative clone of `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>neg <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">neg</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ineg</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ineg <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ineg</span> <span class="hl opt">() {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">^=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Or `num` with `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iuor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iuor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&lt;</span> num<span class="hl opt">.</span>length<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ior <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ior</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">|</span> num<span class="hl opt">.</span>negative<span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iuor</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Or `num` with `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>or <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">or</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ior</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ior</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>uor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">uor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuor</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuor</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// And `num` with `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iuand <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iuand</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl slc">// b = min-length(num, this)</span>
    <span class="hl kwa">var</span> b<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">) {</span>
      b <span class="hl opt">=</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      b <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &amp;</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iand <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iand</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">|</span> num<span class="hl opt">.</span>negative<span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iuand</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// And `num` with `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>and <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">and</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iand</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iand</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>uand <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">uand</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuand</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuand</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Xor `num` with `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iuxor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iuxor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl slc">// a.length &gt; b.length</span>
    <span class="hl kwa">var</span> a<span class="hl opt">;</span>
    <span class="hl kwa">var</span> b<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">) {</span>
      a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
      b <span class="hl opt">=</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      a <span class="hl opt">=</span> num<span class="hl opt">;</span>
      b <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] ^</span> b<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span> <span class="hl opt">!==</span> a<span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ixor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ixor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">|</span> num<span class="hl opt">.</span>negative<span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iuxor</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Xor `num` with `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>xor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">xor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ixor</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ixor</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>uxor <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">uxor</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuxor</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iuxor</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Not ``this`` with ``width`` bitwidth</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>inotn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">inotn</span> <span class="hl opt">(</span>width<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> width <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> width <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> bytesNeeded <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">ceil</span><span class="hl opt">(</span>width <span class="hl opt">/</span> <span class="hl num">26</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bitsLeft <span class="hl opt">=</span> width <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>

    <span class="hl slc">// Extend the buffer with leading zeroes</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_expand</span><span class="hl opt">(</span>bytesNeeded<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>bitsLeft <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      bytesNeeded<span class="hl opt">--;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Handle complete words</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> bytesNeeded<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] = ~</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Handle the residue</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>bitsLeft <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] = ~</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &amp; (</span><span class="hl num">0x3ffffff</span> <span class="hl opt">&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> bitsLeft<span class="hl opt">));</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// And remove leading zeroes</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>notn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">notn</span> <span class="hl opt">(</span>width<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">inotn</span><span class="hl opt">(</span>width<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Set `bit` of `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>setn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">setn</span> <span class="hl opt">(</span>bit<span class="hl opt">,</span> val<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bit <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> bit <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> off <span class="hl opt">= (</span>bit <span class="hl opt">/</span> <span class="hl num">26</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> wbit <span class="hl opt">=</span> bit <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_expand</span><span class="hl opt">(</span>off <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>val<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>off<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>off<span class="hl opt">] | (</span><span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> wbit<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>off<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>off<span class="hl opt">] &amp; ~(</span><span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> wbit<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Add `num` to `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iadd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iadd</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> r<span class="hl opt">;</span>

    <span class="hl slc">// negative + positive</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      r <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">^=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_normSign</span><span class="hl opt">();</span>

    <span class="hl slc">// positive + negative</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      r <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return</span> r<span class="hl opt">.</span><span class="hl kwd">_normSign</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// a.length &gt; b.length</span>
    <span class="hl kwa">var</span> a<span class="hl opt">,</span> b<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">) {</span>
      a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
      b <span class="hl opt">=</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      a <span class="hl opt">=</span> num<span class="hl opt">;</span>
      b <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      r <span class="hl opt">= (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) + (</span>b<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      carry <span class="hl opt">=</span> r <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span> <span class="hl opt">(;</span> carry <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      r <span class="hl opt">= (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      carry <span class="hl opt">=</span> r <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">] =</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++;</span>
    <span class="hl slc">// Copy the rest of the words</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>a <span class="hl opt">!==</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Add `num` to `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>add <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">add</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> res<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">sub</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">^=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return</span> res<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      res <span class="hl opt">=</span> num<span class="hl opt">.</span><span class="hl kwd">sub</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return</span> res<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>num<span class="hl opt">);</span>

    <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iadd</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Subtract `num` from `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isub <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isub</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl slc">// this - (-num) = this + num</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> r <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      num<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return</span> r<span class="hl opt">.</span><span class="hl kwd">_normSign</span><span class="hl opt">();</span>

    <span class="hl slc">// -this - num = -(this + num)</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_normSign</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// At this point both numbers are positive</span>
    <span class="hl kwa">var</span> cmp <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">);</span>

    <span class="hl slc">// Optimization - zeroify</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>cmp <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// a &gt; b</span>
    <span class="hl kwa">var</span> a<span class="hl opt">,</span> b<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>cmp <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
      b <span class="hl opt">=</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      a <span class="hl opt">=</span> num<span class="hl opt">;</span>
      b <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      r <span class="hl opt">= (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) - (</span>b<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> r <span class="hl opt">&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span> <span class="hl opt">(;</span> carry <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      r <span class="hl opt">= (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> r <span class="hl opt">&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Copy rest of the words</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length <span class="hl opt">&amp;&amp;</span> a <span class="hl opt">!==</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> a<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">,</span> i<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>a <span class="hl opt">!==</span> <span class="hl kwa">this</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Subtract `num` from `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>sub <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">sub</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">isub</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl kwa">function</span> <span class="hl kwd">smallMulTo</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    out<span class="hl opt">.</span>negative <span class="hl opt">=</span> num<span class="hl opt">.</span>negative <span class="hl opt">^</span> self<span class="hl opt">.</span>negative<span class="hl opt">;</span>
    <span class="hl kwa">var</span> len <span class="hl opt">= (</span>self<span class="hl opt">.</span>length <span class="hl opt">+</span> num<span class="hl opt">.</span>length<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    out<span class="hl opt">.</span>length <span class="hl opt">=</span> len<span class="hl opt">;</span>
    len <span class="hl opt">= (</span>len <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl slc">// Peel one iteration (compiler can't do it, because of code complexity)</span>
    <span class="hl kwa">var</span> a <span class="hl opt">=</span> self<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> a <span class="hl opt">*</span> b<span class="hl opt">;</span>

    <span class="hl kwa">var</span> lo <span class="hl opt">=</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">= (</span>r <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    out<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> lo<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> k <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> k <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> k<span class="hl opt">++) {</span>
      <span class="hl slc">// Sum all words with the same `i + j = k` and accumulate `ncarry`,</span>
      <span class="hl slc">// note that ncarry could be &gt;= 0x3ffffff</span>
      <span class="hl kwa">var</span> ncarry <span class="hl opt">=</span> carry <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> rword <span class="hl opt">=</span> carry <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> maxJ <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>k<span class="hl opt">,</span> num<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> k <span class="hl opt">-</span> self<span class="hl opt">.</span>length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span> j <span class="hl opt">&lt;=</span> maxJ<span class="hl opt">;</span> j<span class="hl opt">++) {</span>
        <span class="hl kwa">var</span> i <span class="hl opt">= (</span>k <span class="hl opt">-</span> j<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        a <span class="hl opt">=</span> self<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        b <span class="hl opt">=</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        r <span class="hl opt">=</span> a <span class="hl opt">*</span> b <span class="hl opt">+</span> rword<span class="hl opt">;</span>
        ncarry <span class="hl opt">+= (</span>r <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        rword <span class="hl opt">=</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      out<span class="hl opt">.</span>words<span class="hl opt">[</span>k<span class="hl opt">] =</span> rword <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
      carry <span class="hl opt">=</span> ncarry <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      out<span class="hl opt">.</span>words<span class="hl opt">[</span>k<span class="hl opt">] =</span> carry <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      out<span class="hl opt">.</span>length<span class="hl opt">--;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> out<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// TODO(indutny): it may be reasonable to omit it for users who don't need</span>
  <span class="hl slc">// to work with 256-bit numbers, otherwise it gives 20% improvement for 256-bit</span>
  <span class="hl slc">// multiplication (like elliptic secp256k1).</span>
  <span class="hl kwa">var</span> comb10MulTo <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">comb10MulTo</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> a <span class="hl opt">=</span> self<span class="hl opt">.</span>words<span class="hl opt">;</span>
    <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">.</span>words<span class="hl opt">;</span>
    <span class="hl kwa">var</span> o <span class="hl opt">=</span> out<span class="hl opt">.</span>words<span class="hl opt">;</span>
    <span class="hl kwa">var</span> c <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> lo<span class="hl opt">;</span>
    <span class="hl kwa">var</span> mid<span class="hl opt">;</span>
    <span class="hl kwa">var</span> hi<span class="hl opt">;</span>
    <span class="hl kwa">var</span> a0 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al0 <span class="hl opt">=</span> a0 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah0 <span class="hl opt">=</span> a0 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a1 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al1 <span class="hl opt">=</span> a1 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah1 <span class="hl opt">=</span> a1 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a2 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al2 <span class="hl opt">=</span> a2 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah2 <span class="hl opt">=</span> a2 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a3 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al3 <span class="hl opt">=</span> a3 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah3 <span class="hl opt">=</span> a3 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a4 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al4 <span class="hl opt">=</span> a4 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah4 <span class="hl opt">=</span> a4 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a5 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">5</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al5 <span class="hl opt">=</span> a5 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah5 <span class="hl opt">=</span> a5 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a6 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">6</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al6 <span class="hl opt">=</span> a6 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah6 <span class="hl opt">=</span> a6 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a7 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">7</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al7 <span class="hl opt">=</span> a7 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah7 <span class="hl opt">=</span> a7 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a8 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">8</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al8 <span class="hl opt">=</span> a8 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah8 <span class="hl opt">=</span> a8 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> a9 <span class="hl opt">=</span> a<span class="hl opt">[</span><span class="hl num">9</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> al9 <span class="hl opt">=</span> a9 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> ah9 <span class="hl opt">=</span> a9 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b0 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl0 <span class="hl opt">=</span> b0 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh0 <span class="hl opt">=</span> b0 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b1 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl1 <span class="hl opt">=</span> b1 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh1 <span class="hl opt">=</span> b1 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b2 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl2 <span class="hl opt">=</span> b2 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh2 <span class="hl opt">=</span> b2 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b3 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl3 <span class="hl opt">=</span> b3 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh3 <span class="hl opt">=</span> b3 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b4 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl4 <span class="hl opt">=</span> b4 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh4 <span class="hl opt">=</span> b4 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b5 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">5</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl5 <span class="hl opt">=</span> b5 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh5 <span class="hl opt">=</span> b5 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b6 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">6</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl6 <span class="hl opt">=</span> b6 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh6 <span class="hl opt">=</span> b6 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b7 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">7</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl7 <span class="hl opt">=</span> b7 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh7 <span class="hl opt">=</span> b7 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b8 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">8</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl8 <span class="hl opt">=</span> b8 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh8 <span class="hl opt">=</span> b8 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b9 <span class="hl opt">=</span> b<span class="hl opt">[</span><span class="hl num">9</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bl9 <span class="hl opt">=</span> b9 <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bh9 <span class="hl opt">=</span> b9 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>

    out<span class="hl opt">.</span>negative <span class="hl opt">=</span> self<span class="hl opt">.</span>negative <span class="hl opt">^</span> num<span class="hl opt">.</span>negative<span class="hl opt">;</span>
    out<span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">19</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 0 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w0 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w0 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w0 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 1 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w1 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w1 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w1 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 2 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w2 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w2 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w2 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 3 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w3 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w3 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w3 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 4 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w4 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w4 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w4 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 5 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w5 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w5 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w5 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 6 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w6 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w6 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w6 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 7 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w7 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w7 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w7 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 8 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w8 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w8 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w8 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 9 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl0<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh0<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al0<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah0<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w9 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w9 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w9 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 10 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl1<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh1<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al1<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah1<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w10 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w10 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w10 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 11 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl2<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh2<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al2<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah2<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w11 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w11 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w11 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 12 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl3<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh3<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al3<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah3<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w12 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w12 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w12 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 13 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl4<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh4<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al4<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah4<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w13 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w13 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w13 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 14 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl5<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh5<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al5<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah5<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w14 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w14 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w14 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 15 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl6<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh6<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al6<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah6<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w15 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w15 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w15 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 16 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl7<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh7<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al7<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah7<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w16 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w16 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w16 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 17 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl8<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh8<span class="hl opt">);</span>
    lo <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al8<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah8<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w17 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w17 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w17 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl com">/* k = 18 */</span>
    lo <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    mid <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>al9<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    mid <span class="hl opt">+=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bl9<span class="hl opt">);</span>
    hi <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span>ah9<span class="hl opt">,</span> bh9<span class="hl opt">);</span>
    <span class="hl kwa">var</span> w18 <span class="hl opt">=</span> c <span class="hl opt">+</span> lo <span class="hl opt">+ ((</span>mid <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">13</span><span class="hl opt">);</span>
    c <span class="hl opt">=</span> hi <span class="hl opt">+ (</span>mid <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">) + (</span>w18 <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">);</span>
    w18 <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> w0<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">] =</span> w1<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">] =</span> w2<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">] =</span> w3<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">] =</span> w4<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">5</span><span class="hl opt">] =</span> w5<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">6</span><span class="hl opt">] =</span> w6<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">7</span><span class="hl opt">] =</span> w7<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">8</span><span class="hl opt">] =</span> w8<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">9</span><span class="hl opt">] =</span> w9<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">10</span><span class="hl opt">] =</span> w10<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">11</span><span class="hl opt">] =</span> w11<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">12</span><span class="hl opt">] =</span> w12<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">13</span><span class="hl opt">] =</span> w13<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">14</span><span class="hl opt">] =</span> w14<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">15</span><span class="hl opt">] =</span> w15<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">] =</span> w16<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">17</span><span class="hl opt">] =</span> w17<span class="hl opt">;</span>
    o<span class="hl opt">[</span><span class="hl num">18</span><span class="hl opt">] =</span> w18<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>c <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      o<span class="hl opt">[</span><span class="hl num">19</span><span class="hl opt">] =</span> c<span class="hl opt">;</span>
      out<span class="hl opt">.</span>length<span class="hl opt">++;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> out<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Polyfill comb</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>Math<span class="hl opt">.</span>imul<span class="hl opt">) {</span>
    comb10MulTo <span class="hl opt">=</span> smallMulTo<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">function</span> <span class="hl kwd">bigMulTo</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    out<span class="hl opt">.</span>negative <span class="hl opt">=</span> num<span class="hl opt">.</span>negative <span class="hl opt">^</span> self<span class="hl opt">.</span>negative<span class="hl opt">;</span>
    out<span class="hl opt">.</span>length <span class="hl opt">=</span> self<span class="hl opt">.</span>length <span class="hl opt">+</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span>

    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> hncarry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> k <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> k <span class="hl opt">&lt;</span> out<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> k<span class="hl opt">++) {</span>
      <span class="hl slc">// Sum all words with the same `i + j = k` and accumulate `ncarry`,</span>
      <span class="hl slc">// note that ncarry could be &gt;= 0x3ffffff</span>
      <span class="hl kwa">var</span> ncarry <span class="hl opt">=</span> hncarry<span class="hl opt">;</span>
      hncarry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> rword <span class="hl opt">=</span> carry <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> maxJ <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>k<span class="hl opt">,</span> num<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> k <span class="hl opt">-</span> self<span class="hl opt">.</span>length <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span> j <span class="hl opt">&lt;=</span> maxJ<span class="hl opt">;</span> j<span class="hl opt">++) {</span>
        <span class="hl kwa">var</span> i <span class="hl opt">=</span> k <span class="hl opt">-</span> j<span class="hl opt">;</span>
        <span class="hl kwa">var</span> a <span class="hl opt">=</span> self<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">var</span> r <span class="hl opt">=</span> a <span class="hl opt">*</span> b<span class="hl opt">;</span>

        <span class="hl kwa">var</span> lo <span class="hl opt">=</span> r <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        ncarry <span class="hl opt">= (</span>ncarry <span class="hl opt">+ ((</span>r <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">)) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        lo <span class="hl opt">= (</span>lo <span class="hl opt">+</span> rword<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
        rword <span class="hl opt">=</span> lo <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
        ncarry <span class="hl opt">= (</span>ncarry <span class="hl opt">+ (</span>lo <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">)) |</span> <span class="hl num">0</span><span class="hl opt">;</span>

        hncarry <span class="hl opt">+=</span> ncarry <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
        ncarry <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      out<span class="hl opt">.</span>words<span class="hl opt">[</span>k<span class="hl opt">] =</span> rword<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> ncarry<span class="hl opt">;</span>
      ncarry <span class="hl opt">=</span> hncarry<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      out<span class="hl opt">.</span>words<span class="hl opt">[</span>k<span class="hl opt">] =</span> carry<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      out<span class="hl opt">.</span>length<span class="hl opt">--;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> out<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">function</span> <span class="hl kwd">jumboMulTo</span> <span class="hl opt">(</span>self<span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> fftm <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">FFTM</span><span class="hl opt">();</span>
    <span class="hl kwa">return</span> fftm<span class="hl opt">.</span><span class="hl kwd">mulp</span><span class="hl opt">(</span>self<span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
  <span class="hl opt">}</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>mulTo <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">mulTo</span> <span class="hl opt">(</span>num<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> res<span class="hl opt">;</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">+</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">10</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">10</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwd">comb10MulTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>len <span class="hl opt">&lt;</span> <span class="hl num">63</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwd">smallMulTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>len <span class="hl opt">&lt;</span> <span class="hl num">1024</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwd">bigMulTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      res <span class="hl opt">=</span> <span class="hl kwd">jumboMulTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Cooley-Tukey algorithm for FFT</span>
  <span class="hl slc">// slightly revisited to rely on looping instead of recursion</span>

  <span class="hl kwa">function</span> <span class="hl kwd">FFTM</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>x <span class="hl opt">=</span> x<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>y <span class="hl opt">=</span> y<span class="hl opt">;</span>
  <span class="hl opt">}</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>makeRBT <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">makeRBT</span> <span class="hl opt">(</span>N<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> t <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">var</span> l <span class="hl opt">=</span> BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span><span class="hl kwd">_countBits</span><span class="hl opt">(</span>N<span class="hl opt">) -</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      t<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">revBin</span><span class="hl opt">(</span>i<span class="hl opt">,</span> l<span class="hl opt">,</span> N<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> t<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Returns binary-reversed representation of `x`</span>
  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>revBin <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">revBin</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> l<span class="hl opt">,</span> N<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>x <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">||</span> x <span class="hl opt">===</span> N <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">)</span> <span class="hl kwa">return</span> x<span class="hl opt">;</span>

    <span class="hl kwa">var</span> rb <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> l<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      rb <span class="hl opt">|= (</span>x <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) &lt;&lt; (</span>l <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">);</span>
      x <span class="hl opt">&gt;&gt;=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> rb<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Performs &quot;tweedling&quot; phase, therefore 'emulating'</span>
  <span class="hl slc">// behaviour of the recursive algorithm</span>
  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>permute <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">permute</span> <span class="hl opt">(</span>rbt<span class="hl opt">,</span> rws<span class="hl opt">,</span> iws<span class="hl opt">,</span> rtws<span class="hl opt">,</span> itws<span class="hl opt">,</span> N<span class="hl opt">) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      rtws<span class="hl opt">[</span>i<span class="hl opt">] =</span> rws<span class="hl opt">[</span>rbt<span class="hl opt">[</span>i<span class="hl opt">]];</span>
      itws<span class="hl opt">[</span>i<span class="hl opt">] =</span> iws<span class="hl opt">[</span>rbt<span class="hl opt">[</span>i<span class="hl opt">]];</span>
    <span class="hl opt">}</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>transform <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">transform</span> <span class="hl opt">(</span>rws<span class="hl opt">,</span> iws<span class="hl opt">,</span> rtws<span class="hl opt">,</span> itws<span class="hl opt">,</span> N<span class="hl opt">,</span> rbt<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">permute</span><span class="hl opt">(</span>rbt<span class="hl opt">,</span> rws<span class="hl opt">,</span> iws<span class="hl opt">,</span> rtws<span class="hl opt">,</span> itws<span class="hl opt">,</span> N<span class="hl opt">);</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> s <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> s <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> s <span class="hl opt">&lt;&lt;=</span> <span class="hl num">1</span><span class="hl opt">) {</span>
      <span class="hl kwa">var</span> l <span class="hl opt">=</span> s <span class="hl opt">&lt;&lt;</span> <span class="hl num">1</span><span class="hl opt">;</span>

      <span class="hl kwa">var</span> rtwdf <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">cos</span><span class="hl opt">(</span><span class="hl num">2</span> <span class="hl opt">*</span> Math<span class="hl opt">.</span>PI <span class="hl opt">/</span> l<span class="hl opt">);</span>
      <span class="hl kwa">var</span> itwdf <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">sin</span><span class="hl opt">(</span><span class="hl num">2</span> <span class="hl opt">*</span> Math<span class="hl opt">.</span>PI <span class="hl opt">/</span> l<span class="hl opt">);</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> p <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> p <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> p <span class="hl opt">+=</span> l<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> rtwdf_ <span class="hl opt">=</span> rtwdf<span class="hl opt">;</span>
        <span class="hl kwa">var</span> itwdf_ <span class="hl opt">=</span> itwdf<span class="hl opt">;</span>

        <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> s<span class="hl opt">;</span> j<span class="hl opt">++) {</span>
          <span class="hl kwa">var</span> re <span class="hl opt">=</span> rtws<span class="hl opt">[</span>p <span class="hl opt">+</span> j<span class="hl opt">];</span>
          <span class="hl kwa">var</span> ie <span class="hl opt">=</span> itws<span class="hl opt">[</span>p <span class="hl opt">+</span> j<span class="hl opt">];</span>

          <span class="hl kwa">var</span> ro <span class="hl opt">=</span> rtws<span class="hl opt">[</span>p <span class="hl opt">+</span> j <span class="hl opt">+</span> s<span class="hl opt">];</span>
          <span class="hl kwa">var</span> io <span class="hl opt">=</span> itws<span class="hl opt">[</span>p <span class="hl opt">+</span> j <span class="hl opt">+</span> s<span class="hl opt">];</span>

          <span class="hl kwa">var</span> rx <span class="hl opt">=</span> rtwdf_ <span class="hl opt">*</span> ro <span class="hl opt">-</span> itwdf_ <span class="hl opt">*</span> io<span class="hl opt">;</span>

          io <span class="hl opt">=</span> rtwdf_ <span class="hl opt">*</span> io <span class="hl opt">+</span> itwdf_ <span class="hl opt">*</span> ro<span class="hl opt">;</span>
          ro <span class="hl opt">=</span> rx<span class="hl opt">;</span>

          rtws<span class="hl opt">[</span>p <span class="hl opt">+</span> j<span class="hl opt">] =</span> re <span class="hl opt">+</span> ro<span class="hl opt">;</span>
          itws<span class="hl opt">[</span>p <span class="hl opt">+</span> j<span class="hl opt">] =</span> ie <span class="hl opt">+</span> io<span class="hl opt">;</span>

          rtws<span class="hl opt">[</span>p <span class="hl opt">+</span> j <span class="hl opt">+</span> s<span class="hl opt">] =</span> re <span class="hl opt">-</span> ro<span class="hl opt">;</span>
          itws<span class="hl opt">[</span>p <span class="hl opt">+</span> j <span class="hl opt">+</span> s<span class="hl opt">] =</span> ie <span class="hl opt">-</span> io<span class="hl opt">;</span>

          <span class="hl com">/* jshint maxdepth : false */</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>j <span class="hl opt">!==</span> l<span class="hl opt">) {</span>
            rx <span class="hl opt">=</span> rtwdf <span class="hl opt">*</span> rtwdf_ <span class="hl opt">-</span> itwdf <span class="hl opt">*</span> itwdf_<span class="hl opt">;</span>

            itwdf_ <span class="hl opt">=</span> rtwdf <span class="hl opt">*</span> itwdf_ <span class="hl opt">+</span> itwdf <span class="hl opt">*</span> rtwdf_<span class="hl opt">;</span>
            rtwdf_ <span class="hl opt">=</span> rx<span class="hl opt">;</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>guessLen13b <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">guessLen13b</span> <span class="hl opt">(</span>n<span class="hl opt">,</span> m<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> N <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span>m<span class="hl opt">,</span> n<span class="hl opt">) |</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> odd <span class="hl opt">=</span> N <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>N <span class="hl opt">=</span> N <span class="hl opt">/</span> <span class="hl num">2</span> <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span> N<span class="hl opt">;</span> N <span class="hl opt">=</span> N <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
      i<span class="hl opt">++;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> <span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> i <span class="hl opt">+</span> <span class="hl num">1</span> <span class="hl opt">+</span> odd<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>conjugate <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">conjugate</span> <span class="hl opt">(</span>rws<span class="hl opt">,</span> iws<span class="hl opt">,</span> N<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>N <span class="hl opt">&lt;=</span> <span class="hl num">1</span><span class="hl opt">)</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N <span class="hl opt">/</span> <span class="hl num">2</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> t <span class="hl opt">=</span> rws<span class="hl opt">[</span>i<span class="hl opt">];</span>

      rws<span class="hl opt">[</span>i<span class="hl opt">] =</span> rws<span class="hl opt">[</span>N <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
      rws<span class="hl opt">[</span>N <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] =</span> t<span class="hl opt">;</span>

      t <span class="hl opt">=</span> iws<span class="hl opt">[</span>i<span class="hl opt">];</span>

      iws<span class="hl opt">[</span>i<span class="hl opt">] = -</span>iws<span class="hl opt">[</span>N <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">];</span>
      iws<span class="hl opt">[</span>N <span class="hl opt">-</span> i <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] = -</span>t<span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>normalize13b <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">normalize13b</span> <span class="hl opt">(</span>ws<span class="hl opt">,</span> N<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N <span class="hl opt">/</span> <span class="hl num">2</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> w <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">round</span><span class="hl opt">(</span>ws<span class="hl opt">[</span><span class="hl num">2</span> <span class="hl opt">*</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] /</span> N<span class="hl opt">) *</span> <span class="hl num">0x2000</span> <span class="hl opt">+</span>
        Math<span class="hl opt">.</span><span class="hl kwd">round</span><span class="hl opt">(</span>ws<span class="hl opt">[</span><span class="hl num">2</span> <span class="hl opt">*</span> i<span class="hl opt">] /</span> N<span class="hl opt">) +</span>
        carry<span class="hl opt">;</span>

      ws<span class="hl opt">[</span>i<span class="hl opt">] =</span> w <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>w <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">) {</span>
        carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        carry <span class="hl opt">=</span> w <span class="hl opt">/</span> <span class="hl num">0x4000000</span> <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> ws<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>convert13b <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">convert13b</span> <span class="hl opt">(</span>ws<span class="hl opt">,</span> len<span class="hl opt">,</span> rws<span class="hl opt">,</span> N<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      carry <span class="hl opt">=</span> carry <span class="hl opt">+ (</span>ws<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">);</span>

      rws<span class="hl opt">[</span><span class="hl num">2</span> <span class="hl opt">*</span> i<span class="hl opt">] =</span> carry <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span> carry <span class="hl opt">=</span> carry <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
      rws<span class="hl opt">[</span><span class="hl num">2</span> <span class="hl opt">*</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] =</span> carry <span class="hl opt">&amp;</span> <span class="hl num">0x1fff</span><span class="hl opt">;</span> carry <span class="hl opt">=</span> carry <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">13</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Pad with zeroes</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span> len<span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
      rws<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwd">assert</span><span class="hl opt">(</span>carry <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">((</span>carry <span class="hl opt">&amp; ~</span><span class="hl num">0x1fff</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>stub <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">stub</span> <span class="hl opt">(</span>N<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> ph <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      ph<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> ph<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  FFTM<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>mulp <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">mulp</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">,</span> out<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> N <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">guessLen13b</span><span class="hl opt">(</span>x<span class="hl opt">.</span>length<span class="hl opt">,</span> y<span class="hl opt">.</span>length<span class="hl opt">);</span>

    <span class="hl kwa">var</span> rbt <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">makeRBT</span><span class="hl opt">(</span>N<span class="hl opt">);</span>

    <span class="hl kwa">var</span> _ <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">stub</span><span class="hl opt">(</span>N<span class="hl opt">);</span>

    <span class="hl kwa">var</span> rws <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">var</span> rwst <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">var</span> iwst <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>

    <span class="hl kwa">var</span> nrws <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">var</span> nrwst <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>
    <span class="hl kwa">var</span> niwst <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>N<span class="hl opt">);</span>

    <span class="hl kwa">var</span> rmws <span class="hl opt">=</span> out<span class="hl opt">.</span>words<span class="hl opt">;</span>
    rmws<span class="hl opt">.</span>length <span class="hl opt">=</span> N<span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">convert13b</span><span class="hl opt">(</span>x<span class="hl opt">.</span>words<span class="hl opt">,</span> x<span class="hl opt">.</span>length<span class="hl opt">,</span> rws<span class="hl opt">,</span> N<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">convert13b</span><span class="hl opt">(</span>y<span class="hl opt">.</span>words<span class="hl opt">,</span> y<span class="hl opt">.</span>length<span class="hl opt">,</span> nrws<span class="hl opt">,</span> N<span class="hl opt">);</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">transform</span><span class="hl opt">(</span>rws<span class="hl opt">,</span> _<span class="hl opt">,</span> rwst<span class="hl opt">,</span> iwst<span class="hl opt">,</span> N<span class="hl opt">,</span> rbt<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">transform</span><span class="hl opt">(</span>nrws<span class="hl opt">,</span> _<span class="hl opt">,</span> nrwst<span class="hl opt">,</span> niwst<span class="hl opt">,</span> N<span class="hl opt">,</span> rbt<span class="hl opt">);</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> N<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> rx <span class="hl opt">=</span> rwst<span class="hl opt">[</span>i<span class="hl opt">] *</span> nrwst<span class="hl opt">[</span>i<span class="hl opt">] -</span> iwst<span class="hl opt">[</span>i<span class="hl opt">] *</span> niwst<span class="hl opt">[</span>i<span class="hl opt">];</span>
      iwst<span class="hl opt">[</span>i<span class="hl opt">] =</span> rwst<span class="hl opt">[</span>i<span class="hl opt">] *</span> niwst<span class="hl opt">[</span>i<span class="hl opt">] +</span> iwst<span class="hl opt">[</span>i<span class="hl opt">] *</span> nrwst<span class="hl opt">[</span>i<span class="hl opt">];</span>
      rwst<span class="hl opt">[</span>i<span class="hl opt">] =</span> rx<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">conjugate</span><span class="hl opt">(</span>rwst<span class="hl opt">,</span> iwst<span class="hl opt">,</span> N<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">transform</span><span class="hl opt">(</span>rwst<span class="hl opt">,</span> iwst<span class="hl opt">,</span> rmws<span class="hl opt">,</span> _<span class="hl opt">,</span> N<span class="hl opt">,</span> rbt<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">conjugate</span><span class="hl opt">(</span>rmws<span class="hl opt">,</span> _<span class="hl opt">,</span> N<span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">normalize13b</span><span class="hl opt">(</span>rmws<span class="hl opt">,</span> N<span class="hl opt">);</span>

    out<span class="hl opt">.</span>negative <span class="hl opt">=</span> x<span class="hl opt">.</span>negative <span class="hl opt">^</span> y<span class="hl opt">.</span>negative<span class="hl opt">;</span>
    out<span class="hl opt">.</span>length <span class="hl opt">=</span> x<span class="hl opt">.</span>length <span class="hl opt">+</span> y<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">return</span> out<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Multiply `this` by `num`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>mul <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">mul</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> out <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
    out<span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">+</span> num<span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">mulTo</span><span class="hl opt">(</span>num<span class="hl opt">,</span> out<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Multiply employing FFT</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>mulf <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">mulf</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> out <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
    out<span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">+</span> num<span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">return</span> <span class="hl kwd">jumboMulTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">,</span> out<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// In-place Multiplication</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>imul <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">imul</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">mulTo</span><span class="hl opt">(</span>num<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>imuln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">imuln</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> num <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">);</span>

    <span class="hl slc">// Carry</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> w <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) *</span> num<span class="hl opt">;</span>
      <span class="hl kwa">var</span> lo <span class="hl opt">= (</span>w <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">) + (</span>carry <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">);</span>
      carry <span class="hl opt">&gt;&gt;=</span> <span class="hl num">26</span><span class="hl opt">;</span>
      carry <span class="hl opt">+= (</span>w <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl slc">// NOTE: lo is 27bit maximum</span>
      carry <span class="hl opt">+=</span> lo <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> lo <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>muln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">muln</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">imuln</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// `this` * `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>sqr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">sqr</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">mul</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// `this` * `this` in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isqr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isqr</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">());</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Math.pow(`this`, `num`)</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>pow <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">pow</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwd">toBitArray</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>w<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>

    <span class="hl slc">// Skip leading zeroes</span>
    <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> w<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++,</span> res <span class="hl opt">=</span> res<span class="hl opt">.</span><span class="hl kwd">sqr</span><span class="hl opt">()) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>w<span class="hl opt">[</span>i<span class="hl opt">] !==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(++</span>i <span class="hl opt">&lt;</span> w<span class="hl opt">.</span>length<span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> q <span class="hl opt">=</span> res<span class="hl opt">.</span><span class="hl kwd">sqr</span><span class="hl opt">();</span> i <span class="hl opt">&lt;</span> w<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++,</span> q <span class="hl opt">=</span> q<span class="hl opt">.</span><span class="hl kwd">sqr</span><span class="hl opt">()) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>w<span class="hl opt">[</span>i<span class="hl opt">] ===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">continue</span><span class="hl opt">;</span>

        res <span class="hl opt">=</span> res<span class="hl opt">.</span><span class="hl kwd">mul</span><span class="hl opt">(</span>q<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Shift-left in-place</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iushln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iushln</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bits <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> bits <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> bits <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> s <span class="hl opt">= (</span>bits <span class="hl opt">-</span> r<span class="hl opt">) /</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> carryMask <span class="hl opt">= (</span><span class="hl num">0x3ffffff</span> <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> r<span class="hl opt">)) &lt;&lt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> r<span class="hl opt">);</span>
    <span class="hl kwa">var</span> i<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>r <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">var</span> newCarry <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &amp;</span> carryMask<span class="hl opt">;</span>
        <span class="hl kwa">var</span> c <span class="hl opt">= ((</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) -</span> newCarry<span class="hl opt">) &lt;&lt;</span> r<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> c <span class="hl opt">|</span> carry<span class="hl opt">;</span>
        carry <span class="hl opt">=</span> newCarry <span class="hl opt">&gt;&gt;&gt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> r<span class="hl opt">);</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>carry<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> carry<span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>s <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> s<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> s<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">+=</span> s<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ishln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ishln</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl slc">// TODO(indutny): implement me</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iushln</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Shift-right in-place</span>
  <span class="hl slc">// NOTE: `hint` is a lowest bit before trailing zeroes</span>
  <span class="hl slc">// NOTE: if `extended` is present - it will be filled with destroyed bits</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iushrn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iushrn</span> <span class="hl opt">(</span>bits<span class="hl opt">,</span> hint<span class="hl opt">,</span> extended<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bits <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> bits <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> h<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>hint<span class="hl opt">) {</span>
      h <span class="hl opt">= (</span>hint <span class="hl opt">- (</span>hint <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">)) /</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      h <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> r <span class="hl opt">=</span> bits <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> s <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">((</span>bits <span class="hl opt">-</span> r<span class="hl opt">) /</span> <span class="hl num">26</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>
    <span class="hl kwa">var</span> mask <span class="hl opt">=</span> <span class="hl num">0x3ffffff</span> <span class="hl opt">^ ((</span><span class="hl num">0x3ffffff</span> <span class="hl opt">&gt;&gt;&gt;</span> r<span class="hl opt">) &lt;&lt;</span> r<span class="hl opt">);</span>
    <span class="hl kwa">var</span> maskedWords <span class="hl opt">=</span> extended<span class="hl opt">;</span>

    h <span class="hl opt">-=</span> s<span class="hl opt">;</span>
    h <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> h<span class="hl opt">);</span>

    <span class="hl slc">// Extended mode, copy masked part</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>maskedWords<span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> s<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        maskedWords<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">];</span>
      <span class="hl opt">}</span>
      maskedWords<span class="hl opt">.</span>length <span class="hl opt">=</span> s<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>s <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl slc">// No-op, we should not move anything at all</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> s<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-=</span> s<span class="hl opt">;</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> s<span class="hl opt">];</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp; (</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">||</span> i <span class="hl opt">&gt;=</span> h<span class="hl opt">);</span> i<span class="hl opt">--) {</span>
      <span class="hl kwa">var</span> word <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] = (</span>carry <span class="hl opt">&lt;&lt; (</span><span class="hl num">26</span> <span class="hl opt">-</span> r<span class="hl opt">)) | (</span>word <span class="hl opt">&gt;&gt;&gt;</span> r<span class="hl opt">);</span>
      carry <span class="hl opt">=</span> word <span class="hl opt">&amp;</span> mask<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Push carried bits as a mask</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>maskedWords <span class="hl opt">&amp;&amp;</span> carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      maskedWords<span class="hl opt">.</span>words<span class="hl opt">[</span>maskedWords<span class="hl opt">.</span>length<span class="hl opt">++] =</span> carry<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ishrn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ishrn</span> <span class="hl opt">(</span>bits<span class="hl opt">,</span> hint<span class="hl opt">,</span> extended<span class="hl opt">) {</span>
    <span class="hl slc">// TODO(indutny): implement me</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>bits<span class="hl opt">,</span> hint<span class="hl opt">,</span> extended<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Shift-left</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>shln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">shln</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ishln</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ushln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ushln</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iushln</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Shift-right</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>shrn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">shrn</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">ishrn</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ushrn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ushrn</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Test if n bit is set</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>testn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">testn</span> <span class="hl opt">(</span>bit<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bit <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> bit <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> bit <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> s <span class="hl opt">= (</span>bit <span class="hl opt">-</span> r<span class="hl opt">) /</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> q <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> r<span class="hl opt">;</span>

    <span class="hl slc">// Fast case: bit is much higher than all existing words</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&lt;=</span> s<span class="hl opt">)</span> <span class="hl kwa">return false</span><span class="hl opt">;</span>

    <span class="hl slc">// Check bit and return</span>
    <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>s<span class="hl opt">];</span>

    <span class="hl kwa">return</span> <span class="hl opt">!!(</span>w <span class="hl opt">&amp;</span> q<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Return only lowers bits of number (in-place)</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>imaskn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">imaskn</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bits <span class="hl opt">===</span> <span class="hl str">'number'</span> <span class="hl opt">&amp;&amp;</span> bits <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> bits <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> s <span class="hl opt">= (</span>bits <span class="hl opt">-</span> r<span class="hl opt">) /</span> <span class="hl num">26</span><span class="hl opt">;</span>

    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">'imaskn works only with positive numbers'</span><span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>r <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      s<span class="hl opt">++;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">(</span>s<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>r <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">var</span> mask <span class="hl opt">=</span> <span class="hl num">0x3ffffff</span> <span class="hl opt">^ ((</span><span class="hl num">0x3ffffff</span> <span class="hl opt">&gt;&gt;&gt;</span> r<span class="hl opt">) &lt;&lt;</span> r<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] &amp;=</span> mask<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Return only lowers bits of number</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>maskn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">maskn</span> <span class="hl opt">(</span>bits<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">imaskn</span><span class="hl opt">(</span>bits<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Add plain number `num` to `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iaddn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iaddn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> num <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">isubn</span><span class="hl opt">(-</span>num<span class="hl opt">);</span>

    <span class="hl slc">// Possible sign change</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp; (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) &lt;</span> num<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] =</span> num <span class="hl opt">- (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">);</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl kwa">return this</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isubn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Add without checks</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_iaddn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_iaddn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_iaddn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] +=</span> num<span class="hl opt">;</span>

    <span class="hl slc">// Carry</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &gt;=</span> <span class="hl num">0x4000000</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] -=</span> <span class="hl num">0x4000000</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">===</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">]++;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">max</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">,</span> i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Subtract plain number `num` from `this`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isubn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isubn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> num <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0x4000000</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">iaddn</span><span class="hl opt">(-</span>num<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">iaddn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] -=</span> num<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] = -</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl slc">// Carry</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] &lt;</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] +=</span> <span class="hl num">0x4000000</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">] -=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>addn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">addn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iaddn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>subn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">subn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">isubn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>iabs <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">iabs</span> <span class="hl opt">() {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>abs <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">abs</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">iabs</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_ishlnsubmul <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_ishlnsubmul</span> <span class="hl opt">(</span>num<span class="hl opt">,</span> mul<span class="hl opt">,</span> shift<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> len <span class="hl opt">=</span> num<span class="hl opt">.</span>length <span class="hl opt">+</span> shift<span class="hl opt">;</span>
    <span class="hl kwa">var</span> i<span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_expand</span><span class="hl opt">(</span>len<span class="hl opt">);</span>

    <span class="hl kwa">var</span> w<span class="hl opt">;</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      w <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> shift<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">var</span> right <span class="hl opt">= (</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) *</span> mul<span class="hl opt">;</span>
      w <span class="hl opt">-=</span> right <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      carry <span class="hl opt">= (</span>w <span class="hl opt">&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">) - ((</span>right <span class="hl opt">/</span> <span class="hl num">0x4000000</span><span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> shift<span class="hl opt">] =</span> w <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> shift<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      w <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> shift<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> w <span class="hl opt">&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i <span class="hl opt">+</span> shift<span class="hl opt">] =</span> w <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>

    <span class="hl slc">// Subtraction overflow</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>carry <span class="hl opt">=== -</span><span class="hl num">1</span><span class="hl opt">);</span>
    carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      w <span class="hl opt">= -(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> w <span class="hl opt">&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> w <span class="hl opt">&amp;</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_wordDiv <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_wordDiv</span> <span class="hl opt">(</span>num<span class="hl opt">,</span> mode<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> shift <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> num<span class="hl opt">.</span>length<span class="hl opt">;</span>

    <span class="hl kwa">var</span> a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">;</span>

    <span class="hl slc">// Normalize</span>
    <span class="hl kwa">var</span> bhi <span class="hl opt">=</span> b<span class="hl opt">.</span>words<span class="hl opt">[</span>b<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> bhiBits <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_countBits</span><span class="hl opt">(</span>bhi<span class="hl opt">);</span>
    shift <span class="hl opt">=</span> <span class="hl num">26</span> <span class="hl opt">-</span> bhiBits<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>shift <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      b <span class="hl opt">=</span> b<span class="hl opt">.</span><span class="hl kwd">ushln</span><span class="hl opt">(</span>shift<span class="hl opt">);</span>
      a<span class="hl opt">.</span><span class="hl kwd">iushln</span><span class="hl opt">(</span>shift<span class="hl opt">);</span>
      bhi <span class="hl opt">=</span> b<span class="hl opt">.</span>words<span class="hl opt">[</span>b<span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Initialize quotient</span>
    <span class="hl kwa">var</span> m <span class="hl opt">=</span> a<span class="hl opt">.</span>length <span class="hl opt">-</span> b<span class="hl opt">.</span>length<span class="hl opt">;</span>
    <span class="hl kwa">var</span> q<span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'mod'</span><span class="hl opt">) {</span>
      q <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
      q<span class="hl opt">.</span>length <span class="hl opt">=</span> m <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
      q<span class="hl opt">.</span>words <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span>q<span class="hl opt">.</span>length<span class="hl opt">);</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> q<span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
        q<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> diff <span class="hl opt">=</span> a<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">_ishlnsubmul</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> m<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>diff<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      a <span class="hl opt">=</span> diff<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>q<span class="hl opt">) {</span>
        q<span class="hl opt">.</span>words<span class="hl opt">[</span>m<span class="hl opt">] =</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> m <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> j <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> j<span class="hl opt">--) {</span>
      <span class="hl kwa">var</span> qj <span class="hl opt">= (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>b<span class="hl opt">.</span>length <span class="hl opt">+</span> j<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) *</span> <span class="hl num">0x4000000</span> <span class="hl opt">+</span>
        <span class="hl opt">(</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span>b<span class="hl opt">.</span>length <span class="hl opt">+</span> j <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">);</span>

      <span class="hl slc">// NOTE: (qj / bhi) is (0x3ffffff * 0x4000000 + 0x3ffffff) / 0x2000000 max</span>
      <span class="hl slc">// (0x7ffffff)</span>
      qj <span class="hl opt">=</span> Math<span class="hl opt">.</span><span class="hl kwd">min</span><span class="hl opt">((</span>qj <span class="hl opt">/</span> bhi<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0x3ffffff</span><span class="hl opt">);</span>

      a<span class="hl opt">.</span><span class="hl kwd">_ishlnsubmul</span><span class="hl opt">(</span>b<span class="hl opt">,</span> qj<span class="hl opt">,</span> j<span class="hl opt">);</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>a<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        qj<span class="hl opt">--;</span>
        a<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
        a<span class="hl opt">.</span><span class="hl kwd">_ishlnsubmul</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> j<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span>a<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
          a<span class="hl opt">.</span>negative <span class="hl opt">^=</span> <span class="hl num">1</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>q<span class="hl opt">) {</span>
        q<span class="hl opt">.</span>words<span class="hl opt">[</span>j<span class="hl opt">] =</span> qj<span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>q<span class="hl opt">) {</span>
      q<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
    a<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>

    <span class="hl slc">// Denormalize</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'div'</span> <span class="hl opt">&amp;&amp;</span> shift <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      a<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>shift<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> <span class="hl opt">{</span>
      div<span class="hl opt">:</span> q <span class="hl opt">||</span> <span class="hl kwa">null</span><span class="hl opt">,</span>
      mod<span class="hl opt">:</span> a
    <span class="hl opt">};</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// NOTE: 1) `mode` can be set to `mod` to request mod only,</span>
  <span class="hl slc">//       to `div` to request div only, or be absent to</span>
  <span class="hl slc">//       request both div &amp; mod</span>
  <span class="hl slc">//       2) `positive` is true if unsigned mod is requested</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>divmod <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">divmod</span> <span class="hl opt">(</span>num<span class="hl opt">,</span> mode<span class="hl opt">,</span> positive<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(!</span>num<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">());</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">),</span>
        mod<span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> div<span class="hl opt">,</span> mod<span class="hl opt">,</span> res<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">().</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">,</span> mode<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'mod'</span><span class="hl opt">) {</span>
        div <span class="hl opt">=</span> res<span class="hl opt">.</span>div<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">();</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'div'</span><span class="hl opt">) {</span>
        mod <span class="hl opt">=</span> res<span class="hl opt">.</span>mod<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>positive <span class="hl opt">&amp;&amp;</span> mod<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          mod<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> div<span class="hl opt">,</span>
        mod<span class="hl opt">:</span> mod
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">(),</span> mode<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'mod'</span><span class="hl opt">) {</span>
        div <span class="hl opt">=</span> res<span class="hl opt">.</span>div<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">();</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> div<span class="hl opt">,</span>
        mod<span class="hl opt">:</span> res<span class="hl opt">.</span>mod
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">((</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">&amp;</span> num<span class="hl opt">.</span>negative<span class="hl opt">) !==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">().</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">(),</span> mode<span class="hl opt">);</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">!==</span> <span class="hl str">'div'</span><span class="hl opt">) {</span>
        mod <span class="hl opt">=</span> res<span class="hl opt">.</span>mod<span class="hl opt">.</span><span class="hl kwd">neg</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>positive <span class="hl opt">&amp;&amp;</span> mod<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          mod<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> res<span class="hl opt">.</span>div<span class="hl opt">,</span>
        mod<span class="hl opt">:</span> mod
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Both numbers are positive at this point</span>

    <span class="hl slc">// Strip both numbers to approximate shift value</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">||</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) &lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">),</span>
        mod<span class="hl opt">:</span> <span class="hl kwa">this</span>
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Very short reduction</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">===</span> <span class="hl str">'div'</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">{</span>
          div<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">divn</span><span class="hl opt">(</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span>
          mod<span class="hl opt">:</span> <span class="hl kwa">null</span>
        <span class="hl opt">};</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>mode <span class="hl opt">===</span> <span class="hl str">'mod'</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl opt">{</span>
          div<span class="hl opt">:</span> <span class="hl kwa">null</span><span class="hl opt">,</span>
          mod<span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">modn</span><span class="hl opt">(</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]))</span>
        <span class="hl opt">};</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">return</span> <span class="hl opt">{</span>
        div<span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">divn</span><span class="hl opt">(</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span>
        mod<span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">modn</span><span class="hl opt">(</span>num<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]))</span>
      <span class="hl opt">};</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_wordDiv</span><span class="hl opt">(</span>num<span class="hl opt">,</span> mode<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Find `this` / `num`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>div <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">div</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">,</span> <span class="hl str">'div'</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">).</span>div<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Find `this` % `num`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>mod <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">mod</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">,</span> <span class="hl str">'mod'</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">).</span>mod<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>umod <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">umod</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">,</span> <span class="hl str">'mod'</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">).</span>mod<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Find Round(`this` / `num`)</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>divRound <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">divRound</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> dm <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">divmod</span><span class="hl opt">(</span>num<span class="hl opt">);</span>

    <span class="hl slc">// Fast case - exact division</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>dm<span class="hl opt">.</span>mod<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">())</span> <span class="hl kwa">return</span> dm<span class="hl opt">.</span>div<span class="hl opt">;</span>

    <span class="hl kwa">var</span> mod <span class="hl opt">=</span> dm<span class="hl opt">.</span>div<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">?</span> dm<span class="hl opt">.</span>mod<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>num<span class="hl opt">) :</span> dm<span class="hl opt">.</span>mod<span class="hl opt">;</span>

    <span class="hl kwa">var</span> half <span class="hl opt">=</span> num<span class="hl opt">.</span><span class="hl kwd">ushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> r2 <span class="hl opt">=</span> num<span class="hl opt">.</span><span class="hl kwd">andln</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> cmp <span class="hl opt">=</span> mod<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>half<span class="hl opt">);</span>

    <span class="hl slc">// Round down</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>cmp <span class="hl opt">&lt;</span> <span class="hl num">0</span> <span class="hl opt">||</span> r2 <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> cmp <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> dm<span class="hl opt">.</span>div<span class="hl opt">;</span>

    <span class="hl slc">// Round up</span>
    <span class="hl kwa">return</span> dm<span class="hl opt">.</span>div<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">?</span> dm<span class="hl opt">.</span>div<span class="hl opt">.</span><span class="hl kwd">isubn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) :</span> dm<span class="hl opt">.</span>div<span class="hl opt">.</span><span class="hl kwd">iaddn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>modn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">modn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> p <span class="hl opt">= (</span><span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> <span class="hl num">26</span><span class="hl opt">) %</span> num<span class="hl opt">;</span>

    <span class="hl kwa">var</span> acc <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
      acc <span class="hl opt">= (</span>p <span class="hl opt">*</span> acc <span class="hl opt">+ (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">)) %</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> acc<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// In-place division by number</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>idivn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">idivn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
      <span class="hl kwa">var</span> w <span class="hl opt">= (</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">) +</span> carry <span class="hl opt">*</span> <span class="hl num">0x4000000</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] = (</span>w <span class="hl opt">/</span> num<span class="hl opt">) |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      carry <span class="hl opt">=</span> w <span class="hl opt">%</span> num<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>divn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">divn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">().</span><span class="hl kwd">idivn</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>egcd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">egcd</span> <span class="hl opt">(</span>p<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>p<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(!</span>p<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">());</span>

    <span class="hl kwa">var</span> x <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> y <span class="hl opt">=</span> p<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>x<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      x <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">umod</span><span class="hl opt">(</span>p<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      x <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// A * x + B * y = x</span>
    <span class="hl kwa">var</span> A <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> B <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl slc">// C * x + D * y = y</span>
    <span class="hl kwa">var</span> C <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> D <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> g <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">while</span> <span class="hl opt">(</span>x<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">() &amp;&amp;</span> y<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">()) {</span>
      x<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      y<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl opt">++</span>g<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> yp <span class="hl opt">=</span> y<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> xp <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>

    <span class="hl kwa">while</span> <span class="hl opt">(!</span>x<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">()) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> im <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; (</span>x<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> im<span class="hl opt">) ===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> <span class="hl num">26</span><span class="hl opt">; ++</span>i<span class="hl opt">,</span> im <span class="hl opt">&lt;&lt;=</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        x<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
        <span class="hl kwa">while</span> <span class="hl opt">(</span>i<span class="hl opt">-- &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>A<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">() ||</span> B<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">()) {</span>
            A<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>yp<span class="hl opt">);</span>
            B<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>xp<span class="hl opt">);</span>
          <span class="hl opt">}</span>

          A<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
          B<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> jm <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; (</span>y<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> jm<span class="hl opt">) ===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> j <span class="hl opt">&lt;</span> <span class="hl num">26</span><span class="hl opt">; ++</span>j<span class="hl opt">,</span> jm <span class="hl opt">&lt;&lt;=</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>j <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        y<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>j<span class="hl opt">);</span>
        <span class="hl kwa">while</span> <span class="hl opt">(</span>j<span class="hl opt">-- &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>C<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">() ||</span> D<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">()) {</span>
            C<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>yp<span class="hl opt">);</span>
            D<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>xp<span class="hl opt">);</span>
          <span class="hl opt">}</span>

          C<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
          D<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>x<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>y<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        x<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>y<span class="hl opt">);</span>
        A<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>C<span class="hl opt">);</span>
        B<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>D<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        y<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>x<span class="hl opt">);</span>
        C<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>A<span class="hl opt">);</span>
        D<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>B<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> <span class="hl opt">{</span>
      a<span class="hl opt">:</span> C<span class="hl opt">,</span>
      b<span class="hl opt">:</span> D<span class="hl opt">,</span>
      gcd<span class="hl opt">:</span> y<span class="hl opt">.</span><span class="hl kwd">iushln</span><span class="hl opt">(</span>g<span class="hl opt">)</span>
    <span class="hl opt">};</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// This is reduced incarnation of the binary EEA</span>
  <span class="hl slc">// above, designated to invert members of the</span>
  <span class="hl slc">// _prime_ fields F(p) at a maximal speed</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_invmp <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_invmp</span> <span class="hl opt">(</span>p<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span>p<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(!</span>p<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">());</span>

    <span class="hl kwa">var</span> a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> b <span class="hl opt">=</span> p<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>a<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      a <span class="hl opt">=</span> a<span class="hl opt">.</span><span class="hl kwd">umod</span><span class="hl opt">(</span>p<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      a <span class="hl opt">=</span> a<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> x1 <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> x2 <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BN</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>

    <span class="hl kwa">var</span> delta <span class="hl opt">=</span> b<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>

    <span class="hl kwa">while</span> <span class="hl opt">(</span>a<span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> b<span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> im <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; (</span>a<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> im<span class="hl opt">) ===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> <span class="hl num">26</span><span class="hl opt">; ++</span>i<span class="hl opt">,</span> im <span class="hl opt">&lt;&lt;=</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        a<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>i<span class="hl opt">);</span>
        <span class="hl kwa">while</span> <span class="hl opt">(</span>i<span class="hl opt">-- &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>x1<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">()) {</span>
            x1<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>delta<span class="hl opt">);</span>
          <span class="hl opt">}</span>

          x1<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> jm <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">; (</span>b<span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> jm<span class="hl opt">) ===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> j <span class="hl opt">&lt;</span> <span class="hl num">26</span><span class="hl opt">; ++</span>j<span class="hl opt">,</span> jm <span class="hl opt">&lt;&lt;=</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>j <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        b<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span>j<span class="hl opt">);</span>
        <span class="hl kwa">while</span> <span class="hl opt">(</span>j<span class="hl opt">-- &gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>x2<span class="hl opt">.</span><span class="hl kwd">isOdd</span><span class="hl opt">()) {</span>
            x2<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>delta<span class="hl opt">);</span>
          <span class="hl opt">}</span>

          x2<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>a<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>b<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        a<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>b<span class="hl opt">);</span>
        x1<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>x2<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        b<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>a<span class="hl opt">);</span>
        x2<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>x1<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">var</span> res<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>a<span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> x1<span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      res <span class="hl opt">=</span> x2<span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>res<span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) &lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      res<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span>p<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>gcd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">gcd</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">())</span> <span class="hl kwa">return</span> num<span class="hl opt">.</span><span class="hl kwd">abs</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>num<span class="hl opt">.</span><span class="hl kwd">isZero</span><span class="hl opt">())</span> <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">abs</span><span class="hl opt">();</span>

    <span class="hl kwa">var</span> a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">.</span><span class="hl kwd">clone</span><span class="hl opt">();</span>
    a<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    b<span class="hl opt">.</span>negative <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl slc">// Remove common factor of two</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> shift <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> a<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">() &amp;&amp;</span> b<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">();</span> shift<span class="hl opt">++) {</span>
      a<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      b<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">do</span> <span class="hl opt">{</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>a<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">()) {</span>
        a<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>b<span class="hl opt">.</span><span class="hl kwd">isEven</span><span class="hl opt">()) {</span>
        b<span class="hl opt">.</span><span class="hl kwd">iushrn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>

      <span class="hl kwa">var</span> r <span class="hl opt">=</span> a<span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>b<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>r <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl slc">// Swap `a` and `b` to make `a` always bigger than `b`</span>
        <span class="hl kwa">var</span> t <span class="hl opt">=</span> a<span class="hl opt">;</span>
        a <span class="hl opt">=</span> b<span class="hl opt">;</span>
        b <span class="hl opt">=</span> t<span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>r <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">||</span> b<span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">break</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>

      a<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span>b<span class="hl opt">);</span>
    <span class="hl opt">}</span> <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">);</span>

    <span class="hl kwa">return</span> b<span class="hl opt">.</span><span class="hl kwd">iushln</span><span class="hl opt">(</span>shift<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Invert number in the field F(num)</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>invm <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">invm</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">egcd</span><span class="hl opt">(</span>num<span class="hl opt">).</span>a<span class="hl opt">.</span><span class="hl kwd">umod</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isEven <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isEven</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> <span class="hl num">1</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isOdd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isOdd</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> <span class="hl num">1</span><span class="hl opt">) ===</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// And first word and num</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>andln <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">andln</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &amp;</span> num<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Increment at the bit position in-line</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>bincn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">bincn</span> <span class="hl opt">(</span>bit<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">typeof</span> bit <span class="hl opt">===</span> <span class="hl str">'number'</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> r <span class="hl opt">=</span> bit <span class="hl opt">%</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> s <span class="hl opt">= (</span>bit <span class="hl opt">-</span> r<span class="hl opt">) /</span> <span class="hl num">26</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> q <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl opt">&lt;&lt;</span> r<span class="hl opt">;</span>

    <span class="hl slc">// Fast case: bit is much higher than all existing words</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&lt;=</span> s<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">_expand</span><span class="hl opt">(</span>s <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>s<span class="hl opt">] |=</span> q<span class="hl opt">;</span>
      <span class="hl kwa">return this</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Add bit and propagate, if needed</span>
    <span class="hl kwa">var</span> carry <span class="hl opt">=</span> q<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> s<span class="hl opt">;</span> carry <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> i <span class="hl opt">&lt;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
      <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      w <span class="hl opt">+=</span> carry<span class="hl opt">;</span>
      carry <span class="hl opt">=</span> w <span class="hl opt">&gt;&gt;&gt;</span> <span class="hl num">26</span><span class="hl opt">;</span>
      w <span class="hl opt">&amp;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> w<span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>carry <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] =</span> carry<span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>length<span class="hl opt">++;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>isZero <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">isZero</span> <span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">1</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ===</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>cmpn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">cmpn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> negative <span class="hl opt">=</span> num <span class="hl opt">&lt;</span> <span class="hl num">0</span><span class="hl opt">;</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp; !</span>negative<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> negative<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">();</span>

    <span class="hl kwa">var</span> res<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">1</span><span class="hl opt">) {</span>
      res <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>negative<span class="hl opt">) {</span>
        num <span class="hl opt">= -</span>num<span class="hl opt">;</span>
      <span class="hl opt">}</span>

      <span class="hl kwd">assert</span><span class="hl opt">(</span>num <span class="hl opt">&lt;=</span> <span class="hl num">0x3ffffff</span><span class="hl opt">,</span> <span class="hl str">'Number is too big'</span><span class="hl opt">);</span>

      <span class="hl kwa">var</span> w <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      res <span class="hl opt">=</span> w <span class="hl opt">===</span> num <span class="hl opt">?</span> <span class="hl num">0</span> <span class="hl opt">:</span> w <span class="hl opt">&lt;</span> num <span class="hl opt">? -</span><span class="hl num">1</span> <span class="hl opt">:</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl opt">-</span>res <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Compare two numbers and return:</span>
  <span class="hl slc">// 1 - if `this` &gt; `num`</span>
  <span class="hl slc">// 0 - if `this` == `num`</span>
  <span class="hl slc">// -1 - if `this` &lt; `num`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>cmp <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">cmp</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> num<span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">ucmp</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">!==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl opt">-</span>res <span class="hl opt">|</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Unsigned comparison</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ucmp <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ucmp</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl slc">// At this point both numbers have the same sign</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&gt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">&lt;</span> num<span class="hl opt">.</span>length<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">var</span> res <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>length <span class="hl opt">-</span> <span class="hl num">1</span><span class="hl opt">;</span> i <span class="hl opt">&gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span> i<span class="hl opt">--) {</span>
      <span class="hl kwa">var</span> a <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>
      <span class="hl kwa">var</span> b <span class="hl opt">=</span> num<span class="hl opt">.</span>words<span class="hl opt">[</span>i<span class="hl opt">] |</span> <span class="hl num">0</span><span class="hl opt">;</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>a <span class="hl opt">===</span> b<span class="hl opt">)</span> <span class="hl kwa">continue</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>a <span class="hl opt">&lt;</span> b<span class="hl opt">) {</span>
        res <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>a <span class="hl opt">&gt;</span> b<span class="hl opt">) {</span>
        res <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> res<span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>gtn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">gtn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span>num<span class="hl opt">) ===</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>gt <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">gt</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) ===</span> <span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>gten <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">gten</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span>num<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>gte <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">gte</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) &gt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>ltn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">ltn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span>num<span class="hl opt">) === -</span><span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>lt <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">lt</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) === -</span><span class="hl num">1</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>lten <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">lten</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span>num<span class="hl opt">) &lt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>lte <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">lte</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) &lt;=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>eqn <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">eqn</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmpn</span><span class="hl opt">(</span>num<span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>eq <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">eq</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">cmp</span><span class="hl opt">(</span>num<span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  <span class="hl slc">//</span>
  <span class="hl slc">// A reduce context, could be using montgomery or something better, depending</span>
  <span class="hl slc">// on the `m` itself.</span>
  <span class="hl slc">//</span>
  BN<span class="hl opt">.</span>red <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">red</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwa">return new</span> <span class="hl kwd">Red</span><span class="hl opt">(</span>num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>toRed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">toRed</span> <span class="hl opt">(</span>ctx<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'Already a number in reduction context'</span><span class="hl opt">);</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>negative <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">'red works only with positives'</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span> ctx<span class="hl opt">.</span><span class="hl kwd">convertTo</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">).</span><span class="hl kwd">_forceRed</span><span class="hl opt">(</span>ctx<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>fromRed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">fromRed</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'fromRed works only with numbers in reduction context'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">convertFrom</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>_forceRed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">_forceRed</span> <span class="hl opt">(</span>ctx<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red <span class="hl opt">=</span> ctx<span class="hl opt">;</span>
    <span class="hl kwa">return this</span><span class="hl opt">;</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>forceRed <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">forceRed</span> <span class="hl opt">(</span>ctx<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(!</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'Already a number in reduction context'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">_forceRed</span><span class="hl opt">(</span>ctx<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redAdd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redAdd</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redAdd works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">add</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redIAdd <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redIAdd</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redIAdd works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">iadd</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redSub <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redSub</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redSub works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">sub</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redISub <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redISub</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redISub works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">isub</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redShl <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redShl</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redShl works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">shl</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redMul <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redMul</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redMul works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify2</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">mul</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redIMul <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redIMul</span> <span class="hl opt">(</span>num<span class="hl opt">) {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redMul works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify2</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">imul</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> num<span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redSqr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redSqr</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redSqr works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify1</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">sqr</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redISqr <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redISqr</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redISqr works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify1</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">isqr</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Square root over p</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redSqrt <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redSqrt</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redSqrt works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify1</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">sqrt</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redInvm <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redInvm</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redInvm works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">_verify1</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">invm</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl opt">};</span>

  <span class="hl slc">// Return negative clone of `this` % `red modulo`</span>
  BN<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>redNeg <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl kwd">redNeg</span> <span class="hl opt">() {</span>
    <span class="hl kwd">assert</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">,</span> <span class="hl str">'redNeg works only with red numbers'</span><span class="hl opt">);</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>red<span class="hl opt">.</span><span class="hl kwd">